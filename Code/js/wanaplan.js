window.requestAnimationFrame = function() {
    return window.requestAnimationFrame || window.webkitRequestAnimationFrame || window.mozRequestAnimationFrame || window.oRequestAnimationFrame || window.msRequestAnimationFrame || function(t) {
        window.setTimeout(t, 1e3 / 60)
    }
}(), window.cancelRequestAnimationFrame = function() {
    return window.cancelAnimationFrame || window.webkitCancelRequestAnimationFrame || window.mozCancelRequestAnimationFrame || window.oCancelRequestAnimationFrame || window.msCancelRequestAnimationFrame || clearTimeout
}(), String.prototype.startsWith = String.prototype.startsWith || function(t) {
    return t = String(t), String(this).substring(0, t.length) === t
}, String.prototype.endsWith = String.prototype.endsWith || function(t) {
    t = String(t);
    var e = String(this);
    return e.substring(e.length - t.length) === t
}, String.prototype.trimLeft = String.prototype.trimLeft || function() {
    return this.replace(/^\s+/, "")
}, String.prototype.trimRight = String.prototype.trimRight || function() {
    return this.replace(/\s+$/, "")
}, String.prototype.trim = String.prototype.trim || function() {
    return this.replace(/^\s+|\s+$/g, "")
}, Math.sign = function(t) {
    return 0 > t ? -1 : 1
};
var Logger = function() {
    var t = !1, e = function(e) {
        t && console.log(e)
    }, n = function(e) {
        t && console.warn(e)
    }, i = function(e) {
        t && console.error(e)
    }, o = function(e) {
        if (t) {
            var n = document.getElementById("debugArea");
            n.innerHTML = "<div>" + e + "</div>" + n.innerHTML
        }
    }, r = function() {
        if (t) {
            var e = document.getElementById("debugArea");
            e.innerHTML = ""
        }
    }, s = function(e) {
        t = e ? !0 : !1
    };
    return {message: e,warning: n,error: i,setDebugMode: s,out: o,clear: r}
}();
BABYLON.Vector2.prototype.distanceTo = function(t) {
    return Math.sqrt(this.distanceToSquared(t))
}, BABYLON.Vector2.prototype.distanceToSquared = function(t) {
    var e = t.x - this.x, n = t.y - this.y;
    return e * e + n * n
}, BABYLON.Vector2.FromArrayToRef = function(t, e, n) {
    e || (e = 0), n.x = t[e], n.y = t[e + 1]
}, BABYLON.Vector2.prototype.distToSegment = function(t, e) {
    var n = t.distanceToSquared(e);
    if (0 == n)
        return this.distanceTo(t);
    var i = this.subtract(t).dot(e.subtract(t)) / n, o = t.add(e.subtract(t).scale(i));
    return this.distanceTo(o)
}, BABYLON.Vector3.prototype.distanceTo = function(t) {
    return Math.sqrt(this.distanceToSquared(t))
}, BABYLON.Vector3.prototype.distanceToSquared = function(t) {
    var e = t.x - this.x, n = t.y - this.y, i = t.z - this.z;
    return e * e + n * n + i * i
}, BABYLON.Vector3.prototype.minimize = function(t) {
    return this.x = this.x < t.x ? this.x : t.x, this.y = this.y < t.y ? this.y : t.y, this.z = this.z < t.z ? this.z : t.z, this
}, BABYLON.Vector3.prototype.maximize = function(t) {
    return this.x = this.x > t.x ? this.x : t.x, this.y = this.y > t.y ? this.y : t.y, this.z = this.z > t.z ? this.z : t.z, this
}, BABYLON.Vector2.prototype.copyFrom = function(t) {
    return this.x = t.x, this.y = t.y, this
}, BABYLON.Vector2.prototype.copyFromFloats = function(t, e) {
    return this.x = t, this.y = e, this
}, BABYLON.Vector2.prototype.addInPlace = function(t) {
    return this.x += t.x, this.y += t.y, this
}, BABYLON.Vector2.prototype.subtractInPlace = function(t) {
    return this.x -= t.x, this.y -= t.y, this
}, BABYLON.Vector2.prototype.subtractToRef = function(t, e) {
    e.x = this.x - t.x, e.y = this.y - t.y
}, BABYLON.Vector2.prototype.lerp = function(t, e) {
    return this.x = this.x + (t.x - this.x) * e, this.y = this.y + (t.y - this.y) * e, this
}, BABYLON.Vector3.prototype.lerp = function(t, e) {
    return this.x = this.x + (t.x - this.x) * e, this.y = this.y + (t.y - this.y) * e, this.z = this.z + (t.z - this.z) * e, this
}, BABYLON.Vector2.prototype.projectOnVector = function() {
    var t = new BABYLON.Vector2;
    return function(e) {
        t.copyFrom(e).normalize();
        var n = this.dot(t);
        return this.copyFrom(t).scaleInPlace(n)
    }
}(), BABYLON.Vector3.prototype.projectOnVector = function() {
    var t = new BABYLON.Vector3;
    return function(e) {
        t.copyFrom(e).normalize();
        var n = this.dot(t);
        return this.copyFrom(t).scaleInPlace(n)
    }
}(), BABYLON.Vector2.prototype.projectOnSegment = function(t, e) {
    var n = e.x - t.x, i = e.y - t.y, o = n * n + i * i, r = ((this.x - t.x) * n + (this.y - t.y) * i) / o;
    return r = BABYLON.Math.clamp(r, 0, 1), new BABYLON.Vector2(t.x + r * n, t.y + r * i)
}, BABYLON.Color3.prototype.fromHex = function(t) {
    if (/^\#([0-9a-f]{6})$/i.test(t))
        var t = parseInt(/^\#([0-9a-f]{6})$/i.exec(t)[1], 16);
    return t = Math.floor(t), this.r = (t >> 16 & 255) / 255, this.g = (t >> 8 & 255) / 255, this.b = (255 & t) / 255, this
};
var roundTo = function(t) {
    return Math.round(1e5 * t) / 1e5
};
BABYLON.Vector2.prototype.isPointInPolygon = function(t) {
    var e, n, i, o, r = this.clone();
    r.x = roundTo(r.x), r.y = roundTo(r.y);
    for (var s = t.length, a = !1, l = 0; s > l; l++)
        e = roundTo(t[l].x), n = roundTo(t[l].y), i = roundTo(t[(l + 1) % s].x), o = roundTo(t[(l + 1) % s].y), o === n && o === r.y ? (e <= r.x && r.x < i || i <= r.x && r.x < e) && (a = !a) : (n <= r.y && r.y < o || o <= r.y && r.y < n) && r.x <= roundTo((i - e) * (r.y - n) / (o - n) + e) && (a = !a);
    return a
}, BABYLON.Ray.prototype.closestPointToPoint = function(t) {
    var e = t.subtract(this.origin), n = e.dot(this.direction);
    return e.copyFrom(this.direction).scale(n).add(this.origin)
}, BABYLON.Vector2.prototype.dot = function(t) {
    return BABYLON.Vector2.Dot(this, t)
}, BABYLON.Vector3.prototype.dot = function(t) {
    return BABYLON.Vector3.Dot(this, t)
}, BABYLON.Vector3.prototype.cross = function() {
    var t = new BABYLON.Vector3;
    return function(e) {
        return BABYLON.Vector3.CrossToRef(this, e, t), this.copyFrom(t), this
    }
}(), BABYLON.Vector3.prototype.toSpherical = function() {
    var t = this.length(), e = Math.acos(this.y / t), n = Math.atan2(this.z, this.x);
    return {r: t,alpha: n,beta: e}
}, BABYLON.Vector3.FromSphericalToRef = function(t, e, n, i) {
    i.x = t * Math.cos(e) * Math.sin(n), i.y = t * Math.cos(n), i.z = t * Math.sin(e) * Math.sin(n)
}, BABYLON.Vector3.FromSpherical = function(t, e, n) {
    var i = new BABYLON.Vector3;
    return BABYLON.Vector3.FromSphericalToRef(t, e, n, i), i
}, BABYLON.Vector2.prototype.determinant = function(t) {
    return this.x * t.y - this.y * t.x
}, BABYLON.Math = BABYLON.Math || {}, BABYLON.Math.clamp = function(t, e, n) {
    return e > t ? e : t > n ? n : t
}, BABYLON.Math.NormalizeAngle = function(t, e) {
    return t %= 2 * Math.PI, t += 2 * Math.PI, t %= 2 * Math.PI, e ? t : t = t > Math.PI ? t - 2 * Math.PI : t
}, BABYLON.Math.ClosestAngle = function(t, e) {
    var n = 2 * Math.PI;
    return t = (t % n + n) % n, rb = Math.floor(e / n), t += rb * n, Math.abs(e - t) > Math.PI && (t += e > t ? n : -n), t
}, BABYLON.Vector2.Precision = 1e-5, BABYLON.Vector2.IntersectIsOn = function() {
    var t, e, n, i, o, r, s, a, l;
    return function(h, c, u, p, d, m) {
        var d = d || BABYLON.Vector2.Precision, m = m || Math.PI / 20;
        if (i = c.x - h.x, o = c.y - h.y, r = p.x - u.x, s = p.y - u.y, n = i * s - o * r, Math.abs(n) < m)
            return void 0;
        n = 1 / n, t = ((h.y - u.y) * r - (h.x - u.x) * s) * n, e = ((h.y - u.y) * i - (h.x - u.x) * o) * n;
        var g = new BABYLON.Vector2(h.x + t * i, h.y + t * o);
        return a = d / Math.sqrt(i * i + o * o), l = d / Math.sqrt(r * r + s * s), {intersect: g,isOn: t >= -a && 1 + a >= t && e >= -l && 1 + l >= e}
    }
}(), BABYLON.Vector2.Intersect = function(t, e, n, i, o) {
    var r, s, a, l = o || BABYLON.Vector2.Precision, h = new BABYLON.Vector2, c = new BABYLON.Vector2;
    return h = e.subtract(t), c = i.subtract(n), r = h.y * t.x - h.x * t.y, s = c.y * n.x - c.x * n.y, a = h.determinant(c), detnorm = h.clone().normalize().determinant(c.clone().normalize()), Math.abs(detnorm) < l ? void 0 : new BABYLON.Vector2((h.x * s - c.x * r) / a, (h.y * s - c.y * r) / a)
}, BABYLON.Vector2.IntersectIsOnOLD = function(t, e, n, i, o, r) {
    var o = o || BABYLON.Vector2.Precision, r = r || Math.PI / 20, s = new BABYLON.Vector2, a = new BABYLON.Vector2;
    if (s = e.subtract(t), a = i.subtract(n), cprime = a.y * n.x - a.x * n.y, det = s.determinant(a), detnorm = s.clone().normalize().determinant(a.clone().normalize()), Math.abs(detnorm) < r)
        return void 0;
    var l = new BABYLON.Vector2((s.x * cprime - a.x * c) / det, (s.y * cprime - a.y * c) / det), h = Math.abs(e.x - t.x) >= BABYLON.Vector2.Precision ? (l.x - t.x) / (e.x - t.x) : (l.y - t.y) / (e.y - t.y), u = Math.abs(i.x - n.x) >= BABYLON.Vector2.Precision ? (l.x - n.x) / (i.x - n.x) : (l.y - n.y) / (i.y - n.y), p = o / s.length(), d = o / a.length();
    return {intersect: l,isOn: h >= -p && 1 + p >= h && u >= -d && 1 + d >= u}
}, BABYLON.Vector2.prototype.isOnSegment = function(t, e) {
    var n = .1, i = e.subtract(t), o = i.length();
    i.scaleInPlace(1 / o);
    var r = this.subtract(t), s = i.x * r.y - i.y * r.x, a = i.dot(r);
    return Math.abs(s) < n && a >= 0 && o >= a
}, BABYLON.Vector2.SegmentIntersection = function(t, e, n, i, o, r) {
    var r = r || Math.PI / 200, s = BABYLON.Vector2.IntersectIsOn(t, e, n, i, o, r);
    return s && s.isOn ? s.intersect : null
}, BABYLON.Vector2.GetAbsoluteSine = function(t, e, n, i) {
    var o = new BABYLON.Vector2, r = new BABYLON.Vector2;
    return t.subtractToRef(e, o), n.subtractToRef(i, r), o.normalize(), r.normalize(), Math.abs(o.determinant(r))
}, BABYLON.BoundingBox.ExpandFromPoint = function(t, e, n) {
    t.x < e.x ? e.x = t.x : t.x > n.x && (n.x = t.x), t.y < e.y ? e.y = t.y : t.y > n.y && (n.y = t.y), t.z < e.z ? e.z = t.z : t.z > n.z && (n.z = t.z)
}, BABYLON.BoundingBox.CreateFromPoints = function(t) {
    if (!(t.length > 0))
        return BABYLON.BoundingBox.Zero();
    for (var e = t[0], n = e.clone(), i = e.clone(), o = 1, r = t.length; r > o; o++)
        BABYLON.BoundingBox.ExpandFromPoint(t[o], n, i);
    return new BABYLON.BoundingBox(n, i)
}, BABYLON.BoundingBox.Zero = function() {
    return new BABYLON.BoundingBox(new BABYLON.Vector3(0, 0, 0), new BABYLON.Vector3(0, 0, 0))
}, BABYLON.BoundingBox.prototype.intersect = function(t) {
    return this.minimum.max(t.minimum), this.maximum.min(t.maximum), this
}, BABYLON.BoundingBox.prototype.union = function(t) {
    return this.minimum.min(t.minimum), this.maximum.max(t.maximum), this
}, BABYLON.Vector2.prototype.min = function(t) {
    return this.x = this.x < t.x ? this.x : t.x, this.y = this.y < t.y ? this.y : t.y, this
}, BABYLON.Vector2.prototype.max = function(t) {
    return this.x = this.x > t.x ? this.x : t.x, this.y = this.y > t.y ? this.y : t.y, this
}, BABYLON.Vector3.prototype.min = function(t) {
    return this.x = this.x < t.x ? this.x : t.x, this.y = this.y < t.y ? this.y : t.y, this.z = this.z < t.z ? this.z : t.z, this
}, BABYLON.Vector3.prototype.max = function(t) {
    return this.x = this.x > t.x ? this.x : t.x, this.y = this.y > t.y ? this.y : t.y, this.z = this.z > t.z ? this.z : t.z, this
}, BABYLON.Quaternion.RotationFromXtoX_ = function(t, e) {
    var n = BABYLON.Vector3.Cross(t, e).normalize();
    n.lengthSquared() < .001 && (n = BABYLON.Vector3.Cross(t, Math.abs(t.x) > .9 ? new BABYLON.Vector3(0, 0, 1) : new BABYLON.Vector3(1, 0, 0)).normalize());
    var i = Math.acos(Math.min(Math.max(BABYLON.Vector3.Dot(t, e), -1), 1));
    return BABYLON.Quaternion.RotationAxis(n, i)
}, BABYLON.Quaternion.RotationFromXtoX_2 = function(t, e, n, i) {
    var o = BABYLON.Vector3.Cross(t, n).normalize(), r = BABYLON.Vector3.Cross(e, i).normalize();
    o.lengthSquared() < .001 && (o = BABYLON.Vector3.Cross(t, Math.abs(t.x) > .9 ? new BABYLON.Vector3(0, 0, 1) : new BABYLON.Vector3(1, 0, 0)).normalize()), r.lengthSquared() < .001 && (r = BABYLON.Vector3.Cross(e, Math.abs(e.x) > .9 ? new BABYLON.Vector3(0, 0, 1) : new BABYLON.Vector3(1, 0, 0)).normalize());
    var s = BABYLON.Quaternion.RotationFromXtoX_(o, r), l = new BABYLON.Matrix;
    s.toRotationMatrix(l);
    var h = BABYLON.Vector3.TransformCoordinates(t, l);
    w = BABYLON.Vector3.Cross(h, e).normalize(), a = Math.acos(Math.min(Math.max(BABYLON.Vector3.Dot(h, e), -1), 1));
    var c = r;
    BABYLON.Vector3.Dot(w, c) < .9 && (c = c.scale(-1));
    var u = BABYLON.Quaternion.RotationAxis(c, a);
    return u.multiply(s)
}, BABYLON.Mesh.prototype.getMaterial = function(t) {
    for (var e = 0, n = this.subMeshes.length; n > e; e++)
        if (3 * t >= this.subMeshes[e].indexStart && 3 * t < this.subMeshes[e].indexStart + this.subMeshes[e].indexCount)
            return this.subMeshes[e].getMaterial();
    return null
}, BABYLON.Mesh.prototype.initMaterials = function(t) {
    for (var e in t)
        this.traverse(function(n) {
            n.name === e && (n.material = t[e])
        })
}, BABYLON.Mesh.prototype.invertFaces = function() {
    for (var t, e = this.getIndices(), n = 0; n < e.length; n += 3)
        t = e[n], e[n] = e[n + 2], e[n + 2] = t;
    this.setIndices(e)
}, BABYLON.Mesh.prototype.invertNormales = function() {
    for (var t = this.getVerticesData(BABYLON.VertexBuffer.NormalKind), e = 0; e < t.length; e++)
        t[e] *= -1;
    this.setVerticesData(BABYLON.VertexBuffer.NormalKind, t)
}, BABYLON.Ray.prototype.intersectMeshes = function(t, e, n) {
    for (var i, o, r, s, a = +1 / 0, l = new BABYLON.Matrix, h = 0, c = t.length; c > h; h++)
        s = t[h].name && -1 != t[h].name.indexOf("_sprite_"), (t[h].isVisible || s) && (s && t[h].sprite.updateCollider(), t[h].getWorldMatrix().invertToRef(l), r = BABYLON.Ray.Transform(this, l), r.direction.normalize(), i = t[h].intersects(r, !1, e, n), i.hit && i.distance < a && (o = i, a = i.distance));
    return o
}, BABYLON.Ray.prototype.distanceToPlane = function(t) {
    var e = t.normal.dot(this.direction);
    if (0 == e)
        return 0 == Math.abs(t.signedDistanceTo(this.origin)) ? 0 : null;
    var n = -(this.origin.dot(t.normal) + t.d) / e;
    return n >= 0 ? n : null
}, BABYLON.Ray.prototype.intersectPlane = function(t) {
    var e = this.distanceToPlane(t);
    return null === e ? null : this.origin.add(this.direction.scale(e))
}, BABYLON.Mesh.CreateBloc = function(t, e, n, i, o) {
    e = e || .01, n = n || .01, i = i || .01;
    var r = new BABYLON.Mesh.CreateBox(t, e, o);
    return r.bakeTransformIntoVertices(BABYLON.Matrix.Scaling(1, n / e, i / e)), r
}, BABYLON.Mesh.CreatePlan = function(t, e, n, i) {
    (0 == n || 0 == e) && console.log("trying to create a bloc with 0 dimension, will probably fail");
    var o = new BABYLON.Mesh.CreatePlane(t, e, i);
    return o.scaling.y = n / e, o
}, BABYLON.Mesh.Triangulate = function(t, e, n, o) {
    for (var r, s = t.slice(0), a = [], l = 0, o = o || 0, h = n && n.indices ? n.indices : [], c = n && n.positions ? n.positions : [], u = n && n.normals ? n.normals : [], p = t[t.length - 1], d = 1e-5, m = 0, g = t.length; g > m; m++)
        p.distanceTo(t[m]) > d && (r = new poly2tri.Point(t[m].x, t[m].y), r.index = l++, a.push(r)), p = t[m];
    if (!(a.length < 3)) {
        var f = new poly2tri.SweepContext(a);
        for (var y in e) {
            var _ = e[y], v = [];
            for (i in _)
                r = new poly2tri.Point(_[i].x, _[i].y), r.index = l++, v.push(r), s.push(_[i]);
            f.addHole(v)
        }
        for (var m = 0, g = s.length; g > m; m++)
            c.push(s[m].x, o, -s[m].y);
        try {
            f.triangulate()
        } catch (b) {
            return Logger.warning("Erreur de triangulation : " + b.message), null
        }
        var w, x = f.getTriangles();
        x.forEach(function(t) {
            w = t.getPoints();
            for (var e = w.length - 1; e >= 0; e--)
                h.push(w[e].index)
        });
        var C = BABYLON.Tools.PlaneUVProjection(c, new BABYLON.Vector3(1, 0, 0), new BABYLON.Vector3(0, 0, 1), 512);
        return n && (n.uvs = C), BABYLON.VertexData.ComputeNormals(c, h, u), n || {positions: c,normals: u,indices: h,uvs: C}
    }
}, BABYLON.Mesh.TriangulateNewMesh = function(t, e, n, i, o) {
    var r = new BABYLON.Mesh(t, i), s = BABYLON.Mesh.Triangulate(e, n, void 0, o);
    return s ? (r.setVerticesData(BABYLON.VertexBuffer.PositionKind, s.positions), r.setVerticesData(BABYLON.VertexBuffer.NormalKind, s.normals), r.setVerticesData(BABYLON.VertexBuffer.UVKind, s.uvs), r.setIndices(s.indices), r) : null
}, BABYLON.Mesh.prototype.centerGeometry = function(t) {
    var t = t || "y", e = this.getBoundingBox(!0), n = e.center;
    if (this.isVerticesDataPresent(BABYLON.VertexBuffer.PositionKind))
        for (var i = this.getVerticesData(BABYLON.VertexBuffer.PositionKind), o = 0, r = i.length; r > o; o += 3)
            i[o] -= n.x, i[o + 1] -= n.y + e.extends[t], i[o + 2] -= n.z;
    for (var s = this.getChildren(), o = 0, a = s.length; a > o; o++)
        s[o].position.subtractInPlace(n), s[o].position[t] += e.extends[t]
}, BABYLON.Mesh.Extrude = function(t, e, n, i) {
    var n = n || {}, o = i && i.indices ? i.indices : [], r = i && i.positions ? i.positions : [], s = i && i.normals ? i.normals : [], a = [], l = BABYLON.Mesh.Triangulate(t, e);
    if (!l)
        return null;
    for (var h, c = l.positions.length / 3, u = {positions: l.positions.slice(0),normals: l.normals.slice(0),uvs: l.uvs.slice(0),indices: l.indices.slice(0)}, p = 0, d = u.indices.length; d > p; p += 3)
        h = u.indices[p], u.indices[p] = u.indices[p + 2], u.indices[p + 2] = h;
    for (var m = void 0 !== n.amount ? n.amount : 5, p = 1, d = l.positions.length; d > p; p += 3)
        l.positions[p] += m;
    for (var p = 0, d = u.positions.length; d > p; p++)
        r.push(u.positions[p]), s.push(u.normals[p]);
    for (var p = 0, d = l.positions.length; d > p; p++)
        r.push(l.positions[p]), s.push(l.normals[p]);
    for (var p = 0, d = u.uvs.length; d > p; p++)
        a.push(u.uvs[p]);
    for (var p = 0, d = l.uvs.length; d > p; p++)
        a.push(l.uvs[p]);
    for (var p = 0, d = u.indices.length; d > p; p++)
        o.push(u.indices[p]);
    for (var p = 0, d = l.indices.length; d > p; p++)
        o.push(l.indices[p] + c);
    var g = function(t, e) {
        for (var n = t.length, i = r.length / 3, l = e ? BABYLON.Tools.Area(t) > 0 : BABYLON.Tools.Area(t) < 0, h = 0; h < t.length; h++)
            r.push(t[h].x, 0, -t[h].y, t[h].x, m, -t[h].y);
        for (var h = 0; n > h; h++)
            a.push(0, 0), a.push(0, 0);
        for (var c = new BABYLON.Vector2, h = 0; n > h; h++)
            c.copyFrom(t[(h + 1) % n]).subtractInPlace(t[h]), c.normalize(), l && c.scaleInPlace(-1), s.push(-c.y, 0, -c.x, -c.y, 0, -c.x);
        for (var h = 0; 2 * n > h; h += 2)
            l ? (o.push(i + h, i + (h + 2) % (2 * n), i + h + 1), o.push(i + (h + 2) % (2 * n), i + (h + 3) % (2 * n), i + h + 1)) : (o.push(i + h + 1, i + (h + 2) % (2 * n), i + h), o.push(i + h + 1, i + (h + 3) % (2 * n), i + (h + 2) % (2 * n)))
    };
    if (g(t), e)
        for (var p = 0, d = e.length; d > p; p++)
            g(e[p], !0);
    return i || {positions: r,normals: s,indices: o,uvs: a}
}, BABYLON.Mesh.ExtrudeNewMesh = function(t, e, n, i, o) {
    var r = new BABYLON.Mesh(t, o), s = BABYLON.Mesh.Extrude(e, n, i);
    return s ? (r.setVerticesData(BABYLON.VertexBuffer.PositionKind, s.positions), r.setVerticesData(BABYLON.VertexBuffer.NormalKind, s.normals), r.setVerticesData(BABYLON.VertexBuffer.UVKind, s.uvs), r.setIndices(s.indices), r) : null
}, BABYLON.Tools.Area = function(t) {
    for (var e = t.length, n = 0, i = e - 1, o = 0; e > o; i = o++)
        n += t[i].x * t[o].y - t[o].x * t[i].y;
    return .5 * n
}, BABYLON.Tools.PlaneUVProjection = function(t, e, n, i) {
    var o;
    e = e.clone().normalize(), n = n.clone().normalize();
    var r = BABYLON.Vector3.Cross(e, n), s = [], a = [];
    if (r.length() < BABYLON.Engine.epsilon)
        return console.warn("Can't map UVs : basis vectors are linked"), null;
    if (0 == t.length)
        return null;
    var l = BABYLON.Matrix.FromValues(e.x, n.x, r.x, 0, e.y, n.y, r.y, 0, e.z, n.z, r.z, 0, 0, 0, 0, 1);
    l = BABYLON.Matrix.Transpose(l), l.invert();
    for (var h = 0, c = t.length; c > h; h += 3)
        o = new BABYLON.Vector3(t[h], t[h + 1], t[h + 2]), BABYLON.Vector3.TransformCoordinatesToRef(o, l, o), s.push(o.x), a.push(o.y);
    for (var u = s[0], p = s[0], d = a[0], m = a[0], h = 0, c = s.length; c > h; h++)
        s[h] < u && (u = s[h]), s[h] > p && (p = s[h]), a[h] < d && (d = a[h]), a[h] > m && (m = a[h]);
    var g, f;
    if (void 0 === i && (i = 512), 0 != i ? (g = (p - u) / i * 4, f = (m - d) / i * 4) : (g = 1, f = 1), p === u)
        for (var h = 0, c = s.length; c > h; h++)
            s[h] = 0;
    else
        for (var h = 0, c = s.length; c > h; h++)
            s[h] = (s[h] - u) / (p - u) * g;
    if (m === d)
        for (var h = 0, c = a.length; c > h; h++)
            a[h] = 0;
    else
        for (var h = 0, c = a.length; c > h; h++)
            a[h] = (a[h] - d) / (m - d) * f;
    for (var y = [], h = 0, c = s.length; c > h; h++)
        y.push(s[h], a[h]);
    return y
}, BABYLON.Mesh.ComputeFlatNormal = function(t, e, n) {
    var i, o = [];
    for (i = 0; i < t.length; i += 3) {
        var r = new BABYLON.Vector3(t[i], t[i + 1], t[i + 2]);
        o.push(r)
    }
    var s;
    for (i = 0; i < n.length / 3; i++) {
        var a = n[3 * i], l = n[3 * i + 1], h = n[3 * i + 2], c = o[a], u = o[l], p = o[h], d = c.subtract(u), m = p.subtract(u);
        s = BABYLON.Vector3.Normalize(BABYLON.Vector3.Cross(d, m)), e[3 * a] = s.x, e[3 * a + 1] = s.y, e[3 * a + 2] = s.z, e[3 * l] = s.x, e[3 * l + 1] = s.y, e[3 * l + 2] = s.z, e[3 * h] = s.x, e[3 * h + 1] = s.y, e[3 * h + 2] = s.z
    }
}, BABYLON.Mesh.prototype.traverse = function(t) {
    t(this);
    for (var e = this.getChildren(), n = 0; n < e.length; n++)
        e[n].traverse(t)
}, BABYLON.Mesh.prototype.getChildByName = function(t, e) {
    for (var n, i = this.getChildren(), o = 0; o < i.length; o++) {
        if (i[o].name === t)
            return i[o];
        if (!e && (n = i[o].getChildByName(t)))
            return n
    }
    return null
}, BABYLON.Mesh.mergeMeshes = function(t, e, n, o) {
    var r = [], s = [], a = [], l = [], h = [], c = [], u = [], p = [], d = [], m = [], g = new BABYLON.Mesh(t, n), f = !0, y = !0, _ = !0, v = !0, b = !0;
    for (i = 0; i != e.length; i++)
        e[i].isVerticesDataPresent([BABYLON.VertexBuffer.UVKind]) || (f = !1), e[i].isVerticesDataPresent([BABYLON.VertexBuffer.UV2Kind]) || (y = !1), e[i].isVerticesDataPresent([BABYLON.VertexBuffer.ColorKind]) || (_ = !1), e[i].isVerticesDataPresent([BABYLON.VertexBuffer.MatricesIndicesKind]) || (v = !1), e[i].isVerticesDataPresent([BABYLON.VertexBuffer.MatricesWeightsKind]) || (b = !1);
    for (i = 0; i != e.length; i++) {
        var w = 0, x = 0;
        r[i] = e[i].getVerticesData(BABYLON.VertexBuffer.PositionKind), s[i] = e[i].getVerticesData(BABYLON.VertexBuffer.NormalKind), f && (a = a.concat(e[i].getVerticesData(BABYLON.VertexBuffer.UVKind))), y && (l = l.concat(e[i].getVerticesData(BABYLON.VertexBuffer.UV2Kind))), _ && (h = h.concat(e[i].getVerticesData(BABYLON.VertexBuffer.ColorKind))), v && (c = c.concat(e[i].getVerticesData(BABYLON.VertexBuffer.MatricesIndicesKind))), b && (u = u.concat(e[i].getVerticesData(BABYLON.VertexBuffer.MatricesWeightsKind)));
        for (var C = d.length / 3, M = e[i].computeWorldMatrix(!0); w < r[i].length; ) {
            var D = new BABYLON.Vector3.TransformCoordinates(new BABYLON.Vector3(r[i][w], r[i][w + 1], r[i][w + 2]), M);
            d.push(D.x), d.push(D.y), d.push(D.z), w += 3
        }
        for (; x < s[i].length; ) {
            var D = new BABYLON.Vector3.TransformNormal(new BABYLON.Vector3(s[i][x], s[i][x + 1], s[i][x + 2]), M);
            m.push(D.x), m.push(D.y), m.push(D.z), x += 3
        }
        if (i > 0) {
            var B = e[i].getIndices();
            for (it = 0; it != B.length; it++)
                B[it] = B[it] + C;
            p = p.concat(B)
        } else
            p = e[i].getIndices()
    }
    if (g.setVerticesData(BABYLON.VertexBuffer.PositionKind, d, !1), g.setVerticesData(BABYLON.VertexBuffer.NormalKind, m, !1), a.length > 0 && g.setVerticesData(BABYLON.VertexBuffer.UVKind, a, !1), l.length > 0 && g.setVerticesData(BABYLON.VertexBuffer.UV2Kind, a, !1), h.length > 0 && g.setVerticesData(BABYLON.VertexBuffer.ColorKind, a, !1), c.length > 0 && g.setVerticesData(BABYLON.VertexBuffer.MatricesIndicesKind, a, !1), u.length > 0 && g.setVerticesData(BABYLON.VertexBuffer.MatricesWeightsKind, a, !1), g.setIndices(p), o) {
        g.subMeshes = [];
        var A, C = 0, E = 0;
        for (i = 0; i != e.length; i++) {
            {
                g.subMeshes.length
            }
            i > 0 && (C += e[i - 1].getIndices().length), A = -1;
            for (subMesh in e[i].subMeshes) {
                var T = BABYLON.SubMesh.CreateFromIndices(e[i].subMeshes[subMesh].materialIndex + E, e[i].subMeshes[subMesh].indexStart + C, e[i].subMeshes[subMesh].indexCount, g);
                T.objectInstance = e[i].subMeshes[subMesh].objectInstance, T.boundingBox = e[i].subMeshes[subMesh].boundingBox, A = Math.max(e[i].subMeshes[subMesh].materialIndex, A)
            }
            E += ++A
        }
    }
    for (i = 0; i != e.length; i++)
        e[i].dispose(!0);
    return g
}, BABYLON.Mesh.mergeMeshesRec = function(t, e, n, i) {
    for (var o = [], r = [], s = 0; s < e.length; s++)
        e[s].traverse(function(t) {
            t.computeWorldMatrix(!0), t.isVisible ? o.push(t) : r.push(t)
        });
    var a = BABYLON.Mesh.mergeMeshes(t, o, n, i);
    return r.forEach(function(t) {
        t.dispose(!0)
    }), a
}, BABYLON.Mesh.ComputeFaceNormal = function(t, e, n) {
    for (var i = 0; i < n.length; i += 3) {
        var o = new BABYLON.Vector3(t[3 * n[i]], t[3 * n[i] + 1], t[3 * n[i] + 2]), r = new BABYLON.Vector3(t[3 * n[i + 1]], t[3 * n[i + 1] + 1], t[3 * n[i + 1] + 2]), s = new BABYLON.Vector3(t[3 * n[i + 2]], t[3 * n[i + 2] + 1], t[3 * n[i + 2] + 2]), a = o.subtract(r), l = s.subtract(r);
        a.cross(l), a.normalize(), e[3 * n[i]] = a.x, e[3 * n[i] + 1] = a.y, e[3 * n[i] + 2] = a.z, e[3 * n[i + 1]] = a.x, e[3 * n[i + 1] + 1] = a.y, e[3 * n[i + 1] + 2] = a.z, e[3 * n[i + 2]] = a.x, e[3 * n[i + 2] + 1] = a.y, e[3 * n[i + 2] + 2] = a.z
    }
}, BABYLON.BoundingBox.CreateFromData = function(t) {
    if (!(t.length > 0 && t.length % 3 == 0))
        return BABYLON.BoundingBox.Zero();
    for (var e = [], n = 0; n < t.length; n += 3)
        e.push(new BABYLON.Vector3(t[n], t[n + 1], t[n + 2]));
    return BABYLON.BoundingBox.CreateFromPoints(e)
}, BABYLON.Material.prototype.serialize = function() {
    return {name: this.name}
}, BABYLON.Material.prototype.deserialize = function() {
}, BABYLON.StandardMaterial.prototype.serialize = function() {
    var t = BABYLON.Material.prototype.serialize.call(this);
    return t.class = {name: "BABYLON.StandardMaterial"}, ujs.serializeObject(this, t, ["diffuseTexture", "ambientTexture", "opacityTexture", "reflectionTexture", "emissiveTexture", "specularTexture", "bumpTexture", "ambientColor", "diffuseColor", "specularColor", "specularPower", "emissiveColor"]), t
}, BABYLON.MultiMaterial.prototype.serialize = function() {
    var t = BABYLON.Material.prototype.serialize.call(this);
    return t.class = {name: "BABYLON.MultiMaterial"}, ujs.serializeObject(this, t, ["subMaterials"]), t
}, BABYLON.StandardMaterial.prototype.deserialize = function(t) {
    return BABYLON.Material.prototype.deserialize.call(this, t), ujs.deserializeObject(t, this, ["diffuseTexture", "ambientTexture", "opacityTexture", "reflectionTexture", "emissiveTexture", "specularTexture", "bumpTexture", "ambientColor", "diffuseColor", "specularColor", "specularPower", "emissiveColor"]), this
}, BABYLON.MultiMaterial.prototype.deserialize = function(t) {
    return BABYLON.Material.prototype.deserialize.call(this, t), ujs.deserializeObject(t, this, ["subMaterials"]), this
}, BABYLON.StandardMaterial.Deserialize = function(t) {
    if (!t)
        return null;
    var e = new BABYLON.StandardMaterial(t.name, wanaplan.engine3D.scene);
    return e.deserialize(t), e
}, BABYLON.MultiMaterial.Deserialize = function(t) {
    if (!t)
        return null;
    var e = new BABYLON.MultiMaterial(t.name, wanaplan.engine3D.scene);
    return e.deserialize(t), e
}, BABYLON.Vector2.prototype.serialize = function() {
    var t = {"class": {name: "BABYLON.Vector2"},x: this.x,y: this.y};
    return t
}, BABYLON.Vector2.Deserialize = function(t) {
    var e = new BABYLON.Vector2(t.x, t.y);
    return e
}, BABYLON.Quaternion.Deserialize = function(t) {
    var e = new BABYLON.Quaternion(t.x, t.y, t.z, t.w);
    return e
}, BABYLON.Quaternion.prototype.serialize = function() {
    var t = {"class": {name: "BABYLON.Quaternion"},x: this.x,y: this.y,z: this.z,w: this.w};
    return t
}, BABYLON.Vector3.prototype.serialize = function() {
    var t = {"class": {name: "BABYLON.Vector3"},x: this.x,y: this.y,z: this.z};
    return t
}, BABYLON.Vector3.prototype.getPositionFromMatrix = function(t) {
    return this.x = t.m[12], this.y = t.m[13], this.z = t.m[14], this
}, BABYLON.Vector3.prototype.getScaleFromMatrix = function(t) {
    var e = this.set(t.m[0], t.m[1], t.m[2]).length(), n = this.set(t.m[4], t.m[5], t.m[6]).length(), i = this.set(t.m[8], t.m[9], t.m[10]).length();
    return this.x = e, this.y = n, this.z = i, this
}, BABYLON.Vector3.Deserialize = function(t) {
    var e = new BABYLON.Vector3(t.x, t.y, t.z);
    return e
}, BABYLON.Color3.prototype.serialize = function() {
    var t = {"class": {name: "BABYLON.Color3"},r: this.r,g: this.g,b: this.b};
    return t
}, BABYLON.Color4.prototype.serialize = function() {
    var t = {"class": {name: "BABYLON.Color4"},r: this.r,g: this.g,b: this.b,a: this.a};
    return t
}, BABYLON.Color3.Deserialize = function(t) {
    var e = new BABYLON.Color3(t.r, t.g, t.b);
    return e
}, BABYLON.Color4.Deserialize = function(t) {
    var e = new BABYLON.Color4(t.r, t.g, t.b, t.a);
    return e
}, BABYLON.BaseTexture.prototype.serialize = function() {
    this.url = GlobalHelper.stripDomainUrl(this.url, "wanaplan.");
    var t = {"class": {name: "BABYLON.BaseTexture"},uScale: this.uScale,vScale: this.vScale,url: this.url};
    return t
}, BABYLON.BaseTexture.Deserialize = function(t) {
    var e = new BABYLON.BaseTexture(t.url, wanaplan.engine3D.scene);
    return e.uScale = t.uScale || 1, e.vScale = t.vScale || 1, e
}, BABYLON.Texture.prototype.serialize = function() {
    var t = BABYLON.BaseTexture.prototype.serialize.call(this);
    return t.class.name = "BABYLON.Texture", t
}, BABYLON.Texture.Deserialize = function(t) {
    t.url = GlobalHelper.stripDomainUrl(t.url, "wanaplan.");
    var e = new BABYLON.Texture(t.url, wanaplan.engine3D.scene);
    return e.uScale = t.uScale || 1, e.vScale = t.vScale || 1, e
}, BABYLON.CubeTexture.prototype.serialize = function() {
    var t = BABYLON.BaseTexture.prototype.serialize.call(this);
    return t.class.name = "BABYLON.CubeTexture", t
}, BABYLON.CubeTexture.Deserialize = function(t) {
    var e = new BABYLON.CubeTexture(t.url, wanaplan.engine3D.scene);
    return e
}, BABYLON.Mesh.prototype._lastCollidedFaceIndex = -1, BABYLON.Mesh.prototype.getFloor = function() {
    return this.parent ? -1 != this.parent.name.indexOf("FloorMesh") ? this.parent : this.parent.getFloor() : null
}, BABYLON.Node.prototype.getTopLevelObject = function(t) {
    return this.parent ? -1 != this.parent.name.indexOf("FloorMesh") ? this : -1 != this.parent.name.indexOf("group") && t ? this : this.parent.getTopLevelObject(t) : this
}, BABYLON.Node.prototype.getParentByName = function(t) {
    return this.name != t ? this.parent ? this.parent.getParentByName(t) : void 0 : this
}, BABYLON.Tools.ExtractMinAndMaxWithTransform = function(t, e, n, i) {
    for (var o = new BABYLON.Vector3(Number.MAX_VALUE, Number.MAX_VALUE, Number.MAX_VALUE), r = new BABYLON.Vector3(-Number.MAX_VALUE, -Number.MAX_VALUE, -Number.MAX_VALUE), s = new BABYLON.Vector3, a = e; e + n > a; a++)
        s.copyFromFloats(t[3 * a], t[3 * a + 1], t[3 * a + 2]), s = BABYLON.Vector3.TransformCoordinates(s, i), o = BABYLON.Vector3.Minimize(s, o), r = BABYLON.Vector3.Maximize(s, r);
    return {minimum: o,maximum: r}
}, BABYLON.Mesh.prototype.getBoundingBox = function(t) {
    if (!t && this.__boundingInfo)
        return this.__boundingInfo.boundingBox;
    var e = 1 / 0, n = 1 / 0, i = 1 / 0, o = -1 / 0, r = -1 / 0, s = -1 / 0;
    this.computeWorldMatrix(!0);
    var a = this.getWorldMatrix().clone();
    a.invert();
    var l = function(t) {
        t.computeWorldMatrix(!0);
        var h = t.getWorldMatrix().clone(), c = h.multiply(a);
        if (t instanceof BABYLON.Mesh && t.isVisible) {
            var u = BABYLON.Tools.ExtractMinAndMaxWithTransform(t.getVerticesData(BABYLON.VertexBuffer.PositionKind), 0, t.getTotalVertices(), c, !0), p = u.minimum, d = u.maximum;
            e = Math.min(e, p.x), n = Math.min(n, p.y), i = Math.min(i, p.z), o = Math.max(o, d.x), r = Math.max(r, d.y), s = Math.max(s, d.z)
        }
        for (var m = t.getChildren(), g = 0, f = m.length; f > g; g++)
            l(m[g])
    };
    l(this);
    var h = new BABYLON.Vector3(e, n, i), c = new BABYLON.Vector3(o, r, s);
    return this.__boundingInfo = new BABYLON.BoundingInfo(h, c), this.__boundingInfo.boundingBox
}, BABYLON.Mesh.prototype.getBoundingSphere = function(t) {
    if (!this.__boundingInfo || t) {
        var e = this.getBoundingBox();
        this.__boundingInfo.boundingSphere = new BABYLON.BoundingSphere(e.maximum.clone(), e.minimum.clone())
    }
    return this.__boundingInfo.boundingSphere
}, BABYLON.Vector3.RotationFromMatrix = function(t) {
    function e(t) {
        return Math.min(Math.max(t, -1), 1)
    }
    var n = new BABYLON.Vector3, i = t.m, o = i[0], r = i[4], s = i[8], a = (i[1], i[5]), l = i[9], h = (i[2], i[6]), c = i[10];
    return n.y = Math.asin(e(s)), Math.abs(s) < .99999 ? (n.x = Math.atan2(-l, c), n.z = Math.atan2(-r, o)) : (n.x = Math.atan2(h, a), n.z = 0), n
}, BABYLON.Mesh.prototype.changeFrame = function(t, e) {
    if (t !== this.parent) {
        var n = this.position.clone(), i = this.rotation.clone(), o = this.parent, r = o.getWorldMatrix().clone(), s = t.getWorldMatrix().clone();
        s.invert();
        var a = r.multiply(s);
        return e ? (n.copyFrom(BABYLON.Vector3.TransformCoordinates(n, a)), i.addInPlace(BABYLON.Vector3.RotationFromMatrix(a))) : (this.parent = t, this.position.copyFrom(BABYLON.Vector3.TransformCoordinates(this.position, a)), this.rotation.addInPlace(BABYLON.Vector3.RotationFromMatrix(a))), {position: n,rotation: i}
    }
}, BABYLON.Mesh.prototype.addInternalRotation = function(t) {
    for (var e = this.getChildren(), n = 0, i = e.length; i > n; n++)
        e[n].rotation.y += t
}, BABYLON.PickingInfo.prototype.getFlatNormal = function() {
    if (!this.pickedMesh)
        return null;
    var t = this.pickedMesh.getIndices(), e = this.pickedMesh.getVerticesData(BABYLON.VertexBuffer.PositionKind), n = BABYLON.Vector3.FromArray(e, 3 * t[3 * this.faceId]), i = BABYLON.Vector3.FromArray(e, 3 * t[3 * this.faceId + 1]), o = BABYLON.Vector3.FromArray(e, 3 * t[3 * this.faceId + 2]), r = n.subtract(i), s = n.subtract(o);
    return s.cross(r).normalize()
}, BABYLON.PickingInfo.getFlatNormal = function(t, e) {
    if (!t)
        return null;
    var n = t.getIndices(), i = t.getVerticesData(BABYLON.VertexBuffer.PositionKind), o = BABYLON.Vector3.FromArray(i, 3 * n[3 * e]), r = BABYLON.Vector3.FromArray(i, 3 * n[3 * e + 1]), s = BABYLON.Vector3.FromArray(i, 3 * n[3 * e + 2]), a = o.subtract(r), l = o.subtract(s);
    return l.cross(a).normalize()
}, BABYLON.PickingInfo.GetNormal = function(t, e, n) {
    var i = t.subtract(e), o = n.subtract(e);
    return commonNormal = BABYLON.Vector3.Normalize(BABYLON.Vector3.Cross(i, o))
}, BABYLON.Mesh.prototype.duplicate = function(t, e, n) {
    var i = new BABYLON.Mesh(t, this.getScene());
    if (this._geometry) {
        var o = this._geometry.copy(BABYLON.Geometry.RandomId());
        o.applyToMesh(i)
    }
    if (BABYLON.Tools.DeepCopy(this, i, ["name", "material", "skeleton"], []), i.material = this.material, e && (i.parent = e), !n)
        for (var r = 0; r < this.getScene().meshes.length; r++) {
            var s = this.getScene().meshes[r];
            s.parent == this && s.duplicate(s.name, i)
        }
    for (r = 0; r < this.getScene().particleSystems.length; r++) {
        var a = this.getScene().particleSystems[r];
        a.emitter == this && a.clone(a.name, i)
    }
    return i.computeWorldMatrix(!0), i
}, BABYLON && function() {
    BABYLON.Mesh.prototype.getChildren;
    BABYLON.Mesh.prototype.getChildren = function() {
        return this._children = this._children || []
    };
    var t = BABYLON.Mesh.prototype.dispose;
    BABYLON.Mesh.prototype.dispose = function() {
        return this.parent = null, t.apply(this, arguments)
    }, Object.defineProperty(BABYLON.Mesh.prototype, "parent", {get: function() {
            return this._parent
        },set: function(t) {
            if (this._parent && this._parent._children)
                for (var e = this.parent._children.length; e--; )
                    this.parent._children[e] == this && this.parent._children.splice(e, 1);
            return this._parent = t, this._parent && (this._parent._children = this._parent._children || []).push(this), this._parent
        },enumerable: !0,configurable: !0})
}();
var wnp = window.wnp || {};
wnp.Widget = wnp.Widget || {}, wnp.Widget.Rotator = function() {
    var t, e, n = null, i = null, o = null, r = new BABYLON.Plane(0, 1, 0, 0), s = !1, a = 0, l = function(n) {
        t = n, e = this, n.on("click", this.onClick), n.on("refresh", this.onRefreshObject), n.on("selectObject", this.onSelectObject), n.on("deselectObject", this.onDeselectObject), n.on("mousedown", this.onMouseDown), n.on("mouseup", this.onMouseUp), n.on("mousemove", this.onMouseMove), this.setupHistory()
    };
    return l.prototype.onRefreshObject = function(t) {
        n && n.dispose(), n = null, e.addSelectionBox(t.object)
    }, l.prototype.onSelectObject = function(t) {
        e.addSelectionBox(t.object)
    }, l.prototype.onDeselectObject = function() {
        n && n.dispose(), n = null
    }, l.prototype.isActive = function() {
        return s
    }, l.prototype.onClick = function() {
    }, l.prototype.onMouseMove = function() {
        if (s) {
            var e = wanaplan.engine3D.projectMouseOnPlane(r), a = n.position, l = i.subtract(a), h = e.subtract(a), c = Math.atan2(l.x, l.z), u = Math.atan2(h.x, h.z), p = o + u - c, d = Math.PI / 2, m = Math.round(p / d), g = p - m * d;
            return Math.abs(g) < .3 && (p -= g), t.getSelectedObject().rotation.y = p, t.getSelectedObject().computeWorldMatrix(!0), t.getSelectedObject().getFloor().markAsDirty(), !1
        }
    }, l.prototype.onMouseDown = function(n) {
        if (!t.getLocker() || t.getLocker() === e) {
            var a = n.collided;
            if (a && "rotator" == a.pickedMesh.name) {
                ujs.notify("wnp.engine3d.dragcontrols.start");
                {
                    t.getSelectedObject().position
                }
                r.d = -a.pickedPoint.y, i = a.pickedPoint, o = t.getSelectedObject().rotation.y, s = !0, t.lock(e)
            }
        }
    }, l.prototype.onMouseUp = function() {
        t.getLocker() && t.getLocker() !== e || (t.getSelectedObject() && null !== o && null !== t.getSelectedObject().rotation.y && o !== t.getSelectedObject().rotation.y && ujs.notify("wnp.request.historyAction", {component: e,object: t.getSelectedObject(),params: {oldAngle: o,newAngle: t.getSelectedObject().rotation.y},action: a}), ujs.notify("wnp.engine3d.dragcontrols.end"), r.d = 0, i = null, o = null, t.unlock(e), s = !1)
    }, l.prototype.setupHistory = function() {
        this.historycmp = wanaplan.getComponentByName("HistoryComponent"), this.historycmp && this.historycmp.registerAction(a, this.undoRotate, this.redoRotate, this)
    }, l.prototype.addHistory = function(t, e, n) {
        this.historycmp && this.historycmp.actionDone(t, e, n, this)
    }, l.prototype.undoRotate = function(t, n) {
        e.historyRotate(t, n.oldAngle)
    }, l.prototype.redoRotate = function(t, n) {
        e.historyRotate(t, n.newAngle)
    }, l.prototype.historyRotate = function(t, e) {
        t.rotation.y = e, ujs.notify("wnp.request.saveHistory")
    }, l.prototype.getRotationMesh = function(t, e) {
        var n = BABYLON.Mesh.CreateCylinder("rotator", 10, 2 * t + 10, 2 * t, 32, 1, !1, wanaplan.engine3D.scene);
        return n.material = new BABYLON.StandardMaterial("rotator", wanaplan.engine3D.scene), wnp.MaterialFactory.MakeBasicColor(n.material, e), n.material.backFaceCulling = !1, n
    }, l.prototype.addSelectionBox = function(t) {
        n && n.dispose();
        var e = t.getBoundingBox(!0), i = Math.sqrt((e.maximum.x - e.minimum.x) * (e.maximum.x - e.minimum.x) / 4 + (e.maximum.z - e.minimum.z) * (e.maximum.z - e.minimum.z) / 4);
        n = new BABYLON.Mesh("selector", wanaplan.engine3D.scene), n.isVisible = !1;
        var o = new BABYLON.Color3;
        o.fromHex(-1 !== t.name.indexOf("group_") ? wnp.Assets.groupColor : wnp.Assets.mainUIColor);
        var r = this.getRotationMesh(i, o);
        r.position.y = e.minimum.y + 10, r.position.x = e.center.x, r.position.z = e.center.z, r.selectorOf = t, r.parent = n;
        var s = new BABYLON.Mesh.CreatePlan("rotator", 28, 14, wanaplan.engine3D.scene);
        s.material = new BABYLON.StandardMaterial("buttons", wanaplan.engine3D.scene), s.material.diffuseTexture = new BABYLON.Texture(wnp.Assets.toolbarTextures.rotateTexture, wanaplan.engine3D.scene), s.material.diffuseTexture.hasAlpha = !0, s.material.backFaceCulling = !1, wnp.MaterialFactory.MakeBasicMaterial(s.material), s.material.emissiveColor.copyFromFloats(1, 1, 1), s.position.z = -i - 6, s.position.y = Math.PI, s.rotation.x = Math.PI / 4, s.selectorOf = t, s.parent = r, n.position = t.getAbsolutePosition(), n.rotation = t.rotation
    }, l
}();
var wnp = window.wnp || {};
wnp.Widget = wnp.Widget || {}, wnp.Widget.Info = function() {
    var t, e, n, i, o, r = null, s = !1, a = function() {
    }, l = function(i) {
        n = i, o = this, t = new BABYLON.SpriteManager("objectMgr", wnp.Assets.toolbarTextures.infoTexture, 2, 128, wanaplan.engine3D.scene), e = new BABYLON.SpriteManager("groupMgr", wnp.Assets.toolbarTextures.infoTextureGroup, 2, 128, wanaplan.engine3D.scene), i.on("click", this.onClick), i.on("special", this.onSpecial), i.on("selectObject", this.onSelectObject), i.on("deselectObject", this.onDeselectObject)
    };
    return l.prototype.setClickCallback = function(t) {
        a = t
    }, l.prototype.onClick = function(t) {
        t.collided && "_sprite_info" == t.collided.pickedMesh.name && (a(n.getSelectedObject()), ujs.notify("wnp.engine3D.info", {}))
    }, l.prototype.onSpecial = function() {
        a(n.getSelectedObject())
    }, l.prototype.onSelectObject = function() {
        o.addInfo()
    }, l.prototype.onDeselectObject = function() {
        o.removeInfo()
    }, l.prototype.addInfo = function() {
        r && this.removeInfo();
        var o = n.getSelectedObject().getBoundingBox(), s = new BABYLON.Vector3((o.minimum.x + o.maximum.x) / 2, o.maximum.y, (o.minimum.z + o.maximum.z) / 2);
        r = n.isGroup(n.getSelectedObject()) ? new BABYLON.Sprite("info", e) : new BABYLON.Sprite("info", t), r.size = 30, i = new BABYLON.Mesh("info", wanaplan.engine3D.scene), i.isVisible = !1, i.position = n.getSelectedObject().getAbsolutePosition();
        var a = new BABYLON.Mesh("info", wanaplan.engine3D.scene);
        return a.parent = i, a.isVisible = !1, a.position = s, a.position.y += 35, r.position = a.getAbsolutePosition(), toolbar
    }, l.prototype.removeInfo = function() {
        r && (r.dispose(), i.dispose()), i = null, r = null
    }, l.prototype.isActive = function() {
        return s
    }, l
}();
var wnp = window.wnp || {};
wnp.Widget = wnp.Widget || {}, wnp.Widget.Elevation = function() {
    var t, e, n, i = document.getElementById("modalWidgets"), o = !1, r = function(e) {
        i = document.getElementById("modalWidgets"), t = e, this.imagePath = "images/remote-controller/", this.domElement = this.buildHTML(), this.defaultDomStyle = "top: 40px;right: 280px;", this.domElement.setAttribute("style", this.defaultDomStyle), i.appendChild(this.domElement), this.slider = document.getElementById("edition-slider"), this.sliderContainer = document.getElementById("edition-slider-content"), this.globalSliderContainer = document.getElementById("edition-slider-bar"), this.globalSliderContainerHeight = this.globalSliderContainer.scrollHeight, this.sliderMin = 12, this.sliderMax = 114, this.sliderPos = this.sliderMin, this.sliderSelected = !1, n = this, this.buttonState = null, this.running = !0, this.updateSliderPos(0), this.hide(), e.on("selectObject", this.onSelectObject), e.on("deselectObject", this.onDeselectObject)
    };
    return r.prototype.buildHTML = function() {
        var t = document.createElement("div");
        t.setAttribute("id", "edition-controller");
        var e = document.createElement("div");
        e.setAttribute("id", "edition-slider-bar");
        var n = document.createElement("div");
        n.setAttribute("id", "edition-slider-content");
        var i = document.createElement("img");
        return i.setAttribute("id", "edition-slider"), i.setAttribute("src", this.imagePath + "zoom-cursor.png"), n.appendChild(i), e.appendChild(n), t.appendChild(e), t
    }, r.prototype.updateDomPosition = function(t, e) {
        this.defaultDomStyle = "top: " + e + "px;right: " + t + "px;", this.domElement.setAttribute("style", this.defaultDomStyle)
    }, r.prototype.show = function() {
        this.domElement.setAttribute("style", this.defaultDomStyle)
    }, r.prototype.hide = function() {
        this.domElement.setAttribute("style", "display:none;")
    }, r.prototype.onSelectObject = function() {
        n.show(), n.updateSliderPos(), n.slider.addEventListener("pointerdown", n.onSliderMouseDown, !1), document.addEventListener("pointermove", n.onSliderMouseMove, !1), document.addEventListener("pointerup", n.onMouseUp, !1), document.addEventListener("pointercancel", n.onMouseUp, !1), o = !0
    }, r.prototype.onDeselectObject = function() {
        n.hide(), n.slider.removeEventListener("pointerdown", n.onSliderMouseDown), document.removeEventListener("pointermove", n.onSliderMouseMove), document.removeEventListener("pointerup", n.onMouseUp), document.removeEventListener("pointercancel", n.onMouseUp), o = !1
    }, r.prototype.init = function(t) {
        this.updateSliderPos(this.sliderValue(this.sceneToRelativeValue(t)))
    }, r.prototype.onSliderMouseDown = function(i) {
        i.preventDefault(), n.sliderSelected = !0, e = t.getSelectedObject().position.y
    }, r.prototype.onSliderMouseMove = function(t) {
        if (n.sliderSelected) {
            var e = (t.touches && t.touches.length ? t.touches[0].clientY : t.clientY) || 0, i = n.getValueFromMouse(e), o = n.sceneToRelativeValue(), r = n.sceneValue(i - o);
            n.setElevationVelocity(r), n.updateSliderPos(), t.preventDefault()
        }
    }, r.prototype.onMouseUp = function() {
        if (n.sliderSelected) {
            n.sliderSelected = !1;
            var i = t.getSelectedObject().position.clone(), o = i.clone();
            i.y = e;
            var r = t.getSelectedObject().rotation;
            ujs.notify("wnp.request.historyAction", {component: t,object: t.getSelectedObject(),params: {oldPosition: i,newPosition: o,oldRotation: r,newRotation: r},action: t.MOVEACTION})
        }
    }, r.prototype.setElevationVelocity = function(e) {
        t.moveObject(t.getSelectedObject(), new BABYLON.Vector3(0, e, 0))
    }, r.prototype.updateSliderPos = function(t) {
        this.sliderPos = void 0 !== t ? t : this.sliderValue(this.sceneToRelativeValue()), this.slider.style.top = this.sliderPos + "px"
    }, r.prototype.sceneToRelativeValue = function() {
        var e = 0, n = t.getSelectedObject().getFloor().structure.height, i = t.getSelectedObject().position.y;
        return i = ujs.Math.clamp(i, e, n), (i - e) / (n - e)
    }, r.prototype.sliderToRelativeValue = function(t) {
        var e = t || this.sliderPos;
        return e = ujs.Math.clamp(e, this.sliderMin, this.sliderMax), 1 - (e - this.sliderMin) / (this.sliderMax - this.sliderMin)
    }, r.prototype.sliderValue = function(t) {
        return t * (-this.sliderMax + this.sliderMin) + this.sliderMax - n.slider.offsetHeight / 2
    }, r.prototype.sceneValue = function(e) {
        return e * t.getSelectedObject().getFloor().structure.height
    }, r.prototype.isActive = function() {
        return o
    }, r.prototype.getValueFromMouse = function(t) {
        for (var e = n.slider, i = e.parentNode, o = 0, r = i; r != document && r != window; )
            o += r.offsetTop || 0, r = r.parentNode;
        return 1 - ujs.Math.clamp((t - o - this.sliderMin) / (this.sliderMax - this.sliderMin), 0, 1)
    }, r
}();
var wanaplan = wanaplan || {}, API = function() {
    var t = {};
    t.CONTEXT_2D = wanaplan.ENGINE_2D || 1, t.CONTEXT_3D = wanaplan.ENGINE_3D || 2, t.MODE_2D_NORMAL = 1, t.MODE_2D_DRAG = 2, t.MODE_2D_DRAW = 4, t.MODE_2D_CONTEXTMENU = 8, t.MODE_2D_SUBSLOPE = 16, t.ORBITCAMERA = 0, t.FPSCAMERA = 1, t.e2D = {}, t.e3D = {}, t.material = {}, t.UI = {}, t.HTML = {}, t.Utils = {}, t.setContext = function(t) {
        wanaplan.setSelectedEngine(t)
    }, t.getContext = function() {
        wanaplan.getSelectedEngine()
    }, t.getMode = function(e) {
        var n = e || wanaplan.getSelectedEngine();
        return n == t.CONTEXT_2D ? wanaplan.engine2D.getMode(name) : void (n == t.CONTEXT_3D)
    }, t.getComponent = function(t) {
        var e = wanaplan.getComponentByName(t);
        return e || Logger.warning("[WnpAPI] getComponent : The component " + t + " has not been found."), e
    }, t.setMode = function(e, n) {
        var i = n || wanaplan.getSelectedEngine();
        i == t.CONTEXT_2D ? (wanaplan.engine2D.setMode(e), wanaplan.engine2D.requestStaticDraw()) : i == t.CONTEXT_3D && wanaplan.engine2D.setMode(e)
    }, t.setCameraById = function(t) {
        var e = wanaplan.getComponentByName("CameraComponent");
        e && e.getActiveCameraId() !== t && this.e3D.switchCamera()
    }, t.getCameraId = function() {
        return wanaplan.getComponentByName("CameraComponent").getActiveCameraId()
    }, t.getData = function(t) {
        return wanaplan.structure.customData[t]
    }, t.setData = function(t, e) {
        wanaplan.structure.customData[t] = e
    }, t.getCurrentFloor = function() {
        return wanaplan.getSelectedStructure()
    }, t.getFloor = function(t) {
        var e = wanaplan.structure.members[t];
        return e || Logger.warning("[WnpAPI] getFloor : Requested floor id was not found"), e
    }, t.getWalls = function(t) {
        var e = t || wanaplan.getSelectedStructure();
        return e.walls
    }, t.getSubSlopes = function(t) {
        var e = t || wanaplan.getSelectedStructure();
        return e.subslopes
    }, t.getRooms = function(t, e) {
        var n = e || wanaplan.getSelectedStructure(), i = t || !0;
        return i ? n.internalRooms : n.externalRooms
    }, t.getObjects = function(t) {
        var e = t || wanaplan.getSelectedStructure();
        return e.objects
    }, t.registerAction = function(t, e, n, i) {
        wanaplan.getComponentByName("HistoryComponent").registerAction(t, e, n, i)
    }, t.addHistory = function(t, e, n, i) {
        wanaplan.getComponentByName("HistoryComponent").actionDone(t, e, n, i)
    }, t.material.TexturedMaterial = function(t, e) {
        return new wnp.TexturedMaterial(t, wanaplan.engine3D.scene, e)
    }, t.material.WhiteMaterial = function(t, e) {
        return new wnp.WhiteMaterial(t, wanaplan.engine3D.scene, e)
    }, t.material.LeatherMaterial = function(t, e) {
        return new wnp.LeatherMaterial(t, wanaplan.engine3D.scene, e)
    }, t.material.MetalMaterial = function(t, e) {
        return new wnp.MetalMaterial(t, wanaplan.engine3D.scene, e)
    }, t.material.WoodMaterial = function(t, e) {
        return new wnp.WoodMaterial(t, wanaplan.engine3D.scene, e)
    }, t.material.MattMaterial = function(t, e) {
        return new wnp.MattMaterial(t, wanaplan.engine3D.scene, e)
    }, t.material.GlassMaterial = function(t, e) {
        return new wnp.GlassMaterial(t, wanaplan.engine3D.scene, e)
    }, t.material.PlasticMaterial = function(t, e) {
        return new wnp.PlasticMaterial(t, wanaplan.engine3D.scene, e)
    }, t.material.TileMaterial = function(t, e) {
        return new wnp.TileMaterial(t, wanaplan.engine3D.scene, e)
    }, t.UI.getWidgetContainer = function() {
        return document.getElementById("modalWidgets")
    }, t.HTML.addHTML = function(t, e, n, i) {
        HTMLHelper.insertHTML(t, e || document.body, n, i)
    }, t.HTML.addScript = function(t, e, n) {
        HTMLHelper.addScript(t, void 0, e, n)
    }, t.HTML.addCSS = function(t, e, n) {
        HTMLHelper.addStylesheet(t, void 0, e, n)
    }, t.Utils.ajax = function(t) {
        var e = t || {};
        e.params = t.data, ujs.ajax(e)
    };
    var e = {};
    return t.listen = function(t, n) {
        return e[t] || (e[t] = []), -1 != e[t].indexOf(n) ? void Logger.warning("[WnpAPI] Event Already listened : cannot listen twice with the same function") : (document.addEventListener(t, n, !1), void e[t].push(n))
    }, t.unListen = function(t, n) {
        if (!e[t])
            return void Logger.warning("[WnpAPI] No such event is listened");
        var i = e[t].indexOf(n);
        return -1 == i ? void Logger.warning("[WnpAPI] No such function listens to this event") : (document.removeEventListener(t, n, !1), void e[t].splice(i, 1))
    }, t.getListeners = function(t) {
        return e[t]
    }, t.getFloorAsPolygon = function(t) {
        var e = wanaplan.getComponentByName("FloorComponent3D");
        if (t = 0, !(t >= e.structure.members.length)) {
            for (var n = e.structure.members[t], i = [], o = n.points.length; o--; ) {
                var r = new BABYLON.Vector2;
                r.copyFrom(n.points[o].position), i.push(r)
            }
            return i
        }
    }, t.e2D.getMousePos = function() {
        return wanaplan.engine2D._pointerManager.getStatus().planPos.clone()
    }, t.e2D.requestStaticDraw = function() {
        wanaplan.engine2D.requestStaticDraw()
    }, t.e2D.requestDynamicDraw = function() {
        wanaplan.engine2D.requestDynamicDraw()
    }, t.e3D.getCanvas = function() {
        return wanaplan.engine3D.canvas
    }, t.e3D.getScene = function() {
        return wanaplan.engine3D.scene
    }, t.e3D.getCamera = function() {
        return wanaplan.engine3D.scene.activeCamera
    }, t.e3D.switchCamera = function() {
        ujs.notify("wnp.request.cameraChanged", {activeCameraId: this.cameraActiveId,activeCamera: this.cameraActiveId ? "fpsCamera" : "orbitCamera"})
    }, t.e3D.getCameraFeatures = function() {
        return wanaplan.engine3D.cameraFeatures
    }, t.e3D.getMeshes = function() {
        return wanaplan.engine3D.scene.meshes
    }, t.e3D.getRoomMesh = function() {
        return wanaplan.engine3D.searchComponent("RoomComponent3D").mesh
    }, t.e3D.setRoomFloorMaterial = function(t) {
        t instanceof wnp.StandardMaterial && wanaplan.engine3D.searchComponent("RoomComponent3D").setSideMaterial(t)
    }, t.e3D.setRoomCeilingMaterial = function(t) {
        t instanceof wnp.StandardMaterial && wanaplan.engine3D.searchComponent("RoomComponent3D").setCeilingMaterial(t)
    }, t.e3D.getTopLevelMeshes = function() {
        for (var t = wanaplan.engine3D.scene, e = [], n = null, i = 0, o = t.meshes.length; o > i; i++)
            n = t.meshes[i].getTopLevelObject(), n.parent && -1 === e.indexOf(n) && e.push(n);
        return e
    }, t.e3D.getObjects = function() {
        for (var t, e = wanaplan.engine3D.scene, n = [], i = 0, o = e.meshes.length; o > i; i++)
            t = e.meshes[i], -1 !== t.name.indexOf("Object_") && n.push(t);
        return n
    }, t.e3D.getSunlight = function() {
        return wanaplan.engine3D.scene.lights.dir
    }, t.e3D.getSkySphere = function() {
        return wanaplan.engine3D.scene.getMeshByName("skysphere")
    }, t.e3D.getGround = function() {
        return wanaplan.engine3D.scene.getMeshByName("ground")
    }, t.e3D.projectOnPlane = function(t, e, n) {
        return wanaplan.engine3D.projectMouseOnPlane(t, e, n)
    }, t.e3D.castShadows = function(t) {
        wanaplan.engine3D.castShadows(t)
    }, t.e3D.uncastShadows = function(t) {
        wanaplan.engine3D.uncastShadows(t)
    }, t.e3D.getSelectedObject = function() {
        return wanaplan.getComponentByName("EditionComponent3D").getSelectedObject()
    }, t.e3D.intersect = function(t, e, n) {
        var i = n || wanaplan.engine3D.scene.meshes;
        return wanaplan.engine3D.collideWithMeshes(t, e, i)
    }, t.e3D.addSelectedEvent = function(t) {
        wanaplan.getComponentByName("EditionComponent3D").on("selectObject", t)
    }, t.e3D.addDeselectedEvent = function(t) {
        wanaplan.getComponentByName("EditionComponent3D").on("deselectObject", t)
    }, t
}(), API = API || {};
API.Menu = function() {
    var t = {};
    return t.MENU_TOP = "wnp.menu.top", t.MENU_TOP_2 = "wnp.menu.top.sub", t.MENU_MAIN = "wnp.menu.main", t.add = function(t, e, n) {
        var i = n || ".";
        ujs.notify(t + ".add", {item: e,menuPath: i})
    }, t
}();
var ujs = function() {
    var t = {};
    return t.triggerEvent = function(e, n) {
        if (n instanceof Array)
            for (var i = 0, o = n.length; o > i; i++)
                t.triggerEvent(e, n[i]);
        else
            e[n] && "function" == typeof e[n] && e[n](e)
    }, t.notify = function(t, e) {
        var n = document.createEvent("HTMLEvents");
        if (n.initEvent(t, !0, !1), "object" == typeof e)
            for (var i in e)
                n[i] = e[i];
        try {
            document.dispatchEvent(n)
        } catch (o) {
            Logger.warning("[ujs.notify]", o)
        }
    }, t.getURLParameter = function(t) {
        for (var e = document.location.href.split("?"), n = e[1], i = n.split("&"), o = 0, r = i.length, s = null; r > o && null == s; ) {
            var a = i[o].split("=");
            a[0] == t && (s = a[1]), o++
        }
        return s
    }, t.addOnAttribute = function(t, e, n) {
        var i = "style" == t ? ";" : " ", o = e.getAttribute(t), r = !1, s = [];
        if (null != o && "" != o) {
            s = o.split(i);
            for (var a = s.length, l = 0; a > l && !r; )
                s[l] == n && (r = !0), l++
        }
        r || s.push(n), e.setAttribute(t, s.join(" "))
    }, t.removeOnAttribute = function(t, e, n) {
        if ("object" == typeof e) {
            var i = "style" == t ? ";" : " ", o = e.getAttribute(t);
            if (null != o && "" != o) {
                for (var r = o.split(i), s = (r.length, []), a = 0, l = r.length; l > a; a++)
                    r[a] != n && s.push(r[a]);
                e.setAttribute(t, s.join(i))
            }
        }
    }, t.addClass = function(e, n) {
        if (n instanceof Array)
            for (var i = 0, o = n.length; o > i; i++)
                t.addOnAttribute("class", e, n[i]);
        else
            t.addOnAttribute("class", e, n)
    }, t.removeClass = function(e, n) {
        if (n instanceof Array)
            for (var i = 0, o = n.length; o > i; i++)
                t.removeOnAttribute("class", e, n[i]);
        else
            t.removeOnAttribute("class", e, n)
    }, t.replaceClass = function(e, n, i) {
        if (e instanceof Array)
            for (var o = 0, r = e.length; r > o; o++)
                t.removeClass(e[o], n), t.addClass(e[o], i);
        else
            t.removeClass(e, n), t.addClass(e, i)
    }, t.removeClasses = function(t) {
        t.setAttribute("class", "")
    }, t.addStyle = function(e, n) {
        if (n instanceof Array)
            for (var i = 0, o = n.length; o > i; i++)
                t.addOnAttribute("style", e, n[i]);
        else
            t.addOnAttribute("style", e, n)
    }, t.removeStyle = function(e, n) {
        if (n instanceof Array)
            for (var i = 0, o = n.length; o > i; i++)
                t.removeOnAttribute("style", e, n[i]);
        t.removeOnAttribute("style", e, n)
    }, t.hasClass = function(t, e) {
        var n = t.getAttribute("class"), i = !1;
        if (null != n)
            for (var o = n.split(" "), r = 0, s = o.length; s > r && !i; )
                o[r] == e && (i = !0), r++;
        return i
    }, t.mergeObjects = function(e, n, i, o) {
        var i = i === !0 ? !0 : !1, r = "array" == o ? [] : {};
        for (var s in e)
            e.hasOwnProperty(s) && (r[s] = e[s]);
        for (var s in n)
            n.hasOwnProperty(s) && "undefined" != typeof n[s] && (r[s] = n[s] instanceof Array && i ? t.mergeObjects(r[s], n[s], i, "array") : n[s] instanceof Object && i ? t.mergeObjects(r[s], n[s]) : n[s]);
        return r
    }, t.getProperty = function(t, e) {
        var n, i, o = e.split(".");
        for (n = 0; n < o.length; n++) {
            if (i = t[o[n]], n == o.length - 1)
                return t[o[n]];
            void 0 === i && (i = t[o[n]] = {}), t = i
        }
        return !1
    }, t.setProperty = function(t, e, n) {
        var i, o, r = e.split(".");
        for (i = 0; i < r.length; i++)
            o = t[r[i]], void 0 !== n && i == r.length - 1 ? o = t[r[i]] = n : void 0 === o && (o = t[r[i]] = {}), t = o;
        return t
    }, t.ajax = function(t) {
        var e, n = t.url, i = t.method || "GET", o = t.params || "", r = t.success || null, s = t.onerror || null, a = "undefined" != typeof t.async ? t.async : !0, l = "undefined" != typeof t.withCredentials ? t.withCredentials : !1;
        if (e = "undefined" != typeof window ? window.XMLHttpRequest ? new XMLHttpRequest : new ActiveXObject("Microsoft.XMLHTTP") : new XMLHttpRequest, t.mimeType && e.overrideMimeType(t.mimeType), "POST" == i)
            e.open("POST", n, a), l && (e.withCredentials = !0), e.setRequestHeader("Content-type", "application/x-www-form-urlencoded"), e.onreadystatechange = function() {
                4 == e.readyState && 200 == e.status ? null != r && r(e.responseText) : 4 == e.readyState && 200 != e.status && null != s && s()
            }, e.send(o);
        else {
            var h = "" != o ? n + "?" + o : n;
            e.open("GET", h, a), l && (e.withCredentials = !0), e.onreadystatechange = function() {
                4 == e.readyState && 200 == e.status ? null != r && r(e.responseText) : 4 == e.readyState && 200 != e.status && null != s && s()
            }, e.send(null)
        }
    }, t.post = function(e, n) {
        var n = n || {};
        return n.method = "POST", n.url = e, t.ajax(n)
    }, t.loadCSS = function(t, e) {
        var n = document.createElement("link");
        if (n.setAttribute("rel", "stylesheet"), n.setAttribute("type", "text/css"), n.setAttribute("href", t), "object" == typeof e)
            for (var i in e)
                n.setAttribute(i, e[i]);
        document.getElementsByTagName("head")[0].appendChild(n)
    }, t.loadJavaScript = function(t, e) {
        var n = document.createElement("script");
        if (n.setAttribute("src", t), "object" == typeof e)
            for (var i in e)
                n.setAttribute(i, e[i]);
        document.getElementsByTagName("body")[0].appendChild(n)
    }, t.inArray = function(t, e) {
        return e.indexOf(t) > -1
    }, t.cloneArray = function(e, n) {
        for (var i = [], n = n || !1, o = 0, r = e.length; r > o; o++)
            i[o] = n ? object[o] instanceof Array ? t.cloneArray(e[o]) : e[o] instanceof Object ? t.cloneObject(e[o]) : e[o] : e[o];
        return i
    }, t.cloneObject = function(e) {
        var n = {};
        for (var i in e)
            e.hasOwnProperty(i) && (n[i] = e[i] instanceof Array ? t.cloneArray(e[i]) : e[i] instanceof Object ? t.cloneObject(e[i]) : e[i]);
        return n
    }, t.insertSorted = function(t, e, n) {
        var i = 0;
        if (0 == n.length)
            n.push(t);
        else {
            for (; i < n.length && e(t, n[i]) > 0; )
                i++;
            n.splice(i, 0, t)
        }
        return n
    }, t.getByClass = function(t) {
        return document.getElementsByClassName(t)
    }, t.getByTag = function(t) {
        return document.getElementsByTagName(t)
    }, t.getById = function(t) {
        return document.getElementById(t)
    }, t.isDef = function(t) {
        return "undefined" != typeof t
    }, t.removeSpaces = function(t) {
        var e = new RegExp("[ ]+", "g");
        return t.replace(e, "")
    }, t.stringToFunction = function(t) {
        for (var e = t.split("."), n = window || this, i = 0, o = e.length; o > i; i++)
            n = n[e[i]];
        if ("function" != typeof n)
            throw new Error("function not found");
        return n
    }, t.deserializeObject = function(e, n, i, o) {
        var r, s = null;
        if (e && e.class && e.class.name && !n) {
            var a = t.stringToFunction(e.class.name);
            s = a.Deserialize(e)
        } else if (e instanceof Array) {
            if (0 == e.length)
                return s;
            s = n || [];
            for (var l = 0; l < e.length; l++)
                r = t.deserializeObject(e[l]), null !== r && s.push(r)
        } else if (e instanceof Object) {
            s = n || {};
            for (var h in e)
                (!i || i && -1 != i.indexOf(h)) && (!o || o && -1 == o.indexOf(h)) && (r = t.deserializeObject(e[h]), null !== r && (s[h] = r))
        } else
            void 0 !== s && (s = e);
        return s
    }, t.serializeObject = function(e, n, i, o) {
        var r, s;
        if (e && e.serialize && !n)
            r = e.serialize();
        else if (e instanceof Array) {
            r = [];
            for (var a = 0; a < e.length; a++)
                r.push(t.serializeObject(e[a]));
            if (0 == r.length)
                return null
        } else if (e instanceof Object) {
            if (!(e instanceof Function)) {
                r = n || {};
                for (var l in e)
                    e.hasOwnProperty(l) && (!i || i && -1 != i.indexOf(l)) && (!o || o && -1 == o.indexOf(l)) && (s = t.serializeObject(e[l]), void 0 !== s && null !== s && (r[l] = s))
            }
        } else
            r = e;
        return r
    }, t
}(), ujs = window.ujs || {};
ujs.Math = ujs.Math || {}, function() {
    ujs.Math.getRandomInt = function(t, e) {
        return Math.floor(Math.random() * (e - t + 1)) + t
    }, ujs.Math.clamp = function(t, e, n) {
        return e > t ? e : t > n ? n : t
    }, ujs.Math.lerp = function(t, e, n) {
        return n = 0 > n ? 0 : n, n = n > 1 ? 1 : n, t + (e - t) * n
    }, ujs.Math.sign = function(t) {
        return 0 > t ? -1 : 1
    }
}();
var PolygonMerger = function() {
    var t = 1e5, e = function(t, e) {
        var n;
        n = t, t = e, e = n
    }, n = function(e) {
        return Math.round(e * t) / t
    }, i = function(t) {
        this.position = new BABYLON.Vector2, this.position.copyFromFloats(n(t.x), n(t.y)), this.parents = []
    };
    i.prototype.replaceParent = function(t, e) {
        var n = this.parents.indexOf(t);
        -1 != n && (this.parents[n] = e)
    }, i.prototype.clone = function() {
        var t = new i(this.position);
        return t.parents = this.parents.slice(0), t
    }, i.prototype.removeParent = function(t) {
        var e = this.parents.indexOf(t);
        -1 != e && this.parents.splice(e, 1)
    };
    var o = function() {
        this.points = [], this.intersections = [], this.parent = null, this.parentWallSide = null
    };
    o.prototype.length = function() {
        return this.points[1].position.distanceTo(this.points[0].position)
    }, o.prototype.clone = function() {
        for (var t = new o, e = 0, n = this.points.length; n > e; e++)
            t.points.push(this.points[e].clone());
        return t.parent = this.parent, t.parentWallSide = this.parentWallSide, t
    };
    var r = function() {
        this.edges = []
    };
    r.prototype.fromWall = function(t) {
        var e = t.getPolygon();
        if (!(e.length < 1)) {
            for (var n, r, s = null, a = null, l = 0, h = e.length; h > l; l++)
                n = new i(e[l]), r = new o, r.parent = t, r.points.push(n), n.parents.push(r), a && (n.parents.push(a), a.points.push(n)), a = r, s = n, this.edges.push(r);
            this.edges[0].points[0].parents.push(r), r.points.push(this.edges[0].points[0]);
            for (var l = 0, h = this.edges.length; h > l; l++)
                this.edges[l].parentWallSide = this.getEdgeNormal(l).normalize();
            return this
        }
    };
    var s, a, l;
    o.prototype.debug = function() {
        s.save(), s.strokeStyle = "#FF0000", s.lineWidth = 3, s.translate(a.x, a.y), s.scale(l, l), s.beginPath(), s.moveTo(this.points[0].position.x, this.points[0].position.y), s.lineTo(this.points[1].position.x, this.points[1].position.y), s.stroke(), s.restore()
    }, r.prototype.debug = function(t, e, n) {
        t.save(), t.strokeStyle = "#FF0000", t.lineWidth = 6, t.translate(e.x, e.y), t.scale(n, n);
        for (var i = 0, o = this.edges.length; o > i; i++)
            t.beginPath(), t.moveTo(this.edges[i].points[0].position.x, this.edges[i].points[0].position.y), t.lineTo(this.edges[i].points[1].position.x, this.edges[i].points[1].position.y), t.stroke();
        t.restore()
    }, r.prototype.computeIntersections = function(t) {
        for (var e = [], n = 0, o = this.edges.length; o > n; n++)
            for (var r = 0, s = t.edges.length; s > r; r++) {
                var a = BABYLON.Vector2.SegmentIntersection(this.edges[n].points[0].position, this.edges[n].points[1].position, t.edges[r].points[0].position, t.edges[r].points[1].position, 0, Math.PI / 2e3);
                if (a) {
                    var l = new i(a);
                    l.parents.push(this.edges[n], t.edges[r]), this.edges[n].intersections.push(l), t.edges[r].intersections.push(l), e.push(l)
                }
            }
        this.mergeIntersections(e)
    }, r.prototype.smashEdge = function(t, e) {
        for (var n = new i(BABYLON.Vector2.Lerp(e.position, t.position, .5)), o = this.edges.length - 1; o >= 0; o--)
            for (var r = 0; 2 > r; r++)
                (this.edges[o].points[r] == t || this.edges[o].points[r] == e) && (this.edges[o].points[r] = n)
    }, r.prototype.splitAtIntersections = function(t) {
        var e, n, i = 1e-5, r = [], s = null, a = function(t, n, i) {
            return e = new o, e.parent = i.parent, e.parentWallSide = i.parentWallSide, e.points[0] = t, e.points[1] = n, t.replaceParent(i, e), n.replaceParent(i, e), e
        }, l = function(t, e) {
            t.intersections.sort(function(t, n) {
                return t.position.distanceTo(e) - n.position.distanceTo(e)
            })
        }, h = (new BABYLON.Vector2, function(e, n) {
            return this.edges[e].parentWallSide.dot(t.edges[n].parentWallSide) >= 0
        }.bind(this)), c = new BABYLON.Vector2, u = function(e, o, r) {
            return c.copyFrom(e.position).lerp(o.position, .5), n = t.edgeIndexVeryClose(c, i), -1 != n ? !h(r, n) : t.isPointIn(c)
        }, p = function(t, e, n) {
            return t.position.distanceTo(e.position) < i ? !0 : !u(t, e, n)
        };
        if (!(this.edges.length < 1)) {
            for (var d = 0, m = this.edges.length; m > d; d++) {
                s = this.edges[d].points[0], l(this.edges[d], s.position);
                for (var g = 0, f = this.edges[d].intersections.length; f > g; g++)
                    p(this.edges[d].intersections[g], s, d) ? r.push(a(s, this.edges[d].intersections[g], this.edges[d])) : PolygonMerger.addDeletedEdge(a(s.clone(), this.edges[d].intersections[g].clone(), this.edges[d])), s = this.edges[d].intersections[g];
                p(this.edges[d].points[1], s, d) ? r.push(a(s, this.edges[d].points[1], this.edges[d])) : PolygonMerger.addDeletedEdge(a(s.clone(), this.edges[d].points[1].clone(), this.edges[d]))
            }
            return r
        }
    }, r.prototype.getInstancesOfPoint = function(t) {
        for (var e = [], n = 0, i = this.edges.length; i > n; n++)
            for (var o = 0; 2 > o; o++)
                this.edges[n].points[o] === t && e.push({edgeIndex: n,pointIndex: o});
        return e
    };
    var h = function(t, e) {
        var n = this.edges[t.edgeIndex], i = n.points[(t.pointIndex + 1) % 2];
        return i.position.subtract(e.position)
    };
    r.prototype.updateParents = function() {
        for (var t = this.edges.length - 1; t >= 0; t--)
            for (var e = 0; 2 > e; e++)
                if (this.edges[t].points[e].parents.length < 2)
                    this.edges[t].points[e].parents.push(this.edges[t]);
                else if (-1 == this.edges[t].points[e].parents.indexOf(this.edges[t])) {
                    var n = this.getInstancesOfPoint(this.edges[t].points[e]);
                    if (3 === n.length) {
                        for (var o, r, s, a, l = .01, c = +1 / 0, u = +1 / 0, p = 0; 3 > p; p++) {
                            a = this.edges[n[p].edgeIndex].length(), u > a && (u = a, s = n[p].edgeIndex);
                            for (var d = p + 1; 3 > d; d++)
                                o = Math.abs(a - this.edges[n[d].edgeIndex].length()), c > o && (r = n[p].edgeIndex, c = o)
                        }
                        l > c ? this.edges.splice(r, 1) : this.edges.splice(s, 1);
                        continue
                    }
                    if (4 !== n.length)
                        continue;
                    var m = this.edges[t].points[e];
                    m.parents.length = 0;
                    var g, f = new i(this.edges[t].points[e].position.clone()), y = n[0];
                    n.splice(0, 1);
                    for (var p = 0; 3 > p; p++)
                        if (this.edges[n[p].edgeIndex].parent === this.edges[y.edgeIndex].parent) {
                            g = n[p], n.splice(p, 1);
                            break
                        }
                    if (!g) {
                        Logger.warning("Erreur, instance jumelle du point multiple non trouvée");
                        continue
                    }
                    for (var _ = h.call(this, y, m), v = h.call(this, g, m), b = BABYLON.Math.NormalizeAngle(Math.atan2(v.y, v.x) - Math.atan2(_.y, _.x), !0), w = [], p = 0; 2 > p; p++)
                        w.push(h.call(this, n[p], m)), w[p].angle = BABYLON.Math.NormalizeAngle(Math.atan2(w[p].y, w[p].x) - Math.atan2(_.y, _.x), !0);
                    {
                        var x, C;
                        Math.PI / 40
                    }
                    x = w[0].angle > b ? w[0].angle > w[1].angle ? n[0] : n[1] : w[0].angle < w[1].angle ? n[0] : n[1], n.splice(n.indexOf(x), 1), C = n[0], f.parents.push(this.edges[y.edgeIndex], this.edges[x.edgeIndex]), this.edges[y.edgeIndex].points[this.edges[y.pointIndex]] = f, this.edges[x.edgeIndex].points[this.edges[x.pointIndex]] = f, f.parents.push(this.edges[C.edgeIndex], this.edges[g.edgeIndex])
                }
    }, r.prototype.mergeIntersections = function(t) {
        for (var e = 1e-5, n = 0, i = t.length; i > n; n++)
            for (var o = t.length - 1; o > n; o--)
                t[n].position.distanceTo(t[o].position) < e && (t[o].parents[0].intersections.splice(t[o].parents[0].intersections.indexOf(t[o]), 1), t[o].parents[1].intersections.splice(t[o].parents[1].intersections.indexOf(t[o]), 1), t.splice(o, 1))
    }, r.prototype.deleteSmallEdges = function() {
        var t = 1e-5;
        if (!(this.edges.length <= 3)) {
            for (var e = 0, n = this.edges.length; n > e; e++)
                this.edges[e].length() < t && (this.smashEdge(this.edges[e].points[0], this.edges[e].points[1], this.edges[e]), this.edges.splice(e, 1), e--, n--);
            this.updateParents()
        }
    }, r.prototype.normalizePolygon = function() {
        for (var t, e = 1e-5, n = this.edges, r = 0, s = n.length; s > r; r++)
            for (var a = r + 1; s > a; a++)
                if (t = BABYLON.Vector2.SegmentIntersection(n[r].points[0].position, n[r].points[1].position, n[a].points[0].position, n[a].points[1].position, -e)) {
                    var l = new i(t), h = new i(t), c = new o;
                    c.parent = n[r].parent, c.parentWallSide = n[r].parentWallSide, c.points.push(n[r].points[0], l), n[r].points[0] = l, l.parents.push(c, n[r]);
                    var u = new o;
                    u.parent = n[a].parent, u.parentWallSide = n[a].parentWallSide, u.points.push(n[a].points[0], h), n[a].points[0] = h, h.parents.push(u, n[a]), n.push(c, u)
                }
    }, r.prototype.distanceTo = function(t) {
        for (var e, n = new BABYLON.Vector2, i = +1 / 0, o = 0, r = this.edges.length; r > o; o++)
            n.copy(t), n = n.projectOnSegment(this.edges[o].points[0].position, this.edges[o].points[1].position), e = n.distanceTo(t), i = Math.min(i, e);
        return i
    }, r.prototype.edgeIndexVeryClose = function(t, e) {
        for (var n, i = new BABYLON.Vector2, o = 0, r = this.edges.length; r > o; o++)
            if (i.copyFrom(t), i = i.projectOnSegment(this.edges[o].points[0].position, this.edges[o].points[1].position), n = i.distanceTo(t), e > n)
                return o;
        return -1
    }, r.prototype.isPointIn = function(t) {
        var i, o, r, s, t = t.clone();
        t.x = n(t.x), t.y = n(t.y);
        for (var a = [], l = !1, h = 0, c = this.edges.length; c > h; h++)
            i = this.edges[h].points[0].position.x, o = this.edges[h].points[0].position.y, r = this.edges[h].points[1].position.x, s = this.edges[h].points[1].position.y, (this.edges[h].points[0].alreadyVisited || this.edges[h].points[1].alreadyVisited) && (e(i, r), e(o, s)), this.edges[h].points[0].alreadyVisited = !0, this.edges[h].points[1].alreadyVisited = !0, a.push(this.edges[h].points[0], this.edges[h].points[1]), s === o && s === t.y ? (i <= t.x && t.x < r || r <= t.x && t.x < i) && (l = !l) : (o <= t.y && t.y < s || s <= t.y && t.y < o) && t.x <= n((r - i) * (t.y - o) / (s - o) + i) && (l = !l);
        for (var h = 0, c = a.length; c > h; h++)
            a[h].alreadyVisited = !1;
        return l
    }, r.prototype.getEdgeNormal = function(t) {
        var i, o, r, s, a = [], l = BABYLON.Vector2.Lerp(this.edges[t].points[0].position, this.edges[t].points[1].position, .5), h = "x", c = "y";
        l.y === this.edges[t].points[0].position.y && (h = "y", c = "x");
        for (var u = !1, p = 0, d = this.edges.length; d > p; p++)
            t !== p && (i = this.edges[p].points[0].position[h], o = this.edges[p].points[0].position[c], r = this.edges[p].points[1].position[h], s = this.edges[p].points[1].position[c], (this.edges[p].points[0].alreadyVisited || this.edges[p].points[1].alreadyVisited) && (e(i, r), e(o, s)), this.edges[p].points[0].alreadyVisited = !0, this.edges[p].points[1].alreadyVisited = !0, a.push(this.edges[p].points[0], this.edges[p].points[1]), s === o && s === l[c] ? (i <= l[h] && l[h] < r || r <= l[h] && l[h] < i) && (u = !u) : (o <= l[c] && l[c] < s || s <= l[c] && l[c] < o) && l[h] <= n((r - i) * (l[c] - o) / (s - o) + i) && (u = !u));
        for (var p = 0, d = a.length; d > p; p++)
            a[p].alreadyVisited = !1;
        var m = this.edges[t].points[1].position.subtract(this.edges[t].points[0].position);
        return m.copyFromFloats(-m.y, m.x).normalize(), (!u && m[h] <= 0 || u && m[h] > 0) && m.scaleInPlace(-1), m
    }, r.prototype.mergeVertices = function() {
        for (var t = [], e = 1e-5, n = 0, i = this.edges.length; i > n; n++)
            -1 === t.indexOf(this.edges[n].points[0]) && t.push(this.edges[n].points[0]), -1 === t.indexOf(this.edges[n].points[1]) && t.push(this.edges[n].points[1]);
        for (var n = 0, i = t.length; i > n; n++)
            for (var o = n + 1; i > o; o++)
                if (t[n].position.distanceTo(t[o].position) < e) {
                    for (var r = t[n].parents, s = t[o].parents, a = -1, l = -1, h = 0; 2 > h; h++)
                        -1 === this.edges.indexOf(r[h]) && (a = (h + 1) % 2), -1 === this.edges.indexOf(s[h]) && (l = (h + 1) % 2);
                    -1 != a && -1 != l && (s[l].points.splice(s[l].points.indexOf(t[o]), 1), s[l].points.push(t[n]), t[n].parents[0] = r[a], t[n].parents[1] = s[l])
                }
    }, r.prototype.processCycles = function() {
        for (var t, e = 200, n = [], i = function(t, e) {
            var n = (e.points.indexOf(t) + 1) % 2, i = e.points[n], o = (i.parents.indexOf(e) + 1) % 2;
            return {edge: i.parents[o],point: i}
        }, r = function(t) {
            var n, r = [], s = t, a = t.points[0], l = a, h = 0;
            a.parents.length = 0, a.parentWallSide = [];
            do {
                if (null == s || !(s instanceof o))
                    return null;
                r.push(a), a.parents.push(s.parent), a.parentWallSide.push(s.parentWallSide), s.visited = !0, n = i(a, s), a = n.point, a.parents.length = 0, a.parentWallSide = [], a.parents.push(s.parent), a.parentWallSide.push(s.parentWallSide), s = n.edge
            } while (++h < 3 || a !== l && e > h);
            return a.parents.push(t.parent), a.parentWallSide.push(t.parentWallSide), h == e ? null : r
        }, s = 0, a = this.edges.length; a > s; s++)
            this.edges[s].visited || (t = r(this.edges[s]), t && n.push(t));
        return n
    }, r.prototype.toShape = function() {
        return void console.warn("NOT COMPATIBLE WITH BABYLON.JS")
    };
    var c, u, p = [], d = function() {
    };
    return d.addDeletedEdge = function(t) {
        p.push(t)
    }, d.merge = function(t, e, n, i, o) {
        var h = [];
        p.length = 0;
        for (var d = 0, m = t.length; m > d; d++)
            h.push((new r).fromWall(t[d]));
        if (h.length < 1)
            return null;
        for (var g, f, y = h[0], d = 1, m = h.length; m > d; d++)
            h[d].normalizePolygon(), y.computeIntersections(h[d]), g = h[d].splitAtIntersections(y), f = y.splitAtIntersections(h[d]), y.edges = g.concat(f), y.deleteSmallEdges();
        return y.mergeVertices(), n && (s = n, a = i, l = o), c = y, e ? y.edges : u = y.processCycles()
    }, d.reconstitutePolygon = function(t, e) {
        var n = [], i = [], s = [], a = new r;
        e || (e = this.getCachedPolygon());
        for (var l, h, c = function() {
            if (!(a.edges.length < 2))
                for (var e, n, r, l, h = 0, c = i.length; c > h; h++)
                    if (2 !== i[h].parents.length) {
                        e = +1 / 0, r = null;
                        for (var u = h + 1; c > u; u++)
                            1 === i[u].parents.length && (n = i[u].position.distanceTo(i[h].position), e > n && (e = n, r = i[u]));
                        null !== r ? (l = new o, l.parent = t, l.points.push(i[h], r), i[h].parents.push(l), r.parents.push(l), s.push(l)) : Logger.warning("Warning : could not connect every point in reconstitutePolygon")
                    }
        }, u = 0, p = e.edges.length; p > u; u++)
            if (e.edges[u].parent === t) {
                l = e.edges[u].clone();
                for (var d = 0; 2 > d; d++)
                    h = n.indexOf(e.edges[u].points[d]), -1 === h ? (n.push(e.edges[u].points[d]), i.push(l.points[d]), l.points[d].parents.length = 0) : l.points[d] = i[h], l.points[d].parents.push(l);
                a.edges.push(l)
            }
        return c(), a.edges = a.edges.concat(s), a.edges.length > 2 ? a : null
    }, d.simplifyCycles = function(t) {
        for (var e = 0, n = t.length; n > e; e++)
            this.simplifyCycle(t[e])
    }, d.simplifyCycle = function(t) {
        for (var e = function(t, e) {
            return t.parents[0] == e.parents[0] || t.parents[0] == e.parents[1] ? t.parents[0] : t.parents[1]
        }, n = function(t, e, n) {
            var i, o = Math.PI / 80, r = 10, s = e.subtract(t), a = n.subtract(e);
            return s.length() < r || a.length() < r ? !1 : (i = Math.abs(s.determinant(a)), o > i)
        }, i = 0, o = t.length; o > i; i++)
            n(t[i].position, t[(i + 1) % o].position, t[(i + 2) % o].position) && e(t[i], t[(i + 1) % o]).height === e(t[(i + 1) % o], t[(i + 2) % o]).height && (console.log("colinear ! "), t.splice((i + 1) % o, 1), i--, o--);
        return t
    }, d.getCachedCycles = function() {
        return u
    }, d.getCachedPolygon = function() {
        return c
    }, d.getCachedDeletedEdges = function() {
        return p
    }, d
}();
!function(t) {
    if ("object" == typeof exports)
        module.exports = t();
    else if ("function" == typeof define && define.amd)
        define(t);
    else {
        var e;
        "undefined" != typeof window ? e = window : "undefined" != typeof global ? e = global : "undefined" != typeof self && (e = self), e.poly2tri = t()
    }
}(function() {
    return function t(e, n, i) {
        function o(s, a) {
            if (!n[s]) {
                if (!e[s]) {
                    var l = "function" == typeof require && require;
                    if (!a && l)
                        return l(s, !0);
                    if (r)
                        return r(s, !0);
                    throw new Error("Cannot find module '" + s + "'")
                }
                var h = n[s] = {exports: {}};
                e[s][0].call(h.exports, function(t) {
                    var n = e[s][1][t];
                    return o(n ? n : t)
                }, h, h.exports, t, e, n, i)
            }
            return n[s].exports
        }
        for (var r = "function" == typeof require && require, s = 0; s < i.length; s++)
            o(i[s]);
        return o
    }({1: [function(t, e) {
                e.exports = {version: "1.3.3"}
            }, {}],2: [function(t, e) {
                "use strict";
                var n = function(t, e) {
                    this.point = t, this.triangle = e || null, this.next = null, this.prev = null, this.value = t.x
                }, i = function(t, e) {
                    this.head_ = t, this.tail_ = e, this.search_node_ = t
                };
                i.prototype.head = function() {
                    return this.head_
                }, i.prototype.setHead = function(t) {
                    this.head_ = t
                }, i.prototype.tail = function() {
                    return this.tail_
                }, i.prototype.setTail = function(t) {
                    this.tail_ = t
                }, i.prototype.search = function() {
                    return this.search_node_
                }, i.prototype.setSearch = function(t) {
                    this.search_node_ = t
                }, i.prototype.findSearchNode = function() {
                    return this.search_node_
                }, i.prototype.locateNode = function(t) {
                    var e = this.search_node_;
                    if (t < e.value) {
                        for (; e = e.prev; )
                            if (t >= e.value)
                                return this.search_node_ = e, e
                    } else
                        for (; e = e.next; )
                            if (t < e.value)
                                return this.search_node_ = e.prev, e.prev;
                    return null
                }, i.prototype.locatePoint = function(t) {
                    var e = t.x, n = this.findSearchNode(e), i = n.point.x;
                    if (e === i) {
                        if (t !== n.point)
                            if (t === n.prev.point)
                                n = n.prev;
                            else {
                                if (t !== n.next.point)
                                    throw new Error("poly2tri Invalid AdvancingFront.locatePoint() call");
                                n = n.next
                            }
                    } else if (i > e)
                        for (; (n = n.prev) && t !== n.point; )
                            ;
                    else
                        for (; (n = n.next) && t !== n.point; )
                            ;
                    return n && (this.search_node_ = n), n
                }, e.exports = i, e.exports.Node = n
            }, {}],3: [function(t, e) {
                "use strict";
                var n = t("./xy"), i = function(t, e) {
                    this.x = +t || 0, this.y = +e || 0, this._p2t_edge_list = null
                };
                i.prototype.toString = function() {
                    return n.toStringBase(this)
                }, i.prototype.clone = function() {
                    return new i(this.x, this.y)
                }, i.prototype.set_zero = function() {
                    return this.x = 0, this.y = 0, this
                }, i.prototype.set = function(t, e) {
                    return this.x = +t || 0, this.y = +e || 0, this
                }, i.prototype.negate = function() {
                    return this.x = -this.x, this.y = -this.y, this
                }, i.prototype.add = function(t) {
                    return this.x += t.x, this.y += t.y, this
                }, i.prototype.sub = function(t) {
                    return this.x -= t.x, this.y -= t.y, this
                }, i.prototype.mul = function(t) {
                    return this.x *= t, this.y *= t, this
                }, i.prototype.length = function() {
                    return Math.sqrt(this.x * this.x + this.y * this.y)
                }, i.prototype.normalize = function() {
                    var t = this.length();
                    return this.x /= t, this.y /= t, t
                }, i.prototype.equals = function(t) {
                    return this.x === t.x && this.y === t.y
                }, i.negate = function(t) {
                    return new i(-t.x, -t.y)
                }, i.add = function(t, e) {
                    return new i(t.x + e.x, t.y + e.y)
                }, i.sub = function(t, e) {
                    return new i(t.x - e.x, t.y - e.y)
                }, i.mul = function(t, e) {
                    return new i(t * e.x, t * e.y)
                }, i.cross = function(t, e) {
                    return "number" == typeof t ? "number" == typeof e ? t * e : new i(-t * e.y, t * e.x) : "number" == typeof e ? new i(e * t.y, -e * t.x) : t.x * e.y - t.y * e.x
                }, i.toString = n.toString, i.compare = n.compare, i.cmp = n.compare, i.equals = n.equals, i.dot = function(t, e) {
                    return t.x * e.x + t.y * e.y
                }, e.exports = i
            }, {"./xy": 10}],4: [function(t, e) {
                "use strict";
                var n = t("./xy"), i = function(t, e) {
                    this.name = "PointError", this.points = e = e || [], this.message = t || "Invalid Points!";
                    for (var i = 0; i < e.length; i++)
                        this.message += " " + n.toString(e[i])
                };
                i.prototype = new Error, i.prototype.constructor = i, e.exports = i
            }, {"./xy": 10}],5: [function(t, e, n) {
                (function(e) {
                    "use strict";
                    var i = e.poly2tri;
                    n.noConflict = function() {
                        return e.poly2tri = i, n
                    }, n.VERSION = t("../dist/version.json").version, n.PointError = t("./pointerror"), n.Point = t("./point"), n.Triangle = t("./triangle"), n.SweepContext = t("./sweepcontext");
                    var o = t("./sweep");
                    n.triangulate = o.triangulate, n.sweep = {Triangulate: o.triangulate}
                }).call(this, "undefined" != typeof self ? self : "undefined" != typeof window ? window : {})
            }, {"../dist/version.json": 1,"./point": 3,"./pointerror": 4,"./sweep": 6,"./sweepcontext": 7,"./triangle": 8}],6: [function(t, e, n) {
                "use strict";
                function i(t) {
                    t.initTriangulation(), t.createAdvancingFront(), o(t), r(t)
                }
                function o(t) {
                    var e, n = t.pointCount();
                    for (e = 1; n > e; ++e)
                        for (var i = t.getPoint(e), o = s(t, i), r = i._p2t_edge_list, l = 0; r && l < r.length; ++l)
                            a(t, r[l], o)
                }
                function r(t) {
                    for (var e = t.front().head().next.triangle, n = t.front().head().next.point; !e.getConstrainedEdgeCW(n); )
                        e = e.neighborCCW(n);
                    t.meshClean(e)
                }
                function s(t, e) {
                    var n = t.locateNode(e), i = c(t, e, n);
                    return e.x <= n.point.x + Y && u(t, n), p(t, i), i
                }
                function a(t, e, n) {
                    t.edge_event.constrained_edge = e, t.edge_event.right = e.p.x > e.q.x, h(n.triangle, e.p, e.q) || (w(t, e, n), l(t, e.p, e.q, n.triangle, e.q))
                }
                function l(t, e, n, i, o) {
                    if (!h(i, e, n)) {
                        var r = i.pointCCW(o), s = j(n, r, e);
                        if (s === z.COLLINEAR)
                            throw new I("poly2tri EdgeEvent: Collinear not supported!", [n, r, e]);
                        var a = i.pointCW(o), c = j(n, a, e);
                        if (c === z.COLLINEAR)
                            throw new I("poly2tri EdgeEvent: Collinear not supported!", [n, a, e]);
                        s === c ? (i = s === z.CW ? i.neighborCCW(o) : i.neighborCW(o), l(t, e, n, i, o)) : S(t, e, n, i, o)
                    }
                }
                function h(t, e, n) {
                    var i = t.edgeIndex(e, n);
                    if (-1 !== i) {
                        t.markConstrainedEdgeByIndex(i);
                        var o = t.getNeighbor(i);
                        return o && o.markConstrainedEdgeByPoints(e, n), !0
                    }
                    return !1
                }
                function c(t, e, n) {
                    var i = new N(e, n.point, n.next.point);
                    i.markNeighbor(n.triangle), t.addToMap(i);
                    var o = new R(e);
                    return o.next = n.next, o.prev = n, n.next.prev = o, n.next = o, g(t, i) || t.mapTriangleToNodes(i), o
                }
                function u(t, e) {
                    var n = new N(e.prev.point, e.point, e.next.point);
                    n.markNeighbor(e.prev.triangle), n.markNeighbor(e.triangle), t.addToMap(n), e.prev.next = e.next, e.next.prev = e.prev, g(t, n) || t.mapTriangleToNodes(n)
                }
                function p(t, e) {
                    for (var n, i = e.next; i.next && (n = m(i), !(n > F || -F > n)); )
                        u(t, i), i = i.next;
                    for (i = e.prev; i.prev && (n = m(i), !(n > F || -F > n)); )
                        u(t, i), i = i.prev;
                    e.next && e.next.next && (n = d(e), V > n && _(t, e))
                }
                function d(t) {
                    var e = t.point.x - t.next.next.point.x, n = t.point.y - t.next.next.point.y;
                    return Math.atan2(n, e)
                }
                function m(t) {
                    var e = t.next.point.x - t.point.x, n = t.next.point.y - t.point.y, i = t.prev.point.x - t.point.x, o = t.prev.point.y - t.point.y;
                    return Math.atan2(e * o - n * i, e * i + n * o)
                }
                function g(t, e) {
                    for (var n = 0; 3 > n; ++n)
                        if (!e.delaunay_edge[n]) {
                            var i = e.getNeighbor(n);
                            if (i) {
                                var o = e.getPoint(n), r = i.oppositePoint(e, o), s = i.index(r);
                                if (i.constrained_edge[s] || i.delaunay_edge[s]) {
                                    e.constrained_edge[n] = i.constrained_edge[s];
                                    continue
                                }
                                var a = f(o, e.pointCCW(o), e.pointCW(o), r);
                                if (a) {
                                    e.delaunay_edge[n] = !0, i.delaunay_edge[s] = !0, y(e, o, i, r);
                                    var l = !g(t, e);
                                    return l && t.mapTriangleToNodes(e), l = !g(t, i), l && t.mapTriangleToNodes(i), e.delaunay_edge[n] = !1, i.delaunay_edge[s] = !1, !0
                                }
                            }
                        }
                    return !1
                }
                function f(t, e, n, i) {
                    var o = t.x - i.x, r = t.y - i.y, s = e.x - i.x, a = e.y - i.y, l = o * a, h = s * r, c = l - h;
                    if (0 >= c)
                        return !1;
                    var u = n.x - i.x, p = n.y - i.y, d = u * r, m = o * p, g = d - m;
                    if (0 >= g)
                        return !1;
                    var f = s * p, y = u * a, _ = o * o + r * r, v = s * s + a * a, b = u * u + p * p, w = _ * (f - y) + v * g + b * c;
                    return w > 0
                }
                function y(t, e, n, i) {
                    var o, r, s, a;
                    o = t.neighborCCW(e), r = t.neighborCW(e), s = n.neighborCCW(i), a = n.neighborCW(i);
                    var l, h, c, u;
                    l = t.getConstrainedEdgeCCW(e), h = t.getConstrainedEdgeCW(e), c = n.getConstrainedEdgeCCW(i), u = n.getConstrainedEdgeCW(i);
                    var p, d, m, g;
                    p = t.getDelaunayEdgeCCW(e), d = t.getDelaunayEdgeCW(e), m = n.getDelaunayEdgeCCW(i), g = n.getDelaunayEdgeCW(i), t.legalize(e, i), n.legalize(i, e), n.setDelaunayEdgeCCW(e, p), t.setDelaunayEdgeCW(e, d), t.setDelaunayEdgeCCW(i, m), n.setDelaunayEdgeCW(i, g), n.setConstrainedEdgeCCW(e, l), t.setConstrainedEdgeCW(e, h), t.setConstrainedEdgeCCW(i, c), n.setConstrainedEdgeCW(i, u), t.clearNeigbors(), n.clearNeigbors(), o && n.markNeighbor(o), r && t.markNeighbor(r), s && t.markNeighbor(s), a && n.markNeighbor(a), t.markNeighbor(n)
                }
                function _(t, e) {
                    for (t.basin.left_node = j(e.point, e.next.point, e.next.next.point) === z.CCW ? e.next.next : e.next, t.basin.bottom_node = t.basin.left_node; t.basin.bottom_node.next && t.basin.bottom_node.point.y >= t.basin.bottom_node.next.point.y; )
                        t.basin.bottom_node = t.basin.bottom_node.next;
                    if (t.basin.bottom_node !== t.basin.left_node) {
                        for (t.basin.right_node = t.basin.bottom_node; t.basin.right_node.next && t.basin.right_node.point.y < t.basin.right_node.next.point.y; )
                            t.basin.right_node = t.basin.right_node.next;
                        t.basin.right_node !== t.basin.bottom_node && (t.basin.width = t.basin.right_node.point.x - t.basin.left_node.point.x, t.basin.left_highest = t.basin.left_node.point.y > t.basin.right_node.point.y, v(t, t.basin.bottom_node))
                    }
                }
                function v(t, e) {
                    if (!b(t, e)) {
                        u(t, e);
                        var n;
                        if (e.prev !== t.basin.left_node || e.next !== t.basin.right_node) {
                            if (e.prev === t.basin.left_node) {
                                if (n = j(e.point, e.next.point, e.next.next.point), n === z.CW)
                                    return;
                                e = e.next
                            } else if (e.next === t.basin.right_node) {
                                if (n = j(e.point, e.prev.point, e.prev.prev.point), n === z.CCW)
                                    return;
                                e = e.prev
                            } else
                                e = e.prev.point.y < e.next.point.y ? e.prev : e.next;
                            v(t, e)
                        }
                    }
                }
                function b(t, e) {
                    var n;
                    return n = t.basin.left_highest ? t.basin.left_node.point.y - e.point.y : t.basin.right_node.point.y - e.point.y, t.basin.width > n ? !0 : !1
                }
                function w(t, e, n) {
                    t.edge_event.right ? x(t, e, n) : B(t, e, n)
                }
                function x(t, e, n) {
                    for (; n.next.point.x < e.p.x; )
                        j(e.q, n.next.point, e.p) === z.CCW ? C(t, e, n) : n = n.next
                }
                function C(t, e, n) {
                    n.point.x < e.p.x && (j(n.point, n.next.point, n.next.next.point) === z.CCW ? M(t, e, n) : (D(t, e, n), C(t, e, n)))
                }
                function M(t, e, n) {
                    u(t, n.next), n.next.point !== e.p && j(e.q, n.next.point, e.p) === z.CCW && j(n.point, n.next.point, n.next.next.point) === z.CCW && M(t, e, n)
                }
                function D(t, e, n) {
                    j(n.next.point, n.next.next.point, n.next.next.next.point) === z.CCW ? M(t, e, n.next) : j(e.q, n.next.next.point, e.p) === z.CCW && D(t, e, n.next)
                }
                function B(t, e, n) {
                    for (; n.prev.point.x > e.p.x; )
                        j(e.q, n.prev.point, e.p) === z.CW ? A(t, e, n) : n = n.prev
                }
                function A(t, e, n) {
                    n.point.x > e.p.x && (j(n.point, n.prev.point, n.prev.prev.point) === z.CW ? T(t, e, n) : (E(t, e, n), A(t, e, n)))
                }
                function E(t, e, n) {
                    j(n.prev.point, n.prev.prev.point, n.prev.prev.prev.point) === z.CW ? T(t, e, n.prev) : j(e.q, n.prev.prev.point, e.p) === z.CW && E(t, e, n.prev)
                }
                function T(t, e, n) {
                    u(t, n.prev), n.prev.point !== e.p && j(e.q, n.prev.point, e.p) === z.CW && j(n.point, n.prev.point, n.prev.prev.point) === z.CW && T(t, e, n)
                }
                function S(t, e, n, i, o) {
                    var r = i.neighborAcross(o);
                    if (!r)
                        throw new Error("poly2tri [BUG:FIXME] FLIP failed due to missing triangle!");
                    var s = r.oppositePoint(i, o);
                    if (i.getConstrainedEdgeAcross(o)) {
                        var a = i.index(o);
                        throw new I("poly2tri Intersecting Constraints", [o, s, i.getPoint((a + 1) % 3), i.getPoint((a + 2) % 3)])
                    }
                    if (W(o, i.pointCCW(o), i.pointCW(o), s))
                        if (y(i, o, r, s), t.mapTriangleToNodes(i), t.mapTriangleToNodes(r), o === n && s === e)
                            n === t.edge_event.constrained_edge.q && e === t.edge_event.constrained_edge.p && (i.markConstrainedEdgeByPoints(e, n), r.markConstrainedEdgeByPoints(e, n), g(t, i), g(t, r));
                        else {
                            var h = j(n, s, e);
                            i = L(t, h, i, r, o, s), S(t, e, n, i, o)
                        }
                    else {
                        var c = O(e, n, r, s);
                        P(t, e, n, i, r, c), l(t, e, n, i, o)
                    }
                }
                function L(t, e, n, i, o, r) {
                    var s;
                    return e === z.CCW ? (s = i.edgeIndex(o, r), i.delaunay_edge[s] = !0, g(t, i), i.clearDelunayEdges(), n) : (s = n.edgeIndex(o, r), n.delaunay_edge[s] = !0, g(t, n), n.clearDelunayEdges(), i)
                }
                function O(t, e, n, i) {
                    var o = j(e, i, t);
                    if (o === z.CW)
                        return n.pointCCW(i);
                    if (o === z.CCW)
                        return n.pointCW(i);
                    throw new I("poly2tri [Unsupported] nextFlipPoint: opposing point on constrained edge!", [e, i, t])
                }
                function P(t, e, n, i, o, r) {
                    var s = o.neighborAcross(r);
                    if (!s)
                        throw new Error("poly2tri [BUG:FIXME] FLIP failed due to missing triangle");
                    var a = s.oppositePoint(o, r);
                    if (W(n, i.pointCCW(n), i.pointCW(n), a))
                        S(t, n, a, s, a);
                    else {
                        var l = O(e, n, s, a);
                        P(t, e, n, i, s, l)
                    }
                }
                var I = t("./pointerror"), N = t("./triangle"), R = t("./advancingfront").Node, k = t("./utils"), V = 3 * Math.PI / 4, F = Math.PI / 2, Y = k.EPSILON, z = k.Orientation, j = k.orient2d, W = k.inScanArea;
                n.triangulate = i
            }, {"./advancingfront": 2,"./pointerror": 4,"./triangle": 8,"./utils": 9}],7: [function(t, e) {
                "use strict";
                var n = t("./pointerror"), i = t("./point"), o = t("./triangle"), r = t("./sweep"), s = t("./advancingfront"), a = s.Node, l = .3, h = function(t, e) {
                    if (this.p = t, this.q = e, t.y > e.y)
                        this.q = t, this.p = e;
                    else if (t.y === e.y)
                        if (t.x > e.x)
                            this.q = t, this.p = e;
                        else if (t.x === e.x)
                            throw new n("poly2tri Invalid Edge constructor: repeated points!", [t]);
                    this.q._p2t_edge_list || (this.q._p2t_edge_list = []), this.q._p2t_edge_list.push(this)
                }, c = function() {
                    this.left_node = null, this.bottom_node = null, this.right_node = null, this.width = 0, this.left_highest = !1
                };
                c.prototype.clear = function() {
                    this.left_node = null, this.bottom_node = null, this.right_node = null, this.width = 0, this.left_highest = !1
                };
                var u = function() {
                    this.constrained_edge = null, this.right = !1
                }, p = function(t, e) {
                    e = e || {}, this.triangles_ = [], this.map_ = [], this.points_ = e.cloneArrays ? t.slice(0) : t, this.edge_list = [], this.pmin_ = this.pmax_ = null, this.front_ = null, this.head_ = null, this.tail_ = null, this.af_head_ = null, this.af_middle_ = null, this.af_tail_ = null, this.basin = new c, this.edge_event = new u, this.initEdges(this.points_)
                };
                p.prototype.addHole = function(t) {
                    this.initEdges(t);
                    var e, n = t.length;
                    for (e = 0; n > e; e++)
                        this.points_.push(t[e]);
                    return this
                }, p.prototype.AddHole = p.prototype.addHole, p.prototype.addPoint = function(t) {
                    return this.points_.push(t), this
                }, p.prototype.AddPoint = p.prototype.addPoint, p.prototype.addPoints = function(t) {
                    return this.points_ = this.points_.concat(t), this
                }, p.prototype.triangulate = function() {
                    return r.triangulate(this), this
                }, p.prototype.getBoundingBox = function() {
                    return {min: this.pmin_,max: this.pmax_}
                }, p.prototype.getTriangles = function() {
                    return this.triangles_
                }, p.prototype.GetTriangles = p.prototype.getTriangles, p.prototype.front = function() {
                    return this.front_
                }, p.prototype.pointCount = function() {
                    return this.points_.length
                }, p.prototype.head = function() {
                    return this.head_
                }, p.prototype.setHead = function(t) {
                    this.head_ = t
                }, p.prototype.tail = function() {
                    return this.tail_
                }, p.prototype.setTail = function(t) {
                    this.tail_ = t
                }, p.prototype.getMap = function() {
                    return this.map_
                }, p.prototype.initTriangulation = function() {
                    var t, e = this.points_[0].x, n = this.points_[0].x, o = this.points_[0].y, r = this.points_[0].y, s = this.points_.length;
                    for (t = 1; s > t; t++) {
                        var a = this.points_[t];
                        a.x > e && (e = a.x), a.x < n && (n = a.x), a.y > o && (o = a.y), a.y < r && (r = a.y)
                    }
                    this.pmin_ = new i(n, r), this.pmax_ = new i(e, o);
                    var h = l * (e - n), c = l * (o - r);
                    this.head_ = new i(e + h, r - c), this.tail_ = new i(n - h, r - c), this.points_.sort(i.compare)
                }, p.prototype.initEdges = function(t) {
                    var e, n = t.length;
                    for (e = 0; n > e; ++e)
                        this.edge_list.push(new h(t[e], t[(e + 1) % n]))
                }, p.prototype.getPoint = function(t) {
                    return this.points_[t]
                }, p.prototype.addToMap = function(t) {
                    this.map_.push(t)
                }, p.prototype.locateNode = function(t) {
                    return this.front_.locateNode(t.x)
                }, p.prototype.createAdvancingFront = function() {
                    var t, e, n, i = new o(this.points_[0], this.tail_, this.head_);
                    this.map_.push(i), t = new a(i.getPoint(1), i), e = new a(i.getPoint(0), i), n = new a(i.getPoint(2)), this.front_ = new s(t, n), t.next = e, e.next = n, e.prev = t, n.prev = e
                }, p.prototype.removeNode = function() {
                }, p.prototype.mapTriangleToNodes = function(t) {
                    for (var e = 0; 3 > e; ++e)
                        if (!t.getNeighbor(e)) {
                            var n = this.front_.locatePoint(t.pointCW(t.getPoint(e)));
                            n && (n.triangle = t)
                        }
                }, p.prototype.removeFromMap = function(t) {
                    var e, n = this.map_, i = n.length;
                    for (e = 0; i > e; e++)
                        if (n[e] === t) {
                            n.splice(e, 1);
                            break
                        }
                }, p.prototype.meshClean = function(t) {
                    for (var e, n, i = [t]; e = i.pop(); )
                        if (!e.isInterior())
                            for (e.setInterior(!0), this.triangles_.push(e), n = 0; 3 > n; n++)
                                e.constrained_edge[n] || i.push(e.getNeighbor(n))
                }, e.exports = p
            }, {"./advancingfront": 2,"./point": 3,"./pointerror": 4,"./sweep": 6,"./triangle": 8}],8: [function(t, e) {
                "use strict";
                var n = t("./xy"), i = function(t, e, n) {
                    this.points_ = [t, e, n], this.neighbors_ = [null, null, null], this.interior_ = !1, this.constrained_edge = [!1, !1, !1], this.delaunay_edge = [!1, !1, !1]
                }, o = n.toString;
                i.prototype.toString = function() {
                    return "[" + o(this.points_[0]) + o(this.points_[1]) + o(this.points_[2]) + "]"
                }, i.prototype.getPoint = function(t) {
                    return this.points_[t]
                }, i.prototype.GetPoint = i.prototype.getPoint, i.prototype.getPoints = function() {
                    return this.points_
                }, i.prototype.getNeighbor = function(t) {
                    return this.neighbors_[t]
                }, i.prototype.containsPoint = function(t) {
                    var e = this.points_;
                    return t === e[0] || t === e[1] || t === e[2]
                }, i.prototype.containsEdge = function(t) {
                    return this.containsPoint(t.p) && this.containsPoint(t.q)
                }, i.prototype.containsPoints = function(t, e) {
                    return this.containsPoint(t) && this.containsPoint(e)
                }, i.prototype.isInterior = function() {
                    return this.interior_
                }, i.prototype.setInterior = function(t) {
                    return this.interior_ = t, this
                }, i.prototype.markNeighborPointers = function(t, e, n) {
                    var i = this.points_;
                    if (t === i[2] && e === i[1] || t === i[1] && e === i[2])
                        this.neighbors_[0] = n;
                    else if (t === i[0] && e === i[2] || t === i[2] && e === i[0])
                        this.neighbors_[1] = n;
                    else {
                        if (!(t === i[0] && e === i[1] || t === i[1] && e === i[0]))
                            throw new Error("poly2tri Invalid Triangle.markNeighborPointers() call");
                        this.neighbors_[2] = n
                    }
                }, i.prototype.markNeighbor = function(t) {
                    var e = this.points_;
                    t.containsPoints(e[1], e[2]) ? (this.neighbors_[0] = t, t.markNeighborPointers(e[1], e[2], this)) : t.containsPoints(e[0], e[2]) ? (this.neighbors_[1] = t, t.markNeighborPointers(e[0], e[2], this)) : t.containsPoints(e[0], e[1]) && (this.neighbors_[2] = t, t.markNeighborPointers(e[0], e[1], this))
                }, i.prototype.clearNeigbors = function() {
                    this.neighbors_[0] = null, this.neighbors_[1] = null, this.neighbors_[2] = null
                }, i.prototype.clearDelunayEdges = function() {
                    this.delaunay_edge[0] = !1, this.delaunay_edge[1] = !1, this.delaunay_edge[2] = !1
                }, i.prototype.pointCW = function(t) {
                    var e = this.points_;
                    return t === e[0] ? e[2] : t === e[1] ? e[0] : t === e[2] ? e[1] : null
                }, i.prototype.pointCCW = function(t) {
                    var e = this.points_;
                    return t === e[0] ? e[1] : t === e[1] ? e[2] : t === e[2] ? e[0] : null
                }, i.prototype.neighborCW = function(t) {
                    return t === this.points_[0] ? this.neighbors_[1] : t === this.points_[1] ? this.neighbors_[2] : this.neighbors_[0]
                }, i.prototype.neighborCCW = function(t) {
                    return t === this.points_[0] ? this.neighbors_[2] : t === this.points_[1] ? this.neighbors_[0] : this.neighbors_[1]
                }, i.prototype.getConstrainedEdgeCW = function(t) {
                    return t === this.points_[0] ? this.constrained_edge[1] : t === this.points_[1] ? this.constrained_edge[2] : this.constrained_edge[0]
                }, i.prototype.getConstrainedEdgeCCW = function(t) {
                    return t === this.points_[0] ? this.constrained_edge[2] : t === this.points_[1] ? this.constrained_edge[0] : this.constrained_edge[1]
                }, i.prototype.getConstrainedEdgeAcross = function(t) {
                    return t === this.points_[0] ? this.constrained_edge[0] : t === this.points_[1] ? this.constrained_edge[1] : this.constrained_edge[2]
                }, i.prototype.setConstrainedEdgeCW = function(t, e) {
                    t === this.points_[0] ? this.constrained_edge[1] = e : t === this.points_[1] ? this.constrained_edge[2] = e : this.constrained_edge[0] = e
                }, i.prototype.setConstrainedEdgeCCW = function(t, e) {
                    t === this.points_[0] ? this.constrained_edge[2] = e : t === this.points_[1] ? this.constrained_edge[0] = e : this.constrained_edge[1] = e
                }, i.prototype.getDelaunayEdgeCW = function(t) {
                    return t === this.points_[0] ? this.delaunay_edge[1] : t === this.points_[1] ? this.delaunay_edge[2] : this.delaunay_edge[0]
                }, i.prototype.getDelaunayEdgeCCW = function(t) {
                    return t === this.points_[0] ? this.delaunay_edge[2] : t === this.points_[1] ? this.delaunay_edge[0] : this.delaunay_edge[1]
                }, i.prototype.setDelaunayEdgeCW = function(t, e) {
                    t === this.points_[0] ? this.delaunay_edge[1] = e : t === this.points_[1] ? this.delaunay_edge[2] = e : this.delaunay_edge[0] = e
                }, i.prototype.setDelaunayEdgeCCW = function(t, e) {
                    t === this.points_[0] ? this.delaunay_edge[2] = e : t === this.points_[1] ? this.delaunay_edge[0] = e : this.delaunay_edge[1] = e
                }, i.prototype.neighborAcross = function(t) {
                    return t === this.points_[0] ? this.neighbors_[0] : t === this.points_[1] ? this.neighbors_[1] : this.neighbors_[2]
                }, i.prototype.oppositePoint = function(t, e) {
                    var n = t.pointCW(e);
                    return this.pointCW(n)
                }, i.prototype.legalize = function(t, e) {
                    var n = this.points_;
                    if (t === n[0])
                        n[1] = n[0], n[0] = n[2], n[2] = e;
                    else if (t === n[1])
                        n[2] = n[1], n[1] = n[0], n[0] = e;
                    else {
                        if (t !== n[2])
                            throw new Error("poly2tri Invalid Triangle.legalize() call");
                        n[0] = n[2], n[2] = n[1], n[1] = e
                    }
                }, i.prototype.index = function(t) {
                    var e = this.points_;
                    if (t === e[0])
                        return 0;
                    if (t === e[1])
                        return 1;
                    if (t === e[2])
                        return 2;
                    throw new Error("poly2tri Invalid Triangle.index() call")
                }, i.prototype.edgeIndex = function(t, e) {
                    var n = this.points_;
                    if (t === n[0]) {
                        if (e === n[1])
                            return 2;
                        if (e === n[2])
                            return 1
                    } else if (t === n[1]) {
                        if (e === n[2])
                            return 0;
                        if (e === n[0])
                            return 2
                    } else if (t === n[2]) {
                        if (e === n[0])
                            return 1;
                        if (e === n[1])
                            return 0
                    }
                    return -1
                }, i.prototype.markConstrainedEdgeByIndex = function(t) {
                    this.constrained_edge[t] = !0
                }, i.prototype.markConstrainedEdgeByEdge = function(t) {
                    this.markConstrainedEdgeByPoints(t.p, t.q)
                }, i.prototype.markConstrainedEdgeByPoints = function(t, e) {
                    var n = this.points_;
                    e === n[0] && t === n[1] || e === n[1] && t === n[0] ? this.constrained_edge[2] = !0 : e === n[0] && t === n[2] || e === n[2] && t === n[0] ? this.constrained_edge[1] = !0 : (e === n[1] && t === n[2] || e === n[2] && t === n[1]) && (this.constrained_edge[0] = !0)
                }, e.exports = i
            }, {"./xy": 10}],9: [function(t, e) {
                "use strict";
                function n(t, e, n) {
                    var i = (t.x - n.x) * (e.y - n.y), s = (t.y - n.y) * (e.x - n.x), a = i - s;
                    return a > -o && o > a ? r.COLLINEAR : a > 0 ? r.CCW : r.CW
                }
                function i(t, e, n, i) {
                    var r = (t.x - e.x) * (i.y - e.y) - (i.x - e.x) * (t.y - e.y);
                    if (r >= -o)
                        return !1;
                    var s = (t.x - n.x) * (i.y - n.y) - (i.x - n.x) * (t.y - n.y);
                    return o >= s ? !1 : !0
                }
                var o = 1e-12, r = {CW: 1,CCW: -1,COLLINEAR: 0};
                e.exports = {EPSILON: o,Orientation: r,orient2d: n,inScanArea: i}
            }, {}],10: [function(t, e) {
                "use strict";
                function n(t) {
                    return "(" + t.x + ";" + t.y + ")"
                }
                function i(t) {
                    var e = t.toString();
                    return "[object Object]" === e ? n(t) : e
                }
                function o(t, e) {
                    return t.y === e.y ? t.x - e.x : t.y - e.y
                }
                function r(t, e) {
                    return t.x === e.x && t.y === e.y
                }
                e.exports = {toString: i,toStringBase: n,compare: o,equals: r}
            }, {}]}, {}, [5])(5)
}), function(t) {
    "use strict";
    var e, n = t.Uint8Array, i = t.HTMLCanvasElement, o = /\s*;\s*base64\s*(?:;|$)/i, r = function(t) {
        for (var i, o, r, s = t.length, a = new n(s / 4 * 3 | 0), l = 0, h = 0, c = [0, 0], u = 0, p = 0; s--; )
            o = t.charCodeAt(l++), i = e[o - 43], 255 !== i && i !== r && (c[1] = c[0], c[0] = o, p = p << 6 | i, u++, 4 === u && (a[h++] = p >>> 16, 61 !== c[1] && (a[h++] = p >>> 8), 61 !== c[0] && (a[h++] = p), u = 0));
        return a.buffer
    };
    n && (e = new n([62, -1, -1, -1, 63, 52, 53, 54, 55, 56, 57, 58, 59, 60, 61, -1, -1, -1, 0, -1, -1, -1, 0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20, 21, 22, 23, 24, 25, -1, -1, -1, -1, -1, -1, 26, 27, 28, 29, 30, 31, 32, 33, 34, 35, 36, 37, 38, 39, 40, 41, 42, 43, 44, 45, 46, 47, 48, 49, 50, 51])), i && !i.prototype.toBlob && (i.prototype.toBlob = function(t, e) {
        if (e || (e = "image/png"), this.mozGetAsFile)
            return void t(this.mozGetAsFile("canvas", e));
        var i, s = Array.prototype.slice.call(arguments, 1), a = this.toDataURL.apply(this, s), l = a.indexOf(","), h = a.substring(l + 1), c = o.test(a.substring(0, l));
        Blob.fake ? (i = new Blob, i.encoding = c ? "base64" : "URI", i.data = h, i.size = h.length) : n && (i = c ? new Blob([r(h)], {type: e}) : new Blob([decodeURIComponent(h)], {type: e})), t(i)
    })
}(self);
var saveAs = saveAs || navigator.msSaveOrOpenBlob && navigator.msSaveOrOpenBlob.bind(navigator) || function(t) {
    "use strict";
    var e = t.document, n = function() {
        return t.URL || t.webkitURL || t
    }, i = t.URL || t.webkitURL || t, o = e.createElementNS("http://www.w3.org/1999/xhtml", "a"), r = !t.externalHost && "download" in o, s = function(n) {
        var i = e.createEvent("MouseEvents");
        i.initMouseEvent("click", !0, !1, t, 0, 0, 0, 0, 0, !1, !1, !1, !1, 0, null), n.dispatchEvent(i)
    }, a = t.webkitRequestFileSystem, l = t.requestFileSystem || a || t.mozRequestFileSystem, h = function(e) {
        (t.setImmediate || t.setTimeout)(function() {
            throw e
        }, 0)
    }, c = "application/octet-stream", u = 0, p = [], d = function() {
        for (var t = p.length; t--; ) {
            var e = p[t];
            "string" == typeof e ? i.revokeObjectURL(e) : e.remove()
        }
        p.length = 0
    }, m = function(t, e, n) {
        e = [].concat(e);
        for (var i = e.length; i--; ) {
            var o = t["on" + e[i]];
            if ("function" == typeof o)
                try {
                    o.call(t, n || t)
                } catch (r) {
                    h(r)
                }
        }
    }, g = function(e, i) {
        var h, d, g, f = this, y = e.type, _ = !1, v = function() {
            var t = n().createObjectURL(e);
            return p.push(t), t
        }, b = function() {
            m(f, "writestart progress write writeend".split(" "))
        }, w = function() {
            (_ || !h) && (h = v(e)), d ? d.location.href = h : window.open(h, "_blank"), f.readyState = f.DONE, b()
        }, x = function(t) {
            return function() {
                return f.readyState !== f.DONE ? t.apply(this, arguments) : void 0
            }
        }, C = {create: !0,exclusive: !1};
        return f.readyState = f.INIT, i || (i = "download"), r ? (h = v(e), o.href = h, o.download = i, s(o), f.readyState = f.DONE, void b()) : (t.chrome && y && y !== c && (g = e.slice || e.webkitSlice, e = g.call(e, 0, e.size, c), _ = !0), a && "download" !== i && (i += ".download"), (y === c || a) && (d = t), l ? (u += e.size, void l(t.TEMPORARY, u, x(function(t) {
            t.root.getDirectory("saved", C, x(function(t) {
                var n = function() {
                    t.getFile(i, C, x(function(t) {
                        t.createWriter(x(function(n) {
                            n.onwriteend = function(e) {
                                d.location.href = t.toURL(), p.push(t), f.readyState = f.DONE, m(f, "writeend", e)
                            }, n.onerror = function() {
                                var t = n.error;
                                t.code !== t.ABORT_ERR && w()
                            }, "writestart progress write abort".split(" ").forEach(function(t) {
                                n["on" + t] = f["on" + t]
                            }), n.write(e), f.abort = function() {
                                n.abort(), f.readyState = f.DONE
                            }, f.readyState = f.WRITING
                        }), w)
                    }), w)
                };
                t.getFile(i, {create: !1}, x(function(t) {
                    t.remove(), n()
                }), x(function(t) {
                    t.code === t.NOT_FOUND_ERR ? n() : w()
                }))
            }), w)
        }), w)) : void w())
    }, f = g.prototype, y = function(t, e) {
        return new g(t, e)
    };
    return f.abort = function() {
        var t = this;
        t.readyState = t.DONE, m(t, "abort")
    }, f.readyState = f.INIT = 0, f.WRITING = 1, f.DONE = 2, f.error = f.onwritestart = f.onprogress = f.onwrite = f.onabort = f.onerror = f.onwriteend = null, t.addEventListener("unload", d, !1), y
}(self), Stats = function() {
    var t = Date.now(), e = t, n = 0, i = 1 / 0, o = 0, r = 0, s = 1 / 0, a = 0, l = 0, h = 0, c = document.createElement("div");
    c.id = "stats", c.addEventListener("mousedown", function(t) {
        t.preventDefault(), _(++h % 2)
    }, !1), c.style.cssText = "width:80px;opacity:0.9;cursor:pointer";
    var u = document.createElement("div");
    u.id = "fps", u.style.cssText = "padding:0 0 3px 3px;text-align:left;background-color:#002", c.appendChild(u);
    var p = document.createElement("div");
    p.id = "fpsText", p.style.cssText = "color:#0ff;font-family:Helvetica,Arial,sans-serif;font-size:9px;font-weight:bold;line-height:15px", p.innerHTML = "FPS", u.appendChild(p);
    var d = document.createElement("div");
    for (d.id = "fpsGraph", d.style.cssText = "position:relative;width:74px;height:30px;background-color:#0ff", u.appendChild(d); 74 > d.children.length; ) {
        var m = document.createElement("span");
        m.style.cssText = "width:1px;height:30px;float:left;background-color:#113", d.appendChild(m)
    }
    var g = document.createElement("div");
    g.id = "ms", g.style.cssText = "padding:0 0 3px 3px;text-align:left;background-color:#020;display:none", c.appendChild(g);
    var f = document.createElement("div");
    f.id = "msText", f.style.cssText = "color:#0f0;font-family:Helvetica,Arial,sans-serif;font-size:9px;font-weight:bold;line-height:15px", f.innerHTML = "MS", g.appendChild(f);
    var y = document.createElement("div");
    for (y.id = "msGraph", y.style.cssText = "position:relative;width:74px;height:30px;background-color:#0f0", g.appendChild(y); 74 > y.children.length; )
        m = document.createElement("span"), m.style.cssText = "width:1px;height:30px;float:left;background-color:#131", y.appendChild(m);
    var _ = function(t) {
        switch (h = t) {
            case 0:
                u.style.display = "block", g.style.display = "none";
                break;
            case 1:
                u.style.display = "none", g.style.display = "block"
        }
    };
    return {REVISION: 11,domElement: c,setMode: _,getFps: function() {
            return r
        },begin: function() {
            t = Date.now()
        },end: function() {
            var h = Date.now();
            n = h - t, i = Math.min(i, n), o = Math.max(o, n), f.textContent = n + " MS (" + i + "-" + o + ")";
            var c = Math.min(30, 30 - 30 * (n / 200));
            return y.appendChild(y.firstChild).style.height = c + "px", l++, h > e + 1e3 && (r = Math.round(1e3 * l / (h - e)), s = Math.min(s, r), a = Math.max(a, r), p.textContent = r + " FPS (" + s + "-" + a + ")", c = Math.min(30, 30 - 30 * (r / 100)), d.appendChild(d.firstChild).style.height = c + "px", e = h, l = 0), h
        },update: function() {
            t = this.end()
        }}
};
"undefined" == typeof document || "classList" in document.createElement("a") || !function(t) {
    if ("HTMLElement" in t || "Element" in t) {
        var e = "classList", n = "prototype", i = (t.HTMLElement || t.Element)[n], o = Object, r = String[n].trim || function() {
            return this.replace(/^\s+|\s+$/g, "")
        }, s = Array[n].indexOf || function(t) {
            for (var e = 0, n = this.length; n > e; e++)
                if (e in this && this[e] === t)
                    return e;
            return -1
        }, a = function(t, e) {
            this.name = t, this.code = DOMException[t], this.message = e
        }, l = function(t, e) {
            if ("" === e)
                throw new a("SYNTAX_ERR", "An invalid or illegal string was specified");
            if (/\s/.test(e))
                throw new a("INVALID_CHARACTER_ERR", "String contains an invalid character");
            return s.call(t, e)
        }, h = function(t) {
            for (var e = r.call(t.className), n = e ? e.split(/\s+/) : [], i = 0, o = n.length; o > i; i++)
                this.push(n[i]);
            this._updateClassName = function() {
                t.className = this.toString()
            }
        }, c = h[n] = [], u = function() {
            return new h(this)
        };
        if (a[n] = Error[n], c.item = function(t) {
            return this[t] || null
        }, c.contains = function(t) {
            return t += "", -1 !== l(this, t)
        }, c.add = function() {
            var t, e = arguments, n = 0, i = e.length, o = !1;
            do
                t = e[n] + "", -1 === l(this, t) && (this.push(t), o = !0);
            while (++n < i);
            o && this._updateClassName()
        }, c.remove = function() {
            var t, e = arguments, n = 0, i = e.length, o = !1;
            do {
                t = e[n] + "";
                var r = l(this, t);
                -1 !== r && (this.splice(r, 1), o = !0)
            } while (++n < i);
            o && this._updateClassName()
        }, c.toggle = function(t, e) {
            t += "";
            var n = this.contains(t), i = n ? e !== !0 && "remove" : e !== !1 && "add";
            return i && this[i](t), !n
        }, c.toString = function() {
            return this.join(" ")
        }, o.defineProperty) {
            var p = {get: u,enumerable: !0,configurable: !0};
            try {
                o.defineProperty(i, e, p)
            } catch (d) {
                -2146823252 === d.number && (p.enumerable = !1, o.defineProperty(i, e, p))
            }
        } else
            o[n].__defineGetter__ && i.__defineGetter__(e, u)
    }
}(self), function() {
    function t() {
        e(), new MutationObserver(function(t) {
            t.forEach(function(t) {
                t.addedNodes && Array.forEach(t.addedNodes, function(t) {
                    t instanceof Element && (t.childElementCount ? Array.forEach(t.querySelectorAll("input[type=range]"), n) : t.mozMatchesSelector("input[type=range]") && n(t))
                })
            })
        }).observe(document, {childList: !0,subtree: !0})
    }
    function e() {
        Array.forEach(document.querySelectorAll("input[type=range]"), n)
    }
    function n(t) {
        "range" != t.type && i(t)
    }
    function i(t) {
        function e(t) {
            if (C = !0, setTimeout(function() {
                C = !1
            }, 0), !t.button && S) {
                var e = parseFloat(getComputedStyle(this).width), o = (e - h.width) / S;
                if (o) {
                    var r = t.clientX - this.getBoundingClientRect().left - h.width / 2 - (L - A) * o;
                    Math.abs(r) > h.radius && (x = !0, this.value -= -r / o), D = L, B = t.clientX, this.addEventListener("mousemove", n, !0), this.addEventListener("mouseup", i, !0)
                }
            }
        }
        function n(e) {
            var n = parseFloat(getComputedStyle(this).width), i = (n - h.width) / S;
            if (i) {
                D += (e.clientX - B) / i, B = e.clientX, x = !0;
                var o = this.value;
                this.value = D, o != D && t.dispatchEvent(m)
            }
        }
        function i() {
            this.removeEventListener("mousemove", n, !0), this.removeEventListener("mouseup", i, !0), t.dispatchEvent(d), t.dispatchEvent(m)
        }
        function r(t) {
            t.keyCode > 36 && t.keyCode < 41 && (s.call(this), x = !0, this.value = L + (38 == t.keyCode || 39 == t.keyCode ? T : -T))
        }
        function s() {
            C || (this.style.boxShadow = l ? "inset 0 0 20px rgba(0,127,255,.1), 0 0 1px rgba(0,127,255,.4)" : "0 0 0 2px #fb0")
        }
        function g() {
            this.style.boxShadow = ""
        }
        function f(t) {
            return !isNaN(t) && +t == parseFloat(t)
        }
        function y() {
            A = f(t.min) ? +t.min : 0, E = f(t.max) ? +t.max : 100, A > E && (E = A > 100 ? A : 100), T = f(t.step) && t.step > 0 ? +t.step : 1, S = E - A, v(!0)
        }
        function _() {
            b || w || (L = t.getAttribute("value")), f(L) || (L = (A + E) / 2), L = Math.round((L - A) / T) * T + A, A > L ? L = A : L > E && (L = A + ~~(S / T) * T)
        }
        function v(e) {
            _();
            var n = x;
            if (x = !1, n && L != M && t.dispatchEvent(d), e || L != M) {
                M = L;
                var i = S ? (L - A) / S * 100 : 0, r = "-moz-element(#__sliderthumb__) " + i + "% no-repeat, ";
                o(t, {background: r + c})
            }
        }
        var b, w, x, C, M, D, B, A, E, T, S, L = t.value;
        a || (a = document.body.appendChild(document.createElement("hr")), o(a, {"-moz-appearance": l ? "scale-horizontal" : "scalethumb-horizontal",display: "block",visibility: "visible",opacity: 1,position: "fixed",top: "-999999px"}), document.mozSetImageElement("__sliderthumb__", a));
        var O = function() {
            return "" + L
        }, P = function I(e) {
            L = "" + e, b = !0, v(), delete t.value, t.value = L, t.__defineGetter__("value", O), t.__defineSetter__("value", I)
        };
        t.__defineGetter__("value", O), t.__defineSetter__("value", P), Object.defineProperty(t, "type", {get: function() {
                return "range"
            }}), ["min", "max", "step"].forEach(function(e) {
            t.hasAttribute(e) && (w = !0), Object.defineProperty(t, e, {get: function() {
                    return this.hasAttribute(e) ? this.getAttribute(e) : ""
                },set: function(t) {
                    null === t ? this.removeAttribute(e) : this.setAttribute(e, t)
                }})
        }), t.readOnly = !0, o(t, u), y(), new MutationObserver(function(e) {
            e.forEach(function(e) {
                "value" != e.attributeName ? (y(), w = !0) : b || (L = t.getAttribute("value"), v())
            })
        }).observe(t, p), t.addEventListener("mousedown", e, !0), t.addEventListener("keydown", r, !0), t.addEventListener("focus", s, !0), t.addEventListener("blur", g, !0)
    }
    function o(t, e) {
        for (var n in e)
            t.style.setProperty(n, e[n], "important")
    }
    var r = document.createElement("input");
    try {
        if (r.type = "range", "range" == r.type)
            return
    } catch (s) {
        return
    }
    if (r.style.background = "linear-gradient(red, red)", r.style.backgroundImage && "MozAppearance" in r.style) {
        var a, l = "MacIntel" == navigator.platform, h = {radius: l ? 9 : 6,width: l ? 22 : 12,height: l ? 16 : 20}, c = "linear-gradient(transparent " + (l ? "6px, #999 6px, #999 7px, #ccc 8px, #bbb 9px, #bbb 10px, transparent 10px" : "9px, #999 9px, #bbb 10px, #fff 11px, transparent 11px") + ", transparent)", u = {"min-width": h.width + "px","min-height": h.height + "px","max-height": h.height + "px",padding: "0 0 " + (l ? "2px" : "1px"),border: 0,"border-radius": 0,cursor: "default","text-indent": "-999999px"}, p = {attributes: !0,attributeFilter: ["min", "max", "step", "value"]}, d = document.createEvent("HTMLEvents");
        d.initEvent("input", !0, !1);
        var m = document.createEvent("HTMLEvents");
        m.initEvent("change", !0, !1), "loading" == document.readyState ? document.addEventListener("DOMContentLoaded", t, !0) : t(), addEventListener("pageshow", e, !0)
    }
}();
var I18njs = function(t, e, n) {
    this._baseURL = t || "/l10n/", this._locale = e || "C", this._strings = n || {}, window._ = this.translate.bind(this)
};
I18njs.prototype.getLocale = function() {
    return this._locale
}, I18njs.prototype.setLocale = function(t, e) {
    this._locale = t || "C", this._loadLocale(e)
}, I18njs.prototype.translate = function(t, e) {
    if (e) {
        var n = "C" == this._locale ? "en_EN" : this._locale;
        if (e[n] && e[n][t])
            return e[n][t]
    }
    return this._strings[t] || t
}, I18njs.prototype._loadLocale = function(t) {
    var t = t || 1;
    if (this._strings = {}, "C" != this._locale) {
        var e = window.XMLHttpRequest ? new XMLHttpRequest : new ActiveXObject("Microsoft.XMLHTTP");
        e.open("GET", this._baseURL + this._locale + ".json?version=" + t, !1), e.onreadystatechange = function() {
            4 == e.readyState && (this._strings = JSON.parse(e.responseText))
        }.bind(this), e.send(null)
    }
};
var BrowserDetector = function() {
    var t = null, e = [{string: navigator.userAgent,subString: "Chrome",identity: "Chrome"}, {string: navigator.vendor,subString: "Apple",identity: "Safari",versionSearch: "Version"}, {string: navigator.userAgent,subString: "Firefox",identity: "Firefox"}, {string: navigator.userAgent,subString: "Netscape",identity: "Netscape"}, {string: navigator.userAgent,subString: "MSIE",identity: "Explorer",versionSearch: "MSIE"}, {string: navigator.userAgent,subString: "Gecko",identity: "Mozilla",versionSearch: "rv"}, {string: navigator.userAgent,subString: "Mozilla",identity: "Netscape",versionSearch: "Mozilla"}], n = [{string: navigator.platform,subString: "Win",identity: "Windows"}, {string: navigator.platform,subString: "Mac",identity: "Mac"}, {string: navigator.userAgent,subString: "iPhone",identity: "iOS"}, {string: navigator.userAgent,subString: "iPod",identity: "iOS"}, {string: navigator.userAgent,subString: "iPad",identity: "iOS"}, {string: navigator.platform,subString: "Linux",identity: "Linux"}, {string: navigator.plateform,subString: "Android",identity: "Android"}], i = function() {
        this.browser = this._searchString(e) || "An unknown browser", this.version = this._searchVersion(navigator.userAgent) || this._searchVersion(navigator.appVersion) || "an unknown version", this.OS = this._searchString(n) || "an unknown OS", t = this
    };
    return i.getInstance = function() {
        return null === t && (t = new BrowserDetector), t
    }, i.prototype.isMobile = function() {
        var t = !1;
        return function(e) {
            (/(android|bb\d+|meego).+mobile|android|avantgo|bada\/|blackberry|blazer|compal|elaine|fennec|hiptop|iemobile|iphone|ipod|ipad|iris|kindle|lge |maemo|midp|mmp|mobile.+firefox|netfront|opera m(ob|in)i|palm( os)?|phone|p(ixi|re)\/|plucker|pocket|psp|series(4|6)0|symbian|treo|up\.(browser|link)|vodafone|wap|windows (ce|phone)|xda|xiino/i.test(e) || /1207|6310|6590|3gso|4thp|50[1-6]i|770s|802s|a wa|abac|ac(er|oo|s\-)|ai(ko|rn)|al(av|ca|co)|amoi|an(ex|ny|yw)|aptu|ar(ch|go)|as(te|us)|attw|au(di|\-m|r |s )|avan|be(ck|ll|nq)|bi(lb|rd)|bl(ac|az)|br(e|v)w|bumb|bw\-(n|u)|c55\/|capi|ccwa|cdm\-|cell|chtm|cldc|cmd\-|co(mp|nd)|craw|da(it|ll|ng)|dbte|dc\-s|devi|dica|dmob|do(c|p)o|ds(12|\-d)|el(49|ai)|em(l2|ul)|er(ic|k0)|esl8|ez([4-7]0|os|wa|ze)|fetc|fly(\-|_)|g1 u|g560|gene|gf\-5|g\-mo|go(\.w|od)|gr(ad|un)|haie|hcit|hd\-(m|p|t)|hei\-|hi(pt|ta)|hp( i|ip)|hs\-c|ht(c(\-| |_|a|g|p|s|t)|tp)|hu(aw|tc)|i\-(20|go|ma)|i230|iac( |\-|\/)|ibro|idea|ig01|ikom|im1k|inno|ipaq|iris|ja(t|v)a|jbro|jemu|jigs|kddi|keji|kgt( |\/)|klon|kpt |kwc\-|kyo(c|k)|le(no|xi)|lg( g|\/(k|l|u)|50|54|\-[a-w])|libw|lynx|m1\-w|m3ga|m50\/|ma(te|ui|xo)|mc(01|21|ca)|m\-cr|me(rc|ri)|mi(o8|oa|ts)|mmef|mo(01|02|bi|de|do|t(\-| |o|v)|zz)|mt(50|p1|v )|mwbp|mywa|n10[0-2]|n20[2-3]|n30(0|2)|n50(0|2|5)|n7(0(0|1)|10)|ne((c|m)\-|on|tf|wf|wg|wt)|nok(6|i)|nzph|o2im|op(ti|wv)|oran|owg1|p800|pan(a|d|t)|pdxg|pg(13|\-([1-8]|c))|phil|pire|pl(ay|uc)|pn\-2|po(ck|rt|se)|prox|psio|pt\-g|qa\-a|qc(07|12|21|32|60|\-[2-7]|i\-)|qtek|r380|r600|raks|rim9|ro(ve|zo)|s55\/|sa(ge|ma|mm|ms|ny|va)|sc(01|h\-|oo|p\-)|sdk\/|se(c(\-|0|1)|47|mc|nd|ri)|sgh\-|shar|sie(\-|m)|sk\-0|sl(45|id)|sm(al|ar|b3|it|t5)|so(ft|ny)|sp(01|h\-|v\-|v )|sy(01|mb)|t2(18|50)|t6(00|10|18)|ta(gt|lk)|tcl\-|tdg\-|tel(i|m)|tim\-|t\-mo|to(pl|sh)|ts(70|m\-|m3|m5)|tx\-9|up(\.b|g1|si)|utst|v400|v750|veri|vi(rg|te)|vk(40|5[0-3]|\-v)|vm40|voda|vulc|vx(52|53|60|61|70|80|81|83|85|98)|w3c(\-| )|webc|whit|wi(g |nc|nw)|wmlb|wonu|x700|yas\-|your|zeto|zte\-/i.test(e.substr(0, 4))) && (t = !0)
        }(navigator.userAgent || navigator.vendor || window.opera), t
    }, i.prototype._searchString = function(t) {
        for (var e = 0; e < t.length; e++) {
            var n = t[e].string, i = t[e].prop;
            if (this.version_searchString = t[e].versionSearch || t[e].identity, n) {
                if (-1 != n.indexOf(t[e].subString))
                    return t[e].identity
            } else if (i)
                return t[e].identity
        }
    }, i.prototype._searchVersion = function(t) {
        var e = t.indexOf(this.version_searchString);
        if (-1 != e)
            return parseFloat(t.substring(e + this.version_searchString.length + 1))
    }, i
}(), BrowserDetect = new BrowserDetector, photonui = function(t, e) {
    !function(t) {
        "undefined" != typeof module && module.exports ? module.exports = t() : "function" == typeof define && "object" == typeof define.amd ? define(t) : this.Class = t()
    }(function(t) {
        function e(t) {
            return !h || /\B\$super\b/.test(t.toString())
        }
        function n(e, n, i) {
            i === t ? delete e[n] : e[n] = i
        }
        function i(e, n) {
            return Object.prototype.hasOwnProperty.call(e, n) ? e[n] : t
        }
        function o(t) {
            l = !0;
            var e = new t;
            return l = !1, e
        }
        var r = "1.4", s = this, a = s.Class, l = !1, h = function() {
            $super()
        }.toString().indexOf("$super") > 0, c = function() {
        };
        return c.$noConflict = function() {
            try {
                n(s, "Class", a)
            } catch (t) {
                s.Class = a
            }
            return c
        }, c.$classyVersion = r, c.$extend = function(r) {
            var a = this.prototype, h = o(this);
            if (r.__include__)
                for (var u = 0, p = r.__include__.length; u != p; ++u) {
                    var d = r.__include__[u];
                    for (var m in d) {
                        var g = i(d, m);
                        g !== t && (h[m] = d[m])
                    }
                }
            if (r.__classvars__ = r.__classvars__ || {}, h.__classvars__)
                for (var f in h.__classvars__)
                    if (!r.__classvars__[f]) {
                        var g = i(h.__classvars__, f);
                        r.__classvars__[f] = g
                    }
            for (var m in r) {
                var g = i(r, m);
                "__include__" !== m && g !== t && (h[m] = "function" == typeof g && e(g) ? function(t, e) {
                    return function() {
                        var o = i(this, "$super");
                        this.$super = a[e];
                        try {
                            return t.apply(this, arguments)
                        }finally {
                            n(this, "$super", o)
                        }
                    }
                }(g, m) : g)
            }
            var y = function() {
                if (!l) {
                    var t = s === this ? o(arguments.callee) : this;
                    return t.__init__ && t.__init__.apply(t, arguments), t.$class = y, t
                }
            };
            for (var f in r.__classvars__) {
                var g = i(r.__classvars__, f);
                g !== t && (y[f] = g)
            }
            return y.prototype = h, y.constructor = y, y.$extend = c.$extend, y.$withData = c.$withData, y
        }, c.$withData = function(e) {
            var n = o(this);
            for (var r in e) {
                var s = i(e, r);
                s !== t && (n[r] = s)
            }
            return n
        }, c
    });
    var n = n || {};
    n.e_parent = document.getElementsByTagName("body")[0], n.domInsert = function(t, e) {
        var e = e || n.e_parent;
        e.appendChild(t.html)
    }, t._ == e && (t._ = function(t, e) {
        var n = t;
        if (e)
            for (var i in e)
                n = n.replace(new RegExp("{" + i + "}", "g"), e[i]);
        return n
    });
    var n = n || {};
    n.Helpers = function() {
    }, n.Helpers.escapeHtml = function(t) {
        return t.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;")
    }, n.Helpers.uuid4 = function() {
        return "xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g, function(t) {
            var e = 16 * Math.random() | 0, n = "x" == t ? e : 3 & e | 8;
            return n.toString(16)
        })
    }, n.Helpers.cleanNode = function(t) {
        for (; t.hasChildNodes(); )
            t.removeChild(t.lastChild)
    }, n.Helpers.getAbsolutePosition = function(t) {
        for (var e = getComputedStyle(t), n = -parseInt(e.borderLeftWidth), i = -parseInt(e.borderTopWidth); t.offsetParent; )
            e = getComputedStyle(t), n += t.offsetLeft || 0, n += parseInt(e.borderLeftWidth), i += t.offsetTop || 0, i += parseInt(e.borderTopWidth), t = t.offsetParent;
        return {x: n,y: i}
    };
    var n = n || {};
    n.Base = Class.$extend({__init__: function(t) {
            this.__events = {}, this._registerWEvents(["destroy"]);
            for (var i in this)
                if (0 == i.indexOf("get")) {
                    var o = i.slice(3, 4).toLowerCase() + i.slice(4, i.length);
                    Object.defineProperty(this, o, {get: this[i],enumerable: !0,configurable: !0})
                } else if (0 == i.indexOf("set")) {
                    var o = i.slice(3, 4).toLowerCase() + i.slice(4, i.length);
                    Object.defineProperty(this, o, {set: this[i],enumerable: !0,configurable: !0})
                } else if (0 == i.indexOf("is")) {
                    var o = i.slice(2, 3).toLowerCase() + i.slice(3, i.length);
                    Object.defineProperty(this, o, {get: this[i],enumerable: !0,configurable: !0})
                }
            var t = t || {};
            for (param in t)
                this[param] !== e && (this[param] = t[param]);
            var r = null, s = 0, a = "";
            if (t.callbacks)
                for (var l in t.callbacks)
                    if (r = t.callbacks[l], "function" == typeof r)
                        this.registerCallback(n.Helpers.uuid4(), l, r);
                    else if (r instanceof Array)
                        for (s = 0; s < r.length; s++)
                            this.registerCallback(n.Helpers.uuid4(), l, r[s]);
                    else
                        for (a in r)
                            this.registerCallback(a, l, r[a])
        },__events: null,__callbacks: null,destroy: function() {
            this._callCallbacks("destroy");
            for (var t in this.__events)
                this._unbindEvent(t)
        },registerCallback: function(t, e, n, i) {
            return this.__callbacks[e] ? void (this.__callbacks[e][t] = {callback: n,thisArg: i || null}) : void console.error("This widget have no '" + e + "' event.")
        },removeCallback: function(t) {
            for (var e in this.__callbacks)
                this.__callbacks[e][t] && delete this.__callbacks[e][t]
        },_updateProperties: function(t) {
            for (var e = 0; e < t.length; e++)
                this[t[e]] = this[t[e]]
        },_bindEvent: function(t, e, n, i) {
            this.__events[t] = {evName: n,element: e,callback: i}, this.__events[t].element.addEventListener(this.__events[t].evName, this.__events[t].callback, !1)
        },_unbindEvent: function(t) {
            this.__events[t].element.removeEventListener(this.__events[t].evName, this.__events[t].callback, !1), delete this.__events[t]
        },_registerWEvents: function(t) {
            null == this.__callbacks && (this.__callbacks = {});
            for (var e in t)
                this.__callbacks[t[e]] = {}
        },_callCallbacks: function(t, e) {
            var e = e || [];
            for (var n in this.__callbacks[t])
                this.__callbacks[t][n].callback.apply(this.__callbacks[t][n].thisArg || this, [this].concat(e))
        }});
    var n = n || {}, i = {};
    n.getWidget = function(t) {
        return i[t] !== e ? i[t] : null
    }, n.Widget = n.Base.$extend({__init__: function(t) {
            this.__html = {}, this._layoutOptions = {}, this._buildHtml(), this.$super(t), this._registerWEvents(["show", "hide"]), this._updateProperties(["visible"]), this.name || (this.name = "widget-" + n.Helpers.uuid4()), t && t.className && this.addClass(t.className), this.html && this._bindEvent("pop-contextmenu", this.html, "contextmenu", this.__onContextMenu.bind(this)), this._bindEvent("locale-changed", document, "stonejs-locale-changed", this.__onLocaleChanged.bind(this)), i[this.name] = this
        },_name: null,getName: function() {
            return this._name
        },setName: function(t) {
            delete i[this.name], this._name = t, i[t] = this, this.html && (this.html.id = this.name)
        },_visible: !0,isVisible: function() {
            return this._visible
        },setVisible: function(t) {
            this._visible = t, this.html && (this.visible ? (this.html.style.display = "", this._callCallbacks("show")) : (this.html.style.display = "none", this._callCallbacks("hide")))
        },_tooltip: null,getTooltip: function() {
            return this._tooltip
        },setTooltip: function(t) {
            this._tooltip = t, t ? this.html.title = t : delete this.html.removeAttribute("title")
        },_contextMenuName: null,getContextMenuName: function() {
            return this._contextMenuName
        },setContextMenuName: function(t) {
            this._contextMenuName = t
        },getContextMenu: function() {
            return n.getWidget(this.contextMenuName)
        },setContextMenu: function(t) {
            this.contextMenuName = t instanceof n.PopupWindow ? t.name : null
        },_layoutOptions: {},getLayoutOptions: function() {
            return this._layoutOptions
        },setLayoutOptions: function(t) {
            for (option in t)
                this._layoutOptions[option] = t[option]
        },getHtml: function() {
            return console.warn("getHtml() method not implemented for this widget."), null
        },getAbsolutePosition: function() {
            return this.html ? n.Helpers.getAbsolutePosition(this.html) : {x: 0,y: 0}
        },getOffsetWidth: function() {
            return this.html ? this.html.offsetWidth : 0
        },getOffsetHeight: function() {
            return this.html ? this.html.offsetHeight : 0
        },__html: {},show: function() {
            this.visible = !0
        },hide: function() {
            this.visible = !1
        },destroy: function() {
            this.$super(), delete i[this.name], this.html && this.html.parentNode.removeChild(this.html)
        },addClass: function(t) {
            if (this.html) {
                var e = this.html.className.split(" ");
                e.indexOf(t) < 0 && e.push(t), this.html.className = e.join(" ")
            }
        },removeClass: function(t) {
            if (this.html) {
                var e = this.html.className.split(" "), n = e.indexOf(t);
                n >= 0 && e.splice(n, 1), this.html.className = e.join(" ")
            }
        },_buildHtml: function() {
            console.warn("_buildHtml() method not implemented for this widget.")
        },__onContextMenu: function(t) {
            t.stopPropagation(), t.preventDefault(), this.contextMenuName && this.contextMenu.popupXY(t.pageX, t.pageY)
        },__onLocaleChanged: function() {
            if (t.Stone)
                for (var e in this)
                    this[e] instanceof Stone.LazyString && (this[e] = this[e])
        }});
    var n = n || {};
    n.Canvas = n.Widget.$extend({__init__: function(t) {
            this.$super(t), this._updateProperties(["width", "height"]), this.getContext = this.__html.canvas.getContext.bind(this.__html.canvas), this.__html.canvas.supportsContext && (this.supportsContext = this.__html.canvas.supportsContext.bind(this.__html.canvas)), this.__html.canvas.setContext && (this.setContext = this.__html.canvas.setContext.bind(this.__html.canvas)), this.__html.canvas.transferControlToProxy && (this.transferControlToProxy = this.__html.canvas.transferControlToProxy.bind(this.__html.canvas)), this.toDataURL = this.__html.canvas.toDataURL.bind(this.__html.canvas), this.__html.canvas.toDataURLHD && (this.toDataURLHD = this.__html.canvas.toDataURLHD.bind(this.__html.canvas)), this.__html.canvas.toBlob && (this.toBlob = this.__html.canvas.toBlob.bind(this.__html.canvas)), this.__html.canvas.toBlobHD && (this.toBlobHD = this.__html.canvas.toBlobHD.bind(this.__html.canvas))
        },getWidth: function() {
            return this.__html.canvas.width
        },setWidth: function(t) {
            this.__html.canvas.width = t || 300
        },getHeight: function() {
            return this.__html.canvas.height
        },setHeight: function(t) {
            this.__html.canvas.height = t || 150
        },getCanvas: function() {
            return this.__html.canvas
        },getHtml: function() {
            return this.__html.outer
        },getInteractiveNode: function() {
            return this.__html.canvas
        },_buildHtml: function() {
            this.__html.outer = document.createElement("div"), this.__html.outer.className = "photonui-widget photonui-canvas", this.__html.canvas = document.createElement("canvas"), this.__html.outer.appendChild(this.__html.canvas)
        },__onLocaleChanged: function() {
        }});
    var n = n || {};
    n.CheckBox = n.Widget.$extend({__init__: function(t) {
            this._registerWEvents(["value-changed", "click"]), this.$super(t), this.inputId = this.name + "-input", this._bindEvent("value-changed", this.__html.checkbox, "change", this.__onChange.bind(this)), this._bindEvent("span-click", this.__html.span, "click", this.__onSpanClick.bind(this)), this._bindEvent("checkbox-click", this.__html.checkbox, "click", this.__onCheckboxClick.bind(this)), this._bindEvent("span-keypress", this.__html.span, "keypress", this.__onSpanKeypress.bind(this)), this.__html.checkbox.name = this.name, this.__html.checkbox.id = this.inputId
        },getValue: function() {
            return this.__html.checkbox.checked
        },setValue: function(t) {
            this.__html.checkbox.checked = t
        },getHtml: function() {
            return this.__html.outer
        },_buildHtml: function() {
            this.__html.outer = document.createElement("div"), this.__html.outer.className = "photonui-widget photonui-checkbox", this.__html.checkbox = document.createElement("input"), this.__html.checkbox.type = "checkbox", this.__html.outer.appendChild(this.__html.checkbox), this.__html.span = document.createElement("span"), this.__html.span.tabIndex = "0", this.__html.outer.appendChild(this.__html.span)
        },__onChange: function() {
            this._callCallbacks("value-changed", [this.value]), "none" == t.getComputedStyle(this.__html.checkbox).display && this.__html.span.focus()
        },__onSpanClick: function(t) {
            this.value = !this.value, this._callCallbacks("value-changed", [this.value]), this._callCallbacks("click", [t])
        },__onCheckboxClick: function(t) {
            this._callCallbacks("click", [t])
        },__onSpanKeypress: function(t) {
            (32 == t.charCode || 13 == t.keyCode) && (this.value = !this.value, this._callCallbacks("value-changed", [this.value]))
        }});
    var n = n || {};
    n.Container = n.Widget.$extend({_childName: null,getChildName: function() {
            return this._childName
        },setChildName: function(t) {
            this.childName && this.containerNode && this.containerNode.removeChild(this.child.html), this._childName = t, this.childName && this.containerNode && this.containerNode.appendChild(this.child.html)
        },getChild: function() {
            return n.getWidget(this.childName)
        },setChild: function(t) {
            return !t instanceof n.Widget ? void (this.childName = null) : void (this.childName = t.name)
        },getContainerNode: function() {
            return console.warn("getContainerNode() method not implemented for this widget."), null
        },destroy: function() {
            this.childName && this.child.destroy(), this.$super()
        }});
    var n = n || {};
    n.Label = n.Widget.$extend({__init__: function(t) {
            var t = t || {};
            t.layoutOptions = t.layoutOptions || {}, t.layoutOptions.verticalExpansion === e && (t.layoutOptions.verticalExpansion = !1), this.$super(t), this._updateProperties(["text", "textAlign", "forInputName"])
        },_text: "Label",getText: function() {
            return this._text
        },setText: function(t) {
            this._text = t, n.Helpers.cleanNode(this.__html.label), this.__html.label.appendChild(document.createTextNode(t))
        },_textAlign: "left",getTextAlign: function() {
            return this._textAlign
        },setTextAlign: function(t) {
            if ("left" != t && "center" != t && "right" != t)
                throw "Text alignement sould be 'left', 'center' or 'right'.";
            this._textAlign = t, this.__html.label.style.textAlign = t
        },_forInputName: null,getForInputName: function() {
            return this._forInputName
        },setForInputName: function(t) {
            this._forInputName = t, this._forInputName && this.__html.label.setAttribute("for", n.Helpers.escapeHtml(this.forInput.inputId || this.forInput.name))
        },getForInput: function() {
            return n.getWidget(this.forInputName)
        },setForInput: function(t) {
            this.forInputName = t.name
        },getHtml: function() {
            return this.__html.label
        },_buildHtml: function() {
            this.__html.label = document.createElement("label"), this.__html.label.className = "photonui-widget photonui-label"
        }});
    var n = n || {};
    n.Field = n.Widget.$extend({__init__: function(t) {
            this._registerWEvents(["value-changed", "keydown", "keyup", "keypress", "selection-changed"]), this.$super(t), this._updateProperties(["value", "placeholder"]), this.__html.field.name = this.name
        },getValue: function() {
            return this.__html.field.value
        },setValue: function(t) {
            this.__html.field.value = t
        },_placeholder: "",getPlaceholder: function() {
            return this._placeholder
        },setPlaceholder: function(t) {
            this._placeholder = t, this.__html.field.placeholder = t
        },getHtml: function() {
            return this.__html.field
        },_bindFieldEvents: function() {
            this._bindEvent("value-changed", this.__html.field, "change", function() {
                this._callCallbacks("value-changed", [this.getValue()])
            }.bind(this)), this._bindEvent("keydown", this.__html.field, "keydown", function(t) {
                this._callCallbacks("keydown", [t])
            }.bind(this)), this._bindEvent("keyup", this.__html.field, "keyup", function(t) {
                this._callCallbacks("keyup", [t])
            }.bind(this)), this._bindEvent("keypress", this.__html.field, "keypress", function(t) {
                this._callCallbacks("keypress", [t])
            }.bind(this)), this._bindEvent("selection-changed", this.__html.field, "select", function(t) {
                this._callCallbacks("selection-changed", [this.__html.field.selectionStart, this.__html.field.selectionEnd, ("" + this.getValue()).substring(this.__html.field.selectionStart, this.__html.field.selectionEnd), t])
            }.bind(this))
        },__onContextMenu: function(t) {
            t.stopPropagation()
        }});
    var n = n || {};
    n.BaseIcon = n.Widget.$extend({__onLocaleChanged: function() {
        }}), t.Stone = function() {
        function t(t, n) {
            this.toString = e.bind(this, t, n)
        }
        function e(t, e) {
            var n = t;
            if (l && a[l] && a[l][t] && (n = a[l][t]), e)
                for (var i in e)
                    n = n.replace(new RegExp("{" + i + "}", "g"), e[i]);
            return n
        }
        function n(e, n) {
            return new t(e, n)
        }
        function i(t) {
            for (var e in t)
                a[e] = t[e]
        }
        function o() {
            return l
        }
        function r(t) {
            l = t;
            var e = null;
            try {
                e = new Event("stonejs-locale-changed")
            } catch (n) {
                e = document.createEvent("Event"), e.initEvent("stonejs-locale-changed", !0, !1)
            }
            document.dispatchEvent(e)
        }
        function s() {
            var t = navigator.language || navigator.userLanguage || navigator.systemLanguage || navigator.browserLanguage || null;
            return t && (t = t.toLowerCase()), t && t.length > 3 && (t = t.split(";")[0], t = t.split(",")[0], t = t.split("-")[0], t = t.split("_")[0], t.length > 3 && (t = null)), t || "en"
        }
        var a = {}, l = null;
        return {LazyString: t,gettext: e,lazyGettext: n,addCatalogs: i,getLocale: o,setLocale: r,guessUserLanguage: s}
    }(t);
    var n = n || {};
    n.Translation = n.Base.$extend({__init__: function(e) {
            this._registerWEvents(["locale-changed"]), this.$super(e), this._bindEvent("locale-changed", document, "stonejs-locale-changed", this.__onStonejsLocaleChanged.bind(this)), t._ = this.lazyGettext
        },getLocale: Stone.getLocale,setLocale: Stone.setLocale,addCatalogs: Stone.addCatalogs,guessUserLanguage: Stone.guessUserLanguage,gettext: Stone.gettext,lazyGettext: Stone.lazyGettext,__onStonejsLocaleChanged: function() {
            this._callCallbacks("click", [this.locale])
        }}), function(t, e) {
        function n() {
            function t() {
                var n;
                return n = e("amd"), n.fork = t, n
            }
            return t()
        }
        function i() {
            function t() {
                var n;
                return n = e("CommonJS"), n.fork = t, n
            }
            module.exports = t()
        }
        function o() {
            function n() {
                function i() {
                    var e, n;
                    for (n = Array.prototype.slice.apply(arguments), e = 0; e < r.length; e += 1)
                        "undefined" == typeof s[r[e]] ? delete t[r[e]] : t[r[e]] = s[r[e]];
                    for (s = {}, e = 0; e < n.length; e += 1) {
                        if ("string" != typeof n[e])
                            throw new Error("Cannot replace namespaces. All new namespaces must be strings.");
                        s[n[e]] = t[n[e]], t[n[e]] = o
                    }
                    return r = n
                }
                var o, r = [], s = {};
                return o = e("global"), o.fork = n, o.noConflict = i, o
            }
            var i;
            i = n(), i.noConflict("KeyboardJS", "k")
        }
        [].indexOf || (Array.prototype.indexOf = function(t, e, n) {
            for (n = this.length, e = (n + ~~e) % n; n > e && (!(e in this) || this[e] !== t); e++)
                ;
            return e ^ n ? e : -1
        }), "function" == typeof define && define.amd ? define(n) : "undefined" != typeof module ? i() : o()
    }(this, function() {
        function e() {
            t.addEventListener ? (document.addEventListener("keydown", o, !1), document.addEventListener("keyup", r, !1), t.addEventListener("blur", i, !1), t.addEventListener("webkitfullscreenchange", i, !1), t.addEventListener("mozfullscreenchange", i, !1)) : t.attachEvent && (document.attachEvent("onkeydown", o), document.attachEvent("onkeyup", r), t.attachEvent("onblur", i))
        }
        function n() {
            i(), t.removeEventListener ? (document.removeEventListener("keydown", o, !1), document.removeEventListener("keyup", r, !1), t.removeEventListener("blur", i, !1), t.removeEventListener("webkitfullscreenchange", i, !1), t.removeEventListener("mozfullscreenchange", i, !1)) : t.detachEvent && (document.detachEvent("onkeydown", o), document.detachEvent("onkeyup", r), t.detachEvent("onblur", i))
        }
        function i(t) {
            I = [], u(), f(t)
        }
        function o(t) {
            var e, n, i;
            if (e = s(t.keyCode), !(e.length < 1)) {
                for (t.isRepeat = !1, i = 0; i < e.length; i += 1)
                    n = e[i], -1 != x().indexOf(n) && (t.isRepeat = !0), C(n);
                c(), g(t)
            }
        }
        function r(t) {
            var e, n;
            if (e = s(t.keyCode), !(e.length < 1)) {
                for (n = 0; n < e.length; n += 1)
                    M(e[n]);
                u(), f(t)
            }
        }
        function s(t) {
            return E[t] || []
        }
        function a(t) {
            var e;
            for (e in E)
                if (E.hasOwnProperty(e) && E[e].indexOf(t) > -1)
                    return e;
            return !1
        }
        function l(t, e) {
            if ("string" != typeof t && ("object" != typeof t || "function" != typeof t.push))
                throw new Error("Cannot create macro. The combo must be a string or array.");
            if ("object" != typeof e || "function" != typeof e.push)
                throw new Error("Cannot create macro. The injectedKeys must be an array.");
            T.push([t, e])
        }
        function h(t) {
            var e;
            if ("string" != typeof t && ("object" != typeof t || "function" != typeof t.push))
                throw new Error("Cannot remove macro. The combo must be a string or array.");
            for (mI = 0; mI < T.length; mI += 1)
                if (e = T[mI], y(t, e[0])) {
                    M(e[1]), T.splice(mI, 1);
                    break
                }
        }
        function c() {
            var t, e, n;
            for (t = 0; t < T.length; t += 1)
                if (e = b(T[t][0]), -1 === k.indexOf(T[t]) && _(e))
                    for (k.push(T[t]), n = 0; n < T[t][1].length; n += 1)
                        C(T[t][1][n])
        }
        function u() {
            var t, e, n;
            for (t = 0; t < k.length; t += 1)
                if (e = b(k[t][0]), _(e) === !1) {
                    for (n = 0; n < k[t][1].length; n += 1)
                        M(k[t][1][n]);
                    k.splice(t, 1), t -= 1
                }
        }
        function p(t, e, n) {
            function i() {
                var t;
                for (t = 0; t < h.length; t += 1)
                    N.splice(N.indexOf(h[t]), 1)
            }
            function o(t) {
                function e() {
                    var e, i;
                    for (e = 0; e < n.length; e += 1)
                        if ("function" == typeof n[e])
                            if ("keyup" === t)
                                for (i = 0; i < h.length; i += 1)
                                    h[i].keyUpCallback.splice(h[i].keyUpCallback.indexOf(n[e]), 1);
                            else
                                for (i = 0; i < h.length; i += 1)
                                    h[i].keyDownCallback.splice(h[i].keyDownCallback.indexOf(n[e]), 1)
                }
                var n, i, o, r = {};
                if ("string" != typeof t)
                    throw new Error("Cannot bind callback. The event name must be a string.");
                if ("keyup" !== t && "keydown" !== t)
                    throw new Error('Cannot bind callback. The event name must be a "keyup" or "keydown".');
                for (n = Array.prototype.slice.apply(arguments, [1]), i = 0; i < n.length; i += 1)
                    if ("function" == typeof n[i])
                        if ("keyup" === t)
                            for (o = 0; o < h.length; o += 1)
                                h[o].keyUpCallback.push(n[i]);
                        else if ("keydown" === t)
                            for (o = 0; o < h.length; o += 1)
                                h[o].keyDownCallback.push(n[i]);
                return r.clear = e, r
            }
            var r, s, a, l = {}, h = [];
            for ("string" == typeof t && (t = b(t)), s = 0; s < t.length; s += 1) {
                if (r = {}, a = w([t[s]]), "string" != typeof a)
                    throw new Error("Failed to bind key combo. The key combo must be string.");
                r.keyCombo = a, r.keyDownCallback = [], r.keyUpCallback = [], e && r.keyDownCallback.push(e), n && r.keyUpCallback.push(n), N.push(r), h.push(r)
            }
            return l.clear = i, l.on = o, l
        }
        function d(t) {
            var e, n;
            for (e = 0; e < N.length; e += 1)
                n = N[e], y(t, n.keyCombo) && (N.splice(e, 1), e -= 1)
        }
        function m(t) {
            var e, n, i;
            if (t) {
                for (e = 0; e < N.length; e += 1)
                    for (i = N[e], n = 0; n < i.keyCombo.length; n += 1)
                        if (i.keyCombo[n].indexOf(t) > -1) {
                            N.splice(e, 1), e -= 1;
                            break
                        }
            } else
                N = []
        }
        function g(t) {
            var e, n, i, o, r, s, a, l, h, c, u, p = [];
            for (r = [].concat(I), e = 0; e < N.length; e += 1)
                u = v(N[e].keyCombo).length, p[u] || (p[u] = []), p[u].push(N[e]);
            for (n = p.length - 1; n >= 0; n -= 1)
                if (p[n])
                    for (e = 0; e < p[n].length; e += 1) {
                        for (i = p[n][e], o = v(i.keyCombo), h = !0, l = 0; l < o.length; l += 1)
                            if (-1 === r.indexOf(o[l])) {
                                h = !1;
                                break
                            }
                        if (h && _(i.keyCombo)) {
                            for (R.push(i), l = 0; l < o.length; l += 1)
                                c = r.indexOf(o[l]), c > -1 && (r.splice(c, 1), l -= 1);
                            for (s = 0; s < i.keyDownCallback.length; s += 1)
                                i.keyDownCallback[s](t, x(), i.keyCombo) === !1 && (a = !0);
                            a === !0 && (t.preventDefault(), t.stopPropagation())
                        }
                    }
        }
        function f(t) {
            var e, n, i, o;
            for (e = 0; e < R.length; e += 1)
                if (i = R[e], _(i.keyCombo) === !1) {
                    for (n = 0; n < i.keyUpCallback.length; n += 1)
                        i.keyUpCallback[n](t, x(), i.keyCombo) === !1 && (o = !0);
                    o === !0 && (t.preventDefault(), t.stopPropagation()), R.splice(e, 1), e -= 1
                }
        }
        function y(t, e) {
            var n, i, o;
            if (t = b(t), e = b(e), t.length !== e.length)
                return !1;
            for (n = 0; n < t.length; n += 1) {
                if (t[n].length !== e[n].length)
                    return !1;
                for (i = 0; i < t[n].length; i += 1) {
                    if (t[n][i].length !== e[n][i].length)
                        return !1;
                    for (o = 0; o < t[n][i].length; o += 1)
                        if (-1 === e[n][i].indexOf(t[n][i][o]))
                            return !1
                }
            }
            return !0
        }
        function _(t) {
            var e, n, i, o, r, s, a = 0;
            for (t = b(t), e = 0; e < t.length; e += 1) {
                for (s = !0, a = 0, n = 0; n < t[e].length; n += 1) {
                    for (i = [].concat(t[e][n]), o = a; o < I.length; o += 1)
                        r = i.indexOf(I[o]), r > -1 && (i.splice(r, 1), a = o);
                    if (0 !== i.length) {
                        s = !1;
                        break
                    }
                }
                if (s)
                    return !0
            }
            return !1
        }
        function v(t) {
            var e, n, i = [];
            for (t = b(t), e = 0; e < t.length; e += 1)
                for (n = 0; n < t[e].length; n += 1)
                    i = i.concat(t[e][n]);
            return i
        }
        function b(t) {
            var e = t, n = 0, i = 0, o = !1, r = !1, s = [], a = [], l = [], h = "";
            if ("object" == typeof t && "function" == typeof t.push)
                return t;
            if ("string" != typeof t)
                throw new Error('Cannot parse "keyCombo" because its type is "' + typeof t + '". It must be a "string".');
            for (; " " === e.charAt(n); )
                n += 1;
            for (; ; ) {
                if (" " === e.charAt(n)) {
                    for (; " " === e.charAt(n); )
                        n += 1;
                    o = !0
                } else if ("," === e.charAt(n)) {
                    if (i || r)
                        throw new Error("Failed to parse key combo. Unexpected , at character index " + n + ".");
                    r = !0, n += 1
                } else if ("+" === e.charAt(n)) {
                    if (h.length && (l.push(h), h = ""), i || r)
                        throw new Error("Failed to parse key combo. Unexpected + at character index " + n + ".");
                    i = !0, n += 1
                } else if (">" === e.charAt(n)) {
                    if (h.length && (l.push(h), h = ""), l.length && (a.push(l), l = []), i || r)
                        throw new Error("Failed to parse key combo. Unexpected > at character index " + n + ".");
                    i = !0, n += 1
                } else if (n < e.length - 1 && "!" === e.charAt(n) && (">" === e.charAt(n + 1) || "," === e.charAt(n + 1) || "+" === e.charAt(n + 1)))
                    h += e.charAt(n + 1), i = !1, o = !1, r = !1, n += 2;
                else {
                    if (!(n < e.length && "+" !== e.charAt(n) && ">" !== e.charAt(n) && "," !== e.charAt(n) && " " !== e.charAt(n))) {
                        n += 1;
                        continue
                    }
                    for ((i === !1 && o === !0 || r === !0) && (h.length && (l.push(h), h = ""), l.length && (a.push(l), l = []), a.length && (s.push(a), a = [])), i = !1, o = !1, r = !1; n < e.length && "+" !== e.charAt(n) && ">" !== e.charAt(n) && "," !== e.charAt(n) && " " !== e.charAt(n); )
                        h += e.charAt(n), n += 1
                }
                if (n >= e.length) {
                    h.length && (l.push(h), h = ""), l.length && (a.push(l), l = []), a.length && (s.push(a), a = []);
                    break
                }
            }
            return s
        }
        function w(t) {
            var e, n, i = [];
            if ("string" == typeof t)
                return t;
            if ("object" != typeof t || "function" != typeof t.push)
                throw new Error("Cannot stringify key combo.");
            for (e = 0; e < t.length; e += 1) {
                for (i[e] = [], n = 0; n < t[e].length; n += 1)
                    i[e][n] = t[e][n].join(" + ");
                i[e] = i[e].join(" > ")
            }
            return i.join(" ")
        }
        function x() {
            return [].concat(I)
        }
        function C(t) {
            if (t.match(/\s/))
                throw new Error("Cannot add key name " + t + " to active keys because it contains whitespace.");
            I.indexOf(t) > -1 || I.push(t)
        }
        function M(t) {
            var e = a(t);
            "91" === e || "92" === e ? I = [] : I.splice(I.indexOf(t), 1)
        }
        function D(t, e) {
            if ("string" != typeof t)
                throw new Error("Cannot register new locale. The locale name must be a string.");
            if ("object" != typeof e)
                throw new Error("Cannot register " + t + " locale. The locale map must be an object.");
            if ("object" != typeof e.map)
                throw new Error("Cannot register " + t + " locale. The locale map is invalid.");
            e.macros || (e.macros = []), P[t] = e
        }
        function B(t) {
            if (t) {
                if ("string" != typeof t)
                    throw new Error("Cannot set locale. The locale name must be a string.");
                if (!P[t])
                    throw new Error("Cannot set locale to " + t + " because it does not exist. If you would like to submit a " + t + " locale map for KeyboardJS please submit it at https://github.com/RobertWHurst/KeyboardJS/issues.");
                E = P[t].map, T = P[t].macros, A = t
            }
            return A
        }
        var A, E, T, S, L, O = {}, P = {}, I = [], N = [], R = [], k = [];
        for (L = {map: {3: ["cancel"],8: ["backspace"],9: ["tab"],12: ["clear"],13: ["enter"],16: ["shift"],17: ["ctrl"],18: ["alt", "menu"],19: ["pause", "break"],20: ["capslock"],27: ["escape", "esc"],32: ["space", "spacebar"],33: ["pageup"],34: ["pagedown"],35: ["end"],36: ["home"],37: ["left"],38: ["up"],39: ["right"],40: ["down"],41: ["select"],42: ["printscreen"],43: ["execute"],44: ["snapshot"],45: ["insert", "ins"],46: ["delete", "del"],47: ["help"],91: ["command", "windows", "win", "super", "leftcommand", "leftwindows", "leftwin", "leftsuper"],92: ["command", "windows", "win", "super", "rightcommand", "rightwindows", "rightwin", "rightsuper"],145: ["scrolllock", "scroll"],186: ["semicolon", ";"],187: ["equal", "equalsign", "="],188: ["comma", ","],189: ["dash", "-"],190: ["period", "."],191: ["slash", "forwardslash", "/"],192: ["graveaccent", "`"],219: ["openbracket", "["],220: ["backslash", "\\"],221: ["closebracket", "]"],222: ["apostrophe", "'"],48: ["zero", "0"],49: ["one", "1"],50: ["two", "2"],51: ["three", "3"],52: ["four", "4"],53: ["five", "5"],54: ["six", "6"],55: ["seven", "7"],56: ["eight", "8"],57: ["nine", "9"],96: ["numzero", "num0"],97: ["numone", "num1"],98: ["numtwo", "num2"],99: ["numthree", "num3"],100: ["numfour", "num4"],101: ["numfive", "num5"],102: ["numsix", "num6"],103: ["numseven", "num7"],104: ["numeight", "num8"],105: ["numnine", "num9"],106: ["nummultiply", "num*"],107: ["numadd", "num+"],108: ["numenter"],109: ["numsubtract", "num-"],110: ["numdecimal", "num."],111: ["numdevide", "num/"],144: ["numlock", "num"],112: ["f1"],113: ["f2"],114: ["f3"],115: ["f4"],116: ["f5"],117: ["f6"],118: ["f7"],119: ["f8"],120: ["f9"],121: ["f10"],122: ["f11"],123: ["f12"]},macros: [["shift + `", ["tilde", "~"]], ["shift + 1", ["exclamation", "exclamationpoint", "!"]], ["shift + 2", ["at", "@"]], ["shift + 3", ["number", "#"]], ["shift + 4", ["dollar", "dollars", "dollarsign", "$"]], ["shift + 5", ["percent", "%"]], ["shift + 6", ["caret", "^"]], ["shift + 7", ["ampersand", "and", "&"]], ["shift + 8", ["asterisk", "*"]], ["shift + 9", ["openparen", "("]], ["shift + 0", ["closeparen", ")"]], ["shift + -", ["underscore", "_"]], ["shift + =", ["plus", "+"]], ["shift + (", ["opencurlybrace", "opencurlybracket", "{"]], ["shift + )", ["closecurlybrace", "closecurlybracket", "}"]], ["shift + \\", ["verticalbar", "|"]], ["shift + ;", ["colon", ":"]], ["shift + '", ["quotationmark", '"']], ["shift + !,", ["openanglebracket", "<"]], ["shift + .", ["closeanglebracket", ">"]], ["shift + /", ["questionmark", "?"]]]}, S = 65; 90 >= S; S += 1)
            L.map[S] = String.fromCharCode(S + 32), L.macros.push(["shift + " + String.fromCharCode(S + 32) + ", capslock + " + String.fromCharCode(S + 32), [String.fromCharCode(S)]]);
        return D("us", L), B("us"), e(), O.enable = e, O.disable = n, O.activeKeys = x, O.on = p, O.clear = d, O.clear.key = m, O.locale = B, O.locale.register = D, O.macro = l, O.macro.remove = h, O.key = {}, O.key.name = s, O.key.code = a, O.combo = {}, O.combo.active = _, O.combo.parse = b, O.combo.stringify = w, O
    });
    var n = n || {};
    n.AccelManager = n.Base.$extend({__init__: function() {
            this.__kbd = {}, this.$super()
        },__kbd: null,addAccel: function(t, n, i, o) {
            var n = n.toLowerCase().replace(/ *\+ */, " + ").replace(/ *, */, ", ").replace(/ *> */, " > ");
            this.removeAccel(t), this.__kbd[t] = {keys: n,safe: o === e ? !0 : o,callback: i,binding: KeyboardJS.on(n, this.__onAccell.bind(this))}
        },removeAccel: function(t) {
            this.__kbd[t] && (this.__kbd[t].binding.clear(), delete this.__kbd[t])
        },destroy: function() {
            for (var t in this.__kbd)
                this.removeAccel(t);
            this.$super()
        },__onAccell: function(t, e, n) {
            for (var i in this.__kbd)
                this.__kbd[i].keys == n && (this.__kbd[i].safe && (document.activeElement instanceof HTMLInputElement || document.activeElement instanceof HTMLSelectElement || document.activeElement instanceof HTMLTextAreaElement) || (this.__kbd[i].callback(), t.stopPropagation(), t.preventDefault()))
        }});
    var n = n || {};
    n.Separator = n.Widget.$extend({__init__: function(t) {
            this.$super(t), this._updateProperties(["orientation"])
        },_orientation: "horizontal",getOrientation: function() {
            return this._orientation
        },setOrientation: function(t) {
            if ("vertical" != t && "horizontal" != t)
                throw 'Error: The orientation should be "vertical" or "horizontal".';
            this._orientation = t, this.removeClass("photonui-separator-vertical"), this.removeClass("photonui-separator-horizontal"), this.addClass("photonui-separator-" + this.orientation)
        },getHtml: function() {
            return this.__html.outer
        },_buildHtml: function() {
            this.__html.outer = document.createElement("div"), this.__html.outer.className = "photonui-widget photonui-separator", this.__html.hr = document.createElement("hr"), this.__html.outer.appendChild(this.__html.hr)
        },__onLocaleChanged: function() {
        }});
    var n = n || {};
    n.Color = n.Base.$extend({__init__: function(t) {
            this._registerWEvents(["value-changed"]), "object" != typeof t || Array.isArray(t) ? (this.$super(), "string" == typeof t ? this.hexString = t : Array.isArray(t) ? this.setRGBA(t) : arguments.length >= 3 && this.setRGBA.apply(this, arguments)) : this.$super(t)
        },getHexString: function() {
            var t = this.red.toString(16).toUpperCase();
            1 == t.length && (t = "0" + t);
            var e = this.green.toString(16).toUpperCase();
            1 == e.length && (e = "0" + e);
            var n = this.blue.toString(16).toUpperCase();
            return 1 == n.length && (n = "0" + n), "#" + t + e + n
        },setHexString: function(t) {
            var t = t.replace(" ", "");
            if (t.match(/^#[0-9a-f]{6}$/i))
                this._red = parseInt(t[1] + t[2], 16), this._green = parseInt(t[3] + t[4], 16), this._blue = parseInt(t[5] + t[6], 16), this._updateHSB();
            else if (t.match(/^#[0-9a-f]{3}$/i))
                this._red = parseInt(t[1] + t[1], 16), this._green = parseInt(t[2] + t[2], 16), this._blue = parseInt(t[3] + t[3], 16), this._updateHSB();
            else {
                var n = {white: [255, 255, 255],silver: [192, 192, 192],gray: [128, 128, 128],black: [0, 0, 0],red: [255, 0, 0],maroon: [128, 0, 0],yellow: [255, 255, 0],olive: [128, 128, 0],lime: [0, 255, 0],green: [0, 128, 0],aqua: [0, 255, 255],teal: [0, 128, 128],blue: [0, 0, 255],navy: [0, 0, 128],fuchsia: [255, 0, 255],purple: [128, 0, 128]};
                n[t] != e && this.setRGB(n[t])
            }
        },getRgbString: function() {
            return "rgb(" + this._red + ", " + this._green + ", " + this._blue + ")"
        },getRgbaString: function() {
            return "rgba(" + this._red + ", " + this._green + ", " + this._blue + ", " + this._alpha / 255 + ")"
        },_red: 255,getRed: function() {
            return this._red
        },setRed: function(t) {
            this._red = Math.max(0, Math.min(255, 0 | t)), this._updateHSB()
        },_green: 0,getGreen: function() {
            return this._green
        },setGreen: function(t) {
            this._green = Math.max(0, Math.min(255, 0 | t)), this._updateHSB()
        },_blue: 0,getBlue: function() {
            return this._blue
        },setBlue: function(t) {
            this._blue = Math.max(0, Math.min(255, 0 | t)), this._updateHSB()
        },_alpha: 255,getAlpha: function() {
            return this._alpha
        },setAlpha: function(t) {
            this._alpha = Math.max(0, Math.min(255, 0 | t)), this._callCallbacks("value-changed")
        },_hue: 0,getHue: function() {
            return this._hue
        },setHue: function(t) {
            this._hue = Math.max(0, Math.min(360, 0 | t)), this._updateRGB()
        },_saturation: 100,getSaturation: function() {
            return this._saturation
        },setSaturation: function(t) {
            this._saturation = Math.max(0, Math.min(100, 0 | t)), this._updateRGB()
        },_brightness: 100,getBrightness: function() {
            return this._brightness
        },setBrightness: function(t) {
            this._brightness = Math.max(0, Math.min(100, 0 | t)), this._updateRGB()
        },setRGB: function() {
            this.setRGBA.apply(this, arguments)
        },setRGBA: function() {
            var t = arguments;
            1 == arguments.length && Array.isArray(arguments[0]) && (t = arguments[0]), t.length < 3 || (this._red = Math.max(0, Math.min(255, 0 | t[0])), this._green = Math.max(0, Math.min(255, 0 | t[1])), this._blue = Math.max(0, Math.min(255, 0 | t[2])), t[3] != e && (this._alpha = Math.max(0, Math.min(255, 0 | t[3]))), this._updateHSB())
        },getRGB: function() {
            return [this._red, this._green, this._blue]
        },getRGBA: function() {
            return [this._red, this._green, this._blue, this._alpha]
        },setHSB: function() {
            var t = arguments;
            1 == arguments.length && Array.isArray(arguments[0]) && (t = arguments[0]), 3 == t.length && (this._hue = Math.max(0, Math.min(360, 0 | t[0])), this._saturation = Math.max(0, Math.min(100, 0 | t[1])), this._brightness = Math.max(0, Math.min(100, 0 | t[2])), this._updateRGB())
        },toString: function() {
            return this.hexString
        },_updateHSB: function() {
            var t = this._red / 255, e = this._green / 255, n = this._blue / 255, i = Math.min(t, e, n), o = Math.max(t, e, n);
            o == i ? this._hue = 0 : o == t ? this._hue = Math.round((60 * (e - n) / (o - i) + 360) % 360) : o == e ? this._hue = Math.round(60 * (n - t) / (o - i) + 120) : o == n && (this._hue = Math.round(60 * (t - e) / (o - i) + 240)), this._saturation = 0 == o ? 0 : Math.round(100 * (1 - i / o)), this._brightness = Math.round(100 * o), this._callCallbacks("value-changed")
        },_updateRGB: function() {
            var t = this.hue % 360, e = this.saturation / 100, n = this.brightness / 100, i = (t / 60 | 0) % 6, o = t / 60 - i, r = n * (1 - e), s = n * (1 - o * e), a = n * (1 - (1 - o) * e);
            switch (i) {
                case 0:
                    this._red = 255 * n | 0, this._green = 255 * a | 0, this._blue = 255 * r | 0;
                    break;
                case 1:
                    this._red = 255 * s | 0, this._green = 255 * n | 0, this._blue = 255 * r | 0;
                    break;
                case 2:
                    this._red = 255 * r | 0, this._green = 255 * n | 0, this._blue = 255 * a | 0;
                    break;
                case 3:
                    this._red = 255 * r | 0, this._green = 255 * s | 0, this._blue = 255 * n | 0;
                    break;
                case 4:
                    this._red = 255 * a | 0, this._green = 255 * r | 0, this._blue = 255 * n | 0;
                    break;
                case 5:
                    this._red = 255 * n | 0, this._green = 255 * r | 0, this._blue = 255 * s | 0
            }
            this._callCallbacks("value-changed")
        }});
    var n = n || {};
    n.FileManager = n.Base.$extend({__init__: function(t) {
            this.__fileField = document.createElement("input"), this.__fileField.type = "file", this.__fileField.addEventListener("change", this.__onFileSelected.bind(this), !1), this.__fileField.style.position = "fixed", this.__fileField.style.top = 0, this.__fileField.style.left = 0, this.__fileField.style.opacity = 0, this.__fileField.style.display = "none", document.getElementsByTagName("body")[0].appendChild(this.__fileField), this._acceptedMimes = [], this._acceptedExts = [], this._registerWEvents(["file-open"]), this.$super(t)
        },_acceptedMimes: [],getAcceptedMimes: function() {
            return this._acceptedMimes
        },setAcceptedMimes: function(t) {
            this._acceptedMimes = t, this._updateAccepted()
        },_acceptedExts: [],getAcceptedExts: function() {
            return this._acceptedExts
        },setAcceptedExts: function(t) {
            this._acceptedExts = t, this._updateAccepted()
        },_dropZone: null,getDropZone: function() {
            return this._dropZone
        },setDropZone: function(t) {
            this._dropZone && (this._unbindEvent("document-dragover"), this._unbindEvent("document-drop"), this._unbindEvent("element-dragover"), this._unbindEvent("element-drop")), this._dropZone = t, t && (this._bindEvent("document-dragover", document, "dragover", function(t) {
                t.preventDefault()
            }), this._bindEvent("document-drop", document, "drop", function(t) {
                t.preventDefault()
            }), this._bindEvent("element-dragover", document, "dragover", function() {
            }), this._bindEvent("element-drop", document, "drop", this.__onFileDropped.bind(this)))
        },_multiselect: !1,getMultiselect: function() {
            return this._multiselect
        },setMultiselect: function(t) {
            this._multiselect = t, t ? this.__fileField.multiple = "true" : delete this.__fileField.multiple
        },__fileField: null,open: function() {
            this.__fileField.style.display = "inline-block", this.__fileField.focus(), this.__fileField.click(), this.__fileField.style.display = "none"
        },destroy: function() {
            document.getElementsByTagName("body")[0].removeChild(this.__fileField), this.$super()
        },_updateAccepted: function() {
            for (var t = [], e = 0; e < this.acceptedExts.length; e++)
                t.push("." + this.acceptedExts[e].toLocaleLowerCase());
            t = t.concat(this.acceptedMimes), this.__fileField.accept = t.join(",")
        },_openFile: function(t, e, n) {
            for (var i = !1, o = 0; o < this.acceptedMimes.length; o++)
                if (t.type == this.acceptedMimes[o]) {
                    i = !0;
                    break
                }
            if (!i)
                for (var r = t.name.split(".").splice(-1), s = 0; s < this.acceptedExts.length; s++)
                    if (r == this.acceptedExts[s]) {
                        i = !0;
                        break
                    }
            i && this._callCallbacks("file-open", [t, e, n])
        },__onFileDropped: function(t) {
            for (var e in t.dataTransfer.files) {
                var n = t.dataTransfer.files[e];
                n instanceof File && this._openFile(n, t.pageX, t.pageY)
            }
        },__onFileSelected: function() {
            for (var t in this.__fileField.files) {
                var e = this.__fileField.files[t];
                e instanceof File && this._openFile(e)
            }
        },__onLocaleChanged: function() {
        }});
    var n = n || {};
    n.ProgressBar = n.Widget.$extend({__init__: function(t) {
            this.$super(t), this._updateProperties(["orientation", "value", "pulsate"])
        },getHtml: function() {
            return this.__html.outer
        },_value: 0,getValue: function() {
            return this._value
        },setValue: function(t) {
            this._value = Math.min(Math.max(t, 0), 1), "horizontal" == this.orientation ? this.__html.bar.style.width = Math.floor(100 * this.value) + "%" : this.__html.bar.style.height = Math.floor(100 * this.value) + "%", this.__html.textContent.innerHTML = Math.floor(100 * this.value) + " %"
        },_orientation: "horizontal",getOrientation: function() {
            return this._orientation
        },setOrientation: function(t) {
            if ("vertical" != t && "horizontal" != t)
                throw 'Error: The orientation should be "vertical" or "horizontal".';
            this._orientation = t, this.removeClass("photonui-progressbar-vertical"), this.removeClass("photonui-progressbar-horizontal"), this.addClass("photonui-progressbar-" + this.orientation)
        },_pulsate: !1,isPulsate: function() {
            return this._pulsate
        },setPulsate: function(t) {
            this._pulsate = t, t ? (this.addClass("photonui-progressbar-pulsate"), "horizontal" == this.orientation ? this.__html.bar.style.width = "" : this.__html.bar.style.height = "") : (this.removeClass("photonui-progressbar-pulsate"), this.value = this.value)
        },_textVisible: !0,isTextVisible: function() {
            return this._textVisible
        },setTextVisible: function(t) {
            this._textVisible = t, this.__html.text.style.display = this.textVisible ? "" : "none"
        },_buildHtml: function() {
            this.__html.outer = document.createElement("div"), this.__html.outer.className = "photonui-widget photonui-progressbar", this.__html.text = document.createElement("div"), this.__html.text.className = "photonui-progressbar-text", this.__html.outer.appendChild(this.__html.text), this.__html.textContent = document.createElement("span"), this.__html.text.appendChild(this.__html.textContent), this.__html.bar = document.createElement("div"), this.__html.bar.className = "photonui-progressbar-bar", this.__html.outer.appendChild(this.__html.bar)
        },__onLocaleChanged: function() {
        }});
    var n = n || {};
    n.MouseManager = n.Base.$extend({__init__: function(t) {
            this._registerWEvents(["mouse-event", "mouse-down", "mouse-up", "click", "double-click", "drag-start", "dragging", "drag-end", "mouse-move", "scroll-up", "scroll-down"]), this.$super(), this.element = t
        },_element: null,getElement: function() {
            return this._element || document
        },setElement: function(t) {
            this._element = t instanceof n.Widget ? t.interactiveNode || t.html : t instanceof HTMLElement ? t : null, this._updateEvents()
        },_threshold: 5,getThreshold: function() {
            return this._threshold
        },setThreshold: function(t) {
            this._threshold = t
        },getPageX: function() {
            return this.__event.pageX || 0
        },getPageY: function() {
            return this.__event.pageY || 0
        },getX: function() {
            var t = n.Helpers.getAbsolutePosition(this.element).x;
            return this.pageX - t
        },getY: function() {
            var t = n.Helpers.getAbsolutePosition(this.element).y;
            return this.pageY - t
        },getDeltaX: function() {
            return this.pageX - (this.__prevState.pageX !== e ? this.__prevState.pageX : this.pageX)
        },getDeltaY: function() {
            return this.pageY - (this.__prevState.pageY !== e ? this.__prevState.pageY : this.pageY)
        },_action: "",getAction: function() {
            return this._action
        },_btnLeft: !1,getBtnLeft: function() {
            return this._btnLeft
        },_btnMiddle: !1,getBtnMiddle: function() {
            return this._btnMiddle
        },_btnRight: !1,getBtnRight: function() {
            return this._btnRight
        },_button: null,getButton: function() {
            return this._button
        },__prevState: {},__mouseDownEvent: {},__event: {},_updateEvents: function() {
            for (var t in this.__events)
                this._unbindEvent(t);
            this.element && (this._bindEvent("mouse-down", this.element, "mousedown", this.__onMouseDown.bind(this)), this._bindEvent("mouse-up", this.element, "mouseup", this.__onMouseUp.bind(this)), this._bindEvent("double-click", this.element, "dblclick", this.__onDoubleClick.bind(this)), this._bindEvent("mouse-move", this.element, "mousemove", this.__onMouseMove.bind(this)), this._bindEvent("mousewheel", this.element, "mousewheel", this.__onMouseWheel.bind(this)), this._bindEvent("mousewheel-firefox", this.element, "DOMMouseScroll", this.__onMouseWheel.bind(this)), this._bindEvent("document-mouse-up", document, "mouseup", this.__onDocumentMouseUp.bind(this)), this._bindEvent("document-mouse-move", document, "mousemove", this.__onDocumentMouseMove.bind(this)))
        },_dump: function() {
            return {event: this.__event,action: this.action,pageX: this.pageX,pageY: this.pageY,x: this.x,y: this.y,deltaX: this.deltaX,deltaY: this.deltaY,btnLeft: this.btnLeft,btnMiddle: this.btnMiddle,btnRight: this.btnRight,button: this.button}
        },_stateMachine: function(t, e) {
            this.__prevState = this._dump(), this._action = t, this.__event = e, this._button = null, 0 === e.button && (this._button = "left"), 1 === e.button && (this._button = "middle"), 2 === e.button && (this._button = "right"), "mouse-down" == t ? (this.__mouseDownEvent = e, 0 === e.button && (this._btnLeft = !0), 1 === e.button && (this._btnMiddle = !0), 2 === e.button && (this._btnRight = !0), this._callCallbacks("mouse-event", [this._dump()]), this._callCallbacks(this.action, [this._dump()])) : "mouse-up" == t ? (0 === e.button && (this._btnLeft = !1), 1 === e.button && (this._btnMiddle = !1), 2 === e.button && (this._btnRight = !1), this._callCallbacks("mouse-event", [this._dump()]), this._callCallbacks(this.action, [this._dump()])) : "drag-end" == t && (0 === e.button && (this._btnLeft = !1), 1 === e.button && (this._btnMiddle = !1), 2 === e.button && (this._btnRight = !1)), "mouse-up" == t && (Math.abs(this.pageX - this.__mouseDownEvent.pageX) <= this._threshold || Math.abs(this.pageY - this.__mouseDownEvent.pageY) <= this._threshold) && (this._action = "click", this._callCallbacks("mouse-event", [this._dump()]), this._callCallbacks("click", [this._dump()])), "double-click" == t && "click" == this.__prevState.action && (this._action = "double-click", this._callCallbacks("mouse-event", [this._dump()]), this._callCallbacks(this.action, [this._dump()])), "mouse-move" == t && (this._callCallbacks("mouse-event", [this._dump()]), this._callCallbacks(this.action, [this._dump()])), "mouse-move" == t && "drag-start" != this.__prevState.action && "dragging" != this.__prevState.action && (this.btnLeft || this.btnMiddle || this.btnRight) ? (Math.abs(this.pageX - this.__mouseDownEvent.pageX) > this._threshold || Math.abs(this.pageY - this.__mouseDownEvent.pageY) > this._threshold) && (this._action = "drag-start", this.__event = this.__mouseDownEvent, this._callCallbacks("mouse-event", [this._dump()]), this._callCallbacks(this.action, [this._dump()]), this._action = "dragging", this.__prevState.event = this.__mouseDownEvent, this.__event = e, this._callCallbacks("mouse-event", [this._dump()]), this._callCallbacks(this.action, [this._dump()])) : "dragging" == t || "mouse-move" == t && ("drag-start" == this.__prevState.action || "dragging" == this.__prevState.action) && (this.btnLeft || this.btnMiddle || this.btnRight) ? (this._action = "dragging", this._callCallbacks("mouse-event", [this._dump()]), this._callCallbacks(this.action, [this._dump()])) : "drag-end" != t && ("mouse-up" != t || "dragging" != this.__prevState.action && "drag-start" != this.__prevState.action || this.btnLeft || this.btnMiddle || this.btnRight) || (this._action = "drag-end", this._callCallbacks("mouse-event", [this._dump()]), this._callCallbacks(this.action, [this._dump()])), ("scroll-up" == t || "scroll-down" == t) && (this._callCallbacks("mouse-event", [this._dump()]), this._callCallbacks(this.action, [this._dump()]))
        },__onMouseDown: function(t) {
            this._stateMachine("mouse-down", t)
        },__onMouseUp: function(t) {
            this._stateMachine("mouse-up", t)
        },__onDoubleClick: function(t) {
            this._stateMachine("double-click", t)
        },__onMouseMove: function(t) {
            this._stateMachine("mouse-move", t)
        },__onDocumentMouseUp: function(t) {
            ("dragging" == this.action || "drag-start" == this.action) && this._stateMachine("drag-end", t)
        },__onDocumentMouseMove: function(t) {
            ("dragging" == this.action || "drag-start" == this.action) && this._stateMachine("dragging", t)
        },__onMouseWheel: function(t) {
            var n = null;
            t.wheelDeltaY != e && (n = t.wheelDeltaY), t.wheelDelta != e && (n = t.wheelDelta), t.axis != e && t.detail != e && 2 == t.axis && (n = -t.detail), null != n && (n >= 0 ? this._stateMachine("scroll-up", t) : this._stateMachine("scroll-down", t))
        }});
    var n = n || {};
    n.palette = [["#000000", "#424242", "#676767", "#989898", "#C5C5C5", "#FFFFFF"], ["#E52131", "#ED7130", "#F0902C", "#F0B922", "#EDE118", "#7DA638"], ["#EA4852", "#F08D52", "#F3A752", "#F9D246", "#F0EC51", "#A7CF41"], ["#F19096", "#F5BC93", "#F9CB94", "#F9E48A", "#F2F08E", "#C6DE84"], ["#F8D1D6", "#F9E2D2", "#F9E8D3", "#FDF8D2", "#F9F9CF", "#E7F1CD"], ["#1E9E85", "#2A7DB5", "#2751A1", "#6C3E98", "#A33E97", "#DF3795"], ["#2FB8A3", "#40A1D7", "#4072B5", "#8963AB", "#B462A7", "#E262A5"], ["#88CEC3", "#8CC9E9", "#87A8D3", "#D2A0C9", "#D2A0C9", "#EDA0C6"], ["#CEEAE7", "#CDE9F8", "#CFDEEF", "#EED9E9", "#EED9E9", "#F8D7E7"]], n.ColorPalette = n.Widget.$extend({__init__: function(t) {
            this._color = new n.Color(n.palette[0][0]), this._registerWEvents(["value-changed"]), this.$super(t), this._updateProperties(["palette", "value"])
        },getValue: function() {
            return this.color.hexString
        },setValue: function(t) {
            this.color.hexString = t
        },_color: null,getColor: function() {
            return this._color
        },setColor: function(t) {
            t instanceof n.Color && (this._color = t)
        },_palette: null,getPalette: function() {
            return this._palette || n.palette
        },setPalette: function(t) {
            if (this._palette = t, !t)
                var t = n.palette;
            this.__html.palette.removeChild(this.__html.tbody), n.Helpers.cleanNode(this.__html.tbody);
            var e, i, o, r;
            for (r = 0; r < t.length; r++) {
                var e = document.createElement("tr");
                for (o = 0; o < t[r].length; o++) {
                    var i = document.createElement("td");
                    i.style.backgroundColor = t[r][o], i.onclick = this.__onColorClicked.bind(this, t[r][o]), e.appendChild(i)
                }
                this.__html.tbody.appendChild(e)
            }
            this.__html.palette.appendChild(this.__html.tbody)
        },getHtml: function() {
            return this.__html.palette
        },_buildHtml: function() {
            this.__html.palette = document.createElement("table"), this.__html.palette.className = "photonui-widget photonui-colorpalette", this.__html.tbody = document.createElement("tbody"), this.__html.palette.appendChild(this.__html.tbody)
        },__onColorClicked: function(t) {
            this.value = t, this._callCallbacks("value-changed", [t])
        }});
    var n = n || {};
    n.FAIcon = n.BaseIcon.$extend({__init__: function(t, e) {
            var n = {};
            if (t && "string" == typeof t) {
                if (n.iconName = t, e && "object" == typeof e)
                    for (var i in e)
                        n[i] = e[i]
            } else
                t && (n = t);
            this.$super(n), this._updateProperties(["iconName", "size", "color"])
        },_iconName: "",getIconName: function() {
            return this._iconName
        },setIconName: function(t) {
            this._iconName = t || "", this.__html.icon.className = "fa " + this.iconName + " " + this.size
        },_size: "",getSize: function() {
            return this._size
        },setSize: function(t) {
            this._size = t || "", this.__html.icon.className = "fa " + this.iconName + " " + this.size
        },_color: "inherit",getColor: function() {
            return this._color
        },setColor: function(t) {
            this._color = t || "inherit", this.__html.icon.style.color = this.color
        },getHtml: function() {
            return this.__html.outer
        },_buildHtml: function() {
            this.__html.outer = document.createElement("span"), this.__html.outer.className = "photonui-widget photonui-icon photonui-faicon", this.__html.icon = document.createElement("i"), this.__html.outer.appendChild(this.__html.icon)
        }});
    var n = n || {};
    n.Layout = n.Container.$extend({__init__: function(t) {
            this._childrenNames = [], this.$super(t)
        },_childrenNames: [],getChildrenNames: function() {
            return this._childrenNames
        },setChildrenNames: function(t) {
            this._childrenNames = t, this._updateLayout()
        },getChildren: function() {
            for (var t = [], e = 0; e < this._childrenNames.length; e++)
                t.push(n.getWidget(this._childrenNames[e]));
            return t
        },setChildren: function(t) {
            for (var e = [], i = 0; i < t.length; i++)
                t[i] instanceof n.Widget && e.push(t[i].name);
            this.childrenNames = e
        },getChildName: function() {
            return console.warn("Warning: You cannot use getChild() on layout widgets, please use getChildren() instead."), null
        },setChildName: function(t) {
            this.childrenNames = [t]
        },getChild: function() {
            return console.warn("Warning: You cannot use getChild() on layout widgets, please use getChildren() instead."), null
        },setChild: function(t) {
            this.children = [t]
        },addChild: function(t, e) {
            e && (t.layoutOptions = e), this._childrenNames.push(t.name), this._updateLayout()
        },removeChild: function(t) {
            var e = this._childrenNames.indexOf(t.name);
            e >= 0 && this._childrenNames.splice(t.name, 1), this._updateLayout()
        },destroy: function() {
            for (var t = this.children, e = 0; e < t.length; e++)
                t[e].destroy();
            this.$super()
        },_updateLayout: function() {
            throw "Error: you should define the _updateLayout() method when you extend a layout widget."
        },__onLocaleChanged: function() {
        }});
    var n = n || {};
    n.TextField = n.Field.$extend({__init__: function(t) {
            this.$super(t), this._bindFieldEvents()
        },getType: function() {
            return this.__html.field.type
        },setType: function(t) {
            if ("text" != t && "password" != t && "email" != t && "search" != t && "tel" != t && "url" != t)
                throw 'Error: The type should be "text", "password", "email", "search", "tel" or "url".';
            this.__html.field.type = t
        },_buildHtml: function() {
            this.__html.field = document.createElement("input"), this.__html.field.className = "photonui-widget photonui-field photonui-field-text", this.__html.field.type = "text"
        }});
    var n = n || {};
    n.NumericField = n.Field.$extend({__init__: function(t) {
            this.$super(t), this._updateProperties(["value"]), this._bindFieldEvents(), this._bindEvent("keypress", this.__html.field, "keypress", this.__onKeypress.bind(this)), this._bindEvent("keyup", this.__html.field, "keyup", this.__onKeyup.bind(this)), this._bindEvent("keydown", this.__html.field, "keydown", this.__onKeydown.bind(this)), this._bindEvent("change", this.__html.field, "change", this.__onChange.bind(this)), this._bindEvent("mousewheel", this.__html.field, "mousewheel", this.__onMouseWheel.bind(this)), this._bindEvent("mousewheel-firefox", this.__html.field, "DOMMouseScroll", this.__onMouseWheel.bind(this))
        },_min: null,getMin: function() {
            return this._min
        },setMin: function(t) {
            this._min = t
        },_max: null,getMax: function() {
            return this._max
        },setMax: function(t) {
            this._max = t
        },_step: 1,getStep: function() {
            return this._step
        },setStep: function(t) {
            this._step = Math.abs(t)
        },_decimalDigits: null,getDecimalDigits: function() {
            return this._decimalDigits
        },setDecimalDigits: function(t) {
            this._decimalDigits = t
        },_decimalSymbol: ".",getDecimalSymbol: function() {
            return this._decimalSymbol
        },setDecimalSymbol: function(t) {
            this._decimalSymbol = t
        },_value: 0,getValue: function() {
            return parseFloat(this._value)
        },setValue: function(t) {
            this._updateValue(t), this._updateFieldValue()
        },_updateValue: function(t) {
            t = ("" + t).replace(",", "."), t = t.replace(/ /g, ""), t = parseFloat(t), isNaN(t) && (t = 0), null != this.min && (t = Math.max(this.min, t)), null != this.max && (t = Math.min(this.max, t)), null != this.decimalDigits && (t = t.toFixed(this.decimalDigits)), this._value = t
        },_updateFieldValue: function() {
            this.__html.field.value = ("" + this._value).replace(".", this.decimalSymbol)
        },_validateInput: function(t) {
            var t = "" + t;
            return t = t.replace(/ /g, ""), /^-?[0-9]*(\.|,)?[0-9]*$/.test(t) && (0 != this.decimalDigits || /^-?[0-9]*$/.test(t)) ? null !== this.min && this.min >= 0 && "-" == t[0] ? !1 : !0 : !1
        },_buildHtml: function() {
            this.__html.field = document.createElement("input"), this.__html.field.className = "photonui-widget photonui-field photonui-field-numeric", this.__html.field.type = "text"
        },__onKeypress: function(t) {
            if (!t.ctrlKey)
                if (13 == t.keyCode)
                    this._updateFieldValue(), this._callCallbacks("value-changed", [this.value]);
                else {
                    var e = this.__html.field, n = e.value.slice(0, e.selectionStart) + String.fromCharCode(t.charCode) + e.value.slice(e.selectionEnd);
                    this._validateInput(n) || t.preventDefault()
                }
        },__onKeyup: function() {
            var t = this.__html.field.value.replace(/[^0-9.,-]*/g, "");
            t != this.__html.field.value && (this.__html.field.value = t), this._updateValue(this.__html.field.value)
        },__onChange: function() {
            this._updateFieldValue(), this._callCallbacks("value-changed", [this.value])
        },__onMouseWheel: function(t) {
            if (document.activeElement == this.__html.field) {
                var n = null;
                t.wheelDeltaY != e && (n = t.wheelDeltaY), t.wheelDelta != e && (n = t.wheelDelta), t.axis != e && t.detail != e && 2 == t.axis && (n = -t.detail), null != n && (n >= 0 ? this.value += this.step : this.value -= this.step, t.preventDefault()), this._callCallbacks("value-changed", [this.value])
            }
        },__onKeydown: function(t) {
            38 == t.keyCode ? (this.setValue(this.getValue() + this.step), t.preventDefault(), this._callCallbacks("value-changed", [this.value])) : 40 == t.keyCode && (this.setValue(this.getValue() - this.step), t.preventDefault(), this._callCallbacks("value-changed", [this.value]))
        }});
    var n = n || {};
    n.Viewport = n.Container.$extend({__init__: function(t) {
            this.$super(t), this._updateProperties(["padding", "verticalScrollbar", "horizontalScrollbar"])
        },_padding: 0,getPadding: function() {
            return this._padding
        },setPadding: function(t) {
            this._padding = t, this.containerNode.style.padding = t + "px"
        },_verticalScrollbar: null,getVerticalScrollbar: function() {
            return this._verticalScrollbar
        },setVerticalScrollbar: function(t) {
            this._verticalScrollbar = t, this.__html.viewport.style.overflowY = t === !0 ? "scroll" : t === !1 ? "hidden" : "auto"
        },_horizontalScrollbar: null,getHorizontalScrollbar: function() {
            return this._horizontalScrollbar
        },setHorizontalScrollbar: function(t) {
            this._horizontalScrollbar = t, this.__html.viewport.style.overflowX = t === !0 ? "scroll" : t === !1 ? "hidden" : "auto"
        },getHtml: function() {
            return this.__html.viewport
        },getContainerNode: function() {
            return this.html
        },_buildHtml: function() {
            this.__html.viewport = document.createElement("div"), this.__html.viewport.className = "photonui-widget photonui-viewport photonui-container"
        },__onLocaleChanged: function() {
        }});
    var n = n || {};
    n.Switch = n.CheckBox.$extend({__init__: function(t) {
            this.$super(t), this.removeClass("photonui-checkbox"), this.addClass("photonui-switch")
        }});
    var n = n || {};
    n.BaseWindow = n.Container.$extend({__init__: function(t) {
            this._registerWEvents(["position-changed"]), this.$super(t);
            var t = t || {};
            t.visible === e && (this.visible = !1), n.domInsert(this), this._updateProperties(["position", "width", "height", "minWidth", "minHeight", "maxWidth", "maxHeight", "padding"])
        },getPosition: function() {
            return this.visible && this.html.parentNode ? this.absolutePosition : {x: this._x,y: this._y}
        },setPosition: function(t, n) {
            "object" == typeof t && n == e ? (this.html.style.left = t.x + "px", this.html.style.top = t.y + "px", this._x = t.x, this._y = t.y) : ("number" == typeof t && (this.html.style.left = t + "px", this._x = t), "number" == typeof n && (this.html.style.top = n + "px", this._y = n)), this._callCallbacks("position-changed", [this.x, this.y])
        },_x: 0,getX: function() {
            return this.position.x
        },setX: function(t) {
            this.setPosition(t, null)
        },_y: 0,getY: function() {
            return this.position.y
        },setY: function(t) {
            this.setPosition(null, t)
        },_width: null,getWidth: function() {
            return this.visible && this.html.parenNode ? this.containerNode.offsetWidth : this._width || 0
        },setWidth: function(t) {
            this._width = t || null, this.containerNode.style.width = this._width ? t + "px" : "auto"
        },_height: null,getHeight: function() {
            return this.visible && this.html.parenNode ? this.containerNode.offsetHeight : this._height || 0
        },setHeight: function(t) {
            this._height = t || null, this.containerNode.style.height = this._height ? t + "px" : "auto"
        },_minWidth: null,getMinWidth: function() {
            return this._minWidth
        },setMinWidth: function(t) {
            this._minWidth = t || null, this.containerNode.style.minWidth = this._minWidth ? t + "px" : "0"
        },_minHeight: null,getMinHeight: function() {
            return this._minHeight
        },setMinHeight: function(t) {
            this._minHeight = t || null, this.containerNode.style.minHeight = this._minHeight ? t + "px" : "0"
        },_maxWidth: null,getMaxWidth: function() {
            return this._maxWidth
        },setMaxWidth: function(t) {
            this._maxWidth = t || null, this.containerNode.style.maxWidth = this._maxWidth ? t + "px" : "auto"
        },_maxHeight: null,getMaxHeight: function() {
            return this._maxHeight
        },setMaxHeight: function(t) {
            this._maxHeight = t || null, this.containerNode.style.maxHeight = this._maxHeight ? t + "px" : "auto"
        },_padding: 0,getPadding: function() {
            return this._padding
        },setPadding: function(t) {
            this._padding = t, this.containerNode.style.padding = t + "px"
        },getHtml: function() {
            return this.__html.window
        },getContainerNode: function() {
            return this.html
        },center: function() {
            this.setPosition(Math.round((n.e_parent.offsetWidth - this.offsetWidth) / 2), Math.round((n.e_parent.offsetHeight - this.offsetHeight) / 2))
        },_buildHtml: function() {
            this.__html.window = document.createElement("div"), this.__html.window.className = "photonui-widget photonui-basewindow"
        }});
    var n = n || {}, o = {};
    n.getSpriteSheet = function(t) {
        return o[t] !== e ? o[t] : null
    }, n.SpriteSheet = n.Base.$extend({__init__: function(t) {
            this._icons = {}, this.$super(t), this._updateProperties(["name"])
        },_name: "default",getName: function() {
            return this._name
        },setName: function(t) {
            o[this.name] == this && delete o[this.name], this._name = t, o[this.name] = this
        },_imageUrl: null,getImageUrl: function() {
            return this._imageUrl
        },setImageUrl: function(t) {
            if (!t)
                return void (this._imageUrl = null);
            if (this._imageUrl != t) {
                this._imageUrl = t;
                var e = new Image;
                e.src = t
            }
        },_size: 16,getSize: function() {
            return this._size
        },setSize: function(t) {
            this._size = t
        },_icons: {},getIcons: function() {
            return this._icons
        },setIcons: function(t) {
            for (icon in t)
                this._icons[icon] = t[icon]
        },getIconPosition: function(t) {
            return {x: this.icons[t][0],y: this.icons[t][1]}
        },getIconCss: function(t) {
            return "width: " + this.size + "px; height: " + this.size + "px; background: url(" + this.imageUrl + ") -" + this.getIconPosition(t).x + "px -" + this.getIconPosition(t).y + "px;"
        },addIcon: function(t, e, n) {
            this.icons = {iconName: [e, n]}
        },removeIcon: function(t) {
            delete this._icons[t]
        }}), n.SpriteIcon = n.BaseIcon.$extend({__init__: function(t, e) {
            var n = {};
            if (t && "string" == typeof t) {
                if (n.icon = t, e && "object" == typeof e)
                    for (var i in e)
                        n[i] = e[i]
            } else
                t && (n = t);
            this.$super(n)
        },_spriteSheetName: "",getSpriteSheetName: function() {
            return this._spriteSheetName
        },setSpriteSheetName: function(t) {
            this._spriteSheetName = t || "", this._update()
        },_iconName: "",getIconName: function() {
            return this._iconName
        },setIconName: function(t) {
            this._iconName = t || "", this._update()
        },getIcon: function() {
            return this.spriteSheetName + "/" + this.iconName
        },setIcon: function(t) {
            var e = t.split("/");
            this.spriteSheetName = e[0], this.iconName = e[1]
        },getHtml: function() {
            return this.__html.outer
        },_update: function() {
            var t = "";
            this.spriteSheetName && this.iconName && (t = n.getSpriteSheet(this.spriteSheetName).getIconCss(this.iconName)), this.__html.icon.setAttribute("style", t)
        },_buildHtml: function() {
            this.__html.outer = document.createElement("span"), this.__html.outer.className = "photonui-widget photonui-icon photonui-spriteicon", this.__html.icon = document.createElement("span"), this.__html.outer.appendChild(this.__html.icon)
        }});
    var n = n || {};
    n.TextAreaField = n.Field.$extend({__init__: function(t) {
            this.$super(t), this._bindFieldEvents()
        },getCols: function() {
            return parseInt(this.__html.field.cols)
        },setCols: function(t) {
            this.__html.field.cols = t
        },getRows: function() {
            return parseInt(this.__html.field.rows)
        },setRows: function(t) {
            this.__html.field.rows = t
        },_buildHtml: function() {
            this.__html.field = document.createElement("textarea"), this.__html.field.className = "photonui-widget photonui-field photonui-field-textarea", this.__html.field.cols = 20, this.__html.field.rows = 3
        }});
    var n = n || {}, r = [];
    n.Window = n.BaseWindow.$extend({__init__: function(t) {
            this._registerWEvents(["close-button-clicked"]), this.$super(t), this._bindEvent("move.dragstart", this.__html.windowTitle, "mousedown", this.__moveDragStart.bind(this)), this._bindEvent("closeButton.click", this.__html.windowTitleCloseButton, "click", this.__closeButtonClicked.bind(this)), this._bindEvent("totop", this.__html.window, "mousedown", this.moveToFront.bind(this)), this._bindEvent("closeButton.mousedown", this.__html.windowTitleCloseButton, "mousedown", function(t) {
                t.stopPropagation()
            }), this._updateProperties(["title", "closeButtonVisible"]), this.moveToFront()
        },_title: "Window",getTitle: function() {
            return this._title
        },setTitle: function(t) {
            this._title = t, n.Helpers.cleanNode(this.__html.windowTitleText), this.__html.windowTitleText.appendChild(document.createTextNode(t))
        },_movable: !0,isMovable: function() {
            return this._movable
        },setMovable: function(t) {
            this._movable = t
        },_closeButtonVisible: !0,getCloseButtonVisible: function() {
            return this._closeButtonVisible
        },setCloseButtonVisible: function(t) {
            this._closeButtonVisible = t, t ? (this.addClass("photonui-window-have-button"), this.__html.windowTitleCloseButton.style.display = "block") : (this.removeClass("photonui-window-have-button"), this.__html.windowTitleCloseButton.style.display = "none")
        },_modal: !1,isModal: function() {
            return this._modal
        },setModal: function(t) {
            this._modal = t, t ? (this.__html.modalBox = document.createElement("div"), this.__html.modalBox.className = "photonui-window-modalbox", n.e_parent.appendChild(this.__html.modalBox), this.visible = this.visible) : this.__html.modalBox && (this.__html.modalBox.parentNode.removeChild(this.__html.modalBox), delete this.__html.modalBox)
        },getContainerNode: function() {
            return this.__html.windowContent
        },setVisible: function(t) {
            this.$super(t), this.visible ? (this.moveToFront(), this.modal && (this.__html.modalBox.style.display = "block")) : (this.moveToBack(), this.modal && (this.__html.modalBox.style.display = "none"))
        },moveToFront: function() {
            var t = r.indexOf(this);
            t >= 0 && r.splice(t, 1), r.unshift(this), this._updateWindowList()
        },moveToBack: function() {
            var t = r.indexOf(this);
            t >= 0 && r.splice(t, 1), r.push(this), this._updateWindowList()
        },destroy: function() {
            this.modal = !1;
            var t = r.indexOf(this);
            t >= 0 && r.splice(t, 1), this.$super()
        },_buildHtml: function() {
            if (t.Stone) {
                t.Stone.lazyGettext
            }
            this.$super(), this.__html.window.className += " photonui-window", this.__html.windowTitle = document.createElement("div"), this.__html.windowTitle.className = "photonui-window-title", this.__html.window.appendChild(this.__html.windowTitle), this.__html.windowTitleCloseButton = document.createElement("button"), this.__html.windowTitleCloseButton.className = "photonui-window-title-close-button", this.__html.windowTitleCloseButton.title = t.Stone ? t.Stone.lazyGettext("Close") : "Close", this.__html.windowTitle.appendChild(this.__html.windowTitleCloseButton), this.__html.windowTitleText = document.createElement("span"), this.__html.windowTitleText.className = "photonui-window-title-text", this.__html.windowTitle.appendChild(this.__html.windowTitleText), this.__html.windowContent = document.createElement("div"), this.__html.windowContent.className = "photonui-container photonui-window-content photonui-container-expand-child", this.__html.window.appendChild(this.__html.windowContent)
        },_updateWindowList: function() {
            for (var t = r.length - 1, e = 0; t >= 0; t--, e++)
                0 == t ? (r[t].html.style.zIndex = 2001, r[t].addClass("photonui-active")) : (r[t].html.style.zIndex = 1e3 + e, r[t].removeClass("photonui-active")), r[t].modal && (r[t].html.style.zIndex = 3001)
        },__moveDragStart: function(t) {
            if (this.movable && !(t.button > 0)) {
                var n = t.offsetX != e ? t.offsetX : t.layerX, i = t.offsetY != e ? t.offsetY : t.layerY;
                this.__html.windowTitle.style.cursor = "move", this._bindEvent("move.dragging", document, "mousemove", this.__moveDragging.bind(this, n, i)), this._bindEvent("move.dragend", document, "mouseup", this.__moveDragEnd.bind(this))
            }
        },__moveDragging: function(t, e, n) {
            var i = document.getElementsByTagName("body")[0], o = Math.min(Math.max(n.pageX - t, 40 - this.offsetWidth), i.offsetWidth - 40), r = Math.max(n.pageY - e, 0);
            i.offsetHeight > 0 && (r = Math.min(r, i.offsetHeight - this.__html.windowTitle.offsetHeight)), this.setPosition(o, r)
        },__moveDragEnd: function() {
            this.__html.windowTitle.style.cursor = "default", this._unbindEvent("move.dragging"), this._unbindEvent("move.dragend")
        },__closeButtonClicked: function() {
            this._callCallbacks("close-button-clicked")
        },__onLocaleChanged: function() {
            this.$super(), this.__html.windowTitleCloseButton.title = t.Stone ? t.Stone.lazyGettext("Close") : "Close"
        }});
    var n = n || {};
    n.GridLayout = n.Layout.$extend({__init__: function(t) {
            this.$super(t), this._updateProperties(["verticalSpacing"])
        },_verticalSpacing: 5,getVerticalSpacing: function() {
            return this._verticalSpacing
        },setVerticalSpacing: function(t) {
            this._verticalSpacing = t, this.__html.grid.style.borderSpacing = this.verticalSpacing + "px " + this.horizontalSpacing + "px"
        },_horizontalSpacing: 5,getHorizontalSpacing: function() {
            return this._horizontalSpacing
        },setHorizontalSpacing: function(t) {
            this._horizontalSpacing = t, this.__html.grid.style.borderSpacing = this.verticalSpacing + "px " + this.horizontalSpacing + "px"
        },getHtml: function() {
            return this.__html.outerbox
        },_buildHtml: function() {
            this.__html.outerbox = document.createElement("div"), this.__html.outerbox.className = "photonui-widget photonui-gridlayout", this.__html.grid = document.createElement("table"), this.__html.outerbox.appendChild(this.__html.grid), this.__html.gridBody = document.createElement("tbody"), this.__html.grid.appendChild(this.__html.gridBody)
        },_updateLayout: function() {
            for (var t = 1 / 0, i = 1 / 0, o = 0, r = 0, s = this.children, a = 0; a < s.length; a++)
                s[a].layoutOptions.gridX = s[a].layoutOptions.gridX != e ? s[a].layoutOptions.gridX : 0, s[a].layoutOptions.gridY = s[a].layoutOptions.gridY != e ? s[a].layoutOptions.gridY : 0, s[a].layoutOptions.gridWidth = Math.max(s[a].layoutOptions.gridWidth, 1) || 1, s[a].layoutOptions.gridHeight = Math.max(s[a].layoutOptions.gridHeight, 1) || 1, t = Math.min(t, s[a].layoutOptions.gridX), i = Math.min(i, s[a].layoutOptions.gridY), o = Math.max(o, s[a].layoutOptions.gridX + s[a].layoutOptions.gridWidth), r = Math.max(r, s[a].layoutOptions.gridY + s[a].layoutOptions.gridHeight);
            o -= t, r -= i, n.Helpers.cleanNode(this.__html.gridBody);
            for (var l = [], h = 0; r > h; h++) {
                for (var c = [], u = 0; o > u; u++)
                    c.push(!1);
                l.push(c)
            }
            for (var h = 0; r > h; h++) {
                var p = document.createElement("tr");
                this.__html.gridBody.appendChild(p);
                for (var u = 0; o > u; u++)
                    if (!l[h][u]) {
                        var d = !1, m = document.createElement("td");
                        m.className = "photonui-container photonui-gridlayout-cell", p.appendChild(m);
                        for (var a = 0; a < s.length; a++)
                            if (s[a].layoutOptions.gridX - t == u && s[a].layoutOptions.gridY - i == h) {
                                d = !0;
                                var g = s[a].layoutOptions.gridWidth, f = s[a].layoutOptions.gridHeight;
                                if (m.colSpan = g, m.rowSpan = f, m.appendChild(s[a].html), (s[a].layoutOptions.horizontalExpansion == e || s[a].layoutOptions.horizontalExpansion) && (m.className += " photonui-container-expand-child-horizontal"), (s[a].layoutOptions.verticalExpansion == e || s[a].layoutOptions.verticalExpansion) && (m.className += " photonui-container-expand-child-vertical"), s[a].layoutOptions.width != e && (m.style.height = s[a].layoutOptions.width + "px"), s[a].layoutOptions.height != e && (m.style.height = s[a].layoutOptions.height + "px"), s[a].layoutOptions.minWidth != e && (m.style.minWidth = s[a].layoutOptions.minWidth + "px"), s[a].layoutOptions.minHeight != e && (m.style.minHeight = s[a].layoutOptions.minHeight + "px"), s[a].layoutOptions.maxWidth != e && (m.style.maxWidth = s[a].layoutOptions.maxWidth + "px"), s[a].layoutOptions.maxHeight != e && (m.style.maxHeight = s[a].layoutOptions.maxHeight + "px"), s[a].layoutOptions.horizontalAlign != e && (m.style.textAlign = s[a].layoutOptions.horizontalAlign), g > 1 || f > 1)
                                    for (var y = h; h + f > y; y++)
                                        for (var _ = u; u + g > _; _++)
                                            l[y][_] = !0;
                                break
                            }
                        d || (m.innerHTML = "&nbsp;")
                    }
            }
        }});
    var n = n || {};
    n.Slider = n.NumericField.$extend({__init__: function(t) {
            this.$super(t), this.inputId = this.name + "-field", this.__html.field.id = this.inputId, this._updateProperties(["fieldVisible"]), this._bindEvent("slider-mousedown", this.__html.slider, "mousedown", this.__onSliderMouseDown.bind(this)), this._bindEvent("slider-keydown", this.__html.slider, "keydown", this.__onSliderKeyDown.bind(this)), this._bindEvent("slider-mousewheel", this.__html.slider, "mousewheel", this.__onSliderMouseWheel.bind(this)), this._bindEvent("slider-mousewheel-firefox", this.__html.slider, "DOMMouseScroll", this.__onSliderMouseWheel.bind(this)), this._bindEvent("field-contextmenu", this.__html.field, "contextmenu", this.__onFieldContextMenu.bind(this))
        },_min: 0,_max: 100,_decimalDigits: 0,_fieldVisible: !0,isFieldVisible: function() {
            return this._fieldVisible
        },setFieldVisible: function(t) {
            this._fieldVisible = t, t ? (this.__html.field.style.display = "", this.removeClass("photonui-slider-nofield")) : (this.__html.field.style.display = "none", this.addClass("photonui-slider-nofield"))
        },getHtml: function() {
            return setTimeout(function() {
                this.value = this.value
            }.bind(this), .01), this.__html.outer
        },setValue: function(t) {
            this.$super(t);
            var e = t - this.min, n = this.max - this.min, i = Math.min(Math.max(e / n, 0), 1), o = this.__html.slider.offsetWidth - this.__html.grip.offsetWidth - 4;
            this.__html.grip.style.left = Math.floor(i * o) + 2 + "px"
        },_buildHtml: function() {
            this.$super(), this.__html.outer = document.createElement("div"), this.__html.outer.className = "photonui-widget photonui-slider", this.__html.slider = document.createElement("div"), this.__html.slider.className = "photonui-slider-slider", this.__html.slider.tabIndex = 0, this.__html.outer.appendChild(this.__html.slider), this.__html.grip = document.createElement("div"), this.__html.grip.className = "photonui-slider-grip", this.__html.slider.appendChild(this.__html.grip), this.__html.outer.appendChild(this.__html.field)
        },_updateFromMouseEvent: function(t) {
            var e = n.Helpers.getAbsolutePosition(this.__html.slider).x, i = this.__html.grip.offsetWidth, o = Math.round(t.pageX - e - i / 2), r = this.__html.slider.offsetWidth - i - 3, s = (this.max - this.min) * o / r + this.min;
            this.value = Math.round(s / this.step) * this.step, this._callCallbacks("value-changed", [this.value])
        },__onSliderMouseDown: function(t) {
            this._updateFromMouseEvent(t), this._bindEvent("slider-mousemove", document, "mousemove", this.__onSliderMouseMove.bind(this)), this._bindEvent("slider-mouseup", document, "mouseup", this.__onSliderMouseUp.bind(this))
        },__onSliderMouseMove: function(t) {
            this._updateFromMouseEvent(t)
        },__onSliderMouseUp: function(t) {
            this._unbindEvent("slider-mousemove"), this._unbindEvent("slider-mouseup"), this._updateFromMouseEvent(t)
        },__onSliderKeyDown: function(t) {
            38 == t.keyCode || 39 == t.keyCode ? (this.value += this.step, this._callCallbacks("value-changed", [this.value])) : (40 == t.keyCode || 37 == t.keyCode) && (this.value -= this.step, this._callCallbacks("value-changed", [this.value]))
        },__onSliderMouseWheel: function(t) {
            var n = null;
            t.wheelDeltaY != e && (n = t.wheelDeltaY), t.wheelDelta != e && (n = t.wheelDelta), t.axis != e && t.detail != e && 2 == t.axis && (n = -t.detail), null != n && (n >= 0 ? this.value += this.step : this.value -= this.step, t.preventDefault(), t.stopPropagation()), this._callCallbacks("value-changed", [this.value])
        },__onContextMenu: function(t) {
            t.stopPropagation(), t.preventDefault(), this.contextMenuName && this.contextMenu.popupXY(t.pageX, t.pageY)
        },__onFieldContextMenu: function(t) {
            t.stopPropagation()
        }});
    var n = n || {};
    n.Button = n.Widget.$extend({__init__: function(t) {
            this._registerWEvents(["click"]), this.$super(t), this._bindEvent("click", this.__html.button, "click", this.__onButtonClicked.bind(this)), this._updateProperties(["text", "leftIconName", "rightIconName"]), this._update()
        },_text: "Button",getText: function() {
            return this._text
        },setText: function(t) {
            this._text = t, n.Helpers.cleanNode(this.__html.text), this.__html.text.appendChild(document.createTextNode(t))
        },_textVisible: !0,isTextVisible: function() {
            return this._textVisible
        },setTextVisible: function(t) {
            this._textVisible = t, this._update()
        },_leftIconName: null,getLeftIconName: function() {
            return this._leftIconName
        },setLeftIconName: function(t) {
            this._leftIconName = t, n.Helpers.cleanNode(this.__html.leftIcon), this._leftIconName && (this.__html.leftIcon.appendChild(this.leftIcon.html), this.leftIconVisible = !0)
        },getLeftIcon: function() {
            return n.getWidget(this._leftIconName)
        },setLeftIcon: function(t) {
            return t instanceof n.BaseIcon ? void (this.leftIconName = t.name) : void (this.leftIconName = null)
        },_leftIconVisible: !0,isLeftIconVisible: function() {
            return this._leftIconVisible
        },setLeftIconVisible: function(t) {
            this._leftIconVisible = t, this._update()
        },_rightIconName: null,getRightIconName: function() {
            return this._rightIconName
        },setRightIconName: function(t) {
            this._rightIconName = t, n.Helpers.cleanNode(this.__html.rightIcon), this._rightIconName && (this.__html.rightIcon.appendChild(this.rightIcon.html), this.rightIconVisible = !0)
        },getRightIcon: function() {
            return n.getWidget(this._rightIconName)
        },setRightIcon: function(t) {
            return t instanceof n.BaseIcon ? void (this.rightIconName = t.name) : void (this.rightIconName = null)
        },_rightIconVisible: !0,isRightIconVisible: function() {
            return this._rightIconVisible
        },setRightIconVisible: function(t) {
            this._rightIconVisible = t, this._update()
        },_appearance: "normal",getAppearance: function() {
            return this._appearance
        },setAppearance: function(t) {
            this._appearance = t, "flat" == t ? this.addClass("photonui-button-appearance-flat") : this.removeClass("photonui-button-appearance-flat")
        },getHtml: function() {
            return this.__html.button
        },_update: function() {
            this.__html.leftIcon.parentNode == this.__html.button && this.__html.button.removeChild(this.__html.leftIcon), this.__html.text.parentNode == this.__html.button && this.__html.button.removeChild(this.__html.text), this.__html.rightIcon.parentNode == this.__html.button && this.__html.button.removeChild(this.__html.rightIcon), this.leftIconName && this.leftIconVisible && this.__html.button.appendChild(this.__html.leftIcon), this.text && this.textVisible && this.__html.button.appendChild(this.__html.text), this.rightIconName && this.rightIconVisible && this.__html.button.appendChild(this.__html.rightIcon)
        },_buildHtml: function() {
            this.__html.button = document.createElement("button"), this.__html.button.className = "photonui-widget photonui-button", this.__html.leftIcon = document.createElement("span"), this.__html.leftIcon.className = "photonui-button-icon", this.__html.button.appendChild(this.__html.leftIcon), this.__html.text = document.createElement("span"), this.__html.text.className = "photonui-button-text", this.__html.button.appendChild(this.__html.text), this.__html.rightIcon = document.createElement("span"), this.__html.rightIcon.className = "photonui-button-icon", this.__html.button.appendChild(this.__html.rightIcon)
        },__onButtonClicked: function(t) {
            this._callCallbacks("click", [t])
        }});
    var s = {_text: n.Button.prototype._text,getText: n.Button.prototype.getText,setText: n.Button.prototype.setText,_textVisible: n.Button.prototype._textVisible,isTextVisible: n.Button.prototype.isTextVisible,setTextVisible: n.Button.prototype.setTextVisible,_leftIconName: n.Button.prototype._leftIconName,getLeftIconName: n.Button.prototype.getLeftIconName,setLeftIconName: n.Button.prototype.setLeftIconName,getLeftIcon: n.Button.prototype.getLeftIcon,setLeftIcon: n.Button.prototype.setLeftIcon,_leftIconVisible: n.Button.prototype._leftIconVisible,isLeftIconVisible: n.Button.prototype.isLeftIconVisible,setLeftIconVisible: n.Button.prototype.setLeftIconVisible,_rightIconName: n.Button.prototype._rightIconName,getRightIconName: n.Button.prototype.getRightIconName,setRightIconName: n.Button.prototype.setRightIconName,getRightIcon: n.Button.prototype.getRightIcon,setRightIcon: n.Button.prototype.setRightIcon,_rightIconVisible: n.Button.prototype._rightIconVisible,isRightIconVisible: n.Button.prototype.isRightIconVisible,setRightIconVisible: n.Button.prototype.setRightIconVisible,_appearance: n.Button.prototype._appearance,getAppearance: n.Button.prototype.getAppearance,setAppearance: n.Button.prototype.setAppearance,_update: n.Button.prototype._update,_buildButtonHtml: n.Button.prototype._buildHtml,__onButtonClicked: n.Button.prototype.__onButtonClicked}, n = n || {};
    n.FluidLayout = n.Layout.$extend({_verticalSpacing: 0,getVerticalSpacing: function() {
            return this._verticalSpacing
        },setVerticalSpacing: function(t) {
            this._verticalSpacing = t, this._updateLayout()
        },_horizontalSpacing: 2,getHorizontalSpacing: function() {
            return this._horizontalSpacing
        },setHorizontalSpacing: function(t) {
            this._horizontalSpacing = t, this._updateLayout()
        },getHtml: function() {
            return this.__html.outerbox
        },_buildHtml: function() {
            this.__html.outerbox = document.createElement("div"), this.__html.outerbox.className = "photonui-widget photonui-fluidlayout"
        },_updateLayout: function() {
            for (var t = this.children, e = document.createDocumentFragment(), i = null, o = 0; o < t.length; o++)
                i = document.createElement("div"), i.className = "photonui-container", i.style.padding = "0 " + this.horizontalSpacing + "px " + this.verticalSpacing + "px 0", i.appendChild(t[o].html), e.appendChild(i);
            n.Helpers.cleanNode(this.__html.outerbox), this.__html.outerbox.appendChild(e)
        }});
    var n = n || {};
    n.PopupWindow = n.BaseWindow.$extend({__init__: function(t) {
            this.$super(t), this._bindEvent("document-mousedown-close", document, "mousedown", this.hide.bind(this)), this._bindEvent("popup-click-close", this.html, "click", this.hide.bind(this)), this._bindEvent("mousedown-preventclose", this.html, "mousedown", function(t) {
                t.stopPropagation()
            }.bind(this))
        },getContainerNode: function() {
            return this.__html.inner
        },popupXY: function(t, e) {
            this.setPosition(-1337, -1337), this.show();
            var n = document.getElementsByTagName("body")[0].offsetWidth, i = document.getElementsByTagName("body")[0].offsetHeight, o = this.offsetWidth, r = this.offsetHeight;
            t + o > n && (t = n - o), e + r > i && (e -= r), 0 > t && (t = 0), 0 > e && (e = 0), this.setPosition(t, e)
        },popupWidget: function(t) {
            this.setPosition(-1337, -1337), this.show();
            var e = document.getElementsByTagName("body")[0], n = 0, i = 0, o = t.absolutePosition, r = t.offsetHeight, s = t.offsetWidth, a = this.offsetWidth, l = this.offsetHeight;
            n = o.x + a < e.offsetWidth ? o.x : o.x + s < e.offsetWidth ? o.x + s - a : e.offsetWidth - a, o.y + r + l < e.offsetHeight ? i = o.y + r + 1 : o.y - l >= 0 && (i = o.y - l - 1), 0 > n && (n = 0), 0 > i && (i = 0), this.setPosition(n, i)
        },_buildHtml: function() {
            this.$super(), this.__html.window.className += " photonui-popupwindow", this.__html.inner = document.createElement("div"), this.__html.window.appendChild(this.__html.inner)
        }});
    var n = n || {}, r = [];
    n.Dialog = n.Window.$extend({__init__: function(t) {
            this._buttonsNames = [], this.$super(t)
        },_buttonsNames: [],getButtonsNames: function() {
            return this._buttonsNames
        },setButtonsNames: function(t) {
            this._buttonsNames = t, this._updateButtons()
        },getButtons: function() {
            for (var t = [], e = 0; e < this._buttonsNames.length; e++)
                t.push(n.getWidget(this._buttonsNames[e]));
            return t
        },setButtons: function(t) {
            for (var e = [], i = 0; i < t.length; i++)
                t[i] instanceof n.Widget && e.push(t[i].name);
            this.buttonsNames = e
        },addButton: function(t) {
            this._childrenNames.push(t.name), this._updateButtons()
        },removeButton: function(t) {
            var e = this._buttonsNames.indexOf(t.name);
            e >= 0 && this._buttonsNames.splice(t.name, 1), this._updateButtons()
        },_updateButtons: function() {
            n.Helpers.cleanNode(this.__html.buttons);
            for (var t = this.buttons, e = t.length - 1; e >= 0; e--)
                this.__html.buttons.appendChild(t[e].html)
        },_buildHtml: function() {
            this.$super(), this.addClass("photonui-dialog"), this.__html.buttons = document.createElement("div"), this.__html.buttons.className = "photonui-dialog-buttons", this.__html.window.appendChild(this.__html.buttons)
        }});
    var n = n || {};
    n.ColorPicker = n.Widget.$extend({__init__: function(t) {
            this._registerWEvents(["value-changed"]), this._color = new n.Color, this.__buffH = document.createElement("canvas"), this.__buffH.width = 200, this.__buffH.height = 200, this.__buffSB = document.createElement("canvas"), this.__buffSB.width = 100, this.__buffSB.height = 100, this.__buffSBmask = document.createElement("canvas"), this.__buffSBmask.width = 100, this.__buffSBmask.height = 100, this.$super(t), this._updateH(), this._updateSB(), this._updateSBmask(), this._updateCanvas(), this._updateProperties(["color"]), this.__mouseManager = new n.MouseManager(this.__html.canvas), this.__mouseManager.registerCallback("click", "mouse-move", this.__onMouseMove.bind(this)), this.__mouseManager.registerCallback("mouse-down", "mouse-down", this.__onMouseDown.bind(this)), this.__mouseManager.registerCallback("drag-start", "drag-start", this.__onDragStart.bind(this))
        },getValue: function() {
            return this.color.hexString
        },setValue: function(t) {
            this.color.hexString = t, this._updateSB(), this._updateCanvas()
        },_color: null,getColor: function() {
            return this._color
        },setColor: function(t) {
            t instanceof n.Color && (this._color && this._color.removeCallback("photonui.colorpicker.value-changed::" + this.name), this._color = t, this._color.registerCallback("photonui.colorpicker.value-changed::" + this.name, "value-changed", function() {
                this._updateSB(), this._updateCanvas()
            }.bind(this)), this._updateSB(), this._updateCanvas())
        },getHtml: function() {
            return this.__html.outer
        },__buffH: null,__buffSB: null,__mouseManager: null,__disableSBUpdate: !1,destroy: function() {
            this.__mouseManager.destroy(), this._color.removeCallback("photonui.colorpicker.value-changed::" + this.name), this.$super()
        },_buildHtml: function() {
            this.__html.outer = document.createElement("div"), this.__html.outer.className = "photonui-widget photonui-colorpicker", this.__html.canvas = document.createElement("canvas"), this.__html.canvas.width = 200, this.__html.canvas.height = 200, this.__html.outer.appendChild(this.__html.canvas), this.__html.previewOuter = document.createElement("span"), this.__html.previewOuter.className = "photonui-colorpicker-previewouter", this.__html.outer.appendChild(this.__html.previewOuter), this.__html.preview = document.createElement("span"), this.__html.preview.className = "photonui-colorpicker-preview", this.__html.previewOuter.appendChild(this.__html.preview)
        },_updateH: function() {
            var t = this.__buffH, e = t.getContext("2d"), i = new n.Color;
            e.clearRect(0, 0, t.width, t.height);
            for (var o = 0; 360 > o; o++)
                i.hue = 360 - o, e.beginPath(), e.fillStyle = i.hexString, e.arc(100, 100, 90, Math.PI * o / 180, Math.PI * ((o + 2) % 360) / 180, !1), e.lineTo(100, 100), e.fill();
            e.beginPath(), e.fillStyle = "#000", e.arc(100, 100, 73, 2 * Math.PI, !1), e.globalCompositeOperation = "destination-out", e.fill()
        },_updateSBmask: function() {
            var t = this.__buffSBmask, e = t.getContext("2d"), n = e.getImageData(0, 0, t.width, t.height), i = 0, o = 0, r = 0, s = 0;
            for (r = 0; 100 > r; r++)
                for (s = 0; 100 > s; s++)
                    i = 400 * r + 4 * s, o = (.5 * (1 - s / 100) + .5) * (1 - r / 100) * 255 << 0, n.data[i + 0] = o, n.data[i + 1] = o, n.data[i + 2] = o, n.data[i + 3] = 255 * (1 - s / 100 * (1 - r / 100)) << 0;
            e.putImageData(n, 0, 0)
        },_updateSB: function() {
            if (!this.__disableSBUpdate) {
                var t = this.__buffSB, e = t.getContext("2d"), i = new n.Color({hue: this.color.hue,saturation: 100,brightness: 100});
                e.save(), e.clearRect(0, 0, t.width, t.height), e.fillStyle = i.hexString, e.rect(0, 0, t.width, t.height), e.fill(), e.drawImage(this.__buffSBmask, 0, 0), e.restore()
            }
        },_updateCanvas: function() {
            var t = this.__html.canvas, e = t.getContext("2d");
            e.save(), e.clearRect(0, 0, t.width, t.height), e.drawImage(this.__buffH, 0, 0), e.drawImage(this.__buffSB, 50, 50), e.strokeStyle = "#fff", e.shadowColor = "rgba(0, 0, 0, .7)", e.shadowBlur = 3, e.lineWidth = 2, e.beginPath(), e.arc(this.color.saturation + 50, 100 - this.color.brightness + 50, 6, 2 * Math.PI, !1), e.stroke(), e.translate(100, 100), e.rotate(-this.color.hue * Math.PI / 180), e.beginPath(), e.arc(81, 0, 6, 2 * Math.PI, !1), e.stroke(), e.restore(), this.__html.preview.style.backgroundColor = this.color.rgbaString
        },_pointerOnSquare: function(t) {
            return t.x >= 50 && t.x <= 150 && t.y >= 50 && t.y <= 150
        },_pointerOnCircle: function(t) {
            var e = Math.abs(100 - t.x), n = Math.abs(100 - t.y), i = Math.sqrt(e * e + n * n);
            return i >= 74 && 90 >= i
        },_pointerAngle: function(t) {
            var e = Math.abs(100 - t.x), n = Math.abs(100 - t.y), i = 180 * Math.atan(n / e) / Math.PI;
            return t.x < 100 && t.y < 100 ? i = 180 - i : t.x < 100 && t.y >= 100 ? i += 180 : t.x >= 100 && t.y > 100 && (i = 360 - i), 0 | i
        },__onMouseMove: function(t, e) {
            this.__html.canvas.style.cursor = this._pointerOnSquare(e) || this._pointerOnCircle(e) ? "crosshair" : "default"
        },__onMouseDown: function(t, e) {
            this._pointerOnSquare(e) ? (this.__disableSBUpdate = !0, this.color.saturation = e.x - 50, this.color.brightness = 150 - e.y, this.__disableSBUpdate = !1, this._callCallbacks("value-changed", this.value)) : this._pointerOnCircle(e) && (this.color.hue = this._pointerAngle(e), this._callCallbacks("value-changed", this.value))
        },__onDragStart: function(t, e) {
            this._pointerOnSquare(e) ? (this.__disableSBUpdate = !0, this.__mouseManager.registerCallback("dragging", "dragging", this.__onDraggingSquare.bind(this)), this.__mouseManager.registerCallback("drag-end", "drag-end", this.__onDragEnd.bind(this))) : this._pointerOnCircle(e) && (this.__mouseManager.registerCallback("dragging", "dragging", this.__onDraggingCircle.bind(this)), this.__mouseManager.registerCallback("drag-end", "drag-end", this.__onDragEnd.bind(this)))
        },__onDraggingSquare: function(t, e) {
            this.color.saturation = e.x - 50, this.color.brightness = 150 - e.y, this._callCallbacks("value-changed", this.value)
        },__onDraggingCircle: function(t, e) {
            this.color.hue = this._pointerAngle(e), this._callCallbacks("value-changed", this.value)
        },__onDragEnd: function() {
            this.__mouseManager.removeCallback("dragging"), this.__mouseManager.removeCallback("drag-end"), this.__disableSBUpdate = !1
        }});
    var n = n || {};
    n.BoxLayout = n.GridLayout.$extend({__init__: function(t) {
            this.$super(t), this._updateProperties(["orientation"])
        },_orientation: "vertical",getOrientation: function() {
            return this._orientation
        },setOrientation: function(t) {
            if ("vertical" != t && "horizontal" != t)
                throw 'Error: The orientation should be "vertical" or "horizontal".';
            this._orientation = t, this.removeClass("photonui-layout-orientation-vertical"), this.removeClass("photonui-layout-orientation-horizontal"), this.addClass("photonui-layout-orientation-" + this.orientation), this._updateLayout()
        },_buildHtml: function() {
            this.$super(), this.__html.outerbox.className = "photonui-widget photonui-boxlayout"
        },_updateLayout: function() {
            n.Helpers.cleanNode(this.__html.gridBody);
            var t = null;
            "horizontal" == this.getOrientation() && (t = document.createElement("tr"), this.__html.gridBody.appendChild(t));
            for (var i = this.children, o = 0; o < i.length; o++) {
                "vertical" == this.getOrientation() && (t = document.createElement("tr"), this.__html.gridBody.appendChild(t));
                var r = document.createElement("td");
                r.className = "photonui-container photonui-boxlayout-cell", t.appendChild(r), (i[o].layoutOptions.horizontalExpansion == e || i[o].layoutOptions.horizontalExpansion) && (r.className += " photonui-container-expand-child-horizontal"), (i[o].layoutOptions.verticalExpansion == e || i[o].layoutOptions.verticalExpansion) && (r.className += " photonui-container-expand-child-vertical"), i[o].layoutOptions.width != e && (r.style.height = i[o].layoutOptions.width + "px"), i[o].layoutOptions.height != e && (r.style.height = i[o].layoutOptions.height + "px"), i[o].layoutOptions.minWidth != e && (r.style.minWidth = this.childrenWidgets[o].layoutOptions.minWidth + "px"), i[o].layoutOptions.minHeight != e && (r.style.minHeight = this.childrenWidgets[o].layoutOptions.minHeight + "px"), i[o].layoutOptions.maxWidth != e && (r.style.maxWidth = this.childrenWidgets[o].layoutOptions.maxWidth + "px"), i[o].layoutOptions.maxHeight != e && (r.style.maxHeight = this.childrenWidgets[o].layoutOptions.maxHeight + "px"), i[o].layoutOptions.horizontalAlign != e && (r.style.textAlign = this.childrenWidgets[o].layoutOptions.horizontalAlign, console.log("hhhh")), r.appendChild(i[o].html)
            }
        }});
    var n = n || {};
    n.Menu = n.Layout.$extend({__init__: function(t) {
            this.$super(t), this._updateProperties(["iconVisible"])
        },_iconVisible: !0,isIconVisible: function() {
            return this._iconVisible
        },setIconVisible: function(t) {
            this._iconVisible = t, t ? this.removeClass("photonui-menu-noicon") : this.addClass("photonui-menu-noicon")
        },getHtml: function() {
            return this.__html.outer
        },_buildHtml: function() {
            this.__html.outer = document.createElement("div"), this.__html.outer.className = "photonui-widget photonui-menu photonui-menu-style-default"
        },_updateLayout: function() {
            n.Helpers.cleanNode(this.__html.outer);
            for (var t = this.children, e = 0; e < t.length; e++)
                this.__html.outer.appendChild(t[e].html)
        }});
    var n = n || {};
    n.MenuItem = n.Container.$extend({__init__: function(t) {
            this._registerWEvents(["click"]), this.$super(t), this._updateProperties(["text", "icon", "active"]), this._bindEvent("click", this.__html.outer, "click", function(t) {
                this._callCallbacks("click", [t])
            }.bind(this))
        },_value: "",getValue: function() {
            return this._value
        },setValue: function(t) {
            this._value = t
        },_text: "Menu Item",getText: function() {
            return this._text
        },setText: function(t) {
            this._text = t, n.Helpers.cleanNode(this.__html.text), this.__html.text.appendChild(document.createTextNode(t))
        },_iconName: null,getIconName: function() {
            return this._iconName
        },setIconName: function(t) {
            this._iconName = t, n.Helpers.cleanNode(this.__html.icon), this._iconName && this.__html.icon.appendChild(this.icon.html)
        },getIcon: function() {
            return n.getWidget(this._iconName)
        },setIcon: function(t) {
            return t instanceof n.BaseIcon ? void (this.iconName = t.name) : void (this.iconName = null)
        },_active: !1,getActive: function() {
            return this._active
        },setActive: function(t) {
            this._active = t, t ? this.addClass("photonui-menuitem-active") : this.removeClass("photonui-menuitem-active")
        },getHtml: function() {
            return this.__html.outer
        },getContainerNode: function() {
            return this.__html.widget
        },_buildHtml: function() {
            this.__html.outer = document.createElement("div"), this.__html.outer.className = "photonui-widget photonui-menuitem", this.__html.icon = document.createElement("span"), this.__html.icon.className = "photonui-menuitem-icon", this.__html.outer.appendChild(this.__html.icon), this.__html.text = document.createElement("span"), this.__html.text.className = "photonui-menuitem-text", this.__html.outer.appendChild(this.__html.text), this.__html.widget = document.createElement("span"), this.__html.widget.className = "photonui-menuitem-widget", this.__html.outer.appendChild(this.__html.widget)
        }});
    var n = n || {};
    n.SubMenuItem = n.MenuItem.$extend({__init__: function(t) {
            this.$super(t), this.addClass("photonui-submenuitem"), this.registerCallback("toggle-folding", "click", this.__onItemClicked, this), this._updateProperties(["menuName"])
        },_menuName: null,getMenuName: function() {
            return this._menuName
        },setMenuName: function(t) {
            this.menuName && (this.menu.removeCallback("fold"), this.menu.removeCallback("unfold")), this._menuName = t, this.menuName && (this.menu.registerCallback("fold", "hide", this.__onToggleFold, this), this.menu.registerCallback("unfold", "show", this.__onToggleFold, this), this.active = this.menu.visible)
        },getMenu: function() {
            return n.getWidget(this.menuName)
        },setMenu: function(t) {
            this.menuName = t instanceof n.Menu ? t.name : null
        },__onToggleFold: function(t) {
            this.active = t.visible
        },__onItemClicked: function() {
            this.menu.visible = !this.menu.visible
        }});
    var n = n || {};
    n.ToggleButton = n.CheckBox.$extend({__init__: function(t) {
            this._registerWEvents(["click"]), this.$super(t), this.__buttonInit(), this.removeClass("photonui-checkbox"), this.addClass("photonui-togglebutton")
        },__buttonInit: function() {
            this._bindEvent("click", this.__html.button, "click", this.__onButtonClicked.bind(this)), this._updateProperties(["text", "leftIconName", "rightIconName"]), this._update()
        },__include__: [s],_buildHtml: function() {
            this.$super(), this._buildButtonHtml(), this.__html.outer.appendChild(this.__html.button), this.__html.outer.removeChild(this.__html.span), this.__html.span = this.__html.button
        }});
    var n = n || {};
    n.PopupMenu = n.PopupWindow.$extend({__init__: function(t) {
            this._childrenNames = [], this.$super(t)
        },__include__: [{getChildrenNames: n.Menu.prototype.getChildrenNames,setChildrenNames: n.Menu.prototype.setChildrenNames,getChildren: n.Menu.prototype.getChildren,setChildren: n.Menu.prototype.setChildren,getChildName: n.Menu.prototype.getChildName,setChildName: n.Menu.prototype.setChildName,getChild: n.Menu.prototype.getChild,setChild: n.Menu.prototype.setChild,isIconVisible: n.Menu.prototype.isIconVisible,setIconVisible: n.Menu.prototype.setIconVisible,addChild: n.Menu.prototype.addChild,removeChild: n.Menu.prototype.removeChild,destroy: n.Menu.prototype.destroy,_updateLayout: n.Menu.prototype._updateLayout}],_buildHtml: function() {
            this.$super(), n.Menu.prototype._buildHtml.call(this), this.__html.inner.appendChild(this.__html.outer), this.__html.window.className += " photonui-popupmenu", this.__html.outer.className = "photonui-widget photonui-menu photonui-menu-style-popupmenu"
        },__onLocaleChanged: function() {
        }});
    var n = n || {};
    n.ColorButton = n.Button.$extend({__init__: function(t) {
            this._color = new n.Color(n.palette[0][0]), this._registerWEvents(["value-changed"]), this.$super(t), this.popup = new n.PopupWindow, this.palette = new n.ColorPalette, this.palette.registerCallback("value-changed", "value-changed", this.__onPaletteValueChanged, this), this.popup.child = this.palette, this._updateProperties(["value"])
        },getValue: function() {
            return this.color.hexString
        },setValue: function(t) {
            this.color.hexString = t, this.__html.color.style.backgroundColor = this.color.hexString
        },_color: null,getColor: function() {
            return this._color
        },setColor: function(t) {
            t instanceof n.Color && (this._color = t)
        },_update: function() {
        },_buildHtml: function() {
            this.$super(), this.__html.button = document.createElement("button"), this.__html.button.className = "photonui-widget photonui-button", this.__html.button.className += " photonui-colorbutton", this.__html.color = document.createElement("span"), this.__html.button.appendChild(this.__html.color)
        },__onButtonClicked: function(t) {
            this._callCallbacks("click", [t]), this.popup.popupWidget(this)
        },__onPaletteValueChanged: function(t, e) {
            this.value = e, this._callCallbacks("value-changed", [e])
        }});
    var n = n || {};
    n.Select = n.Widget.$extend({__init__: function(t) {
            this.__popupMenu = new n.PopupMenu({maxHeight: 300,className: "photonui-select-popup"}), this.__popupMenu.iconVisible = !1, this._registerWEvents(["value-changed"]), this.$super(t), this._updateProperties(["value"]), this._bindEvent("popup", this.html, "click", this.__onClick.bind(this)), this.setValue(t.value || this.value, !0)
        },_value: "",getValue: function() {
            return this._value
        },setValue: function(t, e) {
            if (this.value != t || e) {
                for (var i = this.__popupMenu.children, o = 0; o < i.length; o++)
                    if (i[o] instanceof n.MenuItem && i[o].value == t)
                        return this._value = t, n.Helpers.cleanNode(this.__html.select), void this.__html.select.appendChild(i[o].html.cloneNode(!0));
                this._value = "";
                var r = new n.MenuItem({text: this.placeholder,className: "photonui-select-placeholder"});
                n.Helpers.cleanNode(this.__html.select), this.__html.select.appendChild(r.html)
            }
        },_placeholder: t.Stone ? t.Stone.lazyGettext("Select...") : "Select...",getPlaceholder: function() {
            return this._placeholder
        },setPlaceholder: function(t) {
            this._placeholder = t
        },getChildren: function() {
            return this.__popupMenu.getChildren()
        },setChildren: function(t) {
            this.__popupMenu.setChildren(t), this._updateItemsBinding()
        },getChildrenNames: function() {
            return this.__popupMenu.getChildrenNames()
        },setChildrenNames: function(t) {
            this.__popupMenu.setChildrenNames(t), this._updateItemsBinding()
        },getPopupWidth: function() {
            return this.__popupMenu.getWidth()
        },setPopupWidth: function(t) {
            this.__popupMenu.setWidth(t)
        },getPopupHeight: function() {
            return this.__popupMenu.getHeight()
        },setPopupHeight: function(t) {
            this.__popupMenu.setHeight(t)
        },getPopupMaxWidth: function() {
            return this.__popupMenu.getMaxWidth()
        },setPopupMaxWidth: function(t) {
            this.__popupMenu.setMaxWidth(t)
        },getPopupMinWidth: function() {
            return this.__popupMenu.getMinWidth()
        },setPopupMinWidth: function(t) {
            this.__popupMenu.setMinWidth(t)
        },getPopupMaxHeight: function() {
            return this.__popupMenu.getMaxHeight()
        },setPopupMaxHeight: function(t) {
            this.__popupMenu.setMaxHeight(t)
        },getPopupMinHeight: function() {
            return this.__popupMenu.getMinHeight()
        },setPopupMinHeight: function(t) {
            this.__popupMenu.setMinHeight(t)
        },getPopupOffsetWidth: function() {
            return this.__popupMenu.getOffsetWidth()
        },getPopupOffsetHeight: function() {
            return this.__popupMenu.getOffsetHeight()
        },getPopupPadding: function() {
            return this.__popupMenu.getPadding()
        },setPopupPadding: function(t) {
            this.__popupMenu.setPadding(t)
        },isIconVisible: function() {
            return this.__popupMenu.isIconVisible()
        },setIconVisible: function(t) {
            this.__popupMenu.setIconVisible(t)
        },getHtml: function() {
            return this.__html.select
        },__popupMenu: null,addChild: function(t, e) {
            this.__popupMenu.addChild(t, e), this._updateItemsBinding()
        },destroy: function() {
            this.__popupMenu.destroy(), this.$super()
        },_buildHtml: function() {
            this.__html.select = document.createElement("div"), this.__html.select.className = "photonui-widget photonui-select", this.__html.select.tabIndex = "0"
        },_updateItemsBinding: function() {
            for (var t = this.__popupMenu.children, e = 0; e < t.length; e++)
                t[e] instanceof n.MenuItem && t[e].registerCallback(this.name + "-click", "click", this.__onItemClicked, this)
        },__onClick: function() {
            this.__popupMenu.popupWidget(this)
        },__onItemClicked: function(t) {
            this.value = t.value, this._callCallbacks("value-changed", [this.value])
        }});
    var n = n || {};
    n.FontSelect = n.Select.$extend({__init__: function(t) {
            this._fonts = [], this.$super(t), 0 == this.fonts.length && (this.fonts = ["sans-serif", "serif", "monospace"])
        },_fonts: null,getFonts: function() {
            return this._fonts
        },setFonts: function(t) {
            this._fonts = [];
            for (var e = 0; e < t.length; e++)
                this.addFont(t[e])
        },_value: "sans-serif",_placeholder: t.Stone ? t.Stone.lazyGettext("Select a font...") : "Select a font...",addFont: function(t) {
            var e = new n.MenuItem({value: t,text: t});
            e.html.style.fontFamily = t, this.addChild(e), this._fonts.push(t)
        }});
    var n = n || {};
    return n.ColorPickerDialog = n.Dialog.$extend({__init__: function(t) {
            this.__widgets = {}, this._color = new n.Color;
            var t = t || {};
            t.title == e && (t.title = _("Select a color...")), this.$super(t), this._buildUi(), this._updateProperties(["color"])
        },_color: null,getColor: function() {
            return this._color
        },setColor: function(t) {
            t instanceof n.Color && (this._color && this._color.removeCallback("photonui.colorpickerdialog.value-changed::" + this.name), this._color = t, this._color.registerCallback("photonui.colorpickerdialog.value-changed::" + this.name, "value-changed", this.__onColorChanged, this)), this.__onColorChanged()
        },destroy: function() {
            this._color.removeCallback("photonui.colorpickerdialog.value-changed::" + this.name), this.$super()
        },_buildUi: function() {
            this.__widgets.hbox = new n.BoxLayout({orientation: "horizontal"}), this.child = this.__widgets.hbox, this.__widgets.colorPicker = new n.ColorPicker, this.__widgets.hbox.addChild(this.__widgets.colorPicker), this.__widgets.colorPalette = new n.ColorPalette, this.__widgets.hbox.addChild(this.__widgets.colorPalette), this.__widgets.separator = new n.Separator({orientation: "vertical"}), this.__widgets.hbox.addChild(this.__widgets.separator), this.__widgets.grid = new n.GridLayout, this.__widgets.hbox.addChild(this.__widgets.grid), this.__widgets.fieldRed = new n.Slider({min: 0,max: 255,decimalDigit: 0}), this.__widgets.labelRed = new n.Label({text: _("Red:"),forInput: this.__widgets.fieldRed}), this.__widgets.grid.addChild(this.__widgets.labelRed, {gridX: 0,gridY: 0,verticalExpansion: !1}), this.__widgets.grid.addChild(this.__widgets.fieldRed, {gridX: 1,gridY: 0,verticalExpansion: !1}), this.__widgets.fieldGreen = new n.Slider({min: 0,max: 255,decimalDigit: 0}), this.__widgets.labelGreen = new n.Label({text: _("Green:"),forInput: this.__widgets.fieldGreen}), this.__widgets.grid.addChild(this.__widgets.labelGreen, {gridX: 0,gridY: 1,verticalExpansion: !1}), this.__widgets.grid.addChild(this.__widgets.fieldGreen, {gridX: 1,gridY: 1,verticalExpansion: !1}), this.__widgets.fieldBlue = new n.Slider({min: 0,max: 255,decimalDigit: 0}), this.__widgets.labelBlue = new n.Label({text: _("Blue:"),forInput: this.__widgets.fieldBlue}), this.__widgets.grid.addChild(this.__widgets.labelBlue, {gridX: 0,gridY: 2,verticalExpansion: !1}), this.__widgets.grid.addChild(this.__widgets.fieldBlue, {gridX: 1,gridY: 2,verticalExpansion: !1}), this.__widgets.separator2 = new n.Separator, this.__widgets.grid.addChild(this.__widgets.separator2, {gridX: 0,gridY: 3,verticalExpansion: !1,gridWidth: 2}), this.__widgets.fieldHue = new n.Slider({min: 0,max: 360,decimalDigit: 0}), this.__widgets.labelHue = new n.Label({text: _("Hue:"),forInput: this.__widgets.fieldHue}), this.__widgets.grid.addChild(this.__widgets.labelHue, {gridX: 0,gridY: 4,verticalExpansion: !1}), this.__widgets.grid.addChild(this.__widgets.fieldHue, {gridX: 1,gridY: 4,verticalExpansion: !1}), this.__widgets.fieldSaturation = new n.Slider({min: 0,max: 100,decimalDigit: 0}), this.__widgets.labelSaturation = new n.Label({text: _("Saturation:"),forInput: this.__widgets.fieldSaturation}), this.__widgets.grid.addChild(this.__widgets.labelSaturation, {gridX: 0,gridY: 5,verticalExpansion: !1}), this.__widgets.grid.addChild(this.__widgets.fieldSaturation, {gridX: 1,gridY: 5,verticalExpansion: !1}), this.__widgets.fieldBrightness = new n.Slider({min: 0,max: 100,decimalDigit: 0}), this.__widgets.labelBrightness = new n.Label({text: _("Brightness:"),forInput: this.__widgets.fieldBrightness}), this.__widgets.grid.addChild(this.__widgets.labelBrightness, {gridX: 0,gridY: 6,verticalExpansion: !1}), this.__widgets.grid.addChild(this.__widgets.fieldBrightness, {gridX: 1,gridY: 6,verticalExpansion: !1}), this.__widgets.buttonOk = new n.Button({text: _("Ok")}), n.FAIcon && (this.__widgets.buttonOk.leftIcon = new n.FAIcon("fa-check")), this.__widgets.buttonCancel = new n.Button({text: _("Cancel")}), this.buttons = [this.__widgets.buttonOk, this.__widgets.buttonCancel], n.FAIcon && (this.__widgets.buttonCancel.leftIcon = new n.FAIcon("fa-times")), this.__widgets.colorPalette.color = this.__widgets.colorPicker.color, this.__widgets.colorPicker.color.registerCallback("colorpickerdialog.colorPicker.value-changed", "value-changed", function(t) {
                this.__widgets.fieldRed.value = t.red, this.__widgets.fieldGreen.value = t.green, this.__widgets.fieldBlue.value = t.blue, this.__widgets.fieldHue.value = t.hue, this.__widgets.fieldSaturation.value = t.saturation, this.__widgets.fieldBrightness.value = t.brightness
            }, this), this.__widgets.fieldRed.registerCallback("colorpickerdialog.fieldRed.value-changed", "value-changed", function(t, e) {
                this.__widgets.colorPicker.color.red = e
            }, this), this.__widgets.fieldGreen.registerCallback("colorpickerdialog.fieldGreen.value-changed", "value-changed", function(t, e) {
                this.__widgets.colorPicker.color.green = e
            }, this), this.__widgets.fieldBlue.registerCallback("colorpickerdialog.fieldBlue.value-changed", "value-changed", function(t, e) {
                this.__widgets.colorPicker.color.blue = e
            }, this), this.__widgets.fieldHue.registerCallback("colorpickerdialog.fieldHue.value-changed", "value-changed", function(t, e) {
                this.__widgets.colorPicker.color.hue = e
            }, this), this.__widgets.fieldSaturation.registerCallback("colorpickerdialog.fieldSaturation.value-changed", "value-changed", function(t, e) {
                this.__widgets.colorPicker.color.saturation = e
            }, this), this.__widgets.fieldBrightness.registerCallback("colorpickerdialog.fieldBrightness.value-changed", "value-changed", function(t, e) {
                this.__widgets.colorPicker.color.brightness = e
            }, this), this.__widgets.buttonOk.registerCallback("colorpickerdialog.buttonOk.click", "click", this.__onValidate, this), this.__widgets.buttonCancel.registerCallback("colorpickerdialog.buttonCancel.click", "click", this.__onCancel, this), this.registerCallback("colorpickerdialog.close", "close-button-clicked", this.__onCancel, this)
        },__onCancel: function() {
            this.__widgets.colorPicker.color.setHSB(this._color.hue, this._color.saturation, this._color.brightness), this.hide()
        },__onValidate: function() {
            this._color.setHSB(this.__widgets.colorPicker.color.hue, this.__widgets.colorPicker.color.saturation, this.__widgets.colorPicker.color.brightness), this.hide()
        },__onColorChanged: function() {
            this.__widgets.colorPicker.color.setHSB(this._color.hue, this._color.saturation, this._color.brightness)
        }}), n
}(window), GeometryHelper = new function() {
    this.createHandle = function(t, e, n, i, o) {
        {
            var r, i = i || {};
            i.hinge || 1
        }
        if (1 == t) {
            var s = e, a = n, l = BABYLON.Mesh.CreateBloc("handle", a, a, 4, o);
            l.position.y = s / 2 - (i.offset >= 0 ? i.offset : 2);
            var h = BABYLON.Mesh.CreateBloc("handle", a, s, a, o);
            h.position.z = 2;
            var c = BABYLON.Mesh.CreateBloc("handle", a, a, 4, o);
            c.position.y = -s / 2 + (i.offset >= 0 ? i.offset : 2), r = BABYLON.Mesh.mergeMeshesRec("handle", [l, h, c], o), r.position.z = 0, r.rotation.z = Math.PI / 2
        } else if (2 == t)
            r = BABYLON.Mesh.CreateBloc("handle", e, n, 3, o);
        else if (3 == t)
            r = BABYLON.Mesh.CreateBloc("handle", e, 1, n, o), r.rotation.x = Math.PI / 8;
        else if (4 == t)
            r = BABYLON.Mesh.CreateCylinder("handle", e, n, 3, 6, 1, !0, o), r.rotation.x = Math.PI / 2;
        else if (5 == t)
            r = this.createCurvedBarGeometry("handle", e, n, 1, 5, 10, o);
        else if (6 == t)
            i.offset = n / 2, r = this.createHandle(1, e, n, i, o);
        else if (7 == t) {
            i.offset = n / 2, r = this.createHandle(1, e, n, i, o);
            var u = BABYLON.Mesh.CreateBloc("handle_deco", n, e + 3, .3, o), p = BABYLON.Mesh.CreateBloc("handle_deco", n, e + 3, .3, o);
            u.position.x += n / 2, p.position.x -= n / 2, u.position.z = 2, u.rotation.y = -Math.PI / 10, p.rotation.y = Math.PI / 10, p.position.z = 2, u.parent = p.parent = r
        } else if (8 == t) {
            var s = e, a = n, l = BABYLON.Mesh.CreateBloc("handle", a, a, 4, o);
            l.position.y = s / 2 - (i.offset >= 0 ? i.offset : 2);
            var h = BABYLON.Mesh.CreateCylinder("handle", s, 2 * a, 2 * a, 10, 1, !0, o);
            h.position.z = 2;
            var c = BABYLON.Mesh.CreateCylinder("handle", a, a, 4, 6, 1, !0, o);
            c.position.y = -s / 2 + (i.offset >= 0 ? i.offset : 2);
            var c = BABYLON.Mesh.CreateBloc("handle", a, a, 4, o);
            c.position.y = -s / 2 + (i.offset >= 0 ? i.offset : 2), r = BABYLON.Mesh.mergeMeshesRec("handle", [l, h, c], o), r.position.z = 0, r.rotation.z = Math.PI / 2
        } else
            r = BABYLON.Mesh.CreateBloc("handle", 3, 3, 3, o);
        return r
    }, this.createPoignee = function(t, e, n, i, o) {
        var i = i || {}, r = (i.hinge || 1, null);
        if (1 == t) {
            var s = e - 10, a = 1, l = BABYLON.Mesh.CreateBloc("handle", a, a, 4, o);
            l.position.y = s / 2 - 2;
            var h = BABYLON.Mesh.CreateBloc("handle", a, s, a, o);
            h.position.z = 3;
            var c = BABYLON.Mesh.CreateBloc("handle", a, a, 4, o);
            c.position.y = -s / 2 + 2, r = BABYLON.Mesh.mergeMeshesRec("handle", [l, h, c], o), r.position.z = 0, r.rotation.z = Math.PI / 2
        } else
            2 == t ? r = BABYLON.Mesh.CreateBloc("handle", 3, 3, 3, o) : 3 == t ? r = BABYLON.Mesh.CreateBloc("handle", e - 10, 1, 5, o) : 4 == t ? (r = BABYLON.Mesh.CreateCylinder("handle", 3, 3, 3, 8, 1, !0, o), r.rotation.x = Math.PI / 2) : 5 == t ? (r = this.createPoignee(1, 25, null, null, o), r.position.y += n / 2 - 10) : 6 == t && (r = this.createPoignee(1, 25, null, null, o), r.position.y += n / 2 - 10);
        return r
    }, this.createTiroir = function(t, e, n, i, o, r, s) {
        var r = r || {};
        r.stretched_texture = r.stretched_texture || 0;
        var a = 3, l = r.rounded && (+r.configuration[3] || +r.configuration[0]) ? r.radius : a, h = [], c = BABYLON.Mesh.CreateBloc("back", t - a, n / 2, a, s);
        c.position.z = -e / 2, c.position.y = -n / 4 + l, h.push(c);
        var u = BABYLON.Mesh.CreateBloc("left", a, n / 2, e, s);
        u.position.x = -t / 2 + a, u.position.y = -n / 4 + l, h.push(u);
        var p = BABYLON.Mesh.CreateBloc("right", a, n / 2, e, s);
        if (p.position.x = t / 2 - a, p.position.y = -n / 4 + l, h.push(p), r.rounded) {
            var d = this.createRoundedPane(t, n, i, r.radius, null, r.configuration, s);
            d.name = "front", d.position.z = i / 2
        } else {
            var d = BABYLON.Mesh.CreateBloc("front", t, n, i, s);
            0 !== r.stretched_texture && this.setStretchUV(d)
        }
        d.position.z += e / 2, h.push(d);
        var m = BABYLON.Mesh.CreateBloc("bottom", t - 2 * a, a, e, s);
        m.position.y -= n / 2 - l, h.push(m);
        var g = BABYLON.Mesh.mergeMeshesRec("tiroir", h, s);
        if (-1 !== +r.handle_position) {
            var o = o.toString(), f = r.handle_position.split(",")[0] || 0, y = r.handle_position.split(",")[1] || 0, _ = r.handle_position.split(",")[2] || 0;
            _ = _ / 180 * Math.PI;
            var o = o.toString() || o, v = o.split(",")[0] || 0, b = o.split(",")[1] || t - 10, w = o.split(",")[2] || 1;
            b = this.calcMeasure(b, t, n), w = this.calcMeasure(w, t, n), f = this.calcMeasure(f, t, n), y = this.calcMeasure(y, t, n);
            var x = this.createHandle(v, b, w, {hinge: 1}, s);
            x.position.x = f, x.position.y = y, x.position.z += e / 2 + i / 2, x.rotation.z += _, x.parent = g
        } else {
            var x = this.createPoignee(o, t, n, {hinge: -1}, s);
            x && (x.position.z += e / 2 + i / 2, x.position.y = n / 2 - 5, 3 == o && (x.rotation.x = Math.PI / 8), 5 == o && (x.rotation.z = Math.PI / 2), x.parent = g)
        }
        return 0 == r.stretched_texture && GeometryHelper.giftWraper(g), g
    }, this.calcMeasure = function(measure, w, h) {
        var reg = new RegExp("[^wh0-9?:<>()\\-\\+*/]");
        return reg.test(measure) === !1 ? eval(measure) : measure
    }, this.setStretchUV = function(t) {
        var e = [];
        e.push(1, 0), e.push(0, 0), e.push(0, 1), e.push(1, 1), e.push(1, 1), e.push(0, 1), e.push(0, 0), e.push(1, 0), e.push(1, 0), e.push(0, 0), e.push(0, 0), e.push(1, 0), e.push(1, 0), e.push(0, 0), e.push(0, 0), e.push(1, 0), e.push(1, 0), e.push(0, 0), e.push(0, 0), e.push(1, 0), e.push(1, 0), e.push(0, 0), e.push(0, 0), e.push(1, 0), t.setVerticesData(BABYLON.VertexBuffer.UVKind, e)
    }, this.createSimplePorte = function(t, e, n, i, o, r, s) {
        var n = n || 3, a = new BABYLON.Mesh("door", s);
        a.isVisible = !1;
        var r = r || {};
        if (r.stretched_texture = r.stretched_texture || 0, r.handle_position = r.handle_position || -1, r.rounded) {
            var l = this.createRoundedPane(t, e, n, r.radius, null, r.configuration, s);
            l.name = "casement", l.position.z = n / 2
        } else {
            var l = BABYLON.Mesh.CreateBloc("casement", t, e, n, s);
            0 !== r.stretched_texture && this.setStretchUV(l)
        }
        if (l.parent = a, 1 == i || -1 == i)
            a.setPivotMatrix(BABYLON.Matrix.Translation(i * t / 2, 0, n / 2)), a.position.x = -i * t / 2;
        else {
            var h = -2 * -i + 5;
            a.setPivotMatrix(BABYLON.Matrix.Translation(0, h * e / 2, n / 2)), a.position.y = -h * e / 2
        }
        if (a.hinge = i, -1 !== +r.handle_position) {
            var c = r.handle_position.split(",")[0] || 0, u = r.handle_position.split(",")[1] || 0, p = r.handle_position.split(",")[2] || 0;
            p = p / 180 * Math.PI;
            var o = o.toString() || o, d = o.split(",")[0] || 0, m = o.split(",")[1] || t - 10, g = o.split(",")[2] || 1;
            m = this.calcMeasure(m, t, e), g = this.calcMeasure(g, t, e), c = this.calcMeasure(c, t, e), u = this.calcMeasure(u, t, e), c = -1 == i ? -c : c;
            var f = this.createHandle(d, m, g, {hinge: i}, s);
            f.position.x = c, f.position.y = u, f.position.z += n / 2, f.rotation.z += p, f.parent = a
        } else if (1 != i && -1 != i || 6 == o) {
            if (6 != o) {
                var h = -2 * -i + 5, f = this.createPoignee(o, t, t, {hinge: i}, s);
                f && (f.position.y = h * e / 3, f.position.z += n / 2, 3 == o && (f.rotation.x = h * Math.PI / 8), f.parent = a)
            } else if (6 == o) {
                var f = this.createPoignee(o, t, t, {hinge: i}, s);
                f.position.y = e / 3, f && (f.position.z += n / 2, f.parent = a)
            }
        } else {
            var f = this.createPoignee(o, e, e, {hinge: i}, s);
            f && (f.rotation.z += Math.PI / 2, f.position.x = i * t / 3, f.position.z += n / 2, 3 == o && (f.rotation.y = -i * Math.PI / 8), 4 == o && (f.rotation.z = 0), f.parent = a)
        }
        return 0 == r.stretched_texture && this.giftWraper(l, 128), a
    }, this.createCurvedBarGeometry = function(t, e, n, i, o, r, s) {
        var a = [], l = l || !1, h = [], c = [], u = [], r = r || 10, o = o, p = -i / 2, d = +i / 2, m = new BABYLON.Vector3(-e / 2, 0, p), g = new BABYLON.Vector3(e / 2, 0, p), f = new BABYLON.Vector3(0, 0, p + o);
        a.push(m.x, m.y, m.z), GeometryHelper.generateArc(a, r, m, f, g), a.push(g.x, g.y, g.z);
        var y = new BABYLON.Vector3(-e / 2, n, p), _ = new BABYLON.Vector3(e / 2, n, p), v = new BABYLON.Vector3(0, n, p + o);
        a.push(y.x, y.y, y.z), GeometryHelper.generateArc(a, r, y, v, _), a.push(_.x, _.y, _.z);
        var y = new BABYLON.Vector3(-e / 2, n, d), _ = new BABYLON.Vector3(e / 2, n, d), v = new BABYLON.Vector3(0, n, d + o);
        a.push(y.x, y.y, y.z), GeometryHelper.generateArc(a, r, y, v, _), a.push(_.x, _.y, _.z);
        var m = new BABYLON.Vector3(-e / 2, 0, d), g = new BABYLON.Vector3(e / 2, 0, d), f = new BABYLON.Vector3(0, 0, d + o);
        a.push(m.x, m.y, m.z), GeometryHelper.generateArc(a, r, m, f, g), a.push(g.x, g.y, g.z);
        for (var b = r + 1, w = 0, x = 4, C = 0; x - 1 > C; C++) {
            w = C * b;
            for (var M = 0; b - 1 > M; M++)
                h.push(w + M, w + M + 1, w + b + M + 1), h.push(w + b + M + 1, w + b + M, w + M)
        }
        var D = new BABYLON.Mesh(t, s);
        return BABYLON.VertexData.ComputeNormals(a, h, c), u = BABYLON.Tools.PlaneUVProjection(a, new BABYLON.Vector3(1, 0, 0), new BABYLON.Vector3(0, 1, 0), 0), D.setVerticesData(BABYLON.VertexBuffer.PositionKind, a, l), D.setVerticesData(BABYLON.VertexBuffer.NormalKind, c, l), D.setVerticesData(BABYLON.VertexBuffer.UVKind, u, l), D.setIndices(h), D
    }, this.createDoublePorte = function(t, e, n, i, o, r) {
        var s = new BABYLON.Mesh("dblPorte", r);
        s.isVisible = !1;
        var n = n || 3, o = o || {};
        if (o.rounded) {
            var a = ujs.cloneObject(o), l = ujs.cloneObject(o);
            a.configuration[3] = 0, a.configuration[2] = 0, l.configuration[1] = 0, l.configuration[0] = 0;
            var h = this.createSimplePorte(t / 2, e, n, 1, i, a, r), c = this.createSimplePorte(t / 2, e, n, -1, i, l, r)
        } else
            var h = this.createSimplePorte(t / 2, e, n, 1, i, o, r), c = this.createSimplePorte(t / 2, e, n, -1, i, o, r);
        return h.position.x += -t / 4 - .1, h.hinge = 1, c.position.x += t / 4 + .1, c.hinge = -1, h.setPivotMatrix(BABYLON.Matrix.Translation(t / 4 + .1, 0, n / 2)), c.setPivotMatrix(BABYLON.Matrix.Translation(-t / 4 - .1, 0, n / 2)), h.parent = s, c.parent = s, s
    }, this.createRoundedCadreStrate = function(t, e, n, i, o, r, s) {
        var s = s || [1, 1, 1, 1], a = 1 == s[3] ? o : 1, l = 1 == s[2] ? o : 1, h = 1 == s[1] ? o : 1, c = 1 == s[0] ? o : 1, u = new BABYLON.Vector3(e / 2 - a, -n / 2, i), p = new BABYLON.Vector3(e / 2, -n / 2 + a, i), d = new BABYLON.Vector3(e / 2, n / 2 - l, i), m = new BABYLON.Vector3(e / 2 - l, n / 2, i), g = new BABYLON.Vector3(-e / 2 + h, n / 2, i), f = new BABYLON.Vector3(-e / 2, n / 2 - h, i), y = new BABYLON.Vector3(-e / 2, -n / 2 + c, i), _ = new BABYLON.Vector3(-e / 2 + c, -n / 2, i), v = new BABYLON.Vector3(e / 2, -n / 2, i), b = new BABYLON.Vector3(e / 2, n / 2, i), w = new BABYLON.Vector3(-e / 2, n / 2, i), x = new BABYLON.Vector3(-e / 2, -n / 2, i);
        return t.push(_.x, _.y, _.z), this.generateArc(t, r, _, x, y), t.push(y.x, y.y, y.z), t.push(f.x, f.y, f.z), this.generateArc(t, r, f, w, g), t.push(g.x, g.y, g.z), t.push(m.x, m.y, m.z), this.generateArc(t, r, m, b, d), t.push(d.x, d.y, d.z), t.push(p.x, p.y, p.z), this.generateArc(t, r, p, v, u), t.push(u.x, u.y, u.z), t
    }, this.triangulateStrate = function(t, e) {
        for (var n = [], i = t + 1; t + e - 1 > i; i++)
            n.push(i + 1, i, t);
        return n
    }, this.generateStrateFacesForGeometry = function(t, e, n, i, o, r, s, a) {
        for (var l = l || !1, h = [], c = [], u = [], s = s || [], i = i || !1, o = o || !1, p = e.length / (3 * n), d = 0, m = new BABYLON.Mesh(t, r), g = 0, f = e.slice(0, 3 * (n - 1)), y = this.triangulateStrate(0, n), _ = 0, v = 3; v < f.length; v += 3)
            _ += new BABYLON.Vector3(f[v], f[v + 1], f[v + 2]).distanceTo(new BABYLON.Vector3(f[v - 3], f[v - 2], f[v - 1]));
        _ += new BABYLON.Vector3(f[v - 3], f[v - 2], f[v - 1]).distanceTo(new BABYLON.Vector3(f[0], f[1], f[2]));
        {
            var b = BABYLON.BoundingBox.CreateFromData(e);
            b.maximum.z - b.minimum.z
        }
        if (i)
            for (var v = 0; v < y.length; v += 3)
                h.push(y[v], y[v + 1], y[v + 2]);
        for (var w, x, C, M, D, B, A = 0, E = [], T = !1, S = 0; p - 1 > S; S++) {
            d = S * n, g = h.length, A = 0, T = !1;
            for (var L = 0; L < s.length; L++)
                s[L] === S && (T = !0);
            for (var v = 0; n - 1 > v; v++) {
                w = d + v, x = d + 1 + v, C = d + n + v + 1, M = d + n + v + 1, D = d + n + v, B = d + v, h.push(w, x, C), h.push(M, D, B), T && E.push(w, x, C, M, D, B);
                var O = new BABYLON.Vector3(e[w], e[w + 1], e[w + 2]).distanceTo(new BABYLON.Vector3(e[x], e[x + 1], e[x + 2]));
                A += O
            }
            h.push(d + v, d, d + n), h.push(d + n, d + n + v, d + v), T && (E.push(d + v, d, d + n), E.push(d + n, d + n + v, d + v))
        }
        if (o)
            for (var P = e.length / 3 - n, I = (e.slice(3 * P, e.length), this.triangulateStrate(P, n)), v = 0; v < I.length; v += 3)
                a ? h.push(I[v + 2], I[v + 1], I[v]) : h.push(I[v], I[v + 1], I[v + 2]);
        return BABYLON.VertexData.ComputeNormals(e, h, c), i && BABYLON.Mesh.ComputeFaceNormal(e, c, y), o && !a && BABYLON.Mesh.ComputeFaceNormal(e, c, I), BABYLON.Mesh.ComputeFaceNormal(e, c, E), u = BABYLON.Tools.PlaneUVProjection(e, new BABYLON.Vector3(1, 0, 0), new BABYLON.Vector3(0, 0, 1)), m.setVerticesData(BABYLON.VertexBuffer.PositionKind, e, l), m.setVerticesData(BABYLON.VertexBuffer.NormalKind, c, l), m.setVerticesData(BABYLON.VertexBuffer.UVKind, u, l), m.setIndices(h), m
    }, this.createRoundedPane = function(t, e, n, i, o, r, s) {
        var a = [], o = o || 6, i = i || 20, r = r || [1, 1, 1, 1];
        this.createRoundedCadreStrate(a, t, e, -n, i, o, r), this.createRoundedCadreStrate(a, t, e, -n, i, o, r), this.createRoundedCadreStrate(a, t, e, 0, i, o, r), this.createRoundedCadreStrate(a, t, e, 0, i, o, r);
        var l = 8 + 4 * (o - 1);
        return this.generateStrateFacesForGeometry("pane", a, l, !0, !0, s, void 0, !0)
    }, this.createRoundedCadre = function(t, e, n, i, o, r, s) {
        var a = [], l = r.nbseg || 6, h = r.radius || 20, o = o || [1, 1, 1, 1];
        this.createRoundedCadreStrate(a, t, e, -i / 2, h, l, o), this.createRoundedCadreStrate(a, t, e, i / 2, h, l, o), this.createRoundedCadreStrate(a, t, e, i / 2, h, l, o), this.createRoundedCadreStrate(a, t - 2 * n, e - 2 * n, i / 2, h, l, o), this.createRoundedCadreStrate(a, t - 2 * n, e - 2 * n, i / 2, h, l, o), this.createRoundedCadreStrate(a, t - 2 * n, e - 2 * n, -i / 2, h, l, o);
        var c = 4 * (l + 1), u = this.generateStrateFacesForGeometry("cadre", a, c, !1, !1, s, [2]);
        return this.giftWraper(u, 128, !0), u
    }, this.giftWraper = function(t, e, n) {
        if (e = e || 128, t && t.getTotalVertices()) {
            for (var i, o, r, s, a = t.getIndices(), l = t.getVerticesData(BABYLON.VertexBuffer.PositionKind), h = t.getVerticesData(BABYLON.VertexBuffer.NormalKind), c = !1, u = new Array(l.length / 3), p = t.scaling.asArray(), d = new BABYLON.Vector3, m = new BABYLON.Vector3, g = new BABYLON.Vector3, f = new Array(l.length / 3 * 2), s = f.length; s--; )
                f[s] = 0;
            for (var y = 0; y < a.length; y += 3)
                if (BABYLON.Vector3.FromArrayToRef(l, 3 * a[y], d), BABYLON.Vector3.FromArrayToRef(l, 3 * a[y + 1], m), BABYLON.Vector3.FromArrayToRef(l, 3 * a[y + 2], g), m.subtractInPlace(d), g.subtractInPlace(d), m.multiplyInPlace(t.scaling), g.multiplyInPlace(t.scaling), BABYLON.Vector3.CrossToRef(m, g, d), d.multiplyInPlace(d), !(d.x < 1e-4 && d.y < 1e-4 && d.z < 1e-4))
                    for (d.x > d.y && d.x > d.z ? (i = 2, o = 1, r = 0) : d.y > d.x && d.y > d.z ? (i = 0, o = 2, r = 1) : (i = 0, o = 1, r = 2), s = 0; 3 > s; s++) {
                        if ("undefined" != typeof u[a[y + s]]) {
                            if (!n || u[a[y + s]] == r)
                                continue;
                            c = !0, l.push(l[3 * a[y + s]], l[3 * a[y + s] + 1], l[3 * a[y + s] + 2]), h.push(h[3 * a[y + s]], h[3 * a[y + s] + 1], h[3 * a[y + s] + 2]), a[y + s] = l.length / 3 - 1
                        }
                        u[a[y + s]] = r, f[2 * a[y + s]] = l[3 * a[y + s] + i] * p[i] / e, f[2 * a[y + s] + 1] = l[3 * a[y + s] + o] * p[o] / e
                    }
            return t.setVerticesData(BABYLON.VertexBuffer.UVKind, f), c && (t.setVerticesData(BABYLON.VertexBuffer.NormalKind, h), t.setVerticesData(BABYLON.VertexBuffer.PositionKind, l), t.setIndices(a)), t
        }
    }, this.createCadre = function(t, e, n, i, o, r, s) {
        var r = r || {}, o = o || [1, 1, 1, 1];
        if (r.rounded && r.radius > 0)
            return this.createRoundedCadre(t, e, n, i, o, r, s);
        var a = new BABYLON.Mesh("cadre", s);
        if (a.isVisible = !1, 0 == n) {
            var l = BABYLON.Mesh.CreateBloc("cadreHaut", t, .1, i, s), h = BABYLON.Mesh.CreateBloc("cadreGauche", .1, e, i, s);
            n = .1
        } else if (0 == i)
            var l = BABYLON.Mesh.CreatePlane("cadreHaut", t, n, s), h = BABYLON.Mesh.CreatePlane("cadreGauche", n, e - 2 * n, s);
        else
            var l = BABYLON.Mesh.CreateBloc("CadreHaut", t, n, i, s), h = BABYLON.Mesh.CreateBloc("CadreGauche", n, e - 2 * n, i, s);
        if (l.parent = a, h.parent = a, 1 == o[2]) {
            var c = h.duplicate("cadreDroit", a, !0);
            c.position.x = -t / 2 + n / 2, c.parent = a
        }
        if (1 == o[3]) {
            var u = l.duplicate("cadreBas", a, !0);
            u.position.y = -e / 2 + n / 2, u.parent = a
        }
        return 1 == o[0] ? l.position.y = e / 2 - n / 2 : l.dispose(), 1 == o[1] ? h.position.x = t / 2 - n / 2 : h.dispose(), a = BABYLON.Mesh.mergeMeshesRec("cadre", [a], s), this.giftWraper(a, 128), a
    }, this.generateArc = function(t, e, n, i, o) {
        for (var r = 1; e > r; r++) {
            var s = n.add(i.subtract(n).scale(r / e)), a = i.add(o.subtract(i).scale(r / e)), l = s.add(a.subtract(s).scale(r / e));
            t.push(l.x, l.y, l.z)
        }
    }, this.generateArcPoints = function(t, e, n, i, o) {
        for (var r = 1; e > r; r++) {
            var s = n.add(i.subtract(n).scale(r / e)), a = i.add(o.subtract(i).scale(r / e)), l = s.add(a.subtract(s).scale(r / e));
            t.push(l)
        }
    }, this.generateVasqueStrate = function(t, e, n, i, o, r, s, a, l) {
        var s = s || 3, a = a || r, l = l || r;
        t.push(-n / 2 + a, o, i / 2), t.push(n / 2 - a, o, i / 2), this.generateArc(t, s, new BABYLON.Vector3(n / 2 - a, o, i / 2), new BABYLON.Vector3(n / 2, o, i / 2), new BABYLON.Vector3(n / 2, o, i / 2 - l)), t.push(n / 2, o, i / 2 - l), t.push(n / 2, o, -i / 2 + l), this.generateArc(t, s, new BABYLON.Vector3(n / 2, o, -i / 2 + l), new BABYLON.Vector3(n / 2, o, -i / 2), new BABYLON.Vector3(n / 2 - a, o, -i / 2)), t.push(n / 2 - a, o, -i / 2), t.push(-n / 2 + a, o, -i / 2), this.generateArc(t, s, new BABYLON.Vector3(-n / 2 + a, o, -i / 2), new BABYLON.Vector3(-n / 2, o, -i / 2), new BABYLON.Vector3(-n / 2, o, -i / 2 + l)), t.push(-n / 2, o, -i / 2 + l), t.push(-n / 2, o, +i / 2 - l), this.generateArc(t, s, new BABYLON.Vector3(-n / 2, o, +i / 2 - l), new BABYLON.Vector3(-n / 2, o, i / 2), new BABYLON.Vector3(-n / 2 + a, o, i / 2))
    }, this.createVasqueGeometry = function(t, e, n) {
        for (var i = [], e = e || {}, o = e.height || 35, r = e.bottomL || 140, s = e.topL || 160, a = e.bottomW || 40, l = e.topW || 50, h = e.radius || 5, c = e.nbseg || 10, u = e.thickness || 10, p = e.thicknessL || u, d = e.thicknessW || u, m = 0, g = 0; o >= g; g++)
            f = r + (Math.asin(2 * g / o - 1) + Math.PI / 2) * (s - r) / Math.PI, y = a + (Math.asin(2 * g / o - 1) + Math.PI / 2) * (l - a) / Math.PI, (.3 * o > g || g > .9 * o) && this.generateVasqueStrate(i, ++m, f, y, g, h, c);
        this.generateVasqueStrate(i, ++m, s + 1, l + 1, g, h, c);
        var f = s + p, y = l + d, h = .1;
        return this.generateVasqueStrate(i, ++m, f, y, g, h, c, void 0, void 0, !0), this.generateVasqueStrate(i, ++m, f, y, g - 1, h, c, void 0, void 0, !0), GeometryHelper.generateStrateFacesForGeometry(t, i, 8 + 4 * (c - 1), !0, !1, n, [m - 3])
    }, this.createHeadLight = function(t, e, n, i, o, r, s, a, l) {
        var h = h || !1, c = [], u = [], p = [];
        e = e || 50, n = Math.max(3, Math.floor(n) || 8), i = Math.max(2, Math.floor(i) || 6), o = void 0 !== o ? o : 0, r = void 0 !== r ? r : 2 * Math.PI, s = void 0 !== s ? s : 0, a = void 0 !== a ? a : Math.PI;
        var d, m, g = [], f = [];
        for (m = 0; i >= m; m++) {
            var y = [], _ = [];
            for (d = 0; n >= d; d++) {
                var v = d / n, b = m / i, w = -e * Math.cos(o + v * r) * Math.sin(s + b * a), x = e * Math.cos(s + b * a), C = e * Math.sin(o + v * r) * Math.sin(s + b * a);
                c.push(w, x, C), y.push(c.length / 3 - 1), _.push(new BABYLON.Vector2(v, 1 - b))
            }
            g.push(y), f.push(_)
        }
        for (m = 0; i > m; m++)
            for (d = 0; n > d; d++) {
                var M = g[m][d + 1], D = g[m][d], B = g[m + 1][d], A = g[m + 1][d + 1], E = (new BABYLON.Vector3(c[M], c[M + 1], c[M + 2]).normalize(), new BABYLON.Vector3(c[D], c[D + 1], c[D + 2]).normalize(), new BABYLON.Vector3(c[B], c[B + 1], c[B + 2]).normalize(), new BABYLON.Vector3(c[A], c[A + 1], c[A + 2]).normalize(), f[m][d + 1].clone()), T = f[m][d].clone(), S = f[m + 1][d].clone(), L = f[m + 1][d + 1].clone();
                u.push(A, D, M), p.push(E.x, E.y, T.x, T.y, L.x, L.y), u.push(A, B, D), p.push(T.x, T.y, S.x, S.y, L.x, L.y)
            }
        var O = [], P = new BABYLON.Mesh(t, l);
        return BABYLON.VertexData.ComputeNormals(c, u, O), P.setVerticesData(BABYLON.VertexBuffer.PositionKind, c, h), P.setVerticesData(BABYLON.VertexBuffer.NormalKind, O, h), P.setVerticesData(BABYLON.VertexBuffer.UVKind, p, h), P.setIndices(u), P
    }, this.createPillow = function(t, e, n, i, o, r, s, a, l, h, c, u) {
        c || (c = 0), u || (u = 0);
        var p = i.clone(), d = new BABYLON.Vector3(p.x, p.y, p.z - s / 2), m = new BABYLON.Vector3(p.x, p.y, p.z + s / 2), g = new BABYLON.Vector3(p.x, p.y + r / 2 - l, p.z), f = new BABYLON.Vector3(p.x, p.y - r / 2 + l, p.z), y = new BABYLON.Vector3(p.x - o / 2 + a, p.y, p.z), _ = (new BABYLON.Vector3(d.x - o / 2, d.y + r / 2, d.z), new BABYLON.Vector3(p.x - o / 2, p.y + r / 2, p.z)), v = (new BABYLON.Vector3(m.x - o / 2, m.y + r / 2, m.z), new BABYLON.Vector3(d.x - o / 2, d.y - r / 2, d.z), new BABYLON.Vector3(p.x - o / 2, p.y - r / 2, p.z)), b = (new BABYLON.Vector3(m.x - o / 2, m.y - r / 2, m.z), new BABYLON.Vector3(p.x + o / 2 - a, p.y, p.z)), w = (new BABYLON.Vector3(d.x + o / 2, d.y + r / 2, d.z), new BABYLON.Vector3(p.x + o / 2, p.y + r / 2, p.z)), x = (new BABYLON.Vector3(m.x + o / 2, m.y + r / 2, m.z), new BABYLON.Vector3(d.x + o / 2, d.y - r / 2, d.z), new BABYLON.Vector3(p.x + o / 2, p.y - r / 2, p.z)), C = (new BABYLON.Vector3(m.x + o / 2, m.y - r / 2, m.z), C || !1), M = [], D = [], B = [], A = [], E = [], T = [_.x, _.y, _.z];
        this.generateArc(T, n, _, g, w);
        for (var S = 0; n > S; S++)
            M.push(m.x, m.y, m.z), M.push(m.x - c + 2 * S * c / n, m.y + u, m.z), this.generateArc(M, e, new BABYLON.Vector3(m.x - c + 2 * S * c / n, m.y + u, m.z), new BABYLON.Vector3(T[3 * S], T[3 * S + 1], T[3 * S + 2] + s / 2), new BABYLON.Vector3(T[3 * S], T[3 * S + 1], T[3 * S + 2])), M.push(T[3 * S], T[3 * S + 1], T[3 * S + 2]), this.generateArc(M, e, new BABYLON.Vector3(T[3 * S], T[3 * S + 1], T[3 * S + 2]), new BABYLON.Vector3(T[3 * S], T[3 * S + 1], T[3 * S + 2] - s / 2), new BABYLON.Vector3(d.x - c + 2 * S * c / n, d.y + u, d.z)), M.push(d.x - c + 2 * S * c / n, d.y + u, d.z), M.push(d.x, d.y, d.z);
        T = [w.x, w.y, w.z], this.generateArc(T, n, w, b, x);
        for (var S = 0; n > S; S++)
            M.push(m.x, m.y, m.z), M.push(m.x + c, m.y + u - 2 * S * u / n, m.z), this.generateArc(M, e, new BABYLON.Vector3(m.x + c, m.y + u - 2 * S * u / n, m.z), new BABYLON.Vector3(T[3 * S], T[3 * S + 1], T[3 * S + 2] + s / 2), new BABYLON.Vector3(T[3 * S], T[3 * S + 1], T[3 * S + 2])), M.push(T[3 * S], T[3 * S + 1], T[3 * S + 2]), this.generateArc(M, e, new BABYLON.Vector3(T[3 * S], T[3 * S + 1], T[3 * S + 2]), new BABYLON.Vector3(T[3 * S], T[3 * S + 1], T[3 * S + 2] - s / 2), new BABYLON.Vector3(d.x + c, d.y + u - 2 * S * u / n, d.z)), M.push(d.x + c, d.y + u - 2 * S * u / n, d.z), M.push(d.x, d.y, d.z);
        T = [x.x, x.y, x.z], this.generateArc(T, n, x, f, v);
        for (var S = 0; n > S; S++)
            M.push(m.x, m.y, m.z), M.push(m.x + c - 2 * S * c / n, m.y - u, m.z), this.generateArc(M, e, new BABYLON.Vector3(m.x + c - 2 * S * c / n, m.y - u, m.z), new BABYLON.Vector3(T[3 * S], T[3 * S + 1], T[3 * S + 2] + s / 2), new BABYLON.Vector3(T[3 * S], T[3 * S + 1], T[3 * S + 2])), M.push(T[3 * S], T[3 * S + 1], T[3 * S + 2]), this.generateArc(M, e, new BABYLON.Vector3(T[3 * S], T[3 * S + 1], T[3 * S + 2]), new BABYLON.Vector3(T[3 * S], T[3 * S + 1], T[3 * S + 2] - s / 2), new BABYLON.Vector3(d.x + c - 2 * S * c / n, d.y - u, d.z)), M.push(d.x + c - 2 * S * c / n, d.y - u, d.z), M.push(d.x, d.y, d.z);
        T = [v.x, v.y, v.z], this.generateArc(T, n, v, y, _);
        for (var S = 0; n > S; S++)
            M.push(m.x, m.y, m.z), M.push(m.x - c, m.y - u + 2 * S * u / n, m.z), this.generateArc(M, e, new BABYLON.Vector3(m.x - c, m.y - u + 2 * S * u / n, m.z), new BABYLON.Vector3(T[3 * S], T[3 * S + 1], T[3 * S + 2] + s / 2), new BABYLON.Vector3(T[3 * S], T[3 * S + 1], T[3 * S + 2])), M.push(T[3 * S], T[3 * S + 1], T[3 * S + 2]), this.generateArc(M, e, new BABYLON.Vector3(T[3 * S], T[3 * S + 1], T[3 * S + 2]), new BABYLON.Vector3(T[3 * S], T[3 * S + 1], T[3 * S + 2] - s / 2), new BABYLON.Vector3(d.x - c, d.y - u + 2 * S * u / n, d.z)), M.push(d.x - c, d.y - u + 2 * S * u / n, d.z), M.push(d.x, d.y, d.z);
        for (var L = 4 * n, O = 2 * e + 3, S = 0; L - 1 > S; S++)
            for (var P = 0; O - 2 > P; P++)
                D.push((S + 1) * O + P, S * O + P + 1, (S + 1) * O + P + 1), D.push(S * O + P + 1, S * O + P + 2, (S + 1) * O + P + 1), 0 == P && B.push((S + 1) * O + P, S * O + P + 1, (S + 1) * O + P + 1), P == O - 3 && B.push(S * O + P + 1, S * O + P + 2, (S + 1) * O + P + 1);
        for (var P = 0; O - 2 > P; P++)
            D.push((L - 1) * O + P + 1, P + 1, (L - 1) * O + P), D.push((L - 1) * O + P + 1, P + 2, P + 1);
        var I = new BABYLON.Mesh(t, h);
        return BABYLON.VertexData.ComputeNormals(M, D, A), (c || u) && BABYLON.Mesh.ComputeFlatNormal(M, A, B), E = BABYLON.Tools.PlaneUVProjection(M, new BABYLON.Vector3(1, 0, 0), new BABYLON.Vector3(0, 1, 0)), I.setVerticesData(BABYLON.VertexBuffer.PositionKind, M, C), I.setVerticesData(BABYLON.VertexBuffer.NormalKind, A, C), I.setVerticesData(BABYLON.VertexBuffer.UVKind, E, C), I.setIndices(D), I
    }, this.createRoundedAngle = function(t, e, n, i, o, r, s) {
        var a = [], n = n || 1, e = e || 10;
        return this.generateVasqueStrate(a, 0, i, r, o / 2, n, e), this.generateVasqueStrate(a, 0, i, r, o / 2, n, e), this.generateVasqueStrate(a, 0, i, r, -o / 2, n, e), this.generateVasqueStrate(a, 1, i, r, -o / 2, n, e), GeometryHelper.generateStrateFacesForGeometry(t, a, 8 + 4 * (e - 1), !0, !0, s, void 0, !0)
    }, this.createRoundedBloc = function(t, e, n, i, o, r, s, a) {
        var l = [], i = i || .1, e = e || 10, h = 0, c = i / n, u = o, p = s, d = r / 2 + i;
        this.generateVasqueStrate(l, ++h, u, p, d, .1, e);
        for (var m = c; i >= m; m += c) {
            var g = i * Math.sin(m / i * Math.PI / 2);
            this.generateVasqueStrate(l, ++h, u + 2 * g, p + 2 * g, d - i * (1 - Math.cos(m / i * Math.PI / 2)), g, e)
        }
        for (var m = i; m > 0; m -= c) {
            var g = i * Math.sin(m / i * Math.PI / 2);
            this.generateVasqueStrate(l, ++h, u + 2 * g, p + 2 * g, -d + i * (1 - Math.cos(m / i * Math.PI / 2)), g, e)
        }
        this.generateVasqueStrate(l, ++h, u, p, -d, .1, e);
        var l = GeometryHelper.generateStrateFacesForGeometry(t, l, 8 + 4 * (e - 1), !0, !0, a, void 0, !0);
        return this.giftWraper(l, 128, !0), l
    }, this.generateEllispeStrate = function(t, e, n, i, o, r) {
        var s = 2 * Math.PI / e;
        if (r) {
            for (var a = 0; a < Math.PI; a += s) {
                var l = n * Math.cos(a), h = n * Math.sin(a) + i - n;
                t.push(l, o, h)
            }
            for (var a = Math.PI; a < 2 * Math.PI; a += s) {
                var l = n * Math.cos(a), h = n * Math.sin(a) - i + n;
                t.push(l, o, h)
            }
        } else
            for (var a = 0; a < 2 * Math.PI; a += s) {
                var l = n * Math.cos(a), h = i * Math.sin(a);
                t.push(l, o, h)
            }
    }, this.createEllispeTable = function(t, e, n, i, o, r, s) {
        var a = [], e = e || 10;
        return this.generateEllispeStrate(a, e, n, i, -o / 2, s), this.generateEllispeStrate(a, e, n, i, -o / 2, s), this.generateEllispeStrate(a, e, n, i, o / 2, s), this.generateEllispeStrate(a, e, n, i, o / 2, s), GeometryHelper.generateStrateFacesForGeometry(t, a, e + 1, !0, !0, r, void 0, !0)
    }
}, GlobalHelper = function() {
    function t() {
        if (wanaplan && wanaplan.engine3D)
            return wanaplan.engine3D.engine._gl;
        var t = document.createElement("canvas");
        return t.getContext("webgl") || t.getContext("experimental-webgl")
    }
    var e = {}, n = null, i = !!navigator.userAgent.match(/Android/i), o = i && !!navigator.userAgent.match(/GT-/i), r = !!navigator.userAgent.match(/iPhone|iPad|iPod/i), s = !!navigator.userAgent.match(/trident.*(Windows Phone|NOKIA)/i), a = !!navigator.userAgent.match(/trident.*(arm|tablet|Windows Phone|NOKIA)/i), l = i || r || a, h = /fr/i.test(navigator.language || navigator.languages || navigator.userLanguage || navigator.systemLanguage || "en");
    return e.getCapabilities = function() {
        if (null === n) {
            n = {maxTextureSize: 512,maxCubemapTextureSize: 512,extensions: {}};
            var e = ["EXT_texture_filter_anistrotropic", "OES_element_index_uint", "OES_standard_derivatives", "OES_texture_float", "OES_texture_float_linear", "OES_texture_half_float", "OES_texture_half_float_linear", "OES_vertex_array_object", "WEBGL_compressed_texture_s3tc", "WEBGL_lose_context", "WEBGL_debug_renderer_info"], i = t();
            if (i) {
                for (var o = 0, r = e.length; r > o; o++) {
                    for (var s = e[o].split("_"), a = s[1], l = 2, h = s.length; h > l; l++)
                        a += s[l].replace(s[l][0], s[l][0].toUpperCase());
                    n.extensions[a] = i.getExtension(e[o]) ? !0 : !1
                }
                n.maxTextureSize = i.getParameter(i.MAX_TEXTURE_SIZE), n.maxCubemapTextureSize = i.getParameter(i.MAX_CUBE_MAP_TEXTURE_SIZE)
            }
        }
        return n
    }, e.getWrappedMouseEventNames = function() {
        return "ontouchstart" in window ? {down: "touchstart",move: "touchmove",up: "touchend",cancel: "touchcancel"} : {down: "pointerdown",move: "pointermove",up: "pointerup",cancel: "pointercancel",out: "pointerout"}
    }, e.hasWebGL = function() {
        return t() ? !0 : !1
    }, e.hasCanvas2D = function() {
        return window.HTMLCanvasElement
    }, e.hasAzertyKeyboard = function() {
        return h
    }, e.isMobileDevice = function() {
        return l
    }, e.isAndroidDevice = function() {
        return i
    }, e.isAppleDevice = function() {
        return r
    }, e.isSamsungDevice = function() {
        return o
    }, e.isWindowsDevice = function() {
        return a
    }, e.isWindowsPhoneDevice = function() {
        return s
    }, e.isIE = function() {
        var t = navigator.userAgent.toLowerCase();
        return -1 != t.indexOf("msie") ? parseInt(t.split("msie")[1]) : -1
    }, e.isIE9 = function() {
        return "Explorer" === BrowserDetect.browser && 9 === BrowserDetect.version
    }, e.isIE10 = function() {
        return "Explorer" === BrowserDetect.browser && 10 === BrowserDetect.version
    }, e.createScreenshot3D = function(t, e, n) {
        var i = document.createElement("canvas"), e = e || {width: window.innerWidth,height: window.innerHeight}, o = new BABYLON.RenderTargetTexture("screenShot", e, t.scenes[0]);
        o.renderList = t.scenes[0].meshes, o.onAfterRender = function() {
            for (var o = 4 * e.width, r = e.height / 2, s = t.readPixels(0, 0, e.width, e.height), a = 0; r > a; a++)
                for (var l = 0; o > l; l++) {
                    var h = l + a * o, c = e.height - a - 1, u = l + c * o, p = s[h];
                    s[h] = s[u], s[u] = p
                }
            i.width = e.width, i.height = e.height;
            var d = i.getContext("2d"), m = d.createImageData(i.width, i.height);
            m.data.set(s), d.putImageData(m, 0, 0), n(i)
        }, o.render(), o.dispose()
    }, e.__forceMobileDevice = function(t) {
        l = t
    }, e.stripDomainUrl = function(t, e) {
        if (t && -1 !== t.indexOf("http://") && -1 !== t.indexOf(e)) {
            var n = t.replace("http://", "").split("/");
            t = t.replace("http://" + n[0], "/"), t = t.split("///").join("//"), t = t.split("//").join("/")
        }
        return t
    }, e
}(), HTMLHelper = function() {
    var t = {};
    return t.insertHTML = function(t, e, n, i) {
        var o = e, n = "function" == typeof n ? n : function() {
        }, i = "function" == typeof i ? i : function() {
        };
        "string" == typeof e && (o = document.getElementById(e)), ujs.ajax({method: "GET",url: t + "?t=" + Math.round(100 * Math.random()),success: function(t) {
                o.innerHTML = t, n()
            },onerror: i})
    }, t.addScript = function(t, e, n, i) {
        var n = "function" == typeof n ? n : function() {
        }, i = "function" == typeof i ? i : function() {
        }, o = document.createElement("script");
        if (o.addEventListener("load", n, !1), o.addEventListener("error", i, !1), o.setAttribute("src", t), e)
            for (var r in e)
                o.setAttribute(r, e[r]);
        var s = document.getElementById("scripts");
        s.appendChild(o)
    }, t.addStylesheet = function(t, e, n, i) {
        var n = "function" == typeof n ? n : function() {
        }, i = "function" == typeof i ? i : function() {
        }, o = document.createElement("link");
        if (o.addEventListener("load", n, !1), o.addEventListener("error", i, !1), o.setAttribute("rel", "stylesheet"), o.setAttribute("href", t), e)
            for (var r in e)
                o.setAttribute(r, e[r]);
        var s = document.getElementsByTagName("head")[0];
        s.appendChild(o)
    }, t.hide3DMenus = function(t) {
        var t = t || "none", e = document.getElementById("decorate3D"), n = document.getElementById("furnishing3D");
        e && (e.style.display = t), n && (n.style.display = t)
    }, t.simulateKey = function(t, e, n) {
        var i = "string" == typeof e ? "key" + e : "keydown", n = n || {}, o = {keyCode: t};
        for (var r in n)
            o[r] = n[r];
        ujs.notify(i, o)
    }, t.simulateClick = function(t, e, n, i, o, r) {
        var s = document.createEvent("MouseEvent");
        s.initEvent(i || "mousedown"), s.clientX = s.layerX = s.pageX = s.screenX = s.x = 0 | +e, s.clientX = s.layerY = s.pageY = s.screenY = s.y = 0 | +n, s.button = 0 | +o, s.detail = s.wheelDeltaY = s.wheelDelta = 0 | +r, t.dispatchEvent(s)
    }, t
}(), wnp = window.wnp || {};
wnp.Symbols2D = function() {
    var t = function() {
        this.COLOR_ACTIVE_STROKE = "#89B808", this.COLOR_ACTIVE_STROKE_DARKER = "#6C9104", this.COLOR_ACTIVE_FILL = "rgba(137, 184, 8, 0.2)", this.COLOR_ACTIVE_LARGEZONE_FILL = "rgba(137, 137, 137, 0.5)", this.COLOR_INACTIVE_STROKE = "#777777", this.COLOR_INACTIVE_FILL = "rgba(90, 119, 119, 0.1)", this.COLOR_BACKGROUND = "#FAFAFA", this.COLOR_ANNOTATION = "#888"
    };
    return t.prototype.drawPoint = function(t, e) {
        t.save(), t.fillStyle = this.COLOR_ACTIVE_STROKE, t.beginPath(), t.arc(e.x, e.y, 6, 0, 2 * Math.PI, !1), t.fill(), t.restore()
    }, t.prototype.drawPointHover = function(t, e, n) {
        var n = n || 1;
        t.save(), this.drawPoint(t, e), t.strokeStyle = this.COLOR_ACTIVE_STROKE, t.lineWidth = 4, t.beginPath();
        var i = 12 * n;
        10 > i && (i = 10), t.arc(e.x, e.y, i, 0, 2 * Math.PI, !1), t.stroke(), t.restore()
    }, t.prototype.drawAngle = function(t, e, n, i, o, r, s) {
        t.save(), t.fillStyle = this.COLOR_ACTIVE_LARGEZONE_FILL, t.strokeStyle = this.COLOR_ACTIVE_STROKE, t.beginPath(), t.moveTo(e.x, e.y), t.arc(e.x, e.y, i, o, r, s), t.lineTo(e.x, e.y), t.fill(), t.stroke(), t.font = "normal 8pt sans-serif", t.textBaseline = "middle", t.textAlign = "center";
        var a = {x: e.x + i * Math.cos((r + o) / 2),y: e.y + i * Math.sin((r + o) / 2)}, l = Math.round(180 * Math.abs(r - o) / Math.PI) + " °";
        t.fillStyle = this.COLOR_BACKGROUND, t.beginPath(), t.arc(a.x, a.y, t.measureText(l).width / 2 + 2, 0, 2 * Math.PI), t.fill(), t.stroke(), t.fillStyle = this.COLOR_ANNOTATION, t.fillText(l, a.x, a.y), t.restore()
    }, t.prototype.drawSegment = function(t, e, n) {
        e.x = Math.round(e.x) + .5, e.y = Math.round(e.y) + .5, n.x = Math.round(n.x) + .5, n.y = Math.round(n.y) + .5, t.save(), t.strokeStyle = this.COLOR_ACTIVE_STROKE, t.fillStyle = this.COLOR_ACTIVE_STROKE, t.lineWidth = 5, this.drawPoint(t, e), this.drawPoint(t, n), t.beginPath(), t.moveTo(e.x, e.y), t.lineTo(n.x, n.y), t.stroke(), t.restore()
    }, t.prototype.drawArc = function(t, e, n, i) {
        e.x = Math.round(e.x) + .5, e.y = Math.round(e.y) + .5, i.x = Math.round(i.x) + .5, i.y = Math.round(i.y) + .5, n.x = Math.round(n.x) + .5, n.y = Math.round(n.y) + .5, t.save(), t.strokeStyle = this.COLOR_ACTIVE_STROKE, t.fillStyle = this.COLOR_ACTIVE_STROKE, t.lineWidth = 5, this.drawPoint(t, e), this.drawPoint(t, i), t.beginPath(), t.moveTo(e.x, e.y), t.quadraticCurveTo(n.x, n.y, i.x, i.y), t.stroke(), t.restore()
    }, t.prototype.drawGrip = function(t, e, n, i) {
        var i = i || 0;
        e.x = Math.round(e.x), e.y = Math.round(e.y), t.save(), t.strokeStyle = this.COLOR_ACTIVE_STROKE, t.fillStyle = this.COLOR_BACKGROUND, t.lineWidth = 2, t.translate(e.x, e.y), t.beginPath(), t.arc(0, 0, 9, 0, 2 * Math.PI, !1), t.fill(), t.stroke(), this.drawArrows(t, {x: 0,y: 0}, n, 12, i), t.restore()
    }, t.prototype.drawCheckGrip = function(t, e, n, i) {
        var i = i || 0;
        e.x = Math.round(e.x), e.y = Math.round(e.y), t.save(), t.translate(e.x, e.y), t.strokeStyle = this.COLOR_BACKGROUND, t.fillStyle = this.COLOR_INACTIVE_STROKE, t.lineWidth = 2, t.beginPath(), t.arc(0, 0, 11, 0, 2 * Math.PI, !1), t.fill(), t.stroke(), t.save(), t.fillStyle = this.COLOR_BACKGROUND, t.rotate(Math.PI / 4), t.fillRect(-5, 2, 5, 4), t.rotate(Math.PI / 2), t.fillRect(-7, -3, 13, 4), t.restore(), this.drawArrows(t, {x: 0,y: 0}, n, 12, i), t.restore()
    }, t.prototype.drawCancelGrip = function(t, e, n, i) {
        var i = i || 0;
        e.x = Math.round(e.x), e.y = Math.round(e.y), t.save(), t.translate(e.x, e.y), t.strokeStyle = this.COLOR_BACKGROUND, t.fillStyle = this.COLOR_INACTIVE_STROKE, t.lineWidth = 2, t.beginPath(), t.arc(0, 0, 11, 0, 2 * Math.PI, !1), t.fill(), t.stroke(), t.save(), t.fillStyle = this.COLOR_BACKGROUND, t.rotate(Math.PI / 4), t.fillRect(-7, -2, 14, 4), t.rotate(Math.PI / 2), t.fillRect(-7, -2, 14, 4), t.restore(), this.drawArrows(t, {x: 0,y: 0}, n, 12, i), t.restore()
    }, t.prototype.drawGripSegment = function(t, e, n, i, o, r) {
        var r = r || 0;
        e.x = Math.round(e.x) + .5, e.y = Math.round(e.y) + .5, n.x = Math.round(n.x) + .5, n.y = Math.round(n.y) + .5, t.save(), t.strokeStyle = this.COLOR_ACTIVE_STROKE, t.fillStyle = this.COLOR_ACTIVE_STROKE, t.lineWidth = 5, t.beginPath(), t.moveTo(e.x, e.y), t.lineTo(n.x, n.y), t.stroke(), this.drawGrip(t, e, i, r), this.drawGrip(t, n, o, r), t.restore()
    }, t.prototype.drawArrows = function(t, e, n, o, r, s, a) {
        var a = a || {}, l = a.size || 6, r = r || 0;
        for (t.save(), t.translate(e.x, e.y), t.rotate(r), t.fillStyle = this.COLOR_ACTIVE_STROKE, t.strokeStyle = this.COLOR_BACKGROUND, t.lineWidth = 2, i = 0; 4 > i; i++)
            n[i] && (t.beginPath(), t.moveTo(0, -o - l), t.lineTo(-l, -o), t.lineTo(l, -o), t.closePath(), s && t.stroke(), t.fill()), t.rotate(Math.PI / 2);
        t.restore()
    }, t.prototype.drawMeasure = function(t, e, n, i, o) {
        t.save(), t.strokeStyle = o || this.COLOR_ANNOTATION, t.fillStyle = o || this.COLOR_ANNOTATION, t.lineWidth = 1, t.font = "normal 8pt sans-serif", t.textBaseline = "middle", t.textAlign = "center";
        var r = n.x > e.x ? n.x - e.x : e.x - n.x, s = n.y > e.y ? n.y - e.y : e.y - n.y, a = Math.sqrt(Math.pow(r, 2) + Math.pow(s, 2)), l = Math.atan2(n.y - e.y, n.x - e.x), h = i ? t.measureText(i).width + 10 : 0;
        h > a - 2 || (t.translate(Math.round((e.x + n.x) / 2), Math.round((e.y + n.y) / 2)), t.rotate(l), t.beginPath(), (a - h) / 2 > 5 && (t.moveTo(-Math.round(a / 2), .5), t.lineTo(-Math.round(h / 2) + 1, .5), t.moveTo(Math.round(a / 2), .5), t.lineTo(Math.round(h / 2) - 1, .5)), t.save(), t.translate(-Math.round(a / 2), 0), t.moveTo(.5, .5), t.lineTo(5, 5), t.moveTo(.5, .5), t.lineTo(5, -4), t.stroke(), t.restore(), t.save(), t.translate(Math.round(a / 2), 0), t.moveTo(-.5, .5), t.lineTo(-5, 5), t.moveTo(-.5, .5), t.lineTo(-5, -4), t.restore(), t.stroke(), i && ((l >= Math.PI / 2 || l < -Math.PI / 2) && t.rotate(Math.PI), t.fillText(i, 0, -.5)), t.restore())
    }, t.prototype.drawCursorCheck = function(t, e) {
        var n = e.x + 20, i = e.y + 20;
        t.save(), t.translate(n, i), t.fillStyle = "rgba(0,0,0,.2)", t.rotate(Math.PI / 4), t.fillRect(-6, 2, 7, 6), t.rotate(Math.PI / 2), t.fillRect(-7, -5, 15, 6), t.restore(), t.save(), t.translate(n, i), t.fillStyle = this.COLOR_ACTIVE_STROKE_DARKER, t.fillStyle = "#000", t.rotate(Math.PI / 4), t.fillRect(-7, 1, 7, 6), t.rotate(Math.PI / 2), t.fillRect(-8, -4, 15, 6), t.restore(), t.save(), t.translate(n, i), t.fillStyle = this.COLOR_BACKGROUND, t.rotate(Math.PI / 4), t.fillRect(-6, 2, 6, 4), t.rotate(Math.PI / 2), t.fillRect(-7, -3, 13, 4), t.restore()
    }, t.prototype._drawAllSymbols = function(t) {
        this.drawPoint(t, {x: 100,y: 100}), this.drawPointHover(t, {x: 150,y: 100}), this.drawPointHover(t, {x: 200,y: 100}, 1.5), this.drawSegment(t, {x: 250,y: 90}, {x: 300,y: 110}), this.drawGrip(t, {x: 350,y: 100}, [!0, !0, !0, !0]), this.drawGrip(t, {x: 400,y: 100}, [!1, !0, !1, !0], Math.PI / 4), this.drawCheckGrip(t, {x: 450,y: 100}, [!0, !0, !0, !0]), this.drawCancelGrip(t, {x: 500,y: 100}, [!1, !0, !1, !0], 3 * Math.PI / 4), this.drawGripSegment(t, {x: 550,y: 90}, {x: 600,y: 110}, [!1, !1, !1, !0], [!1, !0, !1, !1], .4), this.drawMeasure(t, {x: 650,y: 80}, {x: 750,y: 80}, "measure"), this.drawMeasure(t, {x: 650,y: 100}, {x: 715,y: 100}, "measure"), this.drawMeasure(t, {x: 650,y: 120}, {x: 706,y: 120}, "measure"), this.drawCursorCheck(t, {x: 100,y: 150})
    }, t
}();
var wnp = window.wnp || {};
wnp.uuid = function() {
    function t() {
        return "xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g, function(t) {
            var e = 16 * Math.random() | 0, n = "x" == t ? e : 3 & e | 8;
            return n.toString(16)
        })
    }
    return {uuid4: t}
}();
var wnp = window.wnp || {};
wnp.Dummy = {Engine3D: function(t) {
        var e = function() {
            return null
        };
        this.dummy = !0, this._components = [], this.removeComponent = e, this.searchComponent = e, this.initialize = e, this.update = e, this.draw = e, this.resize = e, this.setEnabled = e, this.canvas = document.createElement("canvas"), this.castShadows = e, this.uncastShadows = e;
        var n = this;
        this.engine = {_caps: {},_gl: null,_renderingCanvas: n.canvas,getRenderingCanvas: function() {
                return n.canvas
            },createRenderTargetTexture: function() {
            },getLoadedTexturesCache: function() {
                return []
            },createVertexBuffer: e,createIndexBuffer: e,createTexture: e,createCubeTexture: e,createDynamicVertexBuffer: e,createEffect: e,scenes: []}, this.addComponent = function() {
            return {}
        }, this.scene = {materials: [],textures: [],meshes: [],cameras: [],spriteManagers: [],getMeshByName: e,getRenderId: function() {
                return 0
            },getEngine: function() {
                return n.engine
            }}, this.scenes = [this.scene], this.getContainer = function() {
            return t
        }
    }};
var wnp = window.wnp || {};
wnp.Assets = {globalPath: "",metalTextures: {diffuse: "textures/metal/metal_DIFFUSE.png",normal: "textures/metal/metal_NORMAL.png",specular: "textures/metal/metal_SPECULAR.png"},woodTextures: {diffuse: "textures/bois/bois_DIFFUSE.png",normal: "textures/bois/bois_NORMAL.png",specular: "textures/bois/bois_SPECULAR.png"},plasticTextures: {diffuse: "textures/plastique/plastique_DIFFUSE.png",normal: "textures/plastique/plastique_NORMAL.png",specular: "textures/plastique/plastique_SPECULAR.png"},whiteTexture: "textures/misc/white.jpg",blackTexture: "textures/misc/black.jpg",transparentTexture: "textures/misc/transparent.png",shadowTexture: "textures/shadow/shadow.png",roomTextures: {diffuse: "textures/parquet/parquet_DIFFUSE.png",normal: "textures/parquet/parquet_NORMAL.png",specular: "textures/parquet/parquet_SPEC.png"},firePlaceFire: "textures/fireplace/fireplace_tex.png",firePlaceBrick: {diffuse: "textures/fireplace/fire_place_brick.png",normal: "textures/fireplace/fire_place_brick_normals.png",specular: "textures/fireplace/fire_place_brick_spec.png"},firePlaceBrick2: {diffuse: "textures/textureset/brick/brick05.jpg",normal: "textures/textureset/brick/brick05_NORM.jpg",specular: "textures/textureset/brick/brick05_SPEC.jpg"},firePlacePlate: {diffuse: "textures/fireplace/fireplace_plate_tex.png",normal: "textures/fireplace/fireplace_plate_tex_normals.png",specular: "textures/fireplace/fireplace_plate_tex_spec.png"},induction: {map: "textures/misc/induction.jpg"},dishwasher: {map: "textures/misc/lavevaisselle.jpg"},hood: {map: "textures/misc/hotte.png"},oven: {map: "textures/misc/oven.png"},microwave: {map: "textures/misc/microwave.png"},firePlaceWood: {diffuse: "textures/fireplace/fireplace_wood.png",normal: "textures/fireplace/fireplace_wood_normals.png",specular: "textures/fireplace/fireplace_wood_spec.png"},envMapTexture: "textures/environment/SwedishRoyalCastle/src",flatEnvMapTexture: "textures/environment/flatInterior/flat",skyEnvMapTexture: "textures/environment/sky.jpg",toolbarTextures: {infoTexture: "textures/toolbar/info.png",infoTextureGroup: "textures/toolbar/infoGroup.png",rotateTexture: "textures/toolbar/rotate.png",arrowTexture: "textures/toolbar/arrow.png"},mattTexture: "textures/misc/CNPflat_tex.png",darkWoodTextures: {diffuse: "textures/wood/dark-wood1.png",normal: "textures/wood/dark-wood1_NORM.png",specular: "textures/wood/dark-wood1_SPEC.png"},bedSheetsTextures: {diffuse: "textures/bed/sheets.png",normal: "textures/bed/sheets_NORM.png",specular: "textures/bed/sheets_SPEC.png"},cromwellTextures: {diffuse: "models/babylon/chair/cromwell/cromwell_diff.png",normal: "models/babylon/chair/cromwell/cromwell_normals.png",specular: "models/babylon/chair/cromwell/cromwell_specular.png"},cushionTexture: "textures/bed/cushion-test3.png",vasqueDAE: "models/babylon/bathroom/components/vasque_s",doucheDAE: "models/babylon/bathroom/shower1/shower1.babylon",robinetDAE: "models/babylon/robinet/robinet.babylon",spotLampDAE: "models/babylon/lamps/lamp2/spot.babylon",robinet3DAE: "models/babylon/robinet/robinet3.babylon",robinet4DAE: "models/babylon/robinet/robinet4.babylon",robinet5DAE: "models/babylon/robinet/tap.babylon",boconceptfeetDAE: "models/babylon/table/boconcept/bocpart.babylon",ovaletableDAE: "models/babylon/table/ovale/ovale.babylon",cromwellleftsideDAE: "models/babylon/chair/cromwell/cromwell_leftside.babylon",cromwelrightsideDAE: "models/babylon/chair/cromwell/cromwell_rightside.babylon",cromwellcenterDAE: "models/babylon/chair/cromwell/cromwell_center.babylon",DaePath: "models/babylon/",retrieveImageScriptPath: "php/retrieveImage.php",retrieveObjectScriptPath: "php/retrieveObject.php",remote: {man: "images/remote-controller/green_man.png",cam: "images/remote-controller/green_cam.png",bg: "images/remote-controller/bg.png"},mainUIColor: "#8AB808",complementaryUIColor: "#BDB808",groupColor: "#B88A08"};
var wnp = window.wnp || {};
wnp.AnimationHandler = function() {
    var t = function() {
    };
    t.LINEAR = 0, t.SMOOTH = 1;
    var e = -1, n = -1, i = [], o = 0, r = function(e, n, i, r) {
        this.running = !1, this.startTime = null, this.lastTime = null, this.endTime = null, this.duration = n || -1, this.speeds = null, this.target = e || null, this.properties = i || null, this.interpolationMethod = void 0 !== r && null !== r ? r : t.LINEAR, this.id = o++, this.computeSpeeds()
    };
    return r.prototype.computeSpeeds = function() {
        if (this.properties) {
            this.speeds = {};
            for (var t in this.properties)
                this.speeds[t] = (this.properties[t].end - this.properties[t].start) / this.duration
        }
    }, r.prototype.start = function() {
        this.running = !0, this.startTime = (new Date).getTime()
    }, r.prototype.stop = function() {
        this.running = !1, this.endTime = (new Date).getTime(), this.startTime = null
    }, t.Create = function(t, e, n, o) {
        var s = new r(t, e, n, o);
        return i.push(s), s
    }, t.GetAnimations = function() {
        return i
    }, t.GetAnimation = function(t) {
        for (var e = 0, n = i.length; n > e; e++)
            if (i[e].id === t)
                return i[e];
        return Logger.warning("No animation found with this id"), null
    }, t.Dispose = function(t) {
        for (var e = 0, n = i.length; n > e; e++)
            if (i[e].id === t)
                return void i.splice(e, 1)
    }, t.ClearAll = function() {
        i.length = 0
    }, t.Process = function() {
        e = (new Date).getTime();
        for (var n = 0, o = i.length; o > n; n++)
            t.ProcessAnimation(i[n])
    }, t.ProcessAnimation = function(t) {
        if (t.running) {
            n = e - (t.lastTime || t.startTime), t.lastTime = e;
            for (var i in t.properties)
                t.properties[i].callback ? t.properties[i].callback((e - t.startTime) * t.speeds[i] + t.properties[i].start) : t.target[i] += n * t.speeds[i];
            e - t.startTime >= t.duration && t.stop()
        }
    }, t
}();
var wnp = window.wnp || {};
wnp.Constants = {VERSION: "1.2.0.0",BACK_URL: "http://back1.wanaplan.org/",WNP_URL: "",MIGRATION_PATH: "migration/plan?json=",ENGINE_2D: 1,ENGINE_3D: 2,MODE_STANDALONE: 0,MODE_CUSTOMER: 1,LANG: "en",LOCAL_STORAGE_STRUCTURE_KEY: "wanadev.planner.structure",LC_REM_LOGIN_KEY: "wanadev.planner.remember",LC_REM_CRYPT_KEY: "wanadev",LC_LANG_KEY: "wanadev.planner.lang",LC_MAC_GL_CHECK: "wanadev.planner.macosx.check",PRODUCTS_PATH: "data/products/",TEMPLATE_PATH: "js/Core/UI/Templates/",PROGRAMMABLE_PATH: "js/Components/CoreComponents/Object/Programmable",GRAPHICS_FAST: 0,GRAPHICS_GOOD: 1,GRAPHICS_QUALITY: 2,MAGNETISM: {NONE: 0,WALL: 1,OBJECT: 2,VERTICAL: 4},PRODUCTS_FILE: "data/products.json",PRODUCTS_PREVIEWS: "models/previews/"}, wnp.Constants.MAGNETISM.DEFAULT = wnp.Constants.MAGNETISM.WALL | wnp.Constants.MAGNETISM.OBJECT | wnp.Constants.MAGNETISM.VERTICAL;
var wnp = window.wnp || {};
wnp.CameraFeatures = function() {
    var t = null, e = function() {
        this.camera = void 0, this.wallTransparency = !1, document.addEventListener("wnp.engine3D.camera.move", this.onCameraMove.bind(this), !1), document.addEventListener("wnp.engine3D.camera.zoom", this.onCameraZoom.bind(this), !1), document.addEventListener("wnp.engine3d.subslopeOverturesReady", this.onWallsReady.bind(this), !1), document.addEventListener("wnp.contextChanged", this.onContextChanged.bind(this), !1), document.addEventListener("wnp.engine3d.globaleFloorReady", this.onGlobaleFloorReady.bind(this), !1)
    };
    e.prototype.setCamera = function(t) {
        this.camera = t
    }, e.prototype.onCameraMove = function() {
        this.wallTransparency && this.dynamicWallTransparency()
    }, e.prototype.onCameraZoom = function() {
        this.wallTransparency && this.dynamicWallTransparency()
    }, e.prototype.onWallsReady = function() {
        wanaplan.getSelectedEngine() === wanaplan.ENGINE_3D && this.wallTransparency && this.dynamicWallTransparency()
    }, e.prototype.stopTransparency = function() {
        t = t || wanaplan.getComponentByName("WallComponent3D");
        for (var e, i = wanaplan.getSelectedStructure(), o = t.get3DWallFrom2D(i), r = 0, s = o.material.subMaterials.length; s > r; r++)
            if (e = o.material.subMaterials[r], e.opacitySwitched) {
                if (o.objectInstances[r] && ("OvertureStructure" == o.objectInstances[r].name || "SubSlopeOvertureStructure" == o.objectInstances[r].name) && o.objectInstances[r].programmableInstance)
                    for (var a in o.objectInstances[r].programmableInstance.materials)
                        o.objectInstances[r].programmableInstance.materials.hasOwnProperty(a) && n(o.objectInstances[r].programmableInstance.materials[a]);
                n(e)
            }
        this.wallTransparency = !1
    }, e.prototype.startTransparency = function() {
        this.dynamicWallTransparency(), this.wallTransparency = !0
    }, e.prototype.buildPlaneFromBB = function(t) {
        var e = t.center, n = -t.angle, i = new BABYLON.Vector3(Math.sin(n), 0, -Math.cos(n));
        return BABYLON.Plane.FromPositionAndNormal(e, i)
    }, e.prototype.fillByZIndex = function(t) {
        {
            var e, n, i, o = {}, r = this.camera.target.clone(), s = new BABYLON.Ray(this.camera.position, r.subtract(this.camera.position).normalize());
            new BABYLON.Vector3
        }
        o[0] = !0, o[1] = !0;
        for (var a in t.subMeshes)
            e = t.boundingBoxes[a], e ? (n = this.buildPlaneFromBB(e), i = s.distanceToPlane(n), null !== i && i <= r.distanceTo(this.camera.position) && (o[a] = !0)) : "top" == t.material.subMaterials[a].name ? o[a] = !0 : t.objectInstances[a] && "SubSlopeOvertureStructure" == t.objectInstances[a].name && (o[a] = !0);
        return o
    };
    var n = function(t, e) {
        var n = void 0 !== t.alternativeOpacity ? t.alternativeOpacity : e;
        t.alternativeOpacity = t.alpha, t.alpha = n, t.opacitySwitched = !t.opacitySwitched, t.transparent = 1 != t.alpha
    };
    e.prototype.dynamicWallTransparency = function() {
        t = t || wanaplan.getComponentByName("WallComponent3D");
        var e = wanaplan.getSelectedStructure(), i = t.get3DWallFrom2D(e);
        if (i)
            for (var o, r = this.fillByZIndex(i), s = 0, a = i.subMeshes.length; a > s; s++)
                if (o = i.material.subMaterials[i.subMeshes[s].materialIndex], o.opacitySwitched && !r[i.subMeshes[s].materialIndex] || !o.opacitySwitched && r[i.subMeshes[s].materialIndex])
                    if (1 == s)
                        n(o, 0);
                    else {
                        if (i.objectInstances[s] && ("OvertureStructure" == i.objectInstances[s].name || "SubSlopeOvertureStructure" == i.objectInstances[s].name) && i.objectInstances[s].programmableInstance)
                            for (var l in i.objectInstances[s].programmableInstance.materials)
                                i.objectInstances[s].programmableInstance.materials.hasOwnProperty(l) && n(i.objectInstances[s].programmableInstance.materials[l], .2);
                        n(o, .2)
                    }
    }, e.prototype.makeWallsOpaque = function(e) {
        if (this.wallTransparency) {
            t = t || wanaplan.getComponentByName("WallComponent3D");
            var i, e = e || wanaplan.getSelectedStructure(), o = t.get3DWallFrom2D(e);
            if (!o)
                return;
            for (var r = 0, s = o.subMeshes.length; s > r; r++)
                if (i = o.material.subMaterials[o.subMeshes[r].materialIndex], i.opacitySwitched) {
                    if (o.objectInstances[r] && ("OvertureStructure" == o.objectInstances[r].name || "SubSlopeOvertureStructure" == o.objectInstances[r].name) && o.objectInstances[r].programmableInstance)
                        for (var a in o.objectInstances[r].programmableInstance.materials)
                            o.objectInstances[r].programmableInstance.materials.hasOwnProperty(a) && n(o.objectInstances[r].programmableInstance.materials[a]);
                    n(i)
                }
        }
    }, e.prototype.onContextChanged = function(t) {
        "3D" !== t.context && this.makeWallsOpaque()
    }, e.prototype.onGlobaleFloorReady = function(t) {
        for (var e = 0; e < wanaplan.structure.getLength(); e++) {
            var n = wanaplan.structure.getElement(e);
            e !== t.maxFloorId && this.makeWallsOpaque(n)
        }
    }, e.prototype.getBestFocusRadius = function(t, e, n) {
        var i = t.getBoundingSphere(), o = (i.center.clone().add(t.position), n.getEngine().getAspectRatio(e)), r = Math.max(1, 1 / o) * i.radius, s = r / Math.sin(e.fov / 2);
        return s
    }, e.prototype.computeCameraStateLooking = function(t, e, n) {
        n = n || new BABYLON.Viewport(0, 0, 1, 1);
        var i = t.getScene();
        e = e || i.activeCamera;
        var o = t.getBoundingSphere(), r = new BABYLON.Vector3(0, .3, 1.2);
        t.structure && "undefined" != typeof t.structure.preferredYAngle && (r.x = Math.sin(t.structure.preferredYAngle), r.z = Math.cos(t.structure.preferredYAngle)), r.normalize();
        var s = o.center.clone(), a = t.getWorldMatrix().clone();
        s.x += a.m[12], s.y += a.m[13], s.z += a.m[14], a.m[12] = a.m[13] = a.m[14] = 0;
        var l = BABYLON.Vector3.TransformCoordinates(r, a);
        l.y < 0 && (l.y = 0, l.normalize());
        var h = l.toSpherical(), c = i.getEngine().getAspectRatio(e), u = 1 / n.height * o.radius, p = 1 / n.width / c * o.radius, d = Math.max(p, u) / Math.sin(e.fov / 2), m = new BABYLON.Vector3(0, 1, 0), g = BABYLON.Vector3.Cross(m, r);
        (null == g || g.lengthSquared() < 1e-5) && (r = new BABYLON.Vector3(0, 1, .001), g = BABYLON.Vector3.Cross(m, r)), g.normalize(), BABYLON.Vector3.CrossToRef(g, r, m);
        var f = BABYLON.Matrix.FromArray([g.x, g.y, g.z, 0, m.x, m.y, m.z, 0, r.x, r.y, r.z, 0, 0, 0, 0, 1]);
        f.invert(), f = f.multiply(a), u = d * Math.sin(e.fov / 2), p = u * c;
        var y = new BABYLON.Vector3(p * n.x, 0, 0), _ = new BABYLON.Vector3(0, u * n.y, 0);
        return BABYLON.Vector3.TransformCoordinatesToRef(y, f, y), BABYLON.Vector3.TransformCoordinatesToRef(_, f, _), s.addInPlace(y), s.addInPlace(_), {target: s,alpha: h.alpha,beta: h.beta,radius: d}
    };
    var i = function(t, e) {
        this.animations = t, this.target = e, this.target._animationCancelor && this.target._animationCancelor.cancel(), this.target._animationCancelor = this
    };
    i.prototype.cancel = function() {
        this.target._animationCancelor == this && (this.target.getScene().stopAnimation(this.target), this._onAnimationEnd())
    }, i.prototype._onAnimationEnd = function() {
        if (this.target._animationCancelor == this && (this.target._animationCancelor = null, this._moreCleanUp && this._moreCleanUp(), this._callBack && this._callBack(), this.animations)) {
            for (var t = this.animations.length; t--; )
                for (var e = this.target.animations.length; e--; )
                    this.animations[t] == this.target.animations[e] && this.target.animations.splice(e, 1);
            this.animations = null
        }
    };
    var o = function(t, e, n, i, o, r) {
        r = r || {x: null,y: null};
        var s = 1 - t;
        return r.x = 3 * t * s * s * e + 3 * t * t * s * i + t * t * t, r.y = 3 * t * s * s * n + 3 * t * t * s * o + t * t * t, r
    }, r = function(t, e, n, i, r) {
        for (var s, a = 0, l = 1, h = {x: null,y: null}; l - a > .001; )
            o(s = (a + l) / 2, e, n, i, r, h).x > t ? l = s : a = s;
        return (a + l) / 2
    }, s = function(t, e, n, i, s) {
        return o(r(t, e, n, i, s), e, n, i, s).y
    }, a = {linear: function(t) {
            return t
        },ease: function(t) {
            return s(t, .5, 0, .5, 1)
        },easeOut: function(t) {
            return s(t, .64, .47, .34, 1)
        }};
    return e.prototype.computeAnimation = function(t, e, n, o) {
        o = o || {};
        var r = Math.max(.01, o.duration || 0), s = o.callback, l = ("undefined" == typeof o.cleanAfterAnimation ? !0 : o.cleanAfterAnimation, o.name || "animation"), h = o.isACamera, c = "function" == typeof o.smooth ? o.smooth : a[o.smooth || "linear"], u = [];
        for (var p in e) {
            for (var d, m, g = new BABYLON.Animation(l + "_" + p, p, 60, e[p] instanceof BABYLON.Vector3 ? BABYLON.Animation.ANIMATIONTYPE_VECTOR3 : BABYLON.Animation.ANIMATIONTYPE_FLOAT, BABYLON.Animation.ANIMATIONLOOPMODE_CONSTANT), f = [], y = (c == a.linear ? 2 : Math.max(2, r / 40)) >> 0, _ = y; _--; ) {
                d = _ / (y - 1);
                var v = 0 === d ? 0 : 1 === d ? 1 : c(d);
                switch (g.dataType) {
                    case BABYLON.Animation.ANIMATIONTYPE_VECTOR3:
                        m = g.vector3InterpolateFunction(e[p], n[p], v);
                        break;
                    case BABYLON.Animation.ANIMATIONTYPE_FLOAT:
                        m = g.floatInterpolateFunction(e[p], n[p], v)
                }
                f.unshift({frame: 100 * d,value: m})
            }
            g.setKeys(f), u.push(g)
        }
        if (.1 > r)
            return new i(u, t);
        t.animations = t.animations.concat(u);
        var b = new i(u, t);
        b._callBack = s;
        var w = 100 / 60 / (r / 1e3);
        if (t.getScene().beginAnimation(t, 0, 100, !1, w, b._onAnimationEnd.bind(b)), h) {
            var x = function() {
                ujs.notify("wnp.engine3D.camera.move")
            }, C = t.getScene();
            C.registerBeforeRender(x), b._moreCleanUp = function() {
                C.unregisterBeforeRender(x), x = null
            }
        }
        return b
    }, e
}(), wnp.DragControls = function(t, e, n, i) {
    function o(e) {
        if (m.enabled) {
            e.preventDefault();
            var n = t.createPickingRay(e.clientX, e.clientY);
            if (m.enabled && a) {
                var i, o = n.distanceToPlane(f);
                _xyz.length > 1 ? (i = n.direction.scale(o), i.addInPlace(n.origin), i.subtractInPlace(l)) : (i = n.direction.scale(a.distance), i.addInPlace(n.origin), i.subtractInPlace(l));
                var r = a.pickedMesh.parent ? a.pickedMesh.parent.getWorldMatrix().clone() : BABYLON.Matrix.Identity();
                r.invert(), i = BABYLON.Vector3.TransformCoordinates(i, r), h.copyFrom(a.pickedMesh.position), w && (a.pickedMesh.position.x = i.x), x && (a.pickedMesh.position.y = i.y), C && (a.pickedMesh.position.z = i.z), a.pickedMesh.computeWorldMatrix(!0);
                var s = a.pickedMesh.getFloor();
                return s && s.markAsDirty(), ujs.notify("wnp.engine3d.dragcontrols.start", {selected: a}), M("drag", a), void (u === !1 ? u = 0 : 0 === u && (u = !0))
            }
            ujs.notify("wnp.engine3d.dragcontrols.move"), u = !1
        }
    }
    function r(i) {
        if (m.enabled) {
            if (i.preventDefault(), 0 === i.button) {
                var o = t.createPickingRay(i.clientX, i.clientY), r = o.intersectMeshes(t.meshes, !0, !0);
                if (r && -1 == n.indexOf(r.pickedMesh.getTopLevelObject(d)) && (r = null), r && r.hit) {
                    if (g && -1 === r.pickedMesh.name.indexOf("_girl"))
                        return;
                    console.warn("TODO : moveObject() de l'edition component pour avoir le magnetisme en event"), a = r, a.pickedMesh = a.pickedMesh.getTopLevelObject(d), f = new BABYLON.Plane(0, 1, 0, -a.pickedPoint.y);
                    var s = a.pickedMesh.parent ? a.pickedMesh.parent.getWorldMatrix().clone() : BABYLON.Matrix.Identity(), h = s.clone();
                    return h.invert(), l.copyFrom(BABYLON.Vector3.TransformCoordinates(a.pickedPoint, h)).subtractInPlace(a.pickedMesh.position), l.copyFrom(BABYLON.Vector3.TransformNormal(l, s)), e.style.cursor = "move", M("dragstart", a), void M("mousedown", a)
                }
            }
            M("mousedown", {hit: !1})
        }
    }
    function s(t) {
        if (m.enabled) {
            t.preventDefault();
            var n = !1;
            ujs.notify("wnp.engine3d.dragcontrols.end", {selected: a}), a && 1 == u ? (u = !1, n = !0, M("dragend", a), a = null) : a && (a = null), e.style.cursor = "auto", M("mouseup", {dragged: n})
        }
    }
    var a, n = n || [], l = new BABYLON.Vector3, h = new BABYLON.Vector3, c = (new BABYLON.Vector2, new BABYLON.Vector2), u = !1, p = 1;
    this.GROUPS = 0, this.OBJECTS = 1;
    var d = this.GROUPS, m = this, i = i || {}, g = !1, c = (i.offsets || {x: 0,y: 0}, {width: i.width || e.width,height: i.height || e.height}), f = new BABYLON.Plane(0, 1, 0, 0), y = !1, _ = function() {
        y || (e.addEventListener("pointermove", o, !1), e.addEventListener("pointerdown", r, !1), e.addEventListener("pointerup", s, !1), y = !0)
    }, v = function() {
        y && (e.removeEventListener("pointermove", o), e.removeEventListener("pointerdown", r), e.removeEventListener("pointerup", s), y = !1)
    };
    this.enabled = !0;
    var b = {};
    _(), this.setHardwareScaling = function(t) {
        p = t
    }, this.setDomElement = function(t) {
        v(), e = t, _()
    }, this.setDraggingMode = function(t) {
        d = t
    }, this.startEventsListening = function() {
        _()
    }, this.stopEventListening = function() {
        v()
    }, this.on = function(t, e) {
        return b[t] || (b[t] = []), b[t].push(e), m
    }, this.off = function(t, e) {
        var n = b[t];
        return n ? (n.indexOf(e) > -1 && n.splice(e, 1), m) : m
    }, this.lock = function() {
        g = !0
    }, this.unlock = function() {
        g = !1
    };
    var w, x, C, M = function(t, e, n) {
        var i = b[t];
        if (i && !n)
            for (var o = 0; o < i.length; o++)
                i[o](e)
    };
    w = x = C = !0, this.constrains = function(t) {
        return void 0 === t && (t = "xyz"), _xyz = t, w = x = C = !1, t.indexOf("x") > -1 && (w = !0), t.indexOf("y") > -1 && (x = !0), t.indexOf("z") > -1 && (C = !0), this
    }, this.addDraggable = function(t) {
        t.traverse(function(t) {
            n.push(t)
        })
    }, this.addUnremovableDraggable = function(t) {
        t.traverse(function(t) {
            t._unremovableDraggable = !0, n.push(t)
        })
    }, this.removeDraggable = function(t) {
        var e = -1;
        t.traverse(function(t) {
            t._unremovableDraggable || (e = n.indexOf(t), n.splice(e, 1))
        })
    }, this.resetDraggable = function() {
        var t = this;
        n.forEach(function(e) {
            t.removeDraggable(e)
        })
    }, this.onDocumentResize = function() {
        c = {width: window.innerWidth,height: window.innerHeight}
    }, this.setScreenSize = function(t, e) {
        c = {width: t,height: e}
    }, this.setSelectedObject = function(t) {
        a.pickedMesh = t, l.copyFrom(a.pickedPoint).subtractInPlace(a.pickedMesh.position)
    }, this.reset = function() {
        a = !1
    }, this.refreshReferentPlane = function() {
        var t = 0;
        a && (t = -a.pickedPoint.y), f = new BABYLON.Plane(0, 1, 0, t)
    }
};
var wnp = window.wnp || {};
wnp.Box3 = function() {
    var t = function() {
        this.min = null, this.max = null, this.angle = 0, this.customData = {}
    };
    return t.prototype.center = function() {
        return BABYLON.Vector3.Lerp(this.min, this.max, .5)
    }, t.prototype.serialize = function() {
        var t = ujs.serializeObject(this, !0);
        return t.class = {name: "wnp.Box3"}, t
    }, t.prototype.deserialize = function(t) {
        return this.min = new BABYLON.Vector3(t.min.x, t.min.y, t.min.z), this.max = new BABYLON.Vector3(t.max.x, t.max.y, t.max.z), this.angle = t.angle, this.customData = ujs.deserializeObject(t.customData), this
    }, t.Deserialize = function(e) {
        if (!e)
            return null;
        var n = new t;
        return ujs.deserializeObject(e, this), n
    }, t
}();
var MaterialInfo = function() {
    var t = function(t) {
        this.boundingBox = null, this.normal = null, this.center = null, this.material = t || null, this.customData = null
    };
    return t.prototype.serialize = function() {
        var t = {};
        return t.class = {name: "MaterialInfo"}, ujs.serializeObject(this, t), t
    }, t.prototype.deserialize = function(t) {
        return ujs.deserializeObject(t, this), this
    }, t.Deserialize = function(e) {
        var n = new t;
        return n.deserialize(e)
    }, t.MakeFromPane = function(e, n) {
        var i = new t(n);
        return i.normal = e.normal(), i.center = e.center(), i
    }, t.prototype.matchBestBoundingBox = function(t) {
        if (!this.boundingBox)
            return null;
        for (var e, n = +1 / 0, i = null, o = 0, r = t.length; r > o; o++)
            e = this.boundingBox.match(t[o]), n > e && (n = e, i = o);
        return i
    }, t
}(), wnp = window.wnp || {};
wnp.UI = wnp.UI || {}, wnp.UI.FormBuilder = function() {
    function t(t) {
        t.target.parentNode.children[1].value = this.value
    }
    function e(t) {
        var e = (t.target.parentNode.children[0], +this.min), n = +this.max;
        +this.value > n ? this.value = n : +this.value < e && (this.value = e), t.target.parentNode.children[0].value = this.value
    }
    var n = 0, i = function(t) {
        this.itemsContainer = "string" == typeof t ? document.getElementById(t) : t
    };
    return i.prototype.updateProperties = function(t) {
        this.itemsContainer.innerHTML = "";
        for (var e in t) {
            var n = null;
            switch (t[e].type) {
                case "button":
                    n = this.createButtonItem(t[e].label, t[e].value, t[e].eventParams, t[e].id);
                    break;
                case "buttons":
                    n = this.createButtonsItem(t[e].items, t[e].id);
                    break;
                case "checkbox":
                    n = this.createCheckboxItem(t[e].label, t[e].eventParams, t[e].value, t[e].unit, t[e].id);
                    break;
                case "html":
                    n = this.createHTMLItem(t[e].html);
                    break;
                case "number":
                    n = this.createSliderItem(t[e].label, t[e].eventParams, t[e].value, "number", t[e].unit, t[e].id);
                    break;
                case "radio":
                    n = this.createRadioItem(t[e].label, t[e].eventParams, t[e].groupName, t[e].isSelected, t[e].id);
                    break;
                case "separator":
                    n = this.createSeparatorItem(t[e].label);
                    break;
                case "select":
                    n = this.createSelectItem(t[e].label, t[e].eventParams, t[e].namesValues, t[e].selectedKey);
                    break;
                case "slider":
                    n = this.createSliderItem(t[e].label, t[e].eventParams, t[e].value, "range", t[e].unit, t[e].id);
                    break;
                case "spacer":
                    n = this.createSpacerItem();
                    break;
                case "text":
                case "password":
                    n = this.createInputTextItem(t[e].label, t[e].eventParams, t[e].value, t[e].unit, t[e].type, t[e].id)
            }
            if (null !== n) {
                if (t[e]["class"])
                    for (var i = t[e]["class"].split(" "), o = 0; o < i.length; o++)
                        n.classList.add(i[o]);
                n.setAttribute("id", t[e].id || "item-" + e), this.itemsContainer.appendChild(n)
            }
        }
    }, i.prototype.onItemAction = function() {
        var t = JSON.parse(this.getAttribute("event-params")), e = this.getAttribute("rel");
        this instanceof HTMLInputElement ? t.value = "checkbox" == this.type ? this.checked ? !0 : !1 : "int" == t.cast ? parseInt(this.value, 10) : "float" == t.cast ? parseFloat(this.value) : "bool" == t.cast || "boolean" == t.cast ? this.value ? !0 : !1 : this.value : this instanceof HTMLSelectElement && (t.value = "int" === t.cast ? +this.value : "float" === t.cast ? +this.value : this.value), ujs.notify(e, t)
    }, i.prototype.createSelectItem = function(t, e, i, o) {
        var r = document.createElement("li");
        r.setAttribute("class", "param-item");
        var s = document.createElement("label");
        s.innerHTML = " " + t, r.appendChild(s);
        var a = document.createElement("span");
        a.setAttribute("class", "field");
        var l = document.createElement("select");
        l.setAttribute("event-params", JSON.stringify(e)), l.setAttribute("rel", e.eventName);
        for (var h = null, c = 0, u = i.length; u > c; c++)
            h = document.createElement("option"), h.setAttribute("value", i[c].value), h.innerHTML = i[c].text, l.appendChild(h), i[c].value === o && h.setAttribute("selected", "selected");
        return l.addEventListener("change", this.onItemAction, !1), a.appendChild(l), r.appendChild(a), n++, r
    }, i.prototype.createSliderItem = function(n, i, o, r, s) {
        var r = r || "range";
        o.step = o.step || 1;
        var a = document.createElement("li");
        a.setAttribute("class", "param-item");
        var l = document.createElement("label");
        l.innerHTML = n;
        var h = document.createElement("span");
        h.setAttribute("class", "field");
        var c = document.createElement("input");
        c.setAttribute("type", r), c.setAttribute("min", o.min), c.setAttribute("max", o.max), c.setAttribute("value", o.value), c.setAttribute("step", o.step), c.setAttribute("event-params", JSON.stringify(i)), c.setAttribute("rel", i.eventName);
        var u = "";
        if ("range" == r && (u += " input-range"), s && (u += " unit"), "" != u && c.setAttribute("class", u), "range" == r && c.addEventListener("input", this.onItemAction, !1), c.addEventListener("change", this.onItemAction, !1), c.addEventListener("keydown", function(t) {
            t.stopPropagation()
        }, !1), h.appendChild(c), "range" == r) {
            var p = document.createElement("input");
            p.setAttribute("type", "number"), s && p.setAttribute("class", "unit"), p.setAttribute("min", o.min), p.setAttribute("max", o.max), p.setAttribute("value", o.value), p.setAttribute("step", o.step), p.setAttribute("event-params", JSON.stringify(i)), p.setAttribute("rel", i.eventName), p.addEventListener("change", this.onItemAction, !1), p.addEventListener("blur", e, !1), h.appendChild(p), c.addEventListener("input", t, !1), c.addEventListener("change", t, !1), p.addEventListener("keydown", function(t) {
                t.stopPropagation()
            }, !1)
        }
        var d = document.createElement("span");
        return s && (d.innerHTML = s, d.setAttribute("class", "unit")), h.appendChild(d), a.appendChild(l), a.appendChild(h), a
    }, i.prototype.createInputTextItem = function(t, e, i, o, r, s) {
        var a = document.createElement("li");
        a.setAttribute("class", "param-item");
        var l = document.createElement("label");
        l.setAttribute("for", s || "formBuilderCB_" + n), l.innerHTML = t, a.appendChild(l);
        var h = document.createElement("span");
        h.setAttribute("class", "field");
        var c = document.createElement("input");
        c.setAttribute("id", l.getAttribute("for"));
        var u = "string" == typeof r ? r : "text";
        c.setAttribute("type", u), c.setAttribute("value", i), "function" == typeof e ? c.addEventListener("change", e, !1) : e && (c.setAttribute("event-params", JSON.stringify(e)), c.setAttribute("rel", e.eventName), c.addEventListener("change", this.onItemAction, !1)), c.addEventListener("keydown", function(t) {
            t.stopPropagation()
        }, !1), h.appendChild(c);
        var p = document.createElement("span");
        return o && (p.innerHTML = o, p.setAttribute("class", "unit")), h.appendChild(p), a.appendChild(h), n++, a
    }, i.prototype.createCheckboxItem = function(t, e, i, o, r) {
        var s = document.createElement("li");
        s.setAttribute("class", "param-item");
        var a = document.createElement("label");
        a.setAttribute("for", r || "formBuilderCB_" + n), a.innerHTML = " " + t, s.appendChild(a);
        var l = document.createElement("span");
        l.setAttribute("class", "field");
        var h = document.createElement("input");
        h.setAttribute("type", "checkbox"), h.setAttribute("id", a.getAttribute("for")), h.setAttribute("class", "cb-switch"), i && h.setAttribute("checked", "checked"), "function" == typeof e ? h.addEventListener("click", e, !1) : e && (h.setAttribute("event-params", JSON.stringify(e)), h.setAttribute("rel", e.eventName), h.addEventListener("click", this.onItemAction, !1)), l.appendChild(h);
        var c = document.createElement("span");
        return o && (c.innerHTML = o, c.setAttribute("class", "unit")), l.appendChild(c), s.appendChild(l), n++, s
    }, i.prototype.createButtonItem = function(t, e, i, o, r) {
        var s = document.createElement("li");
        s.setAttribute("class", "param-item");
        var a = document.createElement("label");
        a.setAttribute("for", r || "formBuilderBT_" + n), a.innerHTML = t, s.appendChild(a);
        var l = document.createElement("span");
        l.setAttribute("class", "field");
        var h = document.createElement("button");
        h.innerHTML = e, h.setAttribute("id", a.getAttribute("for")), h.setAttribute("event-params", JSON.stringify(i)), h.setAttribute("rel", i.eventName), "function" == typeof i ? h.addEventListener("click", i, !1) : i && h.addEventListener("click", this.onItemAction, !1), l.appendChild(h);
        var c = document.createElement("span");
        return o && (c.innerHTML = o, c.setAttribute("class", "unit")), l.appendChild(c), s.appendChild(l), n++, s
    }, i.prototype.createButtonsItem = function(t) {
        var e = document.createElement("li");
        e.setAttribute("class", "param-item");
        var n = t.length, i = document.createElement("label");
        i.innerHTML = " " + labelParams, e.appendChild(i);
        var o = document.createElement("span");
        o.setAttribute("class", "field");
        var r = document.createElement("div");
        r.setAttribute("class", "stacked_" + n), o.appendChild(r);
        for (var s = 0, a = n; a > s; s++) {
            var l = document.createElement("button");
            l.innerHTML = t[s].value, l.setAttribute("event-params", JSON.stringify(t[s].eventParams)), l.setAttribute("rel", t[s].eventParams.eventName), l.addEventListener("click", this.onItemAction, !1), r.appendChild(l)
        }
        var h = document.createElement("span");
        return unit && (h.innerHTML = unit, h.setAttribute("class", "unit")), o.appendChild(h), e.appendChild(o), e
    }, i.prototype.createSpacerItem = function() {
        var t = this.createHTMLItem("");
        return t.children[0].setAttribute("class", "spacer"), t
    }, i.prototype.createHTMLItem = function(t) {
        var e = document.createElement("li");
        e.setAttribute("class", "param-item");
        var n = document.createElement("div");
        return n.innerHTML = t, e.appendChild(n), e
    }, i.prototype.createSeparatorItem = function(t) {
        var e = document.createElement("li");
        e.setAttribute("class", "separator");
        var n = document.createElement("label");
        n.innerHTML = "undefined" != typeof t ? t : "", e.appendChild(n);
        var i = document.createElement("span");
        i.setAttribute("class", "field"), e.appendChild(i);
        var o = document.createElement("hr");
        return i.appendChild(o), e
    }, i.prototype.createRadioItem = function(t, e, i, o, r) {
        var s = document.createElement("li");
        s.setAttribute("class", "param-item");
        var a = document.createElement("label");
        a.setAttribute("for", r || "formBuilderRD_" + n), a.innerHTML = t, s.appendChild(a);
        var l = document.createElement("span");
        l.setAttribute("class", "field");
        var h = document.createElement("input");
        return h.setAttribute("id", a.getAttribute("for")), h.setAttribute("name", i), h.setAttribute("type", "radio"), o && h.setAttribute("checked", "checked"), "function" == typeof e ? h.addEventListener("click", e, !1) : e && (h.addEventListener("click", this.onItemAction, !1), h.setAttribute("rel", e.eventName), h.setAttribute("event-params", JSON.stringify(e))), l.appendChild(h), s.appendChild(l), n++, s
    }, i
}();
var wnp = window.wnp || {};
wnp.UI = wnp.UI || {}, wnp.UI.Frame = function() {
    function t(t) {
        if (t.touches && t.touches.length) {
            t.preventDefault();
            var e = t.touches[0];
            t.x = e.x || e.screenX || e.pageX || e.clientx, t.y = e.y || e.screenY || e.pageY || e.clientY
        }
        return t
    }
    function e(t) {
        var e = t.target.getAttribute("rel");
        "" != e && ujs.notify(e)
    }
    function n(t, e, n) {
        var i = document.createElement(t);
        return n && i.setAttribute("id", n), e && i.setAttribute("class", e), i
    }
    var i = function(t, e, n) {
        this.activeTab = 0, this.eventStarted = !1, this.config = t || {}, this.content = e || {}, this.parentNode = n || document.getElementById("modalWidgets") || document.body, this.domElement = null, this.mouseState = {x: 0,y: 0,prevX: 0,prevY: 0,deltaX: 0,deltaY: 0,click: !1}, this.windowPosition = {x: 0,y: 0}, this.menuDOM = document.getElementById("mainMenu"), this.windowSize = {width: this.config.width || 640,height: this.config.height || 480,maxWidth: this.config.maxWidth || 1980,maxHeight: this.config.maxHeight || 1080,minWidth: this.config.minWidth || 320,minHeight: this.config.minHeight || 240}, this.formBuilder = new wnp.UI.FormBuilder, this.initialized = !1
    };
    return i.prototype.initialize = function() {
        this.initialized || (this.buildHTML(), this.adapteSize(), this.initializeEvents(), this.parentNode.appendChild(this.domElement), this.initialized = !0)
    }, i.prototype.resetSize = function(t) {
        this.windowSize = {width: t.width || 640,height: t.height || 480}, t.autoSize ? (this.domElement.style.removeProperty("width"), this.domElement.style.removeProperty("height")) : (this.domElement.style.width = this.windowSize.width + "px", this.domElement.style.height = this.windowSize.height + "px")
    }, i.prototype.adapteSize = function() {
        this.windowSize.width = Math.min(this.windowSize.width, this.windowSize.maxWidth), this.windowSize.height = Math.min(this.windowSize.height, this.windowSize.maxHeight), this.windowSize.width = Math.max(this.windowSize.width, this.windowSize.minWidth), this.windowSize.height = Math.max(this.windowSize.height, this.windowSize.minHeight), this.config.autoSize || (this.domElement.style.width = this.windowSize.width + "px", this.domElement.style.height = this.windowSize.height + "px")
    }, i.prototype.buildHeaderTitle = function(t) {
        if (this.headerTitle.innerHTML = "", this.config.headerIcon) {
            var e = n("img", "window-title-icon");
            e.setAttribute("src", this.config.headerIcon), this.headerTitle.appendChild(e)
        }
        var i = n("span", "window-title-text");
        i.innerHTML = t || "Title", this.headerTitle.appendChild(i)
    }, i.prototype.buildHTML = function() {
        var t = this.config.layout || "horizontal";
        this.domElement = n("div", "window"), this.header = n("header", "window-title"), this.closeWindow = n("span", "window-close"), this.config.showCloseButton === !1 && (this.closeWindow.style.display = "none"), this.header.appendChild(this.closeWindow), this.headerTitle = n("h1"), this.buildHeaderTitle(this.content.title), this.header.appendChild(this.headerTitle), this.domElement.appendChild(this.header), this.mainContent = n("div", "window-content"), this.domElement.appendChild(this.mainContent), this.tabsContainer = n("div", "tabbed " + t), this.tabs = n("ul", "tabbed-tabs"), this.tabsContainer.appendChild(this.tabs), this.tabContent = n("div", "tabbed-tabcontent"), this.tabsContainer.appendChild(this.tabContent), this.mainContent.appendChild(this.tabsContainer), this.actionBar = n("div", "window-action-bar"), this.domElement.appendChild(this.actionBar)
    }, i.prototype.setTitle = function(t) {
        this.headerTitle.innerHTML = t
    }, i.prototype.setContent = function(t, e) {
        var e = "number" == typeof e ? e : 0;
        e = e >= this.tabs.children.length ? this.tabs.children.length - 1 : e, t instanceof HTMLElement ? (this.tabContent.children[e].innerHTML = "", this.tabContent.children[e].appendChild(t)) : this.tabContent.children[e].innerHTML = t
    }, i.prototype.addTab = function(t, e, i, o) {
        var r = n("li");
        r.addEventListener("click", this.onTabClick.bind(this), !1), r.setAttribute("rel", "tab-" + this.tabs.children.length);
        var s = n("span", "tab-text");
        if (s.innerHTML = t, r.appendChild(s), e) {
            var a = n("span", "tab-icon"), e = n("img", "tab-icon");
            e.setAttribute("src", e), a.appendChild(e), r.appendChild(a)
        }
        this.tabs.appendChild(r);
        var l = n("section", "tab-content-" + (this.tabs.children.length - 1));
        i instanceof HTMLElement ? l.appendChild(i) : l.innerHTML = i, this.tabContent.appendChild(l)
    }, i.prototype.setLayout = function(t) {
        this.domElement.classList.remove("horizontal", "vertical"), this.domElement.classList.add(t)
    }, i.prototype.clear = function(t) {
        var t = t || {tabs: !0,content: !0,actionBar: !0};
        t.tabs && (this.tabs.innerHTML = ""), t.content && (this.tabContent.innerHTML = ""), t.actionBar && (this.actionBar.innerHTML = "")
    }, i.prototype.addForm = function(t, e, i) {
        if (!this.tabContent.children.length || this.tabContent.children.length <= t) {
            var i = i || "Tab " + this.tabContent.children.length;
            this.addTab(i, void 0, void 0, !0), t = this.tabs.children.length - 1
        }
        var o = this.tabContent.children[t];
        o.innerHTML = "";
        var r = n("ul");
        o.appendChild(r), this.formBuilder.itemsContainer = r, this.formBuilder.updateProperties(e)
    }, i.prototype.setActionBar = function(t) {
        if (this.actionBar.children.length)
            for (var i = this.actionBar.children.length - 1; i > 0; i--)
                this.actionBar.children[i].removeEventListener("click", e), this.actionBar.removeChild(this.actionBar.children[i]);
        if ("string" == typeof element)
            this.actionBar.innerHTML = t;
        else
            for (var i = 0, o = t.length; o > i; i++) {
                var r = n("button");
                r.innerHTML = t[i].label, "function" != typeof t[i].action ? (r.setAttribute("rel", t[i].action), r.addEventListener("click", e, !1)) : (r.setAttribute("rel", ""), r.addEventListener("click", t[i].action, !1)), t[i].title && r.setAttribute("title", t[i].title), t[i]["class"] && r.setAttribute("class", t[i]["class"]), this.actionBar.appendChild(r)
            }
        this.domElement.classList.add("window-with-button")
    }, i.prototype.showContent = function(t) {
        this.tabs.children[this.activeTab] && (this.tabs.children[this.activeTab].classList.remove("active"), this.tabContent.children[this.activeTab].classList.remove("active")), this.activeTab = t, this.activeTab = this.tabs.children[this.activeTab] ? this.activeTab : 0, this.tabs.children[this.activeTab].classList.add("active"), this.tabContent.children[this.activeTab].classList.add("active")
    }, i.prototype.show = function(t, e) {
        this.initialize(), this.domElement.style.display = "block", this.tabs.children.length < 2 ? this.tabsContainer.classList.add("notab") : this.tabsContainer.classList.remove("notab"), this.showContent(this.activeTab), "undefined" != typeof t && "undefined" != typeof e ? (t + this.domElement.offsetWidth > window.innerWidth && (t = window.innerWidth - this.domElement.offsetWidth - 5, 0 > t && (t = 0)), e + this.domElement.offsetHeight > window.innerHeight && (e = window.innerHeight - this.domElement.offsetHeight - 5, 0 > e && (e = 0)), this.setPosition(t, e)) : this.centerWindow()
    }, i.prototype.close = function() {
        ujs.notify("wnp.ui.frame.close"), this.domElement.style.display = "none"
    }, i.prototype.centerWindow = function() {
        this.windowPosition.x = (window.innerWidth - this.menuDOM.offsetWidth) / 2 - this.windowSize.width / 2, this.windowPosition.y = window.innerHeight / 2 - this.windowSize.height / 2, this.domElement.style.position = "absolute", this.config.autoSize || (this.domElement.style.width = this.windowSize.width + "px", this.domElement.style.height = this.windowSize.height + "px"), this.domElement.style.top = this.windowPosition.y + "px", this.domElement.style.left = this.windowPosition.x + "px"
    }, i.prototype.setPosition = function(t, e) {
        this.windowPosition.x = t, this.windowPosition.y = e, this.domElement.style.top = this.windowPosition.y + "px", this.domElement.style.left = this.windowPosition.x + "px"
    }, i.prototype.resetMouseState = function() {
        this.mouseState.click = !1, this.mouseState.prevX = 0, this.mouseState.prevY = 0, this.mouseState.x = 0, this.mouseState.y = 0, this.mouseState.deltaX = 0, this.mouseState.deltaY = 0
    }, i.prototype.onHeaderMouseDown = function(e) {
        t(e), this.mouseState.click = !0, this.mouseState.x = e.x || e.screenX, this.mouseState.y = e.y || e.screenY
    }, i.prototype.onHeaderMouseUp = function() {
        this.resetMouseState()
    }, i.prototype.onHeaderMouseMove = function(e) {
        this.mouseState.click && (t(e), this.mouseState.prevX = this.mouseState.x, this.mouseState.prevY = this.mouseState.y, this.mouseState.x = e.x || e.screenX || this.mouseState.prevX, this.mouseState.y = e.y || e.screenY || this.mouseState.prevY, this.mouseState.deltaX = this.mouseState.x - this.mouseState.prevX, this.mouseState.deltaY = this.mouseState.y - this.mouseState.prevY, this.windowPosition.x += this.mouseState.deltaX, this.windowPosition.y += this.mouseState.deltaY, this.domElement.style.top = this.windowPosition.y + "px", this.domElement.style.left = this.windowPosition.x + "px")
    }, i.prototype.initializeEvents = function() {
        this.eventStated || (this.closeWindow.addEventListener("click", this.close.bind(this), !1), this.closeWindow.addEventListener("touchstart", this.close.bind(this), !1), this.header.addEventListener("mousedown", this.onHeaderMouseDown.bind(this), !1), document.body.addEventListener("mouseup", this.onHeaderMouseUp.bind(this), !1), document.body.addEventListener("mousemove", this.onHeaderMouseMove.bind(this), !1), this.header.addEventListener("touchstart", this.onHeaderMouseDown.bind(this), !1), document.body.addEventListener("touchmove", this.onHeaderMouseMove.bind(this), !1), document.body.addEventListener("touchend", this.onHeaderMouseUp.bind(this), !1), document.body.addEventListener("touchcancel", this.onHeaderMouseUp.bind(this), !1), document.addEventListener("wnp.request.closePopup", this.close.bind(this), !1), this.eventStated = !0)
    }, i.prototype.onTabClick = function(t) {
        var e = t.target.parentNode;
        t.target.classList.contains("counter") ? e = t.target.parentNode.parentNode : "LI" == t.target.nodeName && (e = t.target);
        var n = e.getAttribute("rel").split("-")[1];
        n != this.activeTab && this.showContent(n)
    }, i.prototype.getDivNode = function(t) {
        var e = t;
        return "DIV" != e.nodeName && (e = this.getDivNode(t.parentNode)), e
    }, i
}();
var wnp = window.wnp || {};
wnp.UI = wnp.UI || {}, wnp.UI.ProductList = function() {
    function t(e) {
        var n = {};
        for (var i in e)
            n[i] = e[i] instanceof Object ? t(e[i]) : e[i];
        return n
    }
    var e = null, n = [], i = [], o = !1, r = function(t, n) {
        wnp.UI.Frame.call(this, {layout: "vertical",headerIcon: "images/productIconTitle.png"}, {title: _("Products list")}), this.windowSize.maxWidth = window.innerWidth, this.windowSize.maxHeight = window.innerHeight, this.windowSize.width = (window.innerWidth - this.menuDOM.offsetWidth) / 1.5, this.windowSize.height = window.innerHeight / 1.5, _randomGET = n, this.core = t, null == e && (e = this, e.initProductList(function() {
            o = !0
        }), e.initialize())
    };
    return r.prototype = new wnp.UI.Frame, r.prototype.initialize = function() {
        wnp.UI.Frame.prototype.initialize.call(this), this.domElement.setAttribute("id", "productList")
    }, r.prototype.initProductList = function(t) {
        var t = t || function() {
        };
        ujs.ajax({method: "GET",url: [wnp.Constants.PRODUCTS_FILE, "?t=", _randomGET].join(""),success: function(i) {
                n = JSON.parse(i), t.call(e)
            }})
    }, r.prototype.addProduct = function(t, e) {
        var n = document.createElement("div");
        n.setAttribute("class", "product-item"), n.setAttribute("rel", t.id);
        var i = "models/previews/productsPlaceholder.png";
        t.preview && (i = wnp.Constants.PRODUCTS_PREVIEWS + t.preview);
        var o = document.createElement("span");
        o.setAttribute("class", "selected"), o.innerHTML = _("Added"), n.appendChild(o);
        var r = document.createElement("span");
        r.setAttribute("class", "product-item-image");
        var s = document.createElement("img");
        s.setAttribute("src", i), r.addEventListener("click", this.onMenuItemButtonClick, !1), r.appendChild(s), n.appendChild(r);
        var a = document.createElement("span");
        a.setAttribute("class", "product-item-description"), a.setAttribute("rel", [t.action, "_", t.id].join(""));
        var l = t.translations ? _(t.title, t.translations) : _(t.title);
        a.innerHTML = l, n.appendChild(a), e.appendChild(n)
    }, r.prototype.loadProducts = function(t, r, s) {
        if (o === !0) {
            r.innerHTML = "";
            for (var a in n)
                if (n[a].id == t) {
                    i = n[a].items;
                    for (var l = 0; l < i.length; l++)
                        e.addProduct(i[l], r);
                    e.getTabsForFilters(s)
                }
        } else
            e.initProductList(function() {
                o = !0, e.loadProducts(t, r, s), e.show()
            })
    }, r.prototype.getTabsForFilter = function(t) {
        var n = t.split(":")[1] ? t.split(":")[1] : null, t = t.split(":")[0], o = {};
        n && (o[n] = document.createElement("div"));
        for (var r in i) {
            var s = i[r], a = s.params ? JSON.parse(s.params.params) || {} : {}, l = ujs.getProperty(a, t);
            l && -1 == Object.keys(o).indexOf(l.toString()) && (o[l] = document.createElement("div")), l ? e.addProduct(s, o[l]) : e.addProduct(s, o[n])
        }
        for (var h in o)
            e.addTab(_(t) + " " + h, null, o[h], !0)
    }, r.prototype.getTabsForFilters = function(t) {
        if (t)
            for (var e = t.split(","), n = 0; n < e.length; n++)
                this.getTabsForFilter(e[n])
    }, r.prototype.reinitContent = function(t) {
        e.tabs.innerHTML = "", e.tabContent.innerHTML = "";
        var n = document.createElement("div");
        n.innerHTML = _("Loading ..."), e.addTab("", null, "", !0), e.addTab(_("all"), null, n, !0), e.loadProducts(t.id, n, t.filter), e.showContent(1)
    }, r.show = function(t, n, i) {
        var i = i || {};
        null === e && (e = new wnp.UI.ProductList(t, n)), e.reinitContent(i), e.buildHeaderTitle(e.content.title + " > " + i.name), e.show()
    }, r.close = function() {
        null !== e && e.close()
    }, r.prototype.close = function() {
        ujs.notify("wnp.ui.frame.close"), this.domElement.style.display = "none", ujs.notify("wnp.menu.main.deselect")
    }, r.prototype.onMenuItemButtonClick = function(n) {
        var o = e.getDivNode(n.target), r = o.getAttribute("rel"), s = i[0], a = o.children[0];
        a.classList.add("show");
        for (var l = setInterval(function() {
            a.classList.remove("show"), clearInterval(l)
        }, 1500), h = 0; h < i.length; h++)
            r == i[h].id && (s = t(i[h]));
        var c = s.action, u = s.type, p = s.params, d = r;
        "" != c && "string" == typeof u && ujs.notify(c, {objectId: d,objectType: u,objectParams: p}, !0)
    }, r
}();
var wnp = window.wnp || {};
wnp.UI = wnp.UI || {}, wnp.UI.ContextMenu = function() {
    var t = null, e = !1, n = null, i = {x: !1,y: !1}, o = function(e) {
        var e = e || {};
        e.autoSize = e.autoSize === !1 ? !1 : !0, wnp.UI.Frame.call(this, e), null == t && (t = this)
    };
    return o.prototype = new wnp.UI.Frame, o.prototype.initialize = function() {
        wnp.UI.Frame.prototype.initialize.call(this), this.domElement.id = "contextMenu"
    }, o.prototype.show = function(t, n, i, o) {
        wnp.UI.Frame.prototype.show.call(this, t, n), this.menuName = i, e = !0, ujs.notify("wnp.widget.contextMenu.opened"), ujs.notify("wnp.widget.contextMenu." + this.menuName + ".opened", o)
    }, o.prototype.close = function() {
        e && (wnp.UI.Frame.prototype.close.call(this), e = !1, null !== n && (clearInterval(n), n = null), i = {x: this.windowPosition.x,y: this.windowPosition.y}, ujs.notify("wnp.widget.contextMenu.closed"), ujs.notify("wnp.widget.contextMenu." + this.menuName + ".closed"))
    }, o.isOpen = function() {
        return e
    }, o.show = function(o, r, s, a, l) {
        var o = o || {};
        o.width = o.width || 250, o.height = o.height || !1, o.x = o.x || i.x || window.innerWidth / 2 - o.width / 2, o.y = o.y || i.y || window.innerHeight / 2 - o.height / 2, o.title = o.title || "Paramètres", o.layout = o.layout || "horizontal", o.autoSize = o.autoSize === !1 ? !1 : !0;
        var h = o.menuName || o.title.replace(/ /g, "_");
        null == t && (t = new wnp.UI.ContextMenu(o, {title: o.title}), t.initialize()), o.id && t.domElement.setAttribute("id", o.id);
        var c = function() {
            t.clear(), t.setTitle(o.title);
            for (var e = 0, n = r.length; n > e; e++)
                t.addForm(e, r[e].content, r[e].title);
            s && t.setActionBar(s), o.showIndex > -1 && t.showContent(o.showIndex), t.setLayout(o.layout || "horizontal"), t.resetSize(o), t.show(o.x, o.y, h, l)
        };
        "number" == typeof a ? n = setTimeout(function() {
            c(), clearTimeout(n), n = null
        }, a) : c(), e = !0
    }, o.close = function() {
        null !== t && (i = {x: t.windowPosition.x,y: t.windowPosition.y}, t.close(), e = !1)
    }, o.setPosition = function(e, n) {
        null !== t && t.setPosition(e, n)
    }, o.getPosition = function() {
        return null === t ? null : {x: t.windowPosition.x,y: t.windowPosition.y}
    }, o.update = function(e) {
        if (null === t)
            return null;
        for (var n = e.length; n--; )
            for (var i = e[n].content.length; i--; ) {
                var o = e[n].content[i];
                if (o)
                    switch (o.type) {
                        case "number":
                        case "text":
                        case "checkbox":
                        case "slider":
                            var r = t.domElement.querySelectorAll("li#" + o.id + ".param-item");
                            if (!r || 1 != r.length)
                                continue;
                            r = r[0];
                            for (var s = r.querySelectorAll("input"), a = "object" == typeof o.value ? o.value.value : o.value, l = s.length; l--; )
                                s[l].value = a
                    }
            }
    }, o
}();
var wnp = window.wnp || {};
wnp.UI = wnp.UI || {}, wnp.UI.AboutWindow = function() {
    var t = function() {
        var t = {minWidth: 500};
        t.autoSize = t.autoSize === !1 ? !1 : !0, wnp.UI.Frame.call(this, t), this.initialize(), this.domElement.setAttribute("id", "aboutWindow"), this.setTitle(_("About Wanaplan")), this.close();
        var e = '<div style="width: 432px; text-align: center;"><img src="./images/wanaplan-logo.png" alt="Wanaplan" /></div>';
        e += '<div style="text-align: center; font-size: 16pt; font-weight: bold; margin-top: 15px; color: #333;">Wanaplan ' + wanaplan.version + "</div>", e += '<div style="text-align: center; margin-top: 30px; color: #555;">Copyright © 2012-2014 Wanadev, all rights reserved.</div>', e += '<div style="text-align: center; margin-top: 10px;"><a href="http://www.wanadev.fr/" target="_blank">www.wanadev.fr</a> / <a href="http://www.wanaplan.com/" target="_blank">www.wanaplan.com</a></div>', this.addTab(_("About"), null, e, !0), e = '<div class="scrollable-content" style="width: 410px; max-height: 300px; min-height: 100px; font-size: 9pt;"><ul>', e += '<li><strong>"seamless" textures:</strong><dl><dt>Author:</dt><dd>~hhh316 Giles</dd><dt>License:</dt><dd>cc-by 3.0</dd><dt>Downloaded from:</dt><dd><a href="http://seamless-pixels.blogspot.fr/"> http://seamless-pixels.blogspot.fr/</a></dd></dl></li>', e += '<li><strong>Babylonjs engine:</strong><dl><dt>Authors:</dt><dd>David Catuhe & David Rousset</dd><dt>Licence:</dt><dd>Apache License 2.0</dd><dt>Homepage:</dt><dd><a href="http://www.babylonjs.com">http://www.babylonjs.com</a></dd></dl></li>', e += "</ul></div>", this.addTab(_("Credits"), null, e, !0), this.setActionBar([{label: _("Close"),action: function() {
                    this.close()
                }.bind(this)}]), document.addEventListener("wnp.ui.showAboutWindow", function() {
            this.show(), ujs.notify("wnp.menu.top.deselect")
        }.bind(this), !1)
    };
    return t.prototype = new wnp.UI.Frame, t
}();
var wnp = window.wnp || {};
wnp.UI = wnp.UI || {}, wnp.UI.BackgroundPopup = function() {
    function t(t, e, n) {
        var i = document.createElement(t);
        return n && i.setAttribute("id", n), e && i.setAttribute("class", e), i
    }
    function e(t) {
        if (!t.hasOwnProperty("offsetX")) {
            var e = curtop = 0;
            if (t.currentTarget) {
                var n = t.currentTarget;
                do
                    e += n.offsetLeft, curtop += n.offsetTop;
                while (n = n.offsetParent)
            }
            t.offsetX = t.clientX - e, t.offsetY = t.clientY - curtop
        }
        return t
    }
    var n, i = null, o = 100, r = !0, s = 560, a = 320, l = 1, h = new BABYLON.Vector2(0, 0), c = new BABYLON.Vector2(0, 0), u = !1, p = 1, d = [new BABYLON.Vector2(10, 10), new BABYLON.Vector2(100, 10)], m = function(t) {
        var t = t || {};
        t.autoSize = t.autoSize === !1 ? !1 : !0, t.width = 600, t.height = 540, wnp.UI.Frame.call(this, t)
    };
    return m.prototype = new wnp.UI.Frame, m.prototype.buildHTML = function() {
        this.config.layout || "horizontal";
        this.domElement = t("div", "window", "backgroundPopup"), this.header = t("header", "window-title"), this.closeWindow = t("span", "window-close"), this.config.showCloseButton === !1 && (this.closeWindow.style.display = "none"), this.header.appendChild(this.closeWindow), this.headerTitle = t("h1");
        var e = t("span", "window-title-text");
        e.innerHTML = this.content.title || _("Choose and set background"), this.headerTitle.appendChild(e), this.header.appendChild(this.headerTitle), this.domElement.appendChild(this.header), this.mainContent = t("div", "window-content window-content-background"), this.domElement.appendChild(this.mainContent), i.setPosition((window.innerWidth - this.windowSize.width) / 2, (window.innerHeight - this.windowSize.height) / 2), this.domElement.style.width = this.windowSize.width + "px", this.domElement.style.height = this.windowSize.height + "px";
        var n = wanaplan.structure.params.gridBackground || {};
        o = n.scale || o, n.translation && BABYLON.Vector2.FromArrayToRef(n.translation, 0, h), n.points && (BABYLON.Vector2.FromArrayToRef(n.points[0], 0, d[0]), BABYLON.Vector2.FromArrayToRef(n.points[1], 0, d[1])), (!d[1] || BABYLON.Vector2.Distance(d[0], d[1]) < 90) && (d[1] = d[0].add(new BABYLON.Vector2(100, 0))), this.mainCanvas = t("canvas", "window-canvas"), this.mainCanvas.style.background = "white", this.mainCanvas.width = s, this.mainCanvas.style.width = s + "px", this.mainCanvas.height = a, this.mainCanvas.style.height = a + "px", this.mainCtx = this.mainCanvas.getContext("2d");
        var r = function(t, e) {
            i.onMouseEvent(t, e)
        };
        this.pointerManager = new wnp.PointerManager(void 0, r, this.mainCanvas)
    }, m.prototype.onMouseEvent = function(t, e) {
        e.actions == e.ACTION_DRAGSTART ? i.onCanvasMouseDown(t) : e.actions == e.ACTION_DRAGGING ? i.onCanvasDrag(t, e) : e.actions == e.ACTION_SCROLLDOWN ? (l -= .04, l = .6 > l ? .6 : l) : e.actions == e.ACTION_SCROLLUP && (l += .04, l = l > 6 ? 6 : l), i.updateCtx()
    }, m.prototype.onCanvasDrag = function(t, e) {
        if (1 === u || 0 === u) {
            var n = e.posDelta.scaleInPlace(1 / l), o = d[u].add(n);
            BABYLON.Vector2.Distance(o, d[0 == u ? 1 : 0]) > 10 && (d[u] = o)
        } else
            2 === u ? (d[0].addInPlace(e.posDelta.clone().scaleInPlace(1 / l)), d[1].addInPlace(e.posDelta.clone().scaleInPlace(1 / l))) : h.addInPlace(e.posDelta);
        i.updateCtx(), i.updateGrid()
    }, m.prototype.onCanvasMouseDown = function(t) {
        e(t), c.x = t.offsetX, c.y = t.offsetY, c.subtractInPlace(h), c.scaleInPlace(1 / l), u = BABYLON.Vector2.Distance(c, d[0]) < 10 ? 0 : BABYLON.Vector2.Distance(c, d[1]) < 10 ? 1 : BABYLON.Vector2.Distance(c, d[1].clone().lerp(d[0], .5)) < 10 ? 2 : 3
    }, m.prototype.updateGrid = function() {
        var t = +o, e = 1 / p * BABYLON.Vector2.Distance(d[0], d[1]), i = t / e;
        ujs.notify("wnp.engine2d.backgroundChange", {scale: i,measure: t,visibility: r,img: n,translation: h,points: d})
    }, m.prototype.updateCtx = function() {
        var t = i.mainCtx;
        t.clearRect(0, 0, s, a), t.save(), p = Math.min(s / n.realWidth, a / n.realHeight), t.scale(p * l, p * l), t.translate(h.x / (p * l), h.y / (p * l)), t.drawImage(n, 0, 0);
        Math.round(BABYLON.Vector2.Distance(d[0], d[1]));
        t.restore(), t.save(), t.scale(l, l), t.translate(h.x / l, h.y / l), wanaplan.engine2D.symbols2D.drawMeasure(t, d[0], d[1], o + "cm", "#6E910F"), t.restore()
    }, m.close = function() {
        i && i.close()
    }, m.show = function() {
        if (null == i) {
            i = new wnp.UI.BackgroundPopup({}, {title: _("Choose Background")}), i.initialize();
            var e = t("input", "", "file");
            e.setAttribute("type", "file");
            var r = t("input", "", "scale");
            r.setAttribute("style", "width:100px"), cb = t("input"), cb.setAttribute("type", "checkbox"), cb.setAttribute("checked", "checked"), cb.addEventListener("click", i.handleVisibility, !1), r.addEventListener("change", i.handleScale, !1), r.setAttribute("value", o), e.addEventListener("change", i.handleFileSelect, !1);
            var l = t("div", "warning");
            l.innerHTML = _("Note: your jpg/png won't be saved, and won't be reloaded after use");
            var h = t("div");
            h.innerHTML = "<strong>" + _("Step") + " 1</strong>: " + _("Select your file (jpg, png)") + "  ", h.appendChild(e);
            var c = t("div");
            c.innerHTML = "<strong>" + _("Step") + " 2</strong>: " + _("Drag the arrow and enter the corresponding measure (in cm)") + " ", c.appendChild(r);
            var u = t("div");
            u.innerHTML = "<strong>" + _("Step") + " 3</strong>: " + _("Enable / Disable background"), u.appendChild(cb), i.mainContent.appendChild(l), i.mainContent.appendChild(h), i.mainContent.appendChild(c), n = new Image, n.src = "data:image/gif;base64,R0lGODlhAQABAIAAAP7//wAAACH5BAAAAAAALAAAAAABAAEAAAICRAEAOw==", n.realWidth = s, n.realHeight = a, i.mainContent.appendChild(i.mainCanvas), i.mainContent.appendChild(u)
        }
        i.show()
    }, m.prototype.updateImgSize = function() {
        var t = new Image;
        t.src = n.src, t.setAttribute("style", "position:absolute;top:-1000000000px"), i.mainContent.appendChild(t), t.onload = function() {
            n.realWidth = t.width, n.realHeight = t.height, i.updateCtx(), i.updateGrid(), t.parentNode.removeChild(t), delete t
        }
    }, m.prototype.handleVisibility = function(t) {
        r = t.target.checked ? !0 : !1, i.updateGrid()
    }, m.prototype.handleScale = function(t) {
        o = t.target.value, i.updateGrid(), i.updateCtx()
    }, m.prototype.handleFileSelect = function(t) {
        var e = t.target.files, o = e[0], r = new FileReader;
        r.readAsDataURL(o), r.onloadend = function() {
            n.src = r.result, i.updateImgSize(), i.updateCtx()
        }
    }, m.prototype.show = function() {
        this.initialize(), this.domElement.style.display = "block"
    }, m.prototype.close = function() {
        ujs.notify("wnp.ui.frame.close"), this.domElement.style.display = "none", ujs.notify("wnp.menu.main.deselect")
    }, m
}();
var wnp = window.wnp || {};
wnp.UI = wnp.UI || {}, wnp.UI.ColorPopup = function() {
    function t(t, e, n) {
        var i = document.createElement(t);
        return n && i.setAttribute("id", n), e && i.setAttribute("class", e), i
    }
    var e = null, n = {}, i = 0, o = function() {
    }, r = function(t) {
        var t = t || {};
        t.autoSize = t.autoSize === !1 ? !1 : !0, t.width = 215, t.height = 200, wnp.UI.Frame.call(this, t)
    };
    return r.prototype = new wnp.UI.Frame, r.prototype.addColorItems = function(e) {
        for (var n, o, r = 0; r < e.length; r++)
            n = e[r].params.color, o = t("div", "luxens"), r == i && o.classList.add("selected"), o.setAttribute("rel", r), o.style.backgroundColor = "rgb(" + Math.round(255 * n.r) + "," + Math.round(255 * n.g) + "," + Math.round(255 * n.b) + ")", this.mainContent.appendChild(o), o.addEventListener("click", this.onItemClick, !1)
    }, r.prototype.onItemClick = function(t) {
        e.close(), i = t.target.getAttribute("rel"), o && o.call(this, i, n[i].params.color), ujs.notify("wnp.core.colorSelected", {id: i,color: n[i].params.color})
    }, r.prototype.buildHTML = function() {
        this.config.layout || "horizontal";
        this.domElement = t("div", "window", "colorPopup"), this.header = t("header", "window-title"), this.closeWindow = t("span", "window-close"), this.config.showCloseButton === !1 && (this.closeWindow.style.display = "none"), this.header.appendChild(this.closeWindow), this.headerTitle = t("h1");
        var i = t("span", "window-title-text");
        i.innerHTML = this.content.title || _("Colors"), this.headerTitle.appendChild(i), this.header.appendChild(this.headerTitle), this.domElement.appendChild(this.header), this.mainContent = t("div", "window-content"), n = LuxensComponent3D.getLuxens(), this.addColorItems(n), this.domElement.appendChild(this.mainContent), e.setPosition(window.innerWidth - this.windowSize.width - 260, 0), this.domElement.style.width = this.windowSize.width + "px", this.domElement.style.height = window.innerHeight + "px"
    }, r.show = function(t, r) {
        null == e && (e = new wnp.UI.ColorPopup({}, {title: _("colors")}), e.initialize()), i = r || i, e.mainContent.innerHTML = "", e.addColorItems(n), o = t || function() {
        }, e.show()
    }, r.prototype.show = function() {
        this.initialize(), this.domElement.style.display = "block"
    }, r
}();
var wnp = window.wnp || {};
wnp.UI = wnp.UI || {}, wnp.UI.HelpBubble = function() {
    var t = function() {
        this._isVisible = !1, this._e_bubble = document.getElementById("helpbubble"), this._e_image = document.getElementById("helpbubble-image"), this._e_content = document.getElementById("helpbubble-content"), this._image = "", this._content = "", document.getElementById("helpbubble-close").onclick = this.hide.bind(this)
    };
    return t.prototype.newBubble = function(t, e, n) {
        t && (this._image = t), e && (this._content = e), n && this.show()
    }, t.prototype.show = function() {
        this._isVisible ? (this.hide(), window.setTimeout(this.show.bind(this), 600)) : (this._isVisible = !0, this._e_image.src = this._image, this._e_content.innerHTML = this._content, this._e_bubble.setAttribute("class", "visible"))
    }, t.prototype.hide = function() {
        this._isVisible = !1, this._e_bubble.setAttribute("class", "")
    }, t
}();
var wnp = window.wnp || {};
wnp.UI = wnp.UI || {}, wnp.UI.HelpBubbleManager = function() {
    var t = function(t) {
        this.helpBubble = new wnp.UI.HelpBubble, this._enabled = "boolean" == typeof t ? t : !0, this._bubbles = {"wnp.2d.wall-basics": {image: "wnp.2d.wall-basics.gif",content: "<strong>" + _("Walls") + "</strong><ul><li>" + _("Move a wall with a drag &amp; drop.") + "</li><li>" + _("Cut a wall with a double-click.") + "</li></ul>",disp: !1},"wnp.2d.menu": {image: _("wnp.2d.menu-C.gif"),content: "",disp: !1},"wnp.2d.subslope": {image: "wnp.2d.subslope.gif",content: "<strong>" + _("Create Subslopes") + "</strong><ul><li>" + _("Pull the grips to create subslopes.") + "</li><li>" + _("Right-click on a grip to configure the subslope.") + "</li></ul>",disp: !1},"wnp.2d.draw-wall": {image: "wnp.2d.draw-wall.gif",content: "<strong>" + _("Draw Walls") + "</strong><ul><li>" + _("Click to add a point.") + "</li><li>" + _("Click again on your last point to terminate the wall.") + "</li></ul>",disp: !1},"wnp.2d.dup-overture": {image: "wnp.2d.dup-overture.gif",content: "<strong>" + _("Opening Duplication") + "</strong>" + _("Double-click on an opening to duplicate it."),disp: !1},"wnp.2d.draw-staires": {image: "wnp.2d.draw-staires.gif",content: "<strong>" + _("Draw Staireway") + "</strong><ul><li>" + _("Click to add a step.") + "</li><li>" + _("Double-click to terminate the stairway.") + "</li></ul>",disp: !1},"wnp.2d.properties": {image: "wnp.2d.properties.gif",content: "<strong>" + _("Items Settings") + "</strong><ul><li>" + _("You can configure any item of your plan (doors, windows, walls, etc.) by clicking on it.") + "</li><li>" + _("The setting window also allow you to remove any item from your plan.") + "</li></ul>",disp: !1},"wnp.2d.subslopeOverture-menu": {image: "wnp.2d.dormer.png",content: "<strong>" + _("Items Settings") + "</strong><ul><li>" + _("You can configure some parameters of your dormer (height, width, height of roof, etc.) by clicking on it.") + "</li><li>" + _("1: height, 2: height of roof, 3: length of the hole, 4: width") + "</li></ul>",disp: !1},"wnp.3d.paint": {image: "wnp.3d.paint.gif",content: "<strong>" + _("Decorate") + "</strong><ul><li>" + _("Click on a wall to paint it.") + "</li><li>" + _("You can paint objects too.") + "</li></ul>",disp: !1}}, this._load()
    };
    return t.prototype.setActive = function(t) {
        this._enabled = t
    }, t.prototype.display = function(t, e) {
        !this._enabled || !e && this._bubbles[t].disp || (this._bubbles[t].disp = !0, this.helpBubble.newBubble("./images/help/" + this._bubbles[t].image, this._bubbles[t].content, !0), this._save())
    }, t.prototype.alreadyDisplayed = function(t) {
        return this._bubbles[t].disp
    }, t.prototype._save = function() {
        var t = [];
        for (var e in this._bubbles)
            this._bubbles[e].disp && t.push(e);
        wnpLocalStorage["wanadev.planner.helpbubble"] = JSON.stringify(t)
    }, t.prototype._load = function() {
        if (wnpLocalStorage["wanadev.planner.helpbubble"]) {
            var t = JSON.parse(wnpLocalStorage["wanadev.planner.helpbubble"]);
            for (var e in t)
                this._bubbles[t[e]] && (this._bubbles[t[e]].disp = !0)
        }
    }, t
}();
var wnp = window.wnp || {};
wnp.UI = wnp.UI || {}, wnp.UI.RemoteController = function() {
    var t, e = document.getElementById("modalWidgets"), n = function(n, i) {
        function o() {
            if (++l > t.repeat) {
                if (l = 0, null != t.buttonState) {
                    var e = t.buttonState, n = e.target.getAttribute("class");
                    null == n && (n = e.target.parentNode.getAttribute("class"));
                    var i = n.split(" ")[1];
                    switch (i) {
                        case "up":
                            t.setDirection(i);
                            break;
                        case "down":
                            t.setDirection(i);
                            break;
                        case "left":
                            t.setDirection(i);
                            break;
                        case "right":
                            t.setDirection(i);
                            break;
                        case "zoomup":
                            t.addZoom(-1);
                            break;
                        case "zoomdown":
                            t.addZoom(1)
                    }
                }
                requestAnimationFrame(o)
            }
        }
        e = document.getElementById("modalWidgets");
        var n = n || {}, i = i || {};
        this.addedToDomElement = i.domElement || e, this.imagePath = i.imagePath || "../images/remote-controller/", this.domElement = this.buildHTML(), this.defaultDomStyle = "top: " + (i.y || 10) + "px;left: " + (i.x || 10) + "px;", this.domElement.setAttribute("style", this.defaultDomStyle), this.addedToDomElement.appendChild(this.domElement), this.buttons = document.getElementsByClassName("remote-button"), this.slider = document.getElementById("remote-slider"), this.sliderContainer = document.getElementById("remote-slider-content"), this.globalSliderContainer = document.getElementById("remote-slider-bar"), this.globalSliderContainerHeight = this.globalSliderContainer.scrollHeight, this.buttonHeight = this.buttons;
        var r = 35;
        this.zoom = {min: 21,max: 129,reference: r,value: r,lastValue: r,setValue: function(t) {
                this.lastValue = this.value, t > this.min && t < this.max && (this.value = t)
            },setRelativeValue: function(t) {
                this.lastValue = this.value, t >= 0 && 1 >= t && (this.value = t * (this.max - this.min) + this.min)
            },addValue: function(t) {
                this.setValue(this.value + t)
            },getValue: function() {
                return this.value
            },getRelativeValue: function() {
                return (this.value - this.min) / (this.max - this.min)
            },getRelativeDeltaValue: function() {
                return (this.value - this.lastValue) / (this.max - this.min)
            },getDelta: function() {
                return this.value - this.lastValue
            }}, this.callbacks = {zoom: n.zoomChanged || null,direction: n.directionChanged || null,camera: n.cameraChanged || null}, t = this;
        for (var s = 0, a = this.buttons.length; a > s; s++)
            this.buttons[s].addEventListener("mousedown", function(e) {
                t.onButtonMouseDown(e, t)
            }, !1), this.buttons[s].addEventListener("mouseup", function(e) {
                t.onButtonMouseUp(e, t)
            }, !1), this.buttons[s].addEventListener("click", function(e) {
                t.onButtonClick(e, t)
            }, !1);
        this.slider.addEventListener("mousedown", function(e) {
            t.onSliderMouseDown(e, t)
        }, !1), document.body.addEventListener("mousemove", function(e) {
            t.onSliderMouseMove(e, t)
        }, !1), document.body.addEventListener("mouseup", function(e) {
            t.onMouseUp(e, t)
        }, !1), document.addEventListener("wnp.keyboardManager.keyDown", t.onKeyDown, !0), this.sliderSelected = !1, this.updateSliderPos(), this.mouse = {y: 0,lastY: 0,getDelta: function() {
                return this.y - this.lastY
            }}, o(), this.buttonState = null, this.running = !0, this.repeat = 3;
        var l = 0;
        o()
    };
    return n.prototype.buildHTML = function() {
        var t = document.createElement("div");
        t.setAttribute("id", "remote-controller");
        var e = document.createElement("div");
        e.setAttribute("id", "remote-buttons");
        for (var n = ["up", "down", "left", "right"], i = 0; 4 > i; i++) {
            var o = document.createElement("a");
            o.setAttribute("href", "javascript:void(0);"), o.setAttribute("class", "remote-button " + n[i]);
            var r = document.createElement("img");
            r.setAttribute("src", this.imagePath + n[i] + ".png"), o.appendChild(r), e.appendChild(o)
        }
        t.appendChild(e);
        var s = document.createElement("a");
        s.setAttribute("href", "javascript:void(0);"), s.setAttribute("class", "remote-button camera");
        var a = document.createElement("img");
        a.setAttribute("src", this.imagePath + "camera.png"), s.appendChild(a), t.appendChild(s);
        var l = document.createElement("div");
        l.setAttribute("id", "remote-slider-bar");
        var h = document.createElement("a");
        h.setAttribute("href", "javascript:void(0);"), h.setAttribute("class", "remote-button zoomup");
        var c = document.createElement("img");
        c.setAttribute("src", this.imagePath + "zoom-up.png"), h.appendChild(c), l.appendChild(h);
        var u = document.createElement("div");
        u.setAttribute("id", "remote-slider-content");
        var p = document.createElement("img");
        p.setAttribute("id", "remote-slider"), p.setAttribute("src", this.imagePath + "zoom-cursor.png"), u.appendChild(p), l.appendChild(u);
        var d = document.createElement("a");
        d.setAttribute("href", "javascript:void(0);"), d.setAttribute("class", "remote-button zoomdown");
        var m = document.createElement("img");
        return m.setAttribute("src", this.imagePath + "zoom-down.png"), d.appendChild(m), l.appendChild(d), t.appendChild(l), t
    }, n.prototype.onKeyDown = function(e) {
        var n = e.keyCode;
        switch (n) {
            case 37:
                t.setDirection("left");
                break;
            case 38:
                t.setDirection("up");
                break;
            case 39:
                t.setDirection("right");
                break;
            case 40:
                t.setDirection("down")
        }
    }, n.prototype.updateDomPosition = function(t, e) {
        this.defaultDomStyle = "top: " + e + "px;left: " + t + "px;", this.domElement.setAttribute("style", this.defaultDomStyle)
    }, n.prototype.kill = function(t) {
        for (var t = "undefined" != typeof t ? t : !0, e = this, n = 0, i = this.buttons.length; i > n; n++)
            this.buttons[n].removeEventListener("mousedown", function(t) {
                e.onButtonMouseDown(t, e)
            }), this.buttons[n].removeEventListener("mouseup", function(t) {
                e.onButtonMouseUp(t, e)
            }), this.buttons[n].removeEventListener("click", function(t) {
                e.onButtonClick(t, e)
            });
        this.slider.removeEventListener("mousedown", function(t) {
            e.onSliderMouseDown(t, e)
        }), document.body.removeEventListener("mousemove", function(t) {
            e.onSliderMouseMove(t, e)
        }), document.body.removeEventListener("mouseup", function(t) {
            e.onMouseUp(t, e)
        }), this.running = !1, t && null !== this.domElement.parentNode && this.addedToDomElement.removeChild(this.domElement)
    }, n.prototype.onButtonMouseDown = function(t, e) {
        e.buttonState = t
    }, n.prototype.onButtonMouseUp = function(t, e) {
        e.buttonState = null
    }, n.prototype.onButtonClick = function(t, e) {
        var n = t.target.getAttribute("class");
        null == n && (n = t.target.parentNode.getAttribute("class"));
        var i = n.split(" ")[1];
        switch (i) {
            case "camera":
                e.changeCamera();
                break;
            case "up":
                e.setDirection(i);
                break;
            case "down":
                e.setDirection(i);
                break;
            case "left":
                e.setDirection(i);
                break;
            case "right":
                e.setDirection(i);
                break;
            case "zoomup":
                e.addZoom(-1);
                break;
            case "zoomdown":
                e.addZoom(1)
        }
    }, n.prototype.show = function() {
        this.domElement.setAttribute("style", this.defaultDomStyle)
    }, n.prototype.hide = function() {
        this.domElement.setAttribute("style", "display:none;")
    }, n.prototype.onSliderMouseDown = function(t, e) {
        t.preventDefault(), e.sliderSelected = !0
    }, n.prototype.onSliderMouseMove = function(t, e) {
        e.mouse.lastY = e.mouse.y, e.mouse.y = void 0 !== t.y ? t.y : t.clientY, e.sliderSelected && this.addZoom(e.mouse.getDelta())
    }, n.prototype.onMouseUp = function(t, e) {
        e.sliderSelected = !1
    }, n.prototype.reset = function() {
        this.zoom.value = this.zoom.reference, this.updateSliderPos()
    }, n.prototype.addZoom = function(t) {
        this.zoom.addValue(t), this.updateSliderPos(), null != this.callbacks.zoom && this.callbacks.zoom(this.zoom.getRelativeDeltaValue())
    }, n.prototype.setDirection = function(t) {
        null != this.callbacks.direction && this.callbacks.direction(t)
    }, n.prototype.changeCamera = function() {
        null != this.callbacks.camera && this.callbacks.camera()
    }, n.prototype.updateZoom = function(t) {
        this.zoom.setRelativeValue(t), this.updateSliderPos()
    }, n.prototype.updateSliderPos = function() {
        this.slider.style.top = this.zoom.getValue() + "px"
    }, n
}();
var wnp = window.wnp || {};
wnp.UI = wnp.UI || {}, wnp.UI.MessageBox = function() {
    var t = document.getElementById("modalWidgets"), e = !1, n = null, i = function(e) {
        var e = e || {}, i = this;
        t = document.getElementById("modalWidgets"), e.buttonAText = e.buttonAText || _("Ok"), e.buttonBText = e.buttonBText || _("Cancel"), e.buttonCText = e.buttonCText || _("Cancel"), e.inputType = e.inputType || "text", e.inputValue = e.inputValue || "", e.inputPlaceHolder = e.inputPlaceHolder || "", e.textAreaValue = e.textAreaValue || "", e.textAreaPlaceHolder = e.textAreaPlaceHolder || "", this.showButtonA = "undefined" != typeof e.buttonA ? e.buttonA : !1, this.showButtonB = "undefined" != typeof e.buttonB ? e.buttonB : !1, this.showButtonC = "undefined" != typeof e.buttonC ? e.buttonC : !1, this.showInput = "undefined" != typeof e.input ? e.input : !1, this.showTextArea = "undefined" != typeof e.textArea ? e.textArea : !1, this.closeCallback = e.onClose || function() {
        }, this.button1Callback = e.onClickA || function() {
        }, this.button2Callback = e.onClickB || function() {
        }, this.button3Callback = e.onClickC || function() {
        }, this.destroyAfterClose = "undefined" != typeof e.destroyAfterClose ? e.destroyAfterClose : !1, this.overlay = "undefined" != typeof e.overlay ? e.overlay : !1, this.opacity = e.opacity || 0, this.messageBox = document.createElement("div"), this.messageBox.setAttribute("id", "messageBox"), this.messageBox.setAttribute("class", "window"), this.header = document.createElement("header"), this.header.setAttribute("class", "window-title"), this.closeHeader = document.createElement("span"), this.closeHeader.setAttribute("class", "window-close"), this.closeHeader.addEventListener("click", function() {
            wnp.UI.MessageBox.close(), i.closeCallback.call(i)
        }, !1), this.header.appendChild(this.closeHeader), this.headerContent = document.createElement("h1"), this.header.appendChild(this.headerContent), this.content = document.createElement("p"), this.content.setAttribute("class", "mb-content window-content"), this.input = document.createElement("input"), this.input.setAttribute("class", "mb-input"), this.input.setAttribute("type", e.inputText), this.input.setAttribute("value", e.inputValue), this.input.setAttribute("placeholder", e.inputPlaceHolder), this.input.addEventListener("click", this.onInputClick, !1), this.showInput || this.input.setAttribute("style", "display:none;"), this.textArea = document.createElement("textarea"), this.textArea.setAttribute("class", "mb-textarea"), this.textArea.setAttribute("placeholder", e.textAreaPlaceHolder), this.textArea.style.display = "block", this.textArea.style.margin = "5px auto", this.textArea.style.width = "90%", this.textArea.style.height = "60px", this.textArea.innerHTML = e.textAreaValue, this.showTextArea || (this.textArea.style.display = "none"), this.buttonA = document.createElement("button"), this.buttonA.setAttribute("id", "mb-button-a"), this.buttonA.addEventListener("click", function(t) {
            i.onClick(t, i)
        }, !1), this.buttonA.innerHTML = e.buttonAText, this.showButtonA || this.buttonA.setAttribute("style", "display:none;"), this.buttonB = document.createElement("button"), this.buttonB.setAttribute("id", "mb-button-b"), this.buttonB.addEventListener("click", function(t) {
            i.onClick(t, i)
        }, !1), this.buttonB.innerHTML = e.buttonBText, this.showButtonB || this.buttonB.setAttribute("style", "display:none;"), this.buttonC = document.createElement("button"), this.buttonC.setAttribute("id", "mb-button-c"), this.buttonC.addEventListener("click", function(t) {
            i.onClick(t, i)
        }, !1), this.buttonC.innerHTML = e.buttonCText, this.showButtonC || this.buttonC.setAttribute("style", "display:none;"), this.buttonsContainer = document.createElement("div"), this.buttonsContainer.setAttribute("class", "window-action-bar"), this.buttonsContainer.appendChild(this.buttonA), this.buttonsContainer.appendChild(this.buttonB), this.buttonsContainer.appendChild(this.buttonC), this.messageBox.appendChild(this.header), this.messageBox.appendChild(this.content), this.messageBox.appendChild(this.input), this.messageBox.appendChild(this.textArea), this.messageBox.appendChild(this.buttonsContainer), t.appendChild(this.messageBox), this.autoHideInterval = null, n = this;
        var i = this;
        document.addEventListener("wnp.request.closePopup", function() {
            n = n == this ? null : n, i.destroy()
        }, !1)
    };
    return i.prototype.destroy = function() {
        var n = this;
        this.buttonA.removeEventListener("click", function(t) {
            n.onClick(t, n)
        }), this.buttonB.removeEventListener("click", function(t) {
            n.onClick(t, n)
        }), this.buttonC.removeEventListener("click", function(t) {
            n.onClick(t, n)
        }), this.headerContent.innerHTML = "", this.content.innerHTML = "", this.messageBox.setAttribute("style", "display:none;"), e && ujs.notify("wnp.ui.messagebox.closed"), e = !1, null !== this.messageBox.parentNode && t.removeChild(this.messageBox)
    }, i.prototype.onClick = function(t, e) {
        if (e.messageBox.setAttribute("style", "display:none;"), "undefined" != typeof t.clearInterval && t.clearInterval && clearInterval(e.autoHideInterval), null != e.closeCallback && (params = {textInput: e.input.value}, e.closeCallback(params)), "undefined" != typeof t.target) {
            t.textInput = e.input.value, t.textAreaInput = e.textArea.value;
            var n = t.target.id;
            "mb-button-a" == n && null != e.button1Callback && e.button1Callback(t), "mb-button-b" == n && null != e.button2Callback && e.button2Callback(t), "mb-button-c" == n && null != e.button3Callback && e.button3Callback(t)
        }
        e.destroyAfterClose && e.destroy()
    }, i.prototype.onInputClick = function() {
        this.value = ""
    }, i.prototype.open = function(t) {
        var t = t || {}, n = "undefined" != typeof t.force ? t.force : !1;
        if (!e || n) {
            e = !0;
            var i = t.autoHide || !1, o = t.hideTime || 1500, r = t.width || 250, s = t.height || !1, a = t.x || window.innerWidth / 2 - r / 2, l = t.y || window.innerHeight / 2 - s / 2, h = t.title || "", c = t.message || "";
            this.headerContent.innerHTML = h, c instanceof HTMLElement ? (this.content.innerHTML = "", this.content.appendChild(c)) : this.content.innerHTML = c, this.showInput && (s += 30), (this.showButtonA || this.showButtonB) && (s += 30);
            var u = "display:block;width:" + r + "px;top:" + l + "px;left:" + a + "px;";
            if (s && (u += "width:" + r + "px;"), this.messageBox.setAttribute("style", u), !this.showInput && "string" == typeof c && GlobalHelper.isMobileDevice()) {
                this.content.classList.add(/<form|<ul|<table/.test(c) ? "message-incFontSize" : "message-center");
                var p = this.content.getBoundingClientRect();
                this.content.style.top = Math.floor(window.innerHeight / 2 - p.height / 2) + "px"
            }
            var d = this;
            i && (this.autoHideInterval = setInterval(function() {
                d.onClick({clearInterval: !0}, d)
            }, o)), ujs.notify("wnp.ui.messagebox.opened")
        }
    }, i.prototype.close = function() {
        var t = "";
        this.defaultStyles && this.defaultStyles.box && (t = this.defaultStyles.box), this.messageBox.setAttribute("style", t + "display:none"), e = !1, ujs.notify("wnp.ui.messagebox.closed")
    }, i.close = function() {
        null != n && (n.close(), n.destroy(), n = null)
    }, i.show = function(t) {
        var t = t || {}, n = "undefined" == typeof t.force ? !1 : t.force;
        if (!e || n) {
            var t = t || {};
            t.autoHide = t.autoHide || !1, t.hideTime = t.hideTime || 2500, t.width = t.width || null, t.height = t.height || null, t.x = t.x || null, t.y = t.y || null, t.title = t.title || "", t.message = t.message || "", t.inputValue = t.inputValue || "", t.openCallback = t.openCallback || function() {
            };
            var i = {destroyAfterClose: !0,onClose: t.onClose || null,onClickA: t.onClickA || null,onClickB: t.onClickB || null,onClickC: t.onClickC || null,buttonA: "undefined" != typeof t.buttonA ? t.buttonA : !1,buttonAText: t.buttonAText || null,buttonB: "undefined" != typeof t.buttonB ? t.buttonB : !1,buttonBText: t.buttonBText || null,buttonC: "undefined" != typeof t.buttonC ? t.buttonC : !1,buttonCText: t.buttonCText || null,input: "undefined" != typeof t.input ? t.input : !1,inputValue: t.inputValue,inputPlaceHolder: t.inputPlaceHolder,textArea: "undefined" != typeof t.textArea ? t.textArea : !1,textAreaValue: t.textAreaValue,textAreaPlaceHolder: t.textAreaPlaceHolder,opacity: t.opacity || 0,overlay: t.overlay || !1}, o = new wnp.UI.MessageBox(i);
            o.open(t), t.openCallback()
        }
    }, i
}();
var wnp = window.wnp || {};
wnp.UI = wnp.UI || {}, wnp.UI.Menu = function() {
    function t(t) {
        var e = [];
        return e.push("background-color:rgb("), e.push(Math.floor(255 * t.r)), e.push(", "), e.push(Math.floor(255 * t.g)), e.push(", "), e.push(Math.floor(255 * t.b)), e.push(")"), e.join("")
    }
    var e = 0, n = function(t, e, n) {
        this.json = t || [], this.domElement = document.getElementById(e), this.params = n || {}, this.selected = this.params.selected || !1, this.inception = this.params.inception === !1 ? !1 : !0, this.oneClick = this.params.oneClick === !0 ? !0 : !1, this.initialize()
    };
    return n.prototype.initialize = function() {
        this.updateHtml()
    }, n.prototype.getWidth = function() {
        return this.domElement.offsetWidth || 0
    }, n.prototype.updateHtml = function(t) {
        if (t && t.id) {
            var e = this.domElement.querySelector("#" + t.id), n = this.buildItem(t, e.nodeName);
            e.parentNode.replaceChild(n, e)
        } else {
            this.domElement.innerHTML = "";
            for (var n, i = 0; i < this.json.length; i++)
                n = this.buildItem(this.json[i], "li"), this.domElement.appendChild(n)
        }
    }, n.prototype.buildItem = function(n, i) {
        var o = document.createElement(i);
        if (n.id = "undefined" != typeof n.id ? n.id : "item" + e++, o.id = n.id, n.noTitle = !1, 1 == n.texture) {
            var r = document.createElement("span");
            r.setAttribute("class", "menu-icon");
            var s = n.translations ? _(n.title, n.translations) : _(n.title);
            if (n.params.url) {
                n.noTitle = !0;
                var a = document.createElement("img"), l = n.icon || n.params.url;
                a.setAttribute("src", l), a.setAttribute("title", s), r.appendChild(a), o.appendChild(r)
            } else
                n.params.color && (n.noTitle = !0, r.setAttribute("style", t(n.params.color)), r.setAttribute("title", s), o.appendChild(r));
            if (n.colorable) {
                var h = document.createElement("div");
                h.setAttribute("class", "colorChooser");
                var c = t(n.params.addColor && n.params.addColor.color ? n.params.addColor.color : {r: 137 / 255,g: 184 / 255,b: 8 / 255});
                h.setAttribute("style", c), r.appendChild(h), r.classList.add("colorable"), h.item = n, h.addEventListener("click", this.onColorChooserClick.bind(this), !1)
            }
        } else if (n.icon) {
            var r = document.createElement("span");
            r.setAttribute("class", "menu-icon"), r.innerHTML = -1 == n.icon.indexOf(".") ? "<i class='" + n.icon + "'></i>" : "<img src='" + n.icon + "' />", o.appendChild(r)
        }
        if (n.title && n.noTitle === !1) {
            var s = n.translations ? _(n.title, n.translations) : _(n.title), u = document.createElement("span");
            u.setAttribute("class", "menu-title"), u.innerHTML = s, o.appendChild(u)
        }
        if (o.classList.add("menu-item"), n.context && o.classList.add("label-" + n.context), n == this.selected && o.classList.add("selected"), n.addClass)
            for (var p = n.addClass.split(" "), d = 0; d < p.length; d++)
                o.classList.add(p[d]);
        if (n.items && n.items.length > 0 && this.inception) {
            var m, g = document.createElement("ul");
            g.classList.add(n.layout), o.classList.add("menu-subitem"), n == this.selected && o.classList.add("opened");
            for (var f = 0; f < n.items.length; f++)
                n.items[f] == this.selected && o.classList.add("opened"), m = this.buildItem(n.items[f], "li"), g.appendChild(m);
            o.appendChild(g)
        }
        return o.addEventListener("click", function(t) {
            "UL" != t.target.tagName && (this.selected == n || o.classList.contains("opened") ? (this.deselect(), this.deselectElement(o)) : (ujs.notify("wnp.menu.click", this.buildEventItem(n)), (this.oneClick === !1 || n.selectionnable === !0) && (this.selected = n, this.selectElement(o)), n.action && ujs.notify(n.action, this.buildEventItem(n))), t.stopPropagation())
        }.bind(this), !1), o
    }, n.prototype.selectElement = function(t) {
        for (var e = this.domElement.querySelectorAll(".selected"), n = 0; n < e.length; n++)
            e[n].classList.remove("selected");
        t.classList.add("selected"), t.classList.contains("menu-subitem") && t.classList.add("opened")
    }, n.prototype.deselectElement = function(t) {
        t.classList.remove("selected"), t.classList.contains("menu-subitem") && t.classList.remove("opened")
    }, n.prototype.onColorChooserClick = function(t) {
        var e = t.target, n = e.item, i = function(t, i) {
            e.style.backgroundColor = "rgb(" + Math.round(255 * i.r) + "," + Math.round(255 * i.g) + "," + Math.round(255 * i.b) + ")";
            var o = n.params;
            o.addColor = {color: i}, n.colorId = t, this.selected = n, n.action && ujs.notify(n.action, this.buildEventItem(n))
        };
        wnp.UI.ColorPopup.show(i.bind(this), n.colorId), t.stopPropagation()
    }, n.prototype.buildEventItem = function(t) {
        var e = {};
        for (var n in t)
            e[n] = t[n];
        for (var n in t.params)
            e[n] = t.params[n];
        return delete e.items, e
    }, n.prototype.deselect = function(t, e) {
        var t = t || !1, e = e || !1;
        if (!this.selected || !e || this.selected.id === e) {
            if (this.selected.cancelAction) {
                var n = this.buildEventItem(this.selected);
                n.from = "deselect", ujs.notify(this.selected.cancelAction, n)
            }
            this.getDomItemById(this.selected.id) && this.deselectElement(this.getDomItemById(this.selected.id)), this.selected = t ? !1 : this.getParent(this.selected)
        }
    }, n.prototype.getParent = function(t) {
        for (var e = 0; e < this.json.length; e++)
            for (var n in this.json[e].items)
                if (this.json[e].items[n] == t)
                    return this.json[e];
        return !1
    }, n.prototype.deleteMenuItem = function(t) {
        var e = function(e, n) {
            return e.id == t ? n : !1
        }, n = this.traverse(this.json, void 0, e);
        if (n) {
            for (var i = this.json; n.length > 1; )
                i = i[n.shift()].items;
            i.splice(n[0], 1)
        }
    }, n.prototype.replaceMenuItem = function(t, e, n) {
        var i = this, n = n || !1, e = e || {}, o = function(o, r) {
            if (o.id == t) {
                var s = e;
                n === !0 && (s = ujs.mergeObjects(o, e, !0)), o == this.selected && (this.selected = s);
                var a = r.join(".items.");
                ujs.setProperty(i.json, a, s);
                for (var l in s)
                    e[l] = s[l];
                return !0
            }
            return !1
        };
        this.traverse(this.json, o)
    }, n.prototype.addMenuItem = function(t, e) {
        if (e.items || (e.items = []), "." !== t) {
            t = this.cleanPath(t);
            var n = ujs.getProperty(this.json, t);
            if (n !== !1 && "undefined" != typeof n) {
                if (e instanceof Array)
                    for (var i = 0; i < e.length; i++)
                        n.push(e[i]);
                else
                    n.push(e);
                this.sortJson(n)
            } else
                ujs.setProperty(this.json, t, e)
        } else
            this.json.push(e), this.sortJson(this.json);
        this.updateHtml()
    }, n.prototype.getDomItemById = function(t) {
        if (t) {
            t = t.id || t;
            for (var e = this.domElement.getElementsByClassName("menu-item"), n = e.length; n--; )
                if (e[n].id == t)
                    return e[n]
        }
    }, n.prototype.searchItem = function(t) {
        var e = function(e) {
            return e.id == t ? e : !1
        }, n = this.traverse(this.json, void 0, e);
        return n ? n : !1
    }, n.prototype.sortJson = function(t) {
        t && t.length > 0 && t.sort(function(t, e) {
            return t.index - e.index
        })
    }, n.prototype.traverse = function(t, e, n, i) {
        for (var e = e || function() {
        }, n = n || function() {
            return !1
        }, i = i || [], o = 0; o < t.length; o++) {
            if (e(t[o], i.concat(o)), n(t[o], i) !== !1)
                return i.push(o), n(t[o], i);
            if (t[o].items && t[o].items.length > 0) {
                var r = ujs.cloneArray(i);
                r.push(o);
                var s = this.traverse(t[o].items, e, n, r);
                if (s)
                    return s
            }
        }
    }, n.prototype.getIdFromIdentifier = function(t) {
        var e = function(e, n) {
            return e.id == t ? n[n.length - 1] : !1
        }, n = this.traverse(this.json, void 0, e);
        return n ? n : 0
    }, n.prototype.cleanPath = function(t) {
        for (var t = t || "", e = t.split("."), n = 0; n < e.length; n++)
            isNaN(+e[n]) && (e[n] = this.getIdFromIdentifier(e[n]));
        return t = e.join(".items.") + ".items"
    }, n
}();
var wnp = window.wnp || {};
wnp.UI = wnp.UI || {}, wnp.UI.LanguageSelector = function() {
    var t = null, e = "en", n = "", i = [{id: "en",label: "English (English)"}, {id: "es",label: "Spain (España)"}, {id: "fr",label: "French (Français)"}, {id: "pl",label: "Polish (Poland)"}, {id: "jp",label: "Japanese (Japan)"}], o = function() {
        wnp.UI.Frame.call(this, {maxWidth: 200,maxHeight: 220}, {title: _("Available languages")}), this.init = !1
    };
    return o.prototype = new wnp.UI.Frame, o.prototype.initialize = function() {
        if (wnp.UI.Frame.prototype.initialize.call(this), !this.init) {
            var t = [{title: _("Ok"),action: this.close.bind(this),label: _("Ok")}];
            this.setActionBar(t), this.init = !0, this.domElement.setAttribute("id", "languageSelector"), this.domElement.classList.add("language-selector");
            for (var n = document.getElementsByClassName("drawableSurface"), o = 0, r = n.length; r > o; o++)
                n[o].addEventListener("click", this.close, !1);
            var s = document.createElement("ul");
            s.setAttribute("class", "layout-list");
            var a = [];
            for (var o in i)
                a.push({label: i[o].label,groupName: "languages",isSelected: i[o].id == e ? !0 : !1,id: "lang_" + i[o].id,type: "radio",eventParams: this.onSelected});
            this.addForm(0, a, "Languages"), this.setLayout("vertical")
        }
    }, o.prototype.onSelected = function() {
        n = this.id.split("_")[1]
    }, o.show = function() {
        null == t && (t = new wnp.UI.LanguageSelector, t.initialize()), t._selectedLang = "", t.show()
    }, o.setLocal = function(t) {
        e = "C" == t ? "en" : t
    }, o.prototype.close = function() {
        t.domElement.style.display = "none", "" !== n && (wnpLocalStorage.setItem(wnp.Constants.LC_LANG_KEY, n), window.location.reload())
    }, o
}();
var wnp = window.wnp || {};
wnp.UI = wnp.UI || {}, wnp.UI.IFrame = function() {
    function t() {
        e.close(!0)
    }
    var e = null, n = function(t, n, i, o) {
        this.domElement = document.createElement("div"), this.domElement.setAttribute("id", "wnp-iframe"), this.domElement.style.width = window.innerWidth + "px", this.domElement.style.height = window.innerHeight + "px", this.iframeContainer = document.createElement("div"), this.iframeContainer.setAttribute("class", "wnp-iframe-container"), this.iframe = document.createElement("iframe"), this.iframe.setAttribute("seamless", "seamless"), this.iframe.setAttribute("sandbox", "allow-same-origin allow-scripts allow-top-navigation allow-popups  allow-forms"), this.parentNode = t, this.added = !1, this.closeOnClick = i && "undefined" != typeof i.closeOnClick ? i.closeOnClick : !1, this.closeCallback = o || function() {
        };
        for (var r in n)
            this.iframe[r] = n[r];
        this.closeButton = document.createElement("a"), this.closeButton.setAttribute("href", "#"), this.closeButton.setAttribute("class", "close-button");
        var s = document.createElement("img");
        s.setAttribute("src", "images/close-icon.png"), this.closeButton.appendChild(s);
        var i = i || {};
        i.showClose && this.iframeContainer.appendChild(this.closeButton), this.iframeContainer.appendChild(this.iframe), this.domElement.appendChild(this.iframeContainer), e = this, this.resize(n.width, n.height)
    };
    return n.prototype.open = function() {
        this.added || (this.iframeContainer.style.left = +(+window.innerWidth / 2) - +parseInt(this.iframeContainer.style.width) / 2 + "px", this.iframeContainer.style.top = +(+window.innerHeight / 2) - +parseInt(this.iframeContainer.style.height) / 2 + "px", this.parentNode.appendChild(this.domElement), this.closeButton.addEventListener("click", t, !0), this.closeOnClick && this.parentNode.addEventListener("click", t, !1), this.added = !0)
    }, n.prototype.close = function(n) {
        this.added && (this.parentNode.removeChild(e.domElement), this.closeButton.removeEventListener("click", t), this.closeOnClick && this.parentNode.removeEventListener("click", t), this.added = !1, this.closeCallback()), "boolean" == typeof n && delete this
    }, n.show = function(t, n, i) {
        wnp.UI.IFrame.close(), e = new wnp.UI.IFrame(t, n, i), e.open()
    }, n.close = function(t) {
        e && (e.close(t), e = null)
    }, n.prototype.resize = function(t, n) {
        var t = t, n = n;
        t && (t > wanaplan.getWidth() - 40 && (t = wanaplan.getWidth() - 40), e.iframeContainer.style.width = t + "px", e.iframe.setAttribute("width", t), e.iframeContainer.style.left = Math.round(+(+window.innerWidth / 2) - +parseInt(e.iframeContainer.style.width) / 2) + "px"), n && (n > wanaplan.getHeight() - 40 && (n = wanaplan.getHeight() - 40), e.iframeContainer.style.height = n + "px", e.iframe.setAttribute("height", n), e.iframeContainer.style.top = Math.round(+(+window.innerHeight / 2) - +parseInt(e.iframeContainer.style.height) / 2) + "px")
    }, n.resize = n.prototype.resize, n
}();
var wnp = window.wnp || {};
wnp.Input = wnp.Input || {}, wnp.Input.OrbitCamera = function() {
    var t = (BABYLON.Tools.GetPointerPrefix(), function(e, n, i, o, r, s) {
        BABYLON.Camera.call(this, e, BABYLON.Vector3.Zero(), s), this.alpha = n, this.beta = i, this.radius = o, this.target = r, this.enabled = !0, this.cameraTranslationenabled = !0, this._keys = [], this.keysUp = [38], this.keysDown = [40], this.keysLeft = [37], this.keysRight = [39], this._viewMatrix = new BABYLON.Matrix, t.prototype._initCache.call(this), this.getViewMatrix()
    });
    t.prototype = Object.create(BABYLON.Camera.prototype);
    var e = BABYLON.Camera;
    t.prototype.inertialAlphaOffset = 0, t.prototype.inertialBetaOffset = 0, t.prototype.inertialRadiusOffset = 0, t.prototype.lowerAlphaLimit = null, t.prototype.upperAlphaLimit = null, t.prototype.lowerBetaLimit = null, t.prototype.upperBetaLimit = null, t.prototype.lowerRadiusLimit = 40, t.prototype.upperRadiusLimit = 6e3, t.prototype.radiusSpeedFactor = .2, t.prototype.moveSpeedFactor = .5, t.prototype.angularSensibility = 1e3;
    var n = function(t) {
        return t.offsetX ? t.offsetX : t.layerX ? t.layerX : t.clientX
    }, i = function(t) {
        return t.offsetY ? t.offsetY : t.layerY ? t.layerY : t.clientY
    };
    return t.prototype._getTargetPosition = function() {
        return this.target.position || this.target
    }, t.prototype._initCache = function() {
        e.prototype._initCache.call(this), this._cache.target = new BABYLON.Vector3(Number.MAX_VALUE, Number.MAX_VALUE, Number.MAX_VALUE), this._cache.alpha = void 0, this._cache.beta = void 0, this._cache.radius = void 0
    }, t.prototype._updateCache = function(t) {
        t || e.prototype._updateCache.call(this), this._cache.target.copyFrom(this._getTargetPosition()), this._cache.alpha = this.alpha, this._cache.beta = this.beta, this._cache.radius = this.radius
    }, t.prototype._isSynchronizedViewMatrix = function() {
        return e.prototype._isSynchronizedViewMatrix.call(this) ? this._cache.target.equals(this._getTargetPosition()) && this._cache.alpha === this.alpha && this._cache.beta === this.beta && this._cache.radius === this.radius : !1
    }, t.prototype.attachControl = function(t, e, n) {
        1 === wanaplan.engine3D.pointerManager.mode ? this.attachControlForMobile(t, e, n) : this.attachControlForDesktop(t, e, n)
    }, t.prototype.attachControlForMobile = function(t) {
        var e, n = this._scene.getEngine(), i = .005, o = !0, r = [{x: 0,y: 0}, {x: 0,y: 0}], s = 0, a = 0, l = this;
        this.angularSensibility = 1, this._attachedCanvas = t, window.ejecta && (this._attachedCanvas = document), document.addEventListener("wnp.engine3d.dragcontrols.start", function() {
            o = !1
        }, !1), document.addEventListener("wnp.engine3d.dragcontrols.end", function() {
            o = !0
        }, !1);
        var h = function(t) {
            r[0].x = t.touches[0].clientX || t.touches[0].pageX, r[0].y = t.touches[0].clientY || t.touches[0].pageY, 2 === t.touches.length && (r[1].x = t.touches[1].clientX || t.touches[1].pageX, r[1].y = t.touches[1].clientY || t.touches[1].pageY)
        }, c = function(t, e) {
            var n = t.x - e.x, i = t.y - e.y;
            return Math.sqrt(n * n + i * i)
        }, u = function(t) {
            o && (t.preventDefault(), h(t), n.isPointerLock = !0, t.touches.length && (e = {x: t.touches[0].clientX * i,y: t.touches[0].clientY * i}))
        }, p = function(t) {
            if (o && (t.preventDefault(), h(t), t.touches.length)) {
                if (!e)
                    return;
                var n = t.touches[0].clientX * i, u = t.touches[0].clientY * i, p = n - e.x, d = u - e.y;
                if (t.touches.length > 2) {
                    var m = wanaplan.engine3D.projectMouseOnGround(0 | +(e.x / i), 0 | +(e.y / i)), g = wanaplan.engine3D.projectMouseOnGround(0 | +(n / i), 0 | +(u / i));
                    null !== m && null !== g && (g.subtractInPlace(m), l._getTargetPosition().addInPlace(g.scaleInPlace(-1)), l._getTargetPosition().x = ujs.Math.clamp(l._getTargetPosition().x, wanaplan.configuration.boundingSize.min.x, wanaplan.configuration.boundingSize.max.x), l._getTargetPosition().z = ujs.Math.clamp(l._getTargetPosition().z, wanaplan.configuration.boundingSize.min.z, wanaplan.configuration.boundingSize.max.z))
                } else if (2 == t.touches.length) {
                    a = s, s = c(r[0], r[1]);
                    var f = +(s - a) > 0 ? 2.5 : -2.5;
                    f *= wanaplan.loopTimer.getDeltaTime(), l.inertialRadiusOffset += f
                } else
                    l.inertialAlphaOffset -= p / l.angularSensibility, l.inertialBetaOffset -= d / l.angularSensibility;
                e = {x: n,y: u}
            }
        }, d = function(t) {
            o && (t.preventDefault(), n.isPointerLock = !1, e = null)
        };
        this._attachedCanvas.addEventListener("touchstart", u, !1), this._attachedCanvas.addEventListener("touchmove", p, !1), this._attachedCanvas.addEventListener("touchend", d, !1), this._attachedCanvas.addEventListener("touchcancel", d, !1)
    }, t.prototype.attachControlForDesktop = function(t, e) {
        var o, r, s = this, a = !1;
        if (!this._attachedCanvas) {
            this._attachedCanvas = t;
            var l = this._scene.getEngine();
            void 0 === this._onPointerDown && (this._onPointerDown = function(t) {
                return s.enabled ? void (r || (r = t.pointerId, o = {x: n(t),y: i(t)}, e || t.preventDefault())) : void (o = null)
            }, this._onPointerUp = function(t) {
                o = null, r = null, e || t.preventDefault()
            }, this._onPointerMove = function(t) {
                if (o && !a && r === t.pointerId) {
                    var l = n(t) - o.x, h = i(t) - o.y;
                    if (s.enabled) {
                        var c = t.button;
                        if (!t.button && t.buttons ? (c = t.buttons, c = 1 === t.buttons ? 0 : c) : -1 === c && (c = 1 === t.buttons ? 0 : t.buttons), 0 === c)
                            s.inertialAlphaOffset -= l / s.angularSensibility, s.inertialBetaOffset -= h / s.angularSensibility;
                        else if (2 === c) {
                            if (!s.cameraTranslationenabled)
                                return;
                            var u = wanaplan.engine3D.projectMouseOnGround(o.x, o.y), p = wanaplan.engine3D.projectMouseOnGround(n(t), i(t));
                            if (null !== u && null !== p) {
                                p.subtractInPlace(u);
                                var d = p.length();
                                d > 125 && p.scaleInPlace(125 / d), s._getTargetPosition().addInPlace(p.scaleInPlace(-1)), s._getTargetPosition().x = ujs.Math.clamp(s._getTargetPosition().x, wanaplan.configuration.boundingSize.min.x, wanaplan.configuration.boundingSize.max.x), s._getTargetPosition().z = ujs.Math.clamp(s._getTargetPosition().z, wanaplan.configuration.boundingSize.min.z, wanaplan.configuration.boundingSize.max.z)
                            }
                        }
                        ujs.notify("wnp.engine3D.camera.move"), o = {x: n(t),y: i(t)}, e || t.preventDefault()
                    }
                }
            }, this._onMouseMove = function(t) {
                if (s.enabled && l.isPointerLock) {
                    var n = t.movementX || t.mozMovementX || t.webkitMovementX || t.msMovementX || 0, i = t.movementY || t.mozMovementY || t.webkitMovementY || t.msMovementY || 0;
                    s.inertialAlphaOffset -= n / s.angularSensibility, s.inertialBetaOffset -= i / s.angularSensibility, e || t.preventDefault()
                }
            }, this._wheel = function(t) {
                if (s.enabled) {
                    var n = 0;
                    t.wheelDelta ? n = t.wheelDelta / (120 * s.radiusSpeedFactor) : t.detail && (n = -t.detail / (3 * s.radiusSpeedFactor)), n && (s.inertialRadiusOffset += n), t.preventDefault && (e || t.preventDefault())
                }
            }, this._onKeyDown = function(t) {
                if (s.enabled && (-1 !== s.keysUp.indexOf(t.keyCode) || -1 !== s.keysDown.indexOf(t.keyCode) || -1 !== s.keysLeft.indexOf(t.keyCode) || -1 !== s.keysRight.indexOf(t.keyCode))) {
                    var n = s._keys.indexOf(t.keyCode);
                    -1 === n && s._keys.push(t.keyCode), t.preventDefault && (e || t.preventDefault())
                }
            }, this._onKeyUp = function(t) {
                if (s.enabled && (-1 !== s.keysUp.indexOf(t.keyCode) || -1 !== s.keysDown.indexOf(t.keyCode) || -1 !== s.keysLeft.indexOf(t.keyCode) || -1 !== s.keysRight.indexOf(t.keyCode))) {
                    var n = s._keys.indexOf(t.keyCode);
                    n >= 0 && s._keys.splice(n, 1), t.preventDefault && (e || t.preventDefault())
                }
            }, this._onLostFocus = function() {
                s.enabled && (s._keys = [], r = null)
            }, this._onGestureStart = function(e) {
                s.enabled && void 0 !== window.MSGesture && (s._MSGestureHandler || (s._MSGestureHandler = new MSGesture, s._MSGestureHandler.target = t), s._MSGestureHandler.addPointer(e.pointerId))
            }, this._onGesture = function(t) {
                s.enabled && (1 !== t.scale ? (s.inertialRadiusOffset += 65 * t.scale * (t.expansion > 0 ? 1 : -1), a = !0) : a = !1, t.preventDefault && (e || (t.stopPropagation(), t.preventDefault())))
            }, this._reset = function() {
                s._keys = [], s.inertialAlphaOffset = 0, s.inertialBetaOffset = 0, o = null, r = null
            });
            var h = window.PointerEvent ? "pointer" : "mouse";
            t.addEventListener(h + "down", this._onPointerDown, !1), t.addEventListener(h + "up", this._onPointerUp, !1), t.addEventListener(h + "out", this._onPointerUp, !1), t.addEventListener(h + "move", this._onPointerMove, !1), t.addEventListener("mousemove", this._onMouseMove, !1), t.addEventListener("MSPointerDown", this._onGestureStart, !1), t.addEventListener("MSGestureChange", this._onGesture, !1), window.addEventListener("keydown", this._onKeyDown, !1), window.addEventListener("keyup", this._onKeyUp, !1), t.addEventListener("mousewheel", this._wheel, !1), window.addEventListener("DOMMouseScroll", this._wheel, !1), window.addEventListener("blur", this._onLostFocus, !1)
        }
    }, t.prototype.detachControl = function(t) {
        if (this._attachedCanvas == t) {
            var e = window.PointerEvent ? "pointer" : "mouse";
            t.removeEventListener(e + "down", this._onPointerDown, !1), t.removeEventListener(e + "up", this._onPointerUp, !1), t.removeEventListener(e + "out", this._onPointerUp, !1), t.removeEventListener(e + "move", this._onPointerMove, !1), t.removeEventListener("mousemove", this._onMouseMove, !1), t.removeEventListener("MSPointerDown", this._onGestureStart, !1), t.removeEventListener("MSGestureChange", this._onGesture, !1), window.removeEventListener("keydown", this._onKeyDown), window.removeEventListener("keyup", this._onKeyUp), t.removeEventListener("mousewheel", this._wheel), window.removeEventListener("DOMMouseScroll", this._wheel, !1), window.removeEventListener("blur", this._onLostFocus), this._MSGestureHandler = null, this._attachedCanvas = null, this._reset && this._reset()
        }
    }, t.prototype._update = function() {
        for (var t = 0; t < this._keys.length; t++) {
            var e = this._keys[t];
            ujs.notify("wnp.engine3D.camera.move"), -1 !== this.keysLeft.indexOf(e) ? this.inertialAlphaOffset -= .01 : -1 !== this.keysUp.indexOf(e) ? this.inertialBetaOffset -= .01 : -1 !== this.keysRight.indexOf(e) ? this.inertialAlphaOffset += .01 : -1 !== this.keysDown.indexOf(e) && (this.inertialBetaOffset += .01)
        }
        (0 != this.inertialAlphaOffset || 0 != this.inertialBetaOffset || 0 != this.inertialRadiusOffset) && (this.alpha += this.inertialAlphaOffset, this.beta += this.inertialBetaOffset, this.radius -= this.inertialRadiusOffset, this.inertialAlphaOffset *= this.inertia, this.inertialBetaOffset *= this.inertia, this.inertialRadiusOffset *= this.inertia, Math.abs(this.inertialAlphaOffset) < BABYLON.Engine.epsilon && (this.inertialAlphaOffset = 0), Math.abs(this.inertialBetaOffset) < BABYLON.Engine.epsilon && (this.inertialBetaOffset = 0), Math.abs(this.inertialRadiusOffset) < BABYLON.Engine.epsilon && (this.inertialRadiusOffset = 0)), this.lowerAlphaLimit && this.alpha < this.lowerAlphaLimit && (this.alpha = this.lowerAlphaLimit), this.upperAlphaLimit && this.alpha > this.upperAlphaLimit && (this.alpha = this.upperAlphaLimit), this.lowerBetaLimit && this.beta < this.lowerBetaLimit && (this.beta = this.lowerBetaLimit), this.upperBetaLimit && this.beta > this.upperBetaLimit && (this.beta = this.upperBetaLimit), this.lowerRadiusLimit && this.radius < this.lowerRadiusLimit && (this.radius = this.lowerRadiusLimit), this.upperRadiusLimit && this.radius > this.upperRadiusLimit && (this.radius = this.upperRadiusLimit), this._constraintToUpScene()
    }, t.prototype.setPosition = function(t) {
        var e = t.subtract(this._getTargetPosition());
        this.radius = e.length(), this.alpha = Math.atan(e.z / e.x), this.beta = Math.acos(e.y / this.radius)
    }, t.prototype._getViewMatrix = function() {
        this.beta > Math.PI && (this.beta = Math.PI), this.beta <= 0 && (this.beta = .01);
        var t = Math.cos(this.alpha), e = Math.sin(this.alpha), n = Math.cos(this.beta), i = Math.sin(this.beta), o = this._getTargetPosition();
        return o.addToRef(new BABYLON.Vector3(this.radius * t * i, this.radius * n, this.radius * e * i), this.position), BABYLON.Matrix.LookAtLHToRef(this.position, o, this.upVector, this._viewMatrix), this._viewMatrix
    }, t.prototype._constraintToUpScene = function() {
        var t = 3, e = -(this.target.y - t) / this.radius;
        if (!(Math.abs(e) > 1)) {
            var n = Math.abs(Math.acos(e));
            this.beta = BABYLON.Math.NormalizeAngle(this.beta), this.beta = Math.min(this.beta, n), this.beta = Math.max(this.beta, -n)
        }
    }, t
}();
var wnp = window.wnp || {};
wnp.Input = wnp.Input || {}, wnp.Input.FirstPersonCamera = function() {
    var t = !1, e = function(t, n, i) {
        BABYLON.Camera.call(this, t, n, i), this.cameraDirection = new BABYLON.Vector3(0, 0, 0), this.cameraRotation = new BABYLON.Vector2(0, 0), this.rotation = new BABYLON.Vector3(0, 0, 0), this.ellipsoid = new BABYLON.Vector3(.5, 1, .5), this._keys = [], this.keysUp = [38, 87], this.keysDown = [40, 83], this.keysLeft = [37, 81], this.keysRight = [39, 69], this.keysStrafeLeft = [65], this.keysStrafeRight = [68], GlobalHelper.hasAzertyKeyboard && (this.keysUp[1] = 90, this.keysLeft[1] = 65, this.keysStrafeLeft[0] = 81), this._collider = new BABYLON.Collider, this._needMoveForGravity = !0, this._currentTarget = BABYLON.Vector3.Zero(), this._viewMatrix = BABYLON.Matrix.Zero(), this._camMatrix = BABYLON.Matrix.Zero(), this._cameraTransformMatrix = BABYLON.Matrix.Zero(), this._cameraRotationMatrix = BABYLON.Matrix.Zero(), this._referencePoint = BABYLON.Vector3.Zero(), this._transformedReferencePoint = BABYLON.Vector3.Zero(), this._oldPosition = BABYLON.Vector3.Zero(), this._diffPosition = BABYLON.Vector3.Zero(), this._newPosition = BABYLON.Vector3.Zero(), this._lookAtTemp = BABYLON.Matrix.Zero(), this._tempMatrix = BABYLON.Matrix.Zero(), e.prototype._initCache.call(this)
    };
    e.prototype = Object.create(BABYLON.Camera.prototype);
    var n = BABYLON.Camera;
    return e.prototype.speed = 2, e.prototype.checkCollisions = !1, e.prototype.applyGravity = !1, e.prototype.noRotationConstraint = !1, e.prototype.angularSensibility = 2e3, e.prototype.lockedTarget = null, e.prototype.onCollide = null, e.prototype._getLockedTargetPosition = function() {
        return this.lockedTarget ? this.lockedTarget.position || this.lockedTarget : null
    }, e.prototype._onMessageBoxOpened = function() {
        t = !0
    }, e.prototype._onMessageBoxClosed = function() {
        t = !1
    }, e.prototype._initCache = function() {
        n.prototype._initCache.call(this), this._cache.lockedTarget = new BABYLON.Vector3(Number.MAX_VALUE, Number.MAX_VALUE, Number.MAX_VALUE), this._cache.rotation = new BABYLON.Vector3(Number.MAX_VALUE, Number.MAX_VALUE, Number.MAX_VALUE)
    }, e.prototype._updateCache = function(t) {
        t || n.prototype._updateCache.call(this);
        var e = this._getLockedTargetPosition();
        e ? this._cache.lockedTarget ? this._cache.lockedTarget.copyFrom(e) : this._cache.lockedTarget = e.clone() : this._cache.lockedTarget = null, this._cache.rotation.copyFrom(this.rotation)
    }, e.prototype._isSynchronizedViewMatrix = function() {
        if (!BABYLON.Camera.prototype._isSynchronizedViewMatrix.call(this))
            return !1;
        var t = this._getLockedTargetPosition();
        return (this._cache.lockedTarget ? this._cache.lockedTarget.equals(t) : !t) && this._cache.rotation.equals(this.rotation)
    }, e.prototype._computeLocalCameraSpeed = function() {
        return this.speed * (BABYLON.Tools.GetDeltaTime() / (10 * BABYLON.Tools.GetFps()))
    }, e.prototype.setTarget = function(t) {
        this.upVector.normalize(), BABYLON.Matrix.LookAtLHToRef(this.position, t, this.upVector, this._camMatrix), this._camMatrix.invert(), this.rotation.x = Math.atan(this._camMatrix.m[6] / this._camMatrix.m[10]);
        var e = t.subtract(this.position);
        this.rotation.y = e.x >= 0 ? -Math.atan(e.z / e.x) + Math.PI / 2 : -Math.atan(e.z / e.x) - Math.PI / 2, this.rotation.z = -Math.acos(BABYLON.Vector3.Dot(new BABYLON.Vector3(0, 1, 0), this.upVector)), isNaN(this.rotation.x) && (this.rotation.x = 0), isNaN(this.rotation.y) && (this.rotation.y = 0), isNaN(this.rotation.z) && (this.rotation.z = 0)
    }, e.prototype.lockUnrelatedActions = function() {
        var t = wanaplan.getComponentByName("EditionComponent3D");
        return t && (ujs.notify("wnp.request.configurator.cancel"), t.lock(this, 14), t.deselectObject()), !0
    }, e.prototype.unlockUnrelatedActions = function() {
        var t = wanaplan.getComponentByName("EditionComponent3D");
        return t && t.unlock(this, 14), !0
    }, e.prototype.attachControl = function(e, n) {
        var i, o = this, r = this._scene.getEngine();
        if (!this._attachedCanvas) {
            document.addEventListener("wnp.ui.messagebox.opened", this._onMessageBoxOpened, !1), document.addEventListener("wnp.ui.messagebox.closed", this._onMessageBoxClosed, !1), this.lockUnrelatedActions(), this._attachedCanvas = e, void 0 === this._onMouseDown && (this.onMouseDown = function(t) {
                i = t.touches && 1 == t.touches.length ? {x: t.touches[0].pageX,y: t.touches[0].pageY} : {x: t.clientX,y: t.clientY}, n || t.preventDefault()
            }, this.onMouseUp = function(t) {
                i = null, n || t.preventDefault()
            }, this.onMouseOut = function(t) {
                i = null, o._keys = [], n || t.preventDefault()
            }, this.onMouseMove = function(t) {
                if (i || r.isPointerLock) {
                    var e, s;
                    t.touches && 1 == t.touches.length ? (e = t.touches[0].pageX - i.x, s = t.touches[0].pageY - i.y, i = {x: t.touches[0].pageX,y: t.touches[0].pageY}) : r.isPointerLock ? (e = t.movementX || t.mozMovementX || t.webkitMovementX || t.msMovementX || 0, s = t.movementY || t.mozMovementY || t.webkitMovementY || t.msMovementY || 0) : (e = t.clientX - i.x, s = t.clientY - i.y, i = {x: t.clientX,y: t.clientY}), t.touches || (e *= -1, s *= -1), o.rotation.y -= e / o.angularSensibility, o.rotation.x - s / o.angularSensibility < Math.PI / 2 && o.rotation.x - s / o.angularSensibility > -Math.PI / 2 && (o.rotation.x -= s / o.angularSensibility), n || t.preventDefault()
                }
            }, this.onWheel = function(t) {
                var e = 0;
                t.wheelDelta ? e = t.wheelDelta / (120 * o.radiusSpeedFactor) : t.detail && (e = -t.detail / (3 * o.radiusSpeedFactor)), o.height + e < o.heightMax && o.height + e > o.heightMin && (o.height += e, o.position.y = o.height), t.preventDefault && (n || t.preventDefault())
            }, this.onKeyDown = function(e) {
                if (!t && (-1 !== o.keysUp.indexOf(e.keyCode) || -1 !== o.keysDown.indexOf(e.keyCode) || -1 !== o.keysLeft.indexOf(e.keyCode) || -1 !== o.keysRight.indexOf(e.keyCode) || -1 !== o.keysStrafeLeft.indexOf(e.keyCode) || -1 !== o.keysStrafeRight.indexOf(e.keyCode))) {
                    var i = o._keys.indexOf(e.keyCode);
                    -1 === i && o._keys.push(e.keyCode), n || e.preventDefault()
                }
            }, this.onKeyUp = function(e) {
                if (!t && (-1 !== o.keysUp.indexOf(e.keyCode) || -1 !== o.keysDown.indexOf(e.keyCode) || -1 !== o.keysLeft.indexOf(e.keyCode) || -1 !== o.keysRight.indexOf(e.keyCode) || -1 !== o.keysStrafeLeft.indexOf(e.keyCode) || -1 !== o.keysStrafeRight.indexOf(e.keyCode))) {
                    var i = o._keys.indexOf(e.keyCode);
                    i >= 0 && o._keys.splice(i, 1), n || e.preventDefault()
                }
            }, this.onLostFocus = function() {
                o._keys = []
            }, this.reset = function() {
                o._keys = [], i = null, o.cameraDirection = new BABYLON.Vector3(0, 0, 0), o.cameraRotation = new BABYLON.Vector2(0, 0)
            });
            var s = window.PointerEvent ? "pointer" : "mouse";
            e.addEventListener(s + "down", this.onMouseDown, !1), e.addEventListener(s + "up", this.onMouseUp, !1), e.addEventListener(s + "out", this.onMouseOut, !1), e.addEventListener(s + "move", this.onMouseMove, !1), e.addEventListener("mousewheel", this.onWheel, !1), window.addEventListener("keydown", this.onKeyDown, !1), window.addEventListener("keyup", this.onKeyUp, !1), window.addEventListener("blur", this.onLostFocus, !1), document.addEventListener("touchend", this.onMouseUp, !1), document.addEventListener("touchcancel", this.onMouseUp, !1), document.addEventListener("touchmove", this.onMouseMove, !1), document.addEventListener("touchstart", this.onMouseDown, !1)
        }
    }, e.prototype.detachControl = function(t) {
        if (this._attachedCanvas == t) {
            this.unlockUnrelatedActions();
            var e = window.PointerEvent ? "pointer" : "mouse";
            t.removeEventListener(e + "down", this.onMouseDown), t.removeEventListener(e + "up", this.onMouseUp), t.removeEventListener(e + "out", this.onMouseOut), t.removeEventListener(e + "move", this.onMouseMove), t.removeEventListener("mousewheel", this.onWheel), window.removeEventListener("keydown", this.onKeyDown), window.removeEventListener("keyup", this.onKeyUp), window.removeEventListener("blur", this.onLostFocus), document.removeEventListener("touchend", this.onMouseUp), document.removeEventListener("touchcancel", this.onMouseUp), document.removeEventListener("touchmove", this.onMouseMove), document.removeEventListener("touchstart", this.onMouseDown), document.removeEventListener("wnp.ui.messagebox.opened", this._onMessageBoxOpened), document.removeEventListener("wnp.ui.messagebox.closed", this._onMessageBoxClosed), this._attachedCanvas = null, this._reset && this._reset()
        }
    }, e.prototype._collideWithWorld = function(t) {
        this.position.subtractFromFloatsToRef(0, this.ellipsoid.y, 0, this._oldPosition), this._collider.radius = this.ellipsoid, this._scene._getNewPosition(this._oldPosition, t, this._collider, 3, this._newPosition), this._newPosition.subtractToRef(this._oldPosition, this._diffPosition), this._diffPosition.length() > BABYLON.Engine.collisionsEpsilon && (this.position.addInPlace(this._diffPosition), this.onCollide && this.onCollide(this._collider.collidedMesh))
    }, e.prototype._checkInputs = function() {
        this._localDirection || (this._localDirection = BABYLON.Vector3.Zero(), this._transformedDirection = BABYLON.Vector3.Zero()), this._localRotation || (this._localRotation = BABYLON.Vector3.Zero(), this._transformedRotation = BABYLON.Vector3.Zero());
        for (var t = 0; t < this._keys.length; t++) {
            var e = this._keys[t], n = this._computeLocalCameraSpeed(), i = BABYLON.Tools.GetFps() / 60;
            -1 !== this.keysLeft.indexOf(e) ? this._localRotation.copyFromFloats(0, -n / 3 * i, 0) : -1 !== this.keysUp.indexOf(e) ? this._localDirection.copyFromFloats(0, 0, 100 * n * i) : -1 !== this.keysRight.indexOf(e) ? this._localRotation.copyFromFloats(0, n / 3 * i, 0) : -1 !== this.keysDown.indexOf(e) ? this._localDirection.copyFromFloats(0, 0, 100 * -n * i) : -1 !== this.keysStrafeLeft.indexOf(e) ? this._localDirection.copyFromFloats(100 * -n * i, 0, 0) : -1 !== this.keysStrafeRight.indexOf(e) && this._localDirection.copyFromFloats(100 * n * i, 0, 0), this.getViewMatrix().invertToRef(this._cameraTransformMatrix), -1 !== this.keysUp.indexOf(e) || -1 !== this.keysDown.indexOf(e) || -1 !== this.keysStrafeLeft.indexOf(e) || -1 !== this.keysStrafeRight.indexOf(e) ? (BABYLON.Vector3.TransformNormalToRef(this._localDirection, this._cameraTransformMatrix, this._transformedDirection), this.position.addInPlace(this._transformedDirection)) : (BABYLON.Vector3.TransformNormalToRef(this._localRotation, this._cameraTransformMatrix, this._transformedRotation), this.rotation.y += this._transformedRotation.y), this.position.y = this.height
        }
    }, e.prototype.moveLocal = function(t) {
        BABYLON.Vector3.TransformNormalToRef(t, this._cameraTransformMatrix, this._transformedDirection), this.position.addInPlace(this._transformedDirection)
    }, e.prototype.rotateLocal = function(t) {
        this._transformedRotation = BABYLON.Vector3.Zero(), BABYLON.Vector3.TransformNormalToRef(t, this._cameraTransformMatrix, this._transformedRotation), this.rotation.x += this._transformedRotation.x, this.rotation.x = ujs.Math.clamp(this.rotation.x, -Math.PI / 2, Math.PI / 2), this.rotation.y += this._transformedRotation.y
    }, e.prototype._update = function() {
        this._checkInputs();
        var t = this._needMoveForGravity || Math.abs(this.cameraDirection.x) > 0 || Math.abs(this.cameraDirection.y) > 0 || Math.abs(this.cameraDirection.z) > 0, e = Math.abs(this.cameraRotation.x) > 0 || Math.abs(this.cameraRotation.y) > 0;
        if (t)
            if (this.checkCollisions && this._scene.collisionsEnabled) {
                if (this._collideWithWorld(this.cameraDirection), this.applyGravity) {
                    var n = this.position;
                    this._collideWithWorld(this._scene.gravity), this._needMoveForGravity = 0 != BABYLON.Vector3.DistanceSquared(n, this.position)
                }
            } else
                this.position.addInPlace(this.cameraDirection);
        if (e && (this.rotation.x += this.cameraRotation.x, this.rotation.y += this.cameraRotation.y, !this.noRotationConstraint)) {
            var i = Math.PI / 2 * .95;
            this.rotation.x > i && (this.rotation.x = i), this.rotation.x < -i && (this.rotation.x = -i)
        }
        t && (Math.abs(this.cameraDirection.x) < BABYLON.Engine.epsilon && (this.cameraDirection.x = 0), Math.abs(this.cameraDirection.y) < BABYLON.Engine.epsilon && (this.cameraDirection.y = 0), Math.abs(this.cameraDirection.z) < BABYLON.Engine.epsilon && (this.cameraDirection.z = 0), this.cameraDirection.scaleInPlace(this.inertia)), e && (Math.abs(this.cameraRotation.x) < BABYLON.Engine.epsilon && (this.cameraRotation.x = 0), Math.abs(this.cameraRotation.y) < BABYLON.Engine.epsilon && (this.cameraRotation.y = 0), this.cameraRotation.scaleInPlace(this.inertia))
    }, e.prototype._getViewMatrix = function() {
        return BABYLON.Vector3.FromFloatsToRef(0, 0, 1, this._referencePoint), this.lockedTarget ? this._currentTarget.copyFrom(this._getLockedTargetPosition()) : (0 != this.upVector.x || 1 != this.upVector.y || 0 != this.upVector.z ? (BABYLON.Matrix.LookAtLHToRef(BABYLON.Vector3.Zero(), this._referencePoint, this.upVector, this._lookAtTemp), BABYLON.Matrix.RotationYawPitchRollToRef(this.rotation.y, this.rotation.x, this.rotation.z, this._cameraRotationMatrix), this._lookAtTemp.multiplyToRef(this._cameraRotationMatrix, this._tempMatrix), this._lookAtTemp.invert(), this._tempMatrix.multiplyToRef(this._lookAtTemp, this._cameraRotationMatrix)) : BABYLON.Matrix.RotationYawPitchRollToRef(this.rotation.y, this.rotation.x, this.rotation.z, this._cameraRotationMatrix), BABYLON.Vector3.TransformCoordinatesToRef(this._referencePoint, this._cameraRotationMatrix, this._transformedReferencePoint), this.position.addToRef(this._transformedReferencePoint, this._currentTarget)), BABYLON.Matrix.LookAtLHToRef(this.position, this._currentTarget, this.upVector, this._viewMatrix), this._viewMatrix
    }, e
}();
var wnp = window.wnp || {};
wnp.Input = wnp.Input || {}, wnp.Input.TouchManager = function(t) {
    var e = [{x: 0,y: 0}, {x: 0,y: 0}], n = [{x: 0,y: 0}, {x: 0,y: 0}], i = {x: 0,y: 0,reset: function() {
            this.x = 0, this.y = 0
        },update: function() {
            this.x = e[0].x - n[0].x, this.y = e[0].y - n[0].y
        }}, o = {timer: 0,duration: 200}, r = {sx: 0,sy: 0,timer: null,duration: 900,deadZone: 5}, s = !1, a = 2, l = !1, h = 0, c = 0, u = 0, p = !1, d = {}, m = null, g = -1;
    this.on = function(t, e) {
        d[t] = e
    }, this.off = function(t) {
        delete d[t]
    }, this.setDeadZone = function(t) {
        a = t
    };
    var f = function(t, n) {
        var i = document.createEvent("HTMLEvents");
        i.initEvent(t, !0, !1), i.pageX = e[0].x, i.pageY = e[0].y, i.clientX = e[0].x, i.clientY = e[0].y, i.detail = -h, i.distance = c, i.wheelDeltaY = m ? h : +(c - u) > 0 ? 2.5 : -2.5, i.button = 0;
        for (var o in n)
            i[o] = n[o];
        return i
    }, y = function(t, e) {
        d[t] && d[t](f(t, e))
    }, _ = function(t, e) {
        var n = t.x - e.x, i = t.y - e.y;
        return Math.sqrt(n * n + i * i)
    }, v = function(t, i, o) {
        o || (n[i].x = e[i].x, n[i].y = e[i].y), window.PointerEvent && t instanceof window.PointerEvent || window.MSPointerEvent && t instanceof MSPointerEvent ? (e[i].x = t.clientX || t.pageX, e[i].y = t.clientY || t.pageY) : t.touches && (e[i].x = t.touches[i].clientX || t.touches[i].pageX, e[i].y = t.touches[i].clientY || t.touches[i].pageY), o && (n[i].x = e[i].x, n[i].y = e[i].y)
    }, b = function(t, e) {
        v(t, 0, e), t.touches && t.touches.length > 1 && v(t, 1, e)
    }, w = function(t) {
        if (t.preventDefault(), !("pointerdown" === t.type && g > -1)) {
            g = t.pointerId, s = !0, l = !1, b(t, !0);
            var n = 0;
            t.touches && t.touches.length > 1 && (n = 1), y("touchDown", {button: n}), t.touches && 1 === t.touches.length || g ? (y("tap"), o.timer ? (clearTimeout(o.timer), o.timer = null, y("dblTap")) : o.timer = setTimeout(function() {
                clearTimeout(o.timer), o.timer = null
            }, o.duration), r.timer && clearTimeout(r.timer), r.sx = e[0].x, r.sy = e[0].y, r.timer = setTimeout(function() {
                clearTimeout(r.timer), r.timer = null;
                var t = e[0].x - r.sx, n = e[0].y - r.sy;
                Math.abs(t) < r.deadZone && Math.abs(n) < r.deadZone && y("longPress")
            }, r.duration)) : t.touches && t.touches.length > 1 && y("touchUp")
        }
    }, x = function(t) {
        if (!(p || "pointerdown" === t.type && t.pointerId !== g) && (t.preventDefault(), b(t), i.update(), l || (l = Math.abs(i.x) > a || Math.abs(i.y) > a)))
            if (t.touches && 2 == t.touches.length) {
                y("touchUp");
                var o = e[0].x - n[0].x, r = e[1].y - n[1].y;
                u = c, c = _(e[0], e[1]), h = Math.abs(o) > Math.abs(r) ? o : r, y("swipe"), y("rotate")
            } else
                s && y("touchMove")
    }, C = function(t) {
        h = 0, c = 0, u = 0, s = !1, l = !1, t.pointerId && g === t.pointerId && (g = -1), r.timer && (clearTimeout(r.timer), r.timer = null), y("touchUp")
    }, M = function(e) {
        void 0 !== window.MSGesture && (m || (m = new MSGesture, m.target = t), m.addPointer(e.pointerId))
    }, D = function(t) {
        1 !== t.scale ? (h = 50 * t.scale * (t.expansion > 0 ? 1 : -1), p = !0, y("touchUp"), y("swipe"), y("rotate"), t.stopPropagation(), t.preventDefault()) : p = !1
    }, B = GlobalHelper.getWrappedMouseEventNames();
    this.start = function() {
        t.addEventListener(B.down, w, !1), t.addEventListener(B.move, x, !1), t.addEventListener(B.up, C, !1), t.addEventListener(B.cancel, C, !1), B.out && t.addEventListener(B.out, C, !1), t.addEventListener("MSPointerDown", M, !1), t.addEventListener("MSGestureChange", D, !1)
    }, this.stop = function() {
        t.removeEventListener(B.down, w), t.removeEventListener(B.move, x), t.removeEventListener(B.up, C), t.removeEventListener(B.cancel, C), B.out && t.removeEventListener(B.out, C), t.removeEventListener("MSPointerDown", M), t.removeEventListener("MSGestureChange", D)
    }
};
var wnp = window.wnp || {};
wnp.PointerManager = function() {
    var t = function(t, e, n, i) {
        var i = i || {};
        this.BUTTON_LEFT = 1, this.BUTTON_MIDDLE = 2, this.BUTTON_RIGHT = 4, this.ACTION_CLICK = 1, this.ACTION_DBLCLICK = 2, this.ACTION_DRAGSTART = 4, this.ACTION_DRAGGING = 8, this.ACTION_DRAGEND = 16, this.ACTION_SCROLLUP = 32, this.ACTION_SCROLLDOWN = 64, this.MODIFIER_ALT = 1, this.MODIFIER_CTRL = 2, this.MODIFIER_SHIFT = 4, this.pos = new BABYLON.Vector2, this.posDelta = new BABYLON.Vector2, this.buttons = 0, this.actions = 0, this.modifiers = 0, this._core = t || wanaplan, this._callback = e || null, this._domElement = n || document.body, this._offsets = i.offsets || new BABYLON.Vector2, this._width = i.width || this._domElement.clientWidth, this._height = i.height || this._domElement.clientHeight, this._lastState = this.getStatus(), this._initialised = !1, this.touchManager = new wnp.Input.TouchManager(this._domElement), this.setDomElement(this._domElement), this.mode = 0
    };
    return t.prototype.setDomElement = function(t) {
        this._domElement = t, this.onMouseDown = this.onMouseDown.bind(this), this.onMouseMove = this.onMouseMove.bind(this), this.onMouseUp = this.onMouseUp.bind(this), this.onMouseDoubleClick = this.onMouseDoubleClick.bind(this), this.onMouseWheel = this.onMouseWheel.bind(this), this.addTouchSupport(), this.addMouseSupport()
    }, t.prototype.addMouseSupport = function() {
        window.PointerEvent ? (this._domElement.addEventListener("pointerdown", this.onMouseDown, !1), this._domElement.addEventListener("pointermove", this.onMouseMove, !1), this._domElement.addEventListener("pointerup", this.onMouseUp, !1), document.addEventListener("pointerup", this.onMouseUp, !1)) : (this._domElement.addEventListener("mousedown", this.onMouseDown, !1), this._domElement.addEventListener("mousemove", this.onMouseMove, !1), this._domElement.addEventListener("mouseup", this.onMouseUp, !1), document.addEventListener("mouseup", this.onMouseUp, !1)), this._domElement.addEventListener("dblclick", this.onMouseDoubleClick, !1), this._domElement.addEventListener("mousewheel", this.onMouseWheel, !1), this._domElement.addEventListener("DOMMouseScroll", this.onMouseWheel, !1)
    }, t.prototype.removeMouseSupport = function() {
        window.PointerEvent ? (this._domElement.removeEventListener("pointerdown", this.onMouseDown), this._domElement.removeEventListener("pointermove", this.onMouseMove), this._domElement.removeEventListener("pointerup", this.onMouseUp), document.removeEventListener("pointerup", this.onMouseUp)) : (this._domElement.removeEventListener("mousedown", this.onMouseDown), this._domElement.removeEventListener("mousemove", this.onMouseMove), this._domElement.removeEventListener("mouseup", this.onMouseUp), document.removeEventListener("mouseup", this.onMouseUp)), this._domElement.removeEventListener("dblclick", this.onMouseDoubleClick), this._domElement.removeEventListener("mousewheel", this.onMouseWheel), this._domElement.removeEventListener("DOMMouseScroll", this.onMouseWheel), this.mode = 1
    }, t.prototype.addTouchSupport = function() {
        this.touchManager.start(), this.touchManager.on("tap", this.onMouseDown), this.touchManager.on("touchMove", this.onMouseMove), this.touchManager.on("touchUp", this.onMouseUp), this.touchManager.on("longPress", this.onMouseDoubleClick), this.touchManager.on("swipe", this.onMouseWheel)
    }, t.prototype.removeTouchSupport = function() {
        this.touchManager.stop(), this.touchManager.off("tap", this.onMouseDown), this.touchManager.off("touchMove", this.onMouseMove), this.touchManager.off("touchUp", this.onMouseUp), this.touchManager.off("longPress", this.onMouseDoubleClick), this.touchManager.off("swipe", this.onMouseWheel), this.mode = 2
    }, t.prototype.getStatus = function() {
        var t = {};
        return t.BUTTON_LEFT = this.BUTTON_LEFT, t.BUTTON_MIDDLE = this.BUTTON_MIDDLE, t.BUTTON_RIGHT = this.BUTTON_RIGHT, t.ACTION_CLICK = this.ACTION_CLICK, t.ACTION_DBLCLICK = this.ACTION_DBLCLICK, t.ACTION_DRAGSTART = this.ACTION_DRAGSTART, t.ACTION_DRAGGING = this.ACTION_DRAGGING, t.ACTION_DRAGEND = this.ACTION_DRAGEND, t.ACTION_SCROLLUP = this.ACTION_SCROLLUP, t.ACTION_SCROLLDOWN = this.ACTION_SCROLLDOWN, t.MODIFIER_ALT = this.MODIFIER_ALT, t.MODIFIER_CTRL = this.MODIFIER_CTRL, t.MODIFIER_SHIFT = this.MODIFIER_SHIFT, t.pos = this.pos.clone(), t.posDelta = this.posDelta.clone(), t.buttons = this.buttons, t.prevButtons = this._lastState ? this._lastState.buttons : 0, t.actions = this.actions, t.modifiers = this.modifiers, t.planPos = this.pos.clone(), t.planPos.subtractInPlace(this._core.engine2D.getTranslation()), t.planPos.scaleInPlace(1 / this._core.engine2D.getZoom()), t.plan3DPos = new BABYLON.Vector2(this.pos.x / this._core.getWidth() * 2 - 1, 2 * -(this.pos.y / this._core.getHeight()) + 1), t
    }, t.prototype.reset = function() {
        this.buttons = 0, this.actions = 0, this.posDelta = new BABYLON.Vector2(0, 0)
    }, t.prototype.resize = function(t, e) {
        this._width = t || this._domElement.clientWidth || this._domElement.innerWidth, this._height = e || this._domElement.clientHeight || this._domElement.innerHeight
    }, t.prototype._getX = function(t) {
        var e = 0;
        return t.pageX ? e = t.pageX : t.clientX && (e = t.clientX + (document.documentElement.scrollLeft ? document.documentElement.scrollLeft : document.body.scrollLeft)), e
    }, t.prototype._getY = function(t) {
        var e = 0;
        return t.pageY ? e = t.pageY : t.clientY && (e = t.clientY + (document.documentElement.scrollTop ? document.documentElement.scrollTop : document.body.scrollTop)), e
    }, t.prototype._getButton = function(t) {
        if (t.touches && t.touches.length > 0)
            return this.BUTTON_LEFT;
        switch (t.button) {
            case 0:
                return this.BUTTON_LEFT;
            case 1:
                return this.BUTTON_MIDDLE;
            case 2:
                return this.BUTTON_RIGHT
        }
        return 0
    }, t.prototype._updateMouseState = function(t, e) {
        var n = t;
        (GlobalHelper.isMobileDevice() || n.target && "canvas" == n.target.tagName.toLowerCase() || this.preventDefault) && n.preventDefault(), "undefined" != typeof t.touches && t.touches.length > 0 && (n = t.touches[0]);
        var e = e || 0, i = this._getX(n), o = this._getY(n);
        i + o > 0 && this.pos.copyFromFloats(i, o), this._initialised || (this._initialised = !0, this._lastState.pos.copyFrom(this.pos)), this.posDelta = this.pos.subtract(this._lastState.pos), "tap" == n.type && (this.posDelta = new BABYLON.Vector2(0, 0)), this.actions = 0, this.actions |= e, 0 == this.buttons && this._lastState.buttons > 0 && 0 == (this._lastState.actions & this.ACTION_DRAGGING) && 0 == (this._lastState.actions & this.ACTION_DBLCLICK) ? this.actions |= this.ACTION_CLICK : this.buttons > 0 && 0 == this._lastState.actions && (0 != this.posDelta.x || 0 != this.posDelta.y) ? (this.actions |= this.ACTION_DRAGSTART, this.pos.x = this._lastState.pos.x, this.pos.y = this._lastState.pos.y) : this.buttons > 0 && ((this._lastState.actions & this.ACTION_DRAGSTART) > 0 || (this._lastState.actions & this.ACTION_DRAGGING) > 0) ? this.actions |= this.ACTION_DRAGGING : 0 == this.buttons && ((this._lastState.actions & this.ACTION_DRAGSTART) > 0 || (this._lastState.actions & this.ACTION_DRAGGING) > 0) && (this.actions |= this.ACTION_DRAGEND), this.modifiers = 0, n.altKey && (this.modifiers |= this.MODIFIER_ALT), n.ctrlKey && (this.modifiers |= this.MODIFIER_CTRL), n.shiftKey && (this.modifiers |= this.MODIFIER_SHIFT), this._notifyCb(n), this._lastState = this.getStatus()
    }, t.prototype._notifyCb = function(t) {
        null != this._callback && (this._callback(t, this.getStatus()), ujs.notify("wnp.input.pointerchanged", {inputStatus: this.getStatus()}))
    }, t.prototype.onMouseDown = function(t) {
        this.buttons |= this._getButton(t), this._updateMouseState(t)
    }, t.prototype.onMouseMove = function(t) {
        this._updateMouseState(t), t.preventDefault()
    }, t.prototype.onMouseUp = function(t) {
        this.buttons &= !this._getButton(t), this._updateMouseState(t)
    }, t.prototype.onMouseDoubleClick = function(t) {
        this._updateMouseState(t, this.ACTION_DBLCLICK)
    }, t.prototype.onMouseWheel = function(t) {
        var e = 0;
        t.wheelDeltaY ? e = t.wheelDeltaY : t.wheelDelta ? e = t.wheelDelta : t.detail && (e = -t.detail), 0 != e && (e > 0 ? this._updateMouseState(t, this.ACTION_SCROLLUP) : this._updateMouseState(t, this.ACTION_SCROLLDOWN), t.preventDefault())
    }, t
}();
var Keys = {up: 38,down: 40,left: 37,right: 39,space: 32,escape: 27,shift: 16,ctrl: 17,alt: 18,tab: 9,a: 65,z: 90,e: 69,q: 81,s: 83,d: 68,r: 82,cmd: 91}, wnp = window.wnp || {};
wnp.KeyboardManager = function() {
    function t(t) {
        for (var e = 0; 110 > e; e++)
            t[e] = !1
    }
    var e, n = [], i = function() {
        this.keys = [], this.preventDefault = !1, this.initialized = !1;
        for (var t = 0; 110 > t; t++)
            this.keys[t] = !1;
        n = [8], e = this
    };
    return i.prototype.initialize = function() {
        t(this.keys), this.startEventsListening()
    }, i.prototype.destroy = function() {
        t(this.keys), this.stopEventsListening()
    }, i.prototype.startEventsListening = function() {
        this.initialized || (document.addEventListener("keydown", this.onKeyStateChange, !1), document.addEventListener("keyup", this.onKeyStateChange, !1), window.addEventListener("focus", this.onFocus, !1), this.initialized = !0)
    }, i.prototype.stopEventsListening = function() {
        this.initialized && (document.removeEventListener("keydown", this.onKeyStateChange), document.removeEventListener("keyup", this.onKeyStateChange), window.removeEventListener("focus", this.onFocus, !1), this.initialized = !1)
    }, i.prototype.onFocus = function() {
        for (var t = 0; t < e.keys.length; t++)
            e.keys[t] = !1
    }, i.prototype.onKeyStateChange = function(t) {
        var i = "keydown" == t.type ? !0 : !1, o = "keydown" == t.type ? "wnp.keyboardManager.keyDown" : "wnp.keyboardManager.keyUp";
        if (ujs.notify(o, t), "INPUT" == document.activeElement.nodeName || "TEXTAREA" == document.activeElement.nodeName)
            ;
        else if (e.preventDefault === !0)
            t.preventDefault();
        else
            for (var r = 0, s = n.length; s > r; r++)
                t.keyCode == n[r] && t.preventDefault();
        e.keys[t.keyCode] = i
    }, i.prototype.isPressed = function(t) {
        if (t instanceof Array) {
            for (var e = !1, n = 0, i = this.keys.length; i > n && !e; )
                e = this.keys[t[n]], n++;
            return e
        }
        return this.keys[t]
    }, i.prototype.isReleased = function(t) {
        return !this.isPressed(t)
    }, i
}();
var wnp = window.wnp || {};
wnp.MaterialFactory = function() {
    var t = function(t) {
        this.configuration = t
    };
    return t.prototype.mergeParams = function(t, e) {
        var t = t || {}, e = e || {}, n = t;
        for (var i in e)
            n[i] = e[i];
        return n
    }, t.RepeatTextureXY = function(t, e, n) {
        return t.uScale = e, t.vScale = n, t
    }, t.MakeBasicMaterial = function(t) {
        t.ambientColor.copyFromFloats(.6, .6, .6), t.diffuseColor.copyFromFloats(0, 0, 0), t.specularColor.copyFromFloats(0, 0, 0), t.emissiveColor.copyFromFloats(.05, .05, .05)
    }, t.MakeBasicColor = function(t, e) {
        t.ambientColor.copyFromFloats(0, 0, 0), t.specularColor.copyFromFloats(0, 0, 0), t.diffuseColor.copyFromFloats(0, 0, 0), t.emissiveColor.copyFrom(e)
    }, t.MakeDefaultMaterial = function(t) {
        t.ambientColor.copyFromFloats(.2, .2, .2), t.diffuseColor.copyFromFloats(0, 0, 0), t.specularColor.copyFromFloats(.7, .7, .7), t.specularPower = 10
    }, t.ImportWNPMaterial = function(e) {
        var n = e.materialType;
        if (e = e || {}, e.url && (e.diffuseTexture = e.url), e.maps)
            for (var i in e.maps)
                "normal" == i ? e.bumpTexture = e.url.replace(".jpg", e.maps[i] + ".jpg") : e[i + "Texture"] = e.url.replace(".jpg", e.maps[i] + ".jpg");
        n = -1 !== n.indexOf("wnp.") ? n : "wnp." + (n.charAt("0").toUpperCase() + n.slice(1)) + "Material";
        var o = ujs.getProperty(window, n);
        o ? o = new o(e.name || "ImportedMaterial", wanaplan.engine3D.scene) : (o = new BABYLON.StandardMaterial(e.name || "ImportedMaterial", wanaplan.engine3D.scene), this.MakeDefaultMaterial(o)), e.color && (o.diffuseColor.copyFrom(e.color), o.params.baseColor = e.color);
        for (var r in e)
            void 0 !== o[r] && null !== o[r] ? e[r] instanceof Array && o[r].fromArray ? o[r].fromArray(e[r]) : e[r] instanceof Object && o[r].copyFrom ? o[r].copyFrom(e[r]) : -1 !== r.indexOf("Texture") ? (o[r] = new BABYLON.Texture(e[r], wanaplan.engine3D.scene), o[r].vScale = e.vScale || e.scale || 1, o[r].uScale = e.uScale || e.scale || 1, o[r].hasAlpha = e.hasAlpha || !1) : o[r] = e[r] : -1 !== r.indexOf("Texture") ? (o[r] = new BABYLON.Texture(e[r], wanaplan.engine3D.scene), o[r].vScale = e.vScale || e.scale || 1, o[r].uScale = e.uScale || e.scale || 1) : o[r] = e[r];
        if ((-1 != n.indexOf("Glass") || -1 != n.indexOf("Transparent") || -1 != n.indexOf("Metal")) && e.addColor && e.addColor.color)
            o.setBaseColor(e.addColor.color);
        else if (e.addColor && e.addColor.color && o.diffuseTexture) {
            o.addColor = e.addColor, e.addColor.size = e.addColor.size || {width: 512,height: 512};
            var s = new Image, a = e.addColor.color;
            s.crossOrigin = "Anonymous", s.src = o.diffuseTexture.url;
            var l = new BABYLON.DynamicTexture("canvas", e.addColor.size.width, wanaplan.engine3D.scene, !0);
            l.url = o.diffuseTexture.url, o.diffuseTexture = l, o.diffuseColor = new BABYLON.Color3(a.r, a.g, a.b).scale(.2), s.onload = function() {
                var n = l.getContext();
                n.fillStyle = t.rgbToHex(a), n.clearRect(0, 0, e.addColor.size.width, e.addColor.size.height), n.drawImage(s, 0, 0, e.addColor.size.width, e.addColor.size.height), n.globalCompositeOperation = "soft-light", n.globalCompositeOperation = "color-burn", n.globalCompositeOperation = "multiply", n.fillRect(0, 0, e.addColor.size.width, e.addColor.size.height), l.wrapU = BABYLON.Texture.WRAP_ADDRESSMODE, l.wrapV = BABYLON.Texture.WRAP_ADDRESSMODE, l.vScale = e.vScale || e.scale || 1, l.uScale = e.uScale || e.scale || 1, l.update()
            }
        }
        return o
    }, t.rgbToHex = function(e, n) {
        var i, o, r, n = n || !1, e = e || {r: 1,g: 1,b: 1};
        return n ? (i = e.r, o = e.g, r = e.b) : (i = Math.round(255 * e.r), o = Math.round(255 * e.g), r = Math.round(255 * e.b)), "#" + t.decToHex(i, 2) + t.decToHex(o, 2) + t.decToHex(r, 2)
    }, t.decToHex = function(t, e) {
        for (var e = e || 0, n = t.toString(16), i = n.length; e > i; i++)
            n = "0" + n;
        return n
    }, t
}();
var wnp = window.wnp || {};
wnp.Structure = function() {
    function t(t) {
        var e = {};
        for (var n in t)
            e[n] = t[n].serialize();
        return e
    }
    function e(t, e) {
        e.length = 0;
        for (var n in t) {
            var i = new window[t[n].name];
            i.deserialize(t[n]), i.updateReferences(i), e.push(i)
        }
    }
    var n = function(t) {
        this.uuid = wnp.uuid.uuid4(), this.lastModified = (new Date).getTime(), this.name = "planStructure", this.members = [], this.currentStructureIndex = 0, this.version = t, this.lastMaterialsUsed = [], this.structureVersion = t, this.params = {}, this.customData = {}
    };
    return n.prototype.clear = function() {
        this.members.length = 0, this.currentStructureIndex = 0, this.uuid = wnp.uuid.uuid4(), this.lastModified = (new Date).getTime(), this.params = {}
    }, n.prototype.getVersion = function() {
        return this.version
    }, n.prototype.getLength = function() {
        return this.members.length
    }, n.prototype.addElement = function(t) {
        return -1 == this.members.indexOf(t) ? (t.id = this.members.push(t) - 1, !0) : !1
    }, n.prototype.addToCurrentStructure = function(t) {
        this.members[this.currentStructureIndex].add(t)
    }, n.prototype.getElement = function(t) {
        return t > -1 && t < this.members.length ? this.members[t] : null
    }, n.prototype.getElementByName = function(t) {
        for (var e = this.members.length, n = 0, i = null; e > n && null === i; )
            i = this.members[n].name == t ? this.members[n] : i, n++;
        return i
    }, n.prototype.removeElement = function(t) {
        var e = this.members.indexOf(t);
        return e > -1 ? (this.members.splice(e, 1), this.reindexMembers(), !0) : !1
    }, n.prototype.getCurrentStructure = function() {
        return this.members[this.currentStructureIndex]
    }, n.prototype.setCurrentStructureIndex = function(t) {
        t > -1 && t < this.members.length && (this.currentStructureIndex = t)
    }, n.prototype.serialize = function() {
        function e(t) {
            for (var n in t)
                "object" == typeof t[n] ? e(t[n]) : "number" == typeof t[n] && (t[n] = Math.round(1e3 * t[n]) / 1e3)
        }
        var n = this;
        n.lastModified = (new Date).getTime();
        var i = {uuid: n.uuid,lastModified: n.lastModified,version: n.getVersion(),structureVersion: n.structureVersion,name: n.name,current: n.currentStructureIndex,members: t(n.members),lastMaterialsUsed: n.lastMaterialsUsed,params: n.params,customData: ujs.serializeObject(n.customData)};
        return e(i), JSON.stringify(i)
    }, n.prototype.deserialize = function(t) {
        var n = JSON.parse(t);
        return this.currentStructureIndex = 0 | +n.current, this.name = n.name, this.version = n.version, this.structureVersion = n.structureVersion, this.uuid = n.uuid || wnp.uuid.uuid4(), this.lastModified = n.lastModified || 0, this.lastMaterialsUsed = n.lastMaterialsUsed || [], this.params = n.params || {}, this.customData = ujs.deserializeObject(n.customData) || {}, e(n.members, this.members), this.reindexMembers(), !0
    }, n.prototype.addMemberAtIndex = function(t, e) {
        this.members.splice(t, 0, e), this.reindexMembers()
    }, n.prototype.reindexMembers = function() {
        for (var t = 0; t < this.members.length; t++)
            this.members[t].id = t
    }, n.prototype.updateFloorElevations = function() {
        for (var t = 0, e = 0; e < this.members.length; e++) {
            var n = this.getElement(e);
            n instanceof FloorStructure && (n.elevation = t, t += n.height)
        }
    }, n
}();
var wnp = window.wnp || {};
wnp.Configuration = function() {
    var t = null;
    LOCAL_STORAGE_CONFIGURATION_KEY = "wnp.configuration";
    var e = function() {
        this.boundingSize = {min: {x: -5e3,y: -5e3,z: -5e3},max: {x: 5e3,y: 5e3,z: 5e3},getSize: function() {
                return {x: this.max.x - this.min.x,y: this.max.y - this.min.y,z: this.max.z - this.min.z}
            }}, this.hardwareScalingLevel = 1, this.hasMobileConfig = !1, this.maxTextureSize = 1024, this.useAntialiasing = !0, this.useEnvMap = !0, this.useMultiLights = !0, this.useMultiTexturing = !0, this.useShadow = !0, this.useStats = !0, this.useAreaProcessing = !0, this.useRealtimeMeasure = !0, this.loadConfiguration(), t = this
    };
    return e.prototype.loadConfiguration = function() {
        var t = wnpLocalStorage.getItem(LOCAL_STORAGE_CONFIGURATION_KEY);
        if (null != t) {
            var e = JSON.parse(t);
            this.useAntialiasing = e.useAntialiasing, this.useAreaProcessing = e.useAreaProcessing, this.useRealtimeMeasure = e.useRealtimeMeasure, this.useShadow = e.useShadow, this.useEnvMap = e.useEnvMap, this.useMultiTexturing = e.useMultiTexturing, this.maxTextureSize = e.maxTextureSize, this.useMultiLights = e.useMultiLights, this.useStats = e.useStats, this.hasMobileConfig = e.hasMobileConfig, this.hardwareScalingLevel = e.hardwareScalingLevel ? e.hardwareScalingLevel : 1
        }
        return t ? !0 : !1
    }, e.prototype.saveConfiguration = function() {
        var t = this.serialize();
        wnpLocalStorage.setItem(LOCAL_STORAGE_CONFIGURATION_KEY, t)
    }, e.prototype.serialize = function() {
        var t = {useAntialiasing: this.useAntialiasing,useAreaProcessing: this.useAreaProcessing,useRealtimeMeasure: this.useRealtimeMeasure,useShadow: this.useShadow,useEnvMap: this.useEnvMap,useMultiTexturing: this.useMultiTexturing,maxTextureSize: this.maxTextureSize,useMultiLights: this.useMultiLights,useStats: this.useStats,hasMobileConfig: this.hasMobileConfig,hardwareScalingLevel: this.hardwareScalingLevel};
        return JSON.stringify(t)
    }, e.prototype.setQuality = function(t) {
        t === wnp.Constants.GRAPHICS_FAST ? (this.useAntialiasing = !1, this.useShadow = !1, this.useEnvMap = !1, this.useMultiTexturing = !1, this.useMultiLights = !1, this.hardwareScalingLevel = 1.5) : t === wnp.Constants.GRAPHICS_GOOD ? (this.useAntialiasing = !0, this.useShadow = !1, this.useEnvMap = !1, this.useMultiTexturing = !0, this.useMultiLights = !0, this.hardwareScalingLevel = 1) : (this.useAntialiasing = !0, this.useShadow = !0, this.useEnvMap = !0, this.useMultiTexturing = !0, this.useMultiLights = !0, this.hardwareScalingLevel = 1), this.saveConfiguration()
    }, e
}();
var wnp = window.wnp || {};
wnp.ComponentCollection = function() {
    var t = function(t) {
        Array.call(this), this._core = t, this._componentsToRemove = [], this._initialized = !1, this._size = 0
    };
    return t.prototype = Object.create(Array.prototype), t.prototype.addComponent = function(t) {
        var e = new t(this._core);
        return this.addInstancedComponent(e)
    }, t.prototype.addInstancedComponent = function(t) {
        return t.dirty || this.getComponentByName(t.name) ? null : (t.core || (t.core = this._core, t.structure = this._core.structure), this._initialized && t.initialize(), this.push(t), this.sort(function(t, e) {
            return e.priority - t.priority
        }), this._size++, t)
    }, t.prototype.clear = function() {
        for (var t = 0; t < this._size; t++)
            this[t].destroy();
        this._size = 0, this.length = 0
    }, t.prototype.getComponent = function(t) {
        return "string" == typeof t ? this.getComponentByName(t) : this[t]
    }, t.prototype.removeComponent = function(t, e) {
        var e = "undefined" != typeof e ? e : !1, n = -1;
        if ("number" == typeof t)
            n = t;
        else if ("string" == typeof t) {
            var i = this.getComponentByName(t);
            i && (n = this.indexOf(i))
        } else
            n = this.indexOf(t);
        return 0 > n || n >= this._size ? null : e ? (this[n].destroy(), this._size--, this.splice(n, 1)) : (this._componentsToRemove.push(this[n].name), null)
    }, t.prototype.initialize = function() {
        if (!this._initialized) {
            this._initialized = !0, this.checkDirtyComponents();
            for (var t = 0; t < this._size; t++)
                this[t].initialize()
        }
    }, t.prototype.update = function(t) {
        for (var e = 0; e < this._size; e++)
            this[e].update(t)
    }, t.prototype.draw = function(t) {
        for (var e = 0; e < this._size; e++)
            this[e].draw(t)
    }, t.prototype.checkDirtyComponents = function() {
        if (this._componentsToRemove.length) {
            for (var t = 0, e = this._componentsToRemove.length; e > t; t++)
                this.removeComponent(this._componentsToRemove[t], !0);
            this._componentsToRemove.length = 0
        }
    }, t.prototype.getComponentByName = function(t) {
        for (var e = 0; e < this._size; e++)
            if (this[e].name == t)
                return this[e];
        return null
    }, t.prototype.size = function() {
        return this._size
    }, t
}();
var wnp = window.wnp || {};
wnp.Core = function() {
    function t() {
        var t = n.mode == n.MODE_EDITOR ? r : 0;
        n.setSize(window.innerWidth - t, window.innerHeight)
    }
    function e(t, e) {
        return t.uuid || (t.uuid = wnp.uuid.uuid4()), t.lastModified || "wnpLocalStorage" == e ? t.lastModified || (t.lastModified = 0) : t.lastModified = (new Date).getTime(), t
    }
    var n = null, i = 640, o = 480, r = 260, s = 260, a = 1, l = null, h = null, c = {}, u = wnp.Constants.MODE_STANDALONE, p = null, d = null, m = null, g = null, f = !1, y = null, v = !1, b = null, w = "2D", x = null, C = function(e, _, v) {
        this.version = e, this.isFullyInitialized = !1, window.wanaplan = this, this.ENGINE_2D = 1, this.ENGINE_3D = 2, this.MODE_EDITOR = 1, this.MODE_VIEWER = 2, this.LOCAL_STORAGE_STRUCTURE_KEY = "wanadev.planner.structure", this.i18n = _, wnp.UI.LanguageSelector.setLocal(_.getLocale().split("_")[0]), l = document.getElementById("container2d"), h = document.getElementById("container3d"), a = this.ENGINE_2D, c = {structure: [],limit: 50,cursor: 0,getLatest: function() {
                return this.structure[this.cursor]
            }}, v.css && HTMLHelper.addStylesheet(v.css), this.allow3D = "undefined" != typeof v.allow3D ? v.allow3D : !0, this.api = v || {}, d = this.api.saveUrl || null, m = this.api.newUrl || null, g = this.api.planUrl || null, y = this.api.screenshotUrl || null, f = this.api.publisher || !1, _origin = this.api.origin || !1, this.mode = "true" === this.api.isViewer ? this.MODE_VIEWER : this.MODE_EDITOR, this.api.params = this.api.params ? JSON.parse(this.api.params) : {}, this.api.id > 0 && (p = this.api.id, u = wnp.Constants.MODE_CUSTOMER, b = this.api.params, w = this.api.screenshotMode || "2D", x = this.api.title || null, wnp.Constants.PRODUCTS_CATEGORY_FILE = [wnp.Constants.WNP_URL, "/data/", p, "/categories.json"].join(""), wnp.Constants.TEXTURES_FILE = [wnp.Constants.WNP_URL, "/data/", p, "/textures.json"].join(""), wnp.Constants.PRODUCTS_FILE = [wnp.Constants.WNP_URL, "/data/", p, "/products.json"].join(""), wnp.Constants.PRODUCTS_PREVIEWS = [wnp.Constants.WNP_URL, "/data/previews/"].join("")), i = window.innerWidth, o = window.innerHeight, this.needPageRefresh = !1, this.loopTimer = new wnp.LoopTimer, this.structure = new wnp.Structure(e), this.keyboardManager = new wnp.KeyboardManager, this.configuration = new wnp.Configuration, this.engine2D = new wnp.Engine2D(l, this), this.engine3D = null, this.engine3D = GlobalHelper.hasWebGL() ? new wnp.Engine3D(h) : new wnp.Dummy.Engine3D(h), this.aboutWindow = null;
        var C = this;
        n = this, window.addEventListener("resize", t, !1);
        var M = !1;
        if (document.addEventListener("keydown", function(t) {
            C.getSelectedEngine() === C.ENGINE_2D && ((t.ctrlKey || M) && 90 == t.keyCode ? n.backFromHistory() : (t.ctrlKey || n.pomme) && 89 == t.keyCode && n.nextFromHistory(), M = 91 == t.keyCode ? !0 : M)
        }, !1), document.addEventListener("keyup", function() {
            M = !1
        }, !1), document.addEventListener("contextmenu", function(t) {
            t.preventDefault()
        }, !1), window.addEventListener("message", function(t) {
            var e = JSON.parse(t.data);
            switch (e.action) {
                case "close-frame":
                    wnp.UI.IFrame.close();
                    break;
                case "resize-frame":
                    wnp.UI.IFrame.resize(e.width, e.height);
                    break;
                case "take-screenshot":
                    this.takeScreenshot({})
            }
        }.bind(this)), GlobalHelper.isIE() < 11) {
            var D = document.getElementById("screenshot-flash");
            D && (D.style.display = "none")
        }
        this.setMenuWidth = function(t) {
            r = "number" == typeof t ? t : s
        }, this.getMenuWidth = function() {
            return r
        }
    };
    return C.prototype.initialize = function(t) {
        this.mode == this.MODE_VIEWER ? this.initializeViewer(t) : this.initializeEditor(t), setTimeout(function() {
            this.engine2D.bestZoom()
        }.bind(this), 50), this.engine2D.bestZoom(), window.setTimeout(function() {
            this.hideSplashScreen()
        }.bind(this), 7e3), this.keyboardManager.startEventsListening(), GlobalHelper.hasWebGL() || HTMLHelper.hide3DMenus(), ujs.notify("wnp.core.initialized")
    }, C.prototype.initializeViewer = function(t) {
        var t = t || function() {
        }, e = this, n = document.getElementById("toggleEngine");
        this.changeToggleEngineLabel = function(t) {
            n.children[0].innerHTML = t
        }, GlobalHelper.hasWebGL() ? (n.setAttribute("title", _("Switch the view to 2D or 3D")), n.addEventListener("click", function() {
            e.switchEngine(), e.changeToggleEngineLabel("2D" == n.children[0].innerHTML ? "3D" : "2D")
        }, !1)) : n.style.display = "none", this.changeToggleEngineLabel(+this.api.startOn2D ? "3D" : "2D"), this._createDefaultStructure(), this.menu = {addMenuItem: function() {
            }}, this.helpBubbleManager = {alreadyDisplayed: function() {
            },display: function() {
            }}, this.engine2D.isViewer = !0, this.engine3D.isViewer = !0, this.engine2D.initialize(), this.engine3D.initialize(), g ? this._getStructureFromUrl(g, function(e) {
            this._loadStructure(e), this.engine2D.bestZoom(), this.hideSplashScreen(), t.call(this)
        }.bind(this)) : this._localStructureExists() ? this._loadStructure(this._getLocaleStorageStructure(), t) : t(this)
    }, C.prototype.initializeEditor = function() {
        var t = this;
        this.helpBubbleManager = new wnp.UI.HelpBubbleManager(!GlobalHelper.isMobileDevice()), document.addEventListener("wnp.request.takeScreenshot", this.takeScreenshot, !1), document.addEventListener("wnp.request.saveStructrure", this.saveStructure.bind(this), !1), document.addEventListener("wnp.request.loadStructure", this.loadStructure.bind(this), !1), this.engine2D.getContainer().addEventListener("touchend", this.saveHistory.bind(this), !1), this.engine2D.getContainer().addEventListener("touchcancel", this.saveHistory.bind(this), !1), this.engine3D.getContainer().addEventListener("touchend", this.saveHistory.bind(this), !1), this.engine3D.getContainer().addEventListener("touchcancel", this.saveHistory.bind(this), !1);
        var e = window.PointerEvent ? "pointerup" : "mouseup";
        if (e = window.MSPointerEvent ? "MSPointerUp" : e, this.engine2D.getContainer().addEventListener(e, this.saveHistory.bind(this), !1), this.engine3D.getContainer().addEventListener(e, this.saveHistory.bind(this), !1), document.addEventListener("wnp.request.saveHistory", this.saveHistory.bind(this), !1), document.addEventListener("wnp.request.switchEngine", this.switchEngine.bind(this), !1), document.addEventListener("wnp.request.changeEngine", function(e) {
            ujs.notify("wnp.request.closePopup"), "undefined" != typeof e.engine && setTimeout(function() {
                t.setSelectedEngine(e.engine)
            }, 10)
        }, !1), document.addEventListener("wnp.request.changeLang", function() {
            ujs.notify("wnp.menu.top.deselect"), wnp.UI.LanguageSelector.show()
        }, !1), this._createDefaultStructure(), this.engine2D.initialize(), this.engine3D.initialize(), v = !0, ":new" == g) {
            var n = !1;
            if (this._localStructureExists()) {
                var i = this._getLocaleStorageStructure(), o = wnpLocalStorage.getItem("wanadev.planner.stack");
                o != i.uuid && confirm(_("An unsaved plan exists, would you like to load it ?")) && (this._loadStructure(i), n = !0)
            }
            n === !1 && (this._clearLocaleStructure(), this._createDefaultStructure(), ujs.notify("wnp.core.structure.loaded")), this.engine2D.bestZoom(), this.hideSplashScreen()
        } else
            g ? this._getStructureFromUrl(g, function(t) {
                if (!t)
                    return this._localStructureExists() && this._loadStructure(this._getLocaleStorageStructure()), this.engine2D.bestZoom(), void this.hideSplashScreen();
                var e = this._getLocaleStorageStructure();
                this._loadStructure(e ? e.uuid == t.uuid ? e.lastModified >= t.lastModified ? e : t : t : t), this.structure.setCurrentStructureIndex(0), this.engine2D.bestZoom(), this.hideSplashScreen()
            }.bind(this)) : (this._localStructureExists() && this._loadStructure(this._getLocaleStorageStructure()), this.structure.setCurrentStructureIndex(0), this.engine2D.bestZoom(), this.hideSplashScreen());
        window.addEventListener("focus", function() {
            this.saveLocalStructure(!1, !0)
        }.bind(this), !1), this.aboutWindow = new wnp.UI.AboutWindow, this.setSize(window.innerWidth - 260, window.innerHeight)
    }, C.prototype.update = function() {
        this.loopTimer.update(), this.keyboardManager.isPressed(82) && (this.keyboardManager.isPressed(17) || this.keyboardManager.isPressed(91) || this.keyboardManager.isPressed(224)) && (this.needPageRefresh || (this.needPageRefresh = !0, location.href = location.href, this.needPageRefresh = !1)), this.engine2D.isEnabled() && this.keyboardManager.isPressed(Keys.escape) && (this.engine2D.setMode(this.engine2D.MODE_NORMAL), ujs.notify("wnp.menu.main.deselect"), this.engine2D.requestStaticDraw(), this.keyboardManager.keys[Keys.escape] = !1), this.engine2D.isEnabled() ? this.engine2D.update(this.loopTimer.getDeltaTime()) : this.engine3D.update(this.loopTimer.getDeltaTime())
    }, C.prototype.draw = function() {
        this.engine2D.isEnabled() ? this.engine2D.draw(this.loopTimer.getDeltaTime()) : this.engine3D.draw(this.loopTimer.getDeltaTime())
    }, C.prototype.compareVersion = function(t, e) {
        for (var n = t.split("."), i = e.split("."), o = 0, r = n.length, s = null; null === s && r > o; )
            void 0 !== n[o] && void 0 !== i[o] && (+n[o] < +i[o] ? s = -1 : +n[o] > +i[o] && (s = 1)), o++;
        return null !== s ? s : 0
    }, C.prototype.setSize = function(t, e) {
        i = t, o = e || t, n.engine2D.resize(), n.engine3D.resize()
    }, C.prototype.getWidth = function() {
        return i
    }, C.prototype.getHeight = function() {
        return o
    }, C.prototype.getContainer2D = function() {
        return l
    }, C.prototype.getContainer3D = function() {
        return h
    }, C.prototype.getSelectedEngine = function() {
        return a
    }, C.prototype.getPlanName = function() {
        return this.structure.uuid
    }, C.prototype.getPlanURL = function() {
        return g
    }, C.prototype.setSelectedEngine = function(t) {
        if (!this.allow3D && "2D" !== t && t !== this.ENGINE_2D) {
            var e = document.getElementById("toggleEngine");
            return void (e && e.parentNode.removeChild(e))
        }
        var n = t == this.ENGINE_3D || "3D" == t, i = this.engine2D.isEnabled() ? "2D" : "3D", o = n ? "3D" : "2D";
        this.engine2D.setEnabled(!n), this.engine3D.setEnabled(n), a = "3D" == t || t == this.ENGINE_3D ? this.ENGINE_3D : this.ENGINE_2D, ujs.notify("wnp.contextChanged", {context: o,previousContext: i}), this.helpBubbleManager && this.helpBubbleManager.helpBubble && this.helpBubbleManager.helpBubble.hide()
    }, C.prototype.getSelectedStructure = function() {
        return this.structure.getCurrentStructure()
    }, C.prototype.getHistory = function() {
        return c
    }, C.prototype.takeScreenshot = function(t, e, i) {
        var o, r = "undefined" != typeof t.selectedEngine ? t.selectedEngine : a, s = "undefined" != typeof t.sendBlob ? t.sendBlob : !1, e = e || function() {
        }, i = i || function() {
        };
        if (o = r == n.ENGINE_2D ? l.children[0] : h.children[0], u == wnp.Constants.MODE_STANDALONE || null === y) {
            if (e(), s)
                return o.toDataURL("image/png");
            r === n.ENGINE_2D ? o.toBlob(function(t) {
                saveAs(t, "plan.png")
            }) : GlobalHelper.createScreenshot3D(n.engine3D.engine, void 0, function(t) {
                t.toBlob(function(t) {
                    saveAs(t, "plan.png")
                })
            })
        } else {
            var c = [];
            if (b) {
                var p = b;
                "object" == typeof p && (p = JSON.stringify(p)), c.push("params=" + p + "&")
            }
            var d = function(t) {
                ujs.ajax({method: "POST",withCredentials: !0,url: y,params: t.join(""),error: i,success: function(t) {
                        var o = JSON.parse(t), r = _("An error occured. Please try later.");
                        if ("ok" === o.status)
                            r = _("Your screenshot has been saved."), n.structure.planId = !0, wnp.UI.MessageBox.show({title: _("Screenshot"),message: r,buttonAText: _("Close"),buttonA: !0,autoHide: !0,force: !0}), o.params && (b = o.params), wnp.UI.MessageBox.show(s), e();
                        else {
                            if (o.connectionUrl)
                                n._loginIframe(o.connectionUrl, o.frameWidth || Math.round(window.innerWidth / 2), o.frameHeight || Math.round(window.innerHeight / 2));
                            else {
                                var s = {title: _("Screenshot"),message: o.message || _("Error occured during save."),buttonA: !0,buttonAText: _("Ok"),onClickA: function() {
                                        wnp.UI.MessageBox.close()
                                    }};
                                wnp.UI.MessageBox.show(s)
                            }
                            i()
                        }
                    }})
            };
            r === n.ENGINE_2D ? (c.push("screenshot=" + o.toDataURL("image/png")), d(c)) : GlobalHelper.createScreenshot3D(n.engine3D.engine, void 0, function(t) {
                c.push("screenshot=" + t.toDataURL("image/png")), d(c)
            })
        }
        if (!GlobalHelper.isIE10()) {
            var m = document.getElementById("screenshot-flash");
            m.style.opacity = 1;
            var g = setTimeout(function() {
                clearTimeout(g), m.style.opacity = 0
            }, 200)
        }
    }, C.prototype.switchEngine = function() {
        this.setSelectedEngine(a == this.ENGINE_2D ? this.ENGINE_3D : this.ENGINE_2D)
    }, C.prototype.getComponentByName = function(t, e) {
        var e = void 0 != typeof e ? e : 3;
        if (e == this.ENGINE_2D)
            return this.engine2D.searchComponent(t);
        if (e == this.ENGINE_3D)
            return this.engine3D.searchComponent(t);
        var n = this.engine2D.searchComponent(t);
        return n || (n = this.engine3D.searchComponent(t)), n
    }, C.prototype.addStrutureElement = function(t) {
        this.structure.addElement(t)
    }, C.prototype.updateDeserialisation = function(t) {
        this.engine2D.requestStaticDraw(), this.unlock(t), this.getComponentByName("RoomComponent2D", this.ENGINE_2D).needsUpdate = !0, this.engine2D.requestStaticDraw(), this.engine2D.requestCompute(), this.engine2D.update(), this.engine2D.draw()
    }, C.prototype.checkLocalPlan = function() {
        var t = wnpLocalStorage.getItem(this.LOCAL_STORAGE_STRUCTURE_KEY);
        null != t && this.loadLocalStructure(!1)
    }, C.prototype.saveLocalStructure = function(t, e) {
        if (this.mode == this.MODE_VIEWER)
            return null;
        var t = "undefined" != typeof t ? t : !1, i = n.structure.serialize(), o = wnpLocalStorage.getItem(n.LOCAL_STORAGE_STRUCTURE_KEY);
        return o !== i || e ? (n.removeLocalStructure(!1), wnpLocalStorage.setItem(n.LOCAL_STORAGE_STRUCTURE_KEY, i), t && wnp.UI.MessageBox.show({title: _("Save a Plan"),message: _("Your plan has been saved."),buttonAText: _("Close"),button: !0}), i) : null
    }, C.prototype.loadLocalStructure = function(t) {
        var t = "undefined" != typeof t ? t : !1, e = wnpLocalStorage.getItem(this.LOCAL_STORAGE_STRUCTURE_KEY), n = this;
        if (null != e) {
            var i = n.lock();
            return n.structure.deserialize(e) ? (n.structure.setCurrentStructureIndex(0), n.updateDeserialisation(i)) : (this.removeLocalStructure(!1), t && wnp.UI.MessageBox.show({title: _("Load a Plan"),message: _("Unable to load your plan: its version is too old."),buttonAText: _("Close"),buttonA: !0})), t && wnp.UI.MessageBox.show({title: _("Load a Plan"),message: _("Your plan has been loaded."),buttonAText: _("Close"),buttonA: !0}), ujs.notify("wnp.structure.locale.loaded"), !0
        }
        return t && wnp.UI.MessageBox.show({title: _("Load a Plan"),message: _("You have no saved plan."),buttonAText: _("Close"),buttonA: !0}), !1
    }, C.prototype.removeLocalStructure = function(t) {
        var t = "undefined" != typeof t ? t : !1, e = wnpLocalStorage.getItem(this.LOCAL_STORAGE_STRUCTURE_KEY);
        return null != e ? (wnpLocalStorage.removeItem(this.LOCAL_STORAGE_STRUCTURE_KEY), t && wnp.UI.MessageBox.show({title: _("Remove a Plan"),message: _("Your plan has been removed."),buttonAText: _("Close"),button: !0}), !0) : !1
    }, C.prototype.getPreviewImage = function(t, e) {
        var i = null, o = null, r = n.engine2D.getZoom(), s = n.engine2D.getTranslation();
        n.setSize(t, e), this.getSelectedEngine() == this.ENGINE_2D ? (n.engine2D.bestZoom(), n.engine2D.draw(), o = n.engine2D.canvas) : (o = n.getContainer3D().getElementsByTagName("canvas")[0], n.engine3D.draw()), i = o.toDataURL("image/png");
        var a = n.mode == n.MODE_EDITOR ? 260 : 0;
        return n.setSize(window.innerWidth - a, window.innerHeight), this.getSelectedEngine() == this.ENGINE_2D && (n.engine2D.setZoom(r), n.engine2D.setTranslation(s)), i
    }, C.prototype.saveStackToLocal = function() {
        wnpLocalStorage.setItem("wanadev.planner.stack", n.structure.uuid)
    }, C.prototype.saveStructure = function() {
    }, C.prototype.loadStructure = function(t, e) {
        var e = e || function() {
        }, i = function(t) {
            n.removeLocalStructure();
            var i = n.lock();
            n.structure.deserialize(t) && n.updateDeserialisation(i), n.saveLocalStructure(!1), e(1)
        }, o = function(t) {
            ujs.ajax({url: wnp.Constants.BACK_URL + wnp.Constants.MIGRATION_PATH + t,withCredentials: !0,success: function(t) {
                    t ? i(t) : e(-1)
                }})
        };
        g ? (ujs.ajax({url: g,withCredentials: !0,success: function(t) {
                if (t) {
                    var n = JSON.parse(t);
                    1 == wanaplan.compareVersion(wnp.Constants.VERSION, n.version) ? i(t) : (console.log("migration"), o(g))
                } else
                    e(-1)
            }}), g = null) : e(-2)
    }, C.prototype.saveHistory = function() {
        {
            var t = this.saveLocalStructure(!1), e = this.getHistory().structure.length;
            this.getHistory().getLatest()
        }
        null != t && (this.getHistory().cursor < e - 1 && this.getHistory().structure.splice(this.getHistory().cursor + 1, e - this.getHistory().cursor), e > this.getHistory().maxSize && this.getHistory().structure.splice(0, 1), this.getHistory().cursor = this.getHistory().structure.push(t) - 1)
    }, C.prototype.backFromHistory = function() {
        this.getHistory().cursor <= 0 ? this.getHistory().cursor = 0 : this.getHistory().cursor--;
        var t = this.getHistory().structure[this.getHistory().cursor];
        if (null != t) {
            var e = this.lock();
            this.structure.deserialize(t) && this.updateDeserialisation(e)
        }
        this.engine2D.requestCompute(), this.engine2D.requestStaticDraw(), this.engine2D.update()
    }, C.prototype.lock = function() {
        var t = {engine2D: n.engine2D.isEnabled(),engine3D: n.engine3D.enabled};
        return this.engine2D._enabled = !1, this.engine3D.enabled = !1, t
    }, C.prototype.unlock = function(t) {
        this.engine2D._enabled = t.engine2D, this.engine3D.enabled = t.engine3D
    }, C.prototype.nextFromHistory = function() {
        this.getHistory().cursor < this.getHistory().structure.length && this.getHistory().cursor++;
        var t = this.getHistory().structure[this.getHistory().cursor];
        null != t && this.structure.deserialize(t), this.engine2D.requestCompute()
    }, C.prototype.hideSplashScreen = function(t) {
        var t = t || 800;
        document.getElementById("splash-bar-inner").style.webkitAnimationDuration = "1s", document.getElementById("splash-bar-inner").style.animationDuration = "1s";
        window.setTimeout(function() {
            document.getElementById("splashscreen").style.display = "none", n.isFullyInitialized = !0
        }, t)
    }, C.prototype._localStructureExists = function() {
        return void 0 != wnpLocalStorage.getItem(this.LOCAL_STORAGE_STRUCTURE_KEY) ? !0 : !1
    }, C.prototype._getLocaleStorageStructure = function() {
        return this._localStructureExists() ? e(JSON.parse(wnpLocalStorage.getItem(this.LOCAL_STORAGE_STRUCTURE_KEY)), "wnpLocalStorage") : null
    }, C.prototype.isPublisher = function() {
        return f
    }, C.prototype.getOrigin = function() {
        return _origin
    }, C.prototype._getStructureFromUrl = function(t, n) {
        var i = function(i) {
            if (i) {
                var r = JSON.parse(i);
                1 == wanaplan.compareVersion(wnp.Constants.VERSION, r.version) ? o(t, n) : n(e(r))
            } else
                n(null)
        }, o = function(t, e) {
            var n = wnp.Constants.BACK_URL + wnp.Constants.MIGRATION_PATH + t;
            ujs.ajax({url: n,success: i,onerror: function() {
                    r(n, e)
                }})
        }, r = function(t) {
            var e = "/php/retrieveJson.php?json=" + t;
            ujs.ajax({url: e,withCredentials: !0,success: i})
        };
        ujs.ajax({url: t,withCredentials: !0,success: i,onerror: function() {
                r(t, n)
            }})
    }, C.prototype.coherenceControl = function(t) {
        for (var e in t.members)
            this.engine2D.coherenceControl(t.members[e])
    }, C.prototype._loadStructure = function(t, e) {
        this.structure.deserialize("string" == typeof t ? t : JSON.stringify(t)), ujs.notify("wnp.core.structure.loaded");
        var e = e || function() {
        };
        e.call(this), this.engine2D.requestCompute()
    }, C.prototype._clearLocaleStructure = function() {
        var t = wnpLocalStorage.getItem(this.LOCAL_STORAGE_STRUCTURE_KEY);
        null != t && wnpLocalStorage.removeItem(this.LOCAL_STORAGE_STRUCTURE_KEY), this.structure.clear()
    }, C.prototype._createDefaultStructure = function() {
        this.addStrutureElement(new FloorStructure);
        for (var t = this.structure.getCurrentStructure(), e = [new PolygonWall, new PolygonWall, new PolygonWall, new PolygonWall], n = [new BABYLON.Vector2(-515, 0), new BABYLON.Vector2(0, 415), new BABYLON.Vector2(515, 0), new BABYLON.Vector2(0, -415)], i = 0; i < e.length; i++) {
            var o = (i + 1) % e.length;
            e[i].setPoints(e[o].getPoints(0), 1)
        }
        for (var i = 0; i < e.length; i++)
            e[i].translate(n[i]), t.insertElement("walls", e[i]), t.insertElement("points", e[i].getPoints(1))
    }, C.prototype._loginIframe = function(t, e, n) {
        var e = e || window.innerWidth / 2, n = n || window.innerHeight / 2;
        wnp.UI.IFrame.show(document.body, {width: e,height: n,src: t}, {showClose: !0})
    }, C
}();
var wnp = window.wnp || {};
wnp.Engine2D = function() {
    var t = function(t, e, n) {
        this.MODE_NORMAL = 1, this.MODE_DRAG = 2, this.MODE_DRAW = 4, this.MODE_CONTEXTMENU = 8, this.MODE_SUBSLOPE = 16, this._container = t, this.isViewer = "undefined" != typeof n ? n : !1, this.getContainer = function() {
            return this._container
        }, this.canvas = document.createElement("canvas"), this.canvas.id = "canvas2d", this._container.appendChild(this.canvas), this.dynamicCanvas = document.createElement("canvas"), this.dynamicCanvas.id = "dynamiccanvas2d", this._container.appendChild(this.dynamicCanvas), this.symbols2D = new wnp.Symbols2D, this._core = e, this._components = new wnp.ComponentCollection(wanaplan), this._initialized = !1, this._enabled = !1, this._zoom = 1, this._translation = new BABYLON.Vector2, this._cursorIconCb = null, this._pointerManager = null, this._mode = this.MODE_NORMAL, this._lastMode = this.MODE_NORMAL, this._enableAutoScroll = !1, this._eventsCb = {click: [],"double-click": [],hover: [],leave: [],"mouse-move": [],"drag-start": [],dragging: [],"drag-end": [],"zoom-in": [],"zoom-out": [],"key-pressed": [],"key-released": [],"static-draw": [],"dynamic-draw": [],"draw-end": [],"subslope-end": [],"enter-draw-zone": [],"leave-draw-zone": []}, this._lastTargeted = null, this._isHover = !1, this._needStaticDraw = !0, this._needDynamicDraw = !0, this._menuIsVisible = !0, this._contextMenuCallback = null, this._contextMenuRmCallback = null, this._contextMenuTarget = null, document.addEventListener("wnp.engine2D.contextMenu.propertyChanged", this.onContextMenuPropertyChanged.bind(this), !1), document.addEventListener("wnp.engine2D.contextMenu.close", this.onContextMenuClose.bind(this), !1), document.addEventListener("wnp.ui.frame.close", this.onContextMenuClose.bind(this), !1), document.addEventListener("wnp.engine2D.contextMenu.remove", this.onContextMenuRemove.bind(this), !1), document.addEventListener("wnp.engine2D.contextMenu.debug", this.onContextMenuDebug.bind(this), !1)
    };
    return t.prototype.isEnabled = function() {
        return this._enabled
    }, t.prototype.setEnabled = function(t) {
        this._enabled = t;
        var e = "none";
        t && (e = "block"), this.setMode(this.MODE_NORMAL), this._container.setAttribute("style", "display:" + e), this.requestStaticDraw(), ujs.notify("wnp.core.hideLoader")
    }, t.prototype.getZoom = function() {
        return this._zoom
    }, t.prototype.setZoom = function(t) {
        this._zoom = t, this._zoom = this._zoom < .1 ? .1 : this._zoom, this._zoom = this._zoom > 5 ? 5 : this._zoom, this.requestStaticDraw(), ujs.notify("wnp.request.zoomUpdated")
    }, t.prototype.getTranslation = function() {
        return this._translation.clone()
    }, t.prototype.setTranslation = function(t) {
        if (t instanceof BABYLON.Vector2) {
            var e = this._core.configuration.boundingSize, n = 100, i = this._core.getWidth() / 2 + (this.getZoom() * Math.abs(e.min.x) - this._core.getWidth() / 2) + n, o = this._core.getHeight() / 2 + (this.getZoom() * Math.abs(e.min.y) - this._core.getHeight() / 2) + n, r = this._core.getWidth() / 2 - (this.getZoom() * Math.abs(e.max.x) - this._core.getWidth() / 2) - n, s = this._core.getHeight() / 2 - (this.getZoom() * Math.abs(e.max.y) - this._core.getHeight() / 2) - n;
            t.x >= i && t.x <= r ? t.x = (i + r) / 2 : t.x > i ? t.x = i : t.x < r && (t.x = r), t.y >= o && t.y <= s ? t.y = (o + s) / 2 : t.y > o ? t.y = o : t.y < s && (t.y = s), this._translation.copyFrom(t), this._translation.x = Math.round(this._translation.x), this._translation.y = Math.round(this._translation.y), this.requestStaticDraw()
        }
    }, t.prototype.toRealCoord = function(t, e, n) {
        var i = t.scale(n || this.getZoom());
        return i.addInPlace(e || this.getTranslation()), i
    }, t.prototype.getMode = function() {
        return this._mode == this.MODE_DRAG || this._mode == this.MODE_CONTEXTMENU ? this._mode | this._lastMode : this._mode
    }, t.prototype.setMode = function(t) {
        if (t != this._mode) {
            var e = {mode: this._mode,lastMode: this._lastMode,newMode: t};
            this._lastMode = this._mode, this._mode = t, this._stateMachine(e)
        }
    }, t.prototype.setEnableAutoScroll = function(t) {
        this._enableAutoScroll = t
    }, t.prototype.getTarget = function(t) {
        if (!this.isViewer) {
            for (var t = t || this._pointerManager.getStatus(), e = 0; e < this._components.size(); e++) {
                var n = this._components[e].getTargeted(t.planPos);
                if (null != n)
                    return n
            }
            return null
        }
    }, t.prototype.getMouseState = function() {
        return this._pointerManager.getStatus()
    }, t.prototype.setCursorIcon = function(t) {
        this._cursorIconCb = t, this.requestDynamicDraw()
    }, t.prototype.initialize = function() {
        this._pointerManager = new wnp.PointerManager(this._core, this.onMouseEvent.bind(this), this.dynamicCanvas), this.dynamicCanvas.addEventListener("mouseout", function(t) {
            this._callInOutDrawZoneCb("leave-draw-zone", t)
        }.bind(this), !1), this.dynamicCanvas.addEventListener("mousein", function(t) {
            this._callInOutDrawZoneCb("enter-draw-zone", t)
        }.bind(this), !1), this.setTranslation(new BABYLON.Vector2((this._core.getWidth() - 260) / 2, this._core.getHeight() / 2)), this.resize(), this.initializeComponents(), this._initialized = !0, document.addEventListener("wnp.engine2D.requestCompute", function() {
            this.requestCompute()
        }.bind(this), !1), window.setTimeout(function() {
            this._core.helpBubbleManager.display("wnp.2d.wall-basics")
        }.bind(this), 2e3)
    }, t.prototype.bestZoom = function(t, e) {
        var n = this.getBestZoomAttributes(t, e);
        this.setZoom(n.zoom), this.setTranslation(n.translation), this.requestCompute()
    }, t.prototype.getBestZoomAttributes = function(t, e) {
        var n = t || this._core.getWidth(), i = e || this._core.getHeight(), o = this._core.getSelectedStructure().walls, r = {min: {x: 1 / 0,y: 1 / 0},max: {x: -1 / 0,y: -1 / 0}};
        for (var s in o) {
            var a = o[s].getBoundingBox();
            a.min.x < r.min.x && (r.min.x = a.min.x), a.min.y < r.min.y && (r.min.y = a.min.y), a.max.x > r.max.x && (r.max.x = a.max.x), a.max.y > r.max.y && (r.max.y = a.max.y)
        }
        var l = r.max.x - r.min.x + 100, h = r.max.y - r.min.y + 100, c = 1;
        (l > n || h > i) && (c = Math.min(i / h, n / l));
        var u = new BABYLON.Vector2(n / 2, i / 2);
        return u.x -= (r.max.x + r.min.x) / 2 * c, u.y -= (r.max.y + r.min.y) / 2 * c, {zoom: c,translation: u}
    }, t.prototype.reinitialize = function() {
        this.setMode(this.MODE_NORMAL), this.setTranslation(new BABYLON.Vector2((this._core.getWidth() - this._core.getMenuWidth()) / 2, this._core.getHeight() / 2)), this.resize(), this.requestCompute(), this.bestZoom()
    }, t.prototype.initializeComponents = function() {
        this._components.initialize()
    }, t.prototype.resize = function(t, e) {
        this.canvas.width = t || this._core.getWidth(), this.canvas.height = e || this._core.getHeight(), this.dynamicCanvas.width = t || this._core.getWidth(), this.dynamicCanvas.height = e || this._core.getHeight(), this._pointerManager && this._pointerManager.resize(), this.requestStaticDraw()
    }, t.prototype.update = function(t) {
        this._components.checkDirtyComponents();
        var t = t === !0 ? !0 : !1;
        if (t)
            for (var e = 0; e < this._components.size(); e++)
                for (var n = 0; n < wanaplan.structure.members.length; n++) {
                    var i = wanaplan.structure.members[n];
                    this._components[e].update(i), i.tidy()
                }
        else
            this._components.update(), wanaplan.getSelectedStructure().tidy();
        this._autoScroll()
    }, t.prototype.draw = function() {
        this.update(), wnp.AnimationHandler.Process(), this._needStaticDraw && (this._needStaticDraw = !1, this._callStaticDrawCb()), this._needDynamicDraw && (this._needDynamicDraw = !1, this._callDynamicDrawCb())
    }, t.prototype.registerEventCb = function(t, e, n, i, o, r, s) {
        var s = s || null;
        this.unregisterEventCb(t), this._eventsCb[n].push({id: t,priority: e,mode: i,objType: o,callback: r,data: s}), this._eventsCb[n].sort("static-draw" != n && "dynamic-draw" != n ? function(t, e) {
            return e.priority - t.priority
        } : function(t, e) {
            return t.priority - e.priority
        })
    }, t.prototype.unregisterEventCb = function(t) {
        for (var e in this._eventsCb)
            if (this._eventsCb.hasOwnProperty(e))
                for (var n in this._eventsCb[e])
                    this._eventsCb[e][n].id == t && delete this._eventsCb[e][n]
    }, t.prototype.addComponent = function(t) {
        return this._components.addComponent(t)
    }, t.prototype.addInstancedComponent = function(t) {
        return this._components.addInstancedComponent(t)
    }, t.prototype.getComponent = function() {
        return this._components.getComponent(name)
    }, t.prototype.searchComponent = function(t) {
        return this._components.getComponent(t)
    }, t.prototype.removeComponent = function(t, e) {
        return this._components.removeComponent(t, e)
    }, t.prototype.removeComponentByName = function(t) {
        return this._components.removeComponent(t)
    }, t.prototype.clearComponents = function() {
        this._components.clear()
    }, t.prototype.requestStaticDraw = function() {
        this._needStaticDraw = !0, this.requestDynamicDraw()
    }, t.prototype.requestDynamicDraw = function() {
        this._needDynamicDraw = !0
    }, t.prototype.requestCompute = function() {
        for (var t = 0; t < this._components.size(); t++)
            this._components[t].compute();
        this.requestStaticDraw()
    }, t.prototype.setCursor = function(t) {
        var t = t || "default";
        this.dynamicCanvas.style.cursor = t
    }, t.prototype.displayContextMenu = function(t, e, n, i) {
        var o = this._pointerManager.getStatus(), r = [];
        this._contextMenuCallback = n, this._contextMenuRmCallback = i, this._contextMenuTarget = e;
        for (var s in t) {
            var a = t[s];
            a.eventParams = {cast: a.cast || a.type,property: a.name,eventName: "wnp.engine2D.contextMenu.propertyChanged"}, r.push(a)
        }
        var l = [{title: "Tab 1",content: r}], h = [];
        window.WNP_DEBUG && h.push({label: "Debug",action: "wnp.engine2D.contextMenu.debug"}), null != i && h.push({label: _("Remove"),action: "wnp.engine2D.contextMenu.remove","class": "remove"}), h.push({label: _("Ok"),action: "wnp.engine2D.contextMenu.close"}), this._callMouseEventCb("leave", e, {}, o), this.requestStaticDraw(), this.setMode(this.MODE_CONTEXTMENU);
        var c = (o.prevButtons & o.BUTTON_LEFT) > 0 ? 200 : 0, u = this._enabled ? o.pos.x + 2 : this._core.getWidth() / 2, p = this._enabled ? o.pos.y + 2 : 100;
        wnp.UI.ContextMenu.show({title: _("Settings"),x: u,y: p}, l, h, c)
    }, t.prototype._stateMachine = function(t) {
        var e = this._mode, n = this._lastMode, i = this._mode, o = null, r = null, s = {}, a = this._lastTargeted, l = this._lastTargeted;
        void 0 !== t.mode && (e = t.mode), void 0 !== t.lastMode && (n = t.lastMode), void 0 !== t.newMode && (i = t.newMode), o = void 0 !== t.mstate ? t.mstate : this._pointerManager.getStatus(), void 0 !== t.evName && (r = t.evName), void 0 !== t.ev && (s = t.ev), void 0 !== t.target && (a = t.target), void 0 !== t.lastTarget && (l = t.lastTarget);
        var h = !1;
        e != i && (h = !0);
        var c = !1;
        if (null != r && (c = !0), h)
            if ((e & this.MODE_DRAW) > 0 && 0 == (i & this.MODE_DRAG) ? this._callDrawEndCb() : (n & this.MODE_DRAW) > 0 && (e & this.MODE_DRAG) > 0 && 0 == (i & (this.MODE_DRAW | this.MODE_DRAG)) && this._callDrawEndCb(), (e & this.MODE_SUBSLOPE) > 0 && 0 == (i & this.MODE_DRAG) ? this._callSubslopeEndCb() : (n & this.MODE_SUBSLOPE) > 0 && (e & this.MODE_DRAG) > 0 && 0 == (i & (this.MODE_SUBSLOPE | this.MODE_DRAG | this.MODE_CONTEXTMENU)) && this._callSubslopeEndCb(), (e & this.MODE_CONTEXTMENU) > 0 && 0 == (i & this.MODE_CONTEXTMENU) ? (wnp.UI.ContextMenu.close(), this.requestCompute(), this._core.keyboardManager.preventDefault = !0) : (i & this.MODE_CONTEXTMENU) > 0 && (this._core.keyboardManager.preventDefault = !1), (e & this.MODE_DRAG) > 0 && 0 == (i & this.MODE_DRAG))
                (o.actions & o.ACTION_DRAGGING) > 0 && (this._pointerManager.reset(), this._callMouseEventCb("drag-end", a, s, o, this.MODE_DRAG)), this._eventsCb.dragging.length = 0, this._eventsCb["drag-end"].length = 0;
            else if ((e & this.MODE_DRAW) > 0 && 0 == (i & (this.MODE_DRAG | this.MODE_DRAW)))
                for (var u in this._eventsCb)
                    if (this._eventsCb.hasOwnProperty(u))
                        for (var p in this._eventsCb[u])
                            this._eventsCb[u][p].mode == this.MODE_DRAW && delete this._eventsCb[u][p];
        if (h)
            switch (i) {
                case this.MODE_DRAG:
                    this.setCursor(e == this.MODE_DRAW ? "crosshair" : "move");
                    break;
                case this.MODE_DRAW:
                    this.setCursor("crosshair");
                    break;
                default:
                    this.setCursor("default")
            }
        if (c && 0 == (e & this.MODE_CONTEXTMENU))
            switch (r) {
                case "drag-start":
                    this._callMouseEventCb("drag-start", a, s, o, e), i = this.MODE_DRAG, this.setMode(i);
                    break;
                case "drag-end":
                    this._callMouseEventCb("drag-end", a, s, o, e), this._mode == this.MODE_DRAG ? (i = n, this.setMode(i)) : i = this._mode, l = a, a = this.getTarget(o);
                    break;
                case "double-click":
                    this._callMouseEventCb("double-click", a, s, o, e), l = a, a = this.getTarget(o);
                    break;
                case "mouse-move":
                    (this.getMode() & this.MODE_DRAG) > 0 && (t.evName = "drag-end", this._stateMachine(t)), this._callMouseEventCb("mouse-move", a, s, o, e);
                    break;
                default:
                    this._callMouseEventCb(r, a, s, o, e)
            }
        (e & (this.MODE_NORMAL | this.MODE_CONTEXTMENU)) > 0 && this.setEnableAutoScroll(!1), c && (e & this.MODE_CONTEXTMENU) > 0 && ("click" == r || "double-click" == r ? (i = n, this.setMode(i)) : "drag-start" == r && (i = n, this.setMode(i), t.evName = "drag-start", t.target = this.getTarget(o), this._stateMachine(t))), a != l && 0 == (e & this.MODE_CONTEXTMENU) ? (null != l && this._callMouseEventCb("leave", l, s, o, e), null != a && this._callMouseEventCb("hover", a, s, o, i)) : e != i && 0 == (e & this.MODE_CONTEXTMENU) ? null != a && (this._callMouseEventCb("leave", a, s, o, e), this._callMouseEventCb("hover", a, s, o, i)) : e != i && 0 == (i & this.MODE_CONTEXTMENU) && null != a && (this._callMouseEventCb("leave", a, s, o, e), this._callMouseEventCb("hover", a, s, o, i)), e != i && 0 == (e & (this.MODE_DRAG | this.MODE_CONTEXTMENU)) && (i & this.MODE_SUBSLOPE) > 1 ? this._core.helpBubbleManager.display("wnp.2d.subslope") : e != i && 0 == (e & (this.MODE_DRAG | this.MODE_CONTEXTMENU)) && (i & this.MODE_DRAW) > 1 || e != i && 0 == (e & (this.MODE_DRAG | this.MODE_CONTEXTMENU)) && 0 == (i & (this.MODE_DRAG | this.MODE_CONTEXTMENU)) && this._core.helpBubbleManager.helpBubble.hide()
    }, t.prototype._callMouseEventCb = function(t, e, n, i, o) {
        if (void 0 != t) {
            var e = e;
            void 0 == e && (e = null);
            var n = n;
            void 0 == n && (n = {});
            var i = i;
            void 0 == i && (i = this._pointerManager.getStatus());
            var o = o;
            void 0 == o && (o = this.getMode());
            for (var r in this._eventsCb[t])
                if ((null == this._eventsCb[t][r].mode || (o & this._eventsCb[t][r].mode) > 0) && (null == this._eventsCb[t][r].objType || e instanceof this._eventsCb[t][r].objType)) {
                    var s = this._eventsCb[t][r].callback(n, e, i, this._eventsCb[t][r].data);
                    if (s === !1)
                        break
                }
        }
    }, t.prototype._callStaticDrawCb = function() {
        var t = this.canvas.getContext("2d");
        t.clearRect(0, 0, this._core.getWidth(), this._core.getHeight());
        for (var e in this._eventsCb["static-draw"])
            this._eventsCb["static-draw"][e] && (null == this._eventsCb["static-draw"][e].mode || (this._eventsCb["static-draw"][e].mode & this.getMode()) > 0) && (t.save(), this._eventsCb["static-draw"][e].callback(t, this.getTranslation(), this.getZoom(), this._eventsCb["static-draw"][e].data), t.restore())
    }, t.prototype._callInOutDrawZoneCb = function(t, e) {
        for (var n in this._eventsCb[t])
            this._eventsCb[t][n] && (null == this._eventsCb[t][n].mode || (this._eventsCb[t][n].mode & this.getMode()) > 0) && this._eventsCb[t][n].callback(e, this._eventsCb[t][n].data)
    }, t.prototype._callDynamicDrawCb = function() {
        var t = this.dynamicCanvas.getContext("2d");
        t.clearRect(0, 0, this._core.getWidth(), this._core.getHeight());
        for (var e in this._eventsCb["dynamic-draw"])
            this._eventsCb["dynamic-draw"][e] && (null == this._eventsCb["dynamic-draw"][e].mode || (this._eventsCb["dynamic-draw"][e].mode & this.getMode()) > 0) && (t.save(), this._eventsCb["dynamic-draw"][e].callback(t, this.getTranslation(), this.getZoom(), this._eventsCb["dynamic-draw"][e].data), t.restore());
        this._cursorIconCb && (this._cursorIconCb(t, this.getMouseState().pos), this._cursorIconCb = null)
    }, t.prototype._callDrawEndCb = function() {
        for (var t in this._eventsCb["draw-end"])
            this._eventsCb["draw-end"][t] && this._eventsCb["draw-end"][t].callback(this._eventsCb["draw-end"][t].data)
    }, t.prototype._callSubslopeEndCb = function() {
        for (var t in this._eventsCb["subslope-end"])
            this._eventsCb["subslope-end"][t] && this._eventsCb["subslope-end"][t].callback(this._eventsCb["subslope-end"][t].data)
    }, t.prototype._autoScroll = function() {
        if (this._enableAutoScroll || (this.getMode() & this.MODE_DRAG) > 1 && this.getTarget()) {
            var t = 3, e = 35, n = !1, i = this.getMouseState(), o = this.getTranslation();
            if (Math.abs(i.planPos.x) >= this._core.configuration.boundingSize.max.x || Math.abs(i.planPos.y) >= this._core.configuration.boundingSize.max.y)
                return;
            if (i.pos.y < e ? (o.y += t, i.posDelta.y = -t, n = !0) : i.pos.y > this._core.getHeight() - e && (o.y -= t, i.posDelta.y = t, n = !0), i.pos.x < e ? (o.x += t, i.posDelta.x = -t, n = !0) : i.pos.x > this._core.getWidth() - e && (o.x -= t, i.posDelta.x = t, n = !0), n) {
                this.setTranslation(o);
                var r = "mouse-move";
                (this.getMode() & this.MODE_DRAG) > 0 && (r = "dragging"), this._stateMachine({evName: r,ev: {},mstate: i})
            }
        }
    }, t.prototype.onMouseEvent = function(t, e) {
        if (this._enabled) {
            var n = this.getTarget(e), i = null;
            e.actions > 0 ? (e.actions & e.ACTION_CLICK) > 0 ? i = "click" : (e.actions & e.ACTION_DBLCLICK) > 0 ? i = "double-click" : (e.actions & e.ACTION_DRAGSTART) > 0 && this._mode != this.MODE_DRAG ? i = "drag-start" : (e.actions & e.ACTION_DRAGGING) > 0 ? i = "dragging" : (e.actions & e.ACTION_DRAGEND) > 0 ? i = "drag-end" : (e.actions & e.ACTION_SCROLLUP) > 0 ? i = "zoom-in" : (e.actions & e.ACTION_SCROLLDOWN) > 0 && (i = "zoom-out") : (0 != e.posDelta.x || 0 != e.posDelta.y) && (i = "mouse-move"), null != i && (Math.abs(e.planPos.x) > this._core.configuration.boundingSize.max.x || Math.abs(e.planPos.y) > this._core.configuration.boundingSize.max.y || (this._stateMachine({mstate: e,evName: i,ev: t,target: n}), this._lastTargeted = n))
        }
    }, t.prototype.onContextMenuPropertyChanged = function(t) {
        this._contextMenuCallback(this._contextMenuTarget, t.property, t.value)
    }, t.prototype.onContextMenuClose = function() {
        this._callMouseEventCb("leave", this._contextMenuTarget), (this.getMode() & this.MODE_CONTEXTMENU) > 0 && this.setMode(this._lastMode)
    }, t.prototype.onContextMenuRemove = function() {
        this._contextMenuRmCallback(this._contextMenuTarget), this.setMode(this._lastMode)
    }, t.prototype.onContextMenuDebug = function() {
        console.debug(this._contextMenuTarget)
    }, t
}();
var wnp = window.wnp || {};
wnp.Engine3D = function() {
    var t, e = function(e, n, i) {
        this._initialized = !1, this._components = new wnp.ComponentCollection(wanaplan), this.hardwareScaling = 1, this.contextLostCount = 0, this.MAX_CONTEXT_LOST = 5, this.MODE_NORMAL = 1, this.MODE_DRAG = 2, this.MODE_PAINT = 4, this.MODE_CONTEXTMENU = 8, this.mode = this.MODE_NORMAL, this.container = e, this.canvas = document.createElement("canvas"), e.appendChild(this.canvas), this.canvas.width = wanaplan.getWidth(), this.canvas.height = wanaplan.getHeight();
        var o = wanaplan.configuration && wanaplan.configuration.useAntialiasing === !1 ? !1 : !0;
        this.engine = new BABYLON.Engine(this.canvas, o), this.scene = new BABYLON.Scene(this.engine), this.scene.ambientColor = new BABYLON.Color3(1, 1, 1), this.scene.clearColor.copyFromFloats(.96, .96, .96), this.shadowGenerator = null, this.worldPlane = new BABYLON.Plane(0, 1, 0, 0), this.enabled = !1, this.viewInitialized = !1, this.isViewer = "undefined" != typeof i ? i : !1, this.canvas.addEventListener("webglcontextlost", this.onContextLost.bind(this), !1), this.canvas.addEventListener("webglcontextrestored", this.onContextRestored.bind(this), !1), this.canDraw = !0, t = this, n || (this.structure = wanaplan.structure, this.materialFactory = new wnp.MaterialFactory(wanaplan.configuration), this.cameraFeatures = new wnp.CameraFeatures, this.pointerManager = new wnp.PointerManager(wanaplan, this.onMouseEvent.bind(this), this.canvas), this.pointerManager.touchManager.setDeadZone(1), this.keyboardManager = wanaplan.keyboardManager, this.stats = new Stats, this.stats.domElement.style.position = "absolute", this.stats.domElement.style.bottom = "28px", this.stats.domElement.style.left = "0px", this.stats.domElement.style.zIndex = "99999", this.stats.domElement.style.display = "none", wanaplan.configuration.useStats && (this.stats.active = !0), document.body.appendChild(this.stats.domElement), document.addEventListener("wnp.engine3D.stats.activeChanged", function(e) {
            t.stats.active = e.value, t.stats.domElement.style.display = e.value ? "block" : "none", wanaplan.configuration.useStats = e.value ? !0 : !1, wanaplan.configuration.saveConfiguration()
        }, !1), document.addEventListener("wnp.engine3D.refreshGL", function() {
            var t = location.hash.replace("#", ""), e = atob(t), n = btoa(e.replace("&planUrl=:new", "&planUrl"));
            location.hash = n, window.location.reload(!0)
        }, !1), document.addEventListener("wnp.engine3D.showProducts", function(t) {
            var e = t.translations ? _(t.categoryName, t.translations) : _(t.categoryName);
            wnp.UI.ProductList.show(wanaplan, wanaplan.version, {id: t.categoryId,filter: t.categoryFilter,name: e})
        }, !1), this.isViewer || (document.addEventListener("wnp.engine3D.click", t.onClick, !1), document.addEventListener("wnp.engine3D.double-click", t.onDoubleClick, !1), document.addEventListener("pointerdown", t.onMouseDown, !1)), document.addEventListener("wnp.engine3d.wallsReady", this.onWallsReady, !1)), this.getContainer = function() {
            return this.container
        }
    };
    return e.prototype.collideWithMeshes = function(e, n, i) {
        var o = t.scene.createPickingRay(e, n), r = o.intersectMeshes(i, !0, !0);
        return r
    }, e.prototype.castShadows = function(t) {
        var e = this.shadowGenerator ? this.shadowGenerator.getShadowMap() : null;
        if (e) {
            e.renderList.push(t);
            var n = t.onDispose;
            t.onDispose = n ? function() {
                n(), wanaplan.engine3D.unCastShadows(t)
            } : function() {
                wanaplan.engine3D.unCastShadows(t)
            }
        }
    }, e.prototype.unCastShadows = function(t) {
        this.shadowGenerator.getShadowMap().renderList.splice(this.shadowGenerator.getShadowMap().renderList.indexOf(t), 1)
    }, e.prototype.reinitializeEngine = function() {
        if (!GlobalHelper.isMobileDevice() || "Firefox" !== BrowserDetect.browser)
            if (this.contextLostCount < this.MAX_CONTEXT_LOST)
                this.contextLostCount++;
            else {
                var t = wanaplan.engine2D.searchComponent("PedagoComponent"), e = GlobalHelper.isMobileDevice() ? "mobile" : "no-webgl";
                t ? t.redirectToPage(e) : window.location.href = ["js/Components/PedagoComponent/pedago/pages/", e, ".php"].join("")
            }
    }, e.prototype.setEnabled = function(t) {
        this.enabled = t;
        var e = this.enabled ? "block" : "none";
        this.container.setAttribute("style", "display:" + e), this.isViewer || (this.stats.domElement.style.display = this.stats.active && this.enabled ? "block" : "none")
    }, e.prototype.setInitialView = function() {
        if (!this.viewInitialized) {
            var t, e = this.scene.getMeshByName("WallMesh_0");
            t = e ? this.cameraFeatures.getBestFocusRadius(e, wanaplan.engine3D.camera, wanaplan.engine3D.scene) : 500, wanaplan.engine3D.camera.radius = t, wanaplan.engine3D.camera.alpha = -120 / 180 * Math.PI, wanaplan.engine3D.camera.beta = 60 / 180 * Math.PI, this.viewInitialized = !0
        }
    }, e.prototype.requestCompute = function() {
        for (var t = 0; t < this._components.size(); t++)
            this._components[t].compute()
    }, e.prototype.addComponent = function(t) {
        return this._components.addComponent(t)
    }, e.prototype.addInstancedComponent = function(t) {
        return this._components.addInstancedComponent(t)
    }, e.prototype.getComponent = function(t) {
        return this._components.getComponent(t)
    }, e.prototype.searchComponent = function(t) {
        return this._components.getComponent(t)
    }, e.prototype.removeComponent = function(t, e) {
        this._components.removeComponent(t, e)
    }, e.prototype.removeComponentByName = function(t) {
        return this._components.removeComponent(t, !0)
    }, e.prototype.clearComponents = function() {
        this._components.clear()
    }, e.prototype.collideWithScene = function(e, n) {
        var i = t.scene.createPickingRay(e, n), o = i.intersectMeshes(t.scene.meshes, !0, !0);
        return o
    }, e.prototype.projectMouseOnGround = function(e, n) {
        var i, o;
        if (void 0 === e) {
            var r = this.pointerManager.getStatus();
            i = r.pos.x, o = r.pos.y
        } else
            i = e, o = n;
        var s = t.scene.createPickingRay(i, o);
        return s.intersectPlane(this.worldPlane)
    }, e.prototype.projectMouseOnPlane = function(e, n, i) {
        var o = this.pointerManager.getStatus(), n = void 0 !== n ? n : o.pos.x, i = void 0 !== i ? i : o.pos.y, r = t.scene.createPickingRay(n, i);
        return r.intersectPlane(e)
    }, e.prototype.onClick = function(e) {
        e.collided = t.collideWithScene(e.mstate.pos.x, e.mstate.pos.y), ujs.notify("wnp.engine3D.click.collided", e)
    }, e.prototype.onDoubleClick = function(e) {
        e.collided = t.collideWithScene(e.mstate.pos.x, e.mstate.pos.y), ujs.notify("wnp.engine3D.dblclick.collided", e)
    }, e.prototype.onMouseEvent = function(t, e) {
        var n = !1;
        1 != this.hardwareScaling && (e.pos.scaleInPlace(this.hardwareScaling), e.posDelta.scaleInPlace(this.hardwareScaling), e.planPos.scaleInPlace(this.hardwareScaling), e.plan3DPos.scaleInPlace(this.hardwareScaling)), e.actions > 0 ? (e.actions & e.ACTION_CLICK) > 0 ? n = "click" : (e.actions & e.ACTION_DBLCLICK) > 0 ? n = "double-click" : (e.actions & e.ACTION_DRAGSTART) > 0 && this._mode != this.MODE_DRAG ? n = "drag-start" : (e.actions & e.ACTION_DRAGGING) > 0 ? n = "dragging" : (e.actions & e.ACTION_DRAGEND) > 0 ? n = "drag-end" : (e.actions & e.ACTION_SCROLLUP) > 0 ? n = "zoom-in" : (e.actions & e.ACTION_SCROLLDOWN) > 0 && (n = "zoom-out") : (0 != e.posDelta.x || 0 != e.posDelta.y) && (n = "mouse-move"), n && (t.mstate = e, ujs.notify("wnp.engine3D." + n, t))
    }, e.prototype.resize = function() {
        this.canvas.width = wanaplan.getWidth() * this.hardwareScaling, this.canvas.height = wanaplan.getHeight() * this.hardwareScaling, this.engine.setViewport(this.camera.viewport, wanaplan.getWidth(), wanaplan.getHeight())
    }, e.prototype.onContextLost = function(t) {
        t.preventDefault(), wanaplan.setSelectedEngine(wanaplan.ENGINE_2D)
    }, e.prototype.onContextRestored = function(t) {
        t.preventDefault(), this.reinitializeEngine()
    }, e.prototype.onWallsReady = function() {
        t.setInitialView()
    }, e.prototype.initialize = function() {
        wanaplan.configuration.useMultiTexturing || (BABYLON.StandardMaterial.SpecularTextureEnabled = !1, BABYLON.StandardMaterial.BumpTextureEnabled = !1, BABYLON.StandardMaterial.ReflectionTextureEnabled = !1), this._components.initialize(), this._initialized = !0
    }, e.prototype.update = function(t) {
        this._components.checkDirtyComponents(), this._components.checkDirtyComponents();
        for (var e = 0; e < this._components.size(); e++)
            this._components[e].enabled && this._components[e].update(t);
        this.stats.active && this.stats.update(), this.keyboardManager.isPressed("27") && (this.mode = this.MODE_NORMAL)
    }, e.prototype.draw = function() {
        this.canDraw && (this.engine.beginFrame(), this.scene.render(), this.engine.endFrame())
    }, e
}();
var __extends = this.__extends || function(t, e) {
    function n() {
        this.constructor = t
    }
    for (var i in e)
        e.hasOwnProperty(i) && (t[i] = e[i]);
    n.prototype = e.prototype, t.prototype = new n
}, wnp;
!function(t) {
    var e = function(t) {
        function e(e, n) {
            var i = this;
            t.call(this, e, n), this.category = -1, this.addColor = null, this.isDefault = !0, this._cachedDefines = null, this._renderTargets = new BABYLON.SmartArray(16), this._worldViewProjectionMatrix = BABYLON.Matrix.Zero(), this._lightMatrix = BABYLON.Matrix.Zero(), this._globalAmbientColor = new BABYLON.Color3(0, 0, 0), this._baseColor = new BABYLON.Color3, this._scaledDiffuse = new BABYLON.Color3, this._scaledSpecular = new BABYLON.Color3, this._scene = n, this._shaderName = "", this._uniforms = ["world", "viewProjection", "vEyePosition"], this._uniformsLocations = {}, this._samplers = [], this._attribs = [BABYLON.VertexBuffer.PositionKind], this._customDefines = null, this._hasColors = null, this._hasNormals = null, this._hasUvs = null, this._hasDiffuse = null, this._hasBump = null, this._hasEnv = null, this._hasLights = null, this.build(), this.getRenderTargetTextures = function() {
                return i._renderTargets.reset(), i.reflectionTexture && i.reflectionTexture.isRenderTarget && i._renderTargets.push(i.reflectionTexture), i._renderTargets
            }
        }
        __extends(e, t);
        var n = -1;
        return e.prototype.needAlphaBlending = function() {
            return this.alpha < 1
        }, e.prototype.needAlphaTesting = function() {
            return !1
        }, e.prototype.setCustomDefines = function(t) {
            this._customDefines = t
        }, e.prototype.build = function() {
        }, e.prototype.normal = function() {
            this._attribs.push(BABYLON.VertexBuffer.NormalKind), this._hasNormals = !0
        }, e.prototype.uv = function() {
            this._attribs.push(BABYLON.VertexBuffer.UVKind), this._hasUvs = !0
        }, e.prototype.diffuse = function() {
            this._uniforms.push("vDiffuseInfos", "diffuseMatrix"), this._samplers.push("diffuseSampler"), this._hasDiffuse = !0
        }, e.prototype.bump = function() {
            this._uniforms.push("vBumpInfos", "bumpMatrix"), this._samplers.push("bumpSampler"), this._hasBump = !0
        }, e.prototype.color = function() {
            this._uniforms.push("vDiffuseColor"), this._hasColor = !0
        }, e.prototype.setAlpha = function() {
            this._uniforms.push("vAlpha")
        }, e.prototype.env = function() {
            this._uniforms.push("vReflectionInfos", "reflectionMatrix"), this._samplers.push("reflectionCubeSampler"), this._hasEnv = !0
        }, e.prototype.light = function() {
            this._uniforms.push("vLightsType", "vLightData0", "vLightDiffuse0", "vLightSpecular0", "vLightDirection0", "vLightGround0", "lightMatrix0", "vLightData1", "vLightDiffuse1", "vLightSpecular1", "vLightDirection1", "vLightGround1", "lightMatrix1", "vLightData2", "vLightDiffuse2", "vLightSpecular2", "vLightDirection2", "vLightGround2", "lightMatrix2", "vLightData3", "vLightDiffuse3", "vLightSpecular3", "vLightDirection3", "vLightGround3", "lightMatrix3", "darkness0", "darkness1", "darkness2", "darkness3"), this._samplers.push("shadowSampler0", "shadowSampler1", "shadowSampler2", "shadowSampler3"), this._hasLights = !0
        }, e.prototype._isReady = function(t, e, n, i) {
            return this._hasDiffuse && !this.diffuseReadyChunk(t, e) ? !1 : this._hasBump && !this.bumpReadyChunk(t, e) ? !1 : this._hasEnv && !this.envReadyChunk(t, e) ? !1 : (this._hasLights && this.lightReadyChunk(i, t, e), this._hasUvs && this.uvReadyChunk(i, t), !0)
        }, e.prototype.isReady = function(t) {
            if (this._wasPreviouslyReady)
                return !0;
            GlobalHelper.isWindowsPhoneDevice() && (this._shaderName = "legacydefault");
            var e, n = this._scene.getEngine(), i = new Array;
            if (e = this._customDefines ? this._customDefines.slice() : [], !this._isReady(e, i, n, t))
                return !1;
            var o = e.join("\n");
            return this._cachedDefines != o && (this._cachedDefines = o, this._effect = this._scene.getEngine().createEffect(this._shaderName, this._attribs, this._uniforms, this._samplers, o, i, this.onCompiled, this.onError)), this._effect.isReady() ? (this._renderId = this._scene.getRenderId(), this._wasPreviouslyReady = !0, this._uniformsLocations.vEyePosition = this._effect.getUniform("vEyePosition"), this._uniformsLocations.viewProjection = this._effect.getUniform("viewProjection"), this._uniformsLocations.lightMatrix = [], this._uniformsLocations.darkness = [], this._uniformsLocations.lightMatrix[0] = this._effect.getUniform("lightMatrix0"), this._uniformsLocations.darkness[0] = this._effect.getUniform("darkness0"), this._uniformsLocations.lightMatrix[1] = this._effect.getUniform("lightMatrix1"), this._uniformsLocations.darkness[1] = this._effect.getUniform("darkness1"), this._uniformsLocations.lightMatrix[2] = this._effect.getUniform("lightMatrix2"), this._uniformsLocations.darkness[2] = this._effect.getUniform("darkness2"), this._uniformsLocations.lightMatrix[3] = this._effect.getUniform("lightMatrix3"), this._uniformsLocations.darkness[3] = this._effect.getUniform("darkness3"), !0) : !1
        }, e.prototype.diffuseReadyChunk = function(t) {
            if (this._scene.texturesEnabled && this.diffuseTexture && BABYLON.StandardMaterial.DiffuseTextureEnabled) {
                if (!this.diffuseTexture.isReady())
                    return !1;
                t.push("#define DIFFUSE")
            }
            return !0
        }, e.prototype.bumpReadyChunk = function(t, e) {
            if (this._scene.getEngine().getCaps().standardDerivatives && this.bumpTexture && BABYLON.StandardMaterial.BumpTextureEnabled) {
                if (!this.bumpTexture.isReady())
                    return !1;
                t.push("#define BUMP"), e.push(t[t.length - 1])
            }
            return !0
        }, e.prototype.envReadyChunk = function(t) {
            if (this.reflectionTexture && BABYLON.StandardMaterial.ReflectionTextureEnabled) {
                if (!this.reflectionTexture.isReady())
                    return !1;
                t.push("#define REFLECTION")
            }
            return !0
        }, e.prototype.uvReadyChunk = function(t, e) {
            t && t.isVerticesDataPresent(BABYLON.VertexBuffer.UVKind) && e.push("#define UV1")
        }, e.prototype.lightReadyChunk = function(t, e, n) {
            var i = !1, o = 0;
            if (this._scene.lightsEnabled)
                for (var r = 0; r < this._scene.lights.length; r++) {
                    var s = this._scene.lights[r];
                    if (s.isEnabled() && (!t || -1 === s.excludedMeshes.indexOf(t))) {
                        e.push("#define LIGHT" + o), o > 0 && n.push(e[e.length - 1]);
                        var a;
                        a = s instanceof BABYLON.SpotLight ? "#define SPOTLIGHT" + o : s instanceof BABYLON.HemisphericLight ? "#define HEMILIGHT" + o : "#define POINTDIRLIGHT" + o, e.push(a), o > 0 && n.push(e[e.length - 1]);
                        var l = s.getShadowGenerator();
                        if (t && t.receiveShadows && l && (e.push("#define SHADOW" + o), o > 0 && n.push(e[e.length - 1]), i || (e.push("#define SHADOWS"), i = !0), l.useVarianceShadowMap && (e.push("#define SHADOWVSM" + o), o > 0 && n.push(e[e.length - 1])), l.usePoissonSampling && (e.push("#define SHADOWPCF" + o), o > 0 && n.push(e[e.length - 1]))), o++, 4 == o)
                            break
                    }
                }
        }, e.prototype.setBaseColor = function() {
        }, e.prototype._batchedBind = function() {
        }, e.prototype._mandatoryBind = function() {
        }, e.prototype.bind = function(t, e) {
            this._effect.setMatrix("world", t), this._mandatoryBind(t, e)
        }, e.prototype.unbind = function() {
            this.reflectionTexture && this.reflectionTexture.isRenderTarget && this._effect.setTexture("reflection2DSampler", null)
        }, e.prototype._preBind = function() {
            t.prototype._preBind.call(this);
            var e = -1 != this.category && n === this.category;
            n = this.category, e || this._batchedBind()
        }, e.prototype.bindView = function() {
            this._effect._engine.setFloat3(this._uniformsLocations.vEyePosition, this._scene.activeCamera.position.x, this._scene.activeCamera.position.y, this._scene.activeCamera.position.z), this._effect._engine.setMatrix(this._uniformsLocations.viewProjection, this._scene.getTransformMatrix())
        }, e.prototype.bindColor = function() {
            this._effect.setColor4("vDiffuseColor", this.diffuseColor, this.alpha)
        }, e.prototype.bindAlpha = function() {
            this._effect.setFloat("vAlpha", this.alpha)
        }, e.prototype.bindDiffuse = function() {
            this.diffuseTexture && BABYLON.StandardMaterial.DiffuseTextureEnabled && (this._effect.setTexture("diffuseSampler", this.diffuseTexture), this._effect.setFloat2("vDiffuseInfos", this.diffuseTexture.coordinatesIndex, this.diffuseTexture.level), this._effect.setMatrix("diffuseMatrix", this.diffuseTexture.getTextureMatrix()))
        }, e.prototype.bindBump = function() {
            this.bumpTexture && this._scene.getEngine().getCaps().standardDerivatives && BABYLON.StandardMaterial.BumpTextureEnabled && (this._effect.setTexture("bumpSampler", this.bumpTexture), this._effect.setFloat2("vBumpInfos", this.bumpTexture.coordinatesIndex, this.bumpTexture.level), this._effect.setMatrix("bumpMatrix", this.bumpTexture.getTextureMatrix()))
        }, e.prototype.bindEnv = function() {
            this.reflectionTexture && BABYLON.StandardMaterial.ReflectionTextureEnabled && (this._effect.setTexture("reflectionCubeSampler", this.reflectionTexture), this._effect.setMatrix("reflectionMatrix", this.reflectionTexture.getReflectionTextureMatrix()), this._effect.setFloat3("vReflectionInfos", this.reflectionTexture.coordinatesMode, this.reflectionTexture.level, this.reflectionTexture.isCube ? 1 : 0))
        }, e.prototype.bindLights = function() {
            for (var t = 0, e = 0; e < this._scene.lights.length; e++) {
                var n = this._scene.lights[e];
                n.isEnabled() && (n instanceof BABYLON.PointLight ? n.transferToEffect(this._effect, "vLightData" + t) : n instanceof BABYLON.DirectionalLight ? n.transferToEffect(this._effect, "vLightData" + t) : n instanceof BABYLON.SpotLight ? n.transferToEffect(this._effect, "vLightData" + t, "vLightDirection" + t) : n instanceof BABYLON.HemisphericLight && n.transferToEffect(this._effect, "vLightData" + t, "vLightGround" + t), n.diffuse.scaleToRef(n.intensity, this._scaledDiffuse), n.specular.scaleToRef(n.intensity, this._scaledSpecular), this._effect.setColor4("vLightDiffuse" + t, this._scaledDiffuse, n.range), this._effect.setColor3("vLightSpecular" + t, this._scaledSpecular))
            }
        }, e.prototype.bindShadows = function(t, e) {
            if (this._hasLights && this._scene.lightsEnabled)
                for (var n = 0, i = 0; i < this._scene.lights.length; i++) {
                    var o = this._scene.lights[i];
                    if (o.isEnabled()) {
                        var r = o.getShadowGenerator();
                        if (e.receiveShadows && r && (t.multiplyToRef(r.getTransformMatrix(), this._lightMatrix), this._effect.setTexture("shadowSampler" + n, r.getShadowMap()), this._effect._engine.setMatrix(this._uniformsLocations.lightMatrix[i], this._lightMatrix), this._effect._engine.setFloat(this._uniformsLocations.darkness[i], r.getDarkness())), n++, 4 == n)
                            break
                    }
                }
        }, e.prototype.dispose = function(e) {
            this.diffuseTexture && this.diffuseTexture.dispose(), this.bumpTexture && this.bumpTexture.dispose(), this.reflectionTexture && this.reflectionTexture.dispose(), t.prototype.dispose.call(this, e)
        }, e.prototype.clone = function(t) {
            var e = this.isDefault;
            this.isDefault = !1;
            var n = this.serialize();
            this.isDefault = e;
            var i = ujs.deserializeObject(n);
            return i.name = t, i.isDefault = this.isDefault, i
        }, e
    }(BABYLON.Material);
    t.StandardMaterial = e
}(wnp || (wnp = {})), function(t) {
    var e = function(t) {
        function e(e, n, i) {
            t.call(this, e, n), this.params = i || {}, this.params.diffuseTexture && (this.diffuseTexture = this.params.diffuseTexture instanceof BABYLON.Texture ? this.params.diffuseTexture : new BABYLON.Texture(this.params.diffuseTexture, wanaplan.engine3D.scene), this.bumpTexture = null), this.params.bumpTexture && (this.bumpTexture = this.params.bumpTexture instanceof BABYLON.Texture ? this.params.bumpTexture : new BABYLON.Texture(this.params.bumpTexture, wanaplan.engine3D.scene)), this.category = -1, this._shaderName = "textured"
        }
        return __extends(e, t), e.prototype.build = function() {
            this.uv(), this.normal(), this.diffuse(), this.light(), this.setAlpha()
        }, e.prototype._batchedBind = function() {
        }, e.prototype._mandatoryBind = function(t, e) {
            this.bindView(), this.bindShadows(t, e), this.bindDiffuse(), this.bindAlpha(), this.bindLights()
        }, e
    }(t.StandardMaterial);
    t.TexturedMaterial = e
}(wnp || (wnp = {})), function(t) {
    var e = function(e) {
        function n(n, i, o) {
            e.call(this, n, i), this.category = 2, this.params = o || {}, this.params.brillance = this.params.brillance || .5, this.params.brillance = BABYLON.Math.clamp(this.params.brillance, 0, 1), this.params.baseColor = this.params.baseColor || new BABYLON.Color3(.6, .6, .6), this.diffuseColor = new BABYLON.Color3(this.params.brillance * this.params.baseColor.r, this.params.brillance * this.params.baseColor.g, this.params.brillance * this.params.baseColor.b), this.reflectionTexture = new BABYLON.CubeTexture(t.Assets.flatEnvMapTexture, i), this._shaderName = "metal", this.setCustomDefines(["#define METAL"])
        }
        return __extends(n, e), n.prototype.setBaseColor = function(t) {
            this.params.baseColor = t, this.diffuseColor.copyFromFloats(this.params.brillance * t.r, this.params.brillance * t.g, this.params.brillance * t.b)
        }, n.prototype.build = function() {
            this.color(), this.normal(), this.env(), this.light()
        }, n.prototype._batchedBind = function() {
            this.bindEnv(), this.bindLights()
        }, n.prototype._mandatoryBind = function(t, e) {
            this.bindView(), this.bindShadows(t, e), this.bindColor()
        }, n
    }(t.StandardMaterial);
    t.MetalMaterial = e
}(wnp || (wnp = {})), function(t) {
    var e = function(e) {
        function n(n, i, o) {
            e.call(this, n, i, o), this.category = 3, this.alpha = this.params.opacity || this.params.alpha || .3, this.alpha = BABYLON.Math.clamp(this.alpha, 0, 1), this.reflectionTexture = new BABYLON.CubeTexture(t.Assets.envMapTexture, i), this.setCustomDefines(["#define GLASS"]), this.setBaseColor(this.params.baseColor || {r: .6,g: .6,b: .6})
        }
        return __extends(n, e), n
    }(t.MetalMaterial);
    t.GlassMaterial = e
}(wnp || (wnp = {})), function(t) {
    var e = function(e) {
        function n(n, i, o) {
            e.call(this, n, i, o), this.params.diffuseTexture || (this.diffuseTexture = new BABYLON.Texture(t.Assets.woodTextures.diffuse, wanaplan.engine3D.scene)), this.category = 1, this.setCustomDefines(["#define WOOD"])
        }
        return __extends(n, e), n
    }(t.TexturedMaterial);
    t.WoodMaterial = e
}(wnp || (wnp = {})), function(t) {
    var e = function(t) {
        function e(e, n, i) {
            t.call(this, e, n, i), this.category = 4, this.setCustomDefines(["#define LEATHER"])
        }
        return __extends(e, t), e
    }(t.TexturedMaterial);
    t.LeatherMaterial = e
}(wnp || (wnp = {})), function(t) {
    var e = function(t) {
        function e(e, n, i) {
            t.call(this, e, n), this.category = 5, this.params = i || {}, this.params.factor = this.params.factor || 1, this.params.factor = BABYLON.Math.clamp(this.params.factor, 0, 1), this.diffuseColor = new BABYLON.Color3(this.params.factor, this.params.factor, this.params.factor), this._shaderName = "white", this.setCustomDefines(["#define WHITE"])
        }
        return __extends(e, t), e.prototype.setBaseColor = function(t) {
            this.params.factor = (t.r + t.g + t.b) / 3, this.diffuseColor.copyFromFloats(this.params.factor, this.params.factor, this.params.factor)
        }, e.prototype.build = function() {
            this.color(), this.normal(), this.light()
        }, e.prototype._batchedBind = function() {
        }, e.prototype._mandatoryBind = function(t, e) {
            this.bindView(), this.bindShadows(t, e), this.bindColor(), this.bindLights()
        }, e
    }(t.StandardMaterial);
    t.WhiteMaterial = e
}(wnp || (wnp = {})), function(t) {
    var e = function(t) {
        function e(e, n, i) {
            this.params = i || {}, t.call(this, e, n, this.params), this.category = 6, this.diffuseColor = this.params.baseColor ? new BABYLON.Color3(this.params.baseColor.r, this.params.baseColor.g, this.params.baseColor.b) : new BABYLON.Color3(1, 1, 1), this.setCustomDefines(["#define PLASTIC"])
        }
        return __extends(e, t), e.prototype.setBaseColor = function(t) {
            this.params.baseColor = t, this.diffuseColor.copyFrom(t)
        }, e
    }(t.WhiteMaterial);
    t.PlasticMaterial = e
}(wnp || (wnp = {})), function(t) {
    var e = function(t) {
        function e(e, n, i) {
            t.call(this, e, n, i), this.category = 7, this.setCustomDefines(["#define TILE"])
        }
        return __extends(e, t), e
    }(t.TexturedMaterial);
    t.TileMaterial = e
}(wnp || (wnp = {})), function(t) {
    var e = function(e) {
        function n(n, i, o) {
            e.call(this, n, i, o), this.params.diffuseTexture || (this.diffuseTexture = new BABYLON.Texture(t.Assets.firePlaceWood.diffuse, wanaplan.engine3D.scene)), this.category = 8, this.setCustomDefines(["#define MATT"])
        }
        return __extends(n, e), n
    }(t.TexturedMaterial);
    t.MattMaterial = e
}(wnp || (wnp = {}));
var wnp = window.wnp || {};
!function() {
    wnp.StandardMaterial.prototype.serialize = function(t) {
        if (this.isDefault)
            return null;
        var t = t || {};
        return t.class = {name: wnp.StandardMaterial.GetClassFromCategory(this.category)}, ujs.serializeObject(this, t, ["name", "backFaceCulling", "addColor", "params"]), t
    }, wnp.StandardMaterial.prototype.deserialize = function(e) {
        return e ? (ujs.deserializeObject(e, this, ["name", "backFaceCulling", "addColor"]), this.isDefault = !1, t(this), e.centroid && (this.centroid = e.centroid), e.side && (this.side = e.side), e.ambientColor && this.setBaseColor(ujs.deserializeObject(e.ambientColor)), e.emissiveColor && this.setBaseColor(ujs.deserializeObject(e.emissiveColor)), this) : null
    }, wnp.StandardMaterial.Deserialize = function(t) {
        var e = {};
        ujs.deserializeObject(t.params, e);
        var n = ujs.stringToFunction(t.class.name), i = new n(t.name, wanaplan.engine3D.scene, e);
        return i.deserialize(t), i
    }, wnp.StandardMaterial.GetClassFromCategory = function(t) {
        switch (t) {
            case -1:
                return "wnp.StandardMaterial";
            case 1:
                return "wnp.WoodMaterial";
            case 2:
                return "wnp.MetalMaterial";
            case 3:
                return "wnp.GlassMaterial";
            case 4:
                return "wnp.LeatherMaterial";
            case 5:
                return "wnp.WhiteMaterial";
            case 6:
                return "wnp.PlasticMaterial";
            case 7:
                return "wnp.TileMaterial";
            case 8:
                return "wnp.MattMaterial";
            default:
                return Logger.warning("Category Error (wnp.StandardMaterial)"), null
        }
    }, wnp.WoodMaterial.Deserialize = wnp.StandardMaterial.Deserialize, wnp.MetalMaterial.Deserialize = wnp.StandardMaterial.Deserialize, wnp.GlassMaterial.Deserialize = wnp.StandardMaterial.Deserialize, wnp.LeatherMaterial.Deserialize = wnp.StandardMaterial.Deserialize, wnp.WhiteMaterial.Deserialize = wnp.StandardMaterial.Deserialize, wnp.PlasticMaterial.Deserialize = wnp.StandardMaterial.Deserialize, wnp.TileMaterial.Deserialize = wnp.StandardMaterial.Deserialize, wnp.MattMaterial.Deserialize = wnp.StandardMaterial.Deserialize, wnp.TexturedMaterial.prototype.serialize = function() {
        if (1 == this.isDefault)
            return null;
        var t = {};
        return wnp.StandardMaterial.prototype.serialize.call(this, t), ujs.serializeObject(this, t, ["diffuseTexture", "bumpTexture"]), t
    }, wnp.TexturedMaterial.prototype.deserialize = function(t) {
        return ujs.deserializeObject(t, this, ["diffuseTexture", "bumpTexture"]), wnp.StandardMaterial.prototype.deserialize.call(this, t), this
    }, wnp.GlassMaterial.prototype.serialize = function() {
        if (1 == this.isDefault)
            return null;
        var t = {};
        return wnp.StandardMaterial.prototype.serialize.call(this, t), ujs.serializeObject(this, t, ["alpha"]), t
    }, wnp.GlassMaterial.prototype.deserialize = function(t) {
        return ujs.deserializeObject(t, this, ["alpha"]), wnp.StandardMaterial.prototype.deserialize.call(this, t), this
    }, BABYLON.StandardMaterial.prototype.serialize = function() {
        var t = BABYLON.Material.prototype.serialize.call(this);
        return t.class = {name: "BABYLON.StandardMaterial"}, ujs.serializeObject(this, t, ["diffuseTexture", "ambientTexture", "opacityTexture", "reflectionTexture", "emissiveTexture", "specularTexture", "bumpTexture", "ambientColor", "diffuseColor", "specularColor", "specularPower", "emissiveColor", "addColor"]), t
    }, BABYLON.StandardMaterial.prototype.deserialize = function(e) {
        return BABYLON.Material.prototype.deserialize.call(this, e), ujs.deserializeObject(e, this, ["diffuseTexture", "ambientTexture", "opacityTexture", "reflectionTexture", "emissiveTexture", "specularTexture", "bumpTexture", "ambientColor", "diffuseColor", "specularColor", "specularPower", "emissiveColor", "addColor"]), t(this), this
    }, wnp.BlackMaterial = wnp.WhiteMaterial, wnp.PolishedMaterial = wnp.WoodMaterial, wnp.LuxensMaterial = wnp.PlasticMaterial, wnp.TransparentMaterial = wnp.GlassMaterial;
    var t = function(t) {
        if ((t instanceof wnp.GlassMaterial || t instanceof wnp.MetalMaterial) && t.addColor && t.addColor.color)
            t.setBaseColor(t.addColor.color);
        else if (t.addColor && t.addColor.color && t.diffuseTexture && t.diffuseTexture.url) {
            t.addColor.size = t.addColor.size || {width: 512,height: 512};
            var e = new Image;
            e.crossOrigin = "Anonymous";
            var n = t.addColor.color;
            e.src = t.diffuseTexture.url;
            var i = new BABYLON.DynamicTexture("canvas", t.addColor.size.width, wanaplan.engine3D.scene, !0);
            i.url = t.diffuseTexture.url;
            var o = {u: t.diffuseTexture.uScale,v: t.diffuseTexture.vScale};
            t.diffuseTexture = i, t.diffuseColor = new BABYLON.Color3(n.r, n.g, n.b).scale(.2), e.onload = function() {
                var r = i.getContext();
                r.fillStyle = wnp.MaterialFactory.rgbToHex(n), r.clearRect(0, 0, t.addColor.size.width, t.addColor.size.height), r.drawImage(e, 0, 0, t.addColor.size.width, t.addColor.size.height), r.globalCompositeOperation = "soft-light", r.globalCompositeOperation = "color-burn", r.globalCompositeOperation = "multiply", r.fillRect(0, 0, t.addColor.size.width, t.addColor.size.height), i.wrapU = BABYLON.Texture.WRAP_ADDRESSMODE, i.wrapV = BABYLON.Texture.WRAP_ADDRESSMODE, i.uScale = o.u || 1, i.vScale = o.v || 1, i.update()
            }
        }
    }
}();
var BaseStructure = function() {
    var t = 0, e = function(e) {
        this.id = t++, this.name = e || "Structure_" + t
    };
    return e.prototype.add = function(t, e) {
        if ("undefined" == typeof this[t] && (this[t] = []), this[t] instanceof Array) {
            var n = this[t].indexOf(e);
            if (-1 == n)
                return !1;
            this[t].push(e)
        } else
            this[t] = e;
        return !0
    }, e.prototype.initialize = function() {
    }, e.prototype.update = function() {
    }, e.prototype.serialize = function() {
    }, e.Deserialize = function() {
    }, e.prototype.updateReferences = function() {
    }, e.prototype.updateFieldArray = function(t, e, n) {
        n.length = 0;
        for (var i = 0, o = this.structureIds.length; o > i; i++)
            for (var r = 0, s = e.length; s > r; r++)
                e[r].id == this.structureIds[i] && n.push(e[r])
    }, e.prototype.getElementByName = function(t, e) {
        var n = function(t, e) {
            for (var n = 0, i = null, o = e.length; o > n && null === e; )
                e[n].name == t && (i = e[n]), n++;
            return i
        };
        if (this[e] instanceof Array)
            return n(t, this[e]);
        var i = null;
        for (var o in this)
            this[o] instanceof Array && (i = n(t, this[o]));
        return i
    }, e
}(), BaseComponent2D = function() {
    var t = function(t, e) {
        this.core = t, this.name = e || "Component2D", this.structure = null, this.keyboard = null, this.priority = 42, this.enabled = !0;
        var n = this;
        "undefined" != typeof t && (this.structure = this.core.structure, this.keyboardManager = this.core.keyboardManager, document.addEventListener("wnp.contextChanged", function(t) {
            n.enabled && t.context != t.previousContext && n.onContextChanged(t.context)
        }, !1))
    };
    return t.prototype.initialize = function() {
        this.startListening()
    }, t.prototype.startListening = function() {
    }, t.prototype.stopListening = function() {
    }, t.prototype.onContextChanged = function(t) {
        "2D" == t ? this.startListening() : this.stopListening()
    }, t.prototype.disable = function() {
        this.enabled = !1, this.stopListening()
    }, t.prototype.enable = function() {
        this.enabled = !0
    }, t.prototype.getTargeted = function() {
        return null
    }, t.prototype.update = function() {
    }, t.prototype.compute = function() {
    }, t.prototype.destroy = function() {
    }, t
}(), BaseComponent3D = function() {
    var t = function(t, e) {
        if (this.core = t, this.engine3D = null, this.name = e || "Component3D", this.structure = null, this.keyboardManager = null, this.materialFactory = null, this.scene = null, this.draggableObjects = null, this.cameraController = null, this.cubeCameras = null, this.configuration = null, this.camera = null, this.enabled = !0, this.initialized = !1, "undefined" != typeof t) {
            this.name = e, this.engine3D = this.core.engine3D, this.structure = this.core.structure, this.keyboardManager = this.core.keyboardManager, this.configuration = this.core.configuration, this.scene = this.core.engine3D.scene, this.camera = this.core.engine3D.camera, this.cubeCameras = this.core.engine3D.cubeCameras, this.cameraController = this.core.engine3D.cameraController, this.materialFactory = this.core.engine3D.materialFactory;
            var n = this;
            document.addEventListener("wnp.contextChanged", function(t) {
                n.enabled && t.context != t.previousContext && n.onContextChanged(t.context)
            }, !1), document.addEventListener("wnp.engine3D.forceReload", this.reloadConfiguration, !1)
        }
    };
    return t.prototype.initialize = function() {
    }, t.prototype.startListening = function() {
    }, t.prototype.stopListening = function() {
    }, t.prototype.onContextChanged = function(t) {
        "3D" == t ? this.startListening() : this.stopListening()
    }, t.prototype.disable = function() {
        this.enabled = !1, this.stopListening()
    }, t.prototype.enable = function() {
        this.enabled = !0
    }, t.prototype.update = function() {
    }, t.prototype.compute = function() {
    }, t.prototype.reloadConfiguration = function() {
    }, t.prototype.getFloor = function(t) {
        var e = this.core.getComponentByName("FloorComponent3D"), t = t || wanaplan.getSelectedStructure();
        return e.getFloor(t)
    }, t.prototype.getObjectStructure = function(t) {
        return Logger.warning("[BaseComponent3D] getObjectStructure - Fonction dépreciée"), t.structure
    }, t.prototype.getParentRelativeToScene = function(t) {
        var e = t.parent;
        if ("structure" != e.name && "undefined" != typeof e.parent) {
            for (; "undefined" != typeof e.parent && "structure" != e.parent.name; )
                e = e.parent;
            t = e
        }
        return t
    }, t.prototype.getParentRelativeToGroup = function(t) {
        var e = t.parent;
        if ("structure" != e.name && -1 == e.name.indexOf("group_") && "undefined" != typeof e.parent) {
            for (; "undefined" != typeof e.parent && -1 == e.parent.name.indexOf("group_") && "structure" != e.parent.name; )
                e = e.parent;
            t = e
        }
        return t
    }, t.prototype.getObjectByName = function(t, e) {
        return this.core.getSelectedStructure().getElementByName(t, e)
    }, t.prototype.destroy = function() {
    }, t
}(), BaseEditionComponent = function() {
    var t = function(t) {
        this.name = t || "EditionComponent"
    };
    return t.prototype.initialize = function() {
    }, t
}(), MainMenuComponent = function() {
    var t = [{title: "Draw",index: 1,icon: "images/dessiner.png",action: "wnp.request.changeEngine",id: "draw2D",params: {engine: "2D"},layout: "layout-list",context: "2D",items: []}, {title: "Furnish",index: 2,icon: "images/meubler.png",action: "wnp.request.changeEngine",id: "furnishing3D",context: "3D",params: {engine: "3D"},layout: "layout-list",items: []}, {title: "Decorate",index: 3,icon: "images/decorer.png",action: "wnp.request.changeEngine",id: "decorate3D",context: "3D",params: {engine: "3D"},layout: "layout-list",items: []}], e = function(e) {
        BaseComponent2D.call(this, e, "MainMenuComponent"), this.menu = new wnp.UI.Menu(t, "mainMenuTabs", {selected: t[0],inception: !1}), this.menu.initialize(), this.menuTitleDom = document.getElementById("mainMenuTitle"), this.menuTitleDom.innerHTML = _(this.menu.selected.title), this.submenu = new wnp.UI.Menu(t[0].items, "mainMenuContentList"), document.addEventListener("wnp.menu.main.add", this.addItem.bind(this), !1), document.addEventListener("wnp.menu.main.replace", this.replaceItem.bind(this), !1), document.addEventListener("wnp.menu.main.deselect", this.deselectItem.bind(this), !1), document.addEventListener("wnp.menu.main.remove", this.removeItem.bind(this), !1), document.addEventListener("wnp.request.changeEngine", this.onChangeEngine.bind(this), !1), document.addEventListener("wnp.menu.main.remove", this.removeItem.bind(this), !1)
    };
    return e.prototype = new BaseComponent2D, e.prototype.onChangeEngine = function() {
        this.menuTitleDom.innerHTML = _(this.menu.selected.title), this.updateSubMenu()
    }, e.prototype.removeItem = function(t) {
        this.menu.deleteMenuItem(t.item), this.menu.updateHtml(), this.submenu.updateHtml()
    }, e.prototype.replaceItem = function(t) {
        if (t.item) {
            var e = t.item, n = t.merge || !1;
            this.menu.replaceMenuItem(e.id, e, n), this.submenu.updateHtml(e)
        }
    }, e.prototype.deselectItem = function(t) {
        var e = t.all || !1, n = t.itemId || !1;
        this.submenu.selected.items && 0 != this.submenu.selected.items.length && this.submenu.selected.items != {} || this.submenu.deselect(e, n)
    }, e.prototype.updateSubMenu = function() {
        this.menu.selected.items && (this.submenu = new wnp.UI.Menu(this.menu.selected.items, "mainMenuContentList"), this.submenu.initialize())
    }, e.prototype.addItem = function(t) {
        if (t.item && t.menuPath) {
            var e = t.item, n = t.menuPath, i = t.position > -1 ? t.position : 1e5;
            e.index = e.index > -1 ? e.index : i, this.menu.addMenuItem(n, e, i), this.submenu.updateHtml()
        }
    }, e.prototype.removeItem = function(t) {
        t.item && (this.menu.deleteMenuItem(t.item), this.menu.updateHtml(), this.submenu.updateHtml())
    }, e
}(), TopMenuComponent = function(t) {
    var e = [], n = [], i = function() {
        BaseComponent2D.call(this, t, "TopMenuComponent"), this.menu = new wnp.UI.Menu(e, "toolbarMenu", {oneClick: !0}), this.submenu = new wnp.UI.Menu(n, "subMenuList", {oneClick: !0}), document.addEventListener("wnp.menu.top.add", this.addItem.bind(this), !1), document.addEventListener("wnp.menu.top.delete", this.removeItem.bind(this), !1), document.addEventListener("wnp.menu.top.replace", this.replaceItem.bind(this), !1), document.addEventListener("wnp.menu.top.sub.add", this.addSubItem.bind(this), !1), document.addEventListener("wnp.menu.top.sub.delete", this.removeSubItem.bind(this), !1), document.addEventListener("wnp.menu.top.sub.replace", this.replaceSubItem.bind(this), !1), document.addEventListener("wnp.menu.top.deselect", this.deselectItem.bind(this), !1)
    };
    return i.prototype = Object.create(BaseComponent2D.prototype), i.prototype._addItem = function(t, e) {
        if (e.item && e.menuPath) {
            var n = e.item, i = e.menuPath, o = e.position > -1 ? e.position : 1e5;
            n.index = n.index > -1 ? n.index : o, t.addMenuItem(i, n, o), t.updateHtml()
        }
    }, i.prototype._replaceItem = function(t, e) {
        if (e.item) {
            var n = e.item, i = "undefined" != typeof e.merge ? e.merge : !1;
            t.replaceMenuItem(n.id, n, i), t.updateHtml()
        }
    }, i.prototype._removeItem = function(t, e) {
        e.id && (t.deleteMenuItem(e.id), t.updateHtml())
    }, i.prototype.deselectItem = function() {
        this.menu.deselect(!0)
    }, i.prototype.addItem = function(t) {
        this._addItem(this.menu, t)
    }, i.prototype.replaceItem = function(t) {
        this._replaceItem(this.menu, t)
    }, i.prototype.removeItem = function(t) {
        this._removeItem(this.menu, t)
    }, i.prototype.addSubItem = function(t) {
        this._addItem(this.submenu, t)
    }, i.prototype.replaceSubItem = function(t) {
        this._replaceItem(this.submenu, t)
    }, i.prototype.removeSubItem = function(t) {
        this._removeItem(this.submenu, t)
    }, i
}(), BaseTopMenuComponent2D = function() {
    var t = function(t, e) {
        BaseComponent2D.call(this, t, e), this._topMenuComponent = null, this._item = {}, this.isMainMenuItem = !0
    };
    return t.prototype = Object.create(BaseComponent2D.prototype), t.prototype.initialize = function() {
        BaseComponent2D.prototype.initialize.call(this), ujs.notify(this.isMainMenuItem ? "wnp.menu.top.add" : "wnp.menu.top.sub.add", {item: this._item,menuPath: "."})
    }, t.prototype.destroy = function() {
        BaseComponent2D.prototype.destroy.call(this), ujs.notify(this.isMainMenuItem ? "wnp.menu.top.delete" : "wnp.menu.top.sub.delete", {id: this._item.id,menuPath: "."})
    }, t
}(), SaveComponent = function() {
    var t, e = !1, n = function(e) {
        BaseTopMenuComponent2D.call(this, e, "SaveComponent"), this._item = {title: "Save",icon: "images/save_icon.png",action: "wnp.request.saveStructure",id: "toolbarSave",items: [],index: "2"}, document.addEventListener("wnp.request.saveStructure", this.saveStructure.bind(this), !1), window.addEventListener("message", function(e) {
            var n = JSON.parse(e.data);
            "save-plan" == n.action ? t.saveStructure(e) : "update-urls" == n.action && (n.planUrl && (t.core.api.planUrl = n.planUrl), n.newUrl && (t.core.api.newUrl = n.newUrl), n.screenshotUrl && (t.core.api.screenshotUrl = n.screenshotUrl), n.saveUrl && (t.core.api.saveUrl = n.saveUrl))
        }), t = this
    };
    return n.prototype = Object.create(BaseTopMenuComponent2D.prototype), n.prototype.startProcess = function() {
        e = !0
    }, n.prototype.endProcess = function() {
        e = !1
    }, n.prototype.saveStructure = function(n, i, o) {
        if (e !== !0) {
            this.startProcess();
            var i = i || n.callback || function() {
            };
            if (n.callback = !1, "planStructure" !== this.structure.name)
                t.sendToServer(t.core.structure.name, void 0, i, o);
            else {
                var r = new Date, s = this.core.api.title || [_("My plan") + " ", r.getDay(), "/", r.getMonth(), "/", r.getFullYear(), " - ", Math.floor(100 * Math.random())].join(""), a = "", l = function(e) {
                    s = "" !== e.textInput ? e.textInput : s, a = "" !== e.textAreaInput ? e.textAreaInput : a, t.sendToServer(s, a, i, o)
                }, h = {title: _("Save a Plan"),message: _("Choose a name for your plan"),buttonBText: _("Save"),buttonAText: _("Cancel"),buttonA: !0,buttonB: !0,input: !0,inputValue: s,textArea: !0,textAreaPlaceHolder: _("Enter a description"),onClose: t.endProcess,onClickB: l,onClickA: function() {
                    }};
                wnp.UI.MessageBox.close(), wnp.UI.MessageBox.show(h)
            }
        }
    }, n.prototype.onError = function() {
        var e = t.core.saveLocalStructure(!1, !0), n = {title: _("Save a Plan"),message: _("An error occured during save, please try later."),buttonA: !0,buttonAText: _("Download a backup"),onClose: t.endProcess,onClickA: function() {
                var n = t.core.getOrigin();
                parent.postMessage({type: "downloadFile",name: "plan",content: "data:text/html;base64," + btoa(e)}, n), wnp.UI.MessageBox.close(), t.endProcess()
            }};
        wnp.UI.MessageBox.show(n)
    }, n.prototype.sendToServer = function(e, n, i, o) {
        var r = this.core.getPreviewImage(320, 240), s = this.core.engine2D.isEnabled() ? "2D" : "3D";
        t.core.structure.name = e;
        var a = t.core.saveLocalStructure(!1, !0), l = ["title=", encodeURIComponent(e), "&plan=", encodeURIComponent(a), "&preview=", r, "&previewMode=", s];
        t.core.api.params, t.core.api.id && l.push("&id=" + t.core.api.id), n && l.push("&description=" + encodeURIComponent(n)), ujs.ajax({method: "POST",url: t.core.api.saveUrl,withCredentials: !0,params: l.join(""),onerror: function(e) {
                t.onError(e), o && o()
            },success: function(e) {
                var n = JSON.parse(e), r = _("An error occured during save, please try later.");
                if ("ok" === n.status) {
                    t.core.saveStackToLocal(), r = _("Your plan has been saved."), t.core.structure.planId = !0;
                    var s = function() {
                    };
                    if (n["refresh-url"]) {
                        var a = t.core.getOrigin();
                        r += "<br />" + _("you will be redirected ..."), s = function() {
                            parent.postMessage({type: "refresh",url: n["refresh-url"]}, a)
                        }
                    }
                    parent.postMessage({type: "planSaved"}, t.core.getOrigin()), wnp.UI.MessageBox.show({title: _("Save a Plan"),message: r,buttonAText: _("Close"),buttonA: !0,autoHide: !0,onClose: s,force: !0}), n.params && (t.core.api.params = n.params), i(!0)
                } else
                    n.connectionUrl ? t.core._loginIframe(n.connectionUrl, n.frameWidth || Math.round(window.innerWidth / 2), n.frameHeight || Math.round(window.innerHeight / 2)) : t.onError(), o && o();
                t.endProcess()
            }})
    }, n
}(), NewComponent = function() {
    var t, e = function(e) {
        BaseTopMenuComponent2D.call(this, e, "NewComponent"), this._item = {title: _("New"),icon: "fa fa-file",action: "wnp.request.newPlan",id: "toolbarNew",items: [],index: "0"}, t = this, document.addEventListener("wnp.request.newPlan", function() {
            t.launchProcess(), t.core.engine2D.bestZoom()
        }, !1)
    };
    return e.prototype = Object.create(BaseTopMenuComponent2D.prototype), e.prototype.createNewPlan = function() {
        ujs.notify("wnp.request.closePopup"), t.core.structure.clear(), t.core._createDefaultStructure(), t.core.engine2D.reinitialize(), t.core.setSelectedEngine(t.core.ENGINE_2D), t.core.saveLocalStructure(!1), t.core.structure.planId = -1, t.core.structure.name = "planStructure", ujs.triggerEvent(document.getElementById("draw2D"), "click"), ujs.notify("wnp.request.newPlanReady"), t.core.engine2D.bestZoom()
    }, e.prototype.launchProcess = function() {
        if (!t.core.api.newUrl || !t.core.api.saveUrl)
            return void t.createNewPlan();
        var e = [t.core.api.newUrl];
        if (t.core.api.params) {
            var n = -1 !== t.core.api.newUrl.indexOf("?") ? "&" : "?";
            e.push([n, "params=", t.core.api.params].join(""))
        }
        var i = function() {
            ujs.ajax({method: "GET",url: e.join(""),withCredentials: !0,success: function(e) {
                    var n = JSON.parse(e);
                    if ("ok" === n.status)
                        n.saveUrl && (t.core.api.saveUrl = n.saveUrl), n.title && (t.core.api.planTitle = n.title), n.params && (t.core.api.params = n.params), t.createNewPlan();
                    else if (n.connectionUrl)
                        t.core._loginIframe(n.connectionUrl, n.frameWidth || Math.round(window.innerWidth / 2), n.frameHeight || Math.round(window.innerHeight / 2));
                    else {
                        var i = {title: _("Save a Plan"),message: n.message || _("Error occured during save."),buttonA: !0,buttonAText: _("Ok"),onClickA: function() {
                                wnp.UI.MessageBox.close()
                            }};
                        wnp.UI.MessageBox.show(i)
                    }
                }})
        }, o = function() {
            ujs.notify("wnp.request.saveStructure", {callback: i})
        };
        wnp.UI.MessageBox.show({title: _("New Plan"),message: _("Do you want to save your current plan?"),buttonCText: _("Yes"),buttonBText: _("No"),buttonAText: _("Cancel"),buttonA: !0,buttonB: !0,buttonC: !0,onClickC: o,onClickB: i,onClickA: function() {
                wnp.UI.MessageBox.close()
            }})
    }, e
}(), OptionsComponent = function() {
    var t = function(t) {
        BaseTopMenuComponent2D.call(this, t, "OptionsComponent"), this._item = {title: "Options",icon: "fa fa-cog",action: "optionMenu",id: "toolbarOption",selectionnable: !0,index: "3",items: [{title: "Change language",action: "wnp.request.changeLang",id: "toolbarChangeLanguage",index: 100}, {title: "<hr />",index: 1e5}, {title: "About Wanaplan",action: "wnp.ui.showAboutWindow",id: "toolbarAbout",index: 100001}]}
    };
    return t.prototype = Object.create(BaseTopMenuComponent2D.prototype), t
}(), ExitComponent = function() {
    var t, e = function(e) {
        BaseTopMenuComponent2D.call(this, e, "ExitComponent"), this._item = {title: "Exit",icon: "fa fa-sign-out",action: "wnp.request.exit",id: "toolbarExit",items: []}, t = this, document.addEventListener("wnp.request.exit", function() {
            t.exit()
        }, !1)
    };
    return e.prototype = Object.create(BaseTopMenuComponent2D.prototype), e.prototype.doExit = function() {
        if (wanaplan.api.params.exitUrl) {
            var e = t.core.getOrigin();
            parent.postMessage({type: "refresh",url: wanaplan.api.params.exitUrl}, e)
        }
        parent.postMessage({type: "planExit"}, t.core.getOrigin()), ujs.notify("wnp.request.exited")
    }, e.prototype.exit = function() {
        var e = {title: _("Exit"),message: _("Are you sure you want to leave this page"),buttonA: !0,buttonB: !0,buttonBText: _("Exit"),buttonAText: _("Cancel"),onClickB: function(e) {
                return t.doExit(e), !0
            }};
        wnp.UI.MessageBox.show(e)
    }, e
}(), ScreenshotMenuComponent = function() {
    var t = function(t) {
        BaseTopMenuComponent2D.call(this, t, "ScreenshotMenuComponent"), this.isMainMenuItem = !1, this._item = {title: "Capture",icon: "fa fa-camera",action: "wnp.request.takeScreenshot",id: "toolbarScreenshot",items: [],index: 500}
    };
    return t.prototype = Object.create(BaseTopMenuComponent2D.prototype), t
}(), FullscreenComponent = function() {
    function t(t) {
        t.requestFullScreen || (t.requestFullScreen = t.msRequestFullscreen || t.webkitRequestFullscreen || t.mozRequestFullScreen || function() {
            return !1
        }), document.cancelFullScreen || (document.cancelFullScreen = document.msExitFullscreen || document.webkitCancelFullScreen || document.mozCancelFullScreen || function() {
            return !1
        })
    }
    function e() {
        return document.fullscreen || document.msFullscreenElement || document.webkitIsFullScreen || document.mozFullScreen
    }
    var n = function(t) {
        BaseTopMenuComponent2D.call(this, t, "FullscreenComponent"), this.isMainMenuItem = !1, this._item = {title: "Full Screen",icon: "fa fa-arrows-alt",action: "wnp.request.toggleFullscreen",id: "fullscreen-btn",items: [],index: 1001}
    };
    return n.prototype = Object.create(BaseTopMenuComponent2D.prototype), n.prototype.initialize = function() {
        if (BaseTopMenuComponent2D.prototype.initialize.call(this), document.addEventListener("wnp.request.toggleFullscreen", this.toggleFullscreen, !1), document.addEventListener("mozfullscreenchange", this.onFullScreenChange, !1), document.addEventListener("webkitfullscreenchange", this.onFullScreenChange, !1), document.addEventListener("MSFullscreenChange", this.onFullScreenChange, !1), document.addEventListener("fullscreenchange", this.onFullScreenChange, !1), wanaplan.mode === wanaplan.MODE_VIEWER) {
            var e = document.getElementById("fullscreen-btn");
            e.setAttribute("title", _("Toggle to fullscreen mode")), e.addEventListener("click", toggleFullscreen, !1)
        }
        t(document.body)
    }, n.prototype.destroy = function() {
        BaseTopMenuComponent2D.prototype.destroy.call(this), document.removeEventListener("wnp.request.toggleFullscreen", this.toggleFullscreen), document.removeEventListener("mozfullscreenchange", this.onFullScreenChange), document.removeEventListener("webkitfullscreenchange", this.onFullScreenChange), document.removeEventListener("MSFullscreenChange", this.onFullScreenChange), document.removeEventListener("fullscreenchange", this.onFullScreenChange)
    }, n.prototype.toggleFullscreen = function(n) {
        var i = document.body;
        n instanceof HTMLElement && (i = n, t(i)), e() ? document.cancelFullScreen() : i.requestFullScreen()
    }, n.prototype.onFullScreenChange = function() {
        var t = document.getElementById("fullscreen-btn").querySelector(".menu-icon > i");
        t.setAttribute("class", e() ? "fa fa-expand" : "fa fa-arrows-alt")
    }, n
}(), CameraComponent = function() {
    var t, e = new BABYLON.Vector3(0, 170, 0), n = function(n) {
        BaseComponent3D.call(this, n, "CameraComponent"), t = this, this.ORBITCAMERA = 0, this.FPSCAMERA = 1, this.scene = n.engine3D.scene, this.cameraActiveId = 0, this.lookAt = null;
        var i = function() {
            this.bindLookAt(wanaplan.getComponentByName("AvatarComponent3D").avatar), document.removeEventListener("wnp.engine3d.globaleFloorReady", i, !1)
        }.bind(this);
        document.addEventListener("wnp.engine3d.globaleFloorReady", i, !1), this.avatarPosition = e.clone(), this.camera = [new wnp.Input.OrbitCamera("Camera", -Math.PI / 3, Math.PI / 4, 1500, e.clone(), n.engine3D.scene), new wnp.Input.FirstPersonCamera("FPS", this.avatarPosition, n.engine3D.scene)], this.camera[0].attachControl(n.engine3D.canvas), this.camera[0].inertia = 0, this.camera[0].angularSensibility = 300, this.camera[0].radiusSpeedFactor = .005, this.camera[0].moveSpeedFactor = 5, this.camera[0].fov = .25 * Math.PI, this.camera[0].minZ = 15, this.camera[0].maxZ = 4e4, this.camera[1].minZ = 15, this.camera[1].maxZ = 4e4, this.camera[1].heightMin = 20, this.camera[1].heightMax = 240, this.camera[1].radiusSpeedFactor = .2, this.camera[1].angularSensibility = 400, this.camera[1].height = 170, this.camera[1].fov = 70 / 180 * Math.PI, n.engine3D.scene.activeCamera = this.camera[this.cameraActiveId], n.engine3D.camera = n.engine3D.scene.activeCamera
    };
    return n.prototype = new BaseComponent3D, n.prototype.startListening = function() {
        this.onCameraChanged = this.onCameraChanged.bind(this), this.onFloorLevelChanged = this.onFloorLevelChanged.bind(this), this.onControleEnd = this.onControleEnd.bind(this), this.onControleMove = this.onControleMove.bind(this), this.onNewPlanReady = this.onNewPlanReady.bind(this), this.onGlobaleFloorReady = this.onGlobaleFloorReady.bind(this), document.addEventListener("wnp.request.cameraChanged", this.onCameraChanged, !1), document.addEventListener("wnp.request.floorSelected", this.onFloorLevelChanged, !1), document.addEventListener("mousemove", this.onMouseMove, !1), document.addEventListener("mousewheel", this.onMouseZoom, !1), document.addEventListener("wnp.engine3d.dragcontrols.end", this.onControleEnd, !1), document.addEventListener("wnp.engine3d.dragcontrols.move", this.onControleMove, !1), document.addEventListener("wnp.request.newPlanReady", this.onNewPlanReady, !1), document.addEventListener("wnp.engine3d.globaleFloorReady", this.onGlobaleFloorReady, !1), wanaplan.engine3D.pointerManager.touchManager.on("swipe", this.onMouseZoom)
    }, n.prototype.stopListening = function() {
        document.removeEventListener("wnp.request.cameraChanged", this.onCameraChanged, !1), document.removeEventListener("wnp.request.floorSelected", this.onFloorLevelChanged, !1), document.removeEventListener("wnp.request.newPlanReady", this.onNewPlanReady, !1), document.removeEventListener("mousemove", this.onMouseMove), document.removeEventListener("mousewheel", this.onMouseZoom), document.removeEventListener("wnp.engine3d.dragcontrols.end", this.onControleEnd), document.removeEventListener("wnp.engine3d.dragcontrols.move", this.onControleMove), document.removeEventListener("wnp.engine3d.globaleFloorReady", this.onGlobaleFloorReady), wanaplan.engine3D.pointerManager.touchManager.off("swipe", this.onMouseZoom)
    }, n.prototype.toggleFXAA = function(t) {
        var e = wanaplan.engine3D.scene.activeCamera;
        return "number" == typeof t && (e = wanaplan.engine3D.scene.cameras[t]), e.__fxaa__cookie ? (e.__fxaa__cookie.dispose(), e.__fxaa__cookie = null) : e.__fxaa__cookie = new BABYLON.FxaaPostProcess("fxaa", 1, e), e.__fxaa__cookie ? !0 : !1
    }, n.prototype.toggleFSAA = function(t, e) {
        var e = "number" == typeof e || BABYLON.Texture.BILINEAR_SAMPLINGMODE, n = wanaplan.engine3D.scene.activeCamera;
        return "number" == typeof t && (n = wanaplan.engine3D.scene.cameras[t]), n.__fsaa__cookie ? (n.__fsaa__cookie.dispose(), n.__fsaa__cookie = null) : (n.__fsaa__cookie = new BABYLON.PassPostProcess("fsaa", 2, n), n.__fsaa__cookie.renderTargetSamplingMode = e), n.__fsaa__cookie ? !0 : !1
    }, n.prototype.disableAllPostProcess = function() {
        camera.__fsaa__cookie && (camera.__fsaa__cookie.dispose(), camera.__fsaa__cookie = null), camera.__fxaa__cookie && (camera.__fxaa__cookie.dispose(), camera.__fxaa__cookie = null)
    }, n.prototype.onMouseMove = function() {
    }, n.prototype.onMouseZoom = function() {
        ujs.notify("wnp.engine3D.camera.zoom")
    }, n.prototype.onGlobaleFloorReady = function() {
        var t = this.core.structure.members[this.core.structure.currentStructureIndex].elevation;
        this.camera[0].target.y = t + 170, this.camera[1].height = t + 170, this.camera[1].heightMin = t + 20, this.camera[1].heightMax = t + 240, this.avatarPosition.y = t + 170
    }, n.prototype.onCameraChanged = function() {
        this.cameraActiveId = (this.cameraActiveId + 1) % 2, this.scene.activeCamera = this.camera[this.cameraActiveId], wanaplan.engine3D.camera = this.camera[this.cameraActiveId];
        var t = wanaplan.engine3D.searchComponent("AvatarComponent3D");
        this.cameraActiveId ? (this.camera[1].rotation.copyFromFloats(0, -this.camera[0].alpha - Math.PI / 2, 0), this.camera[1].position.copyFromFloats(t.avatar.position.x, this.camera[1].height, t.avatar.position.z), this.camera[1].attachControl(wanaplan.engine3D.canvas), this.camera[0].detachControl(wanaplan.engine3D.canvas), t && t.setVisibility(!1)) : (this.lookAt && (this.lookAt.position.x = this.camera[1].position.x, this.lookAt.position.z = this.camera[1].position.z), this.camera[0].target.x = this.camera[1].position.x, this.camera[0].target.z = this.camera[1].position.z, this.camera[0].alpha = -this.camera[1].rotation.y - Math.PI / 2, this.camera[0].attachControl(wanaplan.engine3D.canvas), this.camera[1].detachControl(wanaplan.engine3D.canvas), t && t.setVisibility(!0)), ujs.notify("wnp.engine3d.cameraChanged", {activeCameraId: this.cameraActiveId,activeCamera: this.cameraActiveId ? "fpsCamera" : "orbitCamera"})
    }, n.prototype.onFloorLevelChanged = function(e) {
        t.camera[0].target.y = e.structure.elevation + 170, t.camera[1].height = e.structure.elevation + 170, t.camera[1].position.y = e.structure.elevation + 170, t.camera[1].heightMax = e.structure.elevation + 240, t.camera[1].heightMin = e.structure.elevation + 20
    }, n.prototype.onControleEnd = function(e) {
        e.selected && this.lookAt && e.selected.pickedMesh.id == this.lookAt.id && (t.camera[0].target.x = this.lookAt.position.x, t.camera[0].target.z = this.lookAt.position.z)
    }, n.prototype.onControleMove = function(e) {
        !e.selected && this.lookAt && (this.lookAt.position.x = t.camera[0].target.x, this.lookAt.position.z = t.camera[0].target.z)
    }, n.prototype.onNewPlanReady = function() {
        this.structure = this.core.getSelectedStructure(), "undefined" != typeof this.structure.elevation && (t.camera[0].target.y = this.structure.elevation + 170)
    }, n.prototype.getLookAt = function() {
        return this.lookAt
    }, n.prototype.bindLookAt = function(t) {
        this.lookAt = t
    }, n.prototype.getActiveCameraId = function() {
        return this.cameraActiveId
    }, n
}(), GridStructure = function() {
    var t = function() {
        BaseStructure.call(this, "GridStructure"), this.materials = {}
    };
    return t.prototype = new BaseStructure, t.prototype.serialize = function() {
        return this.materials
    }, t.prototype.deserialize = function(t) {
        for (var e in t)
            this.materials[e] = t[e]
    }, t
}(), GridComponent2D = function() {
    var t = function(t) {
        BaseComponent2D.call(this, t, "GridComponent2D"), this.priority = 1, this.displayGrid = !0
    };
    return t.prototype = new BaseComponent2D, t.prototype.startListening = function() {
        this.core.engine2D.registerEventCb("GridComponent2D.static-draw", this.priority, "static-draw", null, null, this.onStaticDraw.bind(this), null), this.core.engine2D.registerEventCb("GridComponent2D.drag-start", this.priority, "drag-start", 255 - this.core.engine2D.MODE_CONTEXTMENU, null, this.onDragStart.bind(this), null), this.core.engine2D.registerEventCb("GridComponent2D.zoom-in", this.priority, "zoom-in", 255 - this.core.engine2D.MODE_CONTEXTMENU, null, this.onZoomIn.bind(this), null), this.core.engine2D.registerEventCb("GridComponent2D.zoom-out", this.priority, "zoom-out", 255 - this.core.engine2D.MODE_CONTEXTMENU, null, this.onZoomOut.bind(this), null)
    }, t.prototype.stopListening = function() {
        this.core.engine2D.unregisterEventCb("GridComponent2D.static-draw"), this.core.engine2D.unregisterEventCb("GridComponent2D.drag-start"), this.core.engine2D.unregisterEventCb("GridComponent2D.zoom-in"), this.core.engine2D.unregisterEventCb("GridComponent2D.zoom-out")
    }, t.prototype.enableScrolling = function(t) {
        t && !this.scrollingEnabled ? (this.core.engine2D.registerEventCb("GridComponent2D.drag-start", this.priority, "drag-start", 255 - this.core.engine2D.MODE_CONTEXTMENU, null, this.onDragStart.bind(this), null), this.core.engine2D.registerEventCb("GridComponent2D.zoom-in", this.priority, "zoom-in", 255 - this.core.engine2D.MODE_CONTEXTMENU, null, this.onZoomIn.bind(this), null), this.core.engine2D.registerEventCb("GridComponent2D.zoom-out", this.priority, "zoom-out", 255 - this.core.engine2D.MODE_CONTEXTMENU, null, this.onZoomOut.bind(this), null), this.scrollingEnabled = !0) : (this.scrollingEnabled = !1, this.core.engine2D.unregisterEventCb("GridComponent2D.drag-start"), this.core.engine2D.unregisterEventCb("GridComponent2D.zoom-in"), this.core.engine2D.unregisterEventCb("GridComponent2D.zoom-out"))
    }, t.prototype.onStaticDraw = function(t, e, n) {
        if (this.displayGrid) {
            var i = this.core.getWidth(), o = this.core.getHeight(), r = 50 * n, s = Math.floor(e.x % r), a = Math.floor(e.y % r), l = 0, h = 0, c = this.core.configuration.boundingSize, u = this.core.getWidth() / 2 + (this.core.engine2D.getZoom() * Math.abs(c.min.x) - this.core.getWidth() / 2), p = this.core.getHeight() / 2 + (this.core.engine2D.getZoom() * Math.abs(c.min.y) - this.core.getHeight() / 2), d = this.core.getWidth() / 2 - (this.core.engine2D.getZoom() * Math.abs(c.max.x) - this.core.getWidth() / 2), m = this.core.getHeight() / 2 - (this.core.engine2D.getZoom() * Math.abs(c.max.y) - this.core.getHeight() / 2);
            s = e.x >= u ? e.x - u : s, l = e.x >= u ? s : 0, a = e.y >= p ? e.y - p : a, h = e.y >= p ? a : 0, i = e.x < d ? i + e.x - d : i, o = e.y < m ? o + e.y - m : o, t.strokeStyle = "#dddddd", t.lineWidth = 1, t.beginPath();
            for (var g = a; o > g; g += r)
                t.moveTo(l, Math.floor(g) + .5), t.lineTo(i, Math.floor(g) + .5);
            for (var f = s; i > f; f += r)
                t.moveTo(Math.floor(f) + .5, h), t.lineTo(Math.floor(f) + .5, o);
            t.stroke(), t.strokeStyle = "#aaaaaa", t.lineWidth = 3, t.beginPath(), e.x >= u && (t.moveTo(Math.floor(s) + .5, h), t.lineTo(Math.floor(s) + .5, o)), e.x <= d && (t.moveTo(Math.floor(i) + .5, h), t.lineTo(Math.floor(i) + .5, o)), e.y >= p && (t.moveTo(l, Math.floor(a) + .5), t.lineTo(i, Math.floor(a) + .5)), e.y <= m && (t.moveTo(l, Math.floor(o) + .5), t.lineTo(i, Math.floor(o) + .5)), t.stroke(), t.fillStyle = "#770000", t.fillRect(e.x - 5, e.y - 5, 11, 11);
            var y = 100, _ = "1m";
            n > 2.5 && (y = 50, _ = "0.5m"), t.strokeStyle = "#999999", t.beginPath(), t.lineWidth = 3, t.moveTo(20, o - 30.5), t.lineTo(Math.floor(20 + y * n), o - 30.5), t.stroke(), t.lineWidth = 2, t.moveTo(20, o - 29), t.lineTo(20, o - 35), t.moveTo(Math.floor(20 + y * n), o - 29), t.lineTo(Math.floor(20 + y * n), o - 35), t.stroke(), t.fillStyle = "#777777", t.font = "10px Verdana", t.textAlign = "center", t.fillText(_, y / 2 * n + 20, o - 15)
        }
    }, t.prototype.onDragStart = function() {
        this.core.engine2D.registerEventCb("GridComponent2D.dragging", this.priority, "dragging", this.core.engine2D.MODE_DRAG, null, this.onDragging.bind(this), null), this.core.engine2D.registerEventCb("GridComponent2D.drag-end", this.priority, "drag-end", this.core.engine2D.MODE_DRAG, null, this.onDragEnd.bind(this), null)
    }, t.prototype.onDragging = function(t, e, n) {
        var i = this.core.engine2D.getTranslation();
        i = i.add(new BABYLON.Vector2(n.posDelta.x, n.posDelta.y)), this.core.engine2D.setTranslation(i)
    }, t.prototype.onDragEnd = function() {
        this.core.engine2D.unregisterEventCb("GridComponent2D.dragging"), this.core.engine2D.unregisterEventCb("GridComponent2D.drag-end")
    }, t.prototype.onZoomIn = function(t, e, n) {
        var i = this.core.engine2D.getZoom();
        if (this.core.engine2D.setZoom(1.05 * i), this.core.engine2D.getZoom() != i) {
            var o = this.core.engine2D.getTranslation(), r = n.pos.clone().subtractInPlace(o);
            r.scaleInPlace(.05), this.core.engine2D.setTranslation(o.subtractInPlace(r))
        }
    }, t.prototype.onZoomOut = function(t, e, n) {
        var i = this.core.engine2D.getZoom();
        this.core.engine2D.setZoom(.95 * i);
        i - this.core.engine2D.getZoom();
        if (this.core.engine2D.getZoom() != i) {
            var o = this.core.engine2D.getTranslation(), r = n.pos.clone().subtractInPlace(o);
            r.scaleInPlace(.05), this.core.engine2D.setTranslation(o.add(r))
        }
    }, t
}(), GridBackgroundComponent2D = function() {
    var t = function(t) {
        BaseComponent2D.call(this, t, "GridBackgroundComponent2D"), this.priority = 1e3, this.background = !1, this.visibility = !0, this.scale = 1, this.translation = new BABYLON.Vector3(0, 0, 0)
    };
    return t.prototype = new BaseComponent2D, t.prototype.startListening = function() {
        this.onBackgroundChange = this.onBackgroundChange.bind(this), this.onAddBackground = this.onAddBackground.bind(this), this.onEndBackground = this.onEndBackground.bind(this), document.addEventListener("wnp.engine2d.backgroundChange", this.onBackgroundChange), document.addEventListener("wnp.engine2d.onAddBackground", this.onAddBackground), document.addEventListener("wnp.engine2d.onEndBackground", this.onEndBackground), this.core.engine2D.registerEventCb("GridBackgroundComponent2D.static-draw", this.priority, "static-draw", null, null, this.onStaticDraw.bind(this), null)
    }, t.prototype.stopListening = function() {
        document.removeEventListener("wnp.engine2d.backgroundChange", this.onBackgroundChange), document.removeEventListener("wnp.engine2d.onAddBackground", this.onAddBackground), document.removeEventListener("wnp.engine2d.onEndBackground", this.onEndBackground), this.core.engine2D.unregisterEventCb("GridBackgroundComponent2D.static-draw")
    }, t.prototype.initialize = function() {
        var t = {id: "gridBackgroundMenu",title: _("Add Background"),action: "wnp.engine2d.onAddBackground",cancelAction: "wnp.engine2d.onEndBackground"};
        ujs.notify("wnp.menu.main.add", {item: t,menuPath: "draw2D",position: 0})
    }, t.prototype.onStaticDraw = function(t, e, n) {
        if (this.background && this.visibility === !0) {
            var i = this.background;
            t.save(), t.globalAlpha = .4, t.translate(e.x - this.background.realWidth * n * this.scale / 2 + this.translation.x * n, e.y - this.background.realHeight * n * this.scale / 2 + this.translation.y * n), t.scale(n * this.scale, n * this.scale), t.drawImage(i, 0, 0), t.restore
        }
    }, t.prototype.onBackgroundChange = function(t) {
        this.visibility = t.visibility, this.scale = t.scale, this.background = t.img, this.core.engine2D.requestStaticDraw(), this.translation = t.translation || new BABYLON.Vector3(0, 0, 0), this.core.engine2D.requestStaticDraw(), this.core.structure.params.gridBackground = {scale: t.measure,translation: this.translation.asArray(),points: [t.points[0].asArray(), t.points[1].asArray()]}, ujs.notify("wnp.request.saveHistory", {})
    }, t.prototype.onEndBackground = function() {
        wnp.UI.BackgroundPopup.close(void 0, void 0, !0)
    }, t.prototype.onAddBackground = function() {
        wnp.UI.BackgroundPopup.show()
    }, t
}(), GridComponent3D = function() {
    var t, e = function(e) {
        BaseComponent3D.call(this, e, "GridComponent3D"), this.structure = new GridStructure, t = this, this.setupLights(), this.createGround(), this.createSky(), this.lights = [], document.addEventListener("wnp.core.structure.loaded", this.onStructureLoaded.bind(this), !1)
    };
    return e.prototype = new BaseComponent3D, e.prototype.initialize = function() {
    }, e.prototype.onStructureLoaded = function() {
        var t = {}, e = {};
        this.core.structure.params.grid && (t = this.core.structure.params.grid, this.createGround(t)), this.core.structure.params.sky && (e = this.core.structure.params.sky, this.createSky(e))
    }, e.prototype.startListening = function() {
        document.addEventListener("wnp.engine3D.changeGround", this.onChangeGround, !1), document.addEventListener("wnp.engine3D.changeSky", this.onChangeSky, !1)
    }, e.prototype.stopListening = function() {
        document.removeEventListener("wnp.engine3D.changeGround", this.onChangeGround, !1), document.removeEventListener("wnp.engine3D.changeSky", this.onChangeSky, !1)
    }, e.prototype.createGround = function(e) {
        var e = e || {}, n = (e.name || "ground", e.url || wnp.Assets.globalPath + "js/Components/GridComponent/Images/grid2.jpg"), i = function(e) {
            var n = wanaplan.engine3D.scene.getMeshByName("ground");
            if (!n) {
                var i = t.core.configuration.boundingSize.getSize();
                n = BABYLON.Mesh.CreateBloc("ground", i.x, 1, i.z, wanaplan.engine3D.scene), n.position.copyFromFloats(0, -1, 0), (window.ejecta || GlobalHelper.isMobileDevice()) && (n.position.y = -10), n.isDecorable = !1, n.receiveShadows = !0
            }
            wnp.MaterialFactory.RepeatTextureXY(e, 16, 16), n.material = new BABYLON.StandardMaterial("ground", wanaplan.engine3D.scene), n.material.diffuseTexture = e, n.material.ambientColor = new BABYLON.Color3(.9, .9, .9), n.material.diffuseColor = new BABYLON.Color3(1, 1, 1), n.material.specularColor = new BABYLON.Color3(.01, .01, .01), wanaplan.engine3D.scene.lights.point.excludedMeshes.push(n)
        };
        i(new BABYLON.Texture(n, wanaplan.engine3D.scene))
    }, e.prototype.createSky = function(e) {
        var e = e || {}, n = e.url || wnp.Assets.globalPath + "js/Components/GridComponent/Images/background2.jpg", i = function(e) {
            var n = t.scene.getMeshByName("skysphere");
            n || (n = BABYLON.Mesh.CreateSphere("skysphere", 16, 3e4, wanaplan.engine3D.scene), n.scaling.x *= -1, n.isDecorable = !1), n.material = new BABYLON.StandardMaterial("skysphere", wanaplan.engine3D.scene), n.material.ambientTexture = e, wnp.MaterialFactory.MakeBasicMaterial(n.material), n.material.ambientColor.copyFromFloats(1, 1, 1)
        };
        i(new BABYLON.Texture(n, wanaplan.engine3D.scene))
    }, e.prototype.setupLights = function() {
        wanaplan.engine3D.scene.lights = [];
        var t = new BABYLON.DirectionalLight("Dir0", new BABYLON.Vector3(-1, -2, -1), wanaplan.engine3D.scene);
        t.specular = new BABYLON.Color3(.15, .15, .15), t.diffuse = new BABYLON.Color3(.55, .55, .55), t.intensity = 1, t.position = new BABYLON.Vector3(1e3, 2e3, 1e3);
        var e = new BABYLON.PointLight("Point0", wanaplan.engine3D.camera.position, wanaplan.engine3D.scene);
        e.diffuse = new BABYLON.Color3(.65, .65, .65), e.specular = new BABYLON.Color3(1, 1, 1), e.intensity = .45, wanaplan.engine3D.scene.lights.point = e, wanaplan.engine3D.shadowGenerator = new BABYLON.ShadowGenerator(2048, t), wanaplan.configuration.useShadow ? (wanaplan.engine3D.shadowGenerator.useVarianceShadowMap = !1, wanaplan.engine3D.shadowGenerator.usePoissonSampling = !0, wanaplan.engine3D.shadowGenerator.setDarkness(.8), wanaplan.engine3D.shadowGenerator.setTransparencyShadow(!0)) : wanaplan.engine3D.shadowGenerator.dispose()
    }, e.prototype.reloadConfiguration = function() {
    }, e.prototype.onChangeGround = function(e) {
        t.createGround({name: e.name,url: e.url}), t.core.structure.params.grid = {name: e.name,url: e.url}, ujs.notify("wnp.request.saveHistory")
    }, e.prototype.onChangeSky = function(e) {
        t.createSky({name: e.name,url: e.url}), t.core.structure.params.sky = {name: e.name,url: e.url}, ujs.notify("wnp.request.saveHistory")
    }, e
}(), HistoryEditionComponent = function() {
    var t = 0, e = t, n = function(t) {
        BaseComponent3D.call(this, t, "HistoryEditionComponent"), this.historyComponent3D = null, this.isMainMenuItem = !1, this._items = [{title: _("Undo"),icon: "fa fa-reply",action: "wnp.request.undo",index: 10}, {title: _("Redo"),icon: "fa fa-share",action: "wnp.request.redo",index: 11}, {title: _("Transparency"),id: "transparencyButton",icon: "images/icon-transparency.png",action: "wnp.request.switch-transparency",addClass: "hidden",index: 12}], this.undo = this.undo.bind(this), this.redo = this.redo.bind(this)
    };
    return n.prototype = Object.create(BaseComponent3D.prototype), n.prototype.initialize = function() {
        BaseComponent3D.prototype.initialize.call(this), this.historyComponent3D = wanaplan.getComponentByName("HistoryComponent");
        for (var t = 0, e = this._items.length; e > t; t++)
            ujs.notify("wnp.menu.top.sub.add", {item: this._items[t],menuPath: "."});
        this.switchTransparencyMode = this.switchTransparencyMode.bind(this), document.addEventListener("wnp.request.undo", this.undo, !1), document.addEventListener("wnp.request.redo", this.redo, !1), document.addEventListener("wnp.request.switch-transparency", this.switchTransparencyMode, !1), document.addEventListener("wnp.engine3d.wallTransparency.on", this.onWallTransparencyOn, !1), document.addEventListener("wnp.engine3d.wallTransparency.off", this.onWallTransparencyOff, !1)
    }, n.prototype.destroy = function() {
        console.log("destroy");
        for (var t = 0, e = this._items.length; e > t; t++)
            ujs.notify("wnp.menu.top.sub.delete", {id: this._items[t].id,menuPath: "."});
        document.removeEventListener("wnp.request.undo", this.undo), document.removeEventListener("wnp.request.redo", this.redo), document.removeEventListener("wnp.request.switch-transparency", this.switchTransparencyMode), document.removeEventListener("wnp.engine3d.wallTransparency.on", this.onWallTransparencyOn), document.removeEventListener("wnp.engine3d.wallTransparency.off", this.onWallTransparencyOff)
    }, n.prototype.switchTransparencyMode = function() {
        var n = wanaplan.getComponentByName("WallComponent3D"), i = wanaplan.engine3D.cameraFeatures;
        if (i.setCamera(wanaplan.engine3D.camera), e = (e + 1) % 2, e === t) {
            i && i.stopTransparency();
            for (var o in wanaplan.structure.members)
                n.switchTransparentStatusByStructure(wanaplan.structure.members[o]);
            ujs.notify("wnp.engine3d.wallTransparency.off")
        } else if ("Camera" == i.camera.name) {
            for (var o in wanaplan.structure.members)
                n.switchTransparentStatusByStructure(wanaplan.structure.members[o]);
            i && i.startTransparency(), ujs.notify("wnp.engine3d.wallTransparency.on")
        }
    }, n.prototype.setTransparencyMode = function(t) {
        e != t && this.switchTransparencyMode()
    }, n.prototype.undo = function() {
        wanaplan.getSelectedEngine() == wanaplan.ENGINE_2D ? wanaplan.backFromHistory() : this.historyComponent3D.controlZ()
    }, n.prototype.redo = function() {
        wanaplan.getSelectedEngine() == wanaplan.ENGINE_2D ? wanaplan.nextFromHistory() : this.historyComponent3D.controlY()
    }, n.prototype.onContextChanged = function(t) {
        "3D" == t ? ujs.notify("wnp.menu.top.sub.replace", {item: {id: "transparencyButton",addClass: "",items: wanaplan.structure.lastMaterialsUsed},merge: !0}, !0) : ujs.notify("wnp.menu.top.sub.replace", {item: {id: "transparencyButton",addClass: "hidden",items: wanaplan.structure.lastMaterialsUsed},merge: !0}, !0)
    }, n.prototype.onWallTransparencyOn = function() {
        var t = wanaplan.getComponentByName("TopMenuComponent"), e = t.submenu;
        e.replaceMenuItem("transparencyButton", {icon: "images/icon-opacity.png"}, !0), e.updateHtml()
    }, n.prototype.onWallTransparencyOff = function() {
        var t = wanaplan.getComponentByName("TopMenuComponent"), e = t.submenu;
        e.replaceMenuItem("transparencyButton", {icon: "images/icon-transparency.png"}, !0), e.updateHtml()
    }, n.prototype.onEngineSwitched = function() {
        e !== t && this.switchTransparencyMode()
    }, n
}(), HistoryComponent = function() {
    var t, e = function(e) {
        BaseComponent3D.call(this, e, "HistoryComponent"), t = this, this.componentList = [], this.history = [], this.currentHistoryIndex = -1, this.currentBalance = 0, this.maxHistoryLength = 50, this.callbackMap = []
    };
    e.prototype = new BaseComponent3D, e.prototype.startListening = function() {
        document.addEventListener("wnp.keyboardManager.keyDown", this.onKeyDown, !0), document.addEventListener("wnp.request.historyAction", this.onRotatorAction, !0)
    }, e.prototype.stopListening = function() {
        document.removeEventListener("wnp.keyboardManager.keyDown", this.onKeyDown, !0), document.removeEventListener("wnp.request.historyAction", this.onRotatorAction, !0)
    }, e.prototype.onContextChanged = function(t) {
        "3D" == t ? this.startListening() : (this.stopListening(), this.reset())
    };
    var n = function() {
        this.target = null, this.params = null, this.type = 0, this.componentInstance = null
    };
    return n.prototype.set = function(t, e, n, i) {
        this.target = t, this.params = e, this.type = n, this.componentInstance = i
    }, e.prototype.reset = function() {
        this.history.length = 0, this.currentHistoryIndex = -1, this.currentBalance = 0
    }, e.prototype.register = function(t) {
        this.componentList.push(t), this.callbackMap.push([])
    }, e.prototype.registerAction = function(t, e, n, i) {
        -1 == this.componentList.indexOf(i) && this.register(i);
        var o = {};
        this.callbackMap[this.componentList.indexOf(i)][t] = o, o.undo = e, o.redo = n
    }, e.prototype.actionDone = function(t, e, i, o) {
        this.currentHistoryIndex = (this.currentHistoryIndex + 1) % this.maxHistoryLength, this.currentBalance = 0, this.history[this.currentHistoryIndex] || (this.history[this.currentHistoryIndex] = new n), this.history[this.currentHistoryIndex].set(t, e, i, o)
    }, e.prototype.redo = function(t) {
        var e = this.callbackMap[this.componentList.indexOf(t.componentInstance)][t.type].redo;
        e(t.target, t.params)
    }, e.prototype.undo = function(t) {
        var e = this.callbackMap[this.componentList.indexOf(t.componentInstance)][t.type].undo;
        e(t.target, t.params)
    }, e.prototype.controlZ = function() {
        -1 != this.currentHistoryIndex && null != this.history[this.currentHistoryIndex] && (-this.currentBalance >= this.maxHistoryLength || (this.undo(this.history[this.currentHistoryIndex]), this.currentHistoryIndex = (this.currentHistoryIndex + this.maxHistoryLength - 1) % this.maxHistoryLength, this.currentBalance--))
    }, e.prototype.controlY = function() {
        -1 != this.currentHistoryIndex && (this.currentBalance >= 0 || (this.currentHistoryIndex = (this.currentHistoryIndex + 1) % this.maxHistoryLength, this.redo(this.history[this.currentHistoryIndex]), this.currentBalance++))
    }, e.prototype.onKeyDown = function(e) {
        var n = t.core.engine3D.keyboardManager.isPressed([17, 91, 224]);
        n && 90 == e.keyCode ? t.controlZ() : n && 89 == e.keyCode && t.controlY()
    }, e.prototype.onRotatorAction = function(t) {
        t.component.addHistory && t.component.addHistory(t.object, t.params, t.action)
    }, e
}(), PrintComponent2D = function() {
    var t, e = function(e) {
        BaseTopMenuComponent2D.call(this, e, "PrintComponent2D"), this.isMainMenuItem = !1, this._item = {title: _("Print"),icon: "fa fa-print",action: "wnp.request.print",id: "print-icon-component",index: 20}, t = this
    };
    return e.prototype = Object.create(BaseTopMenuComponent2D.prototype), e.prototype.startListening = function() {
        document.addEventListener("wnp.request.print", this.onPrint, !1)
    }, e.prototype.stopListening = function() {
        document.removeEventListener("wnp.request.print", this.onPrint, !1)
    }, e.prototype.onPrint = function() {
        var e = 842, n = 596, i = document.createElement("canvas");
        i.width = e, i.height = n, i.style.width = e + "px", i.style.height = n + "px";
        var o = i.getContext("2d"), r = t.core.engine2D.getBestZoomAttributes(e, n), s = t.core.getComponentByName("WallComponent2D"), a = t.core.getComponentByName("RoomComponent2D"), l = t.core.getComponentByName("OvertureComponent2D"), h = t.core.getComponentByName("StairwayComponent2D"), c = t.core.getComponentByName("HopperComponent2D");
        a.onStaticDraw(o, r.translation, r.zoom, null), s.onStaticDraw(o, r.translation, r.zoom, null), l.onStaticDraw(o, r.translation, r.zoom, null), h.onStaticDraw(o, r.translation, r.zoom, null), c.onStaticDraw(o, r.translation, r.zoom, null);
        var u = t.core.getOrigin(), p = new Image, d = t.core.api.logoUrl || u + "/logo.png";
        p.src = "php/retrieveImage.php?image=" + d;
        var m = t.core.structure.name, g = o.measureText(m);
        o.fillText(m, 55 + g.width / 2, 20), p.onload = function() {
            o.drawImage(p, 0, 0, 48, 48)
        }, setTimeout(function() {
            var t, o = i.toDataURL("image/png");
            try {
                t = window.open("", "_blank", "width=" + e + ",height=" + n), t.document.write("<img src='" + o + "' />"), t.document.close(), t.focus(), t.print(), t.close()
            } catch (r) {
                parent.postMessage({type: "printPopup",img: o,w: e,h: n,message: _("you must enable popup for this site")}, u)
            }
        }, 1e3)
    }, e
}(), PrintComponent3D = function() {
    var t = function(t) {
        BaseComponent3D.call(this, t, "PrintComponent3D")
    };
    return t.prototype = Object.create(BaseComponent3D.prototype), t.prototype.startListening = function() {
        document.addEventListener("wnp.request.print", this.onPrint, !1)
    }, t.prototype.stopListening = function() {
        document.removeEventListener("wnp.request.print", this.onPrint, !1)
    }, t.prototype.onPrint = function() {
        var t = 842, e = 596, n = wanaplan.getOrigin();
        GlobalHelper.createScreenshot3D(wanaplan.engine3D.engine, void 0, function(i) {
            var o = i.toDataURL("image/png"), r = setTimeout(function() {
                clearTimeout(r);
                var i;
                try {
                    i = window.open("", "_blank", "width=" + t + ",height=" + e), i.document.write("<img src='" + o + "' />"), i.document.close(), i.focus(), i.print(), i.close()
                } catch (s) {
                    parent.postMessage({type: "printPopup",img: o,w: t,h: e,message: _("you must enable popup for this site")}, n)
                }
            }, 1e3)
        })
    }, t
}(), PerformanceComponent3D = function() {
    var t, e = 10, n = 1e4, i = 5e3, o = "wanadev.planner.performanceCheck", r = [], s = [], a = function(e) {
        BaseComponent3D.call(this, e, "PerformanceComponent3D"), this.waiter = document.getElementById("waiter"), this.waiter.innerHTML = _("Computing, please wait..."), this.waitSince = !1, this.stats = this.core.engine3D.stats, this.priority = 0, this.hasBeenAlreadyNotified = wnpLocalStorage.getItem(o), this.targetMaxLowFPSTime = n, this.hasFocus = !0, document.addEventListener("wnp.engine2D.contextMenuPerformance.close", this.onContextMenuPerformanceClose, !1), document.addEventListener("wnp.request.changePerformancesProperty", this.onContextMenuPropertyChanged, !1), document.addEventListener("wnp.request.changePerformances", this.onChangePerformance, !1), document.addEventListener("wnp.request.changeEngine", this.onChangeEngine, !1), t = this;
        var a = null, l = function(e) {
            null !== a && (clearTimeout(a), a = null), "focus" === e.type ? a = setTimeout(function() {
                clearTimeout(a), a = null, t.hasFocus = !0
            }, i) : t.hasFocus = !1
        };
        r = [{content: [{type: "html",html: "<div class='warning'>" + _("Disable some of these functionnalities") + "<br />" + _("to get better performances in 3D mode.") + "</div>"}, {type: "checkbox",label: _("Antialiasing"),value: t.configuration.useAntialiasing,eventParams: {cast: "bool",property: "useAntialiasing",eventName: "wnp.request.changePerformancesProperty"}}, {type: "checkbox",label: _("Shadows"),value: t.configuration.useShadow,eventParams: {cast: "bool",property: "useShadow",eventName: "wnp.request.changePerformancesProperty"}}, {type: "checkbox",label: _("Enable detailled textures"),value: t.configuration.useMultiTexturing,eventParams: {cast: "bool",property: "useMultiTexturing",eventName: "wnp.request.changePerformancesProperty"}}]}], s = [{label: _("Apply and reload"),action: "wnp.engine2D.contextMenuPerformance.close"}], window.addEventListener("focus", l, !1), window.addEventListener("blur", l, !1)
    };
    return a.prototype = Object.create(BaseComponent3D.prototype), a.prototype.initialize = function() {
        var t = {title: "Increase performances",action: "wnp.request.changePerformances",index: 1};
        ujs.notify("wnp.menu.top.add", {item: t,menuPath: "toolbarOption"})
    }, a.prototype.addItem = function(t) {
        r[0].content.push(t)
    }, a.prototype.removeItem = function(t) {
        var e = "number" == typeof item ? t : r[0].content.indexOf(t);
        return e > -1 && r[0].content.splice(e, 1), e > -1
    }, a.prototype.onChangePerformance = function() {
        ujs.notify("wnp.menu.top.deselect");
        var t = {id: "performancesWindow",title: _("Settings"),x: wanaplan.getWidth() / 2 - 100,y: 100};
        wnp.UI.ContextMenu.show(t, r, s)
    }, a.prototype.onContextMenuPerformanceClose = function() {
        ujs.notify("wnp.engine2D.contextMenu.close"), ujs.notify("wnp.engine3D.refreshGL")
    }, a.prototype.onContextMenuPropertyChanged = function(e) {
        var n = e.property, i = e.value;
        t.core.configuration.hasOwnProperty(n) && (t.core.configuration[n] = i, t.core.configuration.saveConfiguration())
    }, a.prototype.onChangeEngine = function() {
        t.waiter.classList.remove("hidden"), t.core.getSelectedEngine() == t.core.ENGINE_2D && setTimeout(function() {
            t.waiter.classList.add("hidden")
        }, 1e3)
    }, a.prototype.onContextChanged = function(t) {
        "2D" === t && this.waiter.classList.add("hidden")
    }, a.prototype.update = function() {
        this.checkPerf()
    }, a.prototype.checkPerf = function() {
        if (this.hasFocus) {
            var t = BABYLON.Tools.GetFps();
            if (e > t) {
                var i = (new Date).getTime();
                if (this.waitSince === !1)
                    this.waitSince = i;
                else if (i - this.waitSince > n && !this.hasBeenAlreadyNotified) {
                    var r = wanaplan.engine2D.searchComponent("PedagoComponent");
                    this.hasBeenAlreadyNotified = !0, wnpLocalStorage.setItem(o, !0), wnp.UI.IFrame.show(document.body, {width: 720,height: 240,src: r.getPageURL("graphics")})
                }
                this.waiter.classList.remove("hidden")
            } else
                this.waitSince = !1, this.waiter.classList.add("hidden")
        }
    }, a
}(), HardwareScalingComponent3D = function() {
    var t = function(t) {
        BaseComponent3D.call(this, t, "HardwareScalingComponent3D"), this.hardwareScalingLevel = 1, this.hardwareScaling = 1, this._e3d = wanaplan.engine3D, this._camComponent = null, this._edtComponent = null, this._perfComponent = null, this._performanceItem = {}, this._initialized = !1
    };
    return t.prototype = Object.create(BaseComponent3D.prototype), t.prototype.initialize = function() {
        this._initialized || (this._onResize = this._onResize.bind(this), this.hardwareScalingLevel = wanaplan.configuration.hardwareScalingLevel || 1, this.hardwareScaling = 1 / this.hardwareScalingLevel, this._camComponent = this._e3d.searchComponent("CameraComponent"), this._edtComponent = this._e3d.searchComponent("EditionComponent3D"), this._perfComponent = this._e3d.searchComponent("PerformanceComponent3D"), this.hardwareScalingLevel > 1 && (window.addEventListener("resize", this._onResize, !1), this.setHardwareScalingLevel(this.hardwareScalingLevel)), this._perfComponent && (this._performanceItem = {type: "select",label: _("Quality"),namesValues: [{text: _("Low"),value: 2}, {text: _("Simple"),value: 1.5}, {text: _("Good"),value: 1}],selectedKey: wanaplan.configuration.hardwareScalingLevel,eventParams: {cast: "float",property: "hardwareScalingLevel",eventName: "wnp.request.changePerformancesProperty"}}, this._perfComponent.addItem(this._performanceItem)), this._initialized = !0)
    }, t.prototype.destroy = function() {
        this.setHardwareScalingLevel(1), wanaplan.configuration.hardwareScalingLevel = 1, wanaplan.configuration.saveConfiguration(), this._perfComponent && this._perfComponent.removeItem(this._performanceItem), this._camComponent && this._camComponent.disableAllPostProcess(), this._edtComponent && (this._edtComponent.dragControl.hardwareScaling = 1), window.removeEventListener("resize", this._onResize)
    }, t.prototype.setHardwareScalingLevel = function(t) {
        this.hardwareScaling = 1 / t, this.hardwareScalingLevel = t, this._e3d.engine.setHardwareScalingLevel(t), this._e3d.hardwareScaling = this.hardwareScaling, this._e3d.canvas.width = wanaplan.getWidth() * this.hardwareScaling, this._e3d.canvas.height = wanaplan.getHeight() * this.hardwareScaling, this.hardwareScalingLevel > 2 && this._camComponent && this._camComponent.toggleFSAA(), this._edtComponent && this._edtComponent.dragControl.setHardwareScaling(this.hardwareScaling)
    }, t.prototype._onResize = function() {
        this.hardwareScalingLevel > 1 && this.setHardwareScalingLevel(this.hardwareScalingLevel)
    }, t
}(), RemoteControlComponent3D = function() {
    var t, e, n, i = !1, o = !1, r = function(e) {
        BaseComponent3D.call(this, e, "RemoteControlComponent3D"), t = this
    };
    return r.prototype = new BaseComponent3D, r.prototype.initialize = function() {
        this.createHTML(), document.addEventListener("mouseup", this.onMouseUp, !1), document.addEventListener("mousemove", this.onMouseMove, !1), window.addEventListener("mousewheel", this.onZoomUpdated, !1), document.addEventListener("touchend", this.onMouseUp, !1), document.addEventListener("touchcancel", this.onMouseUp, !1), document.addEventListener("touchmove", this.onMouseMove, !1), document.addEventListener("wnp.request.zoomUpdated", this.onZoomUpdated, !1), document.addEventListener("wnp.contextChanged", this.onZoomUpdated, !1), document.addEventListener("wnp.engine3d.cameraChanged", this.onCameraHasChanged.bind(this), !1), document.addEventListener("wnp.request.changeEngine", this.onCameraHasChanged.bind(this), !1)
    }, r.prototype.listenJoystickEvents = function() {
        this.joystick.addEventListener("mousedown", this.onJoystickMouseDown, !1), this.joystick.addEventListener("touchstart", this.onJoystickMouseDown, !1)
    }, r.prototype.listenCursorEvents = function() {
        this.cursor.addEventListener("mousedown", this.onCursorMouseDown, !1), this.cursor.addEventListener("touchstart", this.onCursorMouseDown, !1)
    }, r.prototype.onZoomUpdated = function() {
        var e = n.height;
        if (wanaplan.getSelectedEngine() == wanaplan.ENGINE_2D) {
            var i = wanaplan.engine2D.getZoom(), o = e * (1 - i);
            o = 0 > o ? 0 : o
        } else {
            var r = wanaplan.engine3D.camera;
            if ("Camera" == r.name)
                var s = r.radius, o = e * (s - r.lowerRadiusLimit) / (r.upperRadiusLimit - r.lowerRadiusLimit);
            else
                var o = e * (r.heightMax - r.height) / (r.heightMax - r.heightMin)
        }
        t.cursor.style.marginTop = o + "px"
    }, r.prototype.onMouseMove = function(e) {
        if (i) {
            var o = e.pageY || e.clientY;
            e.touches && (e.preventDefault(), o = e.touches[0].pageY);
            var r = o - n.top, s = 0;
            if (r > 0 && r < n.height ? s = r : r > 0 && r > n.height ? s = n.height : 0 > r && (s = 0), wanaplan.getSelectedEngine() == wanaplan.ENGINE_2D) {
                {
                    var a = (n.height - s) / n.height;
                    wanaplan.engine2D.getZoom()
                }
                wanaplan.engine2D.setZoom(a)
            } else {
                var a = s / n.height, l = wanaplan.engine3D.camera;
                "Camera" == l.name ? l.radius = l.lowerRadiusLimit + (l.upperRadiusLimit - l.lowerRadiusLimit) * a : (l.height = l.heightMax + (l.heightMin - l.heightMax) * a, l.position.y = l.height), t.cursor.style.marginTop = s + "px"
            }
        }
    }, r.prototype.onJoystickMouseDown = function(n) {
        o = !0, n.touches && n.preventDefault();
        var i = t.joystick.getBoundingClientRect(), r = {x: (n.touches ? n.touches[0].pageX : n.pageX || n.clientX) - i.left,y: (n.touches ? n.touches[0].pageY : n.pageY || n.clientY) - i.top}, s = Math.floor(r.x / i.width * 3), a = Math.floor(r.y / i.height * 3);
        1 == s && 1 == a && ujs.notify("wnp.request.cameraChanged"), e = setInterval(function() {
            t.setTranslation(s, a)
        }, 1)
    }, r.prototype.setTranslation = function(t, e) {
        if (wanaplan.getSelectedEngine() == wanaplan.ENGINE_2D) {
            var n = 10, i = wanaplan.engine2D.getTranslation();
            1 > t && (i.x -= n), t > 1 && (i.x += n), 1 > e && (i.y -= n), e > 1 && (i.y += n), wanaplan.engine2D.setTranslation(i)
        } else {
            var o = wanaplan.engine3D.camera;
            if ("Camera" == o.name) {
                var n = Math.PI / 300;
                1 > t && (o.alpha -= n), t > 1 && (o.alpha += n), 1 > e && (o.beta -= n), e > 1 && (o.beta += n)
            } else {
                var n = o._computeLocalCameraSpeed();
                o._localDirection || (o._localDirection = BABYLON.Vector3.Zero(), o._transformedDirection = BABYLON.Vector3.Zero()), o._localRotation || (o._localRotation = BABYLON.Vector3.Zero(), o._transformedRotation = BABYLON.Vector3.Zero()), 1 > t ? o._localRotation.copyFromFloats(0, -n / 15, 0) : 1 > e ? o._localDirection.copyFromFloats(0, 0, 50 * n) : t > 1 ? o._localRotation.copyFromFloats(0, n / 15, 0) : e > 1 && o._localDirection.copyFromFloats(0, 0, 50 * -n), o.getViewMatrix().invertToRef(o._cameraTransformMatrix), 1 > e || e > 1 ? (BABYLON.Vector3.TransformNormalToRef(o._localDirection, o._cameraTransformMatrix, o._transformedDirection), o.position.addInPlace(o._transformedDirection)) : (BABYLON.Vector3.TransformNormalToRef(o._localRotation, o._cameraTransformMatrix, o._transformedRotation), o.rotation.y += o._transformedRotation.y), o.position.y = o.height
            }
        }
    }, r.prototype.onCursorMouseDown = function() {
        i = !0
    }, r.prototype.onMouseUp = function() {
        i = !1, o && (clearInterval(e), o = !1)
    }, r.prototype.createHTML = function() {
        var e = document.createElement("div");
        e.setAttribute("id", "remoteController"), e.style.width = "50px", e.style.height = "210px", e.style.position = "relative", e.style.backgroundImage = "url('" + wnp.Assets.globalPath + wnp.Assets.remote.bg + "')", this.cursorContainer = document.createElement("div"), this.cursorContainer.setAttribute("style", "width:20px;height:150px;position:absolute;top:57px;left:15px;"), this.cursor = document.createElement("div"), this.cursor.setAttribute("style", "width:20px;height:7px;background:" + wnp.Assets.mainUIColor + ";border-radius:2px;cursor:pointer;border:1px solid " + ("#8AB808" == wnp.Assets.mainUIColor ? "#6E910F" : "#333") + ";margin-top:50px;"), this.listenCursorEvents(), this.cursorContainer.appendChild(this.cursor), e.appendChild(this.cursorContainer), this.cameraButton = document.createElement("div"), this.cameraButton.id = "camera-swap-btn", this.cameraButton.style.width = "18px", this.cameraButton.style.height = "18px", this.cameraButton.style.position = "absolute", this.cameraButton.style.backgroundSize = "cover", this.cameraButton.style.top = "16px", this.cameraButton.style.left = "16px", this.cameraButton.style.borderRadius = "7px", e.appendChild(this.cameraButton), t._setCameraIcon(!1), this.joystick = document.createElement("div"), this.joystick.setAttribute("style", "width:50px;height:50px;cursor:pointer;position:absolute;"), this.listenJoystickEvents(), e.appendChild(this.joystick);
        var i = document.getElementById("remote-controller");
        i || (i = document.createElement("div"), i.style.position = "absolute", i.style.top = "50px", i.style.left = "10px", i.style.height = "300px", i.style.width = "50px", document.getElementById("modalWidgets").appendChild(i)), i.appendChild(e), n = this.cursorContainer.getBoundingClientRect()
    }, r.prototype.destroy = function() {
        window.removeEventListener("mousewheel", this.onZoomUpdated), document.removeEventListener("mouseup", this.onMouseUp), document.removeEventListener("mousemove", this.onMouseMove), document.removeEventListener("touchend", this.onMouseUp), document.removeEventListener("touchcancel", this.onMouseUp), document.removeEventListener("touchmove", this.onMouseMove), document.removeEventListener("wnp.request.zoomUpdated", this.onZoomUpdated), document.removeEventListener("wnp.contextChanged", this.onZoomUpdated);
        var t = document.getElementById("remoteController");
        if (t) {
            var e = t.parentNode;
            e.removeChild(t), e.parentNode.removeChild(e)
        }
    }, r.prototype.onCameraHasChanged = function(t) {
        this._setCameraIcon(t.engine && "2D" == t.engine ? !1 : t.activeCamera)
    }, r.prototype._setCameraIcon = function(t) {
        this.cameraButton.style.display = t === !1 ? "none" : "block";
        var e;
        switch (t) {
            case "fpsCamera":
                e = wnp.Assets.remote.cam;
                break;
            case "orbitCamera":
            default:
                e = wnp.Assets.remote.man
        }
        this.cameraButton.style.backgroundImage = "url('" + wnp.Assets.globalPath + e + "')"
    }, r
}(), MeasureStructure = function() {
    var t = function(t, e, n) {
        this.points = t || [], this.parent = e, this.offsetVector = n
    };
    return t.prototype.center = function() {
        return BABYLON.Vector2.Lerp(this.points[0], this.points[1], .5)
    }, t.prototype.normal = function() {
        return this.offsetVector.clone().normalize()
    }, t.prototype.tryMerge = function(t) {
        var e = function(t, e, n) {
            var i, o = Math.PI / 80, r = 3, s = e.subtract(t), a = n.subtract(e);
            return s.length() < r || a.length() < r ? !1 : (i = Math.abs(s.determinant(a)), o > i)
        }, n = 1, i = function() {
            var e = this.points.length - 1, i = t.points.length - 1;
            if (this.points[e].distanceTo(t.points[0]) < n)
                t.points.shift(), this.points.pop(), this.points = this.points.concat(t.points);
            else if (this.points[0].distanceTo(t.points[0]) < n)
                t.points.reverse(), t.points.pop(), this.points.shift(), this.points = t.points.concat(this.points);
            else if (this.points[e].distanceTo(t.points[i]) < n)
                t.points.reverse(), t.points.shift(), this.points.pop(), this.points = this.points.concat(t.points);
            else {
                if (!(this.points[0].distanceTo(t.points[i]) < n))
                    return !1;
                t.points.pop(), this.points.shift(), this.points = t.points.concat(this.points)
            }
            return !0
        }.bind(this);
        return e(this.points[0], this.points[this.points.length - 1], t.points[0]) && e(this.points[0], this.points[this.points.length - 1], t.points[t.points.length - 1]) && this.parent.height === t.parent.height ? i() : !1
    }, t.mergeMeasures = function(t) {
        for (var e, n = t.length, i = t.length - 1; i >= 0; i--) {
            e = t[i];
            for (var o = 0; n > o; o++)
                o !== i && e.tryMerge(t[o]) && (t.splice(o, 1), n--, i--, o = 0)
        }
    }, t
}(), MeasureComponent = function() {
    var t = [], e = [], n = function() {
    };
    return n.getInternalMeasures = function() {
        return t
    }, n.getExternalMeasures = function() {
        return e
    }, n.getAllMeasures = function() {
        return measures
    }, n.buildFromRooms = function(n, i) {
        n = n, i = i, t.length = 0, e.length = 0;
        for (var o = 0, r = n.length; r > o; o++)
            n[o].panes ? t.push(n[o].panes) : (n.splice(o, 1), o--);
        for (var o = 0, r = i.length; r > o; o++)
            i[o].panes ? e.push(i[o].panes) : (i.splice(o, 1), o--)
    }, n.mergeMeasures = function(t) {
        for (var e, n = t.length, i = t.length - 1; i >= 0; i--) {
            e = t[i];
            for (var o = 0; n > o; o++)
                o !== i && e.tryMerge(t[o]) && (t.splice(o, 1), n--, i--, o = 0)
        }
    }, n.drawTmpWallMesure = function(t, e, n) {
        var i = wanaplan.getComponentByName("WallComponent2D")._tmpWall;
        if (i) {
            var o = new BABYLON.Vector2(i.points[1].position.y - i.points[0].position.y, i.points[0].position.x - i.points[1].position.x).normalize().scaleInPlace(40);
            this._drawMeasureSlice(t, e, n, i.points[0].position.add(o), i.points[1].position.add(o))
        }
    }, n.draw = function(n, i, o) {
        for (var r, s, a = wanaplan.getComponentByName("OvertureComponent2D") && wanaplan.getComponentByName("OvertureComponent2D").overtureDragged, l = new BABYLON.Vector2, h = [], c = t.concat(e), u = 0, p = c.length; p > u; u++) {
            h.push([]);
            for (var d = 0, m = c[u].length; m > d; d++)
                c[u][d].parent.measureDisplayed && (r = [], l.copyFrom(c[u][d].offsetVector).normalize().scaleInPlace(c[u][d].parent.measureDist), r.push(c[u][d].points[0].clone(), c[u][d].points[1].clone()), a && this._addOvertureIntersections(c[u][d].parent, r), s = new MeasureStructure(r, c[u][d].parent, l.clone()), h[u].push(s));
            this.mergeMeasures(h[u])
        }
        for (var u = 0, p = h.length; p > u; u++)
            for (var d = 0, m = h[u].length; m > d; d++)
                for (var g = 0, f = h[u][d].points.length - 1; f > g; g++)
                    this._drawMeasureSlice(n, i, o, h[u][d].points[g].add(h[u][d].offsetVector), h[u][d].points[g + 1].add(h[u][d].offsetVector))
    }, n._drawMeasureSlice = function(t, e, n, i, o) {
        var r = wanaplan.engine2D.toRealCoord(i, e, n), s = wanaplan.engine2D.toRealCoord(o, e, n), a = i.distanceTo(o), l = Math.round(a) / 100;
        return wanaplan.engine2D.symbols2D.drawMeasure(t, r, s, l + "m"), l
    }, n._addOvertureIntersections = function(t, e) {
        for (var n = function(t, n) {
            return t.distanceToSquared(e[0]) - n.distanceToSquared(e[0])
        }, i = 0, o = t.overtures.length; o > i; i++)
            for (var r = t.overtures[i].getPolygon(), s = 0, a = r.length; a > s; s++)
                r[s].isOnSegment(e[0], e[e.length - 1]) && ujs.insertSorted(r[s], n, e)
    }, n
}(), DebugComponent2D = function(t) {
    BaseComponent2D.call(this, t, "DebugComponent2D")
};
DebugComponent2D.prototype = Object.create(BaseComponent2D.prototype), DebugComponent2D.prototype.dumpStructureToFile = function() {
    var t = wanaplan.structure.serialize(), e = new Blob([t], {type: "text/plain;charset=utf-8"});
    saveAs(e, "structure.json")
}, DebugComponent2D.prototype.wallState = function() {
    Logger.message("ETAT DES MURS :");
    var t = this.structure.getCurrentStructure(), e = t.getElements("walls"), n = t.getElements("points");
    for (var i in e) {
        Logger.message("Mur " + i + " :"), Logger.message("	" + e[i].points[0].position.x + "," + e[i].points[0].position.y + " ->" + e[i].points[1].position.x + "," + e[i].points[1].position.y), Logger.message("	Points rattachés : ");
        for (var o in e[i].attachedPoints)
            Logger.message("		Point " + n.indexOf(e[i].attachedPoints[o]) + " : " + e[i].attachedPoints[o].position.x + "," + e[i].attachedPoints[o].position.y)
    }
}, DebugComponent2D.prototype.pointState = function() {
    Logger.message("ETAT DES POINTS :");
    var t = this.structure.getCurrentStructure(), e = t.getElements("points"), n = t.getElements("walls");
    for (var i in e)
        Logger.message("Point " + i + " :"), Logger.message("	" + e[i].position.x + "," + e[i].position.y), Logger.message("	Murs parents : ", n.indexOf(e[i].parents[0]), n.indexOf(e[i].parents[1]))
}, DebugComponent2D.prototype.roomState = function(t) {
    Logger.message("ETAT DES PIECES :");
    for (var e in t.rooms)
        Logger.message("Pièce " + e + " :"), Logger.message("	Aire : " + t.rooms[e].area), t.rooms[e].path.debug()
}, DebugComponent2D.prototype.ints = function(t) {
    Logger.message("Intersections :");
    var e = this.structure.getCurrentStructure(), n = (e.getElements("points"), e.getElements("walls"));
    for (var i in n) {
        Logger.message("Mur " + i + " :");
        for (var o = t._extractWallIntersections(n[i]), r = 0; r < o.a.length; r++)
            Logger.message("	a :" + o.a[r].x + "," + o.a[r].y);
        for (var r = 0; r < o.b.length; r++)
            Logger.message("	b :" + o.b[r].x + "," + o.b[r].y)
    }
};
var DEBUG = DEBUG || !0, wallState = wallState || function() {
    if (DEBUG) {
        var t = PLANNER_DEBUGGER.getComponentByName("DebugComponent2D", 1);
        t.wallState()
    } else
        Logger.message("debug is disabled !")
}, pointState = pointState || function() {
    if (DEBUG) {
        var t = PLANNER_DEBUGGER.getComponentByName("DebugComponent2D", 1);
        t.pointState()
    } else
        Logger.message("debug is disabled !")
}, roomState = roomState || function() {
    if (DEBUG) {
        var t = PLANNER_DEBUGGER.getComponentByName("DebugComponent2D", 1), e = PLANNER_DEBUGGER.getComponentByName("RoomComponent2D");
        t.roomState(e)
    } else
        Logger.message("debug is disabled !")
}, ints = ints || function() {
    if (DEBUG) {
        var t = PLANNER_DEBUGGER.getComponentByName("DebugComponent2D", 1), e = PLANNER_DEBUGGER.getComponentByName("WallComponent2D", 1);
        t.ints(e)
    } else
        Logger.message("debug is disabled !")
}, getWalls = getWalls || function() {
    return DEBUG ? PLANNER_DEBUGGER.getSelectedStructure().getElements("walls") : void Logger.message("debug is disabled !")
}, getPoints = getPoints || function() {
    return DEBUG ? PLANNER_DEBUGGER.getSelectedStructure().getElements("points") : void Logger.message("debug is disabled !")
}, getRooms = getRooms || function() {
    return DEBUG ? PLANNER_DEBUGGER.getSelectedStructure().getElements("rooms") : void Logger.message("debug is disabled !")
}, compareRooms = compareRooms || function() {
    if (DEBUG) {
        for (var t = [], e = 0, n = PLANNER_DEBUGGER.structure.getLength(); n > e; e++) {
            var i = PLANNER_DEBUGGER.structure.getElement(e);
            if (i instanceof FloorStructure && (t.push(i.getElements("rooms")), 2 == t.length))
                break
        }
        var o = PLANNER_DEBUGGER.getComponentByName("RoomComponent2D", 1);
        Logger.message(o.identifyRooms(t[0], t[1]))
    } else
        Logger.message("debug is disabled !")
}, DebugComponent3D = function(t) {
    BaseComponent3D.call(this, t, "DebugComponent3D")
};
DebugComponent3D.prototype = Object.create(BaseComponent3D.prototype), DebugComponent3D.prototype.dumpSceneToFile = function() {
    var t = BABYLON.SceneSerializer.Serialize(wanaplan.engine3D.scene), e = JSON.stringify(t), n = new Blob([e], {type: "text/plain;charset=utf-8"});
    saveAs(n, "scene.babylon")
}, DebugComponent3D.prototype.marks = [], DebugComponent3D.prototype.mark = function(t, e, n, i, o) {
    var i = i || 16755200;
    Logger.message("%c Point marked with this color", "color:" + i);
    var r = new THREE.SphereGeometry(o || 5), s = new THREE.MeshBasicMaterial({color: i}), a = new THREE.Mesh(r, s);
    return this.scene.add(a), this.marks.push(a), a.position.set(t, e, n), wanaplan.engine3D.refreshRenderer(), this.marks.length - 1
}, DebugComponent3D.prototype.marklights = function() {
    Logger.message(this);
    for (var t = 0; t < this.scene.__lights.length; t++) {
        var e = this.scene.__lights[t].position;
        this.mark(e.x, e.y, e.z, 16776960)
    }
    return wanaplan.engine3D.refreshRenderer(), this.scene.__lights
}, DebugComponent3D.prototype.removemark = function(t) {
    return this.scene.remove(this.marks[t]), this.marks.splice(t, 1), t
}, DebugComponent3D.prototype.removemarks = function() {
    for (var t = 0; t < this.marks.length; t++)
        this.scene.remove(this.marks[t]);
    return this.marks = [], "done"
};
var DEBUG = DEBUG || !0;
DebugComponent3D.prototype.concatGeom = function(t) {
    var e = function(t) {
        var e = -1 / 0;
        for (var n in t.faces)
            e = Math.max(e, t.faces[n].materialIndex);
        return e
    }, n = new THREE.Geometry, i = [], o = new THREE.MeshFaceMaterial(i), r = 0, s = function() {
        for (var s = t.children.length - 1; s >= 0; s--)
            if ("structure" == t.children[s].type)
                for (var a in t.children[s].children)
                    if (t.children[s].children[a] instanceof THREE.Mesh && t.children[s].children[a].structure instanceof WallStructure) {
                        var l = e(t.children[s].children[a].geometry) + 1;
                        THREE.GeometryUtils.merge(n, t.children[s].children[a], r), i = i.concat(t.children[s].children[a].material.materials), r += l, t.remove(t.children[s].children[a])
                    }
        Logger.message(i), o.materials = i;
        var h = new THREE.Mesh(n, o);
        Logger.message(h.material), t.add(h), Logger.message(wanaplan.engine3D.renderer.autoUpdateObjects), wanaplan.engine3D.renderer.autoUpdateObjects = !1
    };
    s()
};
var updateRenderer = function() {
    wanaplan.engine3D.renderer.initWebGLObjects(wanaplan.engine3D.scene)
}, concatgeom = concatgeom || function() {
    var t = wanaplan.getComponentByName("DebugComponent3D");
    return DEBUG ? t.concatGeom(wanaplan.engine3D.scene) : (Logger.warning("debug is disabled !"), !1)
}, mark = mark || function(t, e, n, i, o) {
    var r = wanaplan.getComponentByName("DebugComponent3D");
    return DEBUG ? r.mark(t, e, n, i, o) : (Logger.warning("debug is disabled !"), !1)
}, marklights = marklights || function() {
    var t = wanaplan.getComponentByName("DebugComponent3D");
    return DEBUG ? t.marklights() : (Logger.warning("debug is disabled !"), !1)
}, removemark = removemark || function(t) {
    var e = wanaplan.getComponentByName("DebugComponent3D");
    return DEBUG ? e.removemark(t) : (Logger.warning("debug is disabled !"), !1)
}, removemarks = removemarks || function() {
    var t = wanaplan.getComponentByName("DebugComponent3D");
    return DEBUG ? t.removemarks() : (Logger.warning("debug is disabled !"), !1)
}, drawWalls = drawWalls || function() {
    var t = wanaplan.getComponentByName("WallComponent3D");
    return DEBUG ? t.drawWalls() : (Logger.warning("debug is disabled !"), !1)
}, debugCSG = debugCSG || function() {
    var t = wanaplan.getComponentByName("WallComponent3D");
    return DEBUG ? t.debugCSG() : (Logger.warning("debug is disabled !"), !1)
}, debugSS = debugSS || function() {
    var t = wanaplan.getComponentByName("SubSlopeComponent3D");
    return DEBUG ? t.debug() : (Logger.warning("debug is disabled !"), !1)
}, AnalyticsComponent = function() {
    var t, e = {"wnp.contextChanged": {action: "contextChanged",label: "fromContext",value: "{previousContext}"},"wnp.request.toggleFullscreen": {action: "toggleFullscreen"},"wnp.request.print": {action: "requestPrint"},"wnp.engine2d.onAddBackground": {action: "addBackgroundClick"},"wnp.component.lock": {action: "onLockObject"},"wnp.request.undo": {action: "history",label: "undo"},"wnp.request.redo": {action: "history",label: "redo"},"wnp.request.switch-transparency": {action: "switchTransparency"},"wnp.engine3D.addObject": {action: "addObject"},"wnp.engine3D.addProgrammable": {action: "addObject"},"wnp.engine3D.addGroup": {action: "addObject"},"wnp.request.object.remove": {action: "removeObject"},"wnp.engine3D.info": {action: "infoObject"},"wnp.contextMenu.propertyChanged": {action: "objectParamsModified",label: "{property}",value: "{value}"},"wnp.menu.click": {action: "menuClicked",label: "{title}"},"wnp.engine3D.decorate": {action: "decorate"}}, n = function(e) {
        BaseComponent2D.call(this, e, "AnalyticsComponent"), t = this
    };
    return n.prototype = Object.create(BaseComponent2D.prototype), n.prototype.initialize = function() {
        for (var i in e)
            !function(e, i) {
                var o = e.split(".").join("_");
                n.prototype[o] = function(e) {
                    var n = wanaplan.getSelectedEngine() == wanaplan.ENGINE_2D ? "2D" : "3D", o = t.cleanValue(i.action, e), r = t.cleanValue(i.label, e), s = t.cleanValue(i.value, e);
                }, document.addEventListener(e, n.prototype[o])
            }(i, e[i])
    }, n.prototype.cleanValue = function(t, e) {
        if (!t)
            return null;
        var e = e || {};
        if (-1 == t.toString().indexOf("{"))
            return t;
        var n = t.replace("{", "").replace("}", ""), t = ujs.getProperty(e, n);
        return t ? t : null
    }, n
}(), GroupConfiguratorModComponent3D = function() {
    var t = function(t) {
        BaseComponent3D.call(this, t, "GroupConfiguratorModComponent3D"), this.edcmp = wanaplan.getComponentByName("EditionComponent3D")
    };
    return t.prototype = new BaseComponent3D, t.prototype.initialize = function() {
        this._state = "idle", this._currentObject = null
    }, t.prototype.getState = function() {
        return this._state
    }, t.prototype.getCurrentObject = function() {
        return this._currentObject
    }, t.prototype.lockUnrelatedActions = function() {
        this.edcmp.lock(this, 14);
        for (var t = this.edcmp.widgets.length; t--; )
            this.edcmp.widgets[t].removeInfo && this.edcmp.widgets[t].removeInfo();
        return !0
    }, t.prototype.unlockUnrelatedActions = function() {
        if (this.edcmp.unlock(this, 14), this.edcmp.getSelectedObject())
            for (var t = this.edcmp.widgets.length; t--; )
                this.edcmp.widgets[t].addInfo && this.edcmp.widgets[t].addInfo();
        return !0
    }, t.prototype.requestStart = function() {
        return "ready" == this.getState() ? !1 : this.getCurrentObject() ? (this.lockUnrelatedActions(), this._state = "ready", void ujs.notify("wnp.engine3d.groupConfigurator.start")) : !1
    }, t.prototype.requestStop = function() {
        return "idle" == this.getState() ? !1 : (this._state = "idle", ujs.notify("wnp.engine3d.groupConfigurator.stop"), void this.unlockUnrelatedActions())
    }, t.prototype.startListening = function() {
        this.initBindForThisInstance(), this.stopListening(), document.addEventListener("wnp.request.groupConfigurator.start", this.myBind.onRequestStart), document.addEventListener("wnp.request.groupConfigurator.stop", this.myBind.onRequestStop), document.addEventListener("wnp.request.groupConfigurator.cancel", this.myBind.onRequestCancel), document.addEventListener("wnp.engine3D.object.remove", this.myBind.onDisposeObject, !1), document.addEventListener("wnp.engine3D.object.dispose", this.myBind.onDisposeObject, !1), document.addEventListener("wnp.engine3d.globaleFloorReady", this.myBind.onFloorChanged, !1), document.addEventListener("wnp.contextChanged ", this.myBind.onSwapEngine)
    }, t.prototype.stopListening = function() {
        this.initBindForThisInstance(), document.removeEventListener("wnp.request.groupConfigurator.start", this.myBind.onRequestStart), document.removeEventListener("wnp.request.groupConfigurator.stop", this.myBind.onRequestStop), document.removeEventListener("wnp.request.groupConfigurator.cancel", this.myBind.onRequestCancel), document.removeEventListener("wnp.engine3D.object.remove", this.myBind.onDisposeObject, !1), document.removeEventListener("wnp.engine3D.object.dispose", this.myBind.onDisposeObject, !1), document.removeEventListener("wnp.engine3d.globaleFloorReady", this.myBind.onFloorChanged, !1), document.removeEventListener("wnp.contextChanged ", this.myBind.onSwapEngine)
    }, t.prototype.initBindForThisInstance = function() {
        if (this.myBind)
            return this;
        var t = this;
        this.myBind = {};
        for (var e in this.handlers)
            (function() {
                var n = t.handlers[e];
                t.myBind[e] = function(e) {
                    n.call(t, e)
                }
            })();
        return this
    }, t.prototype.handlers = {onRequestStart: function(t) {
            this._currentObject = t.object || t.furniture || this.edcmp.getSelectedObject(), this.edcmp.isGroup(this._currentObject) || (this._currentObject = null), this.requestStart()
        },onRequestStop: function() {
            this.requestStop()
        },onRequestCancel: function() {
            this.cancel()
        },onSwapEngine: function(t) {
            "2D" == t.engine && ujs.notify("wnp.request.groupConfigurator.cancel")
        },onFloorChanged: function() {
        },onDisposeObject: function() {
        }}, t
}(), GroupConfiguratorPanelComponent3D = function() {
    var t = function(t) {
        BaseComponent3D.call(this, t, "GroupConfiguratorPanelComponent3D"), this.confm = wanaplan.getComponentByName("ConfiguratorModComponent3D"), this.hec = wanaplan.getComponentByName("HistoryEditionComponent"), this.edcmp = wanaplan.getComponentByName("EditionComponent3D"), this.camF = wanaplan.engine3D.cameraFeatures
    };
    t.prototype = new BaseComponent3D, t.prototype.initialize = function() {
        this._options || this.setOptions()
    };
    var e = {};
    return t.prototype.setOptions = function(t) {
        this._options = this._options || {}, t = t || {};
        for (var n in e)
            this._options[n] = "undefined" == typeof t[n] ? e[n] : t[n];
        return this
    }, t.prototype.stopListening = function() {
        this.initBindForThisInstance(), document.removeEventListener("wnp.engine3d.groupConfigurator.start", this.myBind.onEditionStart, !1), document.removeEventListener("wnp.engine3d.groupConfigurator.stop", this.myBind.onEditionStop, !1), document.removeEventListener("wnp.widget.contextMenu.FurnitureEditorForGroup.closed", this.myBind.onEditBoxClosed, !1)
    }, t.prototype.startListening = function() {
        this.stopListening(), document.addEventListener("wnp.engine3d.groupConfigurator.start", this.myBind.onEditionStart, !1), document.addEventListener("wnp.engine3d.groupConfigurator.stop", this.myBind.onEditionStop, !1), document.addEventListener("wnp.widget.contextMenu.FurnitureEditorForGroup.closed", this.myBind.onEditBoxClosed, !1)
    }, t.prototype.initBindForThisInstance = function() {
        if (this.myBind)
            return this;
        var t = this;
        this.myBind = {};
        for (var e in this.handlers)
            (function() {
                var n = t.handlers[e];
                t.myBind[e] = function(e) {
                    n.call(t, e)
                }
            })();
        return this
    }, t.prototype.closeEditBox = function() {
        wnp.UI.ContextMenu.close()
    }, t.prototype.openEditBox = function(t) {
        if (t) {
            this._enabled = !0;
            var e = [{label: _("Remove"),action: "wnp.request.object.remove","class": "remove"}, {label: _("Duplicate"),action: "wnp.request.object.clone"}, {label: _("Submit"),action: "wnp.widget.contextMenu.FurnitureEditorForGroup.closed"}];
            wanaplan.isPublisher() && e.push({label: _("Add to products"),action: "wnp.request.object.addToProducts"});
            var n = [{content: [{label: _("grouper"),type: "checkbox",value: -1 == t.name.indexOf("group_virtual") ? !0 : !1,eventParams: {eventName: "wnp.engine3D.contextMenu.group"}}]}];
            wnp.UI.ContextMenu.show({menuName: "FurnitureEditorForGroup",title: _("Infos Groupe"),width: 450,maxHeight: 200,height: 200,autoSize: !1}, n, e, !1, {furniture: t})
        }
    }, t.prototype.handlers = {onEditionStart: function() {
            this.openEditBox(this.edcmp.getSelectedObject())
        },onEditionStop: function() {
            this.closeEditBox()
        },onEditBoxClosed: function() {
            this._enabled = !1, ujs.notify("wnp.request.groupConfigurator.stop")
        }}, t
}(), ConfiguratorModComponent3D = function() {
    var t = function(t) {
        BaseComponent3D.call(this, t, "ConfiguratorModComponent3D"), this.edcmp = wanaplan.getComponentByName("EditionComponent3D")
    };
    return t.prototype = new BaseComponent3D, t.prototype.startListening = function() {
        this.initBindForThisInstance(), this.stopListening(), document.addEventListener("wnp.request.configurator.start", this.myBind.onRequestStart), document.addEventListener("wnp.request.configurator.stop", this.myBind.onRequestStop), document.addEventListener("wnp.request.configurator.cancel", this.myBind.onRequestCancel), document.addEventListener("wnp.engine3d.configurator.animationIn.end", this.myBind.onAnimationInEnd), document.addEventListener("wnp.engine3d.configurator.animationOut.end", this.myBind.onAnimationOutEnd), document.addEventListener("wnp.engine3d.configurator.animationIn.begin", this.myBind.onAnimationInStart), document.addEventListener("wnp.engine3d.configurator.animationOut.begin", this.myBind.onAnimationOutStart), document.addEventListener("wnp.engine3D.object.remove", this.myBind.onDisposeObject, !1), document.addEventListener("wnp.engine3D.object.dispose", this.myBind.onDisposeObject, !1), document.addEventListener("wnp.engine3D.object.refresh", this.myBind.onRefreshObject, !1), document.addEventListener("wnp.engine3d.globaleFloorReady", this.myBind.onFloorChanged, !1), document.addEventListener("wnp.contextChanged ", this.myBind.onSwapEngine)
    }, t.prototype.stopListening = function() {
        this.initBindForThisInstance(), document.removeEventListener("wnp.request.configurator.start", this.myBind.onRequestStart), document.removeEventListener("wnp.request.configurator.stop", this.myBind.onRequestStop), document.removeEventListener("wnp.request.configurator.cancel", this.myBind.onRequestCancel), document.removeEventListener("wnp.engine3d.configurator.animationIn.end", this.myBind.onAnimationInEnd), document.removeEventListener("wnp.engine3d.configurator.animationOut.end", this.myBind.onAnimationOutEnd), document.removeEventListener("wnp.engine3d.configurator.animationIn.begin", this.myBind.onAnimationInStart), document.removeEventListener("wnp.engine3d.configurator.animationOut.begin", this.myBind.onAnimationOutStart), document.removeEventListener("wnp.engine3D.object.remove", this.myBind.onDisposeObject, !1), document.removeEventListener("wnp.engine3D.object.dispose", this.myBind.onDisposeObject, !1), document.removeEventListener("wnp.engine3D.object.refresh", this.myBind.onRefreshObject, !1), document.removeEventListener("wnp.engine3d.globaleFloorReady", this.myBind.onFloorChanged, !1), document.removeEventListener("wnp.contextChanged ", this.myBind.onSwapEngine)
    }, t.prototype.initBindForThisInstance = function() {
        if (this.myBind)
            return this;
        var t = this;
        this.myBind = {};
        for (var e in this.handlers)
            (function() {
                var n = t.handlers[e];
                t.myBind[e] = function(e) {
                    n.call(t, e)
                }
            })();
        return this
    }, t.prototype.initialize = function() {
        this._state = "idle", this._currentObject = null
    }, t.prototype.getCurrentObject = function() {
        return this._currentObject
    }, t.prototype.getState = function() {
        return this._state
    }, t.prototype.requestStart = function() {
        return "idle" != this.getState() ? !1 : this.getCurrentObject() ? void (this._animateInandOut() ? ujs.notify("wnp.request.configurator.animationIn.start") : (ujs.notify("wnp.engine3d.configurator.animationIn.begin"), ujs.notify("wnp.engine3d.configurator.animationIn.end"))) : !1
    }, t.prototype.requestStop = function() {
        return "ready" != this.getState() ? !1 : void (this._animateInandOut() ? ujs.notify("wnp.request.configurator.animationOut.start") : (ujs.notify("wnp.engine3d.configurator.animationOut.begin"), ujs.notify("wnp.engine3d.configurator.animationOut.end")))
    }, t.prototype.cancel = function() {
        switch (this._canceling = !0, this._state) {
            case "animationIn":
                ujs.notify(this._animateInandOut() ? "wnp.request.configurator.animation.cancel" : "wnp.engine3d.configurator.animationIn.end"), this._state = "animationOut", ujs.notify("wnp.engine3d.configurator.animationOut.begin"), ujs.notify("wnp.engine3d.configurator.animationOut.end");
                break;
            case "animationOut":
                ujs.notify(this._animateInandOut() ? "wnp.request.configurator.animation.cancel" : "wnp.engine3d.configurator.animationOut.end");
                break;
            case "ready":
                this._state = "animationOut", ujs.notify("wnp.engine3d.configurator.animationOut.begin"), ujs.notify("wnp.engine3d.configurator.animationOut.end");
                break;
            case "idle":
        }
        this._canceling = !1, this._state = "idle"
    }, t.prototype._lockUnrelatedActions = function() {
        return this.edcmp.lock(this, 14), this.edcmp.disableWidget(), !0
    }, t.prototype._unlockUnrelatedActions = function() {
        return this.edcmp.unlock(this, 14), this.edcmp.enableWidget(), this.getCurrentObject() && this.getCurrentObject().parent && this.edcmp.isGroup(this.getCurrentObject().parent) && this.edcmp.selectObject(this.getCurrentObject().parent), !0
    }, t.prototype._animateInandOut = function() {
        return !!wanaplan.getComponentByName("ConfiguratorInOutAnimationComponent3D")
    }, t.prototype.handlers = {onAnimationInStart: function() {
            this._lockUnrelatedActions(), this._state = "animationIn"
        },onAnimationInEnd: function() {
            this._state = "ready", this._canceling || ujs.notify("wnp.engine3d.configurator.start", {furniture: this.getCurrentObject()})
        },onAnimationOutStart: function() {
            this._state = "animationOut", this._unlockUnrelatedActions(), ujs.notify("wnp.engine3d.configurator.stop")
        },onAnimationOutEnd: function() {
            this._state = "idle", this._unlockUnrelatedActions()
        },onRequestStart: function(t) {
            this._currentObject = t.object || t.furniture || this.edcmp.getSelectedObject(), this.edcmp.isGroup(this._currentObject) && (this._currentObject = null), this.requestStart()
        },onRequestStop: function() {
            this.requestStop()
        },onRequestCancel: function() {
            this.cancel()
        },onSwapEngine: function(t) {
            "2D" == t.engine && ujs.notify("wnp.request.configurator.cancel")
        },onFloorChanged: function() {
        },onDisposeObject: function(t) {
            "idle" != this.getState() && t.object == this._currentObject && ujs.notify("wnp.request.configurator.cancel")
        },onRefreshObject: function() {
            "idle" != this.getState() && this.getCurrentObject() == event.object && this._lockUnrelatedActions()
        }}, t
}(), ConfiguratorPanelComponent3D = function() {
    var t = function(t) {
        BaseComponent3D.call(this, t, "ConfiguratorPanelComponent3D"), this.confm = wanaplan.getComponentByName("ConfiguratorModComponent3D"), this.hec = wanaplan.getComponentByName("HistoryEditionComponent"), this.edcmp = wanaplan.getComponentByName("EditionComponent3D"), this.camF = wanaplan.engine3D.cameraFeatures
    };
    t.prototype = new BaseComponent3D, t.prototype.initialize = function() {
        this._options || this.setOptions()
    };
    var e = {};
    t.prototype.setOptions = function(t) {
        this._options = this._options || {}, t = t || {};
        for (var n in e)
            this._options[n] = "undefined" == typeof t[n] ? e[n] : t[n];
        return this
    }, t.prototype.stopListening = function() {
        this.initBindForThisInstance(), document.removeEventListener("wnp.engine3d.configurator.start", this.myBind.onEditionStart, !1), document.removeEventListener("wnp.engine3d.configurator.stop", this.myBind.onEditionStop, !1), document.removeEventListener("wnp.engine3D.object.refresh", this.myBind.onRefresh, !1), document.removeEventListener("wnp.engine3D.object.rotate", this.myBind.onRefresh, !1), document.removeEventListener("wnp.engine3D.object.translate", this.myBind.onRefresh, !1), document.removeEventListener("wnp.contextMenu.transformChanged", this.myBind.onTransformPropertyChanged, !1), document.removeEventListener("wnp.contextMenu.propertyChanged", this.myBind.onParamPropertyChanged, !1), document.removeEventListener("wnp.widget.contextMenu.FurnitureEditor.closed", this.myBind.onEditBoxClosed, !1)
    }, t.prototype.startListening = function() {
        this.stopListening(), document.addEventListener("wnp.engine3d.configurator.start", this.myBind.onEditionStart, !1), document.addEventListener("wnp.engine3d.configurator.stop", this.myBind.onEditionStop, !1), document.addEventListener("wnp.contextMenu.transformChanged", this.myBind.onTransformPropertyChanged, !1), document.addEventListener("wnp.contextMenu.propertyChanged", this.myBind.onParamPropertyChanged, !1), document.addEventListener("wnp.widget.contextMenu.FurnitureEditor.closed", this.myBind.onEditBoxClosed, !1)
    }, t.prototype.initBindForThisInstance = function() {
        if (this.myBind)
            return this;
        var t = this;
        this.myBind = {};
        for (var e in this.handlers)
            (function() {
                var n = t.handlers[e];
                t.myBind[e] = function(e) {
                    n.call(t, e)
                }
            })();
        return this
    }, t.prototype.closeEditBox = function() {
        wnp.UI.ContextMenu.close(), document.removeEventListener("wnp.engine3D.object.refresh", this.myBind.onRefresh, !1), document.removeEventListener("wnp.engine3D.object.rotate", this.myBind.onRefresh, !1), document.removeEventListener("wnp.engine3D.object.translate", this.myBind.onRefresh, !1)
    }, t.prototype.openEditBox = function(t) {
        if (t) {
            this._enabled = !0;
            var e = [{label: _("Remove"),action: "wnp.request.object.remove","class": "remove"}, {label: _("Duplicate"),action: "wnp.request.object.clone"}, {label: _("Submit"),action: "wnp.widget.contextMenu.FurnitureEditor.closed"}];
            wanaplan.isPublisher() && e.push({label: _("Add to products"),action: "wnp.request.object.addToProducts"});
            var n = t.structure, i = n.getAvailableProperties(), o = [{title: _("Settings"),content: i}, {title: _("Position & Rotation"),content: this._getPositionAndRotationMenu(n)}];
            wnp.UI.ContextMenu.show({menuName: "FurnitureEditor",title: _("Product infos"),width: 500,maxHeight: window.innerHeight - 140,height: window.innerHeight - 140,autoSize: !1,x: window.innerWidth - 400,id: "configuratorWindow"}, o, e, !1, {furniture: t}), document.addEventListener("wnp.engine3D.object.refresh", this.myBind.onRefresh, !1), document.addEventListener("wnp.engine3D.object.rotate", this.myBind.onRefresh, !1), document.addEventListener("wnp.engine3D.object.translate", this.myBind.onRefresh, !1)
        }
    }, t.prototype.refreshEditBox = function(t) {
        if (t && this._enabled) {
            var e = t.structure, n = e.getAvailableProperties(), i = [{title: _("Settings"),content: n}, {title: _("Position & Rotation"),content: this._getPositionAndRotationMenu(e)}];
            wnp.UI.ContextMenu.update(i)
        }
    }, t.prototype._setTransformProperty = function(t, e, n) {
        if (!t)
            return !1;
        var i = e.indexOf("rotation") >= 0;
        i && (n = n / 180 * Math.PI);
        var o = t.rotation.clone(), r = t.position.clone();
        ujs.setProperty(t, e, +n), ujs.notify("wnp.request.historyAction", {component: this.edcmp,object: t,params: {oldPosition: r,newPosition: t.position.clone(),oldRotation: o,newRotation: t.rotation.clone()},action: i ? this.edcmp.ROTATEACTION : this.edcmp.MOVEACTION}), t.computeWorldMatrix(!0), t.parent.markAsDirty(), ujs.notify(i ? "wnp.engine3D.object.translate" : "wnp.engine3D.object.rotate", {object: t})
    }, t.prototype._setParamProperty = function(t, e, n) {
        if (!t)
            return !1;
        var i = t.structure.programmableInstance;
        n = i.validateParam(e, n), ("undefined" == typeof n || null === n) && (n = ujs.getProperty(i, e));
        var o = {};
        o["programmableInstance." + e] = {newValue: n,exValue: ujs.getProperty(i, e)}, ujs.setProperty(i, e, n), this.edcmp.refreshObject(t, {modifiedProperties: o}), ujs.notify("wnp.request.saveHistory")
    }, t.prototype._saveFrameState = function() {
        for (var t = wnp.UI.ContextMenu.getPosition() || {x: 100,y: 100}, e = document.querySelectorAll(".advancedParams"), n = !(!e.length || e[0].classList.contains("hidden")), o = document.querySelectorAll(".window .tabbed-tabcontent"), r = [], s = o.length; s--; )
            r[s] = i(o[s]);
        this._frameSavedState = {advancedVisible: n,x: t.x,y: t.y,scroll: r}
    }, t.prototype._restoreFrameState = function() {
        if (this._frameSavedState) {
            this._frameSavedState.advancedVisible && wnp.Programmable.toggleVisible(), wnp.UI.ContextMenu.setPosition(this._frameSavedState.x, this._frameSavedState.y);
            for (var t = document.querySelectorAll(".window .tabbed-tabcontent"), e = t.length; e--; )
                n(t[e], this._frameSavedState.scroll[e].x, this._frameSavedState.scroll[e].y)
        }
    }, t.prototype._getPositionAndRotationMenu = function(t) {
        var e = [], n = function(t) {
            var e = 2 * Math.PI;
            return Math.round((t % e + e) % e / Math.PI * 180)
        };
        return e.push({type: "separator",label: _("rotation")}), e.push({label: _("x (pivotement avant/arriere)"),type: "slider",unit: "°",value: {step: 1,min: 0,max: 360,value: n(t.rotation.x)},eventParams: {eventName: "wnp.contextMenu.transformChanged",property: "rotation.x"},id: "rotation-x"}), e.push({label: _("y (standard rotation)"),type: "slider",unit: "°",value: {step: 1,min: 0,max: 360,value: n(t.rotation.y)},eventParams: {eventName: "wnp.contextMenu.transformChanged",property: "rotation.y"},id: "rotation-y"}), e.push({label: _("z (pivot left/right)"),type: "slider",unit: "°",value: {step: 1,min: 0,max: 360,value: n(t.rotation.z)},eventParams: {eventName: "wnp.contextMenu.transformChanged",property: "rotation.z"},id: "rotation-z"}), e.push({type: "separator",label: _("positioning")}), e.push({label: _("x (left/right)"),type: "number",unit: "cm",value: {step: 10,min: -1e4,max: 1e4,value: Math.round(t.position.x)},eventParams: {eventName: "wnp.contextMenu.transformChanged",property: "position.x"},id: "position-x"}), e.push({label: _("y (elevation)"),type: "number",unit: "cm",value: {step: 10,min: -1e4,max: 1e4,value: Math.round(t.position.y)},eventParams: {eventName: "wnp.contextMenu.transformChanged",property: "position.y"},id: "position-y"}), e.push({label: _("z (forward/backward)"),type: "number",unit: "cm",value: {step: 10,min: -1e4,max: 1e4,value: Math.round(t.position.z)},eventParams: {eventName: "wnp.contextMenu.transformChanged",property: "position.z"},id: "position-z"}), e
    }, t.prototype.handlers = {onEditionStart: function() {
            this.openEditBox(this.confm.getCurrentObject())
        },onEditionStop: function() {
            this.closeEditBox()
        },onRefresh: function(t) {
            "ready" == this.confm.getState() && t.object == this.confm.getCurrentObject() && this.refreshEditBox(this.confm.getCurrentObject())
        },onParamPropertyChanged: function(t) {
            this._setParamProperty(this.confm.getCurrentObject(), t.property, t.value)
        },onTransformPropertyChanged: function(t) {
            this._setTransformProperty(this.confm.getCurrentObject(), t.property, t.value)
        },onEditBoxClosed: function() {
            this._enabled = !1, ujs.notify("wnp.request.configurator.stop")
        }};
    var n = function(t, e, n) {
        if (t.scrollTo)
            return void t.scrollTo(e, n);
        if (null != t.scrollLeft && null != t.scrollTop)
            return t.scrollLeft = e, void (t.scrollTop = n);
        if (null != t.scrollX && null != t.scrollY)
            return t.scrollX = e, void (t.scrollY = n);
        throw "unable to scroll"
    }, i = function(t) {
        if (null != t.scrollLeft && null != t.scrollTop)
            return {x: t.scrollLeft,y: t.scrollTop};
        if (null != t.scrollX && null != t.scrollY)
            return {x: t.scrollX,y: t.scrollY};
        throw "unable to scroll"
    };
    return t
}(), ConfiguratorInOutAnimationComponent3D = function() {
    var t = function(t) {
        BaseComponent3D.call(this, t, "ConfiguratorInOutAnimationComponent3D"), this.confm = wanaplan.getComponentByName("ConfiguratorModComponent3D"), this.camComp = wanaplan.getComponentByName("CameraComponent"), this.avatarComp = wanaplan.getComponentByName("AvatarComponent3D"), this.camF = wanaplan.engine3D.cameraFeatures, this.setOptions({alpha: !1,beta: !0,goBack: !0,velocity: 2})
    };
    t.prototype = Object.create(BaseComponent3D.prototype), t.prototype.initialize = function() {
        this._previous = {cameraState: null,wallTransparency: null,lookAtObject: null,lookAtY: null,controlLock: null}, this._options || this.setOptions()
    };
    var e = {duration: 250,velocity: !1,smooth: "ease",alpha: !0,beta: !0,radius: !0,goBack: !0};
    t.prototype.setOptions = function(t) {
        this._options = this._options || {}, t = t || {};
        for (var n in e)
            this._options[n] = "undefined" == typeof t[n] ? e[n] : t[n];
        return this
    }, t.prototype.replaceCameraTarget = function(t) {
        var e = wanaplan.engine3D.scene.activeCamera, n = this.camF, i = n.computeCameraStateLooking(t, e);
        i = {target: i.target};
        var o = {target: e.target.clone()}, r = this._options.velocity ? this._coputeDelta(o, i) / (.1 * this._options.velocity) : .5 * this._options.duration;
        return n.computeAnimation(e, o, i, {duration: r,name: "cameraAnimation",isACamera: !0,smooth: "ease"})
    }, t.prototype.focusObject = function(t) {
        var e = wanaplan.engine3D.camera, n = this.camF;
        if ("In" != this._currentAnimation && !this._focus) {
            this._previous.cameraState = {target: e.target.clone(),alpha: e.alpha,beta: e.beta,radius: e.radius};
            var i = {target: e.target.clone(),alpha: e.alpha,beta: e.beta,radius: e.radius}, o = n.computeCameraStateLooking(t, e);
            o.alpha = BABYLON.Math.ClosestAngle(o.alpha, i.alpha), o.beta = BABYLON.Math.ClosestAngle(o.beta, i.beta), this.stopCurrentAnimation(), i = this._filterCameraState(i), o = this._filterCameraState(o);
            var r = this._options.velocity ? this._coputeDelta(i, o) / this._options.velocity : this._options.duration;
            this._cancelor = n.computeAnimation(e, i, o, {duration: r,callback: this.myBind.afterAnimation,name: "cameraFocusOn_" + t.name,isACamera: !0,smooth: "ease"}), this._currentAnimation = "In", ujs.notify("wnp.engine3d.configurator.animationIn.begin")
        }
    }, t.prototype.stopCurrentAnimation = function() {
        if (this._cancelor) {
            this._cancelor.cancel(), this._listenBreakEvent(!1);
            var t = this._currentAnimation;
            switch (this._cancelor = null, this._currentAnimation = null, t) {
                case "In":
                case "Out":
                    ujs.notify("wnp.engine3d.configurator.animation" + t + ".end")
            }
        }
    }, t.prototype.cancel = function() {
        this.stopCurrentAnimation()
    }, t.prototype.restoreCameraState = function() {
        var t = wanaplan.engine3D.camera, e = this.camF;
        if ("Out" != this._currentAnimation && this._focus) {
            var n = {target: t.target.clone(),alpha: t.alpha,beta: t.beta,radius: t.radius}, i = this._previous.cameraState;
            i.alpha = BABYLON.Math.ClosestAngle(i.alpha, n.alpha), i.beta = BABYLON.Math.ClosestAngle(i.beta, n.beta), this.stopCurrentAnimation(), n = this._filterCameraState(n), i = this._filterCameraState(i);
            var o = this._options.velocity ? this._coputeDelta(n, i) / this._options.velocity : this._options.duration;
            this._cancelor = e.computeAnimation(t, n, i, {duration: o,callback: this.myBind.afterAnimation,name: "cameraFocusOff",isACamera: !0,smooth: "ease"}), this._currentAnimation = "Out", this._previous.cameraState = !1, ujs.notify("wnp.engine3d.configurator.animationOut.begin"), this._listenBreakEvent(!0)
        }
    }, t.prototype.startListening = function() {
        this.stopListening(), document.addEventListener("wnp.request.configurator.animation.cancel", this.myBind.onRequestCancel), document.addEventListener("wnp.request.configurator.animationIn.start", this.myBind.onRequestAnimationIn), document.addEventListener("wnp.request.configurator.animationOut.start", this.myBind.onRequestAnimationOut), document.addEventListener("wnp.engine3d.configurator.animationIn.begin", this.myBind.onAnimationInStart), document.addEventListener("wnp.engine3d.configurator.animationIn.end", this.myBind.onAnimationInEnd), document.addEventListener("wnp.engine3d.configurator.animationOut.begin", this.myBind.onAnimationOutStart), document.addEventListener("wnp.engine3d.configurator.animationOut.end", this.myBind.onAnimationOutEnd), document.addEventListener("wnp.engine3D.object.refresh", this.myBind.onRefresh), document.addEventListener("wnp.engine3D.object.translate", this.myBind.onRefresh), document.addEventListener("wnp.engine3D.object.rotate", this.myBind.onRefresh), this._listening = !0
    }, t.prototype.stopListening = function() {
        this.initBindForThisInstance(), document.removeEventListener("wnp.request.configurator.animation.cancel", this.myBind.onRequestCancel), document.removeEventListener("wnp.request.configurator.animationIn.start", this.myBind.onRequestAnimationIn), document.removeEventListener("wnp.request.configurator.animationOut.start", this.myBind.onRequestAnimationOut), document.removeEventListener("wnp.engine3d.configurator.animationIn.begin", this.myBind.onAnimationInStart), document.removeEventListener("wnp.engine3d.configurator.animationIn.end", this.myBind.onAnimationInEnd), document.removeEventListener("wnp.engine3d.configurator.animationOut.begin", this.myBind.onAnimationOutStart), document.removeEventListener("wnp.engine3d.configurator.animationOut.end", this.myBind.onAnimationOutEnd), document.removeEventListener("wnp.engine3D.object.refresh", this.myBind.onRefresh), document.removeEventListener("wnp.engine3D.object.translate", this.myBind.onRefresh), document.removeEventListener("wnp.engine3D.object.rotate", this.myBind.onRefresh), this._listening = !1
    }, t.prototype.initBindForThisInstance = function() {
        if (this.myBind)
            return this;
        var t = this;
        this.myBind = {};
        for (var e in this.handlers)
            (function() {
                var n = t.handlers[e];
                t.myBind[e] = function(e) {
                    n.call(t, e)
                }
            })();
        return this
    }, t.prototype.avatarUnbind = function() {
        var t = this.camComp, e = wanaplan.engine3D.camera;
        this._previous.lookAtObject = t.lookAt, this._previous.lookAtY = e.target.y, t.bindLookAt(null)
    }, t.prototype.avatarRebind = function() {
        var t = this.camComp, e = wanaplan.engine3D.camera;
        t.cameraActiveId ? t.camera[0].target.y = this.avatarComp.avatar.position.y + 170 : (e.target.y = this._previous.lookAtY, e.target.y = this.avatarComp.avatar.position.y + 170, t.bindLookAt(this._previous.lookAtObject))
    }, t.prototype._listenBreakEvent = function(t) {
        for (var e = n.length; e--; )
            document.removeEventListener(n[e], this.myBind.onRequestCancel, !1);
        if (t)
            for (var e = n.length; e--; )
                document.addEventListener(n[e], this.myBind.onRequestCancel, !1)
    }, t.prototype._filterCameraState = function(t) {
        var e = {target: t.target};
        for (var n in t)
            switch (n) {
                case "beta":
                case "alpha":
                case "radius":
                    this._options[n] && (e[n] = t[n])
            }
        return e
    }, t.prototype._coputeDelta = function(t, e) {
        var n, i = 0;
        for (var o in t) {
            switch (o) {
                case "beta":
                case "alpha":
                    n = Math.abs(e[o] - t[o]) / Math.PI * 800;
                    break;
                case "radius":
                    n = .6 * Math.abs(e[o] - t[o]);
                    break;
                case "target":
                    n = 1.6 * BABYLON.Vector3.Distance(t[o], e[o])
            }
            n > i && (i = n)
        }
        return i
    }, t.prototype.handlers = {afterAnimation: function() {
            this.stopCurrentAnimation()
        },onAnimationInStart: function() {
            this.avatarUnbind()
        },onAnimationInEnd: function() {
            this._focus = !0
        },onAnimationOutStart: function() {
            this._focus = !1
        },onAnimationOutEnd: function() {
            this.avatarRebind()
        },onRequestAnimationOut: function() {
            this._options.goBack ? this.restoreCameraState() : (ujs.notify("wnp.engine3d.configurator.animationOut.begin"), ujs.notify("wnp.engine3d.configurator.animationOut.end"))
        },onRequestAnimationIn: function() {
            this.confm.getCurrentObject() && this.focusObject(this.confm.getCurrentObject())
        },onRequestCancel: function() {
            this.cancel()
        },onRefresh: function(t) {
            (this._focus || this._currentAnimation) && t.object == this.confm.getCurrentObject() && this.replaceCameraTarget(t.object)
        }};
    var n = ["wnp.engine3D.dragging", "wnp.engine3D.camera.zoom", "wnp.engine3D.click"];
    return t
}(), ConfiguratorXrayComponent3D = function() {
    var t = function(t) {
        BaseComponent3D.call(this, t, "ConfiguratorXrayComponent3D"), this.confm = wanaplan.getComponentByName("ConfiguratorModComponent3D"), this.hec = wanaplan.getComponentByName("HistoryEditionComponent"), this.camF = wanaplan.engine3D.cameraFeatures
    };
    t.prototype = new BaseComponent3D, t.prototype.initialize = function() {
        this._options || this.setOptions(), this._savedMaterials = {}, this._clonedMaterials = {}, e = new BABYLON.StandardMaterial("xrayTransparentDefaultMaterial", this.scene)
    };
    var e, n = function(t, n) {
        t.getTotalVertices() && (t.material || (t.material = e), "undefined" == typeof t.material.alternativeOpacity && (t.material.alternativeOpacity = "undefined" != typeof t.material.alpha ? t.material.alpha : 1), t.material.alpha = n, t.material.transparent = 1 != t.material.alpha)
    }, i = function(t) {
        n(t, 0)
    }, o = function(t) {
        n(t, .1)
    }, r = function(t) {
        t.getTotalVertices() && (t.material.alpha = "undefined" == typeof t.material.alternativeOpacity ? 1 : t.material.alternativeOpacity, t.material.transparent = 1 != t.material.alpha, t.material == e && (t.material = null))
    }, s = {wallTransparency: !0,hideAll: !0,partialTransparency: !0};
    return t.prototype.setOptions = function(t) {
        this._options = this._options || {}, t = t || {};
        for (var e in s)
            this._options[e] = "undefined" == typeof t[e] ? s[e] : t[e];
        return this._setHideStrategy(), this
    }, t.prototype.stopListening = function() {
        this.initBindForThisInstance(), document.removeEventListener("wnp.engine3d.configurator.animationIn.begin", this.myBind.onAnimationInStart, !1), document.removeEventListener("wnp.engine3d.configurator.animationOut.end", this.myBind.onAnimationOutEnd, !1), document.removeEventListener("wnp.engine3D.camera.move", this.myBind.onCameraMove, !1)
    }, t.prototype.startListening = function() {
        this.stopListening(), document.addEventListener("wnp.engine3d.configurator.animationIn.begin", this.myBind.onAnimationInStart, !1), document.addEventListener("wnp.engine3d.configurator.animationOut.end", this.myBind.onAnimationOutEnd, !1)
    }, t.prototype.initBindForThisInstance = function() {
        if (this.myBind)
            return this;
        var t = this;
        this.myBind = {};
        for (var e in this.handlers)
            (function() {
                var n = t.handlers[e];
                t.myBind[e] = function(e) {
                    n.call(t, e)
                }
            })();
        return this
    }, t.prototype.start = function() {
        document.removeEventListener("wnp.engine3D.camera.move", this.myBind.onCameraMove, !1), this._stopSharingMaterial(this.confm.getCurrentObject()), this._flagMeshes(), this._changeOnCameraMove && document.addEventListener("wnp.engine3D.camera.move", this.myBind.onCameraMove, !1), this._options.wallTransparency && this._startWallTransparency()
    }, t.prototype.stop = function() {
        if (document.removeEventListener("wnp.engine3D.camera.move", this.myBind.onCameraMove, !1), this._continueSharingMaterial(this.confm.getCurrentObject()), this._restoreMeshes(), this._options.wallTransparency)
            try {
                this._stopWallTransparency()
            } catch (t) {
                console.warn("TODO  fix wallTransparency when floor have changed")
            }
    }, t.prototype._stopSharingMaterial = function(t) {
        var e, n = this._savedMaterials, i = this._clonedMaterials;
        t.traverse(function(o) {
            o.material && !n[e = t.name + ":" + o.material.id + ":" + o.name] && o.material.clone && (n[e] = o.material, i[e] = o.material = o.material.clone())
        })
    }, t.prototype._continueSharingMaterial = function(t) {
        var e, n = this._savedMaterials, i = this._clonedMaterials;
        t.traverse(function(o) {
            o.material && n[e = t.name + ":" + o.material.id + ":" + o.name] && (i[e] != o.material || (o.material = n[e], o.material.dispose()), i[e] = null, n[e] = null, delete i[e], delete n[e])
        })
    }, t.prototype._flagMeshes = function() {
        var t = this.camera, e = this.confm.getCurrentObject(), n = this._options.partialTransparency ? o : i;
        this._hideStrategyInit || this._hideStrategyInit(e, t);
        for (var s, a = wanaplan.engine3D.scene.meshes, l = a.length; l--; )
            s = a[l], s.name && "Object" == s.name.substr(0, 6) && s != e && s.traverse(this._hideStrategyAccept(s, e, t) ? n : r)
    }, t.prototype._restoreMeshes = function() {
        for (var t, e = this.confm.getCurrentObject(), n = wanaplan.engine3D.scene.meshes, i = n.length; i--; )
            t = n[i], t.name && "Object" == t.name.substr(0, 6) && t != e && t.traverse(r)
    }, t.prototype._startWallTransparency = function() {
        var t = this.hec, e = this.camF;
        this._previousWallTransparency = e.wallTransparency, t.setTransparencyMode(!0)
    }, t.prototype._stopWallTransparency = function() {
        {
            var t = this.hec;
            this.camF
        }
        t.setTransparencyMode(this._previousWallTransparency)
    }, t.prototype._setHideStrategy = function(t) {
        switch ("undefined" == typeof t && (t = "do not hide", this._options.hideAll && (t = "hide all")), t) {
            case "hide all":
                this._hideStrategyInit = function() {
                }, this._hideStrategyAccept = function() {
                    return !0
                }, this._changeOnCameraMove = !1;
                break;
            case "do not hide":
            default:
                this._hideStrategyInit = function() {
                }, this._hideStrategyAccept = function() {
                    return !1
                }, this._changeOnCameraMove = !1
        }
    }, t.prototype.handlers = {onAnimationInStart: function() {
            this.start()
        },onAnimationOutEnd: function() {
            this.stop()
        },onCameraMove: function() {
            this._flagMeshes()
        }}, t
}(), MasterReshaperComponent3D = function() {
    var t = function(t) {
        BaseComponent3D.call(this, t, "MasterReshaperComponent3D"), this.edcmp = wanaplan.getComponentByName("EditionComponent3D"), this.confm = wanaplan.getComponentByName("ConfiguratorModComponent3D"), this._listeners = []
    };
    return t.prototype = new BaseComponent3D, t.prototype.initialize = function() {
    }, t.prototype.startListening = function() {
        this.stopListening(), document.addEventListener("wnp.engine3d.configurator.cancel", this.myBind.onConfiguratorCancel, !1), document.addEventListener("wnp.engine3d.configurator.start", this.myBind.onConfiguratorStart, !1), document.addEventListener("wnp.engine3d.configurator.stop", this.myBind.onConfiguratorStop, !1)
    }, t.prototype.stopListening = function() {
        this.initBindForThisInstance(), document.removeEventListener("wnp.engine3d.configurator.cancel", this.myBind.onConfiguratorCancel, !1), document.removeEventListener("wnp.engine3d.configurator.start", this.myBind.onConfiguratorStart, !1), document.removeEventListener("wnp.engine3d.configurator.stop", this.myBind.onConfiguratorStop, !1), document.removeEventListener("wnp.engine3D.drag-start", this.myBind.onDragStart, !1), document.removeEventListener("wnp.engine3D.drag-end", this.myBind.onDragEnd, !1), document.removeEventListener("wnp.engine3D.dragging", this.myBind.onDragging, !1), document.removeEventListener("wnp.engine3D.mouse-move", this.myBind.onMouseMove, !1), document.removeEventListener("wnp.engine3D.object.refresh", this.myBind.onRefresh, !1), document.removeEventListener("wnp.engine3D.object.translate", this.myBind.onRefresh, !1), document.removeEventListener("wnp.engine3D.object.rotate", this.myBind.onRefresh, !1)
    }, t.prototype.initBindForThisInstance = function() {
        if (this.myBind)
            return this;
        var t = this;
        this.myBind = {};
        for (var e in this.handlers)
            (function() {
                var n = t.handlers[e];
                t.myBind[e] = function(e) {
                    n.call(t, e)
                }
            })();
        return this
    }, t.prototype.notify = function(t, e) {
        var n = this._listeners[t];
        if (n)
            for (var i = 0; i < n.length; i++)
                n[i](e)
    }, t.prototype.on = function(t, e) {
        return this._listeners[t] || (this._listeners[t] = []), this._listeners[t].push(e), this
    }, t.prototype.off = function(t, e) {
        var n = this._listeners[t];
        return n ? (n.indexOf(e) > -1 && n.splice(e, 1), this) : this
    }, t.prototype.requireHand = function(t) {
        return this._currentConfigurator == t ? !0 : (this._currentConfigurator && this._currentConfigurator.cancelHand(), this._currentConfigurator = t, !0)
    }, t.prototype.releaseHand = function(t) {
        this._currentConfigurator == t && (this._currentConfigurator = null, t.cancelHand());
        var e = this.edcmp, n = e.getLocker();
        e.unlock(n, 1), e.lock(n, 2)
    }, t.prototype.start = function(t) {
        this.furniture = t.furniture, this.notify("editionStart", t), document.removeEventListener("wnp.engine3D.drag-start", this.myBind.onDragStart, !1), document.removeEventListener("wnp.engine3D.mouse-move", this.myBind.onMouseMove, !1), document.removeEventListener("wnp.engine3D.object.refresh", this.myBind.onRefresh, !1), document.removeEventListener("wnp.engine3D.object.translate", this.myBind.onDragStart, !1), document.removeEventListener("wnp.engine3D.object.rotate", this.myBind.onMouseMove, !1), document.addEventListener("wnp.engine3D.drag-start", this.myBind.onDragStart, !1), document.addEventListener("wnp.engine3D.mouse-move", this.myBind.onMouseMove, !1), document.addEventListener("wnp.engine3D.object.refresh", this.myBind.onRefresh, !1), document.addEventListener("wnp.engine3D.object.translate", this.myBind.onRefresh, !1), document.addEventListener("wnp.engine3D.object.rotate", this.myBind.onRefresh, !1)
    }, t.prototype.cancel = t.prototype.stop = function(t) {
        this.notify("editionEnd", t), document.removeEventListener("wnp.engine3D.drag-start", this.myBind.onDragStart, !1), document.removeEventListener("wnp.engine3D.drag-end", this.myBind.onDragEnd, !1), document.removeEventListener("wnp.engine3D.dragging", this.myBind.nDragging, !1), document.removeEventListener("wnp.engine3D.mouse-move", this.myBind.onMouseMove, !1), document.removeEventListener("wnp.engine3D.object.refresh", this.myBind.onRefresh, !1), document.removeEventListener("wnp.engine3D.object.translate", this.myBind.onRefresh, !1), document.removeEventListener("wnp.engine3D.object.rotate", this.myBind.onRefresh, !1)
    }, t.prototype.handlers = {onConfiguratorStart: function(t) {
            this.start(t)
        },onConfiguratorStop: function(t) {
            this.stop(t)
        },onConfiguratorCancel: function(t) {
            this.cancel(t)
        },onDragStart: function(t) {
            t.furniture = this.furniture;
            var e = this.furniture;
            if (t.collided = this.scene.pick(t.mstate.pos.x, t.mstate.pos.y, function(t) {
                return t.getTopLevelObject(!0) == e
            }), this.notify("dragStart", t), document.removeEventListener("wnp.engine3D.drag-end", this.myBind.onDragEnd, !1), document.removeEventListener("wnp.engine3D.dragging", this.myBind.onDragging, !1), this.dragging = !1, document.addEventListener("wnp.engine3D.drag-end", this.myBind.onDragEnd, !1), document.addEventListener("wnp.engine3D.dragging", this.myBind.onDragging, !1), this._currentConfigurator) {
                this.dragging = !0;
                var n = this.edcmp;
                n.lock(n.getLocker(), 1)
            }
        },onDragging: function(t) {
            if (this.notify("dragging", t), this._currentConfigurator) {
                this.dragging = !0;
                var e = this.edcmp;
                e.lock(e.getLocker(), 1)
            }
        },onDragEnd: function(t) {
            if (this.notify("dragEnd", t), this.dragging = !1, this._currentConfigurator) {
                var e = this.edcmp, n = e.getLocker();
                e.unlock(n, 1), e.lock(n, 2), document.removeEventListener("wnp.engine3D.drag-end", this.myBind.onDragEnd, !1), document.removeEventListener("wnp.engine3D.dragging", this.myBind.nDragging, !1)
            }
        },onMouseMove: function(t) {
            if (!this.dragging && (this._listeners.leave && this._listeners.leave.length || this._listeners.hover && this._listeners.hover.length)) {
                t.furniture = this.furniture;
                var e = this.furniture;
                t.collided = this.scene.pick(t.mstate.pos.x, t.mstate.pos.y, function(t) {
                    return t.getTopLevelObject(!0) == e
                });
                var n = t.collided && t.collided.pickedMesh;
                !n && this._hover && this.notify("leave", t), n && this.notify("hover", t), this._hover = n
            }
        },onRefresh: function(t) {
            t.object == this.furniture && this.notify("refresh", t)
        }}, t
}(), DimensionReshaperComponent3D = function() {
    var t = function(t) {
        BaseComponent3D.call(this, t, "DimensionReshaperComponent3D"), this._listeners = [], this._options || this.setOptions(), this.setOptions({roundDimension: .25,displayHandleOnResize: !0,keepAnimateHandleOnResize: !0})
    };
    t.prototype = Object.create(BaseComponent3D.prototype), t.prototype.initBindForThisInstance = function() {
        if (this.myBind)
            return this;
        var t = this;
        this.myBind = {};
        for (var e in this.handlers)
            (function() {
                var n = t.handlers[e];
                t.myBind[e] = function(e) {
                    n.call(t, e)
                }
            })();
        return this
    }, t.prototype.initialize = function() {
        var t = wanaplan.getComponentByName("MasterReshaperComponent3D");
        if (!t)
            return console.warn("MasterReshaperComponent3D not found, the configurator " + this.name + " components will be disabled.");
        this.master = t, this._options || this.setOptions();
        var e = wanaplan.getComponentByName("HandlesDisplayerForDimensionReshaperFactoryComponent3D"), n = wanaplan.getComponentByName("BoundingLimitDisplayerForDimensionReshaperFactoryComponent3D"), i = wanaplan.getComponentByName("MesureDisplayerForDimensionReshaperFactoryComponent3D");
        this.displayer = {}, n && (this.displayer.boundingLimit = n.create(this.camera, this.scene, "green")), n && this._options.displayNewBoundingLimit && (this.displayer.boundingLimitNew = n.create(this.camera, this.scene, "yellow")), e && (this.displayer.handles = e.create(this.camera, this.scene)), i && (this.displayer.mesure = i.create(this.camera, this.scene)), this.initBindForThisInstance(), t.on("editionStart", this.myBind.onEditionStart), t.on("editionEnd", this.myBind.onEditionEnd), t.on("dragStart", this.myBind.onDragStart), t.on("dragging", this.myBind.onDragging), t.on("dragEnd", this.myBind.onDragEnd), t.on("refresh", this.myBind.onAfterRefresh), this.displayer.boundingLimit && this._options.displayBoundingLimitOnHover && (t.on("hover", this.myBind.onHover), t.on("leave", this.myBind.onLeave))
    };
    var e = {displayHandleOnResize: !0,keepAnimateHandleOnResize: !1,animateHandleOnHover: !0,displayNewBoundingLimit: !0,displayBoundingLimitOnHover: !0,displayBoundingLimitOnDrag: !0,roundDimension: 1,debug: !1};
    return t.prototype.setOptions = function(t) {
        this._options = this._options || {}, t = t || {};
        for (var n in e)
            this._options[n] = "undefined" == typeof t[n] ? e[n] : t[n];
        return this
    }, t.prototype.askStartResize = function(t, e, n, i) {
        return this._asker && i == this.displayer.handles ? !1 : t && !this._getPropertyName(t, e) ? !1 : this.master.requireHand(this) ? (this._direction = e, this._pickedPoint = n, this._asker = i || this, this.myBind.onDragging(event), !0) : !1
    }, t.prototype.cancelHand = function() {
        this._touchedFace = null, this._direction = null, this._pickedPoint = null, this._asker = null, this.master.releaseHand(this)
    }, t.prototype.computeDimension = function(t, e, n) {
        var i = t.getBoundingBox(), o = i.maximum.subtract(i.minimum);
        o.multiplyInPlace(t.scaling, o);
        var r = i.center.clone(), s = t.getWorldMatrix();
        BABYLON.Vector3.TransformCoordinatesToRef(r, s, r);
        var a = this.rotationToWorld(t), l = new BABYLON.Matrix;
        if (a.toRotationMatrix(l), !e)
            return {position: r,dimension: o,rotationMatrix: l,rotationQuat: a};
        var h = e.scale(.5 * n);
        BABYLON.Vector3.TransformCoordinatesToRef(h, l, h), h.addInPlace(r);
        var c = e.multiply(e);
        return c.scaleInPlace(n), c.addInPlace(o), {position: r,dimension: o,newPosition: h,newDimension: c,rotationMatrix: l,rotationQuat: a}
    }, t.prototype.rotationToWorld = function(t) {
        for (var e = t.getTopLevelObject(), n = new BABYLON.Quaternion(0, 0, 0, 1), i = new BABYLON.Quaternion; t && (BABYLON.Quaternion.RotationYawPitchRollToRef(t.rotation.y, t.rotation.x, t.rotation.z, i), n = i.multiply(n), t != e); )
            t = t.parent;
        return n
    }, t.prototype.getbestAxis = function(t, e, n) {
        n = n || this._direction, e = e || this._pickedPoint || t.position;
        var i = wanaplan.engine3D, o = i.scene.activeCamera, r = o.position.subtract(e), s = this.computeDimension(t).rotationMatrix.clone();
        s.invert(), BABYLON.Vector3.TransformCoordinatesToRef(r, s, r);
        for (var a = r.multiply(r).asArray(), l = n.asArray(), h = null, c = 3; c--; )
            (null === h || a[c] > a[h]) && Math.abs(l[c]) < .7 && (h = c);
        var u = [0, 0, 0];
        return u[h] = r.asArray()[h] < 0 ? 1 : -1, BABYLON.Vector3.FromArray(u)
    }, t.prototype._getCollider = function() {
        if (this._collider)
            return this._collider;
        this._objectPool = this._objectPool || {};
        var t = this.scene;
        return this._collider = BABYLON.Mesh.CreateBox("boundingboxConfigurator.collider", 1, t)
    }, t.prototype._getTouchedFace = function(t, e) {
        var n = this._getCollider();
        n.isVisible = !0;
        var i = t.pickedMesh, o = i.getTopLevelObject(!0), r = this.computeDimension(o);
        n.position = r.position, n.scaling = r.dimension, n.rotationQuaternion = r.rotationQuat;
        var s = wanaplan.engine3D, a = s.scene.createPickingRay(e.mstate.pos.x, e.mstate.pos.y), l = a.intersectMeshes([n], !0, !0);
        if (this._options.debug || (n.isVisible = !1), !l || !l.hit)
            return null;
        var h = n.getIndices(), c = n.getVerticesData(BABYLON.VertexBuffer.NormalKind), u = BABYLON.Vector3.FromArray(c, 3 * h[3 * l.faceId]), p = s.scene.activeCamera, d = p.position.subtract(p.target);
        d.normalize();
        var m = BABYLON.Vector3.TransformNormal(u, n.getWorldMatrix());
        if (m.normalize(), BABYLON.Vector3.Dot(d, m) > .6)
            return null;
        var h = i.getIndices(), c = i.getVerticesData(BABYLON.VertexBuffer.NormalKind), g = BABYLON.Vector3.FromArray(c, 3 * h[3 * t.faceId]), f = BABYLON.Vector3.TransformNormal(g, i.getWorldMatrix());
        return f.normalize(), BABYLON.Vector3.Dot(m, f) < .35 ? null : u
    }, t.prototype._computeL = function(t, e, n, i) {
        var o = this._getCollider();
        o.isVisible = !0;
        var r = this.computeDimension(t);
        o.position = n.clone(), o.rotationQuaternion = r.rotationQuat, o.scaling.x = o.scaling.y = o.scaling.z = 1;
        var s = 9e3, a = this.getbestAxis(t, n, e);
        a.multiplyInPlace(a), a.scaleInPlace(-s + .1);
        var l = new BABYLON.Vector3(s, s, s);
        l.addInPlace(a), o.scaling = l, o.markAsDirty();
        var h = wanaplan.engine3D, c = h.scene.createPickingRay(i.mstate.pos.x, i.mstate.pos.y), u = c.intersectMeshes([o], !0, !0);
        if (this._options.debug || (o.isVisible = !1), !u || !u.pickedPoint)
            return 0;
        var p = r.rotationMatrix.clone();
        p.invert();
        var d = u.pickedPoint.subtract(n);
        BABYLON.Vector3.TransformCoordinatesToRef(d, p, d);
        var m = BABYLON.Vector3.Dot(d, e);
        return m
    }, t.prototype._getPropertyName = function(t, e) {
        var n = t.structure.programmableInstance.objectName, i = t.structure.programmableInstance.params;
        if (Math.abs(e.x) > .9)
            switch (n) {
                case "Bed":
                    return "mattress.width";
                case "Bath":
                case "GlassConsole":
                case "BabylonImporter":
                case "Light":
                    return null;
                case "Tv":
                    return "screen.width";
                case "PhotoFrame":
                case "photoFrame":
                    return "structure.width";
                case "BenchIkea":
                    return "global.width";
                case "spotMultiple":
                    return "tube.width";
                default:
                    return "undefined" != typeof i.width ? "width" : null
            }
        if (Math.abs(e.y) > .9)
            switch (n) {
                case "spotMultiple":
                case "Sofa":
                case "BabylonImporter":
                case "Bed":
                    return null;
                case "BenchIkea":
                    return "feet.height";
                case "PhotoFrame":
                case "photoFrame":
                    return "structure.height";
                case "Tv":
                    return "screen.height";
                case "Shower":
                    return t.structure.programmableInstance.nbWall ? "height" : null;
                case "GlassConsole":
                    return i.bar && "undefined" != typeof i.bar.height ? "bar.height" : null;
                case "Basic":
                    if ("undefined" != typeof t.structure.programmableInstance.horizontal && !t.structure.programmableInstance.horizontal)
                        return null;
                default:
                    return "undefined" != typeof i.height ? "height" : null
            }
        if (Math.abs(e.z) > .9)
            switch (n) {
                case "Bed":
                    return "mattress.length";
                case "PhotoFrame":
                case "photoFrame":
                    return "structure.depth";
                case "BenchIkea":
                    return "plank.depth";
                case "Bath":
                case "BabylonImporter":
                case "GlassConsole":
                case "spotMultiple":
                case "Curtains":
                case "Tv":
                case "TowelDry":
                case "Light":
                    return null;
                case "Basic":
                    if ("undefined" != typeof t.structure.programmableInstance.horizontal)
                        return t.structure.programmableInstance.horizontal ? null : "height";
                default:
                    return "undefined" != typeof i.depth ? "depth" : null
            }
    }, t.prototype._computePropertyValue = function(t, e, n) {
        var i = t.structure, o = this.computeDimension(t, e, n), r = Math.abs(BABYLON.Vector3.Dot(o.dimension, e)), s = Math.abs(BABYLON.Vector3.Dot(o.newDimension, e)), a = ujs.setProperty(i.programmableInstance.params, this._getPropertyName(t, e)) || 0, l = s - (r - a);
        return l = Math.abs(e.y) > .9 ? Math.max(1, l) : Math.abs(l)
    }, t.prototype._roundL = function(t) {
        return Math.round(t / this._options.roundDimension) * this._options.roundDimension
    }, t.prototype._enlargeYourObject = function(t, e, n) {
        if (!(Math.abs(n) < 1e-4)) {
            var i = t.structure, o = wanaplan.getComponentByName("EditionComponent3D"), r = {}, s = this._getPropertyName(t, e), a = this._roundL(this._computePropertyValue(t, e, n));
            r["programmableInstance.params." + s] = {newValue: a,exValue: ujs.getProperty(i.programmableInstance.params, s)}, ujs.setProperty(i.programmableInstance.params, s, a);
            var l = BABYLON.Matrix.RotationYawPitchRoll(t.rotation.y, t.rotation.x, t.rotation.z), h = new BABYLON.Vector3(.5 * n * e.x, 0, .5 * n * e.z);
            BABYLON.Vector3.TransformCoordinatesToRef(h, l, h), h.addInPlace(t.position), r.position = {newValue: h.clone(),exValue: t.position.clone()}, t.position.copyFrom(h), o.refreshObject(t, {modifiedProperties: r}), ujs.notify("wnp.request.saveHistory")
        }
    }, t.prototype.handlers = {onDragStart: function(t) {
            t.collided && t.collided.pickedMesh && (this._touchedFace = this._getTouchedFace(t.collided, t), this._touchedFace && (this.displayer.handles && !this._options.keepAnimateHandleOnResize && this.displayer.handles.stopAnimeHandle(), this.displayer.handles && !this._options.displayHandleOnResize && this.displayer.handles.dispose(), this.askStartResize(this.object, this._touchedFace, t.collided.pickedPoint)))
        },onDragEnd: function(t) {
            if (this._direction) {
                this.myBind.onDragging(t);
                var e = this._roundL(this._l);
                this._enlargeYourObject(this.object, this._direction, e), this.displayer.boundingLimit && this.displayer.boundingLimit.hide(), this.displayer.boundingLimitNew && this.displayer.boundingLimitNew.hide(), this.displayer.mesure && this.displayer.mesure.hide(), this.displayer.handles && this.displayer.handles.dispose(), this._direction = null, this.master.releaseHand(this)
            }
        },onDragging: function(t) {
            if (this._direction) {
                this._l = this._computeL(this.object, this._direction, this._pickedPoint, t);
                var e = this._roundL(this._l);
                this.displayer.boundingLimit && this._options.displayBoundingLimitOnDrag && this.displayer.boundingLimit.display(this.object, this._direction, 0), this.displayer.boundingLimitNew && this._options.displayBoundingLimitOnDrag && this.displayer.boundingLimitNew.display(this.object, this._direction, e), this.displayer.handles && this._options.displayHandleOnResize && this.displayer.handles.placeHandleOnObject(this.object, this._direction, e), this.displayer.mesure && this.displayer.mesure.display(this.object, this._direction, this._pickedPoint, e)
            }
        },onHover: function(t) {
            return this._touchedFace = this._getTouchedFace(t.collided, t), this._touchedFace && this._getPropertyName(this.object, this._touchedFace) && this.master.requireHand(this) ? (this.displayer.boundingLimit && this._options.displayBoundingLimitOnHover && this.displayer.boundingLimit.display(this.object, this._touchedFace), this.displayer.handles && this._options.animateHandleOnHover && (this._previousHoverFace && BABYLON.Vector3.Dot(this._previousHoverFace, this._touchedFace) < .9 && this.displayer.handles.stopAnimeHandle(), this.displayer.handles.startAnimeHandle(this._touchedFace)), void (this._previousHoverFace = this._touchedFace)) : this.myBind.onLeave(t)
        },onLeave: function() {
            this.displayer.boundingLimit.hide(), this.displayer.handles && this.displayer.handles.stopAnimeHandle(), this._previousHoverFace = this._touchedFace = null, this.master.releaseHand(this)
        },onAfterRefresh: function() {
            this.displayer.handles && this.displayer.handles.start(this.object)
        },onEditionStart: function(t) {
            this.object = t.furniture, this.displayer.handles && this.displayer.handles.start(this.object)
        },onEditionEnd: function() {
            this.displayer.handles && this.displayer.handles.stop(), this.displayer.boundingLimit && this.displayer.boundingLimit.hide(), this.displayer.boundingLimitNew && this.displayer.boundingLimitNew.hide(), this.displayer.mesure && this.displayer.mesure.hide(), this._direction = null, this.master.releaseHand(this), this.object = null
        }}, t
}(), HandlesDisplayerForDimensionReshaperFactoryComponent3D = function() {
    var t = function(t) {
        BaseComponent3D.call(this, t, "HandlesDisplayerForDimensionReshaperFactoryComponent3D")
    };
    t.prototype = new BaseComponent3D, t.prototype.create = function(t, n) {
        var i = new e;
        return i.initialize(t, n), i
    };
    var e = function() {
    };
    return e.prototype.initialize = function(t, e) {
        this.scene = e, this.camera = t, this.dimensionConfigurator = wanaplan.getComponentByName("DimensionReshaperComponent3D"), this._spriteManager = new BABYLON.SpriteManager("handleMgr", wnp.Assets.toolbarTextures.arrowTexture, 6, 128, this.scene), this._sprite = {}, this._animated = {}, this._availableHandles = {}, this.initBindForThisInstance()
    }, e.prototype.initBindForThisInstance = function() {
        if (this.myBind)
            return this;
        var t = this;
        this.myBind = {};
        for (var e in this.handlers)
            (function() {
                var n = t.handlers[e];
                t.myBind[e] = function(e) {
                    n.call(t, e)
                }
            })();
        return this
    }, e.prototype.start = function(t) {
        this.stop(), this.object = t, this._computeAvailableHandles(t), document.addEventListener("wnp.engine3D.camera.move", this.myBind.onCameraMove), document.addEventListener("wnp.engine3D.drag-start", this.myBind.onMouseDown), this.myBind.onCameraMove()
    }, e.prototype.stop = function() {
        document.removeEventListener("wnp.engine3D.camera.move", this.myBind.onCameraMove), document.removeEventListener("wnp.engine3D.drag-start", this.myBind.onMouseDown), this.dispose()
    }, e.prototype.startAnimeHandle = function(t) {
        var e = 2 * Math.abs(t.y) + 4 * Math.abs(t.z) + (t.x + t.z + t.y < 0 ? 0 : 1);
        if (!this._animated[e]) {
            var n = this.scene;
            n.beginAnimation(this._getHandle(e), 0, 100, !0, 3), this._animated[e] = !0
        }
    }, e.prototype.stopAnimeHandle = function(t) {
        if (t) {
            var e;
            if (e = "string" == typeof t ? t : 2 * Math.abs(t.y) + 4 * Math.abs(t.z) + (t.x + t.z + t.y < 0 ? 0 : 1), this._sprite[e] && this._animated[e]) {
                var n = this.scene;
                n.stopAnimation(this._sprite[e]), this._animated[e] = !1, this._sprite[e].animations && this._sprite[e].animations.length && this._sprite[e].position.copyFrom(this._sprite[e].animations[0]._keys[0].value)
            }
        } else
            for (var i in this._sprite)
                this.stopAnimeHandle(i + "")
    }, e.prototype.placeHandleOnObject = function(t, e, n) {
        var i = this.dimensionConfigurator.computeDimension(t, e || new BABYLON.Vector3(0, 0, 0), n || 0);
        return this.placeHandles(i.newPosition, i.newDimension, i.rotationMatrix)
    }, e.prototype.placeHandles = function(t, e, n) {
        var i = this.camera, o = new BABYLON.Vector3, r = new BABYLON.Vector3, s = new BABYLON.Vector3, a = i.getViewMatrix().clone();
        a.m[12] = a.m[13] = a.m[14] = 0;
        for (var l = i.position.subtract(i.target).normalize(), h = 15, c = 0; 6 > c; c++)
            if (2 != c && this._availableHandles[c]) {
                var u = [0, 0, 0];
                if (u[c >> 1] = c % 2 ? 1 : -1, BABYLON.Vector3.FromArrayToRef(u, 0, o), BABYLON.Vector3.TransformCoordinatesToRef(o, n, s), Math.abs(BABYLON.Vector3.Dot(s, l)) < .6) {
                    r.x = o.x * (.5 * e.x + h), r.y = o.y * (.5 * e.y + h), r.z = o.z * (.5 * e.z + h), BABYLON.Vector3.TransformCoordinatesToRef(r, n, r), r.addInPlace(t);
                    var p = this._getHandle(c + "", r, s);
                    p.position.copyFrom(r), BABYLON.Vector3.TransformCoordinatesToRef(s, a, o), p.angle = Math.atan2(o.y, o.x)
                } else
                    this._disposeHandle(c + "")
            }
    }, e.prototype.dispose = function() {
        this._disposeHandle()
    }, e.prototype._disposeHandle = function(t) {
        if ("undefined" != typeof t)
            this._sprite[t] && (this.stopAnimeHandle(t), this._sprite[t].dispose(), this._sprite[t] = null);
        else
            for (var e in this._sprite)
                this._disposeHandle(e)
    }, e.prototype._getHandle = function(t, e, n) {
        if (this._sprite[t])
            return this._sprite[t];
        this.scene;
        if (this._sprite[t] = new BABYLON.Sprite("handle_" + t, this._spriteManager), this._sprite[t].size = 20, e && n) {
            var i = new BABYLON.Animation("jump_handle_animation", "position", 60, BABYLON.Animation.ANIMATIONTYPE_VECTOR3, BABYLON.Animation.ANIMATIONLOOPMODE_CYCLE), o = e.clone(), r = n.scale(10);
            r.addInPlace(o), i.setKeys([{frame: 0,value: o}, {frame: 50,value: r}, {frame: 100,value: o}]), this._sprite[t].animations = this._sprite[t].animations || [], this._sprite[t].animations.push(i)
        }
        return this._sprite[t]
    }, e.prototype._computeAvailableHandles = function(t) {
        this._availableHandles = {};
        for (var e = new BABYLON.Vector3, n = 0; 6 > n; n++)
            if (2 != n) {
                var i = [0, 0, 0];
                i[n >> 1] = n % 2 ? 1 : -1, BABYLON.Vector3.FromArrayToRef(i, 0, e), this._availableHandles[n] = !!this.dimensionConfigurator._getPropertyName(t, e)
            }
    }, e.prototype.handlers = {onCameraMove: function() {
            var t = this.object;
            this.placeHandleOnObject(t)
        },onMouseDown: function(t) {
            var e = [];
            for (var n in this._sprite || {})
                this._sprite[n] && e.push(this._sprite[n]._colliderMesh);
            var i = wanaplan.engine3D, o = i.scene.createPickingRay(t.mstate.pos.x, t.mstate.pos.y), r = o.intersectMeshes(e, !0, !0);
            if (r && r.pickedMesh) {
                var n = parseInt(r.pickedMesh.name.match(/[0-9]*$/)[0]), s = [0, 0, 0];
                s[n >> 1] = n % 2 ? 1 : -1, this.dimensionConfigurator.askStartResize(this.object, BABYLON.Vector3.FromArray(s), r.pickedMesh.position.clone(), this)
            }
        }}, t
}(), BoundingLimitDisplayerForDimensionReshaperFactoryComponent3D = function() {
    var t = function(t) {
        BaseComponent3D.call(this, t, "BoundingLimitDisplayerForDimensionReshaperFactoryComponent3D")
    };
    t.prototype = new BaseComponent3D, t.prototype.create = function(t, n, i) {
        var o = new e;
        return o.initialize(t, n, i), o
    };
    var e = function() {
    };
    return e.prototype.initialize = function(t, e, n) {
        if (this.scene = e, this.camera = t, this.dimensionConfigurator = wanaplan.getComponentByName("DimensionReshaperComponent3D"), "undefined" == typeof n && (n = "green"), "string" == typeof n) {
            var i, o = new BABYLON.StandardMaterial("texture_dimension_configurator_placeholder", e);
            switch (n) {
                case "yellow":
                    i = (new BABYLON.Color3).fromHex(wnp.Assets.complementaryUIColor);
                    break;
                default:
                    i = (new BABYLON.Color3).fromHex(wnp.Assets.mainUIColor)
            }
            wnp.MaterialFactory.MakeBasicColor(o, i), o.backFaceCulling = !1, o.alpha = .6, n = o
        }
        return this.mat = n, this
    }, e.prototype._getBoundingLimitGhost = function() {
        if (this._boundingLimitGhost)
            return this._boundingLimitGhost;
        var t = this.scene;
        return this._boundingLimitGhost = BABYLON.Mesh.CreateBox("boundingboxConfigurator.boundingLimitGhost", 1, t), this._boundingLimitGhost.material = this.mat, this._boundingLimitGhost
    }, e.prototype.display = function(t, e, n) {
        n = n || 0;
        var i = this._getBoundingLimitGhost();
        i.isVisible = !0;
        var o = this.dimensionConfigurator.computeDimension(t);
        o.dimension.scaleInPlace(1.01), i.position = o.position, i.rotationQuaternion = o.rotationQuat, i.scaling = o.dimension;
        var r = .5, s = new BABYLON.Vector3(.5 * r + .5 * o.dimension.x + n, .5 * r + .5 * o.dimension.y + n, .5 * r + .5 * o.dimension.z + n);
        s.multiplyInPlace(e), BABYLON.Vector3.TransformCoordinatesToRef(s, o.rotationMatrix, s), i.position.addInPlace(s);
        var a = new BABYLON.Vector3(r - o.dimension.x, r - o.dimension.y, r - o.dimension.z);
        a.multiplyInPlace(e), a.multiplyInPlace(e), i.scaling.addInPlace(a), i.markAsDirty()
    }, e.prototype.hide = function() {
        var t = this._getBoundingLimitGhost();
        t.isVisible = !1
    }, e.prototype.dispose = function() {
        this._boundingLimitGhost.remove(), this._boundingLimitGhost = null
    }, t
}(), MesureDisplayerForDimensionReshaperFactoryComponent3D = function() {
    var t = function(t) {
        BaseComponent3D.call(this, t, "MesureDisplayerForDimensionReshaperFactoryComponent3D")
    };
    t.prototype = new BaseComponent3D, t.prototype.create = function(t, n) {
        var i = new e;
        return i.initialize(t, n), i
    };
    var e = function() {
    };
    return e.prototype.initialize = function(t, e) {
        return this.camera = t, this.scene = e, this.dimensionConfigurator = wanaplan.getComponentByName("DimensionReshaperComponent3D"), this
    }, e.prototype.hide = function() {
        this._cote && (this._cote.plan.isVisible = !1)
    }, e.prototype.dispose = function() {
        this._cote.plan.dispose(), this._cote.texture.dispose(), this._cote = null
    }, e.prototype.display = function(t, e, n, i) {
        var o = this._getCote();
        o.plan.isVisible = !0;
        var r = this.dimensionConfigurator.computeDimension(t, e, i), s = this.dimensionConfigurator.getbestAxis(t, n, e), a = e.clone(), l = BABYLON.Vector3.Cross(s, a), h = wanaplan.engine3D, c = h.scene.activeCamera, u = c.target.subtract(c.position), p = BABYLON.Vector3.TransformCoordinates(l, r.rotationMatrix);
        BABYLON.Vector3.Dot(p, u) > 0 && l.scaleInPlace(-1), p = BABYLON.Vector3.TransformCoordinates(l, r.rotationMatrix);
        var d = (BABYLON.Vector3.TransformCoordinates(a, r.rotationMatrix), BABYLON.Quaternion.RotationFromXtoX_2(new BABYLON.Vector3(0, 1, 0), l, new BABYLON.Vector3(0, 0, 1), s)), m = r.rotationQuat, g = m.multiply(d);
        o.plan.rotationQuaternion = g;
        var f = c.getViewMatrix().clone();
        f.m[12] = f.m[13] = f.m[14] = 0;
        var y = BABYLON.Vector3.TransformCoordinates(p, f);
        Math.abs(y.x) > Math.abs(y.y) ? y.y = 0 : y.x = 0;
        var _ = (Math.floor(Math.atan2(y.y, y.x) / (Math.PI / 2)) + 3) % 4, v = Math.abs(r.newDimension.dot(a));
        v = this.dimensionConfigurator._roundL(v), this._writeCote(v, _, u.length()), o.plan.position = r.newPosition.clone();
        var b = new BABYLON.Vector3(.5 * r.newDimension.x + .5 * o.plan.scaling.y, .5 * r.newDimension.y + .5 * o.plan.scaling.y, .5 * r.newDimension.z + .5 * o.plan.scaling.y).multiply(l);
        BABYLON.Vector3.TransformCoordinatesToRef(b, r.rotationMatrix, b), o.plan.position.addInPlace(b);
        var w = r.rotationMatrix.clone();
        w.invert();
        var x = n.subtract(r.newPosition);
        BABYLON.Vector3.TransformCoordinatesToRef(x, w, x), x = x.multiply(s).multiply(s), BABYLON.Vector3.TransformCoordinatesToRef(x, r.rotationMatrix, x), o.plan.position.addInPlace(x)
    }, e.prototype._resizeAndComputeRatio = function(t, e) {
        var n = this._getCote(), i = n.texture.getSize(), o = Math.min(i.width / t, i.height / e);
        return n.plan.scaling.x = i.width / o, n.plan.scaling.y = n.plan.scaling.x * i.height / i.width, o
    }, e.prototype._getCote = function() {
        if (this._cote)
            return this._cote;
        var t = this.scene, e = BABYLON.Mesh.CreatePlane("cote_plan", 1, t);
        e.scaling.x = 1e3, e.scaling.y = 1e3;
        var n = new BABYLON.StandardMaterial("cote_texture", t);
        wanaplan.engine3D.scene.getEngine().getCaps().maxAnisotropy = 128;
        var i = new BABYLON.DynamicTexture("cote_texture", {width: 512,height: 256}, t, !0);
        return i.hasAlpha = !0, n.diffuseTexture = i, n.useAlphaFromDiffuseTexture = !0, e.material = n, this._cote = {texture: i,plan: e}
    }, e.prototype._writeCote = function(t, e, n) {
        var i = this._getCote(), o = i.texture.getContext();
        o.save();
        var r = .5, s = .08, a = 1.65, l = .3, h = 4 * (2 + n / 300), c = !1, u = i.texture.getSize(), p = (Math.round(t) + " cm").replace(/\d/g, "0");
        o.font = "normal " + 1e3 * r + "pt calibri";
        var d = o.measureText(p).width / 1e3;
        o.font = "normal " + 700 * r + "pt calibri", d += o.measureText(".00").width / 1e3, c = (e % 2 == 0 ? d : 2 * r) * h > t - 2 * l * h;
        var m = h * ((c ? 1.5 * r : 0) + (e % 2 == 1 ? d + a : a + 2 * r)), g = this._resizeAndComputeRatio(t, m);
        2 * l * h > .6 * t && (l *= .6 * t / (2 * l * h)), o.save(), o.clearRect(0, 0, u.width, u.height), o.lineWidth = s * h * g, o.strokeStyle = "#000000", o.fillStyle = "#000000", o.font = "normal " + r * h * g + "pt calibri", d *= g * h;
        var f = e % 2 == 1 ? r * h * g * 1.4 : 1.01 * d, y = u.height - a * h * g - r * g * h, _ = .5 * u.width - .5 * t * g + s * h * g, v = .5 * u.width + .5 * t * g - s * h * g;
        c ? (o.beginPath(), o.moveTo(_, y), o.lineTo(v, y), o.stroke()) : (o.beginPath(), o.moveTo(_, y), o.lineTo((_ + v) / 2 - f / 2, y), o.stroke(), o.beginPath(), o.moveTo(v, y), o.lineTo((_ + v) / 2 + f / 2, y), o.stroke()), o.beginPath(), o.moveTo(_ + l * g * h, y + l * g * h), o.lineTo(_, y), o.lineTo(_ + l * g * h, y - l * g * h), o.stroke(), o.beginPath(), o.moveTo(v - l * g * h, y + l * g * h), o.lineTo(v, y), o.lineTo(v - l * g * h, y - l * g * h), o.stroke(), o.globalAlpha = .7, o.lineWidth = .5 * s * h * g, o.beginPath(), o.moveTo(_ - .5 * s * h * g, y + .1 * (u.height - y)), o.lineTo(_ - .5 * s * h * g, y + .9 * (u.height - y)), o.stroke(), o.lineWidth = .5 * s * h * g, o.beginPath(), o.moveTo(v + .5 * s * h * g, y + .1 * (u.height - y)), o.lineTo(v + .5 * s * h * g, y + .9 * (u.height - y)), o.stroke(), o.globalAlpha = 1;
        var b = e * Math.PI / 2;
        o.translate((_ + v) / 2, y - (c ? r * h * g * 1.5 : 0)), o.rotate(b), 1 == e && o.translate(r * h * g - d / 2, 0), 3 == e && o.translate(-r * h * g + d / 2, 0), o.translate(-d / 2, r * h * g * .5);
        var w = (t >> 0) + "";
        o.fillText(w, 0, 0), o.translate(o.measureText(w).width, 0);
        var w = "." + Math.floor(t % 1 * 100);
        w = 2 == w.length ? w + "0" : w, o.font = "normal " + r * h * g * .7 + "pt calibri", o.fillText(w, 0, 0), o.translate(o.measureText(w).width, 0);
        var w = " cm";
        o.font = "normal " + r * h * g + "pt calibri", o.fillText(w, 0, 0), o.restore(), i.texture.update()
    }, t
}(), MagnetismComponent2D = function() {
    var t = function(t) {
        BaseComponent2D.call(this, t, "MagnetismComponent2D"), this.priority = 100, this._precision = 10, this._draggedWall = null, this._magnetism = [], this._wallCandidates = [], this._wallFirstPoint = null, this._virtualPoints = {}, this.core.engine2D.registerEventCb("MagnetismComponent2D.dynamic-draw", 0, "dynamic-draw", 255 - this.core.engine2D.MODE_CONTEXTMENU - this.core.engine2D.MODE_NORMAL, null, this.onDynamicDraw.bind(this), null), this.core.engine2D.registerEventCb("MagnetismComponent2D.point-mag.mouse-move", this.priority, "mouse-move", null, null, this.onPointMagMove.bind(this), null), this.core.engine2D.registerEventCb("MagnetismComponent2D.point-mag.drag-start", this.priority, "drag-start", null, null, this.onPointMagDragStart.bind(this), null), this.core.engine2D.registerEventCb("MagnetismComponent2D.point-mag.click", this.priority, "click", null, null, this.onPointMagClick.bind(this), null), this.core.engine2D.registerEventCb("MagnetismComponent2D.wall-mag.drag-start", this.priority, "drag-start", null, null, this.onWallMagDragStart.bind(this), null)
    };
    return t.prototype = new BaseComponent2D, t.prototype.addVirtualPoint = function(t, e) {
        if (this._virtualPoints[t] || (this._virtualPoints[t] = []), e instanceof PointStructure)
            return this._virtualPoints[t].push(e), this._virtualPoints[t].length - 1;
        if (e instanceof BABYLON.Vector2) {
            var n = new PointStructure;
            return n.position = e, this._virtualPoints[t].push(n), this._virtualPoints[t].length - 1
        }
        Logger.error("Error: MagnetismComponent2D.addVirtualPoint: `point` is neither a `PointStructure` neither a `BABYLON.Vector3`.")
    }, t.prototype.removeVirtualPoint = function(t, e) {
        this._virtualPoints[t] && (null == e ? this._virtualPoints[t].length = 0 : delete this._virtualPoints[t][e])
    }, t.prototype.applyPointMag = function(t) {
        this._magFromPoint(t)
    }, t.prototype._shortCircuitMagnetism = function(t) {
        return (t.modifiers & t.MODIFIER_CTRL) > 1 ? !0 : !1
    }, t.prototype._magFromPoint = function(t, e) {
        if (!this._shortCircuitMagnetism(t)) {
            var n = (this.core.engine2D.getTranslation(), this.core.engine2D.getZoom()), i = this._precision / Math.sqrt(n), o = this.structure.getCurrentStructure().getElements("points").slice(0);
            for (var r in this._virtualPoints)
                if (this._virtualPoints[r].constructor === Array)
                    for (var s in this._virtualPoints[r])
                        o.push(this._virtualPoints[r][s]);
            var a = !1, l = !1;
            for (var s in o) {
                if (e instanceof PointStructure) {
                    if (o[s] == e)
                        continue;
                    var h = !1;
                    for (var c in e.parents)
                        if (!h && e.parents[c] instanceof WallStructure && e.parents[c].attachedPoints)
                            for (var u in e.parents[c].attachedPoints)
                                if (e.parents[c].attachedPoints[u] == o[s]) {
                                    h = !0;
                                    break
                                }
                    if (h)
                        continue
                }
                if ((!a && Math.abs(o[s].position.x - t.planPos.x) <= i || a && Math.abs(o[s].position.x - t.planPos.x) < 1) && (t.planPos.x = o[s].position.x, this._magnetism.push([o[s].position, t.planPos]), a = !0), (!l && Math.abs(o[s].position.y - t.planPos.y) <= i || l && Math.abs(o[s].position.y - t.planPos.y) < 1) && (t.planPos.y = o[s].position.y, this._magnetism.push([o[s].position, t.planPos]), l = !0), a && l)
                    break
            }
            this.core.engine2D.requestDynamicDraw()
        }
    }, t.prototype._globalWallMag = function(t, e) {
        var n, i, o = Math.PI / 150, r = 30, s = this.structure.getCurrentStructure().getElements("walls"), a = new BABYLON.Vector2, l = t.getWallVector().normalize(), h = e.planPos.clone();
        h.subtractInPlace(t.getPoints(0).position);
        for (var c = h.clone().projectOnVector(l), u = h.subtractInPlace(c), p = t.getPoints(0).position.add(u), d = (t.getPoints(1).position.add(u), function(t, e) {
            return e ? a.copyFrom(t).addInPlace(e).subtractInPlace(p).normalize() : a.copyFrom(t).subtractInPlace(p).normalize(), n = a.determinant(l), Math.abs(n) < o
        }), m = function(t, e) {
            var n = Math.PI / 100, i = t.getWallVector(), o = e.getWallVector(), r = Math.atan(i.y, i.x) - Math.atan(o.y, o.x);
            return Math.abs(r) < n || Math.abs(r + Math.PI) < n || Math.abs(r - Math.PI) < n || Math.abs(r + 2 * Math.PI) < n || Math.abs(r - 2 * Math.PI) < n
        }, g = function(n, i) {
            var o = n.getWallVector(), s = t.getNormalVector(), a = i ? t.getPoints(0).position.add(i) : t.getPoints(0).position.clone(), l = (o.determinant(n.getPoints(0).position) - o.determinant(a)) / o.determinant(s);
            return s.scaleInPlace(l), Math.abs(l) < r ? (e.forcePosition = i ? s.add(a).addInPlace(i) : s.add(a), !0) : !1
        }.bind(this), f = 0, y = s.length; y > f; f++)
            if (s[f] != t && m(s[f], t)) {
                if ((d(s[f].getPoints(0).position) || d(s[f].getPoints(1).position)) && g(s[f]))
                    return;
                if (s[f].thickness > t.thickness) {
                    if (i = s[f].getNormalVector((s[f].thickness - t.thickness) / 2), (d(s[f].getPoints(0).position, i) || d(s[f].getPoints(1).position, i)) && g(s[f], i))
                        return;
                    if (i.scaleInPlace(-1), (d(s[f].getPoints(0).position, i) || d(s[f].getPoints(1).position, i)) && g(s[f], i))
                        return
                }
            }
    }, t.prototype._magFromWalls = function(t, e) {
        var n = Math.PI / 18;
        if (!this._shortCircuitMagnetism(t) && this._wallFirstPoint) {
            for (var i, o = (this.core.engine2D.getTranslation(), this.core.engine2D.getZoom()), r = (this._precision / Math.sqrt(o), e || this.structure.getCurrentStructure().getElements("walls"), t.planPos.x - this._wallFirstPoint.x), s = t.planPos.y - this._wallFirstPoint.y, a = Math.atan2(s, r), l = 0, h = this._wallCandidates.length; h > l; l++)
                if (i = Math.abs(this._wallCandidates[l].angle - a) % (Math.PI / 2), n > i || Math.PI / 2 - i < n) {
                    var c;
                    i = Math.abs((this._wallCandidates[l].angle - a) % Math.PI), c = i < Math.PI / 4 || i > 3 * Math.PI / 4 ? 0 : Math.PI / 2, c += this._wallCandidates[l].angle;
                    var u = Math.cos(c), p = Math.sin(c), d = new BABYLON.Vector2(u, p), m = new BABYLON.Vector2(r, s), g = m.clone().projectOnVector(d);
                    t.planPos.copyFrom(g).addInPlace(this._wallFirstPoint);
                    break
                }
            this.core.engine2D.requestDynamicDraw()
        }
    }, t.prototype.onDynamicDraw = function(t, e, n) {
        t.lineWidth = 2, t.strokeStyle = "#009900";
        for (var i in this._magnetism) {
            var o = this._magnetism[i][0].scale(n).addInPlace(e), r = this._magnetism[i][1].scale(n).addInPlace(e);
            t.beginPath(), t.moveTo(Math.round(o.x), Math.round(o.y)), t.lineTo(Math.round(r.x), Math.round(r.y)), t.stroke(), t.closePath()
        }
        this._magnetism = []
    }, t.prototype.onPointMagMove = function(t, e, n) {
        this.core.engine2D.getMode() == this.core.engine2D.MODE_DRAW && (this._magFromPoint(n), this._magFromWalls(n))
    }, t.prototype.onPointMagDragStart = function(t, e, n, i) {
        (e instanceof PointStructure || this.core.engine2D.getMode() == this.core.engine2D.MODE_DRAW) && (this.onPointMagClick(t, e, n, i), this.core.engine2D.registerEventCb("MagnetismComponent2D.point-mag.draging", this.priority, "dragging", this.core.engine2D.MODE_DRAG, null, this.onPointMagDragging.bind(this), e), this.core.engine2D.registerEventCb("MagnetismComponent2D.point-mag.drag-end", this.priority, "drag-end", this.core.engine2D.MODE_DRAG, null, this.onPointMagClick.bind(this), e))
    }, t.prototype.onPointMagDragging = function(t, e, n, i) {
        this._magFromPoint(n, i), this._magFromWalls(n, i)
    }, t.prototype.onPointMagClick = function(t, e, n) {
        if (e instanceof PointStructure)
            this._magFromPoint(n, e), this._magFromWalls(n);
        else {
            if (e instanceof WallStructure && this.core.engine2D.getMode() == this.core.engine2D.MODE_NORMAL)
                return;
            this._magFromPoint(n), this._magFromWalls(n)
        }
    }, t.prototype.onWallMagDragStart = function(t, e) {
        return e instanceof WallStructure ? (this.core.engine2D.registerEventCb("MagnetismComponent2D.wall-mag.dragging", this.priority, "dragging", null, null, this.onWallMagDragging.bind(this), null), void (this._draggedWall = e)) : void (this._draggedWall = null)
    }, t.prototype.onWallMagDragging = function(t, e, n) {
        this._draggedWall && this._globalWallMag(this._draggedWall, n)
    }, t.prototype.onWallDrawStart = function(t) {
        var e = this.structure.getCurrentStructure().getElements("walls"), n = 15;
        this._wallCandidates.length = 0, this._wallFirstPoint = t.position;
        for (var i = 0, o = e.length; o > i; i++)
            if (e[i].distanceFrom(this._wallFirstPoint) < n) {
                var r = e[i].getWallVector();
                this._wallCandidates.push({wall: e[i],angle: Math.atan2(r.y, r.x)})
            }
    }, t.prototype.onWallDrawEnd = function() {
        this._wallFirstPoint = null
    }, t
}(), MagnetismComponent3D = function() {
    var t, e, n = !1, i = function(n) {
        BaseComponent3D.call(this, n, "MagnetismComponent3D"), this._lastPosition = new BABYLON.Vector3, this._lastFictivePosition = new BABYLON.Vector3, this._speedVector = new BABYLON.Vector3, this._physicSpeedVector = new BABYLON.Vector3, this._correctedSpeedVector = new BABYLON.Vector3, this._tmpVector = new BABYLON.Vector3, e = wanaplan.engine3D.searchComponent("EditionComponent3D"), t = this, this.collisionList = [], this.currentCollisionBox = null
    }, o = .1, r = function(t, e) {
        if (e) {
            {
                t.getWorldMatrix()
            }
            this.box = new BABYLON.BoundingBox(e.minimum, e.maximum), this.box.angle = e.angle
        } else {
            var n = t.getBoundingBox(!0);
            this.box = new BABYLON.BoundingBox(n.minimum, n.maximum)
        }
        this.object = t, t.structure && (this.object.magnetismCollider = t.structure.magnetismCollider), this.corner = [new BABYLON.Vector3, new BABYLON.Vector3, new BABYLON.Vector3, new BABYLON.Vector3], this.axis = [new BABYLON.Vector3, new BABYLON.Vector3], this.origin = [0, 0], this.yRange = [0, 0], this.object.structure && this.object.structure.easeMagnetism && this.correctSmallBoxes(), this.update()
    }, s = [];
    r.prototype.showBox = function() {
        if (!this._debugCube) {
            var t = wanaplan.engine3D.scene;
            this._debugCube = BABYLON.Mesh.CreateBox("boundingboxConfigurator.boundingLimitGhost", 1, t), this._debugCube.material = new BABYLON.StandardMaterial("BB_debug", t), this._debugCube.material.wireframe = !0, this._debugCube.material.alpha = .29, s.push(this._debugCube)
        }
        for (var e = this._debugCube, n = new BABYLON.Vector3(0, 0, 0), i = 4; i--; )
            n.addInPlace(this.corner[i]);
        n.scaleInPlace(.25), n.y = (this.yRange[1] + this.yRange[0]) / 2;
        var o = this.corner[0].subtract(this.corner[1]), r = this.corner[2].subtract(this.corner[1]);
        e.position.copyFrom(n), e.scaling.x = o.length(), e.scaling.z = r.length(), e.scaling.y = this.yRange[1] - this.yRange[0], e.rotation.y = -Math.atan2(o.z, o.x)
    }, r.prototype.correctSmallBoxes = function() {
        var t = this.object.structure.preferredYAngle || 0, e = new BABYLON.Vector3(0, 0, 1);
        e = BABYLON.Vector3.TransformCoordinates(e, BABYLON.Matrix.RotationAxis(new BABYLON.Vector3(0, 1, 0), t)), e.scaleInPlace(80), this.corner[0].copyFromFloats(this.box.minimum.x, this.box.minimum.y, this.box.minimum.z), this.corner[1].copyFromFloats(this.box.maximum.x, this.box.minimum.y, this.box.minimum.z), this.corner[2].copyFromFloats(this.box.maximum.x, this.box.minimum.y, this.box.maximum.z), this.corner[3].copyFromFloats(this.box.minimum.x, this.box.minimum.y, this.box.maximum.z);
        for (var n = 0; 4 > n; n++)
            this.corner[n].addInPlace(e), BABYLON.BoundingBox.ExpandFromPoint(this.corner[n], this.box.minimum, this.box.maximum)
    }, r.prototype.update = function() {
        if (this.object.computeWorldMatrix(!0), BABYLON.Vector3.TransformCoordinatesFromFloatsToRef(this.box.minimum.x, this.box.minimum.y, this.box.minimum.z, this.object.getWorldMatrix(), this.corner[0]), BABYLON.Vector3.TransformCoordinatesFromFloatsToRef(this.box.maximum.x, this.box.minimum.y, this.box.minimum.z, this.object.getWorldMatrix(), this.corner[1]), BABYLON.Vector3.TransformCoordinatesFromFloatsToRef(this.box.maximum.x, this.box.minimum.y, this.box.maximum.z, this.object.getWorldMatrix(), this.corner[2]), BABYLON.Vector3.TransformCoordinatesFromFloatsToRef(this.box.minimum.x, this.box.minimum.y, this.box.maximum.z, this.object.getWorldMatrix(), this.corner[3]), this.box.angle) {
            var t = -this.box.angle, e = this.box.center;
            e.y = 0;
            for (var i = BABYLON.Matrix.FromValues(Math.cos(t), 0, Math.sin(t), 0, 0, 1, 0, 0, -Math.sin(t), 0, Math.cos(t), 0, 0, 0, 0, 1), o = 0; 4 > o; o++)
                this.corner[o].subtractInPlace(e), BABYLON.Vector3.TransformCoordinatesToRef(this.corner[o], i, this.corner[o]), this.corner[o].addInPlace(e)
        }
        this.axis[0].copyFrom(this.corner[1]), this.axis[0].subtractInPlace(this.corner[0]), this.axis[1].copyFrom(this.corner[3]), this.axis[1].subtractInPlace(this.corner[0]);
        for (var o = 0; 2 > o; o++)
            0 == this.axis[o].lengthSquared() && (this.axis[o].copyFrom(this.axis[(o + 1) % 2].cross(new BABYLON.Vector3(0, 1, 0))), this.axis[o].normalize().scaleInPlace(.1));
        for (var r, o = 0; 2 > o; o++)
            r = this.axis[o].lengthSquared(), 0 != r ? this.axis[o].scaleInPlace(1 / r) : this.axis[o] = new BABYLON.Vector3(0, 0, 0), this.origin[o] = this.corner[0].dot(this.axis[o]);
        this.yRange = [BABYLON.Vector3.TransformCoordinates(this.box.minimum, this.object.getWorldMatrix()).y, BABYLON.Vector3.TransformCoordinates(this.box.maximum, this.object.getWorldMatrix()).y], n && this.showBox()
    }, r.prototype.overlaps1Way = function(t, e, n) {
        for (var i, r, s, a = +1 / 0, l = 0, h = null, c = 0; 2 > c; c++) {
            n && (s = n.dot(this.axis[c]));
            for (var u = t.corner[0].dot(this.axis[c]), p = 1 / this.axis[c].length(), d = u, m = u, g = 1; 4 > g; g++)
                u = t.corner[g].dot(this.axis[c]), d > u ? d = u : u > m && (m = u);
            if (d > 1 + this.origin[c] || m < this.origin[c])
                return !1;
            i = (this.origin[c] + 1 - d) * p, r = (m - this.origin[c]) * p, l = n && Math.abs(s) > o ? s > 0 ? i : -r : i > r ? -r : i, Math.abs(l) < Math.abs(a) && (h = this.axis[c], a = l)
        }
        return e && (e.overlapAxis = h, e.overlapValue = a), !0
    }, r.prototype.overlaps = function(t) {
        return this.overlaps1Way(t) && t.overlaps1Way(this)
    }, r.prototype.worstOverlap = function(t, e) {
        var n = {}, i = {}, o = this.overlaps1Way(t, n, e), r = t.overlaps1Way(this, i, e ? e.clone().scaleInPlace(-1) : null);
        return o || r ? Math.abs(n.overlapValue) < Math.abs(i.overlapValue) ? n : (i.overlapValue = -i.overlapValue, i) : null
    };
    var a = function(t, e) {
        var n = 9999;
        this.box = {minimum: new BABYLON.Vector3(-n, t, -n),maximum: new BABYLON.Vector3(n, e, n),angle: 0,center: new BABYLON.Vector3(0, (t + e) / 2, 0)}, this.object = {getWorldMatrix: function() {
                return BABYLON.Matrix.Identity()
            },computeWorldMatrix: function() {
            },name: ""}, this.corner = [];
        for (var i = 4; i--; )
            this.corner.push(new BABYLON.Vector3);
        this.axis = [];
        for (var i = 2; i--; )
            this.axis.push(new BABYLON.Vector3);
        this.origin = [];
        for (var i = 2; i--; )
            this.origin.push(new BABYLON.Vector3);
        this.update()
    };
    a.prototype.overlaps1Way = r.prototype.overlaps1Way, a.prototype.worstOverlap = r.prototype.worstOverlap, a.prototype.overlaps = r.prototype.overlaps, a.prototype.showBox = r.prototype.showBox, a.prototype.update = r.prototype.update, i.prototype = Object.create(BaseComponent3D.prototype), i.prototype.initialize = function() {
        e || (e = wanaplan.engine3D.searchComponent("EditionComponent3D"))
    }, i.prototype.buildCollisionList = function(e) {
        var i = t.getFloor();
        if (n)
            for (; s.length; )
                s.shift().dispose();
        this.collisionList.length = 0;
        for (var o = function(t) {
            if (t.structure && (t.magnetismCollider = t.structure.magnetismCollider), t.magnetismCollider & (wnp.Constants.MAGNETISM.OBJECT | wnp.Constants.MAGNETISM.VERTICAL))
                t.getBoundingBox(!0), this.collisionList.push(new r(t));
            else if (-1 != t.name.indexOf("WallMesh_") && e.magnetismCollider & wnp.Constants.MAGNETISM.WALL)
                for (var n in t.boundingBoxes)
                    "OvertureStructure" !== t.objectInstances[n].name && "SubSlopeStructure" !== t.objectInstances[n].name && this.collisionList.push(new r(t, t.boundingBoxes[n]))
        }.bind(this), l = i.getChildren(), h = 0, c = l.length; c > h; h++)
            if (-1 != l[h].name.indexOf("group_")) {
                if (l[h].name != e.name)
                    for (var u = l[h].getChildren(), p = 0, d = u.length; d > p; p++)
                        o(u[p])
            } else
                o(l[h]);
        var m = t.getFloor().structure;
        this.collisionList.push(new a(m.elevation - 20, m.elevation + 5)), this.collisionList.push(new a(m.elevation + m.height, m.elevation + m.height + 20))
    }, i.prototype.updateCollisionList = function(t) {
        for (var e = 0, n = this.collisionList.length; n > e; e++)
            (!t || t && t == this.collisionList[e]) && this.collisionList[e].update()
    }, i.prototype.onContextChanged = function(t) {
        "3D" == t ? this.initialized || (e.on("selectObject", this.onDragStart.bind(this)), e.on("dragstart", this.onDragStart.bind(this)), e.on("dragging", this.onDragging.bind(this)), e.on("objectMoves", this.onDragging.bind(this))) : this.initialized && (e.off("selectObject", this.onDragStart.bind(this)), e.off("dragstart", this.onDragStart.bind(this)), e.off("dragging", this.onDragging.bind(this)), e.off("objectMoves", this.onDragging.bind(this)))
    }, i.prototype.onDragStart = function(e) {
        var n = -1 != e.object.name.indexOf("group_");
        if (n && (e.object.magnetismCollider = wnp.Constants.MAGNETISM.WALL), e.object.structure && (e.object.magnetismCollider = e.object.structure.magnetismCollider), e.object.magnetismCollider) {
            if (t.buildCollisionList(e.object), !n && e.object.magnetismCollider & (wnp.Constants.MAGNETISM.OBJECT | wnp.Constants.MAGNETISM.VERTICAL)) {
                t.currentCollisionBox = null;
                for (var i = 0; !t.currentCollisionBox && i < t.collisionList.length; )
                    t.collisionList[i].object == e.object && (t.currentCollisionBox = t.collisionList[i]), i++;
                t.collisionList.splice(i - 1, 1)
            } else
                t.currentCollisionBox = new r(e.object);
            t._lastPosition.copyFrom(e.object.position), t._lastFictivePosition.copyFrom(e.object.position)
        }
    }, i.prototype.lateralCollisionCandidate = function(e) {
        return t.currentCollisionBox.object.magnetismCollider & wnp.Constants.MAGNETISM.OBJECT && -1 == e.object.name.indexOf("WallMesh_") && e.object.magnetismCollider & wnp.Constants.MAGNETISM.OBJECT || t.currentCollisionBox.object.magnetismCollider & wnp.Constants.MAGNETISM.WALL && -1 != e.object.name.indexOf("WallMesh_")
    }, i.prototype.onDragging = function(n) {
        if (n.object.magnetismCollider) {
            var i = 1, o = 10;
            if (!t.currentCollisionBox)
                return void Logger.warning("L'événement DragStart n'a pas été correctement traité par le magnétisme 3D");
            t.currentCollisionBox.update();
            var r = -1, s = !1, a = 0;
            t._speedVector.copyFrom(t.currentCollisionBox.object.position).subtractInPlace(t._lastFictivePosition);
            for (var l = Math.abs(t._speedVector.y) > .1; (0 > r || r > i) && o > a; ) {
                r = 0;
                for (var h = 0, c = t.collisionList.length; c > h; h++)
                    if (!(t.collisionList[h].yRange[1] <= t.currentCollisionBox.yRange[0] || t.collisionList[h].yRange[0] >= t.currentCollisionBox.yRange[1]) && t.collisionList[h].overlaps(t.currentCollisionBox)) {
                        if (l && (t.currentCollisionBox.object.magnetismCollider & wnp.Constants.MAGNETISM.VERTICAL || "room" == t.collisionList[h].object.name)) {
                            if (t._lastFictivePosition.copyFrom(t.currentCollisionBox.object.position), t.solveCollision(t.collisionList[h], !0) < 5)
                                continue;
                            t._speedVector.y = Math.abs(t.currentCollisionBox.yRange[1] - t.collisionList[h].yRange[0]) <= Math.abs(t.currentCollisionBox.yRange[0] - t.collisionList[h].yRange[1]) ? t.collisionList[h].yRange[0] - t.currentCollisionBox.yRange[1] : t.collisionList[h].yRange[1] - t.currentCollisionBox.yRange[0], t.currentCollisionBox.object.position.addInPlace(t._speedVector);
                            break
                        }
                        if ("room" == t.collisionList[h].object.name)
                            continue;
                        if (t.lateralCollisionCandidate(t.collisionList[h]) && e.getSelectedObject() !== n.object) {
                            if (!s) {
                                var u = t.currentCollisionBox.object.rotation.y;
                                t.collisionList[h].object.name.indexOf("WallMesh_") >= 0 && t.angleMagnetism(t.currentCollisionBox, t.collisionList[h]);
                                for (var p = 0, d = t.collisionList.length; d > p; p++)
                                    if (h != p && t.lateralCollisionCandidate(t.collisionList[p]) && "room" != t.collisionList[p].object.name && t.collisionList[p].overlaps(t.currentCollisionBox) && t.solveCollision(t.collisionList[p], !0) > 5) {
                                        t.currentCollisionBox.object.rotation.y = u, t.currentCollisionBox.object.computeWorldMatrix(!0), t.currentCollisionBox.update();
                                        break
                                    }
                                s = !0
                            }
                            t._physicSpeedVector.copyFrom(t.currentCollisionBox.object.position).subtractInPlace(t._lastPosition), r = Math.max(t.solveCollision(t.collisionList[h], !1, t._physicSpeedVector), r)
                        }
                    }
                a++
            }
            0 >= r && t._lastFictivePosition.copyFrom(t.currentCollisionBox.object.position), a == o && t.currentCollisionBox.object.position.copyFrom(t._lastPosition), t._lastPosition.copyFrom(t.currentCollisionBox.object.position)
        }
    }, i.prototype.angleMagnetism = function(e, n) {
        for (var i = Math.PI / 1e3, o = 2 * Math.PI, r = e.object.structure && void 0 !== e.object.structure.preferredYAngle ? e.object.structure.preferredYAngle : 0, s = e.object.getChildren(), a = s.length - 1; a >= 0; a--)
            if ("selector" === s[a].name)
                return;
        var l = void 0 !== n.box.angle ? n.box.angle : n.object.rotation.y + Math.PI;
        l += Math.PI;
        var h = e.object.rotation.y, c = (t.core.engine3D.keyboardManager.isPressed([17, 91]), l % o), u = h % o;
        Math.abs(c - (u - r)) > o / 2 && (u > c ? c += o : u += o);
        var p = c - (u - r);
        Math.abs(p) > i && -1 == e.object.name.indexOf("group_") && (e.object.rotation.y += p, e.object.computeWorldMatrix(!0), e.update())
    }, i.prototype.solveCollision = function(e, n, i) {
        t._lastFictivePosition.copyFrom(t.currentCollisionBox.object.position);
        var o = t.currentCollisionBox.worstOverlap(e, i);
        if (o && o.overlapAxis) {
            var r = o.overlapAxis.clone().normalize().scaleInPlace(-o.overlapValue);
            return n || t.currentCollisionBox.object.position.addInPlace(r), t.currentCollisionBox.update(), r.length()
        }
        return 0
    };
    return i
}(), AvatarComponent3D = function() {
    var t, e = function(e) {
        BaseComponent3D.call(this, e, "AvatarComponent3D"), this.avatar = null, this.structure = this.core.getSelectedStructure(), this._avatarEnabled = !0, wanaplan.api.params.avatarEnabled === !1 && (this._avatarEnabled = !1), t = this, BABYLON.SceneLoader.ImportMesh("", wnp.Assets.globalPath + "js/Components/AvatarComponent/avatar/", "girl.babylon", e.engine3D.scene, function(n) {
            t.avatar = new BABYLON.Mesh("avatar", e.engine3D.scene), t.avatar.isVisible = !1;
            for (var i = 0, o = n.length; o > i; i++)
                n[i].parent = t.avatar, t._avatarEnabled ? (n[i].material.backFaceCulling = !1, n[i].receiveShadows = !0, e.engine3D.castShadows(n[i])) : n[i].isVisible = !1;
            t.avatar.position.y += 5;
            var r = wanaplan.getComponentByName("EditionComponent3D");
            r && r.addUnremovableDraggable(t.avatar)
        }), this.globalBoundingBox = this.core.configuration.boundingSize, this.onNewPlanReady = this.onNewPlanReady.bind(this), document.addEventListener("wnp.request.newPlanReady", this.onNewPlanReady, !1)
    };
    return e.prototype = Object.create(BaseComponent3D.prototype), e.prototype.onFloorSelected = function(t) {
        var e = t.structure;
        this.structure = e, "undefined" != typeof e.elevation && (this.avatar.position.y = e.elevation + 5)
    }, e.prototype.startListening = function() {
        this.onFloorSelected = this.onFloorSelected.bind(this), document.addEventListener("wnp.request.floorSelected", this.onFloorSelected, !1)
    }, e.prototype.stopListening = function() {
        document.removeEventListener("wnp.request.floorSelected", this.onFloorSelected, !1)
    }, e.prototype.onNewPlanReady = function() {
        this.structure = this.core.getSelectedStructure(), "undefined" != typeof this.structure.elevation && (this.avatar.position.y = this.structure.elevation + 5)
    }, e.prototype.setVisibility = function(t) {
        this._avatarEnabled && this.avatar.traverse(function(e) {
            e.isVisible = t
        })
    }, e.prototype.update = function() {
        this.avatar && (null == this.avatar || this.avatar.visible || (this.avatar.position.y = this.core.getSelectedStructure().elevation + 5), this.avatar.position.x = this.avatar.position.x < this.globalBoundingBox.min.x ? this.globalBoundingBox.min.x : this.avatar.position.x, this.avatar.position.z = this.avatar.position.z < this.globalBoundingBox.min.z ? this.globalBoundingBox.min.z : this.avatar.position.z, this.avatar.position.x = this.avatar.position.x > this.globalBoundingBox.max.x ? this.globalBoundingBox.max.x : this.avatar.position.x, this.avatar.position.z = this.avatar.position.z > this.globalBoundingBox.max.z ? this.globalBoundingBox.max.z : this.avatar.position.z)
    }, e
}();
FloorStructure = function() {
    var t = function() {
        BaseStructure.call(this, "FloorStructure"), this.label = "", this.points = [], this.walls = [], this.overtures = [], this.internalRooms = [], this.externalRooms = [], this.objects = [], this.stairways = [], this.hoppers = [], this.subslopes = [], this.SubSlopeOverture = [], this.elevation = 0, this.height = 250, this.needsUpdate = !0, this.dirtyGeometry = !0
    };
    return t.prototype = new BaseStructure, t.prototype.dirty = function() {
        this.dirtyGeometry = !0
    }, t.prototype.tidy = function() {
        this.dirtyGeometry = !1
    }, t.prototype.isDirty = function() {
        return this.dirtyGeometry
    }, t.prototype.serialize = function() {
        var t = {"class": {name: "FloorStructure"}};
        return ujs.serializeObject(this, t, ["id", "name", "label", "elevation", "height", "internalRooms", "externalRooms", "points", "walls", "overtures", "objects", "stairways", "hoppers"]), t
    }, t.prototype.deserialize = function(t) {
        return ujs.deserializeObject(t, this, ["id", "name", "label", "elevation", "height", "internalRooms", "externalRooms", "points", "walls", "overtures", "objects", "stairways", "hoppers"]), this
    }, t.prototype.updateReferences = function() {
        for (var t = this, e = [this.points, this.walls, this.overtures, this.internalRooms, this.externalRooms, this.objects], n = function(e) {
            for (var n = 0, i = e.length; i > n; n++)
                e[n].updateReferences(t)
        }, i = function(e) {
            for (var n = e.length - 1; n >= 0; n--)
                e[n].checkCoherence && e[n].checkCoherence(t)
        }, o = 0, r = e.length; r > o; o++)
            n(e[o]), i(e[o]);
        for (var o = 0, r = this.walls.length; r > o; o++)
            this.walls[o].getPolygon(this), this.walls[o].update(this)
    }, t.prototype.insertElement = function(t, e) {
        this[t] || (this[t] = []);
        var n = !1;
        for (var i in this[t])
            if (this[t][i] == e) {
                n = !0;
                break
            }
        n || (e.id = this[t].length, this[t].push(e))
    }, t.prototype.getElements = function(t) {
        return this[t] ? this[t] : []
    }, t.prototype.getElementByIdentifier = function(t, e, n) {
        for (var i = this.getElements(e), n = n || "id", o = 0; o < i.length; o++)
            if (i[o][n] == t)
                return i[o];
        return null
    }, t.prototype.removeElement = function(t, e) {
        if (this[t]) {
            var n = 0;
            for (var i in this[t])
                if (this[t][i] == e) {
                    this[t].splice(i, 1), n = i;
                    break
                }
            this.reindexElements(this[t], n)
        }
    }, t.prototype.replaceElements = function(t, e) {
        this[t] = [].concat(e), this.reindexElements(this[t], 0)
    }, t.prototype.clone = function() {
        var e = this.serialize(), n = new t;
        return n.deserialize(e), n.label = "", n
    }, t.prototype.reindexElements = function(t, e) {
        for (var e = e || 0, n = e; n < t.length; n++)
            t[n].id = n
    }, t
}();
var FloorComponent3D = function() {
    var t = null, e = function(e) {
        BaseComponent3D.call(this, e, "FloorComponent3D"), this._floors = [], this.priority = 1, this._current = 0, t = this, this.onNewPlanReady = this.onNewPlanReady.bind(this), document.addEventListener("wnp.request.newPlanReady", this.onNewPlanReady)
    };
    return e.prototype = new BaseComponent3D, e.prototype.compute = function() {
    }, e.prototype.startListening = function() {
        this.onSelectFloor = this.onSelectFloor.bind(this), this.onDeleteFloor = this.onDeleteFloor.bind(this), document.addEventListener("wnp.request.floorSelected", this.onSelectFloor), document.addEventListener("wnp.request.floorDeleted", this.onDeleteFloor)
    }, e.prototype.stopListening = function() {
        document.removeEventListener("wnp.request.floorSelected", this.onSelectFloor), document.removeEventListener("wnp.request.floorDeleted", this.onDeleteFloor)
    }, e.prototype.onContextChanged = function(t) {
        "3D" == t ? (this.startListening(), this.createFloor()) : this.stopListening()
    }, e.prototype.onSelectFloor = function(t) {
        var e = t.id;
        this.createFloor(+e > +this._current ? this._current : e), this._current = e
    }, e.prototype.onDeleteFloor = function(t) {
        this.deleteFloor({id: t.id})
    }, e.prototype.onNewPlanReady = function() {
        for (var t = wanaplan.engine3D.scene.meshes.slice(0), e = t.length - 1; e >= 0; e--)
            "structure" == t[e].type && t[e].dispose();
        return !0
    }, e.prototype.deleteFloor = function(t) {
        for (var e = wanaplan.engine3D.scene.meshes.slice(0), n = e.length - 1; n >= 0; n--)
            e[n].name && -1 != e[n].name.indexOf("FloorMesh") && e[n].structureId >= t.id && e[n].dispose()
    }, e.prototype.getFloor = function(t) {
        for (var t = t || wanaplan.getSelectedStructure(), e = "FloorMesh_" + t.id, n = 0; n < wanaplan.engine3D.scene.meshes.length; n++)
            if (wanaplan.engine3D.scene.meshes[n].name == e)
                return wanaplan.engine3D.scene.meshes[n];
        return null
    }, e.prototype.createFloor = function(t) {
        var e, t = t || 0, n = +wanaplan.getSelectedStructure().id || 0;
        this._current = n;
        for (var i = n + 1; i < this.structure.getLength(); i++)
            e = this.structure.getElement(i), this.deleteFloor(e);
        for (var o = t; n >= o; o++)
            if (e = this.structure.getElement(o), this.deleteFloor(e), e instanceof FloorStructure) {
                var r = this.createFloorMesh(e);
                r.position.y = e.elevation, r.computeWorldMatrix(), ujs.notify("wnp.engine3d.floorReady", {floor: r,structure: e})
            }
        ujs.notify("wnp.engine3d.globaleFloorReady", {maxFloorId: n}), this.initialized = !0
    }, e.prototype.createFloorMesh = function(t) {
        var e = new BABYLON.Mesh("FloorMesh_" + t.id, wanaplan.engine3D.scene);
        return e.isVisible = !1, e.structureId = t.id, e.structure = t, e.id = t.id, e.type = "structure", e
    }, e
}(), FloorController = function() {
    var t = null, e = function(e) {
        BaseComponent2D.call(this, e, "FloorController"), this._dragging = !1, this.core = e, t = this
    };
    return e.prototype = new BaseComponent2D, e.prototype.update = function() {
        wanaplan.getSelectedStructure().isDirty() && this.updateHTML()
    }, e.prototype.initialize = function() {
        this.updateHTML(), this.startListening();
        ({context: "2D",values: [{type: "checkbox",label: _("Display the lower floor"),eventParams: {eventName: "wnp.request.object.seeBottomFloor",cast: "int"}}]})
    }, e.prototype.startListening = function() {
        document.addEventListener("wnp.structure.locale.loaded", this.updateHTML)
    }, e.prototype.stopListening = function() {
        document.removeEventListener("wnp.structure.locale.loaded", this.updateHTML)
    }, e.prototype.updateHTML = function() {
        t.removeHTML();
        var e = t.buildHTML();
        document.getElementById("modalWidgets").appendChild(e)
    }, e.prototype.removeHTML = function() {
        (fcElement = document.getElementById("floor-controller")) && document.getElementById("modalWidgets").removeChild(fcElement)
    }, e.prototype.buildHTML = function() {
        var e = document.createElement("div");
        e.setAttribute("id", "floor-controller"), e.setAttribute("style", "top: 10px;left: 10px;position:absolute;");
        for (var n = this.core.structure.getCurrentStructure() ? this.core.structure.getCurrentStructure().id : 0, i = 0; i < this.core.structure.getLength(); i++) {
            var o = this.structure.getElement(i);
            if (o instanceof FloorStructure) {
                var r = document.createElement("a");
                if (r.setAttribute("rel", i), r.setAttribute("draggable", !0), r.setAttribute("class", "floor-item"), i == n && ujs.addClass(r, "selected"), r.innerHTML = o.label ? o.label : 0 == i ? _("GND") : _("Floor") + " " + i, r.setAttribute("title", r.innerHTML), r.addEventListener("click", this.onItemClick, !1), r.addEventListener("dragstart", function(e) {
                    e.dataTransfer.setData("Text", this.id), t._dragging = this.getAttribute("rel")
                }, !0), r.addEventListener("dragover", function(t) {
                    this.classList.add("dragover"), t.preventDefault()
                }), r.addEventListener("dragleave", function() {
                    this.classList.remove("dragover")
                }), r.addEventListener("drop", function(e) {
                    var n = this.getAttribute("rel");
                    this.classList.remove("dragover"), t.insertFloorBefore(t._dragging, n), t.updateHTML(), e.preventDefault()
                }), e.appendChild(r), !this.core.engine3D.isViewer) {
                    var s = document.createElement("div");
                    s.setAttribute("class", "settings"), s.setAttribute("title", _("Change settings")), s.setAttribute("rel", i), s.innerHTML = "i", s.addEventListener("click", this.onItemContextMenu, !0), r.appendChild(s);
                    var a = document.createElement("div");
                    a.setAttribute("class", "delete"), a.setAttribute("title", _("Remove this floor")), a.setAttribute("rel", i), a.innerHTML = "x", a.addEventListener("click", this.onItemDelete, !1), r.appendChild(a)
                }
            }
        }
        if (!this.core.engine3D.isViewer) {
            var l = document.createElement("div");
            l.setAttribute("class", "floor-item"), l.innerHTML = _("+ add"), l.addEventListener("click", this.onAddItemClick), e.appendChild(l)
        }
        return e
    }, e.prototype.insertFloorBefore = function(e, n) {
        var i = this.structure.getElement(e);
        this.structure.removeElement(i), this.structure.addMemberAtIndex(n, i);
        for (var o = 0, r = 0; r < wanaplan.structure.getLength(); r++) {
            var i = t.structure.getElement(r);
            i instanceof FloorStructure && (i.elevation = o, o += i.height)
        }
        this.selectFloor(n)
    }, e.prototype.onItemClick = function() {
        (id = this.getAttribute("rel")) && t.selectFloor(id)
    }, e.prototype.onItemContextMenu = function(e) {
        if (id = this.getAttribute("rel")) {
            var n = wanaplan.structure.getElement(id), i = [{name: "label",label: _("Name"),type: "text",cast: "string",value: n.label}, {name: "height",label: _("Height"),type: "number",cast: "int",unit: "cm",value: {min: 5,max: 500,step: 1,value: n.height}}];
            wanaplan.engine2D.displayContextMenu(i, n, t.onContextMenuPropertyChanged.bind(t))
        }
        e.stopPropagation()
    }, e.prototype.onContextMenuPropertyChanged = function(t, e, n) {
        if (t.hasOwnProperty(e)) {
            var i = t[e];
            if (t[e] = n, "height" == e) {
                for (var o = 0; o < t.walls.length; o++)
                    (t.walls[o].height > t.height || t.walls[o].height == i) && (t.walls[o].height = t.height);
                this.core.structure.updateFloorElevations(), ujs.notify("wnp.request.floorSelected", {id: this.core.getSelectedStructure().id,structure: this.core.getSelectedStructure()})
            }
        }
        this.updateHTML(), this.core.engine2D.requestStaticDraw()
    }, e.prototype.onItemDelete = function(e) {
        if (confirm(_("confirm the deletion")) && !(wanaplan.structure.getLength() <= 1)) {
            if (id = this.getAttribute("rel")) {
                var n = wanaplan.structure.getElement(id);
                wanaplan.structure.removeElement(n);
                for (var i = 0, o = 0; o < wanaplan.structure.getLength(); o++) {
                    var r = t.structure.getElement(o);
                    r instanceof FloorStructure && (r.elevation = i, i += r.height)
                }
                ujs.notify("wnp.request.floorDeleted", {id: id}, !0), t.selectFloor(0 == id ? id : id - 1)
            }
            e.stopPropagation()
        }
    }, e.prototype.onAddItemClick = function() {
        var e = '<form id="addFloorOptions">' + _("The following items will be duplicated") + '<table style="width:100%;">';
        e += "<tr>", e += '<td><input type="checkbox" name="duplicateOptions[]" value="walls" checked="checked" /></td>', e += "<td>" + _("Walls") + "</td>", e += "</tr>", e += "<tr>", e += '<td><input type="checkbox" name="duplicateOptions[]" value="overtures" checked="checked" /></td>', e += "<td>" + _("Windows") + "</td>", e += "</tr>", e += "<tr>", e += '<td><input type="checkbox" name="duplicateOptions[]" value="cloisons" /></td>', e += "<td>" + _("Bulkheads") + "</td>", e += "</tr>", e += "<tr>", e += '<td><input type="checkbox" name="duplicateOptions[]" value="stairways" /></td>', e += "<td>" + _("Stairways") + "</td>", e += "</tr>", e += "<tr>", e += '<td><input type="checkbox" name="duplicateOptions[]" value="objects" /></td>', e += "<td>" + _("Objects") + "</td>", e += "</tr>", e += "</table></form>";
        var n = {title: _("Create a new floor"),message: e,y: 30,x: 10,buttonA: !0,buttonB: !0,buttonBText: _("Create"),buttonAText: _("Cancel"),onClickB: function(e) {
                for (var n = document.getElementsByName("duplicateOptions[]"), i = [], o = 0; o < n.length; o++)
                    n[o].checked && i.push(n[o].value);
                return t.onAddItemConfirm(e, i), !0
            }};
        wnp.UI.MessageBox.show(n)
    }, e.prototype.onAddItemConfirm = function(e, n) {
        var i = t.duplicateForFloor(n);
        if (i.id > 0) {
            var o = wanaplan.structure.getElement(i.id - 1);
            i.elevation = o.elevation + o.height
        }
        var r = function() {
            t.selectFloor(i.id)
        };
        ujs.notify("wnp.request.floorAdded", {id: i.id,callback: r}, !0)
    }, e.prototype.duplicateForFloor = function(t) {
        var t = t || [], e = wanaplan.structure.getCurrentStructure(), n = e.clone();
        wanaplan.structure.addElement(n), n.updateReferences(wanaplan.structure), n.hoppers = [];
        for (var i = 0, o = n.walls.length; o > i; i++)
            n.walls[i].materials = {}, n.walls[i].subSlopes = [];
        for (var r = n.internalRooms.concat(n.externalRooms), i = 0, o = r.length; o > i; i++)
            r[i].panesMaterials = {}, r[i].materials = {};
        if (n.subslopes = [], -1 == t.indexOf("objects") && (n.objects = []), -1 == t.indexOf("stairways") && (n.stairways = []), -1 == t.indexOf("walls")) {
            for (var i = n.walls.length - 1; i >= 0; i--) {
                var s = n.walls[i];
                s.remove(n)
            }
            n.externalRooms.length = 0, n.internalRooms.length = 0
        } else if (-1 == t.indexOf("cloisons"))
            for (var i = n.walls.length - 1; i >= 0; i--) {
                var s = n.walls[i];
                (s.type != s.TYPE_NORMAL || s.thickness < 15) && s.remove(n)
            }
        if (-1 == t.indexOf("overtures")) {
            n.overtures = [];
            for (var i = n.walls.length - 1; i >= 0; i--) {
                var s = n.walls[i];
                s.overtures.length = 0
            }
        } else
            for (var i = n.overtures.length - 1; i >= 0; i--) {
                var a = n.overtures[i];
                0 == a.elevation && a.remove(n)
            }
        return n
    }, e.prototype.onSelectFloor = function(e) {
        e.id > -1 && t.selectFloor(e.id)
    }, e.prototype.selectFloor = function(e) {
        wanaplan.structure.setCurrentStructureIndex(e), wanaplan.structure.members[e].dirty(), wanaplan.engine2D.update(!0), wanaplan.engine2D.requestStaticDraw(), t.updateHTML();
        var n = wanaplan.getComponentByName("HistoryComponent");
        n && n.reset(), ujs.notify("wnp.request.floorSelected", {id: e,structure: wanaplan.structure.getCurrentStructure()}, !0)
    }, e
}(), PointStructure = function() {
    var t = function() {
        BaseStructure.call(this, "PointStructure"), this.position = new BABYLON.Vector2(0, 0), this.attachedTo = null, this.needsUpdate = !0, this.parents = [], this._parentIds = null
    };
    return t.prototype = new BaseStructure, t.prototype.serialize = function() {
        this.position.x = Math.round(10 * this.position.x) / 10, this.position.y = Math.round(10 * this.position.y) / 10;
        for (var t = {"class": {name: "PointStructure"},_parentIds: []}, e = 0, n = this.parents.length; n > e; e++)
            t._parentIds.push(this.parents[e].id);
        return ujs.serializeObject(this, t, ["name", "id", "position"]), t
    }, t.prototype.deserialize = function(t) {
        ujs.deserializeObject(t, this, ["name", "id", "position"]), this._parentIds = t._parentIds
    }, t.prototype.checkCoherence = function() {
    }, t.prototype.updateReferences = function(t) {
        this.parents.length = 0;
        for (var e = 0, n = this._parentIds.length; n > e; e++)
            for (var i = 0, o = t.walls.length; o > i; i++)
                t.walls[i].id == this._parentIds[e] && this.parents.push(t.walls[i]);
        delete this._parentIds
    }, t.Deserialize = function(e) {
        var n = new t;
        return n.deserialize(e), n
    }, t.prototype.update = function(t) {
        this.tryMerge(t).tryAttach(t)
    }, t.prototype.translate = function(t) {
        this.position.addInPlace(t)
    }, t.prototype.remove = function(t) {
        this.unAttach(), void 0 != t && t.removeElement("points", this)
    }, t.prototype.replaceParent = function(t, e) {
        var n = this.parents.indexOf(t);
        -1 != n && this.parents.splice(n, 1), void 0 !== e && this.parents.push(e)
    }, t.prototype.tryMerge = function(t) {
        if (!this.parents[0])
            return this;
        if (this.parents[0] && this.parents[1])
            return this;
        for (var e = 15, n = t.getElements("points"), i = 0, o = n.length; o > i; i++)
            if (n[i] !== this && !(this.position.distanceTo(n[i].position) > e || n[i].parents[0] && n[i].parents[1])) {
                var r, s;
                if (r = this.wallAttached(t), s = n[i].wallAttached(t), !r && !s || r == n[i].parents[0] && s == this.parents[0]) {
                    n[i].parents.push(this.parents[0]);
                    var a = this.parents[0].points.indexOf(this);
                    this.parents[0].points[a] = n[i], n[i].unAttach(), this.unAttach();
                    var l = n[i];
                    return this.remove(t), l.parents[0].update(t), l
                }
            }
        return this
    }, t.prototype.forceMerge = function(t, e) {
        if (this.parents[0]) {
            var n = t.parents[0];
            n && (this.parents.push(n), n.points[n.points.indexOf(t)] = this), this.unAttach(e), t.unAttach(e), t.remove(e), t.parents.length = 0, this.parents[0].needsUpdate = !0, this.parents[1] && (this.parents[1].needsUpdate = !0)
        } else
            t.position.lerp(this.position, .5), t.unAttach(e), t.needsUpdate = !0
    }, t.prototype.tryAttach = function(t, e) {
        if (!this.parents[0])
            return !1;
        if (this.parents[0] && this.parents[1])
            return !1;
        if (this.isAttached(t))
            return !1;
        for (var n, i = 5, o = t.getElements("walls"), r = [], s = null, a = 0, l = o.length; l > a; a++)
            if ((void 0 === e || e !== o[a]) && o[a] != this.parents[0] && o[a] != this.parents[1] && this.parents[0] && (n = this.parents[0].points[(this.parents[0].points.indexOf(this) + 1) % 2], o[a] != n.wallAttached(t) && o[a].points[0].wallAttached(t) !== this.parents[0] && o[a].points[1].wallAttached(t) !== this.parents[0])) {
                var h = o[a].distanceFromRect(this.position, 0, t);
                if (!(h > i + o[a].thickness)) {
                    var c = o[a].getNearestPointOnRect(this.position, 0, t), u = o[a].getPoints(0).position.subtract(c), p = o[a].getPoints(1).position.subtract(c), d = u.lengthSquared() > p.lengthSquared() ? u : p;
                    r.push({wall: o[a],vector: d.normalize()})
                }
            }
        if (n) {
            for (var m = -1, g = n.position.subtract(this.position).normalize(), a = 0, l = r.length; l > a; a++) {
                var f = g.dot(r[a].vector);
                f >= m && (s = r[a].wall, m = f)
            }
            return s ? (s.attachedPoints.push(this), this.attachedTo = s, this.position = s.getNearestPointOnPolygon(this.position), s.needsUpdate = !0, this.parents[0].needsUpdate = !0, !0) : !1
        }
    }, t.prototype.isAttached = function() {
        return null != this.attachedTo
    }, t.prototype.wallAttached = function() {
        return this.attachedTo
    }, t.prototype.unAttach = function() {
        return this.attachedTo ? (this.attachedTo.attachedPoints.splice(this.attachedTo.attachedPoints.indexOf(this), 1), this.attachedTo = null, !0) : !1
    }, t
}(), PointComponent2D = function() {
    var t = function(t) {
        BaseComponent2D.call(this, t, "PointComponent2D"), this._SIZE = 13, this._ANGLERADIUS = 55, this.anglePointList = [], this.dragging = !1, wanaplan.engine2D.registerEventCb("PointComponent2D.double-click", this.priority, "double-click", wanaplan.engine2D.MODE_NORMAL, PointStructure, this.onDoubleClick.bind(this), null), wanaplan.engine2D.registerEventCb("PointComponent2D.hover", this.priority, "hover", wanaplan.engine2D.MODE_NORMAL | wanaplan.engine2D.MODE_DRAW, PointStructure, this.onHover.bind(this), null), wanaplan.engine2D.registerEventCb("PointComponent2D.leave", this.priority, "leave", wanaplan.engine2D.MODE_NORMAL | wanaplan.engine2D.MODE_DRAW, PointStructure, this.onLeave.bind(this), null), wanaplan.engine2D.registerEventCb("PointComponent2D.dragstart", this.priority, "drag-start", wanaplan.engine2D.MODE_NORMAL, PointStructure, this.onDragStart.bind(this), null), this.priority = 90
    };
    return t.prototype = new BaseComponent2D, BaseComponent2D.prototype.getTargeted = function(t) {
        var e = this.structure.getCurrentStructure(), n = e.getElements("points"), i = null;
        for (var o in n)
            n[o].position.distanceTo(t) < this._SIZE + 5 && (null == i ? i = n[o] : !i.isAttached(e) && n[o].isAttached(e) && (i = n[o]));
        return i
    }, t.prototype.update = function() {
        this.tryMergeAttachAll()
    }, t.prototype.tryMergeAttachAll = function(t) {
        for (var e = this.structure.getCurrentStructure(), n = e.getElements("points"), i = n.length - 1; i >= 0; i--)
            (n[i].needsUpdate || t) && (n[i].needsUpdate = !1, n[i].update(e), e.dirty())
    }, t.prototype.drawAngle = function(t, e, n, i) {
        var o, r, s, a;
        if (2 === i.parents.length)
            o = i.parents[0], r = i.parents[1], s = 0 === o.points.indexOf(i) ? o.getWallVector() : o.getWallVector().scaleInPlace(-1), a = 0 === r.points.indexOf(i) ? r.getWallVector() : r.getWallVector().scaleInPlace(-1);
        else {
            if (1 !== i.parents.length || null == i.attachedTo)
                return;
            o = i.parents[0], r = i.attachedTo, s = 0 === o.points.indexOf(i) ? o.getWallVector() : o.getWallVector().scaleInPlace(-1), a = r.getWallVector(), s.dot(a) < 0 && a.scaleInPlace(-1)
        }
        var l = s.dot(a) / (s.length() * a.length()), h = s.determinant(a) / (s.length() * a.length()), c = Math.acos(BABYLON.Math.clamp(l, -1, 1)) * (h > 0 ? 1 : -1), u = BABYLON.Math.NormalizeAngle(Math.atan2(s.y, s.x), !0);
        wanaplan.engine2D.symbols2D.drawAngle(t, {x: e.x + n * i.position.x,y: e.y + n * i.position.y}, n, this._ANGLERADIUS, u, u + c, 0 > h)
    }, t.prototype.onDynamicDraw = function(t, e, n, i) {
        var o = {x: e.x + i.position.x * n,y: e.y + i.position.y * n};
        wanaplan.engine2D.symbols2D.drawPointHover(t, o, n);
        for (var r = 0, s = this.anglePointList.length; s > r; r++)
            this.drawAngle(t, e, n, this.anglePointList[r])
    }, t.prototype.onDragStart = function(t, e) {
        if (e) {
            e.unAttach(this.structure.getCurrentStructure()), this.anglePointList.push(e);
            for (var n = 0, i = e.parents.length; i > n; n++)
                for (var o = 0, r = e.parents[n].points.length; r > o; o++)
                    e.parents[n].points[o] !== e && this.anglePointList.push(e.parents[n].points[o])
        }
        return this.dragging = !0, wanaplan.engine2D.registerEventCb("PointComponent2D.dragging", this.priority, "dragging", wanaplan.engine2D.MODE_DRAG, null, this.onDragging.bind(this), e), wanaplan.engine2D.registerEventCb("PointComponent2D.drag-end", this.priority, "drag-end", wanaplan.engine2D.MODE_DRAG, null, this.onDragEnd.bind(this), e), wanaplan.engine2D.registerEventCb("PointComponent2D.drag.hover", this.priority, "hover", wanaplan.engine2D.MODE_DRAG, PointStructure, this.onHover.bind(this), e), wanaplan.engine2D.registerEventCb("PointComponent2D.drag.leave", this.priority, "leave", wanaplan.engine2D.MODE_DRAG, PointStructure, this.onLeave.bind(this), e), !1
    }, t.prototype.onDragging = function(t, e, n, i) {
        0 == i.parents.length && this.onDragEnd(), i.position.copyFrom(n.planPos);
        for (var o = 0, r = i.parents.length; r > o; o++)
            i.parents[o] && (i.parents[o].needsUpdate = !0);
        wanaplan.engine2D.requestStaticDraw()
    }, t.prototype.onDragEnd = function(t, e, n, i) {
        if (this.anglePointList.length = 0, this.dragging = !1, i) {
            var o = this.structure.getCurrentStructure();
            i.unAttach(o);
            var r = i.tryMerge(o);
            r === i && i.tryAttach(o);
            var s = [r.parents[0], r.parents[1]], a = o.getElements("walls");
            s[0] && -1 != a.indexOf(s[0]) && (s[0] = s[0].tryMerge(o)), s[1] && -1 != a.indexOf(s[1]) && (s[1] = s[1].tryMerge(o)), s[0] && -1 != a.indexOf(s[0]) && s[0].splitAtIntersections(o), s[1] && -1 != a.indexOf(s[1]) && s[1].splitAtIntersections(o), wanaplan.getComponentByName("WallComponent2D").update(), wanaplan.getComponentByName("WallComponent2D").simplifyWalls(), this.update(), o.dirty(), wanaplan.engine2D.requestStaticDraw(), wanaplan.engine2D.unregisterEventCb("PointComponent2D.drag.hover"), wanaplan.engine2D.unregisterEventCb("PointComponent2D.drag.leave"), wanaplan.getComponentByName("WallComponent2D").update()
        }
    }, t.prototype.onHover = function(t, e, n, i) {
        var e = i || e;
        return this.dragging || this.anglePointList.push(e), wanaplan.engine2D.registerEventCb("PointComponent2D.dynamic-draw", this.priority, "dynamic-draw", null, null, this.onDynamicDraw.bind(this), e), wanaplan.engine2D.requestDynamicDraw(), !1
    }, t.prototype.onLeave = function(t, e, n, i) {
        this.dragging || (this.anglePointList.length = 0, wanaplan.engine2D.unregisterEventCb("PointComponent2D.dynamic-draw")), wanaplan.engine2D.requestDynamicDraw()
    }, t.prototype.onDoubleClick = function(t, e, n) {
        var i = wanaplan.getSelectedStructure(), o = wanaplan.getComponentByName("WallComponent2D", wanaplan.ENGINE_2D);
        if (e.isAttached(i)) {
            var r = e.wallAttached(i);
            n.planPos = e.position.clone(), o.onDoubleClick(t, r, n, null)
        } else {
            if (n.modifiers != n.MODIFIER_SHIFT)
                return;
            var r = null;
            for (var s in e.parents)
                e.parents[s] instanceof WallStructure && (r = e.parents[s]);
            o.onAddWall({wallType: r.type,thickness: r.thickness,putPoint: !0})
        }
        i.dirty()
    }, t
}(), Graph = function() {
    var t = function(t) {
        this.position = t, this.neighbors = [], this.parents = [], this.parentWallSide = [], this.visited = !1
    };
    t.prototype.connect = function(t, e) {
        t && (this.neighbors.push(t), this.parents[0] == t.parents[0] || e || (this.parents.push(t.parents[0]), this.parentWallSide.push(t.parentWallSide[0])))
    };
    var e = function() {
        this.nodes = []
    };
    return e.prototype.mergeNodes = function() {
        for (var t = function(t, e, n) {
            for (var i = n.length - 1; i >= 0; i--)
                for (var o = 0; 2 > o; o++)
                    n[i].neighbors[o] == t && (n[i].neighbors[o] = e)
        }, e = .01, n = this.nodes.length - 1; n >= 0; n--)
            for (var i = 0; n > i; i++)
                if (!(this.nodes[n].position.distanceTo(this.nodes[i].position) > e)) {
                    if (!(this.nodes[n].neighbors.length > 1 || this.nodes[i].neighbors.length > 1)) {
                        if (2 == this.nodes[n].parents[0].type || 2 == this.nodes[i].parents[0].type) {
                            var o = new BABYLON.Vector3;
                            o.subVectors(this.nodes[n].neighbors[0].position, this.nodes[n].position).normalize();
                            var r = new BABYLON.Vector3;
                            r.subVectors(this.nodes[i].neighbors[0].position, this.nodes[i].position).normalize();
                            var s = o.add(r).add(this.nodes[n].position), a = this.nodes[n].parents[0].vectorTo(s), l = this.nodes[i].parents[0].vectorTo(s);
                            if (Math.sign(a.dot(this.nodes[n].parentWallSide[0])) != Math.sign(l.dot(this.nodes[i].parentWallSide[0])))
                                continue
                        }
                        var h = this.nodes.splice(n, 1);
                        this.nodes[i].connect(h[0].neighbors[0], !0), this.nodes[i].parents.push(h[0].parents[0]), this.nodes[i].parentWallSide.push(h[0].parentWallSide[0]), t(h[0], this.nodes[i], this.nodes);
                        break
                    }
                    Logger.warning("Tentative de fusion de 3 points")
                }
    }, e.prototype.processMissingConnections = function() {
        for (var t = 50, e = this.nodes.length - 1; e >= 0; e--)
            if (!(this.nodes[e].neighbors.length > 1))
                for (var n = 0; e > n; n++)
                    if (!(this.nodes[e].position.distanceTo(this.nodes[n].position) > t || this.nodes[n].neighbors.length > 1)) {
                        this.nodes[e].connect(this.nodes[n]), this.nodes[n].connect(this.nodes[e]);
                        break
                    }
    }, e.prototype.createFromWalls = function(e, n) {
        n = n || e;
        for (var i, o, r, s, a, l, h, c, u = e.getElements("walls"), p = function(e, n, r) {
            if (e.length < 2)
                return Logger.warning("Erreur de structure des intersections"), null;
            for (var s, a, l = [], h = 0, c = e.length; c > h; h++)
                l.push(new t(e[h]));
            for (var h = 0, c = l.length; c > h; h++)
                s = l[h], l[h + 1] && (l[h].position.entersWall || -.5) < (l[h + 1].position.entersWall || .5) && (a = l[h + 1], s.neighbors.push(a), a.neighbors.push(s), s.parents.push(n), a.parents.push(n), s.parentWallSide.push(r), a.parentWallSide.push(r), this.nodes.push(s), this.nodes.push(a)), 0 == h && (i = s), h == c - 1 && (o = s);
            return {f: i,l: o}
        }, d = 0, m = u.length; m > d; d++)
            r = u[d].getIntersections(e), c = p.call(this, r.a, u[d], u[d].getNormalVector(1)), s = c.f, l = c.l, c = p.call(this, r.b, u[d], u[d].getNormalVector(-1)), a = c.f, h = c.l, 1 != u[d].points[0].parents.length || u[d].points[0].wallAttached(e) || s && (s.connect(a), a.connect(s)), 1 != u[d].points[1].parents.length || u[d].points[1].wallAttached(e) || l && (l.connect(h), h.connect(l));
        this.mergeNodes(), this.processMissingConnections()
    }, e.prototype.createCycles = function() {
        for (var t = [], e = function(t) {
            var e = [];
            e.push(t), t.visited = !0;
            for (var n, i = t.neighbors[0], o = t, r = 0; i.position != e[0].position; ) {
                if (e.push(i), i.visited = !0, n = i.neighbors.indexOf(o), -1 == n)
                    return Logger.warning("Erreur dans la structure du graphe"), null;
                if (o = i, i = i.neighbors[(n + 1) % 2], r++, r > 250 || null == i)
                    return null
            }
            return e
        }, n = 0, i = this.nodes.length; i > n; n++)
            if (!this.nodes[n].visited) {
                var o = e(this.nodes[n]);
                o && t.push(o)
            }
        return t
    }, e
}();
WallStructure = function() {
    var t = function() {
        BaseStructure.call(this, "WallStructure"), this.points = [new PointStructure, new PointStructure], this._edgePolygons = [[], []], this.attachedPoints = [], this.overtures = [], this.height = 250, this.thickness = 30, this.measureDist = 15, this.measureDisplayed = !0, this.materials = {}, this.subSlopes = [], this.needsUpdate = !0, this.instance = "virtual", this.TYPE_NORMAL = 1, this.TYPE_SEPARATOR = 2, this.type = this.TYPE_NORMAL, this._pointsIds = [], this._attachedPointsIds = [], this._overturesIds = []
    };
    return t.prototype = new BaseStructure, t.prototype.serialize = function() {
        for (var t = {"class": {name: "WallStructure"},_pointsIds: [],_attachedPointsIds: [],_overturesIds: []}, e = 0, n = this.points.length; n > e; e++)
            t._pointsIds.push(this.points[e].id);
        for (var e = 0, n = this.attachedPoints.length; n > e; e++)
            t._attachedPointsIds.push(this.attachedPoints[e].id);
        for (var e = 0, n = this.overtures.length; n > e; e++)
            t._overturesIds.push(this.overtures[e].id);
        return ujs.serializeObject(this, t, ["id", "type", "name", "instance", "height", "thickness", "measureDist", "measureDisplayed", "subSlopes"]), t
    }, t.prototype.deserialize = function(t) {
        ujs.deserializeObject(t, this, ["id", "type", "name", "instance", "height", "thickness", "measureDist", "materials", "measureDisplayed", "subSlopes", "_overturesIds", "_pointsIds", "_attachedPointsIds"]), this.thickness = Math.max(.1, this.thickness)
    }, t.prototype.checkCoherence = function(t) {
        if (this.points.length < 2)
            this.remove(t);
        else if (this.getLength() < 5)
            this.remove(t);
        else {
            var e = this.points[0], n = this.points[1];
            (Math.abs(e.position.x) > 5e3 || Math.abs(e.position.y) > 5e3) && (Math.abs(n.position.x) > 5e3 || Math.abs(n.position.y) > 5e3) && this.remove(t)
        }
    }, t.prototype.computeDefault = function(t) {
        var e = this.getNormalVector(this.thickness / 2), n = this.getPoints(t).position, i = n.add(e), o = (n.clone(), n.subtract(e));
        this._edgePolygons[t] = 0 == t ? [i, o] : [o, i]
    }, t.prototype.computeWeak = function(t) {
        this.computeDefault(t);
        var e = 0 == t ? -1 : 1;
        this._edgePolygons[t][1].addInPlace(this.getWallVector().normalize().scaleInPlace(e * this.getPoints(t).attachedTo.thickness / 4))
    }, t.prototype.computeStrong = function(t) {
        var e = Math.PI / 16, n = function(t, n, i, o) {
            return BABYLON.Vector2.Intersect(t, n, i, o, e)
        }, i = this.getAxis(t), o = i[0], r = i[1], s = this.getPoints(t), a = s.parents.indexOf(this), l = s.parents[(a + 1) % 2], h = l.points.indexOf(s);
        if (!l)
            return void Logger.warning("Point avec un seul parent ne devrait pas être appelé par computeStrong");
        i = l.getAxis(h);
        var c, u, p, d, m = i[0], g = i[1];
        return h == t ? (c = n.call(this, o[0], o[1], g[0], g[1]), u = s.position.clone(), p = n.call(this, r[0], r[1], m[0], m[1])) : (c = n.call(this, o[0], o[1], m[0], m[1]), u = s.position.clone(), p = n.call(this, r[0], r[1], g[0], g[1])), c || (c = o[t]), p || (p = r[t]), d = [c, u, p], 1 == t && d.reverse(), this._edgePolygons[t] = d, d
    }, t.prototype.updateReferences = function(t) {
        var e = function(t, e, n) {
            n.length = 0;
            for (var i = 0, o = t.length; o > i; i++)
                for (var r = 0, s = e.length; s > r; r++)
                    e[r].id == t[i] && n.push(e[r])
        };
        e(this._pointsIds, t.points, this.points), e(this._attachedPointsIds, t.points, this.attachedPoints), e(this._overturesIds, t.overtures, this.overtures);
        for (var n = 0, i = this.subSlopes.length; i > n; n++)
            this.subSlopes[n].wall = this;
        for (var n = 0, i = this.overtures.length; i > n; n++)
            this.overtures[n].parentWall = this;
        for (var n = 0; n < this.attachedPoints.length; n++)
            this.attachedPoints[n].attachedTo = this;
        delete this._pointsIds, delete this._attachedPointsIds, delete this._overturesIds
    }, t.Deserialize = function(t) {
        return Logger.warning("Deserialize is virtual"), console.warn("Impossible de deserialiser un mur virtuel, l'instance par défaut choisie est polygonWall"), PolygonWall.Deserialize(t)
    }, t.prototype.getPoints = function(t) {
        return 0 != t && 1 != t ? [this.points[0], this.points[1]] : this.points[t]
    }, t.prototype.isTargeted = function(t) {
        var e = this.getPoints(), n = this.getWallVector(), i = new BABYLON.Vector2, o = new BABYLON.Vector2;
        if (i = t.subtract(e[0].position), o.copyFrom(i), i.projectOnVector(n), o.subtractInPlace(i), o.length() <= this.thickness / 2 + WallComponent2D.WALL_OFFSET) {
            var r = i.dot(n);
            if (r > 0 && r < n.lengthSquared())
                return !0
        }
        return !1
    }, t.prototype.setPoints = function(t, e) {
        for (var n in this.points)
            for (var i = this.points[n].parents.length - 1; i >= 0; i--)
                this.points[n].parents[i] == this && this.points[n].parents.splice(i, 1);
        if (t instanceof Array)
            2 == t.length && (this.points[0] = t[0], this.points[1] = t[1]);
        else {
            if (!(t instanceof PointStructure) || 0 != e && 1 != e)
                throw {name: "Argument Error",level: "Show Stopper",message: "Bad Arguments for WallStructure.setPoints"};
            this.points[e] = t
        }
        for (var n in this.points)
            this.points[n].parents.push(this)
    }, t.prototype.getPolygon = function() {
        return 0 == this._edgePolygons[0].length && this.computeDefault(0), 0 == this._edgePolygons[1].length && this.computeDefault(1), this._edgePolygons[0].concat(this._edgePolygons[1])
    }, t.prototype.getWallVector = function() {
        return this.points[1].position.subtract(this.points[0].position)
    }, t.prototype.getLength = function() {
        return this.getWallVector().length()
    }, t.prototype.draw = function(t) {
        var e = this.getPolygon();
        t.beginPath(), t.moveTo(e[0].x, e[0].y);
        for (var n = 1; n < e.length; n++)
            t.lineTo(e[n].x, e[n].y);
        t.fill(), this.type === this.TYPE_SEPARATOR && (t.lineWidth = 4, t.stroke())
    }, t.prototype.update = function(t) {
        this.updateAttachedPoints(t)
    }, t.prototype.translate = function() {
        Logger.warning("translate is virtual")
    }, t.prototype.getIntersections = function(t) {
        var e, n, i, o = t.getElements("walls"), r = 5, s = r * r, a = [];
        for (var l in o)
            if (o[l] !== this && (n = this, i = o[l], e = BABYLON.Vector2.Intersect(n.points[0].position, n.points[1].position, i.points[0].position, i.points[1].position), void 0 !== e && !(n.distanceFrom(e) > BABYLON.Vector2.Precision || i.distanceFrom(e) > BABYLON.Vector2.Precision))) {
                var h = [n.points[0].position, n.points[1].position, i.points[0].position, i.points[1].position], c = !1;
                for (var u in h)
                    c = c || e.distanceToSquared(h[u]) < s;
                if (!c) {
                    var p = new PointStructure;
                    p.parents = [n, i], p.position.copyFrom(e), a.push(p)
                }
            }
        return a.sort(function(t, e) {
            return t.position.distanceToSquared(t.parents[0].points[0].position) - e.position.distanceToSquared(t.parents[0].points[0].position)
        }), a
    }, t.prototype.splitAtIntersections = function() {
        Logger.warning("splitAtIntersections is virtual")
    }, t.prototype.reorganizeOnSplit = function(t, e) {
        if (!(e.length <= 1)) {
            for (var n = [], i = [], o = 0, r = e.length; r > o; o++)
                n = n.concat(e[o].overtures), i = i.concat(e[o].attachedPoints), e[o].attachedPoints = [], e[o].subSlopes.forEach(function(t) {
                    t.remove()
                });
            for (var o = 0, r = n.length; r > o; o++) {
                var s = n[o].parentWall.getWallVector();
                s.normalize(), s.scaleInPlace(n[o].position.x);
                for (var a = s.add(n[o].parentWall.getPoints(0).position), l = 0; e[l] && !e[l].isPointOn(a); )
                    l++;
                e[l] ? (n[o].computePositionOnWallChange(e[l]), n[o].setParentWall(e[l])) : Logger.warning("Erreur d'attachage !")
            }
            for (var o = 0, r = i.length; r > o; o++) {
                for (var l = 0; e[l] && !e[l].isPointInPolygon(i[o].position); )
                    l++;
                e[l] ? (e[l].attachedPoints.push(i[o]), i[o].attachedTo = e[l]) : Logger.warning("Erreur d'attachage !")
            }
        }
    }, t.prototype.weakToStrong = function(t, e) {
        if (t.attachedTo != this)
            return Logger.warning("weakToStrong doit être appelé sur un point attaché du mur"), !1;
        var n = this.getPoints(t.position.distanceTo(this.getPoints(0).position) < t.position.distanceTo(this.getPoints(1).position) ? 0 : 1);
        return n.attachedTo ? (n.unAttach(), t.unAttach(), t.forceMerge(n, e)) : (t.unAttach(), this.points[this.points.indexOf(n)] = t, t.parents.push(this), n.attachedTo = this, this.attachedPoints.push(n), n.parents.splice(n.parents.indexOf(this), 1), 0 == n.parents.length ? n.remove(e) : n.parents[0].needsUpdate = !0), t.parents[0].needsUpdate = !0, t.parents[1].needsUpdate = !0, !0
    }, t.prototype.tryMerge = function() {
        Logger.warning("tryMerge is virtual")
    }, t.prototype.updateAttachedPoints = function() {
        Logger.warning("updateAttachedPoints is virtual")
    }, t.prototype.updateOvertures = function(t) {
        for (var e = 0, n = this.overtures.length; n > e; e++)
            this.overtures[e] && (this.overtures[e].projectOnWall(), this.overtures[e].clampSize(!0, t))
    }, t.prototype.getNearestPoint = function(t, e) {
        var n, e = e || 0, i = this.getWallVector(), o = i.length(), r = t.subtract(this.getPoints(0).position);
        return r.projectOnVector(i), n = r.dot(i), -e * o >= n ? this.getPoints(0).position.subtract(i.normalize().scaleInPlace(e)) : n >= i.lengthSquared() + o * e ? this.getPoints(1).position.add(i.normalize().scaleInPlace(e)) : this.getPoints(0).position.add(r)
    }, t.prototype.getNearestPointOnAxe = function(t) {
        var e, n = this.getWallVector(), i = t.subtract(this.points[0].position);
        return i.projectOnVector(n), e = i.dot(n), this.points[0].position.add(i)
    }, t.prototype.getNearestPointOnRect = function() {
        Logger.warning("getNearestPointOnRect is virtual")
    }, t.prototype.isPointInPolygon = function(t) {
        var e = this.getPolygon();
        return e[0] && t.isPointInPolygon(e) ? !0 : !1
    }, t.prototype.getNearestPointOnPolygon = function(t) {
        if (this.isPointInPolygon(t))
            return t.clone();
        var e = this.getPolygon();
        if (!e[0])
            return Logger.warning("getNearestPointOnPolygon a été appelé sur un mur au polygone vide"), null;
        for (var n, i, o = +1 / 0, r = null, s = 0, a = e.length; a > s; s++)
            i = t.projectOnSegment(e[s], e[(s + 1) % a]), n = i.distanceTo(t), o > n && (r = i, o = n);
        return r
    }, t.prototype.getBoundingBox = function() {
        for (var t = +1 / 0, e = -1 / 0, n = +1 / 0, i = -1 / 0, o = this.getPolygon(), r = 0, s = o.length; s > r; r++)
            o[r].x < t && (t = o[r].x), o[r].x > e && (e = o[r].x), o[r].y < n && (n = o[r].y), o[r].y > i && (i = o[r].y);
        return {min: new BABYLON.Vector2(t, n),max: new BABYLON.Vector2(e, i)}
    }, t.prototype.getNearestWall = function(t, e) {
        for (var n, i = e.getElements("walls"), o = null, r = +1 / 0, s = 0, a = i.length; a > s; s++)
            n = i[s].distanceFrom(t), r > n && (o = i[s], r = n);
        return o
    }, t.prototype.distanceFrom = function(t) {
        var e = this.getNearestPoint(t), n = new BABYLON.Vector2;
        return n = t.subtract(e), n.length()
    }, t.prototype.distanceFromRect = function(t, e, n) {
        var i = this.getNearestPointOnRect(t, e, n), o = new BABYLON.Vector2;
        return o = t.subtract(i), o.length()
    }, t.prototype.vectorTo = function(t) {
        var e = this.getNearestPoint(t), n = new BABYLON.Vector2;
        return n = t.subtract(e)
    }, t.prototype.isPointOn = function(t, e) {
        var e = e || 1e-5, n = this.distanceFrom(t);
        return e >= n
    }, t.prototype.getNormalVector = function(t) {
        var t = void 0 === t ? 1 : t, e = new BABYLON.Vector2(this.points[0].position.y - this.points[1].position.y, this.points[1].position.x - this.points[0].position.x);
        return e.normalize(), e.scaleInPlace(t), e
    }, t.prototype.sortAttached = function() {
        var t = this;
        t.attachedPoints.sort(function(e, n) {
            return e.position.distanceToSquared(t.points[0].position) - n.position.distanceToSquared(t.points[0].position)
        })
    }, t.prototype.getAllPoints = function(t) {
        var e = [this.getPoints(0)];
        return this.sortAttached(), e = e.concat(this.attachedPoints), e.push(this.getPoints(1)), -1 == t && e.reverse(), e
    }, t.prototype.remove = function(t) {
        for (var e = 0, n = this.points.length; n > e; e++)
            for (var i = this.points[e].parents.length - 1; i >= 0; i--)
                this.points[e].parents[i] == this && this.points[e].parents.splice(i, 1);
        for (var o, e = this.attachedPoints.length - 1; e >= 0; e--)
            o = this.attachedPoints[e], o.unAttach(), o.needsUpdate = !0, o.parents[0] && (o.parents[0].needsUpdate = !0);
        if (void 0 != t) {
            for (var e = 0, n = this.points.length; n > e; e++)
                o = this.points[e], 0 == o.parents.length ? (o.unAttach(t), o.remove(t)) : o.needsUpdate = !0;
            for (var e = this.overtures.length - 1; e >= 0; e--)
                this.overtures[e].remove(t);
            t.removeElement("walls", this)
        }
    }, t.prototype.addToStructure = function(t) {
        for (var e in this.points)
            t.insertElement("points", this.points[e]);
        t.insertElement("walls", this)
    }, t.prototype.paralleleTo = function(t) {
        return void 0 === BABYLON.Vector2.Intersect(this.getPoints(0).position, this.getPoints(1).position, t.getPoints(0).position, t.getPoints(1).position)
    }, t.prototype.addMaterial = function(t, e, n, i) {
        return Logger.warning("WallStructure.addMaterial is deprecated"), null
    }, t
}();
var WallPane3D = function() {
    var t = function(t, e, n) {
        MeasureStructure.call(this, t, e, n), this.materialInfo = null, this.room = null, this.materialIndex = -1
    };
    return t.prototype = new MeasureStructure, t.prototype.setRoom = function(t) {
        this.room = t
    }, t.prototype.nearestPane = function(t) {
        for (var e, n = this.center(), i = null, o = +1 / 0, r = 0, s = t.length; s > r; r++)
            t[r] !== this && (e = t[r].center().distanceTo(n), o > e && (o = e, i = t[r]));
        return i
    }, t.prototype.nearestMaterial = function(t) {
        for (var e, n = this.center(), i = null, o = +1 / 0, r = 0, s = t.length; s > r; r++)
            e = t[r].center.distanceTo(n), o > e && (o = e, i = r);
        return i
    }, t.prototype.addMaterial = function(t) {
        this.materialInfo || (this.materialInfo = MaterialInfo.MakeFromPane(this));
        var e = this.materialInfo.material ? this.materialInfo.material.clone(this.materialInfo.material.name) : null;
        return this.materialInfo.material = t, this.room.panesMaterials[this.room.panes.indexOf(this)] = this.materialInfo, e
    }, t.prototype.serialize = function() {
        return this.materialInfo ? this.materialInfo.serialize() : null
    }, t.Deserialize = function(t) {
        var e = new MaterialInfo;
        return e.deserialize(t), e
    }, t
}();
PolygonWall = function() {
    var t = function() {
        WallStructure.call(this, "PolygonWall"), this.polygonPoints = [], this.instance = "polygon"
    };
    return t.prototype = new WallStructure, t.prototype.serialize = function() {
        var t = WallStructure.prototype.serialize.call(this);
        return t.class.name = "PolygonWall", t
    }, t.prototype.deserialize = function(t) {
        WallStructure.prototype.deserialize.call(this, t)
    }, t.Deserialize = function(e) {
        var n = new t;
        return n.deserialize(e), n
    }, t.prototype.getAxis = function() {
        var t = (this.getWallVector(), this.getNormalVector(this.thickness / 2)), e = this.getPoints(0).position, n = this.getPoints(1).position;
        return [[e.add(t), n.add(t)], [e.subtract(t), n.subtract(t)]]
    }, t.prototype.translate = function(e, n) {
        for (var i = function(e, i, o) {
            var r = new t, s = new PointStructure;
            s.position.copyFrom(e.position), s.parents = [r, i], e.parents = [o, r], r.points = [e, s], r.thickness = Math.min(i.thickness, o.thickness), r.height = o.height, r.type = i.type;
            var a = i.points[0] == e ? 0 : 1;
            i.points[a] = s, n.insertElement("walls", r), n.insertElement("points", s)
        }, o = Math.PI / 8, r = this.points[0].position.add(e), s = this.points[1].position.add(e), a = null, l = null, h = 0, c = this.points[0].parents.length; c > h; h++)
            this.points[0].parents[h] != this && (a = this.points[0].parents[h], a.needsUpdate = !0);
        for (var h = 0, c = this.points[1].parents.length; c > h; h++)
            this.points[1].parents[h] != this && (l = this.points[1].parents[h], l.needsUpdate = !0);
        var u, p = .01, d = function(t, a, l) {
            if (null !== t) {
                var h = t.getPoints(0).position, c = t.getPoints(1).position;
                if (t.getLength() < p && (c = h.add(e)), u = BABYLON.Vector2.GetAbsoluteSine(r, s, h, c), o > u && void 0 !== n)
                    t.getLength() > 0 && i(this.points[a], t, this);
                else {
                    var d = BABYLON.Vector2.Intersect(r, s, h, c);
                    d && l.copyFromFloats(d.x, d.y)
                }
            }
        }.bind(this);
        d(a, 0, r), d(l, 1, s);
        this.getPoints(0).position.clone(), this.getPoints(1).position.clone();
        this.getPoints(0).position.x = r.x, this.getPoints(0).position.y = r.y, this.getPoints(1).position.x = s.x, this.getPoints(1).position.y = s.y;
        var m, g = function(t) {
            var e = this.getPoints(0).position, i = this.getPoints(1).position, o = t.parents[0];
            return m = BABYLON.Vector2.Intersect(e, i, o.getPoints(0).position, o.getPoints(1).position), void 0 === m ? (t.unAttach(n), !1) : (m = new BABYLON.Vector2(m.x, m.y), this.distanceFromRect(m, 0, n) > BABYLON.Vector2.Precision ? !0 : !1)
        };
        if (void 0 !== n) {
            a && a.updateOvertures(n), l && l.updateOvertures(n), this.updateAttachedPoints(n);
            for (var f, h = 0; 2 > h; h++)
                f = this.getPoints(h).attachedTo, f && (g.call(f, this.getPoints(h)) ? (m && this.getPoints(h).position.copyFrom(m), f.weakToStrong(this.getPoints(h), n)) : this.getPoints(h).position.copyFrom(m))
        }
    }, t.prototype.getIntersections = function(t) {
        var e, n, i, o = t.getElements("walls"), r = 5, s = r * r, a = [];
        for (var l in o)
            if (o[l] !== this && (n = this, i = o[l], e = BABYLON.Vector2.Intersect(n.points[0].position, n.points[1].position, i.points[0].position, i.points[1].position), void 0 !== e && !(n.distanceFrom(e) > BABYLON.Vector2.Precision || i.distanceFrom(e) > BABYLON.Vector2.Precision))) {
                var h = [n.points[0].position, n.points[1].position, i.points[0].position, i.points[1].position], c = !1;
                for (var u in h)
                    c = c || e.distanceToSquared(h[u]) < s;
                if (!c) {
                    var p = new PointStructure;
                    p.parents = [n, i], p.position.copyFrom(e), a.push(p)
                }
            }
        return a.sort(function(t, e) {
            return t.position.distanceToSquared(t.parents[0].points[0].position) - e.position.distanceToSquared(t.parents[0].points[0].position)
        }), a
    }, t.prototype.splitAtIntersections = function(e) {
        var n = this.getIntersections(e), i = [this];
        for (var o in n) {
            var r = new t, s = new PointStructure;
            s.position.copyFrom(n[o].position), s.parents = [r], r.points = [this.getPoints(0), s], r.getPoints(0).replaceParent(this, r), r.thickness = this.thickness, r.type = this.type, r.height = this.height, n[o].parents[1].attachedPoints.push(s), s.attachedTo = n[o].parents[1], n[o].parents[1].attachedPoints.push(n[o]), n[o].attachedTo = n[o].parents[1], this.points[0] = n[o], this.points[0].parents = [this], e.insertElement("walls", r), e.insertElement("points", n[o]), e.insertElement("points", s), i.push(r), r.needsUpdate = !0
        }
        this.needsUpdate = !0, t.prototype.reorganizeOnSplit(e, i)
    }, t.prototype.tryMerge = function(e) {
        for (var n = e.getElements("walls"), i = (e.getElements("points"), function(t, e, n, i) {
            return -1 != i.indexOf(t) && i.splice(i.indexOf(t), 1), -1 != i.indexOf(e) && i.splice(i.indexOf(e), 1), void 0 !== n && i.push(n), i
        }), o = 15, r = Math.PI / 18, s = 0, a = n.length; a > s; s++)
            if (n[s] != this) {
                var l, h, c, u, p = this, d = n[s], m = p.getPoints(), g = d.getPoints();
                if (l = p.distanceFrom(g[0].position), h = p.distanceFrom(g[1].position), c = d.distanceFrom(m[0].position), u = d.distanceFrom(m[1].position), !(l > o && h > o && c > o && u > o) && p.thickness == d.thickness && p.type == d.type && p.height == d.height) {
                    var f, y = p.getWallVector(), _ = d.getWallVector(), v = new BABYLON.Vector2(y.x, y.y).normalize(), b = new BABYLON.Vector2(_.x, _.y).normalize();
                    if (f = Math.abs(v.determinant(b)), !(f > r)) {
                        for (var w, x, C, M, D, B = -1 / 0, A = [m[0], m[1], g[0], g[1]], E = 0; 4 > E; E++)
                            for (var T = 0; 4 > T; T++)
                                if (E != T && (D = A[E].position.subtract(A[T].position).length(), D > B)) {
                                    w = A[E], x = A[T];
                                    for (var S = -1, L = -1, O = 0; 4 > O; O++)
                                        O != E && O != T && (-1 != S ? -1 == L && (L = O) : S = O);
                                    C = A[S], M = A[L], B = D
                                }
                        var P, I;
                        if (P = C.wallAttached(e), I = M.wallAttached(e), !P || P !== I) {
                            var N = new t;
                            N.points[0] = w, N.points[1] = x, N.attachedPoints = p.attachedPoints.concat(d.attachedPoints);
                            for (var R = 0; R < N.attachedPoints.length; R++)
                                N.attachedPoints[R].attachedTo = N;
                            N.thickness = p.thickness, N.type = p.type, N.height = p.height;
                            for (var E = p.overtures.length - 1; E >= 0; E--)
                                p.overtures[E].computePositionOnWallChange(N), p.overtures[E].setParentWall(N);
                            for (var E = d.overtures.length - 1; E >= 0; E--)
                                d.overtures[E].computePositionOnWallChange(N), d.overtures[E].setParentWall(N);
                            e.insertElement("walls", N), w.parents = i(p, d, N, w.parents), x.parents = i(p, d, N, x.parents), w.unAttach(e), x.unAttach(e), w.position = d.getLength() > 5 ? d.getNearestPointOnAxe(w.position) : p.getNearestPointOnAxe(w.position), x.position = d.getLength() > 5 ? d.getNearestPointOnAxe(x.position) : p.getNearestPointOnAxe(x.position);
                            for (var E = 0, a = N.attachedPoints.length; a > E; E++)
                                N.attachedPoints[E].position = N.getNearestPoint(N.attachedPoints[E].position);
                            for (var k = [C, M], E = 0; 2 > E; E++)
                                if (k[E] !== w && k[E] !== x)
                                    if (void 0 != k[E].parents[0] && void 0 != k[E].parents[1]) {
                                        if (k[E].parents[0] == p && k[E].parents[1] == d || k[E].parents[0] == d && k[E].parents[1] == p)
                                            k[E].unAttach(e), k[E].remove(e);
                                        else if (k[E].parents = i(p, d, void 0, k[E].parents), k[E].position = N.getNearestPoint(k[E].position), k[E].parents[0] !== N) {
                                            var V = k[E].tryMerge(e);
                                            V === k[E] && (N.attachedPoints.push(k[E]), k[E].attachedTo = N, k[E].position = N.getNearestPoint(k[E].position))
                                        }
                                    } else
                                        k[E].unAttach(e), k[E].remove(e);
                            return p.remove(e), d.remove(e), w.needsUpdate = !0, x.needsUpdate = !0, N.tryMerge(e)
                        }
                    }
                }
            }
        return this
    }, t.prototype.updateAttachedPoints = function(t) {
        for (var e = this.attachedPoints.length - 1; e >= 0; e--) {
            var n = this.attachedPoints[e].parents[0], i = this.getPoints(0).position, o = this.getPoints(1).position;
            if (n) {
                var r = BABYLON.Vector2.Intersect(i, o, n.getPoints(0).position, n.getPoints(1).position, Math.PI / 18), s = this.attachedPoints[e];
                if (void 0 !== r) {
                    if (this.distanceFrom(r) > BABYLON.Vector2.Precision) {
                        this.attachedPoints[e].position.copyFrom(r);
                        var s = this.attachedPoints[e];
                        this.weakToStrong(this.attachedPoints[e], t)
                    } else
                        this.attachedPoints[e].position.copyFrom(r);
                    n.needsUpdate = !0, n.updateOvertures(t)
                } else
                    s.unAttach(t), s.needsUpdate = !0
            } else
                Logger.warning("Un point attaché n'a plus de parent !"), Logger.warning(this)
        }
    }, t.prototype.getNearestPointOnRect = function(t, e) {
        for (var e = e || 0, n = this.getPolygon(), i = [], o = this.getWallVector().normalize(), r = 0, s = n.length; s > r; r++)
            i.push(this.getNearestPointOnAxe(n[r]));
        for (var a, l = +1 / 0, h = -1 / 0, c = new BABYLON.Vector2, u = this.getPoints(0).position, r = 0, s = i.length; s > r; r++)
            a = c.copyFrom(i[r]).subtractInPlace(u).dot(o), l > a && (l = a), a > h && (h = a);
        var a, p = o.scale(l).addInPlace(u), d = o.scale(h).addInPlace(u), m = d.subtract(p), g = m.length(), f = t.subtract(p);
        return f.projectOnVector(m), a = f.dot(m), -e * g >= a ? p.subtract(m.normalize().scaleInPlace(e)) : a >= m.lengthSquared() + g * e ? d.add(m.normalize().scaleInPlace(e)) : p.add(f)
    }, t
}(), CurvedWall = function() {
    var t = function() {
        PolygonWall.call(this, "CurvedWall"), this.TYPE_NORMAL = 1, this.TYPE_SEPARATOR = 2, this.type = this.TYPE_NORMAL, this.polygonPoints = [], this.instance = "curved", this.cp = null
    };
    return t.prototype = new PolygonWall, t.prototype.serialize = function() {
        var t = PolygonWall.prototype.serialize.call(this);
        return t.type = this.type, t.cp = {x: this.cp.x,y: this.cp.y,z: this.cp.z}, t
    }, t.prototype.isTargeted = function(t) {
        var e = document.createElement("canvas"), n = e.getContext("2d");
        if (this.draw(n), n.isPointInPath(t.x, t.y))
            return delete e, !0;
        var i = this.getCp();
        return t.distanceTo(i) < 10 ? (delete e, i) : (n.beginPath(), n.moveTo(this.getPoints(0).position.x, this.getPoints(0).position.y), n.quadraticCurveTo(i.x, i.y, this.getPoints(1).position.x, this.getPoints(1).position.y), n.lineTo(i.x, i.y), n.closePath(), n.isPointInPath(t.x, t.y) ? (delete e, !0) : (delete e, !1))
    }, t.prototype.computeDefault = function(t) {
        this.computeCp();
        var e = this.getCp(), n = this.getPoints(t).position.clone().subtractInPlace(e).normalize().scaleInPlace(this.thickness / 2), i = new BABYLON.Vector3(n.y, -n.x, 0), o = this.getPoints(t).position, r = o.clone().subtractInPlace(i), s = o.clone(), a = o.clone().add(i);
        this._edgePolygons[t] = [a, s, r]
    }, t.prototype.translate = function(t, e) {
        PolygonWall.prototype.translate.call(this, t, e), this.getCp().add(t)
    }, t.prototype.computeCp = function(t) {
        var t = t || !1;
        if (this.cp && !t)
            var e = this.cp;
        else {
            var e = this.getPoints(0).position.clone().lerp(this.getPoints(1).position, .5);
            e.add(this.getNormalVector(this.getLength() / 2))
        }
        var n = this.getNormalVector(this.thickness / 2), i = e.clone().subtractInPlace(n), o = e.clone().add(n);
        this.cp = e, this._edgePolygons[2] = [i, o]
    }, t.prototype.deserialize = function(t) {
        PolygonWall.prototype.deserialize.call(this, t), this.type = t.type, this.cp = new BABYLON.Vector3(t.cp.x, t.cp.y, t.cp.z)
    }, t.prototype.getAxis = function(t) {
        var e = this.getCp(), n = this.getPoints(t).position.clone().subtractInPlace(e).normalize().scaleInPlace(this.thickness / 2), i = new BABYLON.Vector3(n.y, -n.x, 0), o = this.getPoints(t).position, r = e, s = o.clone().add(i), a = r.clone().add(i), l = o.clone().subtractInPlace(i), h = r.clone().subtractInPlace(i);
        return 1 == t ? [[h, l], [a, s]] : [[s, a], [l, h]]
    }, t.prototype.getCp = function() {
        return this.cp || this.computeCp(), this.cp
    }, t.prototype.draw = function(t) {
        var e = this._edgePolygons[0], n = this._edgePolygons[1];
        "undefined" == typeof this._edgePolygons[2] && this.computeCp();
        var i = this._edgePolygons[2];
        t.beginPath(), t.moveTo(e[2].x, e[2].y), t.quadraticCurveTo(i[0].x, i[0].y, n[0].x, n[0].y), t.lineTo(n[1].x, n[1].y), t.lineTo(n[2].x, n[2].y), t.quadraticCurveTo(i[1].x, i[1].y, e[0].x, e[0].y), t.lineTo(e[1].x, e[1].y), t.fill()
    }, t
}();
var WallComponent2D = function() {
    var t = function(t) {
        BaseComponent2D.call(this, t, "WallComponent2D"), this.TYPE_NORMAL = 1, this.TYPE_SEPARATOR = 2, this._COLORS = ["#333333", "#616161", "#BEBEBE", "#EEEEEE"], this._PATTERNS = [null, null, null, null], this._PATTERN_IMGS = [new Image, new Image, null, null], this._PATTERN_IMGS[0].addEventListener("load", function() {
            this._PATTERNS[0] = wanaplan.engine2D.canvas.getContext("2d").createPattern(this._PATTERN_IMGS[0], "repeat"), wanaplan.engine2D.requestStaticDraw()
        }.bind(this), !1), this._PATTERN_IMGS[1].addEventListener("load", function() {
            this._PATTERNS[1] = wanaplan.engine2D.canvas.getContext("2d").createPattern(this._PATTERN_IMGS[1], "repeat"), wanaplan.engine2D.requestStaticDraw()
        }.bind(this), !1), this._PATTERN_IMGS[0].src = wnp.Assets.globalPath + "js/Components/CoreComponents/Wall/Images/pattern.png", this._PATTERN_IMGS[1].src = wnp.Assets.globalPath + "js/Components/CoreComponents/Wall/Images/pattern_tmp.png", this.priority = 10, this._tmpWall = null, this._tmpThickness = 20, this._tmpType = this.TYPE_NORMAL, this._tmpDragStartPt = null, this._lastPlanPos = new BABYLON.Vector3, this._updateList = [], this._applyHeightToAll = !1, this._minWallLengthRatio = .01, this._draggingMinWallLengthRatio = .5, this.displayMesure = !0
    };
    return t.prototype = new BaseComponent2D, t.WALL_OFFSET = 10, t.prototype.startListening = function() {
        this.onAddWall = this.onAddWall.bind(this), this.onAddWallEnd = this.onAddWallEnd.bind(this), document.addEventListener("wnp.engine2d.onAddWall", this.onAddWall, !1), document.addEventListener("wnp.engine2d.onAddWallEnd", this.onAddWallEnd, !1), this.core.engine2D.registerEventCb("WallComponent2D.static-draw", this.priority, "static-draw", null, null, this.onStaticDraw.bind(this), null), this.core.engine2D.registerEventCb("WallComponent2D.hover", this.priority, "hover", this.core.engine2D.MODE_NORMAL | this.core.engine2D.MODE_DRAW | this.core.engine2D.MODE_CONTEXTMENU, WallStructure, this.onHover.bind(this), null), this.core.engine2D.registerEventCb("WallComponent2D.leave", this.priority, "leave", this.core.engine2D.MODE_NORMAL | this.core.engine2D.MODE_DRAW | this.core.engine2D.MODE_CONTEXTMENU, WallStructure, this.onLeave.bind(this), null), this.core.engine2D.registerEventCb("WallComponent2D.double-click", this.priority, "double-click", this.core.engine2D.MODE_NORMAL, WallStructure, this.onDoubleClick.bind(this), null), this.core.engine2D.registerEventCb("WallComponent2D.context-menu", this.priority, "click", this.core.engine2D.MODE_NORMAL, WallStructure, this.onContextMenu.bind(this), null), GlobalHelper.isMobileDevice() && wanaplan.engine2D.registerEventCb("WallComponent2D.mobile-drag-start", this.priority, "drag-start", wanaplan.engine2D.MODE_NORMAL, null, this.onMobileDragStart.bind(this), null)
    }, t.prototype.stopListening = function() {
        document.removeEventListener("wnp.engine2d.onAddWall", this.onAddWall, !1), document.removeEventListener("wnp.engine2d.onAddWallEnd", this.onAddWallEnd, !1), this.core.engine2D.unregisterEventCb("WallComponent2D.static-draw"), this.core.engine2D.unregisterEventCb("WallComponent2D.hover"), this.core.engine2D.unregisterEventCb("WallComponent2D.leave"), this.core.engine2D.unregisterEventCb("WallComponent2D.double-click"), this.core.engine2D.unregisterEventCb("WallComponent2D.context-menu"), GlobalHelper.isMobileDevice() && wanaplan.engine2D.unregisterEventCb("WallComponent2D.drag-start")
    }, t.prototype.initialize = function() {
        this.startListening();
        var t = {title: _("Rooms & Walls"),id: "rooms_walls",items: [{title: _("Wall"),action: "wnp.engine2d.onAddWall",cancelAction: "wnp.engine2d.onAddWallEnd",params: {wallType: this.TYPE_NORMAL,thickness: 30,putPoint: !1}}, {title: _("Bulkhead"),action: "wnp.engine2d.onAddWall",cancelAction: "wnp.engine2d.onAddWallEnd",params: {wallType: this.TYPE_NORMAL,thickness: 7,putPoint: !1}}, {title: _("Room separator (invisible)"),cancelAction: "wnp.engine2d.onAddWallEnd",action: "wnp.engine2d.onAddWall",params: {wallType: this.TYPE_SEPARATOR,thickness: .2,putPoint: !1}}]};
        ujs.notify("wnp.menu.main.add", {item: t,menuPath: "draw2D",position: .5})
    }, t.prototype.update = function(t) {
        var e, n = t || this.structure.getCurrentStructure(), i = n.getElements("walls");
        this._updateList.length = 0;
        for (var o = i.length - 1; o >= 0; o--)
            i[o].needsUpdate && (this._updateList.push(i[o]), i[o].needsUpdate = !1);
        for (var o = this._updateList.length - 1; o >= 0; o--) {
            for (var r = 0; 2 > r; r++)
                1 == this._updateList[o].getPoints(r).parents.length && this._updateList[o].computeDefault(r);
            this._updateList[o].computeCp && this._updateList[o].computeCp()
        }
        for (var o = this._updateList.length - 1; o >= 0; o--)
            for (var r = 0; 2 > r; r++)
                if (2 == this._updateList[o].getPoints(r).parents.length)
                    for (var s = 0; 2 > s; s++)
                        e = this._updateList[o].getPoints(r).parents[s].getPoints().indexOf(this._updateList[o].getPoints(r)), this._updateList[o].getPoints(r).parents[s].computeStrong(e);
        for (var o = this._updateList.length - 1; o >= 0; o--) {
            for (var r = 0; 2 > r; r++)
                this._updateList[o].getPoints(r).attachedTo && this._updateList[o].computeWeak(r);
            this._updateList[o].needsUpdate = !1, this._updateList[o].update(n)
        }
        this._updateList.length && n.dirty()
    }, t.prototype.getTargeted = function(t) {
        var e = this.structure.getCurrentStructure().getElements("walls");
        for (var n in e)
            if (e[n].isTargeted(t))
                return e[n];
        return null
    }, t.prototype.simplifyWalls = function() {
        for (var t = this.structure.getCurrentStructure(), e = t.getElements("walls"), n = t.getElements("points"), i = e.length - 1; i >= 0; i--) {
            var o, r;
            e[i].getLength() < this._minWallLengthRatio * e[i].thickness && (o = e[i].points[0], r = e[i].points[1], e[i].remove(t), -1 != n.indexOf(o) && o.forceMerge(r, t))
        }
    }, t.prototype._drawWall = function(t, e, n, i, o) {
        var o = o || {}, r = (o.measureDisplayed === !1 ? !1 : !0, o.styleId || 0);
        t.fillStyle = this._PATTERNS[r] || this._COLORS[r], t.strokeStyle = this._COLORS[r], t.save(), t.translate(e.x, e.y), t.scale(n, n), i.draw(t), t.restore()
    }, t.prototype._drawMeasures = function(t, e, n) {
        MeasureComponent.draw(t, e, n)
    }, t.prototype._addWallFirstPoint = function(t, e) {
        var n = wanaplan.getComponentByName("MagnetismComponent2D", wanaplan.ENGINE_2D), i = (wanaplan.getComponentByName("PointComponent2D", wanaplan.ENGINE_2D), wanaplan.getSelectedStructure());
        this._tmpWall = new PolygonWall, this._tmpWall.height = i.height, this._tmpWall.thickness = this._tmpThickness, this._tmpWall.type = this._tmpType || this._tmpWall.TYPE_NORMAL;
        var o = e || new PointStructure, r = new PointStructure;
        e || (o.position = t.planPos.clone()), r.position = t.planPos.clone(), e || (n && n.addVirtualPoint(this.name, o), wanaplan.engine2D.setEnableAutoScroll(!0)), n && n.onWallDrawStart(o), this._tmpWall.setPoints([o, r]), wanaplan.engine2D.requestStaticDraw()
    }, t.prototype._addWallNewPoint = function(t) {
        {
            var e = wanaplan.getSelectedStructure(), n = wanaplan.getComponentByName("MagnetismComponent2D", wanaplan.ENGINE_2D);
            wanaplan.getComponentByName("PointComponent2D", wanaplan.ENGINE_2D)
        }
        n.removeVirtualPoint(this.name, null), this._tmpWall.getPoints(1).position = t.planPos.clone(), this._tmpWall.addToStructure(e);
        var i = !1, o = this._tmpWall.tryMerge(e);
        for (var r in this._tmpWall.points) {
            var s = o.points[r], a = o.points[r].tryMerge(e);
            s != a && (a.parents[0].update(e), a.parents[1].update(e), 1 == r && (i = !0))
        }
        return o.splitAtIntersections(e), i
    }, t.prototype._addWallUpdate = function(t) {
        var e = this._tmpWall.getPoints(1);
        e.position = t.planPos.clone(), this._tmpWall.setPoints(e, 1), this._tmpWall.needsUpdate = !0, wanaplan.engine2D.requestDynamicDraw()
    }, t.prototype.onStaticDraw = function(t, e, n) {
        var i = !1;
        if (i = this.structure.getElement(+this.structure.getCurrentStructure().id - 1))
            for (var o = i.getElements("walls"), r = 0; r < o.length; r++)
                if (o[r].thickness >= 15) {
                    var s = {measureDisplayed: !1,styleId: 3};
                    this._drawWall(t, e, n, o[r], s)
                }
        var a = this.structure.getCurrentStructure().getElements("walls");
        for (var r in a) {
            var s = {styleId: a[r].type == a[r].TYPE_SEPARATOR ? 2 : 0};
            this._drawWall(t, e, n, a[r], s)
        }
        this.displayMesure && (MeasureComponent.buildFromRooms(wanaplan.getSelectedStructure().internalRooms, wanaplan.getSelectedStructure().externalRooms), this._drawMeasures(t, e, n))
    }, t.prototype.onDragStart = function(t, e, n) {
        return e.targeted = e && e.isTargeted(n.planPos) instanceof BABYLON.Vector3 ? e.cp : !1, this._lastPlanPos.copyFrom(n.planPos), wanaplan.engine2D.registerEventCb("WallComponent2D.dragging", this.priority, "dragging", wanaplan.engine2D.MODE_DRAG, null, this.onDragging.bind(this), e), wanaplan.engine2D.registerEventCb("WallComponent2D.drag-end", this.priority, "drag-end", wanaplan.engine2D.MODE_DRAG, null, this.onDragEnd.bind(this), e), wanaplan.engine2D.registerEventCb("WallComponent2D.dynamic-draw", this.priority, "dynamic-draw", wanaplan.engine2D.MODE_DRAG, null, this.onSelectionDynamicDraw.bind(this), e), wanaplan.engine2D.registerEventCb("WallComponent2D.drag.hover", this.priority, "hover", wanaplan.engine2D.MODE_DRAG, WallStructure, this.onHover.bind(this), e), wanaplan.engine2D.registerEventCb("WallComponent2D.drag.leave", this.priority, "leave", wanaplan.engine2D.MODE_DRAG, WallStructure, this.onLeave.bind(this), e), !1
    }, t.prototype.onDragging = function(t, e, n, i) {
        var o;
        if (o = n.forcePosition ? n.forcePosition.clone().subtractInPlace(i.getPoints(0).position) : n.planPos.clone().subtractInPlace(this._lastPlanPos), this._lastPlanPos.copyFrom(n.planPos), i.needsUpdate = !0, i.targeted)
            return i.cp.addInPlace(mouseVector), wanaplan.engine2D.requestStaticDraw(), !1;
        var r = o.clone().projectOnVector(i.getWallVector()), s = o.subtractInPlace(r);
        return i.translate(s, this.structure.getCurrentStructure()), i.getLength() < this._draggingMinWallLengthRatio * i.thickness && (i.remove(this.structure.getCurrentStructure()), wanaplan.engine2D.setMode(wanaplan.engine2D.MODE_NORMAL), this.simplifyWalls(), wanaplan.getSelectedStructure().dirty(), wanaplan.engine2D.requestStaticDraw(), wanaplan.engine2D.unregisterEventCb("WallComponent2D.dynamic-draw")), wanaplan.engine2D.requestStaticDraw(), !1
    }, t.prototype.onDragEnd = function(t, e, n, i) {
        var o = this.structure.getCurrentStructure(), r = o.getElements("walls");
        PolygonMerger.merge(r);
        var s = i.tryMerge(o), a = s.points[0], l = s.points[1];
        a.needsUpdate = !0, l.needsUpdate = !0;
        var h = a.parents[(a.parents.indexOf(s) + 1) % 2], c = l.parents[(l.parents.indexOf(s) + 1) % 2];
        h && h.splitAtIntersections(o), c && c.splitAtIntersections(o), s.splitAtIntersections(o);
        for (var u = 0, p = s.attachedPoints.length; p > u; u++)
            s.attachedPoints[u].parents[0] && s.attachedPoints[u].parents[0].splitAtIntersections(o);
        h && h.tryMerge(o), c && c.tryMerge(o);
        for (var u = 0, p = s.attachedPoints.length; p > u; u++)
            s.attachedPoints[u].parents[0] && s.attachedPoints[u].parents[0].tryMerge(o);
        this.update(), this.simplifyWalls(), wanaplan.getComponentByName("PointComponent2D").update(), wanaplan.getSelectedStructure().dirty(), wanaplan.engine2D.requestStaticDraw(), wanaplan.engine2D.unregisterEventCb("WallComponent2D.dynamic-draw"), wanaplan.engine2D.unregisterEventCb("WallComponent2D.drag.hover"), wanaplan.engine2D.unregisterEventCb("WallComponent2D.drag.leave"), this.update()
    }, t.prototype.onHover = function(t, e, n, i) {
        var e = i || e;
        return wanaplan.engine2D.registerEventCb("WallComponent2D.dynamic-draw", this.priority, "dynamic-draw", null, null, this.onSelectionDynamicDraw.bind(this), e), wanaplan.engine2D.registerEventCb("WallComponent2D.drag-start", this.priority, "drag-start", wanaplan.engine2D.MODE_NORMAL, WallStructure, this.onDragStart.bind(this), null), wanaplan.engine2D.requestDynamicDraw(), !1
    }, t.prototype.onLeave = function(t, e, n, i) {
        wanaplan.engine2D.unregisterEventCb("WallComponent2D.dynamic-draw"), wanaplan.engine2D.unregisterEventCb("WallComponent2D.drag-start"), wanaplan.engine2D.requestDynamicDraw()
    }, t.prototype.onMobileDragStart = function(t, e, n, i) {
        return e ? this.onDragStart(t, e, n, i) : void 0
    }, t.prototype.onSelectionDynamicDraw = function(t, e, n, i) {
        var o = i.getPoints(), r = {x: o[0].position.x * n + e.x,y: o[0].position.y * n + e.y}, s = {x: o[1].position.x * n + e.x,y: o[1].position.y * n + e.y};
        if ("curved" == i.instance) {
            var a = i.getCp(), l = {x: a.x * n + e.x,y: a.y * n + e.y};
            wanaplan.engine2D.symbols2D.drawPoint(t, l), wanaplan.engine2D.symbols2D.drawMeasure(t, r, l), wanaplan.engine2D.symbols2D.drawMeasure(t, s, l), wanaplan.engine2D.symbols2D.drawArc(t, r, l, s)
        } else
            wanaplan.engine2D.symbols2D.drawSegment(t, r, s)
    }, t.prototype.onDoubleClick = function(t, e, n) {
        var i = wanaplan.getSelectedStructure(), o = new PointStructure;
        o.position = e.getNearestPoint(n.planPos);
        var r = new PolygonWall;
        r.height = e.height, r.type = e.type, r.thickness = e.thickness, r.points = [o, e.getPoints(1)], e.points[1] = o, o.parents = [r, e], r.getPoints(1).parents.splice(r.getPoints(1).parents.indexOf(e), 1), r.getPoints(1).parents.push(r), r.reorganizeOnSplit(i, [r, e]), i.insertElement("points", o), i.insertElement("walls", r), wanaplan.engine2D.requestStaticDraw()
    }, t.prototype.onAddWall = function(t) {
        if (wanaplan.helpBubbleManager.display("wnp.2d.draw-wall"), this._tmpThickness = t.thickness, this._tmpType = t.wallType, this._tmpRounded = t.rounded || !1, wanaplan.engine2D.setMode(wanaplan.engine2D.MODE_DRAW), wanaplan.engine2D.registerEventCb("WallComponent2D.add-wall.dynamic-draw", this.priority, "dynamic-draw", wanaplan.engine2D.MODE_DRAW, null, this.onAddWallDynamicDraw.bind(this), null), wanaplan.engine2D.registerEventCb("WallComponent2D.add-wall.click", this.priority, "click", wanaplan.engine2D.MODE_DRAW, null, this.onAddWallClick.bind(this), null), wanaplan.engine2D.registerEventCb("WallComponent2D.add-wall.drag-start", this.priority, "drag-start", wanaplan.engine2D.MODE_DRAW, null, this.onAddWallDragStart.bind(this), null), wanaplan.engine2D.registerEventCb("WallComponent2D.add-wall.mouse-move", this.priority, "mouse-move", wanaplan.engine2D.MODE_DRAW, null, this.onAddWallMouseMove.bind(this), null), wanaplan.engine2D.registerEventCb("WallComponent2D.add-wall.draw-end", this.priority, "draw-end", wanaplan.engine2D.MODE_DRAW, null, this.onAddWallDrawEnd.bind(this), null), 1 == t.putPoint) {
            var e = wanaplan.engine2D.getMouseState(), n = wanaplan.getComponentByName("MagnetismComponent2D", wanaplan.ENGINE_2D);
            n.applyPointMag(e), this.onAddWallClick(t, null, e, null)
        }
    }, t.prototype.onAddWallEnd = function() {
        wanaplan.engine2D.setMode(wanaplan.engine2D.MODE_NORMAL)
    }, t.prototype.onAddWallClick = function(t, e, n, i) {
        var o = wanaplan.getComponentByName("MagnetismComponent2D");
        if ("touchUp" == t.type && null != this._tmpWall && this.onAddWallMouseMove(t, e, n, i), wanaplan.getSelectedStructure().dirty(), !i && null != this._tmpWall && this._tmpWall.getLength() <= 10)
            return wanaplan.getComponentByName("PointComponent2D").update(), wanaplan.engine2D.setMode(wanaplan.engine2D.MODE_NORMAL), ujs.notify("wnp.menu.main.deselect"), o && o.onWallDrawEnd(), void wanaplan.engine2D.requestStaticDraw();
        var r = !1;
        if (!i && null != this._tmpWall && (e instanceof WallStructure || e instanceof PointStructure) && (r = !0), null == this._tmpWall)
            this._addWallFirstPoint(n);
        else {
            var s = this._addWallNewPoint(n);
            r || s ? (this._tmpWall = null, wanaplan.getComponentByName("PointComponent2D").update(), wanaplan.getSelectedStructure().update(), wanaplan.engine2D.setMode(wanaplan.engine2D.MODE_NORMAL), ujs.notify("wnp.menu.main.deselect"), o && o.onWallDrawEnd(), wanaplan.engine2D.requestStaticDraw()) : this._addWallFirstPoint(n, this._tmpWall.getPoints(1))
        }
    }, t.prototype.onAddWallDragStart = function(t, e, n) {
        return 0 == (n.buttons & n.BUTTON_LEFT) ? !0 : (this._tmpDragStartPt = n.planPos.clone(), wanaplan.engine2D.registerEventCb("WallComponent2D.add-wall.drag-end", this.priority, "drag-end", wanaplan.engine2D.MODE_DRAG, null, this.onAddWallDragEnd.bind(this), null), wanaplan.engine2D.registerEventCb("WallComponent2D.add-wall.dragging", this.priority, "dragging", wanaplan.engine2D.MODE_DRAG, null, this.onAddWallMouseMove.bind(this), null), !1)
    }, t.prototype.onAddWallDragEnd = function(t, e, n, i) {
        wanaplan.getSelectedStructure().dirty();
        var o = wanaplan.getComponentByName("MagnetismComponent2D");
        if (!i && null != this._tmpWall && this._tmpWall.getLength() <= 10)
            return wanaplan.getComponentByName("PointComponent2D").update(), wanaplan.engine2D.setMode(wanaplan.engine2D.MODE_NORMAL), ujs.notify("wnp.menu.main.deselect"), void (o && o.onWallDrawEnd());
        var r = !1;
        if (null != this._tmpWall && (e instanceof WallStructure || e instanceof PointStructure) && (r = !0), null == this._tmpWall)
            this._addWallFirstPoint(n);
        else {
            var s = this._addWallNewPoint(n);
            r || s ? (this._tmpWall = null, wanaplan.getComponentByName("PointComponent2D").update(), wanaplan.getSelectedStructure().dirty(), wanaplan.engine2D.setMode(wanaplan.engine2D.MODE_NORMAL), ujs.notify("wnp.menu.main.deselect"), o && o.onWallDrawEnd()) : this._addWallFirstPoint(n, this._tmpWall.getPoints(1))
        }
    }, t.prototype.onAddWallMouseMove = function(t, e, n) {
        if (null != this._tmpWall && null == this._tmpDragStartPt)
            this._tmpWall.needsUpdate = !0, this._addWallUpdate(n);
        else if (null != this._tmpDragStartPt && this._tmpDragStartPt.distanceTo(n.planPos) > 10) {
            var n = n;
            n.planPos = this._tmpDragStartPt, this._tmpDragStartPt = null, this.onAddWallClick(t, e, n, !0)
        }
    }, t.prototype.onAddWallDynamicDraw = function(t, e, n) {
        if (null != this._tmpWall) {
            this._tmpWall.getLength() > 5 && (this._tmpWall.computeCp && this._tmpWall.computeCp(!0), this._tmpWall.computeDefault(0), this._tmpWall.computeDefault(1), this._drawWall(t, e, n, this._tmpWall, {styleId: 1}), this.displayMesure && MeasureComponent.drawTmpWallMesure(t, e, n));
            var i = {x: this._tmpWall.points[0].position.x,y: this._tmpWall.points[0].position.y};
            i.x = i.x * n + e.x, i.y = i.y * n + e.y, 1 == this._tmpWall.points[0].parents.length ? wanaplan.engine2D.symbols2D.drawCancelGrip(t, i, [!1, !1, !1, !1], 0) : wanaplan.engine2D.symbols2D.drawCheckGrip(t, i, [!1, !1, !1, !1], 0);
            var o = wanaplan.engine2D.getTarget();
            (o instanceof WallStructure || o instanceof PointStructure) && wanaplan.engine2D.setCursorIcon(wanaplan.engine2D.symbols2D.drawCursorCheck.bind(wanaplan.engine2D.symbols2D))
        }
    }, t.prototype.onAddWallDrawEnd = function() {
        null != this._tmpWall && this._tmpWall.remove(), this._tmpWall = null, this._tmpDragStartPt = null;
        var t = wanaplan.getComponentByName("MagnetismComponent2D", wanaplan.ENGINE_2D);
        t.removeVirtualPoint(this.name, null), wanaplan.engine2D.requestStaticDraw()
    }, t.prototype.onContextMenu = function(t, e) {
        var n = [];
        e.type != e.TYPE_SEPARATOR && (n.push({name: "thickness",label: _("Thickness"),type: "slider",cast: "int",unit: "cm",value: {min: 3,max: 100,step: 1,value: e.thickness}}), n.push({name: "height",label: _("Height"),type: "slider",cast: "int",unit: "cm",value: {min: 20,max: 1e3,step: 10,value: e.height}}), n.push({name: "_applyHeightToAll",label: _("Apply the height to") + "<br />" + _(" all floor's walls"),type: "checkbox",cast: "bool",value: this._applyHeightToAll})), n.push({name: "measureDist",label: _("Mesures distance"),type: "slider",cast: "int",unit: "cm",value: {min: 5,max: 50,step: 1,value: e.measureDist}}), n.push({name: "measureDisplayed",label: _("Display mesures"),type: "checkbox",cast: "bool",value: e.measureDisplayed}), wanaplan.engine2D.displayContextMenu(n, e, this.onContextMenuPropertyChanged.bind(this), this.onContextMenuRemove.bind(this))
    }, t.prototype.onContextMenuPropertyChanged = function(t, e, n) {
        "_applyHeightToAll" == e ? this._applyHeightToAll = n : t[e] = n;
        var i = wanaplan.getSelectedStructure(), o = i.getElements("walls");
        if ("height" != e && "_applyHeightToAll" != e || !this._applyHeightToAll) {
            for (var r = 0, s = 1; s < o.length; s++)
                o[r].height < o[s].height && (r = s);
            i.height = o[r].height
        } else {
            for (var s = 0; s < o.length; s++)
                o[s].height = t.height;
            i.height = t.height
        }
        wanaplan.structure.updateFloorElevations(), t.needsUpdate = !0, wanaplan.engine2D.requestStaticDraw()
    }, t.prototype.onContextMenuRemove = function(t) {
        var e = wanaplan.getSelectedStructure();
        t.remove(e)
    }, t
}(), WallComponent3D = function() {
    var t, e = function(e) {
        BaseComponent3D.call(this, e, "WallComponent3D"), this.walls = [], this.initialized = !1, this.defaultWallTexture = null, this.priority = 10, t = this, this._defaultMaterial = new wnp.WhiteMaterial("defaultWall", wanaplan.engine3D.scene, {factor: 1})
    };
    e.prototype = new BaseComponent3D, e.prototype.onRoomsReady = function(e) {
        var n = e.floor || t.getFloor(), i = e.structure || t.core.getSelectedStructure();
        t.walls.length = 0;
        var o = t.draw(i);
        ujs.notify("wnp.engine3d.wallsReady", {floor: n,structure: i,walls: o})
    }, e.prototype.startListening = function() {
        document.addEventListener("wnp.engine3d.roomsReady", this.onRoomsReady, !1)
    }, e.prototype.stopListening = function() {
        document.addEventListener("wnp.engine3d.roomsReady", this.onRoomsReady, !1)
    }, e.prototype.get3DWallFrom2D = function(t) {
        return wanaplan.engine3D.scene.getMeshByName("WallMesh_" + t.id)
    }, e.prototype.replaceWall = function(t, e) {
        -1 != wanaplan.engine3D.scene.meshes.indexOf(t) && (e.name = t.name, e.id = t.id, e.boundingBoxes = t.boundingBoxes, e.objectInstances = t.objectInstances, e.decorate = t.decorate, e.receiveShadows = t.receiveShadows, t.dispose())
    };
    var n = function(t, e) {
        for (var n, i, o, r = 0, s = this.subMeshes.length; s > r; r++)
            3 * e.faceId >= this.subMeshes[r].indexStart && 3 * e.faceId < this.subMeshes[r].indexStart + this.subMeshes[r].indexCount && (n = this.objectInstances[r], n && (i = this.material.subMaterials[r].name, this.material.subMaterials[r] = t, n.materialInfo ? o = n.addMaterial(t) : "OvertureStructure" == n.name ? (o = n.material.clone(n.material.name), n.material = t) : (o = n.materials[i].clone(i), n.materials[i] = t, n.materials[i].name = i)));
        return o
    };
    return e.prototype.draw = function(t) {
        t = t || wanaplan.getSelectedStructure();
        var e = wanaplan.getComponentByName("RoomComponent2D").getInternalRooms(), i = wanaplan.getComponentByName("RoomComponent2D").getExternalRooms(), o = MeasureComponent.getInternalMeasures(), r = (MeasureComponent.getExternalMeasures(), t.getElements("walls")), s = wanaplan.getComponentByName("FloorComponent3D").getFloor(t), a = new BABYLON.Mesh("WallMesh_" + t.id, wanaplan.engine3D.scene), l = [], h = [], c = [], u = [], p = {};
        a.objectInstances = [], a.material = new BABYLON.MultiMaterial("wall_material", wanaplan.engine3D.scene), a.material.subMaterials.push(new wnp.WhiteMaterial("white", wanaplan.engine3D.scene), new wnp.WhiteMaterial("white", wanaplan.engine3D.scene));
        var d, m, g, f, y, _, v, b, w, x = {}, C = 0, M = 0, D = 1;
        a.boundingBoxes = [];
        var B, A = [], E = new BABYLON.Vector3, T = new BABYLON.Vector3, S = function(t, e, n, i, o, r) {
            var r = r || 0;
            A.length = 0, l.push(t.x, r, -t.y, e.x, r, -e.y), A.push(t.x, r, -t.y, e.x, r, -e.y), l.push(t.x, n, -t.y, e.x, n, -e.y), A.push(t.x, n, -t.y, e.x, n, -e.y), E.copyFromFloats(e.x - t.x, r, -e.y + t.y), T.copyFromFloats(0, n, 0), B = BABYLON.Tools.PlaneUVProjection(A, E, T, 512);
            for (var s = 0, a = B.length; a > s; s++)
                c.push(B[s]);
            o ? (b = !0, u.push(M + 3, M + 1, M), u.push(M, M + 2, M + 3)) : (u.push(M, M + 1, M + 3), u.push(M + 3, M + 2, M), b = !1)
        }, L = function(t) {
            for (var e, n, i = 0, o = t.length; o > i; i++) {
                d = t[i].parent, m = new BABYLON.Vector3(t[i].offsetVector.x, 0, -t[i].offsetVector.y), S(t[i].points[0], t[i].points[1], d.height, e, m), n = t[i].materialInfo && t[i].materialInfo.material ? t[i].materialInfo.material : this._defaultMaterial.clone("defaultWall"), t[i].addMaterial(n), t[i].materialIndex = D + 1, a.material.subMaterials.push(n), g = new BABYLON.Vector3(l[3 * u[3 * C + 1]], l[3 * u[3 * C + 1] + 1], l[3 * u[3 * C + 1] + 2]), f = new BABYLON.Vector3(l[3 * u[3 * C + 2]], l[3 * u[3 * C + 2] + 1], l[3 * u[3 * C + 2] + 2]), w = g.clone().lerp(f, .5), v = -Math.atan2(f.z - g.z, f.x - g.x), _ = f.distanceTo(g);
                var r = new BABYLON.Vector3(-_ / 2, 0, 0).add(w), s = new BABYLON.Vector3(_ / 2, d.height, 0).add(w);
                y = new BABYLON.BoundingBox(new BABYLON.Vector3(Math.min(r.x, s.x), Math.min(r.y, s.y), Math.min(r.z, s.z)), new BABYLON.Vector3(Math.max(r.x, s.x), Math.max(r.y, s.y), Math.max(r.z, s.z))), y.angle = v, x[D] = {indexStart: 3 * C,indexCount: 6,objectInstance: t[i],boundingBox: y}, D++, M += 4, C += 2, "undefined" == typeof p[d.id] && (p[d.id] = []), p[d.id].push([t[i].points[0], t[i].points[1]])
            }
        }.bind(this), O = wanaplan.structure.version;
        "1.2.0.1" == O && this.migrateMaterials(t.walls, o);
        for (var P = 0, I = e.length; I > P; P++)
            e[P].dispatchMaterials(), currentPanes = e[P].panes, L(currentPanes);
        for (var P = 0, I = i.length; I > P; P++)
            i[P].dispatchMaterials(), currentPanes = i[P].panes, L(currentPanes, !0);
        x[0] = {indexStart: 3 * C,indexCount: 0};
        for (var N = PolygonMerger.getCachedDeletedEdges(), P = 0, I = N.length; I > P; P++) {
            var R = !0;
            N[P].parent.type != N[P].parent.TYPE_SEPARATOR && (S(N[P].points[0].position, N[P].points[1].position, N[P].parent.height, 0, R, 0), x[0].indexCount += 6, M += 4, C += 2)
        }
        for (var k, V, F, Y, z = [], P = 0, I = r.length; I > P; P++)
            r[P].type !== r[P].TYPE_SEPARATOR && (k = r[P].getPolygon(), k && (V = BABYLON.Mesh.TriangulateNewMesh("wallTop", k, null, wanaplan.engine3D.scene), V && (F = V.duplicate(), F.invertFaces(), V.position.y = r[P].height, z.push(V), z.push(F))));
        Y = BABYLON.Mesh.mergeMeshes("wallTop", z, wanaplan.engine3D.scene), BABYLON.Mesh.ComputeFlatNormal(l, h, u), a.setVerticesData(BABYLON.VertexBuffer.PositionKind, l), a.setVerticesData(BABYLON.VertexBuffer.NormalKind, h), a.setVerticesData(BABYLON.VertexBuffer.UVKind, c), a.setIndices(u), a.subMeshes = [];
        for (var P in x) {
            var j = BABYLON.SubMesh.CreateFromIndices(+P, x[P].indexStart, x[P].indexCount, a);
            j.boundingBox = x[P].boundingBox, j.objectInstance = x[P].objectInstance
        }
        var W = BABYLON.Mesh.mergeMeshes("WallMesh_" + t.id, [Y, a], wanaplan.engine3D.scene, !0);
        return W.material = a.material, W.isDecorable = !0, wanaplan.engine3D.castShadows(W), W.receiveShadows = !0, W.parent = s, W.decorate = n, this._mesh = W, W
    }, e.prototype.migrateMaterials = function(t, e) {
        for (var n, i, o, r, s = 0, a = t.length; a > s; s++)
            if (t[s].materials) {
                Logger.message("Conversion des materiaux du mur " + s);
                for (var l in t[s].materials)
                    if (r = +1 / 0, n = t[s].materials[l].centroid, i = t[s].materials[l].side, n.y = n.z, i.y = i.z, n.z = 0, i.z = 0, n) {
                        for (var h = null, c = 0, u = e.length; u > c; c++)
                            for (var p = 0, d = e[c].length; d > p; p++)
                                o = e[c][p].center().distanceTo(n), e[c][p].center().distanceTo(n) < r && e[c][p].offsetVector.dot(i) > 0 && void 0 !== t[s].materials[l].params.baseColor && (r = o, h = e[c][p]);
                        h ? (h.addMaterial(t[s].materials[l]), Logger.message("Material " + l + " : succès.")) : Logger.message("Echec non critique pour le material " + l + " : matériau par défaut.")
                    }
            }
        Logger.message("Conversion terminée");
        var m = wanaplan.structure.version.split(".");
        m[1] = +m[1] + 1, wanaplan.structure.version = m.join(".")
    }, e.prototype.switchTransparentStatusByStructure = function(t) {
        var e = (wanaplan.getComponentByName("FloorComponent3D").getFloor(t), this.get3DWallFrom2D(t));
        if (e)
            for (var n, i, o = 0, r = e.subMeshes.length; r > o; o++)
                n = e.subMeshes[o], i = n.getMaterial(), void 0 !== i.alternativeMaterialIndex && switchMaterialIndex(i)
    }, e.prototype.createInstances = function(t) {
        if (t) {
            for (var e = [], n = [], i = [], o = !0, r = [], s = 0, a = 0, l = t.subMeshes.length; l > a; a++) {
                var h = t.subMeshes[a];
                if (h.objectInstance) {
                    e[s] = h.objectInstance;
                    var c;
                    h.objectInstance.materialInfo ? c = h.objectInstance.materialInfo.material : "OvertureStructure" == h.objectInstance.name || "SubSlopeOvertureStructure" == h.objectInstance.name ? c = h.objectInstance.material : "SubSlopeStructure" == h.objectInstance.name && (c = o ? h.objectInstance.materials.bottom : h.objectInstance.materials.top, o = !o), h.materialIndex = s, i[s] = c, h.boundingBox && (n[s] = h.boundingBox), s++
                } else
                    0 == a || 1 == a ? (i[s] = new wnp.WhiteMaterial("white", wanaplan.engine3D.scene, {factor: 0}), h.materialIndex = 0, s++) : r.push(a)
            }
            for (var u = r.length - 1; u >= 0; u--)
                t.subMeshes.splice(r[u], 1);
            t.objectInstances = e, t.boundingBoxes = n, t.material.subMaterials = i
        }
    }, e
}(), RoomStructure = function() {
    var t = 0, e = function() {
        BaseStructure.call(this, "roomStructure"), this.points = [], this.holes = [], this.walls = [], this.parentWallSides = [], this.panes = null, this.cycle = null, this.name = "room_" + t++, this.label = _("Room"), this.color = "#FFFFFF", this.area = 0, this.areaPosition = new BABYLON.Vector2, this.textWidth = 0, this.textHeight = 12, this.materials = {}, this.panesMaterials = [], this.elevation = 0, this.height = 0, this.thickness = 5, this.ceiling = 2
    };
    e.prototype = new BaseStructure, e.Deserialize = function(t) {
        var e = new RoomStructure;
        if (t.color) {
            var n = t.color.indexOf("0x");
            -1 != n && (t.color = "#" + t.color.slice(2))
        }
        return e.deserialize(t), e
    }, e.prototype.serialize = function() {
        var t = {"class": {name: "RoomStructure"}};
        return ujs.serializeObject(this, t, ["id", "label", "color", "isExternal", "elevation", "thickness", "area", "points", "materials", "panes", "ceiling"]), t
    }, e.prototype.deserialize = function(t) {
        return ujs.deserializeObject(t, this, ["id", "label", "color", "isExternal", "elevation", "thickness", "area", "points", "materials", "panes", "ceiling"]), this.panesMaterials = this.panes, this.panes = [], this.processRoomArea(), this
    }, e.prototype.getCenter = function() {
        return this.areaPosition.clone()
    }, e.prototype.setColor = function(t) {
        this.color = t
    }, e.prototype.getWallPanes = function() {
        return this.panes
    }, e.prototype.updatePaneMaterial = function(t, e) {
        t.addMaterial(e), t.materialInfo.center = t.center(), t.materialInfo.normal = t.offsetVector
    }, e.prototype.copy = function(t) {
        this.materials = t.materials, this.panesMaterials = t.panesMaterials, this.elevation = t.elevation, this.thickness = t.thickness, this.color = t.color, this.label = t.label, (2 != t.ceiling || this.ceiling) && (this.ceiling = t.ceiling)
    };
    var n = function(t) {
        for (var e = 0; 2 > e; e++)
            for (var n = 3; n >= 2; n--)
                if (t[e] == t[n])
                    return t[e];
        return Logger.warning("Parenting problem in cycle"), null
    };
    return e.prototype.createFromCycle = function(t) {
        if (t.length < 3)
            return null;
        for (var n = new e, i = t[t.length - 1].position, o = 0, r = t.length; r > o; o++)
            if (!i.distanceTo(t[o].position < .001) && t[o].parents[0] && t[o].parents[1]) {
                n.points.push(t[o].position), n.walls.push(t[o].parents[1]), n.parentWallSides.push(t[o].parentWallSide[1]), n.height = n.walls[0].height;
                for (var s = 0, a = 1, l = n.walls.length; l > a; a++)
                    n.walls[a] && n.walls[a].type === n.walls[a].TYPE_SEPARATOR && s++, s / n.walls.length > .25 && (n.ceiling = !1), n.walls[a] && n.walls[a].height && n.height !== n.walls[a].height && (n.ceiling = !1, n.height = Math.max(n.walls[a].height, n.height))
            } else
                t.splice(o, 1), o--, r--;
        return n.cycle = t, n.createWallPanes(), n.addFloorOnOvertures(t), n
    }, e.prototype.createWallPanes = function() {
        for (var t, e = [], n = 0, i = this.points.length; i > n; n++)
            this.walls[n] && this.walls[n].type !== this.walls[n].TYPE_SEPARATOR && (t = new WallPane3D([this.points[n], this.points[(n + 1) % i]], this.walls[n], this.parentWallSides[n]), t.setRoom(this), e.push(t));
        return this.panes = e, e
    }, e.prototype.dispatchMaterials = function() {
        var t, e = [], n = this.panes.slice(0);
        if (0 !== n.length) {
            for (var i in this.panesMaterials)
                if (this.panesMaterials[i] && this.panesMaterials[i].center && this.panesMaterials[i].normal) {
                    t = null;
                    for (var o, r, s, a = +1 / 0, l = 0, h = n.length; h > l; l++)
                        r = n[l].center(), s = n[l].normal(), o = this.panesMaterials[i].center.distanceTo(r), a > o && this.panesMaterials[i].normal.clone().normalize().dot(s) >= 0 && (a = o, t = l);
                    if (null !== t && (e.push(this.panesMaterials[i]), this.panesMaterials[i].normal = n[t].normal(), this.panesMaterials[i].center = n[t].center(), n[t].materialInfo = this.panesMaterials[i], n.splice(t, 1), 0 === n.length))
                        break
                }
            this.panesMaterials = e
        }
    }, e.prototype.addFloorOnOvertures = function() {
        for (var t = function(t, e) {
            for (var n = 0, i = 0; i < e.length; i++)
                if (e[i] != t && t.width <= e[i].width && (n = e[i].position.subtract(t.position).length(), n - (e[i].width + t.width) / 2 < 0))
                    return !0;
            return !1
        }, e = this.cycle, i = this.points, o = 0, r = function(t, e) {
            return t.position.x - e.position.x
        }, s = function(t, e) {
            return e.position.x - t.position.x
        }, a = 0, l = e.length; l > a; a++) {
            var h = e[a], c = e[(a + 1) % e.length], u = [h.parents[0], h.parents[1], c.parents[0], c.parents[1]], p = n(u);
            if (p && p.overtures.length > 0) {
                var d = p.getNearestPoint(h.position), m = p.getNearestPoint(c.position), g = d.subtract(p.getPoints(0).position).length(), f = m.subtract(p.getPoints(0).position).length();
                p.overtures.sort(m.subtract(d).dot(p.getWallVector()) > 0 ? r : s);
                for (var y = 0, _ = p.overtures.length; _ > y; y++)
                    if (p.overtures[y].parentWall && p.overtures[y].elevation == this.elevation && t(p.overtures[y], p.overtures) !== !0 && (p.overtures[y].position.x >= g && p.overtures[y].position.x <= f || p.overtures[y].position.x >= f && p.overtures[y].position.x <= g)) {
                        var v, b = h.parents.indexOf(p), w = c.parents.indexOf(p);
                        v = h.parentWallSide[b].equals(c.parentWallSide[w]) ? h.parentWallSide[b].clone() : h.parentWallSide[(b + 1) % 2].equals(c.parentWallSide[w]) ? h.parentWallSide[(b + 1) % 2].clone() : c.parentWallSide[(w + 1) % 2].clone(), v.scaleInPlace(p.thickness / 2);
                        var x = p.overtures[y].getAbsolutePos(), C = x.position.subtract(x.vector.scale(p.overtures[y].width / 2)), M = x.position.add(x.vector.scale(p.overtures[y].width / 2)), D = [C.add(v), C.add(v.clone().normalize().scale(.01)), M.add(v.clone().normalize().scale(.01)), M.add(v)];
                        m.subtract(d).dot(C.subtract(M)) > 0 && D.reverse(), D[0].isOverture = !0, D[1].isOverture = !0, D[2].isOverture = !0, D[3].isOverture = !0, i[a + o] && D[0].distanceTo(i[a + o]) < .01 ? i.splice(a + o, 1, D[0], D[1], D[2], D[3]) : i[a + o + 1] && D[3].distanceTo(i[a + o + 1]) < .01 ? i.splice(a + o + 1, 1, D[0], D[1], D[2], D[3]) : i.splice(a + 1 + o, 0, D[0], D[1], D[2], D[3]), o += 4
                    }
            }
        }
    }, e.prototype.eql = function(t) {
        for (var e = 0; e < this.points.length; e++)
            if (this.points[e].isInArray(t.points, !1) === !1)
                return !1;
        return !0
    }, e.prototype.isPointIn = function(t) {
        return this.points ? t.isPointInPolygon(this.points) ? !0 : !1 : void 0
    }, e.prototype.getRoomArea = function(t) {
        return this.area > 0 && !t ? this.area : this.processRoomArea()
    }, e.prototype.processRoomArea = function() {
        var t = this.points, e = t[0], n = 0, i = 0, o = 0;
        for (var r in t)
            n += (e.x + t[r].x) * (e.x * t[r].y - t[r].x * e.y), i += (e.y + t[r].y) * (e.x * t[r].y - t[r].x * e.y), o += e.x * t[r].y - t[r].x * e.y, e = t[r];
        o += e.x * t[0].y - t[0].x * e.y, n += (e.x + t[0].x) * (e.x * t[0].y - t[0].x * e.y), i += (e.y + t[0].y) * (e.x * t[0].y - t[0].x * e.y);
        var s = .5 * o;
        return this.area = Math.abs(s), this.areaPosition.x = 1 * n / (6 * s), this.areaPosition.y = 1 * i / (6 * s), Math.abs(s)
    }, e.prototype.orientedArea = function() {
        for (var t = this.points.length, e = 0, n = t - 1, i = 0; t > i; n = i++)
            e += this.points[n].x * this.points[i].y - this.points[i].x * this.points[n].y;
        return .5 * e
    }, e.prototype.reversePath = function() {
        this.points.reverse()
    }, e.prototype.toVec2Array = function() {
        for (var t = [], e = 0, n = this.points.length; n > e; e++)
            t.push(new BABYLON.Vector2(this.points[e].x, this.points[e].y));
        return t
    }, e.prototype.getOverlappingRectArea = function(t) {
        var e = this.getBoundingBox(), n = t.getBoundingBox();
        e.intersect(n);
        var i = e.maximum.x - e.minimum.x, o = e.maximum.y - e.minimum.y, r = i * o;
        return r = 0 > i || 0 > o ? 0 : r
    }, e.prototype.getLikelihood = function(t) {
        var e = 0, n = 0, i = 1, o = this.getRoomArea(), r = t.getRoomArea(), s = this.areaPosition.clone(), a = t.areaPosition.clone(), l = 1 - Math.abs(o - r) / Math.max(o, r), h = this.getOverlappingRectArea(t) / Math.min(o, r), c = 1 / (1 + s.distanceTo(a));
        return e * h + n * l + i * c
    }, e.prototype.getBoundingBox = function() {
        return BABYLON.BoundingBox.CreateFromPoints(this.points)
    }, e.prototype.getAvailableProperties = function() {
        return []
    }, e.prototype.remove = function() {
    }, e
}(), RoomHierarchy = function() {
    var t = function() {
        this.room = null, this.center = null, this.parent = null, this.children = []
    };
    t.prototype.contains = function(t) {
        return t.center ? this.room.isPointIn(t.center) : !1
    }, t.prototype.insert = function(t) {
        if (this.contains(t)) {
            for (var e = 0, n = this.children.length; n > e; e++)
                if (this.children[e].insert(t))
                    return !0;
            for (var e = this.children.length - 1; e >= 0; e--)
                t.insert(this.children[e]) && this.children.splice(e, 1);
            return this.children.push(t), t.parent = this, !0
        }
        return !1
    }, t.fromRoom = function(e) {
        if (e.points.length < 3)
            return null;
        var n = new t;
        return n.room = e, n.center = e.points[0].clone().lerp(e.points[1], .5), n
    };
    var e = function() {
        t.call(this)
    };
    e.prototype = new t, e.prototype.contains = function() {
        return !0
    };
    var n = function(n) {
        this.tree = new e;
        for (var i = 0, o = n.length; o > i; i++)
            this.tree.insert(t.fromRoom(n[i]))
    };
    return n.prototype.discrimineRooms = function(t, e) {
        for (var n = function(i, o) {
            o ? e.push(i.room) : t.push(i.room);
            for (var r = 0, s = i.children.length; s > r; r++)
                n(i.children[r], !o)
        }, i = 0, o = this.tree.children.length; o > i; i++)
            n(this.tree.children[i], !0)
    }, n.prototype.adjustRooms = function() {
        for (var t = null, e = function(n, i) {
            n.room.isExternal = i;
            for (var o = 0, r = n.children.length; r > o; o++)
                i || (t = n.children[o], n.room.area -= t.room.area, n.room.holes.push(t.room.points.slice(0))), e(n.children[o], !i)
        }, n = 0, i = this.tree.children.length; i > n; n++)
            e(this.tree.children[n], !0)
    }, n
}(), RoomComponent2D = function() {
    var t = function(t) {
        BaseComponent2D.call(this, t, "RoomComponent2D"), this.priority = 9, this.rooms = [], this._remainings = 0, this.internalRooms = [], this.externalRooms = [], this.useCache = !1, this.displayRoomName = !0, this.core.engine2D.registerEventCb("RoomComponent2D.static-draw", this.priority, "static-draw", null, null, this.onStaticDraw.bind(this), null), this.core.engine2D.registerEventCb("RoomComponent2D.room.click", this.priority, "click", this.core.engine2D.MODE_NORMAL, RoomStructure, this.onContextMenu.bind(this), {})
    };
    return t.prototype = new BaseComponent2D, t.prototype.update = function(t) {
        return t || wanaplan.getSelectedStructure().isDirty() ? (t = t || wanaplan.getSelectedStructure(), this.useCache ? (this.useCache = !1, this.computeRooms(t, PolygonMerger.getCachedCycles())) : this.computeRooms(t)) : void 0
    }, t.prototype.removeBiggestArea = function() {
        for (var t, e = 0, n = 0, i = this.rooms.length; i > n; n++)
            this.rooms[n].getRoomArea() > e && (t = n, e = this.rooms[n].getRoomArea());
        return this.internalRooms.splice(t, 1), this.rooms.splice(t, 1)
    }, t.prototype.getExternalWalls = function(t) {
        return Logger.warning("getExternalWalls is deprecated"), null
    }, t.prototype.getAllSubSlopes = function(t) {
        var t = t || wanaplan.getSelectedStructure(), e = t.getElements("internalRooms");
        0 != e.length && e[0].cycle || (this.update(t), e = t.getElements("internalRooms"));
        for (var n = [], i = function(t, e) {
            var n = 1e-4;
            return t.subtract(e).lengthSquared() < n
        }, o = function(t, e) {
            for (var o = 0, r = n.length; r > o; o++)
                if (t == n[o].wall && i(e, n[o].side[0]))
                    return n[o];
            return null
        }, r = function(t, e) {
            if (t.parents[e]) {
                var i = o(t.parents[e], t.parentWallSide[e]);
                i || (i = n[n.push(new SubSlopeStructure) - 1], i.wall = t.parents[e]), i.points.push(t.position), i.side.push(t.parentWallSide[e]), i.neighbors.push(t.parents[(e + 1) % 2])
            }
        }, s = 0; s < e.length; s++)
            if (!e[s].isExternal)
                for (var a = 0; a < e[s].cycle.length; a++)
                    r(e[s].cycle[a], 0), r(e[s].cycle[a], 1);
        return n
    }, t.prototype.getInternalRooms = function() {
        return this.internalRooms
    }, t.prototype.getExternalRooms = function() {
        return this.externalRooms
    }, t.prototype.identifyRooms = function(t, e) {
        var n, i, o = function(t, e) {
            return e.area - t.area
        }, r = [];
        t.length <= e.length ? (n = t, i = e.slice(0)) : (n = e, i = t.slice(0)), n.sort(o), i.sort(o);
        for (var s = 0, a = n.length; a > s; s++) {
            for (var l = i[0], h = n[s].getLikelihood(i[0]), c = 0; c < i.length; c++) {
                var u = n[s].getLikelihood(i[c]);
                u > h && (l = i[c], h = u)
            }
            i.splice(i.indexOf(l), 1), r.push(l)
        }
        return r
    }, t.prototype.dispatchRooms = function(t, e) {
        var n = e.getElements(t), i = this.identifyRooms(this[t], n);
        if (n.length > 0)
            if (this[t].length <= n.length)
                for (var o = 0; o < i.length; o++)
                    this[t][o].copy(i[o]);
            else
                for (var o = 0; o < i.length; o++)
                    i[o].copy(n[o])
    }, t.prototype.computeRooms = function(t, e) {
        var n, i = t || this.structure.getCurrentStructure(), o = [];
        if (this.internalRooms.length = 0, this.externalRooms.length = 0, n = e || PolygonMerger.merge(i.getElements("walls"))) {
            for (var r = 0, s = n.length; s > r; r++) {
                var a = RoomStructure.prototype.createFromCycle(n[r]);
                a.points.length < 3 || (a.processRoomArea(), o.push(a))
            }
            this.rooms = o;
            var l = new RoomHierarchy(o);
            if (window.ejecta && o.length) {
                this.internalRooms = [];
                for (var r = 0, s = o.length - 1; s > r; r++)
                    this.internalRooms.push(o[r])
            }
            l.discrimineRooms(this.internalRooms, this.externalRooms), l.adjustRooms(), this.dispatchRooms("internalRooms", i), this.dispatchRooms("externalRooms", i), this.internalRooms.forEach(function(t) {
                t.dispatchMaterials()
            }), this.externalRooms.forEach(function(t) {
                t.dispatchMaterials()
            }), i.replaceElements("internalRooms", this.internalRooms), i.replaceElements("externalRooms", this.externalRooms)
        }
    }, t.prototype.getTargeted = function(t) {
        for (var e = this.structure.getCurrentStructure().getElements("internalRooms"), n = this.core.engine2D.getZoom(), i = 0, o = e.length; o > i; i++) {
            var r = e[i].areaPosition;
            if (!e[i].textWidth) {
                var s = wanaplan.engine2D.canvas.getContext("2d");
                e[i].textWidth = s.measureText(e[i].label).width
            }
            var a = r.x - e[i].textWidth / 2 / n, l = r.x + e[i].textWidth / 2 / n, h = r.y - e[i].textHeight / n, c = r.y + e[i].textHeight / n;
            if (t.x <= l && t.x >= a && t.y <= c && t.y >= h)
                return e[i]
        }
        return null
    }, t.prototype.onContextMenu = function(t, e) {
        var n = [];
        n.push({name: "label",label: _("Name"),type: "text",cast: "string",value: e.label}), n.push({name: "ceiling",label: _("Ceiling"),type: "checkbox",value: e.ceiling}), n.push({name: "elevation",label: _("Elevation"),type: "slider",cast: "int",unit: "cm",value: {min: 0,max: 80,step: 1,value: e.elevation}}), n.push({name: "thickness",label: _("Thickness"),type: "slider",cast: "int",unit: "cm",value: {min: 5,max: 100,step: 1,value: e.thickness}}), this.core.engine2D.displayContextMenu(n, e, this.onContextMenuPropertyChanged.bind(this))
    }, t.prototype.onContextMenuPropertyChanged = function(t, e, n) {
        t[e] = n
    }, t.prototype.onStaticDraw = function(t, e, n) {
        this.drawRooms(t, e, n)
    }, t.prototype.drawRooms = function(t, e, n) {
        var i = wanaplan.getSelectedStructure();
        for (var o in i.internalRooms)
            i.internalRooms[o].area > 250 && this.drawRoom(i.internalRooms[o], t, e, n)
    }, t.prototype.isPointInRooms = function(t) {
        for (var e = 0; e < this.rooms.length; e++) {
            var n = this.rooms[e];
            if (n.isPointIn(t))
                return n
        }
        return !1
    }, t.prototype.drawRoom = function(t, e, n, i) {
        if (t && 0 != t.draw) {
            var e = e || this.ctx;
            e.fillStyle = t.color || "#ffffff", e.beginPath();
            for (var o = 0; o < t.points.length; o++) {
                var r = t.points[o].scale(i).addInPlace(n);
                0 == o ? e.moveTo(r.x, r.y) : e.lineTo(r.x, r.y)
            }
            if (e.fill(), this.displayRoomName) {
                var s = t.areaPosition.scale(i).addInPlace(n);
                e.font = "normal 9pt sans-serif", e.textBaseline = "middle", e.textAlign = "center", e.fillStyle = this.core.engine2D.symbols2D.COLOR_ANNOTATION, e.fillText(t.label, s.x, s.y - 7), e.fillText(Math.round(t.area / 100) / 100 + " m²", s.x, s.y + 7)
            }
        }
    }, t
}(), RoomComponent3D = function() {
    var t, e = function(e) {
        BaseComponent3D.call(this, e, "RoomComponent3D"), this._defaultRoomTextures = {diffuseTexture: new BABYLON.Texture(wnp.Assets.roomTextures.diffuse, wanaplan.engine3D.scene),specularTexture: new BABYLON.Texture(wnp.Assets.roomTextures.specular, wanaplan.engine3D.scene),bumpTexture: new BABYLON.Texture(wnp.Assets.roomTextures.normal, wanaplan.engine3D.scene)}, this._defaultMaterial = new wnp.WoodMaterial("floor", wanaplan.engine3D.scene), this._defaultMaterial.diffuseTexture = this._defaultRoomTextures.diffuseTexture, this._defaultMaterial.bumpTexture = this._defaultRoomTextures.bumpTexture, this._defaultCeiling = new wnp.WhiteMaterial("CeilingBasic", wanaplan.engine3D.scene), this._commonMaterials = [new wnp.WhiteMaterial("FloorSide_common", wanaplan.engine3D.scene), new wnp.WhiteMaterial("Ceiling_common", wanaplan.engine3D.scene)], this._materialOffset = 0, t = this
    };
    e.prototype = new BaseComponent3D, e.prototype.getSideMaterial = function() {
        return this._defaultMaterial
    }, e.prototype.setSideMaterial = function(t) {
        this._defaultMaterial = t
    }, e.prototype.getCeilingMaterial = function() {
        return this._defaultCeiling
    }, e.prototype.setCeilingMaterial = function(t) {
        this._defaultCeiling = t
    }, e.prototype.onContextChanged = function(t) {
        "3D" == t ? this.initialized || (document.addEventListener("wnp.engine3d.floorReady", this.onFloorReady, !1), this.initialized = !0) : this.initialized && (document.removeEventListener("wnp.engine3d.floorReady", this.onFloorReady, !1), this.initialized = !1)
    }, e.prototype.onFloorReady = function(e) {
        var n = e.floor || t.getFloor(), i = e.structure || t.core.getSelectedStructure();
        wanaplan.getComponentByName("RoomComponent2D").update(i);
        var o = i.getElements("hoppers"), r = wanaplan.structure.getElement(i.id + 1), s = i.getElements("internalRooms");
        if (r)
            var a = t.build(s, o, n, r.hoppers);
        else
            var a = t.build(s, o, n, []);
        t.mesh = a, ujs.notify("wnp.engine3d.roomsReady", {floor: n,structure: i})
    };
    var n = function(t, e) {
        for (var n, i, o = 0, r = this.subMeshes.length; r > o; o++)
            3 * e.faceId >= this.subMeshes[o].indexStart && 3 * e.faceId < this.subMeshes[o].indexStart + this.subMeshes[o].indexCount && (n = this.objectInstances[this.subMeshes[o].materialIndex], n && (i = this.material.subMaterials[this.subMeshes[o].materialIndex].clone(this.material.subMaterials[this.subMeshes[o].materialIndex].name), t.name = i.name, n.materials[i.name] = t, this.material.subMaterials[this.subMeshes[o].materialIndex] = t));
        return i
    };
    return e.prototype.build = function(t, e, i, o) {
        for (var r = [], s = 0, a = 0, l = t.length; l > a; a++) {
            var h = this.createRoom(t[a], 0, t[a].height);
            s < t[a].height && (s = t[a].elevation), h && (r.push(h.floor), r.push(h.ceiling))
        }
        var c = BABYLON.Mesh.mergeMeshes("RoomMesh_" + i.structure.id, r, wanaplan.engine3D.scene, !0);
        if (c.material = new BABYLON.MultiMaterial("RoomMaterial", wanaplan.engine3D.scene), c.isDecorable = !0, c.decorate = n, c.parent = i, i.roomMesh = c, c.receiveShadows = !0, wanaplan.engine3D.scene.lights.point.excludedMeshes.push(c), HopperComponent3D) {
            for (var u = 0; u < e.length; u++)
                c = HopperComponent3D.Build(c, e[u], 0, s + 5);
            for (var u = 0; u < o.length; u++)
                c = HopperComponent3D.Build(c, o[u], i.structure.height - 10)
        }
        return c
    }, e.prototype.normalizePolygon = function(t) {
        for (var e = [], n = 0, i = t.length; i > n; n++)
            t[n].isOverture || e.push(t[n]);
        return e
    }, e.prototype.createRoom = function(t, e, n) {
        var i, o = (this.core.getComponentByName("HopperComponent3D", this.core.ENGINE_3D), t.points);
        if (o.length < 3)
            return !1;
        if (i = BABYLON.Mesh.ExtrudeNewMesh("room", o, null, {amount: 5 + t.elevation}, wanaplan.engine3D.scene))
            var r = BABYLON.Mesh.TriangulateNewMesh("ceiling", o, [], wanaplan.engine3D.scene, n - .1);
        else {
            var s = this.normalizePolygon(t.points);
            i = BABYLON.Mesh.ExtrudeNewMesh("room", s, null, {amount: 5 + t.elevation}, wanaplan.engine3D.scene);
            var r = BABYLON.Mesh.TriangulateNewMesh("ceiling", s, [], wanaplan.engine3D.scene, n - .1);
            if (!i)
                return null
        }
        r.invertFaces(), r.invertNormales(), t.materials.floor = t.materials.floor || this._defaultMaterial.clone("floor"), t.materials.ceiling = t.materials.ceiling || this._defaultCeiling.clone("ceiling"), t.ceiling ? t.materials.ceiling.oldAlpha && (t.materials.ceiling.alpha = t.materials.ceiling.oldAlpha) : (t.materials.ceiling.oldAlpha = t.materials.ceiling.alpha, t.materials.ceiling.alpha = 0);
        var a = i.getBoundingBox();
        a.ceil = !1;
        var l = r.getBoundingBox();
        l.ceil = !0, i.receiveShadows = !0;
        for (var h = 0, c = t.holes.length; c > h; h++)
            i = this.carveHole(i, t.holes[h], t.elevation + n), r = this.carveHole(r, t.holes[h], t.elevation + n);
        return i.subMeshes[0].objectInstance = t, i.subMeshes[0].boundingBox = a, r.subMeshes[0].objectInstance = t, r.subMeshes[0].boundingBox = l, {floor: i,ceiling: r}
    }, e.prototype.carveHole = function(t, e, n) {
        var i = BABYLON.CSG.FromMesh(t), o = BABYLON.Mesh.ExtrudeNewMesh("hopper_temp", e, null, {amount: n}, wanaplan.engine3D.scene);
        if (!o)
            return t;
        o.parent = t.parent, o.material = this._commonMaterials[0];
        var r = BABYLON.CSG.FromMesh(o), s = i.subtract(r), a = s.toMesh("room_global", t.material, wanaplan.engine3D.scene, !1);
        return a.parent = t.parent, o.dispose(), this.replaceRoom(t, a), a
    }, e.prototype.replaceRoom = function(t, e) {
        -1 != wanaplan.engine3D.scene.meshes.indexOf(t) && (e.name = t.name, e.id = t.id, e.parent = t.parent, e.boundingBoxes = t.boundingBoxes, e.objectInstances = t.objectInstances, e.decorate = t.decorate, e.receiveShadows = t.receiveShadows, wanaplan.engine3D.scene.lights.point.excludedMeshes.push(e), t.dispose(), this.mesh = e)
    }, e.prototype.createInstances = function(t) {
        if (t) {
            for (var e, n = [], i = [], o = [], r = 0, s = 0, a = t.subMeshes.length; a > s; s++) {
                var l = t.subMeshes[s];
                if (l.objectInstance) {
                    if (n[s] = l.objectInstance, l.boundingBox)
                        if (l.boundingBox.ceil)
                            var h = l.objectInstance.materials.ceiling;
                        else
                            var h = l.objectInstance.materials.floor;
                    else
                        var h = l.objectInstance.material;
                    o[s] = h
                } else
                    e || (e = s), r++;
                l.materialIndex = s, l.boundingBox && (i[s] = l.boundingBox)
            }
            e && t.subMeshes.splice(e, r), t.objectInstances = n, t.boundingBoxes = i, t.material.subMaterials = o
        }
    }, e
}();
OvertureStructure = function() {
    var t = function() {
        BaseStructure.call(this, "OvertureStructure");
        this.type = "Door", this.position = new BABYLON.Vector2, this.width = 73, this.height = 200, this.thickness = 7, this.elevation = 0, this.hinge = 0, this.side = -1, this.nbCasement = 1, this.parentWall = null, this.minsize = 15, this.sliding = !1, this.galandage = !1, this.batiThickness = 5, this.programmableInstance = null, this.plinte = 1
    };
    return t.prototype = new BaseStructure, t.prototype.serialize = function() {
        var t = {"class": {name: "OvertureStructure"}};
        return ujs.serializeObject(this, t, null, ["parentWall"]), t
    }, t.Deserialize = function(t) {
        var e = new OvertureStructure;
        return ujs.deserializeObject(t, e), e
    }, t.prototype.checkCoherence = function(t) {
        this.getParentWall() ? this.width = Math.min(this.width, this.parentWall.getWallVector().length() - 24) : this.remove(t)
    }, t.prototype.getParentWall = function() {
        return this.parentWall
    }, t.prototype.setParentWall = function(t) {
        if (t != this.parentWall) {
            null != this.parentWall && this.parentWall.overtures.splice(this.parentWall.overtures.indexOf(this), 1), this.parentWall = t;
            for (var e = 0; e < this.parentWall.overtures.length; e++) {
                var n = this.parentWall.overtures[e];
                if (this.id == n.id)
                    return
            }
            this.parentWall.overtures.push(this)
        }
    }, t.prototype.computePositionOnWallChange = function(t) {
        var e = this.parentWall, n = this.position.x, i = e.getWallVector().normalize().scaleInPlace(n), o = t.getPoints(0).position.subtract(e.getPoints(0).position), r = i.subtract(o), s = r.length();
        return this.position.x = s, this.side *= Math.sign(e.getWallVector().dot(t.getWallVector())), s
    }, t.prototype.projectOnWall = function() {
        if (this.parentWall) {
            var t, e = this.parentWall, n = e.getLength();
            t = n < this.width ? .5 * this.width : ujs.Math.clamp(Math.abs(this.position.x), .5 * this.width, e.getLength() - .5 * this.width), this.position.x = t * Math.sign(this.position.x)
        }
    }, t.prototype.getAbsolutePos = function() {
        var t = this.parentWall.getWallVector().normalize(), e = t.scale(this.position.x).addInPlace(this.parentWall.getPoints(0).position);
        return {position: e,vector: t}
    }, t.prototype.getAngle = function() {
        var t = this.parentWall.getWallVector().normalize();
        return Math.atan2(t.y, t.x)
    }, t.prototype.getPolygon = function() {
        var t = new BABYLON.Vector2, e = new BABYLON.Vector2, n = this.getAbsolutePos(), i = this.parentWall.getNormalVector(this.parentWall.thickness / 2);
        return t = n.position.subtract(n.vector.scale(this.width / 2)), e = n.position.add(n.vector.scale(this.width / 2)), [t.add(i), e.add(i), e.subtract(i), t.subtract(i)]
    }, t.prototype.clampSize = function(t, e) {
        var t = t || !1;
        if (!this.parentWall || this.parentWall.getLength() < this.minsize && t)
            return void this.remove(e);
        var n = this.getAbsolutePos();
        this.width = BABYLON.Math.clamp(this.width, this.minsize, Math.min(2 * n.position.distanceTo(this.parentWall.getPoints(0).position), 2 * n.position.distanceTo(this.parentWall.getPoints(1).position)))
    }, t.prototype.remove = function(t) {
        this.parentWall && this.parentWall.overtures.splice(this.parentWall.overtures.indexOf(this), 1), this.parentWall = null, void 0 != t && t.removeElement("overtures", this)
    }, t
}();
var OvertureComponent2D = function() {
    var t = function(t) {
        BaseComponent2D.call(this, t, "OvertureComponent2D"), this.COLOR = "#888", this.MINSIZE = 30, this.priority = 60, this.overtureDragged = !1, this._applyToAll = !1
    };
    return t.prototype = new BaseComponent2D, t.prototype.startListening = function() {
        this.onAddOverture = this.onAddOverture.bind(this), this.onAddOvertureEnd = this.onAddOvertureEnd.bind(this), this.onStaticDraw = this.onStaticDraw.bind(this), this.onHover = this.onHover.bind(this), this.onLeave = this.onLeave.bind(this), this.onContextMenu = this.onContextMenu.bind(this), this.onDoubleClick = this.onDoubleClick.bind(this), document.addEventListener("wnp.engine2d.onAddOverture", this.onAddOverture, !1), document.addEventListener("wnp.engine2d.onAddOvertureEnd", this.onAddOvertureEnd, !1), wanaplan.engine2D.registerEventCb("OvertureComponent2D.static-draw", this.priority, "static-draw", null, null, this.onStaticDraw, null), wanaplan.engine2D.registerEventCb("OvertureComponent2D.drag-start", this.priority, "drag-start", wanaplan.engine2D.MODE_NORMAL, OvertureStructure, this.onDragStart.bind(this), null), wanaplan.engine2D.registerEventCb("OvertureComponent2D.hover", this.priority, "hover", wanaplan.engine2D.MODE_NORMAL | wanaplan.engine2D.MODE_DRAG | wanaplan.engine2D.MODE_CONTEXTMENU, OvertureStructure, this.onHover, null), wanaplan.engine2D.registerEventCb("OvertureComponent2D.leave", this.priority, "leave", wanaplan.engine2D.MODE_NORMAL | wanaplan.engine2D.MODE_CONTEXTMENU, OvertureStructure, this.onLeave, null), wanaplan.engine2D.registerEventCb("OvertureComponent2D.context-menu", this.priority, "click", wanaplan.engine2D.MODE_NORMAL, OvertureStructure, this.onContextMenu, null), wanaplan.engine2D.registerEventCb("OvertureComponent2D.double-click", this.priority, "double-click", wanaplan.engine2D.MODE_NORMAL, OvertureStructure, this.onDoubleClick, null)
    }, t.prototype.stopListening = function() {
        document.removeEventListener("wnp.engine2d.onAddOverture", this.onAddOverture, !1), document.removeEventListener("wnp.engine2d.onAddOvertureEnd", this.onAddOvertureEnd, !1), wanaplan.engine2D.unregisterEventCb("OvertureComponent2D.static-draw"), wanaplan.engine2D.unregisterEventCb("OvertureComponent2D.drag-start"), wanaplan.engine2D.unregisterEventCb("OvertureComponent2D.hover"), wanaplan.engine2D.unregisterEventCb("OvertureComponent2D.leave"), wanaplan.engine2D.unregisterEventCb("OvertureComponent2D.context-menu"), wanaplan.engine2D.unregisterEventCb("OvertureComponent2D.double-click")
    }, t.prototype.initialize = function() {
        var t, e = [["doors", _("Opening"), "Overture", 0, 90, 204, 0, !1, !1], ["doors", _("Simple Door"), "Door", 0, 73, 204, 1, !1, !1], ["doors", _("Bi-Fold Door"), "Door", 0, 140, 204, 2, !1, !1], ["doors", _("Sliding Door"), "Door", 0, 140, 204, 2, !0, !1], ["doors", _("Garage Door"), "Garage", 0, 240, 200, 3, !1, !1], ["bay_windows", _("Fixed Bay Window"), "Window", 0, 80, 215, 1, !0, !1], ["bay_windows", _("French Door"), "Window", 0, 80, 215, 1, !1, !1], ["bay_windows", _("Bi-Fold French Door"), "Window", 0, 120, 215, 2, !1, !1], ["bay_windows", _("Sliding Bay Window"), "Window", 0, 160, 215, 2, !0, !1], ["windows", _("Opening"), "Overture", 90, 80, 125, 0, !1, !1], ["windows", _("Fixed Window"), "Window", 90, 60, 125, 1, !0, !1], ["windows", _("Single Casement"), "Window", 90, 80, 125, 1, !1, !1], ["windows", _("Double Casement"), "Window", 90, 100, 125, 2, !1, !1], ["windows", _("Sliding Window"), "Window", 90, 100, 125, 2, !0, !1]];
        t = {title: _("Doors"),id: "doors",items: []}, ujs.notify("wnp.menu.main.add", {item: t,menuPath: "draw2D",position: 1}), t = {title: _("Bay Windows"),id: "bay_windows",items: []}, ujs.notify("wnp.menu.main.add", {item: t,menuPath: "draw2D",position: 2}), t = {title: _("Windows"),id: "windows",items: []}, ujs.notify("wnp.menu.main.add", {item: t,menuPath: "draw2D",position: 3});
        for (var n in e)
            t = {title: e[n][1],action: "wnp.engine2d.onAddOverture",cancelAction: "wnp.engine2d.onAddOvertureEnd",params: {overtureType: e[n][2],elevation: e[n][3],width: e[n][4],height: e[n][5],nbCasement: e[n][6],sliding: e[n][7],galandage: e[n][8]}}, ujs.notify("wnp.menu.main.add", {item: t,menuPath: "draw2D." + e[n][0],position: n})
    }, t.prototype.getTargeted = function(t) {
        var e, n, i = this.structure.getCurrentStructure(), o = i.getElements("walls"), r = new BABYLON.Vector2, s = new BABYLON.Vector2, a = 0, l = 0, h = 0, c = null, u = null;
        for (l = 0, h = o.length; h > l; l++)
            if (r = t.subtract(o[l].getPoints(0).position), s.copyFrom(r), n = o[l].getWallVector(), r.projectOnVector(n), s.subtractInPlace(r), s.length() <= o[l].thickness / 2 + 5)
                for (a = o[l].overtures.length - 1; a >= 0; a--)
                    if (c = o[l].overtures[a].position.x - o[l].overtures[a].width / 2 - 13, u = o[l].overtures[a].position.x + o[l].overtures[a].width / 2 + 13, e = r.length() * Math.sign(r.dot(n)), e > c && u > e)
                        return o[l].overtures[a];
        return null
    }, t.prototype._drawOverture = function(t, e, n, i) {
        if (i.getParentWall() || i.remove(wanaplan.getSelectedStructure()), t.save(), t.strokeStyle = this.COLOR, t.translate(Math.round(i.getParentWall().getPoints(0).position.x * n) + e.x, Math.round(i.getParentWall().getPoints(0).position.y * n) + e.y), t.rotate(Math.atan2(-i.getParentWall().getWallVector().x, i.getParentWall().getWallVector().y) + Math.PI / 2), t.translate(Math.round(i.position.x * n), 0), t.fillStyle = "#fff", t.fillRect(Math.round(-i.width / 2 * n), Math.round(-i.getParentWall().thickness / 2 * n) - 1, Math.round(i.width * n), Math.round(i.getParentWall().thickness * n) + 2), t.fillStyle = this.COLOR, t.fillRect(Math.round(-i.width / 2 * n), Math.round(-i.getParentWall().thickness / 2 * n), Math.round(i.width * n), Math.round(i.getParentWall().thickness * n)), i.sliding) {
            t.strokeStyle = "rgba(255, 255, 255, .8)", t.fillStyle = "rgba(255, 255, 255, .4)", t.beginPath();
            var o = Math.round((i.getParentWall().thickness / 2 - 4) * n) + .5, r = Math.round(i.width / 2 * n);
            if (1 == i.nbCasement)
                t.rect(-r + .5, Math.round(-o / 2) - .5, Math.round(i.width * n) - 1, Math.round(o));
            else {
                var s = i.width / i.nbCasement * n;
                t.moveTo(r - .5, -.5), t.lineTo(-r + .5, -.5);
                for (var a = 0, l = -r + .5, h = o; a <= i.nbCasement; a++, l += s, h = -h)
                    l > r - s / 2 && r + s / 2 > l && (l = r - .5), a > 0 && t.lineTo(Math.round(l) - .5, -h), a < i.nbCasement && t.lineTo(Math.round(l) - .5, h);
                t.closePath()
            }
            t.fill(), t.stroke()
        } else
            "Garage" == i.type ? (-1 == i.side && t.rotate(Math.PI), t.strokeRect(Math.round(-i.width / 2 * n) + .5, Math.round(-i.getParentWall().thickness / 2 * n) + .5, Math.round(i.width * n), Math.round(i.height * n)), t.beginPath(), t.moveTo(Math.round(-i.width / 2 * n), Math.round(+i.getParentWall().thickness / 2 * n)), t.lineTo(0, Math.round((i.height - i.getParentWall().thickness / 2) * n)), t.lineTo(Math.round(i.width / 2 * n), Math.round(+i.getParentWall().thickness / 2 * n)), t.stroke()) : 1 == i.nbCasement ? (-1 == i.side && t.rotate(Math.PI), t.beginPath(), 0 == i.hinge ? (t.arc(Math.round(-i.width / 2 * n) + .5, Math.round(i.getParentWall().thickness / 2 * n) + .5, Math.round(i.width * n), 0, Math.PI / 2, !1), t.lineTo(Math.round(-i.width / 2 * n) + .5, Math.round(i.getParentWall().thickness / 2 * n) + .5)) : (t.arc(Math.round(i.width / 2 * n) + .5, Math.round(i.getParentWall().thickness / 2 * n) + .5, Math.round(i.width * n), Math.PI, Math.PI / 2, !0), t.lineTo(Math.round(i.width / 2 * n) + .5, Math.round(i.getParentWall().thickness / 2 * n) + .5)), t.stroke()) : 2 == i.nbCasement && (-1 == i.side && t.rotate(Math.PI), t.beginPath(), t.arc(Math.round(-i.width / 2 * n) + .5, Math.round(i.getParentWall().thickness / 2 * n) + .5, Math.round(i.width / 2 * n), 0, Math.PI / 2, !1), t.lineTo(Math.round(-i.width / 2 * n) + .5, Math.round(i.getParentWall().thickness / 2 * n) + .5), t.stroke(), t.beginPath(), t.arc(Math.round(i.width / 2 * n) + .5, Math.round(i.getParentWall().thickness / 2 * n) + .5, Math.round(i.width / 2 * n), Math.PI, Math.PI / 2, !0), t.lineTo(Math.round(i.width / 2 * n) + .5, Math.round(i.getParentWall().thickness / 2 * n) + .5), t.stroke());
        t.restore()
    }, t.prototype.compute = function() {
        for (var t = this.structure.getCurrentStructure(), e = t.getElements("walls"), n = 0; n < e.length; n++)
            for (var i = e[n].overtures.length - 1; i >= 0; i--)
                e[n].overtures[i].parentWall && e[n].overtures[i].parentWall.id != e[n].id && e[n].overtures.splice(i, 1)
    }, t.prototype.onStaticDraw = function(t, e, n) {
        var i = this.structure.getCurrentStructure().getElements("overtures");
        for (var o in i)
            this._drawOverture(t, e, n, i[o])
    }, t.prototype.onDragStart = function(t, e, n) {
        var i = e.getAbsolutePos(), o = i.position.subtract(i.vector.clone().scaleInPlace(e.width / 2)), r = i.position.add(i.vector.clone().scaleInPlace(e.width / 2));
        return wanaplan.engine2D.registerEventCb("overtureComponent2D.drag-end", this.priority, "drag-end", wanaplan.engine2D.MODE_DRAG, null, this.onDragEnd.bind(this), e), wanaplan.engine2D.registerEventCb("overtureComponent2D.dynamic-draw", this.priority, "dynamic-draw", wanaplan.engine2D.MODE_DRAG, null, this.onSelectionDynamicDraw.bind(this), e), n.planPos.distanceTo(o) <= 13 || n.planPos.distanceTo(r) <= 13 ? wanaplan.engine2D.registerEventCb("overtureComponent2D.dragging", this.priority, "dragging", wanaplan.engine2D.MODE_DRAG, null, this.onDraggingResize.bind(this), e) : wanaplan.engine2D.registerEventCb("overtureComponent2D.dragging", this.priority, "dragging", wanaplan.engine2D.MODE_DRAG, null, this.onDraggingMove.bind(this), e), this.overtureDragged = !0, !1
    }, t.prototype.onDraggingMove = function(t, e, n, i) {
        var o = this.structure.getCurrentStructure(), r = n.planPos.clone(), s = WallStructure.prototype.getNearestWall(r, o), a = s.getNearestPoint(r), l = a.distanceTo(s.getPoints(0).position);
        return i.position.x = l, i.setParentWall(s), i.projectOnWall(), wanaplan.engine2D.requestStaticDraw(), !1
    }, t.prototype.onDraggingResize = function(t, e, n, i) {
        var o = n.planPos.clone(), r = i.parentWall.getNearestPoint(o), s = i.getAbsolutePos();
        return i.width = 2 * r.distanceTo(s.position) + 10, i.clampSize(), wanaplan.engine2D.requestStaticDraw(), !1
    }, t.prototype.onDragEnd = function(t, e, n, i) {
        wanaplan.engine2D.unregisterEventCb("overtureComponent2D.dynamic-draw"), this.overtureDragged = !1, i.width = Math.round(i.width), wanaplan.getSelectedStructure().dirty(), wanaplan.engine2D.requestStaticDraw()
    }, t.prototype.onHover = function(t, e) {
        return wanaplan.engine2D.registerEventCb("overtureComponent2D.dynamic-draw", this.priority, "dynamic-draw", wanaplan.engine2D.MODE_NORMAL, null, this.onSelectionDynamicDraw.bind(this), e), wanaplan.engine2D.requestDynamicDraw(), !1
    }, t.prototype.onLeave = function() {
        wanaplan.engine2D.unregisterEventCb("overtureComponent2D.dynamic-draw"), wanaplan.engine2D.requestDynamicDraw()
    }, t.prototype.onSelectionDynamicDraw = function(t, e, n, i) {
        if (!i.parentWall)
            return !1;
        var o = i.parentWall.getPoints(0).position, r = i.parentWall.getWallVector().normalize(), s = o.add(r.clone().scaleInPlace(i.position.x - i.width / 2)), a = o.add(r.clone().scaleInPlace(i.position.x + i.width / 2)), l = {x: s.x * n + e.x,y: s.y * n + e.y}, h = {x: a.x * n + e.x,y: a.y * n + e.y};
        wanaplan.engine2D.symbols2D.drawGripSegment(t, l, h, [!1, !1, !1, !0], [!1, !0, !1, !1], i.getAngle())
    }, t.prototype.onAddOverture = function(t) {
        overture = new OvertureStructure, overture.type = t.overtureType, overture.elevation = t.elevation, overture.width = t.width, overture.height = t.height, overture.nbCasement = t.nbCasement, overture.sliding = t.sliding, overture.galandage = t.galandage, void 0 != t.hinge && (overture.hinge = t.hinge), void 0 != t.side && (overture.side = t.side), void 0 != t.batiThickness && (overture.batiThickness = t.batiThickness), wanaplan.engine2D.registerEventCb("OvertureComponent2D.addOverture.wall.hover", this.priority, "hover", wanaplan.engine2D.MODE_DRAW, WallStructure, this.onAddOvertureUpdate.bind(this), overture), wanaplan.engine2D.registerEventCb("OvertureComponent2D.addOverture.all.move", this.priority, "mouse-move", wanaplan.engine2D.MODE_DRAW, null, this.onAddOvertureUpdate.bind(this), overture), wanaplan.engine2D.registerEventCb("OvertureComponent2D.addOverture.all.click", this.priority, "click", wanaplan.engine2D.MODE_DRAW, null, this.onAddOvertureEnd.bind(this), overture), wanaplan.engine2D.registerEventCb("OvertureComponent2D.addOverture.all.drag-start", this.priority, "drag-start", wanaplan.engine2D.MODE_DRAW, null, this.onAddOvertureDragStart.bind(this), overture), this.core.engine2D.registerEventCb("OvertureComponent2D.addOverture.all.leave-draw-zone", this.priority, "leave-draw-zone", this.core.engine2D.MODE_DRAW, null, this.onAddOvertureLeaveZone.bind(this), overture), wanaplan.engine2D.setMode(wanaplan.engine2D.MODE_DRAW)
    }, t.prototype.onAddOvertureDragStart = function(t, e, n, i) {
        return 0 != (n.buttons & n.BUTTON_LEFT) ? (wanaplan.engine2D.registerEventCb("OvertureComponent2D.addOverture.all.dragging", this.priority, "dragging", wanaplan.engine2D.MODE_DRAG, null, this.onAddOvertureUpdate.bind(this), i), wanaplan.engine2D.registerEventCb("OvertureComponent2D.addOverture.all.drag-end", this.priority, "drag-end", wanaplan.engine2D.MODE_DRAG, null, this.onAddOvertureEnd.bind(this), i), !1) : void 0
    }, t.prototype.onAddOvertureUpdate = function(t, e, n, i) {
        wanaplan.engine2D.setCursorIcon(wanaplan.engine2D.symbols2D.drawCursorCheck.bind(wanaplan.engine2D.symbols2D));
        var o = this.structure.getCurrentStructure();
        return e instanceof WallStructure && i.setParentWall(e), o.insertElement("overtures", i), this.onDraggingMove(t, e, n, i), wanaplan.engine2D.requestStaticDraw(), !1
    }, t.prototype.onAddOvertureEnd = function(t, e, n, i) {
        return "deselect" != t.from && ujs.notify("wnp.menu.main.deselect"), "touchUp" == t.type && this.onAddOvertureUpdate(t, e, n, i), wanaplan.engine2D.setMode(wanaplan.engine2D.MODE_NORMAL), wanaplan.helpBubbleManager.display("wnp.2d.properties"), wanaplan.getSelectedStructure().dirty(), wanaplan.engine2D.requestStaticDraw(), !1
    }, t.prototype.onAddOvertureLeaveZone = function(t, e) {
        this.core.engine2D.unregisterEventCb("OvertureComponent2D.addOverture.wall.hover"), this.core.engine2D.unregisterEventCb("OvertureComponent2D.addOverture.all.click"), this.core.engine2D.unregisterEventCb("OvertureComponent2D.addOverture.all.move"), this.core.engine2D.unregisterEventCb("OvertureComponent2D.addOverture.all.drag-start"), this.core.engine2D.unregisterEventCb("OvertureComponent2D.addOverture.all.leave-draw-zone");
        var n = this.core.getSelectedStructure();
        return e.remove(n), this.core.engine2D.setMode(this.core.engine2D.MODE_NORMAL), wanaplan.getSelectedStructure().dirty(), wanaplan.engine2D.requestStaticDraw(), !1
    }, t.prototype.onContextMenu = function(t, e) {
        var n = [];
        if (n.push({name: "width",label: _("Width"),type: "slider",cast: "int",unit: "cm",value: {min: 20,max: e.parentWall.getLength(),step: 1,value: e.width}}), n.push({name: "height",label: _("Height"),type: "slider",cast: "int",unit: "cm",value: {min: 20,max: e.parentWall.height,step: 1,value: e.height}}), n.push({name: "elevation",label: _("Elevation"),type: "slider",cast: "int",unit: "cm",value: {min: 0,max: e.parentWall.height,step: 1,value: e.elevation}}), n.push({name: "plinte",label: _("Plinte"),type: "slider",cast: "int",value: {min: 0,max: 1,step: 1,value: e.plttt}}), "Garage" == e.type && n.push({name: "nbCasement",label: _("Number of casements"),type: "slider",cast: "int",value: {min: 1,max: 6,step: 1,value: e.nbCasement}}), "Garage" != e.type) {
            var i = _("Door" == e.type ? "doors" : "Window" == e.type ? "windows" : "opening");
            n.push({name: "_applyToAll",label: _("Apply width, height and elevation") + "<br />" + _(" to all the floor's {typetarget}").replace("{typetarget}", i),type: "checkbox",cast: "bool",value: this._applyToAll})
        }
        (e.sliding || "Window" == e.type) && n.push({name: "nbCasement",label: _("Number of casements"),type: "slider",cast: "int",value: {min: 1,max: 5,step: 1,value: e.nbCasement}}), e.nbCasement % 2 != 1 || e.sliding || "Garage" == e.type || n.push({name: "hinge",label: _("Hinges position"),type: "button",cast: "int",value: _("invert")}), e.nbCasement > 0 && !e.sliding && n.push({name: "side",label: _("Wall Side"),type: "button",cast: "int",value: _("invert")}), wanaplan.engine2D.displayContextMenu(n, e, this.onContextMenuPropertyChanged.bind(this), this.onContextMenuRemove.bind(this))
    }, t.prototype.onContextMenuPropertyChanged = function(t, e, n) {
        switch (e) {
            case "hinge":
                t.hinge = (t.hinge + 1) % 2;
                break;
            case "side":
                t.side = -t.side;
                break;
            case "_applyToAll":
                this._applyToAll = n;
                break;
            default:
                t[e] = n
        }
        if (this._applyToAll && ("elevation" == e || "height" == e || "width" == e))
            for (var i = wanaplan.getSelectedStructure(), o = i.getElements("overtures"), r = 0; r < o.length; r++)
                o[r].type == t.type && (o[r][e] = n);
        wanaplan.engine2D.requestStaticDraw()
    }, t.prototype.onContextMenuRemove = function(t) {
        var e = wanaplan.getSelectedStructure();
        t.remove(e)
    }, t.prototype.onDoubleClick = function(t, e) {
        return wanaplan.helpBubbleManager.display("wnp.2d.dup-overture"), this.onAddOverture({overtureType: e.type,elevation: e.elevation,width: e.width,height: e.height,nbCasement: e.nbCasement,sliding: e.sliding,hinge: e.hinge,side: e.side,batiThickness: e.batiThickness}), !0
    }, t
}(), OvertureComponent3D = function() {
    var t, e = 0, n = function(e) {
        BaseComponent3D.call(this, e, "OvertureComponent3D"), this.priority = 11, t = this, this._defaultMaterial = new wnp.WhiteMaterial("bati", wanaplan.engine3D.scene, {factor: 1})
    };
    return n.prototype = new BaseComponent3D, n.prototype.startListening = function() {
        document.addEventListener("wnp.engine3d.wallsReady", this.onWallsReady, !1), document.addEventListener("wnp.engine3d.subslopesReady", this.onSubslopesReady, !1)
    }, n.prototype.stopListening = function() {
        document.removeEventListener("wnp.engine3d.wallsReady", this.onWallsReady, !1), document.removeEventListener("wnp.engine3d.subslopesReady", this.onSubslopesReady, !1)
    }, n.prototype.onWallsReady = function(e) {
        for (var n = e.floor || t.getFloor(), i = e.structure || t.core.getSelectedStructure(), o = e.walls || [], r = wanaplan.getComponentByName("WallComponent3D").get3DWallFrom2D(i), s = new BABYLON.CSG.FromMesh(r), a = i.getElements("overtures"), l = new BABYLON.CSG, h = 0; h < a.length; h++)
            l.unionInPlace(t.overtureBox(a[h], i, n));
        t.carveWithOvertureMeshes(l, s, r, n);
        for (var h = 0; h < a.length; h++)
            t.createOverture(a[h], i, n);
        ujs.notify("wnp.engine3d.overturesReady", {floor: n,structure: i,walls: o})
    }, n.prototype.onSubslopesReady = function(e) {
        for (var n = e.floor || t.getFloor(), i = e.structure || t.core.getSelectedStructure(), o = e.walls || [], r = i.getElements("subslopes"), s = 0; s < r.length; s++)
            for (var a = 0; a < r[s].overtures.length; a++)
                o = t.carveSubslopeOverture(r[s], r[s].overtures[a], i, n), t.createOverture(r[s].overtures[a], i, n);
        var l = wanaplan.engine3D.searchComponent("WallComponent3D");
        l && l.createInstances(o);
        var h = wanaplan.engine3D.searchComponent("RoomComponent3D");
        h && h.createInstances(h.mesh), n.roomMesh = o, ujs.notify("wnp.engine3d.subslopeOverturesReady", {floor: n,structure: i,walls: o})
    }, n.prototype.createOverture = function(t, n, i) {
        function o(t) {
            t.traverse(function(t) {
                "vitre" !== t.name && (wanaplan.engine3D.castShadows(t), t.receiveShadows = !0)
            })
        }
        function r(t, e) {
            var n = void 0 !== t.alternativeOpacity ? t.alternativeOpacity : e;
            t.alternativeOpacity = t.alpha, t.alpha = n, t.opacitySwitched = !t.opacitySwitched, t.transparent = 1 != t.alpha
        }
        var s, i = i || this.core.getComponentByName("FloorComponent3D").getFloor(n), a = function(n) {
            var s = n.getObject3D(wanaplan.engine3D.scene);
            s.structure = t, s.animate = n.animate.bind(n), s.decorate = n.decorate.bind(s), o(s), s.structure.programmableInstance = n, t.programmableInstance = n, s.isDecorable = !0, s.parent = i, s.name = "Overture_" + e++;
            var a = t.programmableInstance.materials;
            if (t.programmableInstance.getDefaultMaterials && (a = ujs.mergeObjects(t.programmableInstance.getDefaultMaterials(wanaplan.engine3D.scene), a)), t.programmableInstance.materials = a, s.initMaterials(a), t.material.opacitySwitched)
                for (var l in n.materials)
                    n.materials.hasOwnProperty(l) && !n.materials[l].opacitySwitched && r(n.materials[l], .2)
        }.bind(this);
        switch (t.type) {
            case "Door":
                s = "Aperture.Door.js";
                break;
            case "Window":
                s = "Aperture.Window.js";
                break;
            case "Garage":
                s = "Aperture.Garage.js";
                break;
            case "Velux":
                s = "Aperture.Velux.js";
                break;
            case "Dormer":
                s = "Aperture.Dormer.js";
                break;
            default:
                s = "Aperture.js"
        }
        var l = t.programmableInstance ? t.programmableInstance.materials : null, h = {type: t.type,width: t.width,height: t.height,thickness: t.thickness,elevation: t.elevation,angle: -t.angle || 0,angleX: -t.angleX || 0,hinge: t.hinge,side: t.side,nbCasement: t.nbCasement,minsize: t.minsize,sliding: t.sliding,galandage: t.galandage,batiThickness: t.batiThickness,wallThickness: t.wallThickness,dormerRoof: t.dormerRoof || {},plinte: t.plinte};
        return wnp.Programmable.createInstance(s, h, l, t, a, !1, this.engine3D), !0
    }, n.prototype.overtureBox = function(t, e, n) {
        var e = e || this.core.getSelectedStructure(), n = n || this.core.getComponentByName("FloorComponent3D").getFloor(e), i = t.getAbsolutePos().position;
        i.z = -i.y, i.y = t.elevation + t.height / 2;
        {
            var o = 5, r = t.parentWall.getWallVector(), s = Math.atan2(-r.y, r.x);
            t.parentWall.thickness + o, wanaplan.getComponentByName("WallComponent3D").get3DWallFrom2D(e)
        }
        t.material = t.material || this._defaultMaterial.clone("DefaultMaterial");
        var a = new BABYLON.Mesh.CreateBloc("CSGtemp", t.width, t.height, t.parentWall.thickness + 10, wanaplan.engine3D.scene), l = a.getBoundingBox();
        l.angle = s, l.center = i, a.subMeshes[0].objectInstance = t, a.subMeshes[0].boundingBox = l, a.position = i, a.rotation.y = -s, a.parent = n;
        var h = new BABYLON.CSG.FromMesh(a);
        return a.dispose(), h
    }, n.prototype.carveWithOvertureMeshes = function(t, e, n, i) {
        var o = o || this.core.getSelectedStructure(), i = i || this.core.getComponentByName("FloorComponent3D").getFloor(o);
        e.subtractInPlace(t);
        var r = e.toMesh(n.name, n.material, wanaplan.engine3D.scene, !0);
        return r.isDecorable = !0, r.parent = i, wanaplan.getComponentByName("WallComponent3D").replaceWall(n, r), wanaplan.engine3D.castShadows(r), r
    }, n.prototype.carveSubslopeOverture = function(t, e, n, i) {
        var n = n || this.core.getSelectedStructure(), i = i || this.core.getComponentByName("FloorComponent3D").getFloor(n), o = t.polygonPoints[2].dot(e.wallOrtho), r = t.polygonPoints[0].dot(e.wallOrtho), s = Math.atan2(o - r, -(t.hiHeight - t.lowHeight)), a = t.wall.thickness, l = -a / Math.tan(s), h = new BABYLON.Vector3(e.center.x, 0, -e.center.y);
        h.y = e.offset / t.offset * (-l + t.hiHeight - t.lowHeight) + t.lowHeight + l / 2;
        var c = t.wall.getWallVector(), u = new BABYLON.Vector2(c.y, -c.x), p = new BABYLON.Vector2(t.polygonPoints[2].x - t.polygonPoints[0].x, t.polygonPoints[2].y - t.polygonPoints[0].y);
        p.projectOnVector(u);
        var d = p.x * u.x + p.y * u.y;
        0 > d && (c.x = -c.x, c.y = -c.y, u.x = -u.x, u.y = -u.y);
        var m = Math.atan2(-c.y, c.x);
        e.elevation = h.y, e.angle = m, e.angleX = s;
        var g = wanaplan.getComponentByName("WallComponent3D").get3DWallFrom2D(n), f = new BABYLON.Mesh.CreateBloc("CSGtemp", e.width, e.height, 20, wanaplan.engine3D.scene), y = f.getBoundingBox();
        y.angle = m, y.center = h, f.material = new BABYLON.StandardMaterial("CSGtemp", wanaplan.engine3D.scene), f.subMeshes[0].objectInstance = e, f.position = h, f.rotation.y = -m + Math.PI, f.rotation.x = s, f.parent = i;
        var _ = new BABYLON.CSG.FromMesh(g), v = new BABYLON.CSG.FromMesh(f), b = _.subtract(v);
        e.material = e.material || new BABYLON.StandardMaterial("bati", wanaplan.engine3D.scene);
        var w = b.toMesh(g.name, g.material, wanaplan.engine3D.scene, !0);
        return f.dispose(), w.isDecorable = !0, w.parent = i, wanaplan.getComponentByName("WallComponent3D").replaceWall(g, w), wanaplan.engine3D.castShadows(w), w
    }, n
}();
SubSlopeStructure = function() {
    var t = function() {
        BaseStructure.call(this, "SubSlopeStructure"), this.points = [], this.side = [], this.wall = null, this.neighbors = [], this.overtures = [], this.offset = 0, this.materials = {}, this.lowHeight = 80, this.hiHeight = 250, this.polygonPoints = [new BABYLON.Vector2, new BABYLON.Vector2, new BABYLON.Vector2, new BABYLON.Vector2], this.needsUpdate = !0
    };
    return t.prototype = new BaseStructure, t.prototype.serialize = function() {
        var t = {"class": {name: "SubSlopeStructure"}};
        return ujs.serializeObject(this, t, ["offset", "lowHeight", "hiHeight", "overtures", "materials"]), t
    }, t.Deserialize = function(t) {
        var e = new SubSlopeStructure;
        ujs.deserializeObject(t, e, ["offset", "lowHeight", "_overturesIds", "hiHeight", "overtures", "materials"]);
        for (var n in e.overtures)
            e.overtures[n].parent = e;
        return e.checkCoherence(), e
    }, t.prototype.checkCoherence = function() {
        var t;
        this.lowHeight > this.hiHeight && (t = this.hiHeight, this.hiHeight = this.lowHeight, this.lowHeight = t), 0 === this.lowHeight && (this.lowHeight = 1), 0 == this.materials.length && (this.materials = {}), this.offset > 4e3 && (this.offset = 4e3)
    }, t.prototype.indexClosest = function(t) {
        return this.wall.distanceFrom(t[0]) < this.wall.distanceFrom(t[1]) ? 0 : 1
    }, t.prototype.isSameSide = function(t) {
        var e = this.wall.distanceFrom(t[0]) < this.wall.distanceFrom(t[1]) ? 0 : 1, n = t[(e + 1) % 2].subtract(t[e]);
        return n.dot(this.side[0]) >= 0
    }, t.prototype.getVector = function() {
        return this.points[1].subtract(this.points[0])
    }, t.prototype.distanceFrom = function(t) {
        var e = t.points[1].subtract(t.points[0]), n = e.lengthSquared(), i = this.points[1].subtract(t.points[0]), o = this.points[0].subtract(t.points[0]), r = i.projectOnVector(e), s = o.projectOnVector(e);
        r.dot(e) < 0 && r.copyFromFloats(0, 0, 0), s.dot(e) < 0 && s.copyFromFloats(0, 0, 0), r.dot(e) > n && r.copyFrom(e), s.dot(e) > n && s.copyFrom(e);
        var a = t.points[0].add(r), l = t.points[0].add(s);
        return Math.min(a.distanceTo(this.points[1]), l.distanceTo(this.points[0]))
    }, t.prototype.getPolygonPoints = function() {
        this.polygonPoints[1].x = this.wall.points[0].position.x + this.wall.thickness / 2, this.polygonPoints[1].y = this.wall.points[0].position.y + this.wall.thickness / 2, this.polygonPoints[0].x = this.wall.points[1].position.x + this.wall.thickness / 2, this.polygonPoints[0].y = this.wall.points[1].position.y - this.wall.thickness / 2, this.polygonPoints[3].x = this.wall.points[0].position.x - this.offset - this.wall.thickness / 2, this.polygonPoints[3].y = this.wall.points[0].position.y + this.wall.thickness / 2, this.polygonPoints[2].x = this.wall.points[1].position.x - this.offset - this.wall.thickness / 2, this.polygonPoints[2].y = this.wall.points[1].position.y - this.wall.thickness / 2
    }, t.prototype.computePolygonPoints = function(t) {
        if ((t || this.needsUpdate) && 0 != this.side.length) {
            var e = this.side[0].scale(this.offset), n = function(t, n) {
                if (n >= 2) {
                    if (t.offset <= 0)
                        return void (this.polygonPoints[n] = this.polygonPoints[n - 2].add(e.clone().normalize().scaleInPlace(this.offset + this.wall.thickness)));
                    var i = t.side[0].scale(t.offset), o = this.points[0].add(e), r = this.points[1].add(e), s = t.points[0].add(i), a = t.points[1].add(i), l = BABYLON.Vector2.Intersect(o, r, s, a, Math.PI / 50);
                    if (!l)
                        return Logger.warning("No intersect"), void (this.polygonPoints[n] = this.polygonPoints[n - 2].add(e));
                    this.polygonPoints[n].copyFrom(l)
                } else {
                    var o = this.polygonPoints[0], r = this.polygonPoints[1], s = t.points[0].subtract(t.side[0].scale(t.wall.thickness)), a = t.points[1].subtract(t.side[0].scale(t.wall.thickness)), l = BABYLON.Vector2.Intersect(o, r, s, a, Math.PI / 50);
                    if (!l)
                        return;
                    this.polygonPoints[n].copyFrom(l)
                }
            };
            if (this.needsUpdate = !1, this.polygonPoints[0].copyFrom(this.points[0]), this.polygonPoints[1].copyFrom(this.points[1]), this.offset > 0) {
                var i = this.wall.thickness;
                this.polygonPoints[0].subtractInPlace(this.side[0].scale(i)), this.polygonPoints[1].subtractInPlace(this.side[0].scale(i))
            }
            var o = function(t) {
                var i = .001;
                if (this.neighbors[t]) {
                    for (var o = 0; o < this.neighbors[t].subSlopes.length && this.distanceFrom(this.neighbors[t].subSlopes[o]) > i; )
                        o++;
                    var r = this.neighbors[t].subSlopes[o];
                    r && r.wall != this.wall ? (n.call(this, r, t), n.call(this, r, t + 2)) : this.polygonPoints[t + 2] = this.polygonPoints[t].add(e.clone().normalize().scaleInPlace(this.offset + this.wall.thickness))
                } else
                    this.polygonPoints[t + 2] = this.polygonPoints[t].add(e.clone().normalize().scaleInPlace(this.offset + this.wall.thickness))
            };
            o.call(this, 0), o.call(this, 1)
        }
    }, t.prototype.isPointIn = function(t) {
        var e = [this.polygonPoints[0], this.polygonPoints[1], this.polygonPoints[3], this.polygonPoints[2]];
        return t.isPointInPolygon(e)
    }, t.prototype.plane = function() {
        if (this.offset <= 0)
            return null;
        var t = [new BABYLON.Vector3(this.polygonPoints[0].x, this.lowHeight, -this.polygonPoints[0].y), new BABYLON.Vector3(this.polygonPoints[1].x, this.lowHeight, -this.polygonPoints[1].y), new BABYLON.Vector3(this.polygonPoints[3].x, this.hiHeight, -this.polygonPoints[3].y), new BABYLON.Vector3(this.polygonPoints[2].x, this.hiHeight, -this.polygonPoints[2].y)], e = t[2].subtract(t[1]), n = t[0].subtract(t[1]);
        if (e.cross(n), e.y < 0) {
            var i = t[0];
            t[0] = t[1], t[1] = i, i = t[2], t[2] = t[3], t[3] = i
        }
        return t
    }, t.prototype.remove = function() {
        this.offset = 0, this.lowHeight = 80, this.hiHeight = 250, this.needsUpdate = !0, this.overtures.length = 0
    }, t.prototype.getNearestSubSlope = function(t, e) {
        for (var n, i = e.getElements("SubSlopeStructure"), o = null, r = +1 / 0, s = 0, a = i.length; a > s; s++)
            n = i[s].distanceFrom(t), r > n && (o = i[s], r = n);
        return o
    }, t.prototype.addMaterial = function(t, e, n) {
        n.colorOnly ? this.materials[n.materialIndex] ? (this.materials[n.materialIndex].color.r = n.color.r, this.materials[n.materialIndex].color.g = n.color.g, this.materials[n.materialIndex].color.b = n.color.b) : (this.materials[n.materialIndex] = n, n.colorOnly = !1) : this.materials[n.materialIndex] = n
    }, t
}(), SubSlopeOvertureStructure = function() {
    var t = function() {
        BaseStructure.call(this, "SubSlopeOvertureStructure"), this.type = "Velux", this.width = 100, this.height = 150, this.thickness = 5, this.nbCasement = 1, this.sliding = 0, this.dormerRoof = {}, this.wallThickness = 10, this.parent = null, this.position = new BABYLON.Vector2, this.polygon = []
    };
    return t.prototype = new BaseStructure, t.prototype.serialize = function() {
        var t = {"class": {name: "SubSlopeOvertureStructure"}};
        return ujs.serializeObject(this, t, null, ["parent", "wall"]), t
    }, t.Deserialize = function(t) {
        var e = new SubSlopeOvertureStructure;
        return ujs.deserializeObject(t, e), e
    }, t.prototype.getParent = function() {
        return this.parent
    }, t.prototype.setParent = function(t) {
        if (t != this.parent) {
            null != this.parent && this.parent.overtures.splice(this.parent.overtures.indexOf(this), 1), this.parent = t;
            for (var e = 0; e < this.parent.overtures.length; e++) {
                var n = this.parent.overtures[e];
                if (this.id == n.id)
                    return
            }
            this.parent.overtures.push(this)
        }
    }, t.prototype.isTargeted = function(t) {
        return t.isPointInPolygon(this.polygon)
    }, t.prototype.remove = function() {
        this.parent.overtures.splice(this.parent.overtures.indexOf(this), 1)
    }, t.prototype.remove = function() {
        this.parent.overtures.splice(this.parent.overtures.indexOf(this), 1)
    }, t.prototype.getAbsolutePosition = function() {
        var t = new BABYLON.Vector2;
        return t = this.parent.wall.points[0].position.clone().lerp(this.parent.wall.points[1].position, .5).add(this.position), {position: t,vector: null}
    }, t.prototype.to3D = function() {
    }, t
}(), SubSlopeComponent2D = function() {
    var t = function(t) {
        BaseComponent2D.call(this, t, "SubSlopeComponent2D"), this.priority = 100, this.subSlopes = [], this.needsUpdate = !0, this._applyHeightToAll = !1, this._HANDLERADIUS = 10, this._HANDLESTATICSTYLE = "rgba(60,82,129,0.8)", this._HANDLESTYLE = this._HANDLESTATICSTYLE
    };
    return t.prototype = new BaseComponent2D, t.prototype.startListening = function() {
        this.onEditSubSlope = this.onEditSubSlope.bind(this), this.onModeSubSlopeEnd = this.onModeSubSlopeEnd.bind(this), document.addEventListener("wnp.engine2d.onEditSubSlope", this.onEditSubSlope, !1), document.addEventListener("wnp.engine2d.onModeSubSlopeEnd", this.onModeSubSlopeEnd, !1), wanaplan.engine2D.registerEventCb("SubSlopeComponent2D.static-draw", this.priority, "static-draw", wanaplan.engine2D.MODE_SUBSLOPE | wanaplan.engine2D.MODE_DRAG, null, this.onStaticDraw.bind(this), null), wanaplan.engine2D.registerEventCb("SubSlopeComponent2D.hover", this.priority, "hover", wanaplan.engine2D.MODE_SUBSLOPE, SubSlopeStructure, this.onHover.bind(this), null), wanaplan.engine2D.registerEventCb("SubSlopeComponent2D.leave", this.priority, "leave", wanaplan.engine2D.MODE_SUBSLOPE, SubSlopeStructure, this.onLeave.bind(this), null), wanaplan.engine2D.registerEventCb("SubSlopeComponent2D.dragstart", this.priority, "drag-start", wanaplan.engine2D.MODE_SUBSLOPE, SubSlopeStructure, this.onDragStart.bind(this), null), wanaplan.engine2D.registerEventCb("SubSlopeComponent2D.subslope-end", this.priority, "subslope-end", null, null, this.onSubSlopeEnd.bind(this), null), wanaplan.engine2D.registerEventCb("SubSlopeComponent2D.context-menu", this.priority, "click", wanaplan.engine2D.MODE_SUBSLOPE, SubSlopeStructure, this.onContextMenu.bind(this), null)
    }, t.prototype.stopListening = function() {
        document.removeEventListener("wnp.engine2d.onEditSubSlope", this.onEditSubSlope, !1), document.removeEventListener("wnp.engine2d.onModeSubSlopeEnd", this.onModeSubSlopeEnd, !1), wanaplan.engine2D.unregisterEventCb("SubSlopeComponent2D.static-draw"), wanaplan.engine2D.unregisterEventCb("SubSlopeComponent2D.hover"), wanaplan.engine2D.unregisterEventCb("SubSlopeComponent2D.leave"), wanaplan.engine2D.unregisterEventCb("SubSlopeComponent2D.dragstart"), wanaplan.engine2D.unregisterEventCb("SubSlopeComponent2D.subslope-end"), wanaplan.engine2D.unregisterEventCb("SubSlopeComponent2D.context-menu")
    }, t.prototype.initialize = function() {
        this.startListening();
        var t = {id: "subslopes",title: _("Subslope"),index: 90,action: "wnp.engine2d.onEditSubSlope",cancelAction: "wnp.engine2d.onModeSubSlopeEnd"};
        ujs.notify("wnp.menu.main.add", {item: t,menuPath: "0",position: 90})
    }, t.prototype.onEditSubSlope = function() {
        this.needsUpdate = !0, wanaplan.engine2D.setMode(wanaplan.engine2D.MODE_SUBSLOPE), wanaplan.engine2D.requestStaticDraw()
    }, t.prototype.onModeSubSlopeEnd = function() {
        wanaplan.engine2D.setMode(wanaplan.engine2D.MODE_NORMAL)
    }, t.prototype.onSubSlopeEnd = function() {
        wanaplan.engine2D.requestStaticDraw()
    }, t.prototype.onStaticDraw = function(t, e, n) {
        0 != (wanaplan.engine2D.getMode() & wanaplan.engine2D.MODE_SUBSLOPE) && (this.getSubSlopes(), this.update(), this.draw(t, e, n))
    }, t.prototype.onHover = function(t, e) {
        return this._HANDLESTYLE = "rgba(190,230,190,0.8)", wanaplan.engine2D.registerEventCb("SubSlopeComponent2D.dynamic-draw", this.priority, "dynamic-draw", null, null, this.onDynamicDraw.bind(this), e), wanaplan.engine2D.requestDynamicDraw(), !1
    }, t.prototype.onLeave = function() {
        this._HANDLESTYLE = "rgba(130,130,150,0.8)", wanaplan.engine2D.unregisterEventCb("SubSlopeComponent2D.dynamic-draw"), wanaplan.engine2D.requestDynamicDraw()
    }, t.prototype.onDragStart = function(t, e) {
        return wanaplan.engine2D.registerEventCb("SubSlopeComponent2D.dragging", this.priority, "dragging", wanaplan.engine2D.MODE_DRAG, null, this.onDragging.bind(this), e), wanaplan.engine2D.registerEventCb("SubSlopeComponent2D.drag-end", this.priority, "drag-end", wanaplan.engine2D.MODE_DRAG, null, this.onDragEnd.bind(this), e), !1
    }, t.prototype.onDragging = function(t, e, n, i) {
        var o = wanaplan.getSelectedStructure(), r = n.posDelta.scaleInPlace(1 / wanaplan.engine2D.getZoom()), s = r.clone().projectOnVector(i.polygonPoints[3].subtract(i.polygonPoints[2])), a = r.subtractInPlace(s), l = [];
        l[0] = i.polygonPoints[0], l[1] = i.polygonPoints[1], l[2] = i.polygonPoints[3], l[3] = i.polygonPoints[2];
        for (var h = i.overtures.length, c = 0; h > c; c++)
            if (void 0 != i.overtures[c])
                for (var u = 0; u < i.overtures[c].polygon.length; u++)
                    if (!i.overtures[c].polygon[u].isPointInPolygon(l) && a.dot(i.side[0]) < 0 && (i.overtures[c].position.x += r.x, i.overtures[c].position.y += r.y, 1 == u || 2 == u)) {
                        i.overtures[c].remove(i.overtures[c]);
                        break
                    }
        var p = i.wall.getWallVector(), d = new BABYLON.Vector2;
        d.x = p.y, d.y = p.x;
        for (var m = 0; m < i.neighbors.length; m++) {
            var p = i.neighbors[m].getWallVector(), g = new BABYLON.Vector2(r.x, r.y);
            g.projectOnVector(p);
            var f = [];
            f[0] = i.neighbors[m].subSlopes[0].polygonPoints[0], f[1] = i.neighbors[m].subSlopes[0].polygonPoints[1], f[2] = i.neighbors[m].subSlopes[0].polygonPoints[3], f[3] = i.neighbors[m].subSlopes[0].polygonPoints[2];
            for (var y = 0; y < i.neighbors[m].subSlopes[0].overtures.length; y++)
                for (var _ = 0; 4 > _; _++)
                    !i.neighbors[m].subSlopes[0].overtures[y].polygon[_].isPointInPolygon(f) && a.dot(i.side[0]) > 0 && (i.neighbors[m].subSlopes[0].overtures[y].position.x += g.x, i.neighbors[m].subSlopes[0].overtures[y].position.y += g.y)
        }
        i.offset += a.dot(i.side[0]), i.offset < 0 && (i.offset = 0);
        var v = function(t, e) {
            for (var n = 0; n < t.subSlopes.length; n++) {
                var i = t.subSlopes[n].neighbors.indexOf(e.wall);
                if (-1 != i)
                    return i
            }
            return -1
        }, b = function(t, e) {
            for (var n = 0; n < t.subSlopes.length; n++) {
                var i = t.subSlopes[n].points[1].subtract(t.subSlopes[n].points[0]), o = e.subtract(t.subSlopes[n].points[0]), r = i.lengthSquared(), s = i.dot(o);
                if (s >= 0 && r >= s)
                    return t.subSlopes[n]
            }
            return null
        };
        if (i.offset >= 0 && i.neighbors[0] && i.neighbors[1]) {
            var w, x, C;
            i.neighbors[0].subSlopes[0] && (w = v(i.neighbors[0], i), x = i.neighbors[0].subSlopes[0].indexClosest(i.points), -1 == w && (C = b(i.neighbors[0], i.points[x]), this.splitSubSlope(C, i))), i.neighbors[1].subSlopes[0] && (w = v(i.neighbors[1], i), x = i.neighbors[1].subSlopes[0].indexClosest(i.points), -1 == w && (C = b(i.neighbors[1], i.points[x]), this.splitSubSlope(C, i)))
        }
        for (var M = o.getElements("subslopes"), c = 0; c < M.length; c++)
            -1 != M[c].neighbors.indexOf(i.wall) && (M[c].needsUpdate = !0);
        i.needsUpdate = !0, wanaplan.engine2D.requestStaticDraw()
    }, t.prototype.onDragEnd = function() {
        wanaplan.engine2D.requestDynamicDraw(), ujs.notify("wnp.subslope.drag-end")
    }, t.prototype.onDynamicDraw = function(t, e, n, i) {
        if (0 != (wanaplan.engine2D.getMode() & wanaplan.engine2D.MODE_SUBSLOPE)) {
            var o = BABYLON.Vector2.Lerp(i.polygonPoints[3], i.polygonPoints[2], .5);
            o.scaleInPlace(n), o.addInPlace(e)
        }
    }, t.prototype.update = function(t) {
        if ((t || wanaplan.getSelectedStructure().isDirty()) && this.getSubSlopes(!0, t), 0 != (wanaplan.engine2D.getMode() & wanaplan.engine2D.MODE_SUBSLOPE))
            for (var t = wanaplan.getSelectedStructure(), e = t.getElements("subslopes"), n = 0, i = e.length; i > n; n++)
                e[n].computePolygonPoints()
    }, t.prototype.getTargeted = function(t) {
        if (0 != (wanaplan.engine2D.getMode() & wanaplan.engine2D.MODE_SUBSLOPE)) {
            for (var e = wanaplan.getSelectedStructure(), n = e.getElements("subslopes"), i = 0; i < n.length; i++) {
                var o = BABYLON.Vector2.Lerp(n[i].polygonPoints[3], n[i].polygonPoints[2], .5);
                if (t.distanceTo(o) < this._HANDLERADIUS / wanaplan.engine2D.getZoom())
                    return n[i]
            }
            return null
        }
    }, t.prototype.getSubSlopes = function(t, e) {
        var e = e || wanaplan.getSelectedStructure(), n = e.getElements("subslopes");
        if (!this.needsUpdate && !t)
            return n;
        for (var i = function(t) {
            if (!(t.points.length <= 2)) {
                for (var e, n = t.points[0], i = t.points[1].subtract(n).normalize(), o = 0, r = t.points[1].subtract(n).dot(i), s = 0, a = 1, l = 1, h = t.points.length; h > l; l++)
                    e = t.points[l].subtract(n).dot(i), o > e ? (s = l, o = e) : e > r && (a = l, r = e);
                t.points = [t.points[s], t.points[a]], t.side = [t.side[s], t.side[a]], t.neighbors = [t.neighbors[s], t.neighbors[a]]
            }
        }, o = wanaplan.getComponentByName("RoomComponent2D").getAllSubSlopes(e), r = e.getElements("walls"), s = [], a = [], l = 0; l < r.length; l++) {
            for (var h = [], c = 0; c < r[l].subSlopes.length; c++)
                h.push({offset: r[l].subSlopes[c].offset,lowHeight: r[l].subSlopes[c].lowHeight,hiHeight: r[l].subSlopes[c].hiHeight,materials: r[l].subSlopes[c].materials,overtures: r[l].subSlopes[c].overtures});
            r[l].subSlopes.length = 0, s.push(h), a.push(r[l])
        }
        for (var l = o.length - 1; l >= 0; l--)
            if (o[l].wall.thickness < 20)
                o.splice(l, 1);
            else if (o[l].points[1].distanceTo(o[l].points[0]) < 10)
                o.splice(l, 1);
            else {
                i(o[l]), o[l].wall.subSlopes.push(o[l]), o[l].offset = 0;
                var u = s[a.indexOf(o[l].wall)];
                if (u && u.length > 0 && u[o[l].wall.subSlopes.length - 1]) {
                    var p = u[o[l].wall.subSlopes.length - 1].offset;
                    o[l].offset = void 0 !== p ? p : 0;
                    var d = u[o[l].wall.subSlopes.length - 1].lowHeight;
                    o[l].lowHeight = void 0 !== d ? d : 0;
                    var m = u[o[l].wall.subSlopes.length - 1].hiHeight;
                    o[l].hiHeight = void 0 !== m ? m : 0;
                    var g = u[o[l].wall.subSlopes.length - 1].materials;
                    o[l].materials = void 0 !== g ? g : {};
                    var f = u[o[l].wall.subSlopes.length - 1].overtures;
                    o[l].overtures = void 0 !== f ? f : [];
                    for (var y = o[l].overtures.slice(), c = 0; c < y.length; c++)
                        y[c].setParent(o[l])
                }
            }
        this.subSlopes = o;
        for (var l = o.length - 1; l >= 0; l--)
            o[l].computePolygonPoints();
        return e.replaceElements("subslopes", o), this.needsUpdate = !1, o
    }, t.prototype.splitSubSlope = function(t, e) {
        var n = wanaplan.getSelectedStructure(), i = n.getElements("subslopes"), o = t.indexClosest(e.points), r = new SubSlopeStructure, s = function() {
            for (var n = 10 + t.wall.thickness / 2, i = 0; i < e.wall.subSlopes.length; i++)
                if (!(e.wall.subSlopes[i].side[0].subtract(e.side[0]).lengthSquared() < 1e-4)) {
                    if (e.wall.subSlopes[i].distanceFrom(t) < n)
                        return {ss: e.wall.subSlopes[i],index: t.indexClosest(e.wall.subSlopes[i].points)};
                    Logger.message("Problème : sous-pente adjacente non-trouvée")
                }
        }, a = s();
        if (a) {
            var l = a.ss.side[0].dot(t.getVector()) > 0 ? 1 : 0;
            r.points = [a.ss.points[a.index], t.points[l]], t.points[l] = e.points[o], r.neighbors = [e.wall, t.neighbors[l]], t.neighbors[l] = e.wall, r.side[0] = r.side[1] = t.side[0], i.push(r), t.wall.subSlopes.push(r), r.wall = t.wall, t.needsUpdate = !0
        }
    }, t.prototype.draw = function(t, e, n) {
        for (var i = this.getSubSlopes(), o = 0, r = i.length; r > o; o++)
            this.drawOnWall(t, e, n, i[o])
    }, t.prototype.drawOnWall = function(t, e, n, i) {
        t.fillStyle = wanaplan.engine2D.symbols2D.COLOR_ACTIVE_FILL, t.strokeStyle = wanaplan.engine2D.symbols2D.COLOR_ACTIVE_STROKE, t.lineWidth = 2, t.beginPath();
        for (var o = [i.polygonPoints[0].clone(), i.polygonPoints[1].clone(), i.polygonPoints[3].clone(), i.polygonPoints[2].clone()], r = new BABYLON.Vector2, s = 0, a = i.polygonPoints.length; a > s; s++)
            r = o[s], r.scaleInPlace(n), r.addInPlace(e), r.x = Math.round(r.x), r.y = Math.round(r.y), 0 == s ? t.moveTo(r.x, r.y) : t.lineTo(r.x, r.y);
        t.fill(), i.offset > 0 && (t.closePath(), t.stroke());
        var l = o[2].lerp(o[3], .5), h = Math.atan2(i.side[0].y, i.side[0].x);
        wanaplan.engine2D.symbols2D.drawGrip(t, l, [!1, !1, !1, !1], 0), wanaplan.engine2D.symbols2D.drawArrows(t, l, [!1, !0, !1, !1], 12, h, !0)
    }, t.prototype.onContextMenu = function(t, e) {
        var n = [];
        n.push({name: "lowHeight",label: _("Start height"),type: "slider",cast: "int",unit: "cm",value: {min: 1,max: 500,step: 1,value: e.lowHeight}}), n.push({name: "hiHeight",label: _("End height"),type: "slider",cast: "int",unit: "cm",value: {min: 1,max: 500,step: 1,value: e.hiHeight}}), n.push({name: "offset",label: _("Length"),type: "slider",cast: "int",unit: "cm",value: {step: 1,min: 0,max: 5e3,value: Math.round(e.offset)}}), n.push({name: "Length",label: _("Angle"),type: "html",html: "<label>" + _("Angle") + '</label><span class="field">' + Math.round(180 * Math.atan2(e.hiHeight - e.lowHeight, e.offset) / Math.PI) + "°</span>"}), n.push({name: "_applyHeightToAll",label: _("Apply heights to") + "<br />" + _(" all floor's subslopes"),type: "checkbox",cast: "bool",value: this._applyHeightToAll}), wanaplan.engine2D.displayContextMenu(n, e, this.onContextMenuPropertyChanged.bind(this), this.onContextMenuRemove.bind(this))
    }, t.prototype.onContextMenuPropertyChanged = function(t, e, n) {
        if (!("lowHeight" == e && n > t.hiHeight || "hiHeight" == e && n < t.lowHeight)) {
            t[e] = n;
            var i = wanaplan.getSelectedStructure(), o = i.getElements("walls");
            if (("hiHeight" == e || "lowHeight" == e || "_applyHeightToAll" == e) && t._applyHeightToAll) {
                for (var r = 0; r < o.length; r++)
                    for (var s = 0; s < o[r].subSlopes.length; s++)
                        o[r].subSlopes[s].lowHeight = t.lowHeight, o[r].subSlopes[s].hiHeight = t.hiHeight;
                i.height = t.height
            }
            wanaplan.engine2D.requestStaticDraw()
        }
    }, t.prototype.onContextMenuRemove = function(t) {
        var e = wanaplan.getSelectedStructure();
        t.remove(e)
    }, t
}(), SubSlopeOvertureComponent2D = function() {
    var t = function(t) {
        BaseComponent2D.call(this, t, "SubSlopeOvertureComponent2D"), this.priority = 99, this._tmpOverture = null, this._addState = 0, this._targetedAt = null, this._targetedAtSide = null, this._overture1Magnetism = null, this._overture2Magnetism = null
    };
    return t.prototype = new BaseComponent2D, t.prototype.getTargeted = function(t) {
        if (0 != (wanaplan.engine2D.getMode() & wanaplan.engine2D.MODE_SUBSLOPE)) {
            var e = this.structure.getCurrentStructure(), n = e.getElements("walls");
            if (!(wanaplan.engine2D.getMode() & wanaplan.engine2D.MODE_DRAG))
                for (var i = 0, o = n.length; o > i; i++)
                    for (var r = 0, s = n[i].subSlopes.length; s > r; r++)
                        for (var a = 0, l = n[i].subSlopes[r].overtures.length; l > a; a++)
                            for (var h = 0; h < n[i].subSlopes[r].overtures[a].polygon.length; h++) {
                                var c = this.isPointInOvertureSide(t, n[i].subSlopes[r].overtures[a]);
                                if (ov = n[i].subSlopes[r].overtures[a], c !== !1)
                                    return this._targetedAtSide = c, wanaplan.engine2D.requestDynamicDraw(), n[i].subSlopes[r].overtures[a];
                                if (this._targetedAtSide = null, ov.isTargeted(t))
                                    return ov
                            }
            return !1
        }
    }, t.prototype.initialize = function() {
        var t = {title: _("Velux"),index: 90,id: "Velux",action: "wnp.engine2d.onAddSubSlopeOverture"}, e = {title: _("Dormer"),index: 91,id: "Dormer",action: "wnp.engine2d.onAddSubSlopeOverture"};
        ujs.notify("wnp.menu.main.add", {item: t,menuPath: "draw2D.subslopes",position: 90}), ujs.notify("wnp.menu.main.add", {item: e,menuPath: "draw2D.subslopes",position: 91})
    }, t.prototype.startListening = function() {
        this.onAddSubSlopeOverture = this.onAddSubSlopeOverture.bind(this), this.onDragEndSubSlope = this.onDragEndSubSlope.bind(this), this.onDoubleClick = this.onDoubleClick.bind(this), document.addEventListener("wnp.engine2d.onAddSubSlopeOverture", this.onAddSubSlopeOverture, !1), document.addEventListener("wnp.subslope.drag-end", this.onDragEndSubSlope, !1), wanaplan.engine2D.registerEventCb("SubSlopeOvertureComponent2D.static-draw", this.priority, "static-draw", null, null, this.onStaticDraw.bind(this), null), wanaplan.engine2D.registerEventCb("SubSlopeOvertureComponent2D.hover", this.priority, "hover", null, SubSlopeOvertureStructure, this.onHover.bind(this), null), wanaplan.engine2D.registerEventCb("SubSlopeOvertureComponent2D.leave", this.priority, "leave", null, SubSlopeOvertureStructure, this.onLeave.bind(this), null), wanaplan.engine2D.registerEventCb("SubSlopeOvertureComponent2D.drag-start", this.priority, "drag-start", wanaplan.engine2D.MODE_SUBSLOPE, SubSlopeOvertureStructure, this.onDragStart.bind(this), null), wanaplan.engine2D.registerEventCb("SubSlopeOvertureComponent2D.context-menu", this.priority, "click", wanaplan.engine2D.MODE_SUBSLOPE, SubSlopeOvertureStructure, this.onContextMenu.bind(this), null), wanaplan.engine2D.registerEventCb("SubSlopeOvertureComponent2D.drag.dynamic-draw", this.priority, "dynamic-draw", wanaplan.engine2D.MODE_DRAG, SubSlopeOvertureStructure, this.onDragDynamicDraw.bind(this), {}), this.core.engine2D.registerEventCb("SubSlopeOvertureComponent2D.double-click", this.priority, "double-click", wanaplan.engine2D.MODE_SUBSLOPE, SubSlopeOvertureStructure, this.onDoubleClick, null)
    }, t.prototype.stopListening = function() {
        document.removeEventListener("wnp.engine2d.onAddSubSlopeOverture", this.onAddSubSlopeOverture, !1), document.removeEventListener("wnp.subslope.drag-end", this.onDragEndSubSlope, !1), wanaplan.engine2D.unregisterEventCb("SubSlopeOvertureComponent2D.static-draw"), wanaplan.engine2D.unregisterEventCb("SubSlopeOvertureComponent2D.hover"), wanaplan.engine2D.unregisterEventCb("SubSlopeOvertureComponent2D.leave"), this.core.engine2D.unregisterEventCb("SubSlopeOvertureComponent2D.double-click")
    }, t.prototype.onHover = function(t, e) {
        return wanaplan.engine2D.registerEventCb("SubSlopeOvertureComponent2D.hopper.drag-start", this.priority, "drag-start", wanaplan.engine2D.MODE_NORMAL, SubSlopeOvertureStructure, this.onDragStart.bind(this), {}), wanaplan.engine2D.registerEventCb("SubSlopeOvertureComponent2D.dynamic-draw", this.priority, "dynamic-draw", wanaplan.engine2D.MODE_SUBSLOPE, null, this.onSelectionDynamicDraw.bind(this), e), wanaplan.engine2D.registerEventCb("SubSlopeOvertureComponent2D.hopper-hover.dynamic-draw", this.priority, "dynamic-draw", null, SubSlopeOvertureStructure, this.onHoverSubSlopeOverture.bind(this), e), wanaplan.engine2D.requestDynamicDraw(), !1
    }, t.prototype.onHoverSubSlopeOverture = function(t, e, n, i) {
        this.drawTarget(i, t, n)
    }, t.prototype.onDragEndSubSlope = function() {
        for (var t = this.structure.getCurrentStructure(), e = t.getElements("subslopes"), n = 0; n < e.length; n++) {
            var i = [];
            i[0] = e[n].polygonPoints[0], i[1] = e[n].polygonPoints[1], i[2] = e[n].polygonPoints[3], i[3] = e[n].polygonPoints[2];
            for (var o = 0; o < e[n].overtures.length; o++)
                for (var r = 0; 4 > r; r++)
                    if (!e[n].overtures[o].polygon[r].isPointInPolygon(i)) {
                        e[n].overtures[o].remove(), wanaplan.engine2D.requestStaticDraw();
                        break
                    }
        }
    }, t.prototype.onLeave = function() {
        wanaplan.engine2D.unregisterEventCb("SubSlopeOvertureComponent2D.dynamic-draw"), wanaplan.engine2D.requestDynamicDraw()
    }, t.prototype.onDragDynamicDraw = function(t, e, n) {
        if (wanaplan.engine2D.getMode() & wanaplan.engine2D.MODE_SUBSLOPE)
            for (var i = this.structure.getCurrentStructure(), o = i.getElements("subslopes"), r = 0; r < o.length; r++) {
                var s = new Array, a = o[r].wall, l = a.getWallVector().normalize(), h = new BABYLON.Vector2(l.y, -l.x), c = o[r].overtures.length;
                this.reorganizeSubslopes(o[r].overtures, o[r], l);
                for (var u = 0; c - 1 > u; u++)
                    s[u] = this.calculateDistance(o[r].overtures[u], o[r].overtures[u + 1], l, 1), this.drawCotes(o[r].overtures[u], o[r].overtures[u + 1], t, e, n, s[u]);
                for (var p = 0; c > p; p++)
                    if (o[r].overtures[p]) {
                        var d = this.getIntersectPoint(o[r].overtures[p], o[r], h, 2);
                        this.drawCotesSS(o[r].overtures[p], o[r], t, e, n, d, h)
                    }
                if (o[r].overtures[0]) {
                    var m = [], g = this.getIntersectPoint(o[r].overtures[0], o[r], l, 0), f = this.getIntersectPoint(o[r].overtures[c - 1], o[r], l, 1), y = this.getIntersectPoint(o[r].overtures[0], o[r], l, 1), _ = this.getIntersectPoint(o[r].overtures[c - 1], o[r], l, 0), v = new BABYLON.Vector2(o[r].overtures[0].getAbsolutePosition().position.x - o[r].polygonPoints[0].x, o[r].overtures[0].getAbsolutePosition().position.y - o[r].polygonPoints[0].y);
                    v.projectOnVector(l);
                    var b = new BABYLON.Vector2(o[r].polygonPoints[0].x + v.x, o[r].polygonPoints[0].y + v.y);
                    m[1] = Math.sqrt((b.x - o[r].polygonPoints[0].x) * (b.x - o[r].polygonPoints[0].x) + (b.y - o[r].polygonPoints[0].y) * (b.y - o[r].polygonPoints[0].y));
                    var w = new BABYLON.Vector2(o[r].overtures[c - 1].getAbsolutePosition().position.x - o[r].polygonPoints[0].x, o[r].overtures[c - 1].getAbsolutePosition().position.y - o[r].polygonPoints[0].y);
                    w.projectOnVector(l);
                    var x = new BABYLON.Vector2(o[r].polygonPoints[0].x + w.x, o[r].polygonPoints[0].y + w.y);
                    m[2] = Math.sqrt((x.x - o[r].polygonPoints[0].x) * (x.x - o[r].polygonPoints[0].x) + (x.y - o[r].polygonPoints[0].y) * (x.y - o[r].polygonPoints[0].y));
                    var C = new BABYLON.Vector2(o[r].overtures[0].getAbsolutePosition().position.x - o[r].polygonPoints[1].x, o[r].overtures[0].getAbsolutePosition().position.y - o[r].polygonPoints[1].y);
                    C.projectOnVector(l);
                    var M = new BABYLON.Vector2(o[r].polygonPoints[1].x + C.x, o[r].polygonPoints[1].y + C.y);
                    m[3] = Math.sqrt((M.x - o[r].polygonPoints[1].x) * (M.x - o[r].polygonPoints[1].x) + (M.y - o[r].polygonPoints[1].y) * (M.y - o[r].polygonPoints[1].y));
                    var D = new BABYLON.Vector2(o[r].overtures[c - 1].getAbsolutePosition().position.x - o[r].polygonPoints[1].x, o[r].overtures[c - 1].getAbsolutePosition().position.y - o[r].polygonPoints[1].y);
                    D.projectOnVector(l);
                    var B = new BABYLON.Vector2(o[r].polygonPoints[1].x + D.x, o[r].polygonPoints[1].y + D.y);
                    m[4] = Math.sqrt((B.x - o[r].polygonPoints[1].x) * (B.x - o[r].polygonPoints[1].x) + (B.y - o[r].polygonPoints[1].y) * (B.y - o[r].polygonPoints[1].y));
                    for (var A = 1 / 0, E = 1; 4 >= E; E++)
                        m[E] < A && (A = m[E]);
                    Math.abs(A - m[1]) < .1 || Math.abs(A - m[4]) < .1 ? (this.drawCotesSS(o[r].overtures[0], o[r], t, e, n, g, l), this.drawCotesSS(o[r].overtures[c - 1], o[r], t, e, n, f, l)) : (this.drawCotesSS(o[r].overtures[0], o[r], t, e, n, y, l), this.drawCotesSS(o[r].overtures[c - 1], o[r], t, e, n, _, l))
                }
            }
    }, t.prototype.calculateDistance = function(t, e, n, i) {
        var o, r = new BABYLON.Vector2(e.position.x - t.position.x, e.position.y - t.position.y);
        return r.projectOnVector(n), o = Math.sqrt(r.x * r.x + r.y * r.y), o -= 0 === i ? t.height / 2 + t.height / 2 : t.width / 2 + t.width / 2
    }, t.prototype.getIntersectPoint = function(t, e, n, i) {
        var o = new BABYLON.Vector2;
        if (2 != i)
            var r = e.polygonPoints[0 + i].x, s = e.polygonPoints[0 + i].y, a = e.polygonPoints[2 + i].x, l = e.polygonPoints[2 + i].y;
        else
            var r = e.polygonPoints[0].x, s = e.polygonPoints[0].y, a = e.polygonPoints[1].x, l = e.polygonPoints[1].y;
        var h = t.getAbsolutePosition().position.x, c = t.getAbsolutePosition().position.y, u = t.getAbsolutePosition().position.x + n.x, p = t.getAbsolutePosition().position.y + n.y;
        if (Math.abs(a - r) > .1 && Math.abs(u - h) > .1) {
            var d = (l - s) / (a - r), m = (s * (a - r) - r * (l - s)) / (a - r), g = (p - c) / (u - h), f = (c * (u - h) - h * (p - c)) / (u - h);
            o.x = (f - m) / (d - g), d * ((f - m) / (d - g)) + m, o.y = d * ((f - m) / (d - g)) + m
        } else if (Math.abs(a - r) < .1)
            o.x = r, o.y = c;
        else {
            o.x = h;
            var d = (l - s) / (a - r), m = (s * (a - r) - r * (l - s)) / (a - r);
            o.y = d * h + m
        }
        return o
    }, t.prototype.onSelectionDynamicDraw = function(t, e, n, i) {
        var o = i.parent.wall, r = o.points[0].position.clone().lerp(o.points[1].position, .5).add(i.position), s = {x: r.x * n + e.x,y: r.y * n + e.y};
        wanaplan.engine2D.symbols2D.drawGrip(t, s, [!0, !0, !0, !0], 0)
    }, t.prototype.changeAddStateVelux = function() {
        this._addState = 1, wanaplan.engine2D.registerEventCb("component.add-hopper.click", this.priority, "click", wanaplan.engine2D.MODE_SUBSLOPE, null, this.onAddVeluxClick.bind(this), {}), wanaplan.engine2D.registerEventCb("component.dynamic-component.mouse-move", this.priority, "mouse-move", wanaplan.engine2D.MODE_SUBSLOPE, null, this.onMouseMove.bind(this), {}), wanaplan.engine2D.registerEventCb("component.dynamic-component.dynamic-draw", this.priority, "dynamic-draw", wanaplan.engine2D.MODE_SUBSLOPE, null, this.onDynamicDraw.bind(this), {}), wanaplan.engine2D.requestStaticDraw()
    }, t.prototype.changeAddStateSubSlopeOverture = function() {
        this._addState = 1, wanaplan.engine2D.registerEventCb("component.add-hopper.click", this.priority, "click", wanaplan.engine2D.MODE_SUBSLOPE, null, this.onAddSubSlopeOvertureClick.bind(this), {}), wanaplan.engine2D.registerEventCb("component.dynamic-component.mouse-move", this.priority, "mouse-move", wanaplan.engine2D.MODE_SUBSLOPE, null, this.onMouseMove.bind(this), {}), wanaplan.engine2D.registerEventCb("component.dynamic-component.dynamic-draw", this.priority, "dynamic-draw", wanaplan.engine2D.MODE_SUBSLOPE, null, this.onDynamicDraw.bind(this), {}), wanaplan.engine2D.requestStaticDraw()
    }, t.prototype.onAddVelux = function() {
        this._tmpOverture = new SubSlopeOvertureStructure, this._tmpOverture.type = "Velux", this.changeAddStateVelux()
    }, t.prototype.onAddSubSlopeOverture = function(t) {
        this._tmpOverture = new SubSlopeOvertureStructure, this._tmpOverture.type = t.id, t.width && (this._tmpOverture.width = t.width), t.height && (this._tmpOverture.height = t.height), this.changeAddStateSubSlopeOverture()
    }, t.prototype.onAddSubSlopeOvertureClick = function() {
        wanaplan.helpBubbleManager.display("wnp.2d.subslopeOverture-menu"), 1 == this._addState && (this._tmpOverture.parent.overtures.push(this._tmpOverture), wanaplan.engine2D.requestStaticDraw(), ujs.notify("wnp.menu.main.deselect"), this._addState = 0, this._tmpOverture = null, wanaplan.engine2D.requestDynamicDraw())
    }, t.prototype.onMouseMove = function(t, e, n) {
        if (this._tmpOverture) {
            this._tmpOverture._tmpPos = n.planPos;
            for (var i = wanaplan.getSelectedStructure(), o = i.getElements("walls"), r = 0; r < o.length; r++)
                for (var s = 0; s < o[r].subSlopes.length; s++)
                    if (o[r].subSlopes[s].isPointIn(n.planPos)) {
                        this._tmpOverture.parent = o[r].subSlopes[s];
                        var a = o[r].subSlopes[s].wall, l = a.getWallVector().normalize(), h = new BABYLON.Vector2(l.y, -l.x);
                        return this._tmpOverture.position.copyFrom(this._tmpOverture._tmpPos).subtractInPlace(a.points[0].position.clone().lerp(a.points[1].position, .5)), this.appliedMagnetism(this._tmpOverture, o[r].subSlopes[s], h, l), void wanaplan.engine2D.requestStaticDraw()
                    }
        }
    }, t.prototype.onContextMenu = function(t, e) {
        var n, i = [], o = Math.atan((e.parent.hiHeight - e.parent.lowHeight) / e.parent.offset);
        n = "Dormer" == e.type ? 2 * e.wallThickness : 0, "Dormer" != e.type && i.push({name: "height",label: _("Height"),type: "slider",cast: "int",unit: "cm",value: {min: 20,max: 500,step: 1,value: e.height}}), i.push({name: "width",label: _("Width"),type: "slider",cast: "int",unit: "cm",value: {min: 20,max: 500,step: 1,value: Math.round(e.width) + n}}), "Dormer" == e.type && (i.push({name: "dormerRoofHeight",label: _("Dormer roof height"),type: "slider",cast: "int",value: {min: 0,max: e.width,step: 1,value: Math.round(e.dormerRoof.height > -1 ? e.dormerRoof.height : e.width / 2)}}), i.push({name: "nbCasement",label: _("Number of casements"),type: "slider",cast: "int",value: {min: 1,max: 6,step: 1,value: e.nbCasement}}), i.push({name: "height",label: _("Height"),type: "slider",cast: "int",unit: "cm",value: {min: 20,max: 500,step: 1,value: Math.round(e.height * Math.sin(o))}}), i.push({name: "depth",label: _("Depth"),type: "html",html: "<label>" + _("Depth") + '</label><span class="field">' + Math.round(e.height * Math.cos(o)) + " cm</span>"})), wanaplan.engine2D.displayContextMenu(i, e, this.onContextMenuPropertyChanged.bind(this), this.onContextMenuRemove.bind(this))
    }, t.prototype.onContextMenuPropertyChanged = function(t, e, n) {
        var i = Math.atan((t.parent.hiHeight - t.parent.lowHeight) / t.parent.offset);
        if (-1 != e.indexOf("sticks_")) {
            var o = e.split("_");
            t.sticks[o[1]] = n
        } else if ("cut" == e) {
            var r = t.points[this._targetedAtSide], s = t.points[this._targetedAtSide + 1], a = r.clone().lerp(s, .5);
            t.insertPointAt(this._targetedAtSide + 1, a)
        } else if ("enable_sticks" == e)
            for (var l = 0; l < t.points.length; l++)
                t.sticks[l] = !0;
        else if ("disable_sticks" == e)
            for (var l = 0; l < t.points.length; l++)
                t.sticks[l] = !1;
        else
            "dormerRoofHeight" == e ? t.dormerRoof.height = n : t[e] = "height" == e ? n / Math.sin(i) : "width" == e && "Dormer" == t.type ? n - 2 * t.wallThickness : n;
        wanaplan.engine2D.requestStaticDraw()
    }, t.prototype.onContextMenuRemove = function(t) {
        var e = wanaplan.getSelectedStructure();
        t.remove(e), wanaplan.engine2D.requestDynamicDraw()
    }, t.prototype.onStaticDraw = function(t, e, n) {
        if (0 != (wanaplan.engine2D.getMode() & wanaplan.engine2D.MODE_SUBSLOPE))
            for (var i = wanaplan.getSelectedStructure(), o = i.getElements("walls"), r = 0; r < o.length; r++)
                for (var s = 0; s < o[r].subSlopes.length; s++)
                    for (var a = 0; a < o[r].subSlopes[s].overtures.length; a++)
                        this.draw(o[r].subSlopes[s].overtures[a], t, e, n)
    }, t.prototype.onDynamicDraw = function(t, e, n) {
        1 == this._addState && (wanaplan.engine2D.setCursorIcon(wanaplan.engine2D.symbols2D.drawCursorCheck.bind(wanaplan.engine2D.symbols2D)), this.draw(this._tmpOverture, t, e, n, !1)), this.drawMagnetism(this._overture1Magnetism, this._overture2Magnetism, t, e, n)
    }, t.prototype.onDragStart = function(t, e) {
        return wanaplan.engine2D.registerEventCb("SubSlopeOvertureComponent2D.drag-end", this.priority, "drag-end", wanaplan.engine2D.MODE_DRAG, null, this.onDragEnd.bind(this), e), wanaplan.engine2D.registerEventCb("SubSlopeOvertureComponent2D.dynamic-draw", this.priority, "dynamic-draw", wanaplan.engine2D.MODE_DRAG, null, this.onSelectionDynamicDraw.bind(this), e), wanaplan.engine2D.registerEventCb("component.dynamic-component.dynamic-draw", this.priority, "dynamic-draw", wanaplan.engine2D.MODE_SUBSLOPE, null, this.onDynamicDraw.bind(this), {}), wanaplan.engine2D.registerEventCb("SubSlopeOvertureComponent2D.dragging", this.priority, "dragging", wanaplan.engine2D.MODE_DRAG, null, this.onDraggingMove.bind(this), e), !1
    }, t.prototype.onDraggingMove = function(t, e, n, i) {
        for (var o = i.parent.wall, r = o.getWallVector().normalize(), s = new BABYLON.Vector2(r.y, -r.x), a = this.structure.getCurrentStructure(), l = a.getElements("subslopes"), h = 0; h < l.length; h++)
            l[h].isPointIn(n.planPos) && (i.wall = l[h].wall);
        var o = i.wall, c = (o.getWallVector().normalize(), o.points[0].position.clone().lerp(o.points[1].position, .5), n.posDelta.scale(1 / wanaplan.engine2D.getZoom())), u = new BABYLON.Vector2(c.x, c.y), p = new BABYLON.Vector2(c.x, c.y);
        if (u.projectOnVector(r), p.projectOnVector(s), null === this._targetedAtSide) {
            var d = n.planPos.subtract(i.parent.wall.points[0].position.clone().lerp(i.parent.wall.points[1].position, .5)), m = (new BABYLON.Vector2((c.x * r.x + c.x * s.x) / (r.x * r.x + r.y * r.y), (c.x * r.y - c.x * s.y) / (r.x * r.x + r.y * r.y)), []);
            m[0] = n.planPos.add(r.scale(i.width / 2)).add(s.scale(i.height / 2)), m[1] = n.planPos.subtract(r.scale(i.width / 2)).add(s.scale(i.height / 2)), m[2] = n.planPos.add(r.scale(i.width / 2)).subtract(s.scale(i.height / 2)), m[3] = n.planPos.subtract(r.scale(i.width / 2)).subtract(s.scale(i.height / 2)), i.parent.computePolygonPoints(), this.isInSubSlope(i.parent.polygonPoints, m, i.width, i.height) && (i.position = d, this.appliedMagnetism(i, i.parent, s, r))
        } else {
            var g = Math.atan((i.parent.hiHeight - i.parent.lowHeight) / i.parent.offset), f = Math.cos(g), y = new BABYLON.Vector2(i.parent.polygonPoints[2].x - i.parent.polygonPoints[0].x, i.parent.polygonPoints[2].y - i.parent.polygonPoints[0].y);
            y.projectOnVector(s);
            var _ = y.x * s.x + y.y * s.y;
            0 > _ && (r.x = -r.x, r.y = -r.y, s.x = -s.x, s.y = -s.y);
            var v = i.polygon[this._targetedAtSide], b = this._targetedAtSide + 1 < i.polygon.length ? this._targetedAtSide + 1 : 0, w = i.polygon[b], m = (new BABYLON.Vector2(v.y - w.y, w.x - v.x), []);
            if (m[0] = i.polygon[0], m[1] = i.polygon[1], m[2] = i.polygon[2], m[3] = i.polygon[3], this._targetedAtSide % 2 === 0) {
                i.position.addInPlace(u.scale(.5));
                var x = r.dot(u) > 0 ? 1 : -1, C = 0 === this._targetedAtSide ? 1 : -1;
                i.width += C * x * u.length(), this.appliedMagnetism(i, i.parent, s, r)
            } else {
                i.position.addInPlace(p.scale(.5));
                var x = s.dot(p) > 0 ? 1 : -1, C = 1 === this._targetedAtSide ? -1 : 1;
                i.height += 1 / f * C * x * p.length()
            }
        }
        return i.modified = !0, wanaplan.engine2D.requestStaticDraw(), !1
    }, t.prototype.onDoubleClick = function(t, e) {
        return this.core.helpBubbleManager.display("wnp.2d.dup-overture"), this.onAddSubSlopeOverture({id: e.type,width: e.width,height: e.height}), !0
    }, t.prototype.isInSubSlope = function(t, e) {
        var n = [];
        return n[0] = t[0], n[1] = t[1], n[2] = t[3], n[3] = t[2], e[0].isPointInPolygon(n) && e[1].isPointInPolygon(n) && e[2].isPointInPolygon(n) && e[3].isPointInPolygon(n) ? !0 : !1
    }, t.prototype.appliedMagnetism = function(t, e, n) {
        var i = [];
        i.push(t);
        for (var o, r = 0; r < e.overtures.length; r++)
            if (e.overtures[r].id != t.id && (o = n.x * (e.overtures[r].position.x - t.position.x) + n.y * (e.overtures[r].position.y - t.position.y), Math.abs(o) < 6)) {
                i.push(e.overtures[r]);
                var s = new BABYLON.Vector2;
                s.x = e.overtures[r].position.x - t.position.x, s.y = e.overtures[r].position.y - t.position.y, s.projectOnVector(n), t.position.addInPlace(s.scale(1)), this._overture1Magnetism = t, this._overture2Magnetism = e.overtures[r]
            }
    }, t.prototype.appliedSideMagnetism = function(t, e, n, i, o) {
        if (3 == o)
            for (var r = 0; r < e.overtures.length; r++) {
                var s = n.length(), a = t.height / (2 * s), l = e.overtures[r].height / (2 * s), h = new BABYLON.Vector2(t.position.x + n.x * a, t.position.y + n.y * a), c = new BABYLON.Vector2(e.overtures[r].position.x + n.x * l, e.overtures[r].position.y + n.y * l), u = new BABYLON.Vector2(h.x - c.x, h.y - c.y);
                if (e.overtures[r].id != t.id && Math.abs(u.x * n.x + u.y * n.y) < 7) {
                    u.projectOnVector(n);
                    var p = n.dot(u) > 0 ? -1 : 1;
                    t.height += p * u.length(), t.position.x -= .5 * u.x, t.position.y -= .5 * u.y
                }
            }
        else
            for (var r = 0; r < e.overtures.length; r++) {
                var s = n.length(), a = -t.height / (2 * s), l = -e.overtures[r].height / (2 * s), h = new BABYLON.Vector2(t.position.x + n.x * a, t.position.y + n.y * a), c = new BABYLON.Vector2(e.overtures[r].position.x + n.x * l, e.overtures[r].position.y + n.y * l), u = new BABYLON.Vector2(h.x - c.x, h.y - c.y);
                if (e.overtures[r].id != t.id && Math.abs(u.x * n.x + u.y * n.y) < 7) {
                    u.projectOnVector(n);
                    var p = n.dot(u) > 0 ? 1 : -1;
                    t.height += p * u.length(), t.position.x -= .5 * u.x, t.position.y -= .5 * u.y
                }
            }
    }, t.prototype.reorganizeSubslopes = function(t, e, n) {
        for (var i = n, o = (new BABYLON.Vector2(i.y, -i.x), []), r = (i.x * (e.polygonPoints[0].x - e.polygonPoints[1].x) + i.y * (e.polygonPoints[0].y - e.polygonPoints[1].y), 0); r < t.length; r++) {
            var s = new BABYLON.Vector2(t[r].position.x - e.polygonPoints[0].x, t[r].position.y - e.polygonPoints[0].y);
            s.projectOnVector(i);
            var a = new BABYLON.Vector2(e.polygonPoints[0].x + s.x, e.polygonPoints[0].y + s.y), l = Math.sqrt((a.x - e.polygonPoints[0].x) * (a.x - e.polygonPoints[0].x) + (a.y - e.polygonPoints[0].y) * (a.y - e.polygonPoints[0].y));
            o.push(l)
        }
        for (var h = 1; h < o.length; h++) {
            for (var c = o[h], u = t[h], p = h; p > 0 && o[p - 1] > c; )
                o[p] = o[p - 1], t[p] = t[p - 1], p--;
            o[p] = c, t[p] = u
        }
    }, t.prototype.onDragEnd = function(t, e, n, i) {
        wanaplan.engine2D.unregisterEventCb("SubSlopeOvertureComponent2D.dynamic-draw"), wanaplan.engine2D.requestStaticDraw(), this.checkCoherence(i), this._overture1Magnetism = null, this._overture2Magnetism = null
    }, t.prototype.checkCoherence = function(t) {
        t.width < 0 && (t.width = -t.width), t.height < 0 && (t.height = -t.height)
    }, t.prototype.isPointInOvertureSide = function(t, e) {
        for (var n = 0; n < e.polygon.length; n++) {
            var i = e.polygon[n].clone(), o = n + 1 < e.polygon.length ? e.polygon[n + 1] : e.polygon[0], r = Math.abs(i.distanceTo(t) + o.distanceTo(t) - i.distanceTo(o));
            if (1 > r)
                return n
        }
        return !1
    }, t.prototype.drawTarget = function(t, e, n) {
        if (null !== this._targetedAt) {
            var i = wanaplan.engine2D.toRealCoord(t.polygon[this._targetedAt]);
            wanaplan.engine2D.symbols2D.drawPointHover(e, i, n)
        } else if (null !== this._targetedAtSide) {
            var o = wanaplan.engine2D.toRealCoord(t.polygon[this._targetedAtSide]), r = wanaplan.engine2D.toRealCoord(this._targetedAtSide + 1 < t.polygon.length ? t.polygon[this._targetedAtSide + 1] : t.polygon[0]);
            wanaplan.engine2D.symbols2D.drawSegment(e, o, r)
        }
    }, t.prototype.draw = function(t, e, n, i, o) {
        if (e.save(), e.beginPath(), o ? (e.fillStyle = wanaplan.engine2D.symbols2D.COLOR_ACTIVE_FILL, e.strokeStyle = wanaplan.engine2D.symbols2D.COLOR_ACTIVE_STROKE_DARKER) : (e.fillStyle = wanaplan.engine2D.symbols2D.COLOR_INACTIVE_FILL, e.strokeStyle = wanaplan.engine2D.symbols2D.COLOR_INACTIVE_STROKE), null !== t.position && null !== t.parent) {
            var r = t.parent.wall, s = r.getWallVector().normalize(), a = new BABYLON.Vector2(s.y, -s.x), l = new BABYLON.Vector2(r.subSlopes[0].polygonPoints[2].x - r.subSlopes[0].polygonPoints[0].x, r.subSlopes[0].polygonPoints[2].y - r.subSlopes[0].polygonPoints[0].y);
            l.projectOnVector(a);
            var h = l.x * a.x + l.y * a.y;
            0 > h && (s.x = -s.x, s.y = -s.y, a.x = -a.x, a.y = -a.y);
            var c = r.points[0].position.clone().lerp(r.points[1].position, .5).add(t.position), u = 40 * t.parent.offset / (t.parent.hiHeight - t.parent.lowHeight);
            t.offset = t.position.dot(a), t.wallOrtho = a, t.center = c;
            var p = Math.atan((t.parent.hiHeight - t.parent.lowHeight) / t.parent.offset), d = Math.cos(p);
            "Dormer" == t.type ? (t.polygon[0] = c.add(s.scale(t.width / 2)).add(a.scale(t.height / (2 / d))).add(s.scale(t.wallThickness)), t.polygon[1] = c.add(s.scale(t.width / 2)).subtract(a.scale(t.height / (2 / d))).subtract(a.scale(t.wallThickness)).add(s.scale(t.wallThickness)), t.polygon[2] = c.subtract(s.scale(t.width / 2)).subtract(a.scale(t.height / (2 / d))).subtract(a.scale(t.wallThickness)).subtract(s.scale(t.wallThickness)), t.polygon[3] = c.subtract(s.scale(t.width / 2)).add(a.scale(t.height / (2 / d))).subtract(s.scale(t.wallThickness))) : (t.polygon[0] = c.add(s.scale(t.width / 2)).add(a.scale(t.height / (2 / d))), t.polygon[1] = c.add(s.scale(t.width / 2)).subtract(a.scale(t.height / (2 / d))), t.polygon[2] = c.subtract(s.scale(t.width / 2)).subtract(a.scale(t.height / (2 / d))), t.polygon[3] = c.subtract(s.scale(t.width / 2)).add(a.scale(t.height / (2 / d))));
            var m = c.add(a.scale(t.height / (2 / d) + u)), g = c.subtract(a.scale(t.height / (2 / d))), f = wanaplan.engine2D.toRealCoord(t.polygon[0], n, i), y = wanaplan.engine2D.toRealCoord(t.polygon[1], n, i), _ = wanaplan.engine2D.toRealCoord(t.polygon[2], n, i), v = wanaplan.engine2D.toRealCoord(t.polygon[3], n, i), b = wanaplan.engine2D.toRealCoord(m, n, i), w = wanaplan.engine2D.toRealCoord(g, n, i);
            "Velux" == t.type ? (e.moveTo(Math.round(f.x) + .5, Math.round(f.y) + .5), e.lineTo(Math.round(y.x) + .5, Math.round(y.y) + .5), e.lineTo(Math.round(_.x) + .5, Math.round(_.y) + .5), e.lineTo(Math.round(v.x) + .5, Math.round(v.y) + .5)) : (e.moveTo(Math.round(b.x) + .5, Math.round(b.y) + .5), e.lineTo(Math.round(v.x) + .5, Math.round(v.y) + .5), e.lineTo(Math.round(_.x) + .5, Math.round(_.y) + .5), e.lineTo(Math.round(y.x) + .5, Math.round(y.y) + .5), e.lineTo(Math.round(f.x) + .5, Math.round(f.y) + .5), e.lineTo(Math.round(b.x) + .5, Math.round(b.y) + .5), e.lineTo(Math.round(w.x) + .5, Math.round(w.y) + .5)), e.closePath(), e.fill(), e.stroke(), e.restore()
        }
    }, t.prototype.drawMagnetism = function(t, e, n, i, o) {
        if (n.save(), n.beginPath(), n.fillStyle = wanaplan.engine2D.symbols2D.COLOR_ACTIVE_FILL, n.strokeStyle = wanaplan.engine2D.symbols2D.COLOR_ACTIVE_STROKE, null !== t) {
            var r = t.getAbsolutePosition().position, s = e.getAbsolutePosition().position, a = wanaplan.engine2D.toRealCoord(r, i, o), l = wanaplan.engine2D.toRealCoord(s, i, o), h = t.parent.wall, c = h.getWallVector().normalize(), u = Math.abs(c.x * (r.y - s.y)), p = Math.abs(c.y * (r.x - s.x));
            Math.abs(u - p) < .01 && (n.moveTo(a.x, a.y), n.lineTo(l.x, l.y))
        }
        n.closePath(), n.fill(), n.stroke(), n.restore()
    }, t.prototype.drawCotes = function(t, e, n, i, o, r) {
        n.fillStyle = wanaplan.engine2D.symbols2D.COLOR_INACTIVE_FILL, n.strokeStyle = wanaplan.engine2D.symbols2D.COLOR_INACTIVE_STROKE;
        var s = t.parent.wall, a = s.getWallVector().normalize(), l = new BABYLON.Vector2(a.y, -a.x), h = t.getAbsolutePosition().position, c = e.getAbsolutePosition().position, u = h.add(c).scaleInPlace(.5), p = a, d = l, m = h.dot(p), g = c.dot(p);
        if (m > g) {
            var f = g;
            g = m, m = f, m += e.width / 2 + ("Dormer" == e.type ? e.wallThickness : 0), g -= t.width / 2 + ("Dormer" == t.type ? t.wallThickness : 0)
        } else
            m += t.width / 2 + ("Dormer" == t.type ? t.wallThickness : 0), g -= e.width / 2 + ("Dormer" == e.type ? e.wallThickness : 0);
        var y = u.dot(d), _ = new BABYLON.Vector2(p.x * m + d.x * y, p.y * m + d.y * y), v = new BABYLON.Vector2(p.x * g + d.x * y, p.y * g + d.y * y), b = wanaplan.engine2D.toRealCoord(_, i, o), w = wanaplan.engine2D.toRealCoord(v, i, o), x = Math.round(r) / 100;
        wanaplan.engine2D.symbols2D.drawMeasure(n, b, w, x + "m"), n.closePath(), n.fill(), n.stroke(), n.restore()
    }, t.prototype.drawCotesSS = function(t, e, n, i, o, r, s) {
        n.fillStyle = wanaplan.engine2D.symbols2D.COLOR_INACTIVE_FILL, n.strokeStyle = wanaplan.engine2D.symbols2D.COLOR_INACTIVE_STROKE;
        var a = t.parent.wall, l = a.getWallVector().normalize(), h = new BABYLON.Vector2(l.y, -l.x), c = t.getAbsolutePosition().position, u = r, p = Math.atan((e.hiHeight - e.lowHeight) / e.offset), d = Math.cos(p), m = new BABYLON.Vector2(c.x - u.x, c.y - u.y);
        if (Math.abs(s.x * h.x + s.y * h.y) < .1)
            if ("Dormer" == t.type) {
                c = c.subtract(m.normalize().scale(t.width / 2 + t.wallThickness));
                var g = 0
            } else {
                c = c.subtract(m.normalize().scale(t.width / 2));
                var g = 0
            }
        else if ("Dormer" == t.type) {
            c = c.subtract(m.normalize().scale(d * t.height / 2)).subtract(h.scale(t.wallThickness));
            var g = Math.atan((e.hiHeight - e.lowHeight) / e.offset)
        } else {
            c = c.subtract(m.normalize().scale(d * t.height / 2));
            var g = Math.atan((e.hiHeight - e.lowHeight) / e.offset)
        }
        var f = Math.sqrt((r.x - c.x) * (r.x - c.x) + (r.y - c.y) * (r.y - c.y)) / Math.cos(g);
        f = Math.round(f) / 100;
        var y = wanaplan.engine2D.toRealCoord(c, i, o), _ = wanaplan.engine2D.toRealCoord(u, i, o);
        wanaplan.engine2D.symbols2D.drawMeasure(n, y, _, f + "m"), n.closePath(), n.fill(), n.stroke(), n.restore()
    }, t
}(), SubSlopeComponent3D = function() {
    var t, e = function(e) {
        BaseComponent3D.call(this, e, "SubSlopeComponent3D"), this.currentID = 0, t = this
    };
    return e.prototype = new BaseComponent3D, e.prototype.startListening = function() {
        document.addEventListener("wnp.engine3d.wallsReady", this.onWallsReady, !1)
    }, e.prototype.stopListening = function() {
        document.removeEventListener("wnp.engine3d.wallsReady", this.onWallsReady, !1)
    }, e.prototype.onWallsReady = function(e) {
        var n = e.floor || t.getFloor(), i = e.structure || t.core.getSelectedStructure();
        t.core.getComponentByName("SubSlopeComponent2D").getSubSlopes(!0), t.drawSSForStructure(i, n, wanaplan.engine3D.scene)
    }, e.prototype.buildCSG = function(t, e, n, i) {
        var o, r, s = s || !1;
        n = n || this.core.getComponentByName("FloorComponent3D").getFloor(e);
        var a = t[0].subtract(t[1]), l = t[3].subtract(t[2]), h = [], c = [], u = [], p = [];
        if (a.dot(l) > 0) {
            for (r = 0; r < t.length; r++)
                h.push(t[r].x, t[r].y, t[r].z);
            h.push(t[0].x, t[2].y, t[0].z), h.push(t[1].x, t[3].y, t[1].z), c.push(0, 2, 3), c.push(2, 0, 1), c.push(5, 3, 2), c.push(3, 5, 4), c.push(4, 1, 0), c.push(1, 4, 5), c.push(5, 2, 1), c.push(3, 4, 0)
        } else {
            var d = t[0].subtract(t[3]), m = t[3].subtract(t[2]).length(), g = t[1].subtract(t[0]).length(), f = m / g + 1, y = d.scale(1 / f).subtract(t[0]).scale(-1), _ = [t[0], t[1], y];
            for (r = 0; r < _.length; r++)
                h.push(_[r].x, _[r].y, _[r].z);
            h.push(_[2].x, t[2].y, _[2].z), h.push(t[0].x, t[2].y, t[0].z), h.push(t[1].x, t[2].y, t[1].z), c.push(0, 1, 2), c.push(2, 3, 0), c.push(3, 4, 0), c.push(1, 5, 2), c.push(3, 2, 5), c.push(4, 3, 5), c.push(1, 0, 4), c.push(1, 4, 5)
        }
        u = BABYLON.Tools.PlaneUVProjection(h, new BABYLON.Vector3(1, 0, 0), new BABYLON.Vector3(0, 0, 1)), BABYLON.Mesh.ComputeFlatNormal(h, p, c);
        var v = new BABYLON.Mesh("carveMesh", i);
        return v.setVerticesData(BABYLON.VertexBuffer.PositionKind, h, s), v.setVerticesData(BABYLON.VertexBuffer.NormalKind, p, s), v.setVerticesData(BABYLON.VertexBuffer.UVKind, u, s), v.setIndices(c), v.parent = n, o = BABYLON.CSG.FromMesh(v), v.dispose(), o
    }, e.prototype.addSubSlope = function(t, e, n, i, o, r) {
        var s, a, l, h, c, u, p, d = d || !1, m = [], g = [], f = [], y = [];
        o = o || this.core.getComponentByName("FloorComponent3D").getFloor(i);
        var _ = new wnp.WhiteMaterial("bottom", wanaplan.engine3D.scene, {factor: 1}), v = n.materials.bottom || _;
        n.materials.bottom || (n.materials.bottom = v), v.name = "bottom";
        var b = n.materials.top || _.clone("top");
        n.materials.top || (n.materials.top = b), b.name = "top";
        var w = e[0].subtract(e[1]), x = e[3].subtract(e[2]);
        if (w.dot(x) > 0) {
            for (g.push(0, 2, 3), g.push(2, 0, 1), g.push(7, 5, 4), g.push(5, 7, 6), s = 0; s < e.length; s++)
                m.push(e[s].x, e[s].y, e[s].z);
            for (s = 0; s < e.length; s++)
                m.push(e[s].x, e[s].y + .1, e[s].z);
            l = new BABYLON.Vector3(e[1].x - e[0].x, e[1].y - e[0].y, e[1].z - e[0].z), l.normalize(), h = new BABYLON.Vector3(e[2].x - e[1].x, e[2].y - e[1].y, e[2].z - e[1].z), h.normalize(), u = BABYLON.Vector3.Cross(l, h), c = BABYLON.Vector3.Cross(u, l), f = BABYLON.Tools.PlaneUVProjection(m, l, c, 512), BABYLON.Mesh.ComputeFlatNormal(m, y, g), a = new BABYLON.Mesh("subslope_" + this.currentID++, r), a.setVerticesData(BABYLON.VertexBuffer.PositionKind, m, d), a.setVerticesData(BABYLON.VertexBuffer.NormalKind, y, d), a.setVerticesData(BABYLON.VertexBuffer.UVKind, f, d), a.setIndices(g), a.subMeshes.shift(), p = BABYLON.SubMesh.CreateFromIndices(0, 0, 6, a), p.objectInstance = n, p = BABYLON.SubMesh.CreateFromIndices(1, 6, 6, a), p.objectInstance = n
        } else {
            var C = e[0].subtract(e[3]), M = e[3].subtract(e[2]).length(), D = e[1].subtract(e[0]).length(), B = M / D + 1, A = C.scale(1 / B).subtract(e[0]).scale(-1), E = [e[0], e[1], A];
            for (s = 0; s < E.length; s++)
                m.push(E[s].x, E[s].y, E[s].z);
            for (s = 0; s < E.length; s++)
                m.push(E[s].x, E[s].y + .1, E[s].z);
            g.push(0, 1, 2), g.push(5, 4, 3), l = new BABYLON.Vector3(e[1].x - e[0].x, e[1].y - e[0].y, e[1].z - e[0].z), l.normalize(), h = new BABYLON.Vector3(e[2].x - e[1].x, e[2].y - e[1].y, e[2].z - e[1].z), h.normalize(), u = BABYLON.Vector3.Cross(l, h), c = BABYLON.Vector3.Cross(u, l), f = BABYLON.Tools.PlaneUVProjection(m, l, c, 512), BABYLON.Mesh.ComputeFlatNormal(m, y, g), a = new BABYLON.Mesh("subslope_" + this.currentID++, r), a.setVerticesData(BABYLON.VertexBuffer.PositionKind, m, d), a.setVerticesData(BABYLON.VertexBuffer.NormalKind, y, d), a.setVerticesData(BABYLON.VertexBuffer.UVKind, f, d), a.setIndices(g), a.subMeshes.shift(), p = BABYLON.SubMesh.CreateFromIndices(0, 0, 3, a), p.objectInstance = n, p = BABYLON.SubMesh.CreateFromIndices(1, 3, 3, a), p.objectInstance = n
        }
        a.position.y = .2;
        var T = t, S = BABYLON.Mesh.mergeMeshes("mat", [T, a], r, !0);
        S.name = T.name, S.id = T.id, S.decorate = T.decorate, S.receiveShadows = T.receiveShadows, S.material = T.material, S.isDecorable = !0, wanaplan.engine3D.castShadows(S)
    }, e.prototype.buildFromCSG = function(t, e, n, i, o, r) {
        var s = t, a = e, l = i.clone();
        a.subtractInPlace(i);
        var h = a.toMesh("mat", s.material, r, !0);
        this.core.getComponentByName("WallComponent3D").replaceWall(s, h), h.material = s.material, h.isDecorable = !0, wanaplan.engine3D.castShadows(h);
        var c = n;
        c.subtractInPlace(l);
        var u = c.toMesh("mat", o.roomMesh.material, r, !0);
        return u.isDecorable = !0, this.core.getComponentByName("RoomComponent3D").replaceRoom(o.roomMesh, u), u.parent = o, o.roomMesh = u, h
    }, e.prototype.drawSSForStructure = function(t, e, n) {
        var i, o, r, s = [], a = t.getElements("subslopes"), l = 0, h = this.core.getComponentByName("WallComponent3D").get3DWallFrom2D(t), c = BABYLON.CSG.FromMesh(h), u = BABYLON.CSG.FromMesh(e.roomMesh), p = new BABYLON.CSG;
        for (o = 0, r = a.length; r > o; o++)
            if (i = a[o].plane(), i && (l++, s.push(i)), i) {
                var d = this.buildCSG(i, a[o], e, n);
                d ? p.unionInPlace(d) : l--
            }
        for (h = this.core.getComponentByName("WallComponent3D").get3DWallFrom2D(t), this.buildFromCSG(h, c, u, p, e, n), o = 0, r = a.length; r > o; o++)
            i = a[o].plane(), h = this.core.getComponentByName("WallComponent3D").get3DWallFrom2D(t), i && this.addSubSlope(h, i, a[o], t, e, n);
        h = this.core.getComponentByName("WallComponent3D").get3DWallFrom2D(t), h.parent = e, ujs.notify("wnp.engine3d.subslopesReady", {floor: e,structure: t,walls: h})
    }, e
}(), StairwayStructure = function() {
    var t = function() {
        BaseStructure.call(this, "StairwayStructure"), this.points = [], this.type = "straight", this.width = 90, this.height = 250, this.stair_height = 20, this.stair_thickness = 3, this.stair_width = 25, this.rail_a = !0, this.rail_b = !0, this.limon = -1, this.stick_spacement = 20, this.have_contremarche = !0, this.elevation = 0, this.diameter = 6, this.bearing = !0, this.stair_offset = 3, this.materials = void 0, this.room = null, this.orientation = !0
    };
    return t.prototype = new BaseStructure, t.prototype.isTargeted = function() {
        return !1
    }, t.prototype.draw = function() {
        return !1
    }, t.prototype.isValid = function() {
        return !0
    }, t.serialize = function(t) {
        for (var e = [], n = 0, i = t.length; i > n; n++)
            e.push(t[n].serialize());
        return e
    }, t.deserialize = function(t) {
        for (var e = [], n = 0, i = t.length; i > n; n++) {
            if ("spiral" == t[n].type)
                var o = new SpiralStairwayStructure;
            else
                var o = new StraightStairwayStructure;
            o.deserialize(t[n]), o.isValid() !== !1 && e.push(o)
        }
        return e
    }, t.prototype.serialize = function() {
        var t = {"class": {name: "StraightStairwayStructure"}};
        return ujs.serializeObject(this, t, ["id", "type", "name", "width", "height", "stair_offset", "stair_thickness", "is_closed", "rail_b", "rail_a", "have_contremarche", "elevation", "z", "area", "points", "bearing", "diameter", "limon", "orientation", "materials"]), t
    }, t.prototype.deserialize = function(t) {
        this.id = t.id, this.type = t.type || "straight", this.name = t.name, this.width = t.width || 90, this.height = t.height || 250, this.z = t.z || 0, this.is_closed = t.is_closed, this.area = t.area, this.points.length = 0, this.have_contremarche = t.have_contremarche, this.elevation = t.elevation, this.rail_a = t.rail_a, this.rail_b = t.rail_b, this.stair_offset = "undefined" != typeof t.stair_offset ? t.stair_offset : 3, this.materials = t.materials || {}, this.bearing = "undefined" == typeof t.bearing ? !0 : t.bearing, this.diameter = "undefined" == typeof t.diameter ? 6 : t.diameter, this.stair_thickness = "undefined" == typeof t.stair_thickness ? 3 : t.stair_thickness, this.limon = "undefined" == typeof t.limon ? 10 : t.limon, this.orientation = "undefined" == typeof t.orientation ? !0 : t.orientation;
        for (var e = 0, n = t.points.length; n > e; e++)
            this.points.push(new BABYLON.Vector3(t.points[e].x, t.points[e].y, t.points[e].z))
    }, t.prototype.getHopperPoints = function() {
        for (var t = -1 / 0, e = -1 / 0, n = 1 / 0, i = 1 / 0, o = [], r = 0; r < this.points.length - 1; r++)
            o = o.concat(this.getStepBoundPoints(r));
        for (var r = 0; r < o.length; r++) {
            var s = o[r];
            s.x > t && (t = s.x), s.x < n && (n = s.x), s.y > e && (e = s.y), s.y < i && (i = s.y)
        }
        return [new BABYLON.Vector2(t, e), new BABYLON.Vector2(n, e), new BABYLON.Vector2(n, i), new BABYLON.Vector2(t, i)]
    }, t.prototype.getStepBoundPoints = function(t) {
        var e = this.points[t], n = this.points[t + 1];
        t + 2 < this.points.length && (n = n.clone().add(n.clone().subtractInPlace(e.clone()).normalize().scaleInPlace(this.width / 2))), t > 0 && (e = e.clone().add(n.clone().subtractInPlace(e.clone()).normalize().scaleInPlace(this.width / 2)));
        var i = new BABYLON.Vector3(e.y - n.y, n.x - e.x, 0).normalize(), o = e.clone().add(i.clone().scaleInPlace(this.width / 2)), r = e.clone().subtractInPlace(i.clone().scaleInPlace(this.width / 2)), s = n.clone().subtractInPlace(i.clone().scaleInPlace(this.width / 2)), a = n.clone().add(i.clone().scaleInPlace(this.width / 2));
        return [o, r, s, a]
    }, t.prototype.getNormalAtPoint = function(t) {
        var e = this.points[t - 1].clone(), n = this.points[t].clone(), i = new BABYLON.Vector3(e.y - n.y, n.x - e.x, 0);
        return i.normalize(), i
    }, t.prototype.remove = function(t) {
        t.removeElement("stairways", this)
    }, t.prototype.addMaterial = function(t, e, n) {
        this.materials[e.name] = n, t.traverse(function(t) {
            t.name == e.name && t != e && (t.material = e.material.clone())
        })
    }, t.prototype.getAvailableProperties = function() {
        var t = [];
        return t.push({name: "width",label: _("Width"),type: "number",cast: "int",unit: "cm",value: {min: 3,max: 100,step: 1,value: this.width}}), t.push({name: "rail_a",label: _("Right guard-rail"),type: "checkbox",value: this.rail_a}), t.push({name: "rail_b",label: _("Left guard-rail"),type: "checkbox",value: this.rail_b}), t.push({name: "have_contremarche",label: _("riser"),type: "checkbox",value: this.have_contremarche}), t
    }, t
}(), StraightStairwayStructure = function() {
    var t = function() {
        StairwayStructure.call(this), this.type = "straight", this._steps = []
    };
    return t.prototype = new StairwayStructure, t.prototype.isValid = function() {
        return this.points.length <= 1 ? !1 : !0
    }, t.prototype.isTargeted = function(t) {
        for (var e, n = !1, i = !1, o = !1, r = 0; r < this.points.length; r++)
            e = this.getBoundPoints(r), this.isInPoly(t, e) && (n = r, o = !0), this.points[r].distanceTo(t) < 10 && (i = r, o = !0);
        return o ? {point: i,step: n} : !1
    }, t.prototype.draw = function(t, e) {
        e && this.points.push(e), this.computeSteps(), e && this.points.pop(e);
        for (var n = 0; n < this._steps.length; n++)
            this.drawStep(t, this._steps[n])
    }, t.prototype.serialize = function() {
        var t = {"class": {name: "StraightStairwayStructure"}};
        return ujs.serializeObject(this, t, ["id", "type", "name", "width", "height", "stair_offset", "stair_thickness", "is_closed", "rail_b", "rail_a", "have_contremarche", "elevation", "z", "area", "points", "bearing", "diameter", "limon", "orientation", "materials"]), t
    }, t.Deserialize = function(t) {
        var e = new StraightStairwayStructure;
        return ujs.deserializeObject(t, e, ["id", "type", "name", "width", "height", "stair_offset", "stair_thickness", "is_closed", "rail_b", "rail_a", "have_contremarche", "elevation", "z", "area", "points", "bearing", "diameter", "limon", "orientation", "materials"]), e.computeSteps(), e
    }, t.prototype.computeSteps = function() {
        this._steps.length = 0;
        for (var t, e, n, i, o = 0; o < this.points.length - 1; o++) {
            e = this.getBoundPoints(o - 1), n = this.getBoundPoints(o), i = this.getBoundPoints(o + 1);
            var r = n[0].clone(), s = n[1].clone(), a = n[2].clone(), l = n[3].clone(), h = this.points[o].clone(), c = this.points[o + 1].clone(), u = null, p = null, d = null, m = null, g = null, f = null;
            i && (ia1 = BABYLON.Vector2.Intersect(n[0], n[3], i[0], i[3]), "undefined" != typeof ia1 && (l.x = ia1.x, l.y = ia1.y), ib1 = BABYLON.Vector2.Intersect(n[1], n[2], i[1], i[2]), "undefined" != typeof ib1 && (a.x = ib1.x, a.y = ib1.y), h.distanceTo(l) > h.distanceTo(a) ? (c = h.add(a.subtract(h).projectOnVector(c.subtract(h))), m = a.clone(), p = c.add(c.subtract(a)), g = l.clone()) : (c = h.add(l.subtract(h).projectOnVector(c.subtract(h))), m = l.clone(), p = c.add(c.subtract(l)), g = a.clone())), e && (ia0 = BABYLON.Vector2.Intersect(n[0], n[3], e[0], e[3]), "undefined" != typeof ia0 && (r.x = ia0.x, r.y = ia0.y), ib0 = BABYLON.Vector2.Intersect(n[1], n[2], e[1], e[2]), "undefined" != typeof ib0 && (s.x = ib0.x, s.y = ib0.y), c.distanceTo(r) > c.distanceTo(s) ? (h = c.add(s.subtract(c).projectOnVector(h.subtract(c))), d = s.clone(), u = h.add(h.subtract(s)), f = r.clone()) : (h = c.add(r.subtract(c).projectOnVector(h.subtract(c))), d = r.clone(), u = h.add(h.subtract(r)), f = s.clone())), t = {id: o,boundPolygon: n,areaPolygon: [r, s, a, l],stairsSegment: [h, c],bearingPolygon0: [d, u, f],bearingPolygon1: [m, p, g]}, this._steps.push(t)
        }
    }, t.prototype.getBoundPoints = function(t) {
        if (this.points[t] && this.points[t + 1]) {
            var e = this.points[t + 1].subtract(this.points[t]).normalize(), n = new BABYLON.Vector3(e.y, -e.x, 0).scaleInPlace(this.width / 2), i = this.points[t].add(n), o = this.points[t + 1].add(n), r = this.points[t + 1].subtract(n), s = this.points[t].subtract(n);
            return [i, s, r, o]
        }
        return !1
    }, t.prototype.drawStepBearing = function(t, e, n) {
        var n = n || 0;
        if (!this.bearing && e[0]) {
            var i, o = e[1].distanceTo(e[2]), r = 25, s = Math.floor(o / r);
            t.beginPath();
            for (var a = 1; s - n >= a; a++)
                i = e[1].clone().lerp(e[2], 1 / s * a), t.moveTo(e[0].x, e[0].y), t.lineTo(i.x, i.y);
            t.stroke()
        }
    }, t.prototype.drawStep = function(t, e) {
        var n = e.areaPolygon, i = n[3].subtract(n[0]).normalize(), o = new BABYLON.Vector3(i.y, -i.x, 0).scaleInPlace(10), r = n[0].add(o), s = n[3].add(o), a = Math.round(r.distanceTo(s)) / 100;
        if (a > .5 && wanaplan.engine2D.symbols2D.drawMeasure(t, r, s, a + "m", "#cccccc"), this.points.length > 2) {
            var l = n[1].subtract(o), h = n[2].subtract(o), c = Math.round(l.distanceTo(h)) / 100;
            c > .5 && wanaplan.engine2D.symbols2D.drawMeasure(t, l, h, c + "m", "#cccccc")
        }
        t.beginPath(), t.moveTo(n[0].x, n[0].y), t.lineTo(n[3].x, n[3].y), t.moveTo(n[1].x, n[1].y), t.lineTo(n[2].x, n[2].y), t.stroke(), this.drawStepStairs(t, e.stairsSegment), this.drawStepBearing(t, e.bearingPolygon0, 1), this.drawStepBearing(t, e.bearingPolygon1)
    }, t.prototype.drawStepStairs = function(t, e) {
        var n = e[0].clone(), i = e[1], o = i.subtract(n).normalize(), r = new BABYLON.Vector3(o.y, -o.x, 0).scaleInPlace(this.width / 2), s = n.distanceTo(i), a = 20, l = Math.floor(s / a), h = s / l, c = Math.atan2(o.y, o.x);
        wanaplan.engine2D.symbols2D.drawArrows(t, n, [0, 1, 0, 0], 0, c, !1, {size: 10}), wanaplan.engine2D.symbols2D.drawArrows(t, i, [0, 1, 0, 0], -10, c, !1, {size: 10});
        var u = o.scale(h);
        t.beginPath();
        for (var p, d, m = 0; l >= m; m++)
            p = n.add(r), d = n.subtract(r), t.moveTo(p.x, p.y), t.lineTo(d.x, d.y), n.addInPlace(u);
        t.stroke()
    }, t.prototype.isInPoly = function(t, e) {
        var n, i, o = 0;
        for (n = 0, i = e.length - 1; n < e.length; i = n++)
            e[n].y > t.y != e[i].y > t.y && t.x < (e[i].x - e[n].x) * (t.y - e[n].y) / (e[i].y - e[n].y) + e[n].x && (o = !o);
        return o
    }, t
}(), SpiralStairwayStructure = function() {
    var t = function() {
        StairwayStructure.call(this), this.type = "spiral"
    };
    return t.prototype = new StairwayStructure, t.prototype.serialize = function() {
        var t = {"class": {name: "SpiralStairwayStructure"}};
        return ujs.serializeObject(this, t, ["id", "type", "name", "width", "height", "stair_offset", "stair_thickness", "is_closed", "rail_b", "rail_a", "have_contremarche", "z", "area", "points", "bearing", "diameter", "limon", "orientation", "materials"]), t
    }, t.Deserialize = function(t) {
        var e = new SpiralStairwayStructure;
        return ujs.deserializeObject(t, e, ["id", "type", "name", "width", "height", "stair_offset", "stair_thickness", "is_closed", "rail_b", "rail_a", "have_contremarche", "z", "area", "points", "bearing", "diameter", "limon", "orientation", "materials"]), e
    }, t.prototype.computeSpiralPoints = function() {
        var t = 0, e = -Math.PI / 2, n = this.points[0], i = new BABYLON.Vector3(this.width * Math.cos(t), this.width * Math.sin(t), 0), o = new BABYLON.Vector3(this.width * Math.cos(e), this.width * Math.sin(e), 0);
        this.points[1] = n.clone().add(i), this.points[2] = n.clone().add(o)
    }, t.prototype.isTargeted = function(t) {
        var e = !1, n = 0;
        if (t.distanceTo(this.points[0]) < this.width && (e = !0), this.points[1] && this.points[0]) {
            var i = t.distanceTo(this.points[1]), o = t.distanceTo(this.points[2]);
            10 > i ? (n = 1, e = !0) : 10 > o && (e = !0, n = 2)
        }
        return e ? {point: n} : !1
    }, t.prototype.getHopperPoints = function() {
        var t = this.points[0].clone(), e = t.clone();
        e.y -= this.width;
        var n = e.clone();
        n.x -= this.width;
        var i = n.clone();
        i.y += 2 * this.width;
        var o = i.clone();
        o.x += 2 * this.width;
        var r = o.clone();
        return r.y -= this.width, [t, e, n, i, o, r]
    }, t.prototype.draw = function(t, e) {
        var n = this.points[0] || e, i = this.points[1] || e.clone().add(new BABYLON.Vector3(this.width, 0, 0)), o = this.points[2] || i.clone(), r = this.width, s = Math.atan2(i.y - n.y, i.x - n.x), a = Math.atan2(o.y - n.y, o.x - n.x);
        s == a && (a = 2 * Math.PI), t.beginPath();
        this.orientation ? 1 : -1;
        this.orientation ? t.arc(n.x, n.y, r, s, a, !1) : t.arc(n.x, n.y, r, a, s, !1), t.moveTo(n.x, n.y), t.lineTo(i.x, i.y), t.moveTo(n.x, n.y), t.lineTo(o.x, o.y), t.stroke();
        var l = [0, 0, 1, 0];
        this.orientation || (l = [1, 0, 0, 0]), wanaplan.engine2D.symbols2D.drawArrows(t, n.clone().lerp(i, .5), l, 0, s, !1, {size: 10}), wanaplan.engine2D.symbols2D.drawArrows(t, n.clone().lerp(o, .5), l, -10, a, !1, {size: 10}), t.save(), t.beginPath(), this.orientation ? t.arc(n.x, n.y, r, a, s, !1) : t.arc(n.x, n.y, r, s, a, !1), t.strokeStyle = "#eeeeee";
        for (var h, c = 0; 10 >= c; c++)
            h = 15 * c / 80 * Math.PI, t.moveTo(n.x, n.y), p2x = n.x + Math.cos(h) * r, p2y = n.y + Math.sin(h) * r, t.lineTo(p2x, p2y);
        t.stroke(), t.restore(), t.save(), t.fillStyle = "#ffffff", t.beginPath(), t.arc(n.x, n.y, this.diameter, 0, 2 * Math.PI, !1), t.stroke(), t.fill(), t.restore()
    }, t
}(), StairwayComponent2D = function() {
    var t = null, e = function(e) {
        BaseComponent2D.call(this, e, "StairwayComponent2D"), this.priority = 50, this._tmpStairway = !1, this._tmpPoint = null, this._targetedAt = null, this._targetedAtPoint = null, this._SIZE = 13, t = this, this.onFloorAdded = this.onFloorAdded.bind(this), document.addEventListener("wnp.request.floorAdded", this.onFloorAdded), document.addEventListener("wnp.core.structure.loaded", this.onStructureLoaded.bind(this))
    };
    return e.prototype = new BaseComponent2D, e.prototype.startListening = function() {
        this.onAddStairway = this.onAddStairway.bind(this), document.addEventListener("wnp.engine2d.onAddStairway", this.onAddStairway, !1), this.core.engine2D.registerEventCb("StairwayComponent2D.stair.static-draw", this.priority, "static-draw", null, null, this.onStaticDraw.bind(this), {}), this.core.engine2D.registerEventCb("StairwayComponent2D.stair.hover", this.priority, "hover", this.core.engine2D.MODE_NORMAL | this.core.engine2D.MODE_DRAG | this.core.engine2D.MODE_CONTEXTMENU, StairwayStructure, this.onHover.bind(this), {}), this.core.engine2D.registerEventCb("StairwayComponent2D.stair.leave", this.priority, "leave", this.core.engine2D.MODE_NORMAL | this.core.engine2D.MODE_CONTEXTMENU, StairwayStructure, this.onLeave.bind(this), {}), this.core.engine2D.registerEventCb("StairwayComponent2D.stair.click", this.priority, "click", this.core.engine2D.MODE_NORMAL, StairwayStructure, this.onContextMenu.bind(this), {}), this.core.engine2D.registerEventCb("StairwayComponent2D.stair.dblclick", this.priority, "double-click", this.core.engine2D.MODE_NORMAL, StairwayStructure, this.onDoubleClick.bind(this), {})
    }, e.prototype.stopListening = function() {
        document.removeEventListener("wnp.engine2d.onAddStairway", this.onAddStairway, !1), this.core.engine2D.unregisterEventCb("StairwayComponent2D.stair.static-draw"), this.core.engine2D.unregisterEventCb("StairwayComponent2D.stair.hover"), this.core.engine2D.unregisterEventCb("StairwayComponent2D.stair.leave"), this.core.engine2D.unregisterEventCb("StairwayComponent2D.stair.click"), this.core.engine2D.unregisterEventCb("StairwayComponent2D.stair.dblclick")
    }, e.prototype.onStructureLoaded = function() {
        for (var t, e = 0; e < this.structure.members.length; e++) {
            t = this.structure.members[e];
            for (var n = t.stairways.length - 1; n >= 0; n--)
                t.stairways[n] instanceof StairwayStructure || t.stairways.splice(n, 1)
        }
    }, e.prototype.onFloorAdded = function(t) {
        var e = t.id, n = this.structure.getElement(+e), i = this.structure.getElement(+e - 1), o = t.callback || function() {
        };
        if (i)
            for (var r = i.getElements("stairways"), s = 0; s < r.length; s++) {
                var a = new HopperStructure;
                a.points = r[s].getHopperPoints(), a.stairwayId = r[s].id, n.insertElement("hoppers", a)
            }
        o.call(this)
    }, e.prototype.onLeave = function() {
        this.core.engine2D.unregisterEventCb("StairwayComponent2D.stair-hover.dynamic-draw"), this.core.engine2D.unregisterEventCb("StairwayComponent2D.stair.drag-start"), this.core.engine2D.requestDynamicDraw()
    }, e.prototype.onHoverStair = function(t, e, n, i) {
        t.strokeStyle = this.core.engine2D.symbols2D.COLOR_ACTIVE_STROKE_DARKER, this.draw(i, t, e, n), this.drawTarget(i, t, e, n)
    }, e.prototype.onHoverStairMouseMove = function(t, e, n) {
        var i = e.isTargeted(n.planPos);
        e.targeted = i, this.core.engine2D.requestDynamicDraw()
    }, e.prototype.onHover = function(t, e) {
        return (this.core.engine2D.getMode() & (this.core.engine2D.MODE_DRAW | this.core.engine2D.MODE_SUBSLOPE)) > 0 ? !1 : (this.core.engine2D.registerEventCb("StairwayComponent2D.stair-hover.mouse-move", this.priority, "mouse-move", null, StairwayStructure, this.onHoverStairMouseMove.bind(this), e), this.core.engine2D.registerEventCb("StairwayComponent2D.stair-hover.dynamic-draw", this.priority, "dynamic-draw", null, StairwayStructure, this.onHoverStair.bind(this), e), this.core.engine2D.registerEventCb("StairwayComponent2D.stair.drag-start", this.priority, "drag-start", this.core.engine2D.MODE_NORMAL, StairwayStructure, this.onDragStart.bind(this), {}), this.core.engine2D.requestDynamicDraw(), !1)
    }, e.prototype.onDragEnd = function(t, e, n, i) {
        this._targetedAtPoint = !1, this._targetedAt = !1;
        for (var o = 0; o < i.points.length - 1; o++)
            "spiral" != i.type && i.points[o].distanceTo(i.points[o + 1]) < i.width / 2 && (i.points.splice(o + 1, i.points.length), this.core.engine2D.requestStaticDraw(), this.core.engine2D.requestDynamicDraw());
        var r = this.core.getSelectedStructure();
        if (topStructure = this.structure.getElement(+r.id + 1)) {
            var s = null;
            if (s = topStructure.getElementByIdentifier(i.id, "hoppers", "stairwayId"))
                0 == s.modified && (s.points = i.getHopperPoints());
            else {
                var s = new HopperStructure;
                s.points = i.getHopperPoints(), s.stairwayId = i.id, topStructure.insertElement("hoppers", s)
            }
        }
    }, e.prototype.onDrawDragging = function(t, e, n, i) {
        return this.onMouseMove(t, e, n, i), !1
    }, e.prototype.onDrawDragStart = function(t, e, n, i) {
        0 == this._tmpStairway.points.length && this.onAddStairwayClick(t, e, n, i), this.core.engine2D.registerEventCb("StairwayComponent2D.stair-draw.drag", this.priority, "dragging", null, null, this.onDrawDragging.bind(this), e), this.core.engine2D.registerEventCb("StairwayComponent2D.stair-draw.drag-end", this.priority, "drag-end", null, null, this.onAddStairwayClick.bind(this), e)
    }, e.prototype.onDragStart = function(t, e) {
        this.core.engine2D.registerEventCb("StairwayComponent2D.stair-hover.drag", this.priority, "dragging", null, null, this.onDragStair.bind(this), e), this.core.engine2D.registerEventCb("StairwayComponent2D.stair-hover.drag-end", this.priority, "drag-end", null, null, this.onDragEnd.bind(this), e)
    }, e.prototype.onDragStairSpiral = function(t, e, n, i) {
        var o = n.posDelta.clone().scaleInPlace(1 / this.core.engine2D.getZoom());
        if (i.targeted.point > 0) {
            var r = n.planPos.clone(), s = i.points[0], a = s.clone().add(new BABYLON.Vector3(i.width, 0, 0)), l = s.clone().add(new BABYLON.Vector3(-i.width, 0, 0)), h = s.clone().add(new BABYLON.Vector3(0, i.width, 0)), c = s.clone().add(new BABYLON.Vector3(0, -i.width, 0)), u = s.clone().add(r.clone().subtractInPlace(s).normalize().scaleInPlace(i.width));
            i.points[i.targeted.point] = u.distanceTo(a) < 20 ? a : u.distanceTo(l) < 20 ? l : u.distanceTo(h) < 20 ? h : u.distanceTo(c) < 20 ? c : u
        } else
            for (var p = 0; p < i.points.length; p++)
                i.points[p].addInPlace(o);
        return this.core.engine2D.requestStaticDraw(), !1
    }, e.prototype.onDragStair = function(t, e, n, i) {
        if ("spiral" == i.type)
            return this.onDragStairSpiral(t, e, n, i), !1;
        {
            var o = i.targeted.step, r = i.points[o], s = i.points[o + 1], a = n.posDelta.clone().scaleInPlace(1 / this.core.engine2D.getZoom());
            this.core.getComponentByName("RoomComponent2D")
        }
        if (i.targeted.point !== !1 && -1 === [0, i.points.length - 1].indexOf(+i.targeted.point))
            for (var l = 0; l < i.points.length; l++)
                i.points[l].addInPlace(a);
        else if (i.targeted.point !== !1 && -1 !== [0, i.points.length - 1].indexOf(+i.targeted.point))
            i.points[i.targeted.point].addInPlace(a);
        else if (o !== !1)
            if (i.points.length > 2) {
                var h = new BABYLON.Vector3(r.y - s.y, s.x - r.x, 0).normalize();
                a.projectOnVector(h), r.addInPlace(a), s.addInPlace(a)
            } else
                for (var l = 0; l < i.points.length; l++)
                    i.points[l].addInPlace(a);
        return this.core.engine2D.requestStaticDraw(), !1
    }, e.prototype.getTargeted = function(t) {
        for (var e = this.core.getSelectedStructure(), n = e.getElements("stairways"), i = 0; i < n.length; i++) {
            var o = n[i];
            if (!(this.core.engine2D.getMode() & this.core.engine2D.MODE_DRAG) && o.isTargeted(t))
                return o
        }
        return null
    }, e.prototype.initialize = function() {
        _item = {title: _("Stairway"),id: "stairways",items: [{title: _("Winder Stairs"),action: "wnp.engine2d.onAddStairway",params: {stairwayType: "straight",bearing: !1}}, {title: _("Landing Stairs"),action: "wnp.engine2d.onAddStairway",params: {stairwayType: "straight",bearing: !0}}, {title: _("Hanging"),action: "wnp.engine2d.onAddStairway",params: {stairwayType: "straight",bearing: !1,have_contremarche: !1,limon: 0,rail_a: !1,rail_b: 0,stair_offset: 0}}, {title: _("Spiral"),action: "wnp.engine2d.onAddStairway",params: {stairwayType: "spiral"}}]}, ujs.notify("wnp.menu.main.add", {item: _item,menuPath: "draw2D",position: 5})
    }, e.prototype.onAddStairway = function(t) {
        this._tmpStairway = "spiral" == t.stairwayType ? new SpiralStairwayStructure : new StraightStairwayStructure, this._tmpStairway.height = this.core.getSelectedStructure().height;
        for (var e in this._tmpStairway)
            this._tmpStairway.hasOwnProperty(e) && "undefined" != typeof t[e] && "type" != e && (this._tmpStairway[e] = t[e]);
        this._tmpPoint = null, this.core.helpBubbleManager.display("wnp.2d.draw-staires"), this.core.engine2D.setMode(wanaplan.engine2D.MODE_DRAW), this.core.engine2D.registerEventCb("StairwayComponent2D.add-stair.click", this.priority, "click", this.core.engine2D.MODE_DRAW, null, this.onAddStairwayClick.bind(this), {}), this.core.engine2D.registerEventCb("StairwayComponent2D.dynamic-stair.mouse-move", this.priority, "mouse-move", this.core.engine2D.MODE_DRAW, null, this.onMouseMove.bind(this), {}), this.core.engine2D.registerEventCb("StairwayComponent2D.dynamic-stair.dynamic-draw", this.priority, "dynamic-draw", this.core.engine2D.MODE_DRAW, null, this.onDynamicDraw.bind(this), {}), this.core.engine2D.registerEventCb("StairwayComponent2D.stair.drag-start-draw", this.priority, "drag-start", this.core.engine2D.MODE_DRAW, null, this.onDrawDragStart.bind(this), {})
    }, e.prototype.onDoubleClick = function(t, e) {
        e.targeted && e.targeted.point == e.points.length - 1 && (this.onAddStairway({}), this._tmpStairway = e, this.core.engine2D.setMode(this.core.engine2D.MODE_DRAW))
    }, e.prototype.finalizeTmpStairway = function() {
        var t = this.core.getSelectedStructure();
        if (this._tmpStairway.isValid()) {
            t.insertElement("stairways", this._tmpStairway);
            var e = !1;
            if (e = this.structure.getElement(+t.id + 1)) {
                var n = new HopperStructure;
                n.points = this._tmpStairway.getHopperPoints(), n.stairwayId = this._tmpStairway.id, e.insertElement("hoppers", n)
            }
        }
        this._tmpStairway = new StairwayStructure, this._tmpPoint = null, this.core.engine2D.requestStaticDraw(), this.core.engine2D.setMode(this.core.engine2D.MODE_NORMAL), ujs.notify("wnp.menu.main.deselect")
    }, e.prototype.onAddStairwayClick = function(t, e, n, i) {
        if ("touchUp" == t.type && this.onDrawDragging(t, e, n, i), 0 == this._tmpStairway.points.length || this._tmpPoint) {
            if (this._tmpPoint = this._tmpPoint || n.planPos, this._tmpPoint = this._tmpPoint || n.planPos, this._tmpStairway.points.push(this._tmpPoint.clone()), 1 == this._tmpStairway.points.length) {
                var o = this.core.getComponentByName("RoomComponent2D");
                this._tmpStairway.room = o.isPointInRooms(this._tmpPoint)
            }
            "spiral" == this._tmpStairway.type && (this._tmpStairway.computeSpiralPoints(), this.finalizeTmpStairway()), this._tmpPoint = !1
        } else
            this.finalizeTmpStairway()
    }, e.prototype.onMouseMove = function(t, e, n) {
        if (0 != !this._tmpStairway.points.length || this._tmpPoint || this.core.engine2D.setCursorIcon(this.core.engine2D.symbols2D.drawCursorCheck.bind(this.core.engine2D.symbols2D)), this._tmpStairway.points.length < 2)
            this._tmpPoint = n.planPos.clone();
        else {
            var i = this._tmpStairway.points;
            if (i[i.length - 1].distanceTo(n.planPos) < this._tmpStairway.width / 2)
                return void (this._tmpPoint = null);
            var o = new BABYLON.Ray(i[i.length - 1], this._tmpStairway.getNormalAtPoint(i.length - 1)), r = o.closestPointToPoint(n.planPos);
            this._tmpPoint = r.distanceTo(n.planPos) > 20 ? n.planPos.clone() : r
        }
    }, e.prototype._getMagneticRays = function(t, e) {
        var n = [];
        if (e.room) {
            for (var i = 0; i < e.room.points.length - 1; i++) {
                var o = e.room.points[i], r = e.room.points[i + 1];
                n.push(new BABYLON.Ray(t, o.clone().subtractInPlace(r.clone()).normalize()))
            }
            var o = e.room.points[i], r = e.room.points[0];
            n.push(new BABYLON.Ray(t, o.clone().subtractInPlace(r.clone()).normalize()))
        } else
            n.push(new BABYLON.Ray(t, new BABYLON.Vector3(0, 1, 0))), n.push(new BABYLON.Ray(t, new BABYLON.Vector3(1, 0, 0)));
        return n
    }, e.prototype.onStaticDraw = function(t, e, n) {
        for (var i = this.core.getSelectedStructure(), o = i.getElements("stairways"), r = 0; r < o.length; r++)
            this.draw(o[r], t, e, n);
        var s = !1;
        if (s = this.structure.getElement(+i.id - 1))
            for (var a = s.getElements("stairways"), r = 0; r < a.length; r++)
                t.save(), t.strokeStyle = "#eeeeee", this.draw(a[r], t, e, n), t.restore()
    }, e.prototype.onDynamicDraw = function(t, e, n) {
        this.draw(this._tmpStairway, t, e, n, this._tmpPoint), t.save(), t.fillStyle = "rgba(60,82,129,0.8)";
        var i = this._tmpStairway;
        if (1 == i.points.length) {
            var o = this.core.engine2D.toRealCoord(i.points[0], e, n);
            if (this._tmpPoint) {
                var r = Math.atan2(this._tmpPoint.y - i.points[0].y, this._tmpPoint.x - i.points[0].x);
                this.core.engine2D.symbols2D.drawGrip(t, o, [!1, !0, !1, !1], r)
            } else
                this.core.engine2D.symbols2D.drawGrip(t, o, [!0, !0, !0, !0])
        } else if (i.points.length > 1) {
            var s = i.points[i.points.length - 1], a = i.points[i.points.length - 2], r = Math.atan2(s.y - a.y, s.x - a.x), o = this.core.engine2D.toRealCoord(s, e, n);
            this.core.engine2D.symbols2D.drawCheckGrip(t, o, [!0, !1, !0, !1], r)
        }
        t.restore()
    }, e.prototype.onContextMenu = function(t, e) {
        var n = [];
        n.push({name: "width",label: _("Width"),type: "slider",cast: "int",unit: "cm",value: {min: 40,max: 300,step: 1,value: e.width}}), n.push({name: "height",label: _("Height"),type: "slider",cast: "int",unit: "cm",value: {min: 20,max: 500,step: 1,value: e.height}}), n.push({name: "elevation",label: _("Elevation"),type: "slider",cast: "int",unit: "cm",value: {min: 0,max: 250,step: 1,value: e.elevation}}), n.push({name: "stair_offset",label: _("Stair Offset"),type: "slider",cast: "int",unit: "cm",value: {min: 0,max: 10,step: 1,value: e.stair_offset}}), n.push({name: "stair_thickness",label: _("Stair thickness"),type: "slider",cast: "int",unit: "cm",value: {min: 0,max: 50,step: 1,value: e.stair_thickness}}), n.push({name: "have_contremarche",label: _("riser"),type: "checkbox",value: e.have_contremarche}), "straight" == e.type ? (n.push({name: "bearing",label: _("bearing"),type: "checkbox",value: e.bearing}), n.push({name: "rail_a",label: _("Right guard-rail"),type: "checkbox",value: e.rail_a}), n.push({name: "rail_b",label: _("Left guard-rail"),type: "checkbox",value: e.rail_b}), n.push({name: "limon",label: _("Limon (-1 => default)"),type: "text",value: e.limon})) : "spiral" == e.type && (n.push({name: "rail_a",label: _("Guard-rail"),type: "checkbox",value: e.rail_a}), n.push({name: "diameter",label: _("Core diameter"),type: "slider",cast: "int",unit: "cm",value: {min: 1,max: 40,step: 1,value: e.diameter}}), n.push({name: "orientation",label: _("Orientation (clockwise)"),type: "checkbox",value: e.orientation})), this.core.engine2D.displayContextMenu(n, e, this.onContextMenuPropertyChanged.bind(this), this.onContextMenuRemove.bind(this))
    }, e.prototype.onContextMenuPropertyChanged = function(t, e, n) {
        t[e] = n, this.core.engine2D.requestStaticDraw()
    }, e.prototype.onContextMenuRemove = function(t) {
        var e = this.core.getSelectedStructure();
        if (topStructure = this.structure.getElement(+e.id + 1)) {
            var n = topStructure.getElementByIdentifier(t.id, "hoppers", "stairwayId");
            n && n.remove(topStructure)
        }
        t.remove(e)
    }, e.prototype.draw = function(t, e, n, i, o) {
        e.save(), e.translate(n.x, n.y), e.scale(i, i), t.draw(e, o), e.restore()
    }, e.prototype.drawTargetSpiral = function(t, e) {
        if (t.targeted && t.targeted.point > 0)
            this.core.engine2D.symbols2D.drawPointHover(e, this.core.engine2D.toRealCoord(t.points[t.targeted.point]));
        else {
            var n = this.core.engine2D.toRealCoord(t.points[0]);
            n.x = Math.round(n.x) + .5, n.y = Math.round(n.y) + .5, this.core.engine2D.symbols2D.drawGrip(e, n, [!0, !0, !0, !0]);
            for (var i = 1; i < t.points.length; i++)
                this.core.engine2D.symbols2D.drawPoint(e, this.core.engine2D.toRealCoord(t.points[i]))
        }
    }, e.prototype.drawTarget = function(t, e, n, i) {
        if (t) {
            if ("spiral" == t.type)
                return void this.drawTargetSpiral(t, e, n, i);
            if (t.targeted && t.targeted.point !== !1) {
                var o = this.core.engine2D.toRealCoord(t.points[t.targeted.point]);
                this.core.engine2D.symbols2D.drawGrip(e, o, [!0, !0, !0, !0])
            } else if (t.targeted && t.targeted.step !== !1) {
                {
                    var o = this.core.engine2D.toRealCoord(t.points[t.targeted.step]), r = this.core.engine2D.toRealCoord(t.points[t.targeted.step + 1]);
                    Math.atan2(r.y - o.y, r.x - o.x)
                }
                this.core.engine2D.symbols2D.drawSegment(e, o, r)
            }
        }
    }, e
}();
var StairwayComponent3D = function() {
    function t(t) {
        t.traverse(function(t) {
            wanaplan.engine3D.castShadows(t), t.receiveShadows = !0
        })
    }
    var e, n = function(t) {
        BaseComponent3D.call(this, t, "StairwayComponent3D"), this._scenes = [], this.priority = 1, e = this
    };
    return n.prototype = new BaseComponent3D, n.prototype.compute = function() {
    }, n.prototype.startListening = function() {
        document.addEventListener("wnp.engine3d.floorReady", this.onFloorReady, !1)
    }, n.prototype.stopListening = function() {
        document.removeEventListener("wnp.engine3d.floorReady", this.onFloorReady, !1)
    }, n.prototype.onFloorReady = function(t) {
        for (var n = t.floor || e.getFloor(), i = t.structure || e.core.getSelectedStructure(), o = 0; o < i.stairways.length; o++)
            e.createStairway(i.stairways[o], n, wanaplan.engine3D.scene)
    }, n.prototype.createScene = function() {
        for (var t = this.core.getComponentByName("FloorComponent3D"), e = 0; e < this.structure.getLength(); e++) {
            var n = this.structure.getElement(e);
            if (n instanceof FloorStructure)
                for (var i = t.getFloor(n), o = 0; o < n.stairways.length; o++)
                    this.createStairway(n.stairways[o], i, wanaplan.engine3D.scene)
        }
    }, n.prototype.initMaterials = function(t, e) {
        for (var n in e)
            t.traverse(function(t) {
                t.name === n && (t.material = e[n])
            })
    }, n.prototype.createStairway = function(e, n, i) {
        var o = (this.core.getComponentByName("ObjectComponent3D", this.core.ENGINE_3D), function(o) {
            var r = o.getObject3D(i);
            t(r), r.structure = e, r.structure.programmableInstance = o, r.name = "Stairway_" + e.id, r.isDecorable = !0, r.decorate = o.decorate, r.parent = n;
            var s = o.materials;
            o.getDefaultMaterials && (s = ujs.mergeObjects(o.getDefaultMaterials(wanaplan.engine3D.scene), s)), this.initMaterials(r, s), e.materials = s, o.materials = s
        }.bind(this)), r = e.programmableInstance ? e.programmableInstance.materials : e.materials;
        return "spiral" == e.type ? wnp.Programmable.createInstance("Stairs.Spiral.js", e, r, e, o) : wnp.Programmable.createInstance("Stairs.js", e, r, e, o), !0
    }, n
}();
HopperStructure = function() {
    var t = function(t) {
        BaseStructure.call(this, "HopperStructure"), this.points = t || [new BABYLON.Vector2(0, 0), new BABYLON.Vector2(100, 0), new BABYLON.Vector2(100, 100), new BABYLON.Vector2(0, 100)], this.materials = {}, this.sticks = {}, this.stairwayId = null, this.modified = !1
    };
    return t.prototype = new BaseStructure, t.prototype.serialize = function() {
        var t = {"class": {name: "HopperStructure"}};
        return ujs.serializeObject(this, t, ["points", "materials", "sticks", "stairwayId"]), t
    }, t.Deserialize = function(e) {
        var n = new t;
        return ujs.deserializeObject(e, n, ["points", "materials", "sticks", "stairwayId"]), n.isValid() ? n : null
    }, t.prototype.isValid = function() {
        if (this.points.length < 2)
            return Logger.warning("Invalid Hopper"), !1;
        for (var t, e = 0, n = this.points.length; n > e; e++)
            if (t = this.points[e].distanceTo(this.points[(e + 1) % n]), 1 / 0 == t || isNaN(t) || 0 === t)
                return Logger.warning("Invalid Hopper"), !1;
        return !0
    }, t.prototype.remove = function(t) {
        t.removeElement("hoppers", this)
    }, t.prototype.insertPointAt = function(t, e) {
        this.points.splice(t, 0, e)
    }, t.prototype.move = function(t) {
        for (var e = 0; e < this.points.length; e++)
            this.points[e].addInPlace(t)
    }, t
}(), HopperComponent2D = function() {
    var t = null, e = function(e) {
        BaseComponent2D.call(this, e, "HopperComponent2D"), this.priority = 80, this._tmpHopper = new HopperStructure, this._targetedAt = null, this._targetedAtSide = null, t = this
    };
    return e.prototype = new BaseComponent2D, e.prototype.startListening = function() {
        this.onAddHopper = this.onAddHopper.bind(this), document.addEventListener("wnp.engine2d.onAddHopper", this.onAddHopper, !1), wanaplan.engine2D.registerEventCb("HopperComponent2D.hopper.static-draw", this.priority, "static-draw", null, null, this.onStaticDraw.bind(this), {}), wanaplan.engine2D.registerEventCb("HopperComponent2D.hopper.hover", this.priority, "hover", wanaplan.engine2D.MODE_NORMAL | wanaplan.engine2D.MODE_DRAG | wanaplan.engine2D.MODE_CONTEXTMENU, HopperStructure, this.onHover.bind(this), {}), wanaplan.engine2D.registerEventCb("HopperComponent2D.hopper.leave", this.priority, "leave", wanaplan.engine2D.MODE_NORMAL | wanaplan.engine2D.MODE_CONTEXTMENU, HopperStructure, this.onLeave.bind(this), {}), wanaplan.engine2D.registerEventCb("HopperComponent2D.hopper.click", this.priority, "click", wanaplan.engine2D.MODE_NORMAL, HopperStructure, this.onContextMenu.bind(this), {}), wanaplan.engine2D.registerEventCb("HopperComponent2D.hopper.dblclick", this.priority, "double-click", wanaplan.engine2D.MODE_NORMAL, HopperStructure, this.onDblClick.bind(this), {})
    }, e.prototype.stopListening = function() {
        document.removeEventListener("wnp.engine2d.onAddHopper", this.onAddHopper, !1), wanaplan.engine2D.unregisterEventCb("HopperComponent2D.hopper.static-draw"), wanaplan.engine2D.unregisterEventCb("HopperComponent2D.hopper.hover"), wanaplan.engine2D.unregisterEventCb("HopperComponent2D.hopper.leave"), wanaplan.engine2D.unregisterEventCb("HopperComponent2D.hopper.click"), wanaplan.engine2D.unregisterEventCb("HopperComponent2D.hopper.dblclick")
    }, e.prototype.getTargeted = function(t) {
        for (var e = wanaplan.getSelectedStructure(), n = e.getElements("hoppers"), i = (wanaplan.engine2D.getZoom(), 0); i < n.length; i++) {
            if (!(wanaplan.engine2D.getMode() & wanaplan.engine2D.MODE_DRAG))
                for (var o = 0; o < n[i].points.length; o++) {
                    if (n[i].points[o].distanceTo(t) < 13)
                        return this._targetedAt = o, this._targetedAtSide = null, wanaplan.engine2D.requestDynamicDraw(), n[i];
                    var r = this.isPointInHopperSide(t, n[i]);
                    if (r !== !1)
                        return this._targetedAtSide = r, this._targetedAt = null, wanaplan.engine2D.requestDynamicDraw(), n[i]
                }
            if (this.isPointInHopper(t, n[i]))
                return wanaplan.engine2D.getMode() & wanaplan.engine2D.MODE_DRAG || (this._targetedAt = null, this._targetedAtSide = null, wanaplan.engine2D.requestDynamicDraw()), n[i]
        }
    }, e.prototype.onLeave = function() {
        wanaplan.engine2D.unregisterEventCb("HopperComponent2D.hopper-hover.dynamic-draw"), wanaplan.engine2D.unregisterEventCb("HopperComponent2D.hopper.drag-start"), wanaplan.engine2D.requestDynamicDraw()
    }, e.prototype.onHover = function(t, e) {
        return wanaplan.engine2D.registerEventCb("HopperComponent2D.hopper-hover.dynamic-draw", this.priority, "dynamic-draw", null, HopperStructure, this.onHoverHopper.bind(this), e), wanaplan.engine2D.registerEventCb("HopperComponent2D.hopper.drag-start", this.priority, "drag-start", wanaplan.engine2D.MODE_NORMAL, HopperStructure, this.onDragStart.bind(this), {}), wanaplan.engine2D.requestDynamicDraw(), !1
    }, e.prototype.onHoverHopper = function(t, e, n, i) {
        this.draw(i, t, e, n, !0), this.drawTarget(i, t, n)
    }, e.prototype.onDblClick = function(t, e, n) {
        if (e instanceof HopperStructure) {
            var i = this.isPointInHopperSide(n.planPos, e);
            if (i !== !1) {
                var o = e.points[i], r = i + 1 < e.points.length ? e.points[i + 1] : e.points[0], s = n.planPos.projectOnSegment(o, r);
                e.insertPointAt(i + 1, s), this._targetedAtSide = null, this._targetedAt = i + 1, wanaplan.engine2D.requestDynamicDraw()
            }
        }
    }, e.prototype.onDrag = function(t, e, n, i) {
        if (null !== this._targetedAt) {
            for (var o = n.planPos.clone(), r = 0; r < i.points.length; r++)
                r != this._targetedAt && (Math.abs(o.x - i.points[r].x) < 10 && (o.x = i.points[r].x), Math.abs(o.y - i.points[r].y) < 10 && (o.y = i.points[r].y));
            this.getRoom(i).isPointIn(o) && (i.points[this._targetedAt] = o)
        } else if (null !== this._targetedAtSide) {
            var s = n.posDelta.scale(1 / wanaplan.engine2D.getZoom()), a = i.points[this._targetedAtSide], l = this._targetedAtSide + 1 < i.points.length ? this._targetedAtSide + 1 : 0, h = i.points[l], c = new BABYLON.Vector2(a.y - h.y, h.x - a.x);
            s.projectOnVector(c), this.getRoom(i).isPointIn(i.points[this._targetedAtSide].add(s)) && this.getRoom(i).isPointIn(i.points[l].add(s)) && (i.points[this._targetedAtSide].addInPlace(s), i.points[l].addInPlace(s))
        } else {
            var s = n.posDelta.scale(1 / wanaplan.engine2D.getZoom());
            i.move(s)
        }
        return i.modified = !0, wanaplan.engine2D.requestStaticDraw(), !1
    }, e.prototype.compute = function() {
        for (var t = wanaplan.getSelectedStructure(), e = 0; e < t.getElements("hoppers").length; e++)
            this.computeHopper(t.getElements("hoppers")[e])
    }, e.prototype.computeHopper = function(t) {
        for (var e = t.points.length - 1; e >= 0; e--) {
            var n = e - 1 >= 0 ? e - 1 : t.points.length - 1;
            t.points[e].distanceTo(t.points[n]) < 2 && t.points.splice(e, 1)
        }
        t.points.length < 3 && (t.remove(wanaplan.getSelectedStructure()), wanaplan.engine2D.requestStaticDraw(), wanaplan.engine2D.requestDynamicDraw(), this._targetedAt = null, this._targetedAtSide = null)
    }, e.prototype.onDragEnd = function(t, e, n, i) {
        this.computeHopper(i)
    }, e.prototype.onDragStart = function(t, e) {
        this.getRoom(e, !0), wanaplan.engine2D.registerEventCb("hopperComponent2D.hopper.drag", this.priority, "dragging", null, null, this.onDrag.bind(this), e), wanaplan.engine2D.registerEventCb("hopperComponent2D.stair-hover.drag-end", this.priority, "drag-end", null, null, this.onDragEnd.bind(this), e)
    }, e.prototype.onAddHopper = function() {
        wanaplan.engine2D.setMode(wanaplan.engine2D.MODE_DRAW), wanaplan.engine2D.registerEventCb("hopperComponent2D.add-hopper.click", this.priority, "click", wanaplan.engine2D.MODE_DRAW, null, this.onAddHopperClick.bind(this), {}), wanaplan.engine2D.registerEventCb("hopperComponent2D.dynamic-stair.mouse-move", this.priority, "mouse-move", wanaplan.engine2D.MODE_DRAW, null, this.onMouseMove.bind(this), {}), wanaplan.engine2D.registerEventCb("hopperComponent2D.dynamic-stair.dynamic-draw", this.priority, "dynamic-draw", wanaplan.engine2D.MODE_DRAW, null, this.onDynamicDraw.bind(this), {})
    }, e.prototype.onAddHopperClick = function() {
        var t = wanaplan.getSelectedStructure();
        t.insertElement("hoppers", this._tmpHopper), this._tmpHopper = new HopperStructure, wanaplan.engine2D.requestStaticDraw(), wanaplan.engine2D.setMode(wanaplan.engine2D.MODE_NORMAL), ujs.notify("wnp.menu.main.deselect")
    }, e.prototype.onMouseMove = function(t, e, n) {
        var i = n.planPos.subtract(this._tmpHopper.points[0].clone());
        i.x -= 50, i.y -= 50, this._tmpHopper.move(i)
    }, e.prototype.onContextMenu = function(t, e) {
        var n = [];
        null !== this._targetedAtSide ? (n.push({name: "sticks_" + this._targetedAtSide,label: _("Enable the guard-rail on this side"),type: "checkbox",cast: "int",value: e.sticks[this._targetedAtSide]}), n.push({name: "cut",label: _("Add point"),type: "button",value: _("Add")})) : (n.push({name: "enable_sticks",label: _("Enable the guard-rail on all side"),type: "button",value: _("Enable")}), n.push({name: "disable_sticks",label: _("Disable the guard-rail on all side"),type: "button",value: _("Disable")})), wanaplan.engine2D.displayContextMenu(n, e, this.onContextMenuPropertyChanged.bind(this), this.onContextMenuRemove.bind(this))
    }, e.prototype.onContextMenuPropertyChanged = function(t, e, n) {
        if (-1 != e.indexOf("sticks_")) {
            var i = e.split("_");
            t.sticks[i[1]] = n
        } else if ("cut" == e) {
            var o = t.points[this._targetedAtSide], r = t.points[this._targetedAtSide + 1], s = o.clone().lerp(r, .5);
            t.insertPointAt(this._targetedAtSide + 1, s)
        } else if ("enable_sticks" == e)
            for (var a = 0; a < t.points.length; a++)
                t.sticks[a] = !0;
        else if ("disable_sticks" == e)
            for (var a = 0; a < t.points.length; a++)
                t.sticks[a] = !1;
        else
            t[e] = n;
        wanaplan.engine2D.requestStaticDraw()
    }, e.prototype.onContextMenuRemove = function(t) {
        var e = wanaplan.getSelectedStructure();
        t.remove(e)
    }, e.prototype.onStaticDraw = function(t, e, n) {
        for (var i = wanaplan.getSelectedStructure(), o = i.getElements("hoppers"), r = 0; r < o.length; r++)
            this.draw(o[r], t, e, n)
    }, e.prototype.onDynamicDraw = function(t, e, n) {
        wanaplan.engine2D.setCursorIcon(wanaplan.engine2D.symbols2D.drawCursorCheck.bind(wanaplan.engine2D.symbols2D)), this.draw(this._tmpHopper, t, e, n)
    }, e.prototype.initialize = function() {
        var t = {title: _("Hoppers"),index: 80,action: "wnp.engine2d.onAddHopper"};
        ujs.notify("wnp.menu.main.add", {item: t,menuPath: "draw2D",position: 80})
    }, e.prototype.drawTarget = function(t, e, n) {
        if (null !== this._targetedAt) {
            var i = wanaplan.engine2D.toRealCoord(t.points[this._targetedAt]);
            wanaplan.engine2D.symbols2D.drawPointHover(e, i, n)
        } else if (null !== this._targetedAtSide) {
            var o = wanaplan.engine2D.toRealCoord(t.points[this._targetedAtSide]), r = wanaplan.engine2D.toRealCoord(this._targetedAtSide + 1 < t.points.length ? t.points[this._targetedAtSide + 1] : t.points[0]);
            wanaplan.engine2D.symbols2D.drawSegment(e, o, r)
        }
    }, e.prototype.draw = function(t, e, n, i, o) {
        e.save(), e.beginPath(), o ? (e.fillStyle = wanaplan.engine2D.symbols2D.COLOR_ACTIVE_FILL, e.strokeStyle = wanaplan.engine2D.symbols2D.COLOR_ACTIVE_STROKE_DARKER) : (e.fillStyle = wanaplan.engine2D.symbols2D.COLOR_INACTIVE_FILL, e.strokeStyle = wanaplan.engine2D.symbols2D.COLOR_INACTIVE_STROKE);
        for (var r = 0; r < t.points.length; r++) {
            var s = wanaplan.engine2D.toRealCoord(t.points[r], n, i);
            0 == r ? e.moveTo(Math.round(s.x) + .5, Math.round(s.y) + .5) : e.lineTo(Math.round(s.x) + .5, Math.round(s.y) + .5)
        }
        e.closePath(), e.fill(), e.stroke(), e.beginPath();
        for (var r = 0; r < t.points.length; r++)
            if (t.sticks[r]) {
                var a = wanaplan.engine2D.toRealCoord(t.points[r], n, i), l = r + 1 < t.points.length ? r + 1 : 0, h = wanaplan.engine2D.toRealCoord(t.points[l], n, i);
                e.lineWidth = 4, e.beginPath(), e.moveTo(Math.round(a.x), Math.round(a.y)), e.lineTo(Math.round(h.x), Math.round(h.y)), e.stroke()
            }
        e.restore()
    }, e.prototype.getRoom = function(t, e) {
        var e = e || !1;
        if (t.room && e === !1)
            return t.room;
        var n = wanaplan.getComponentByName("RoomComponent2D"), i = n.isPointInRooms(t.points[0]);
        return i !== !1 ? (t.room = i, t.room) : !1
    }, e.prototype.isPointInHopperSide = function(t, e) {
        for (var n = 0; n < e.points.length; n++) {
            var i = e.points[n].clone(), o = n + 1 < e.points.length ? e.points[n + 1] : e.points[0], r = Math.abs(i.distanceTo(t) + o.distanceTo(t) - i.distanceTo(o));
            if (1 > r)
                return n
        }
        return !1
    }, e.prototype.isPointInHopper = function(t, e) {
        return t.isPointInPolygon(e.points) ? !0 : !1
    }, e
}();
var HopperComponent3D = function() {
    var t, e = function(e) {
        BaseComponent3D.call(this, e, "HopperComponent3D"), t = this;
        var n = wanaplan.getComponentByName("RoomComponent3D");
        this._commonHopperMaterial = n.getSideMaterial()
    };
    return e.prototype = new BaseComponent3D, e.prototype.startListening = function() {
        document.addEventListener("wnp.engine3d.floorReady", this.onFloorReady, !1)
    }, e.prototype.stopListening = function() {
        document.removeEventListener("wnp.engine3d.floorReady", this.onFloorReady, !1)
    }, e.prototype.onFloorReady = function(e) {
        for (var n = e.floor || t.getFloor(), i = e.structure || wanaplan.getSelectedStructure(), o = 0; o < i.hoppers.length; o++)
            t.createHopperSticks(i.hoppers[o], n)
    }, e.prototype.decorate = function(t, e) {
        var n = e.pickedMesh.material;
        return this.traverse(function(n) {
            n.name === e.pickedMesh.name && (n.material = t)
        }), this.structure.materials[e.pickedMesh.name] = t, n
    }, e.prototype.createScene = function() {
        for (var t = this.core.getComponentByName("FloorComponent3D"), e = 0; e < this.structure.getLength(); e++) {
            var n = this.structure.getElement(e);
            if (n instanceof FloorStructure)
                for (var i = t.getFloor(n), o = 0; o < n.hoppers.length; o++)
                    this.createHopperSticks(n.hoppers[o], i)
        }
    }, e.prototype.mergeGeometries = function(t, e, n) {
        var i = [], o = [], r = [];
        if (t.computeWorldMatrix(!0), t.traverse(function(t) {
            t.computeWorldMatrix(!0), t.isVisible && ("rail_stick" == t.name ? i.push(t) : "rails" == t.name ? o.push(t) : "bas" == t.name && r.push(t))
        }), i.length) {
            var s = BABYLON.Mesh.mergeMeshes("rail_stick", i, n);
            s.parent = t
        }
        if (o.length) {
            var a = BABYLON.Mesh.mergeMeshes("rails", o, n);
            a.parent = t
        }
        if (r.length) {
            var l = BABYLON.Mesh.mergeMeshes("bas", r, n);
            l.parent = t
        }
    }, e.prototype.createHopperSticks = function(t, e) {
        if (Object.keys(t.sticks).length) {
            var n = t.materials;
            n = ujs.mergeObjects(this.getDefaultMaterials(wanaplan.engine3D.scene), n);
            var i = new BABYLON.Mesh("sticks", wanaplan.engine3D.scene);
            i.isVisible = !1;
            for (var o in t.sticks) {
                var r = t.sticks[o] ? o : !1;
                if (r !== !1) {
                    var s = new BABYLON.Mesh("rails", wanaplan.engine3D.scene);
                    s.isVisible = !1;
                    var a = t.points[+r], l = t.points[+r + 1 >= t.points.length ? 0 : +r + 1], h = a.clone().lerp(l.clone(), .5), c = Math.atan2(l.y - a.y, l.x - a.x), u = a.distanceTo(l), p = BABYLON.Mesh.CreateBloc("bas", u, 10, 5, wanaplan.engine3D.scene);
                    p.parent = s, p.position.y = 5, p.name = "bas", p.isDecorable = !0;
                    var d = BABYLON.Mesh.CreateBloc("rails", u, 3, 5, wanaplan.engine3D.scene);
                    d.position.y = 90, d.name = "rails", d.isDecorable = !0, d.parent = s;
                    var m = 20, g = Math.round(u / m), m = u / g, f = new BABYLON.Mesh("stick", wanaplan.engine3D.scene);
                    f.isVisible = !1;
                    for (var y = BABYLON.Mesh.CreateCylinder("rail_stick", 90, 2, 2, 6, 1, !0, wanaplan.engine3D.scene), _ = 0; g > _; _++) {
                        var v = y.clone();
                        v.position.x = 3 + _ * m, v.position.z = 0, v.position.y = 45, v.parent = f
                    }
                    y.dispose(), f = BABYLON.Mesh.mergeMeshesRec("rail_stick", [f], wanaplan.engine3D.scene), f.position.x -= u / 2, f.isDecorable = !0, f.parent = s, s.rotation.y = c, s.position.x = h.x, s.position.z = -h.y, s.parent = i
                }
            }
            this.mergeGeometries(i, n, wanaplan.engine3D.scene), i.isDecorable = !0, i.decorate = this.decorate, i.structure = t, i.parent = e, this.initMaterials(i, n), t.materials = n
        }
        return !1
    }, e.prototype.getDefaultMaterials = function(t) {
        var e = {};
        return e.rails = new wnp.WhiteMaterial("rails", t, {factor: .8}), e.rail_stick = new wnp.MetalMaterial("rail_stick", t, {brillance: .2}), e.bas = new wnp.WhiteMaterial("bas", t, {factor: .8}), e
    }, e.prototype.prepareMaterials = function(t, e) {
        var n = t || {};
        for (var i in e.materials)
            this.materialFactory.copyFromParams(n[i], e.materials[i]);
        return n
    }, e.prototype.initMaterials = function(t, e) {
        for (var n in e)
            t.traverse(function(t) {
                t.name === n && (t.material = e[n])
            })
    }, e.Build = function(e, n, i, o) {
        if (e && 0 !== e.getTotalVertices()) {
            var r = BABYLON.CSG.FromMesh(e), i = i || 0, s = e.parent.structure.height < 100 ? e.parent.structure.height - 1 : 100, s = 100 > o ? o + 1 : 100, a = BABYLON.Mesh.ExtrudeNewMesh("hopper_temp", n.points, null, {amount: s}, wanaplan.engine3D.scene);
            if (!a)
                return e;
            a.position.y += i, a.parent = e.parent, n.material = n.material || t._commonHopperMaterial, a.subMeshes[0].objectInstance = n;
            var l = BABYLON.CSG.FromMesh(a);
            r.subtractInPlace(l);
            var h = r.toMesh("room_global", e.material, wanaplan.engine3D.scene, !0);
            return h.parent = e.parent, wanaplan.getComponentByName("RoomComponent3D").replaceRoom(e, h), 0 != i && h.subMeshes.splice(h.subMeshes.length - 1, 1), h.isDecorable = !0, h.parent.roomMesh = h, a.dispose(), h
        }
    }, e.Debug = function() {
        var t = BABYLON.Mesh.CreateSphere("sphere", 1, 40, wanaplan.engine3D.scene), e = BABYLON.Mesh.CreateBox("box", 40, wanaplan.engine3D.scene);
        t.position.y += 51, e.position.y += 25;
        var n = BABYLON.CSG.FromMesh(t), i = BABYLON.CSG.FromMesh(e), o = new BABYLON.MultiMaterial("multiMat", wanaplan.engine3D.scene), r = new BABYLON.StandardMaterial("mat0", wanaplan.engine3D.scene), s = new BABYLON.StandardMaterial("mat1", wanaplan.engine3D.scene);
        r.diffuseColor.copyFromFloats(.8, .2, .2), r.backFaceCulling = !1, s.diffuseColor.copyFromFloats(.2, .8, .2), s.backFaceCulling = !1, o.subMaterials.push(r, s);
        var a = i.subtract(n), l = a.toMesh("csg", o, wanaplan.engine3D.scene, !0);
        l.position = new BABYLON.Vector3(-100, 0, 0), a = n.subtract(i), l = a.toMesh("csg2", o, wanaplan.engine3D.scene, !0), l.position = new BABYLON.Vector3(100, 0, 0), a = n.intersect(i), l = a.toMesh("csg3", o, wanaplan.engine3D.scene, !0), l.position = new BABYLON.Vector3(0, 0, 100)
    }, e
}(), GeneralOptionComponent2D = function() {
    var t = function(t) {
        BaseComponent2D.call(this, t, "GeneralOptionComponent2D")
    };
    return t.prototype = Object.create(BaseComponent2D.prototype), t.prototype.initialize = function() {
        this.priority = 0, this.startListening(), this.gridComp = wanaplan.getComponentByName("GridComponent2D"), this.roomComp = wanaplan.getComponentByName("RoomComponent2D"), this.wallComp = wanaplan.getComponentByName("WallComponent2D")
    }, t.prototype.startListening = function() {
        this.stopListening(), document.addEventListener("wnp.engine2D.contextMenu.generalOption.propertyChange", this.myBind.onPropertyChange, !1), document.addEventListener("wnp.request.2Doptions", this.myBind.onRequestPanel, !1), document.addEventListener("wnp.contextChanged", this.myBind.onContextChange, !1), this._listening = !0, this._injectMenu()
    }, t.prototype.stopListening = function() {
        this.initBindForThisInstance(), document.removeEventListener("wnp.engine2D.contextMenu.generalOption.propertyChange", this.myBind.onPropertyChange, !1), document.removeEventListener("wnp.request.2Doptions", this.myBind.onRequestPanel, !1), document.removeEventListener("wnp.contextChanged", this.myBind.onContextChange, !1), this._listening = !1, this._removeMenu()
    }, t.prototype.initBindForThisInstance = function() {
        if (this.myBind)
            return this;
        var t = this;
        this.myBind = {};
        for (var e in this.handlers)
            (function() {
                var n = t.handlers[e];
                t.myBind[e] = function(e) {
                    n.call(t, e)
                }
            })();
        return this
    }, t.prototype.openGeneralOptionPanel = function() {
        var t = wanaplan.engine2D;
        t.setMode(t.MODE_CONTEXTMENU), wnp.UI.ContextMenu.show({title: _("General Settings")}, [{title: "Tab 1",content: this._getPanelParam()}], [{label: _("Ok"),action: "wnp.engine2D.contextMenu.close"}], 0)
    }, t.prototype._getPanelParam = function() {
        var t = [];
        return this.gridComp && t.push({label: _("display grid"),type: "checkbox",value: this.gridComp.displayGrid,eventParams: {cast: "boolean",property: "displayGrid",eventName: "wnp.engine2D.contextMenu.generalOption.propertyChange"}}), this.roomComp && t.push({label: _("display room name"),type: "checkbox",value: this.roomComp.displayRoomName,eventParams: {cast: "boolean",property: "displayRoomName",eventName: "wnp.engine2D.contextMenu.generalOption.propertyChange"}}), this.wallComp && t.push({label: _("display mesure"),type: "checkbox",value: this.wallComp.displayMesure,eventParams: {cast: "boolean",property: "displayMesure",eventName: "wnp.engine2D.contextMenu.generalOption.propertyChange"}}), t
    }, t.prototype._injectMenu = function() {
        wanaplan.getComponentByName("TopMenuComponent") && wanaplan.getComponentByName("TopMenuComponent").menu.json.length && (this._removeMenu(), setTimeout(function() {
            ujs.notify("wnp.menu.top.add", {item: {id: "2D-options",title: "2D options",action: "wnp.request.2Doptions",index: 2},menuPath: "toolbarOption"})
        }, 0))
    }, t.prototype._removeMenu = function() {
        ujs.notify("wnp.menu.top.delete", {id: "2D-options"})
    }, t.prototype.handlers = {onRequestPanel: function() {
            ujs.notify("wnp.menu.top.deselect"), this.openGeneralOptionPanel()
        },onPropertyChange: function(t) {
            var e = t.property, n = t.value;
            switch (e) {
                case "displayMesure":
                    this.wallComp && (this.wallComp.displayMesure = n);
                    break;
                case "displayRoomName":
                    this.roomComp && (this.roomComp.displayRoomName = n);
                    break;
                case "displayGrid":
                    this.gridComp && (this.gridComp.displayGrid = n)
            }
            wanaplan.engine2D.requestStaticDraw()
        }}, t
}();
ObjectStructure = function() {
    var t = 0, e = function(e, n) {
        BaseStructure.call(this, "Object_" + t++), Logger.warning("TODO : retravailler constructeur de objectStructure");
        var n = n || {};
        this.objectId = e || 0, this.position = n.position || new BABYLON.Vector3(0, 0, 0), this.rotation = n.rotation || new BABYLON.Vector3(0, 0, 0), this.scaling = n.scaling || new BABYLON.Vector3(1, 1, 1), this.modelRotation = n.modelRotation || new BABYLON.Vector3(0, 0, 0), this.preferredYAngle = n.preferredYAngle, this.objectInstance = null, this.programmableInstance = null, this.filename = null, this.builderId = null, this.customData = {}
    };
    return e.prototype = new BaseStructure, e.prototype.serialize = function() {
        if (!this.isDeleted) {
            var t, e = {"class": {name: "ObjectStructure"}};
            return this.objectInstance && (t = this.objectInstance.parent, this.objectInstance.changeFrame(this.objectInstance.getFloor())), ujs.serializeObject(this, e, ["objectId", "customData", "builderId", "filename", "baseUrl", "position", "rotation", "scaling", "programmableInstance"], ["group"]), t && (this.objectInstance.changeFrame(t), this.objectInstance.getFloor().markAsDirty()), e
        }
    }, e.prototype.deserialize = function(t) {
        return ujs.deserializeObject(t, this, ["objectId", "customData", "builderId", "filename", "baseUrl", "position", "rotation", "scaling", "programmableInstance"]), this
    }, e.Deserialize = function(t) {
        var n = new e;
        return n.deserialize(t), n
    }, e.prototype.checkCoherence = function(t) {
        (Math.abs(this.position.x) > 5e3 || Math.abs(this.position.z) > 5e3) && t.removeElement("objects", this), this.programmableInstance || t.removeElement("objects", this)
    }, e.prototype.clone = function() {
        var t = this.serialize();
        return e.Deserialize(t)
    }, e.prototype.getAvailableProperties = function() {
        var t = [];
        return null !== this.programmableInstance && (t = this.programmableInstance.getAvailableProperties(this)), t
    }, e.prototype.getMagnetismCollider = function() {
        return void 0 !== this.magnetismCollider ? this.magnetismCollider : void 0 !== this.params.magnetismCollider ? this.params.magnetismCollider : wnp.Constants.MAGNETISM.DEFAULT
    }, e.prototype.animate = function(t, e) {
        null !== this.programmableInstance && this.programmableInstance.animate && this.programmableInstance.animate(t, e)
    }, e.prototype.getProperty = function(t) {
        if (this.programmableInstance) {
            var e = "get" + t + "Param";
            if (this.programmableInstance[e]) {
                var n = this.programmableInstance[e].call(this);
                if (n)
                    return ujs.getProperty(this.programmableInstance, n)
            }
        }
        return 0
    }, e.prototype.changeProperty = function(t, e) {
        if (this.programmableInstance) {
            var n = "get" + t + "Param";
            if (this.programmableInstance[n]) {
                var i = this.programmableInstance[n].call(this);
                i && (ujs.setProperty(this, i, e), ujs.setProperty(this.programmableInstance, i, e))
            }
        }
    }, e
}();
var wnp = window.wnp || {};
wnp.Programmable = function() {
    var t, e = function(e, n, i) {
        this.params = {}, this.mergeParams(i), this.materials = null, this.structure = n, n && (this.magnetismCollider = this.structure.magnetismCollider), this.id = 0, this.async = !1, this.objectName = "Programmable", t = this
    };
    return e.prototype.getDefaultMaterials = function() {
        return {}
    }, e.prototype.decorate = function(t, e) {
        var n = e.pickedMesh.material;
        return this.traverse(function(n) {
            n.name === e.pickedMesh.name && (t.backFaceCulling = n.material.backFaceCulling, n.material = t)
        }), this.structure.programmableInstance.materials[e.pickedMesh.name] = t, n
    }, e.prototype.animate = function() {
        Logger.message("No animation here :(")
    }, e.prototype.importDAE = function() {
        return console.warn("Can't use DAE with BABYLON"), null
    }, e.prototype.importBabylon = function(t, e) {
        var n = t.split("/"), i = n[n.length - 1], o = i.split(".")[0];
        delete n[n.length - 1], n = n.join("/"), -1 === n.indexOf("http://") && -1 == n.indexOf("https://") && (n = wnp.Assets.globalPath + n);
        var r = new BABYLON.Mesh(o, wanaplan.engine3D.scene);
        return r.isVisible = !1, BABYLON.SceneLoader.ImportMesh("", n, i, wanaplan.engine3D.scene, function(t) {
            for (var n = 0, i = t.length; i > n; n++)
                t[n].parent = r, t[n].receiveShadows = !0, wanaplan.engine3D.castShadows(t[n]);
            e && e(r)
        }), r
    }, e.prototype.importOBJ = function() {
        return console.warn("Can't load OBJ file with BABYLON"), null
    }, e.prototype.mergeParams = function(t) {
        var t = t || {};
        this.params = this.getDefaultParams(), this.params = ujs.mergeObjects(this.params, t, !0)
    }, e.prototype.getDefaultParams = function() {
        return {}
    }, e.prototype.getParamType = function(t) {
        var e = t.split(".").slice(-1)[0];
        switch (e) {
            case "stretched_texture":
            case "rounded":
            case "active":
                return "boolean"
        }
        var n = this.getDefaultParams(), i = typeof ujs.getProperty(n, t);
        switch (i) {
            case "boolean":
            case "string":
            case "number":
                return i;
            case "undefined":
            default:
                return console.warn('enable to determine the type of the param "' + t + '" in the programmable ' + this.objectName), "number"
        }
    }, e.prototype.validateParam = function() {
        var t = function(t, e) {
            if (e = e || {}, t = t.replace(/\s/g, ""), !/^-?\d*\.?\d*]*$/.exec(t) || !/\d/.exec(t)) {
                if (!(t = /-?\d+\.?\d*]*/.exec(t)))
                    return e["default"] || null;
                t = t[0]
            }
            var n = +t;
            if (e.round) {
                var i = e.round === !0 ? 1 : e.round;
                n = Math.round(n * i) / i
            }
            return "number" == typeof e.max && (n = Math.min(n, e.max)), "number" == typeof e.min && (n = Math.max(n, e.min)), n
        }, e = function(t) {
            return !!+t << 0
        }, n = function(e, n) {
            if (n = n || {}, n.intList = n.intList || n.intListSeparator || n.inListOptions, n.intList) {
                for (var i = n.intListSeparator || ",", o = ("" + e).split(i), r = o.length; r--; )
                    if ("undefined" == typeof (o[r] = t(o[r], n.inListOptions)) || null == o[r])
                        return null;
                e = o.join(i)
            }
            return e
        };
        return function(i, o) {
            var r = null, s = null;
            switch ("params" == i.split(".")[0] && (i = i.split(".").slice(1).join(".")), r = this.getParamType(i), "string" != typeof r && (s = r, r = r.type), r) {
                case "boolean":
                    return e(o, s);
                case "string":
                    return n(o, s);
                default:
                case "number":
                    return t(o, s)
            }
        }
    }(), e.prototype.prepareMaterials = function(t) {
        return this.materials = t, t
    }, e.prototype.applyShadow = function() {
        console.warn("Not used in BABYLON")
    }, e.createInstance = function(t, e, n, i, o, r, s) {
        var a = t.split(".");
        a.length = a.length - 1;
        var e = e || {}, l = function() {
            var t = ujs.getProperty(wnp.Programmable, a.join(".")), r = e.params || e, l = new t(s, i, r);
            l.materials = n || l.getDefaultMaterials(wanaplan.engine3D.scene);
            e.id;
            o(l)
        }, h = a.length, c = function(t, e, n) {
            if (t >= h)
                return void l();
            var i = n || wnp.Constants.PROGRAMMABLE_PATH;
            HTMLHelper.addScript([i, "/", e, ".js"].join(""), void 0, function() {
                var i = e + "/" + a[t + 1];
                c(t + 1, i, n)
            })
        };
        c(0, a[0], r)
    }, e.prototype.serialize = function() {
        var t = {"class": {name: "wnp.Programmable"}};
        return ujs.serializeObject(this, t, ["objectName", "id", "params", "materials"]), t
    }, e.prototype.deserialize = function(t) {
        return ujs.deserializeObject(t, this, ["objectName", "id", "params", "materials"]), this
    }, e.Deserialize = function(t) {
        var n = new e(wanaplan.engine3D, null, t.params);
        return n.deserialize(t), n
    }, e.prototype.getAvailableProperties = function() {
        var t = this.generateFormForObject("params", this);
        if (this.localizeAndSortParams) {
            for (var e = this.localizeAndSortParams(), n = t.length - 1; n >= 0; n--) {
                var i = t[n].name ? t[n].name.replace("params.", "") : void 0, o = i.split(".")[0];
                e.invisible && (e.invisible.hasOwnProperty(i) || e.invisible.hasOwnProperty(o)) ? delete t[n] : e.basic && e.basic.hasOwnProperty(i) ? t[n].label = t[n].label ? e.basic[i] : "" : e.advanced && e.advanced.hasOwnProperty(i) ? (t[n].label = t[n].label ? e.advanced[i] : "", t[n]["class"] = "hidden advancedParams") : delete t[n]
            }
            Object.keys(e.advanced).length > 0 && t.push({type: "html",html: "<a href='' onclick='wnp.Programmable.toggleVisible();return false;'>" + _("show advanced params") + "</a>"})
        }
        return t
    }, e.prototype.generateFormForObject = function(t, e, n, i, o) {
        var n = n || [], r = null, i = i || "", o = o || 0;
        if (e[t] instanceof Object) {
            i = i ? i + "." + t : t, "params" != t && (r = {name: i,label: t,type: "separator",html: t}, n.push(r)), o++;
            for (var s in e[t])
                this.generateFormForObject(s, e[t], n, i, o);
            n.push({type: "separator",name: i})
        } else {
            var a = i ? i + "." + t : t, l = this.getParamType(a.split(".").slice(1).join("."));
            l = l.type ? l : {type: l};
            var h, c;
            switch (l.type) {
                case "boolean":
                    h = "checkbox", c = !!e[t];
                    break;
                case "number":
                    h = "number", c = {value: +e[t]}, "undefined" != typeof l.max && (c.max = l.max), "undefined" != typeof l.min && (c.min = l.min), "undefined" != typeof l.round && (c.step = l.round);
                    break;
                default:
                    h = "text", c = e[t]
            }
            r = {name: a,label: new Array(2 * o).join("&nbsp") + t,type: h,value: c,eventParams: {eventName: "wnp.contextMenu.propertyChanged",property: a},id: a.split(".").join("-")}, n.push(r)
        }
        return n
    }, e.prototype.createPoignee = function() {
        return console.warn("Can't use it with BABYLON"), null
    }, e.prototype.getWidthParam = function() {
        return this.params.width ? "params.width" : !1
    }, e.prototype.getHeightParam = function() {
        return this.params.height ? "params.height" : !1
    }, e.prototype.getDepthParam = function() {
        return this.params.depth ? "params.depth" : !1
    }, e.prototype.generateMissingFacesUvs = function() {
        return console.warn("Can't use it with BABYLON"), null
    }, e
}(), wnp.Programmable.toggleVisible = function() {
    for (var t = document.querySelectorAll(".advancedParams"), e = 0; e < t.length; e++)
        t[e].classList.toggle("hidden")
};
var DecorationComponent3D = function() {
    function t(t) {
        "object" == typeof t && ("keydown" == t.type && 27 != t.keyCode || "mousedown" == t.type && 0 == t.button) || (n = null, ujs.notify("wnp.menu.main.deselect"), wanaplan.engine3D.mode = wanaplan.engine3D.MODE_NORMAL, wanaplan.engine3D.canvas.classList.remove("brush"))
    }
    var e, n = null, i = 0, o = function(t) {
        BaseComponent3D.call(this, t, "DecorationComponent3D"), this.tabs = [], window.ejecta || (this.tabs = document.getElementsByClassName("menu-tab")), e = this, this.historycmp = null, this.PAINTACTION = 0, this.setupHistory(), this.standardMaps = ["map", "bumpMap", "normalMap", "specularMap"], document.addEventListener("wnp.core.structure.loaded", this.initializeLastColor.bind(this), !1)
    };
    return o.prototype = new BaseComponent3D, o.prototype.initializeLastColor = function() {
        var t = this.core.structure.lastMaterialsUsed.length > 0 ? "" : " hidden", e = this.core.structure.lastMaterialsUsed.length > 0 ? this.cleanJson(this.core.structure.lastMaterialsUsed) : [], n = {id: "last_colors",title: _("Latest colors"),index: 5,addClass: "last-color-item" + t,layout: "layout-table-60",items: e};
        ujs.notify("wnp.menu.main.add", {item: n,menuPath: "decorate3D",position: 0})
    }, o.prototype.destroy = function() {
        ujs.notify("wnp.menu.main.remove", {item: "furnishing3D"}), ujs.notify("wnp.menu.main.remove", {item: "decorate3D"})
    }, o.prototype.cleanJson = function(t) {
        for (var e in t)
            t.hasOwnProperty(e) && (t[e] instanceof Object ? t[e] = this.cleanJson(t[e]) : "string" == typeof t[e] && -1 !== t[e].indexOf("http://") && (t[e] = GlobalHelper.stripDomainUrl(t[e], "wanaplan.")));
        return t
    }, o.prototype.initialize = function() {
        var t = this, e = "data/menu.content.compiled.json";
        window.ejecta && (e = "Wanaplan/" + e);
        var n = function() {
            ujs.ajax({url: e,method: "GET",params: ["t=", Math.round(100 * Math.random())].join(""),success: function(e) {
                    var n = JSON.parse(e);
                    n = t.cleanJson(n), ujs.notify("wnp.menu.main.add", {item: n,menuPath: "decorate3D",position: 0})
                }})
        };
        ujs.ajax({url: wnp.Constants.TEXTURES_FILE,method: "GET",params: ["t=", Math.round(100 * Math.random())].join(""),success: function(e) {
                try {
                    var i = JSON.parse(e);
                    i = t.cleanJson(i), ujs.notify("wnp.menu.main.add", {item: i,menuPath: "decorate3D",position: 0})
                } catch (o) {
                    Logger.message("BAD JSON FILE"), n()
                }
            },onerror: n})
    }, o.prototype.startListening = function() {
        document.addEventListener("wnp.request.changeEngine", this.onChangeEngine, !1), document.addEventListener("wnp.engine3D.paint", this.onPaintHandler, !1), document.addEventListener("wnp.engine3D.click.collided", this.onClick, !1), document.addEventListener("keydown", t, !1)
    }, o.prototype.stopListening = function() {
        document.removeEventListener("wnp.request.changeEngine", this.onChangeEngine, !1), document.removeEventListener("wnp.engine3D.paint", this.onPaintHandler), document.removeEventListener("wnp.engine3D.click.collided", this.onClick, !1), document.removeEventListener("keydown", t)
    }, o.prototype.onContextChanged = function(e) {
        if ("3D" == e) {
            if (!this.initialized) {
                this.startListening();
                for (var n = 0, i = this.tabs.length; i > n; n++)
                    this.tabs[n].addEventListener("click", t, !1);
                this.initialized = !0
            }
        } else if (this.initialized) {
            for (var n = 0, i = this.tabs.length; i > n; n++)
                this.tabs[n].removeEventListener("click", t, !1);
            this.initialized = !1
        }
    }, o.prototype.onPaintHandler = function(t) {
        e.core.helpBubbleManager.display("wnp.3d.paint");
        var i = t.params || {};
        n = {title: t.title,action: "wnp.engine3D.paint",params: i,texture: !0}, wanaplan.engine3D.mode = e.engine3D.MODE_PAINT, wanaplan.engine3D.canvas.classList.add("brush"), ujs.notify("wnp.engine3D.brushReady")
    }, o.prototype.updateLastItemMenu = function(t) {
        for (var e = !1, n = 0; n < wanaplan.structure.lastMaterialsUsed.length; n++)
            t.title == wanaplan.structure.lastMaterialsUsed[n].title && (e = !0);
        e === !1 && (wanaplan.structure.lastMaterialsUsed.push(ujs.cloneObject(t)), ujs.notify("wnp.menu.main.replace", {item: {id: "last_colors",addClass: "last-color-item",items: wanaplan.structure.lastMaterialsUsed},merge: !0}, !0)), this.core.structure.lastMaterialsUsed.length > 21 && this.core.structure.lastMaterialsUsed.splice(0, this.core.structure.lastMaterialsUsed.length - 21)
    }, o.prototype.onClick = function(o) {
        if (null != n) {
            var r = wnp.MaterialFactory.ImportWNPMaterial(n.params);
            r.isDefault = !1;
            var s = o.collided.pickedMesh.getTopLevelObject();
            if (s.isDecorable) {
                if (s.decorate)
                    var a = s.decorate(r, o.collided);
                else
                    var a = e.decorate(o.collided.pickedMesh, r, o.collided);
                r.backFaceCulling = a ? a.backFaceCulling : !1
            }
            e.updateLastItemMenu(n), ujs.notify("wnp.request.historyAction", {component: e,object: s,params: {oldMaterial: a,newMaterial: r,collided: o.collided},action: e.PAINTACTION}), n && e.updateLastItemMenu(n), ujs.notify("wnp.engine3D.decorate", {material: r}), 1 >= i && t()
        }
    }, o.prototype.decorate = function(t, e) {
        t.material = e
    }, o.prototype.applyMaterial = function(t, n, i) {
        t.decorate ? t.decorate(n, i) : e.decorate(i.pickedMesh, n, i)
    }, o.prototype.getMaterial = function() {
        return material
    }, o.prototype.addHistory = function(t, e, n) {
        this.historycmp && this.historycmp.actionDone(t, e, n, this)
    }, o.prototype.undoPaint = function(t, n) {
        e.historyPaint(t, n, n.oldMaterial)
    }, o.prototype.redoPaint = function(t, n) {
        e.historyPaint(t, n, n.newMaterial)
    }, o.prototype.historyPaint = function(t, n, i) {
        e.applyMaterial(t, i, n.collided), ujs.notify("wnp.request.saveHistory")
    }, o.prototype.setupHistory = function() {
        this.historycmp = this.core.getComponentByName("HistoryComponent"), this.historycmp && this.historycmp.registerAction(this.PAINTACTION, this.undoPaint, this.redoPaint, this)
    }, o
}(), LuxensComponent3D = function() {
    var t = function(t) {
        BaseComponent3D.call(this, t, "LuxensComponent3D")
    };
    t.prototype = new BaseComponent3D, t.prototype.initialize = function() {
        _item = {title: _("Paints (Luxens)"),id: "luxens",items: e,layout: "layout-table-26"}, ujs.notify("wnp.menu.main.add", {item: _item,menuPath: "decorate3D",position: 10})
    }, t.getLuxens = function() {
        return e
    };
    var e = [{texture: !0,title: "Blanc 1",icon: "",action: "wnp.engine3D.paint",items: [],params: {materialType: "wnp.WhiteMaterial",color: {r: 1,g: 1,b: 1}}}, {texture: !0,title: "Blanc 2",icon: "",action: "wnp.engine3D.paint",items: [],params: {materialType: "wnp.WhiteMaterial",color: {r: .96,g: .96,b: .96}}}, {texture: !0,title: "Blanc3",icon: "",action: "wnp.engine3D.paint",items: [],params: {materialType: "wnp.WhiteMaterial",color: {r: .9,g: .9,b: .9}}}, {texture: !0,title: "Noir 1",icon: "",action: "wnp.engine3D.paint",items: [],params: {materialType: "luxens",color: {r: 0,g: 0,b: 0}}}, {texture: !0,title: "Noir 2",icon: "",action: "wnp.engine3D.paint",items: [],params: {materialType: "luxens",color: {r: .05,g: .05,b: .05}}}, {texture: !0,title: "Noir 3",icon: "",action: "wnp.engine3D.paint",items: [],params: {materialType: "luxens",color: {r: .07,g: .07,b: .07}}}, {texture: !0,title: "Blanc calcaire 1",icon: "",action: "wnp.engine3D.paint",items: [],params: {materialType: "luxens",color: {r: .85,g: .85,b: .82}}}, {texture: !0,title: "Blanc calcaire 2",icon: "",action: "wnp.engine3D.paint",items: [],params: {materialType: "luxens",color: {r: .91,g: .9,b: .82}}}, {texture: !0,title: "Blanc calcaire 3",icon: "",action: "wnp.engine3D.paint",items: [],params: {materialType: "luxens",color: {r: .92,g: .93,b: .89}}}, {texture: !0,title: "Blanc calcaire 4",icon: "",action: "wnp.engine3D.paint",items: [],params: {materialType: "luxens",color: {r: .92,g: .93,b: .89}}}, {texture: !0,title: "Blanc calcaire 5",icon: "",action: "wnp.engine3D.paint",items: [],params: {materialType: "luxens",color: {r: .88,g: .89,b: .86}}}, {texture: !0,title: "Blanc calcaire 6",icon: "",action: "wnp.engine3D.paint",items: [],params: {materialType: "luxens",color: {r: .91,g: .88,b: .84}}}, {texture: !0,title: "Blanc ivoire 1",icon: "",action: "wnp.engine3D.paint",items: [],params: {materialType: "luxens",color: {r: .85,g: .8,b: .71}}}, {texture: !0,title: "Blanc ivoire 2",icon: "",action: "wnp.engine3D.paint",items: [],params: {materialType: "luxens",color: {r: .93,g: .87,b: .77}}}, {texture: !0,title: "Blanc ivoire 3",icon: "",action: "wnp.engine3D.paint",items: [],params: {materialType: "luxens",color: {r: .91,g: .87,b: .76}}}, {texture: !0,title: "Blanc ivoire 4",icon: "",action: "wnp.engine3D.paint",items: [],params: {materialType: "luxens",color: {r: .94,g: .91,b: .83}}}, {texture: !0,title: "Blanc ivoire 5",icon: "",action: "wnp.engine3D.paint",items: [],params: {materialType: "luxens",color: {r: .91,g: .89,b: .84}}}, {texture: !0,title: "Blanc ivoire 6",icon: "",action: "wnp.engine3D.paint",items: [],params: {materialType: "luxens",color: {r: .93,g: .89,b: .76}}}, {texture: !0,title: "Blanc coquille 1",icon: "",action: "wnp.engine3D.paint",items: [],params: {materialType: "luxens",color: {r: .84,g: .78,b: .73}}}, {texture: !0,title: "Blanc coquille 2",icon: "",action: "wnp.engine3D.paint",items: [],params: {materialType: "luxens",color: {r: .86,g: .83,b: .77}}}, {texture: !0,title: "Blanc coquille 3",icon: "",action: "wnp.engine3D.paint",items: [],params: {materialType: "luxens",color: {r: .91,g: .86,b: .78}}}, {texture: !0,title: "Blanc coquille 4",icon: "",action: "wnp.engine3D.paint",items: [],params: {materialType: "luxens",color: {r: .9,g: .86,b: .81}}}, {texture: !0,title: "Blanc coquille 5",icon: "",action: "wnp.engine3D.paint",items: [],params: {materialType: "luxens",color: {r: .93,g: .89,b: .84}}}, {texture: !0,title: "Blanc coquille 6",icon: "",action: "wnp.engine3D.paint",items: [],params: {materialType: "luxens",color: {r: .96,g: .88,b: .75}}}, {texture: !0,title: "Gris galet 1",icon: "",action: "wnp.engine3D.paint",items: [],params: {materialType: "luxens",color: {r: .31,g: .32,b: .35}}}, {texture: !0,title: "Gris galet 2",icon: "",action: "wnp.engine3D.paint",items: [],params: {materialType: "luxens",color: {r: .39,g: .38,b: .41}}}, {texture: !0,title: "Gris galet 3",icon: "",action: "wnp.engine3D.paint",items: [],params: {materialType: "luxens",color: {r: .49,g: .49,b: .5}}}, {texture: !0,title: "Gris galet 4",icon: "",action: "wnp.engine3D.paint",items: [],params: {materialType: "luxens",color: {r: .58,g: .62,b: .63}}}, {texture: !0,title: "Gris galet 5",icon: "",action: "wnp.engine3D.paint",items: [],params: {materialType: "luxens",color: {r: .7,g: .71,b: .72}}}, {texture: !0,title: "Gris galet 6",icon: "",action: "wnp.engine3D.paint",items: [],params: {materialType: "luxens",color: {r: .78,g: .79,b: .8}}}, {texture: !0,title: "Gris zingué 1",icon: "",action: "wnp.engine3D.paint",items: [],params: {materialType: "luxens",color: {r: .2,g: .22,b: .23}}}, {texture: !0,title: "Gris zingué 2",icon: "",action: "wnp.engine3D.paint",items: [],params: {materialType: "luxens",color: {r: .29,g: .33,b: .36}}}, {texture: !0,title: "Gris zingué 3",icon: "",action: "wnp.engine3D.paint",items: [],params: {materialType: "luxens",color: {r: .29,g: .36,b: .43}}}, {texture: !0,title: "Gris zingué 4",icon: "",action: "wnp.engine3D.paint",items: [],params: {materialType: "luxens",color: {r: .47,g: .51,b: .54}}}, {texture: !0,title: "Gris zingué 5",icon: "",action: "wnp.engine3D.paint",items: [],params: {materialType: "luxens",color: {r: .6,g: .65,b: .69}}}, {texture: !0,title: "Gris zingué 6",icon: "",action: "wnp.engine3D.paint",items: [],params: {materialType: "luxens",color: {r: .69,g: .73,b: .78}}}, {texture: !0,title: "Gris smoke 1",icon: "",action: "wnp.engine3D.paint",items: [],params: {materialType: "luxens",color: {r: .26,g: .27,b: .27}}}, {texture: !0,title: "Gris smoke 2",icon: "",action: "wnp.engine3D.paint",items: [],params: {materialType: "luxens",color: {r: .36,g: .37,b: .33}}}, {texture: !0,title: "Gris smoke 3",icon: "",action: "wnp.engine3D.paint",items: [],params: {materialType: "luxens",color: {r: .4,g: .42,b: .36}}}, {texture: !0,title: "Gris smoke 4",icon: "",action: "wnp.engine3D.paint",items: [],params: {materialType: "luxens",color: {r: .47,g: .51,b: .45}}}, {texture: !0,title: "Gris smoke 5",icon: "",action: "wnp.engine3D.paint",items: [],params: {materialType: "luxens",color: {r: .58,g: .62,b: .59}}}, {texture: !0,title: "Gris smoke 6",icon: "",action: "wnp.engine3D.paint",items: [],params: {materialType: "luxens",color: {r: .73,g: .75,b: .74}}}, {texture: !0,title: "Gris gris 1",icon: "",action: "wnp.engine3D.paint",items: [],params: {materialType: "luxens",color: {r: .08,g: .08,b: .08}}}, {texture: !0,title: "Gris gris 2",icon: "",action: "wnp.engine3D.paint",items: [],params: {materialType: "luxens",color: {r: .4,g: .41,b: .39}}}, {texture: !0,title: "Gris gris 3",icon: "",action: "wnp.engine3D.paint",items: [],params: {materialType: "luxens",color: {r: .52,g: .52,b: .5}}}, {texture: !0,title: "Gris gris 4",icon: "",action: "wnp.engine3D.paint",items: [],params: {materialType: "luxens",color: {r: .59,g: .56,b: .51}}}, {texture: !0,title: "Gris gris 5",icon: "",action: "wnp.engine3D.paint",items: [],params: {materialType: "luxens",color: {r: .65,g: .64,b: .57}}}, {texture: !0,title: "Gris gris 6",icon: "",action: "wnp.engine3D.paint",items: [],params: {materialType: "luxens",color: {r: .79,g: .81,b: .77}}}, {texture: !0,title: "Gris poivré 1",icon: "",action: "wnp.engine3D.paint",items: [],params: {materialType: "luxens",color: {r: .12,g: .11,b: .1}}}, {texture: !0,title: "Gris poivré 2",icon: "",action: "wnp.engine3D.paint",items: [],params: {materialType: "luxens",color: {r: .3,g: .27,b: .26}}}, {texture: !0,title: "Gris poivré 3",icon: "",action: "wnp.engine3D.paint",items: [],params: {materialType: "luxens",color: {r: .41,g: .4,b: .37}}}, {texture: !0,title: "Gris poivré 4",icon: "",action: "wnp.engine3D.paint",items: [],params: {materialType: "luxens",color: {r: .57,g: .53,b: .54}}}, {texture: !0,title: "Gris poivré 5",icon: "",action: "wnp.engine3D.paint",items: [],params: {materialType: "luxens",color: {r: .69,g: .67,b: .67}}}, {texture: !0,title: "Gris poivré 6",icon: "",action: "wnp.engine3D.paint",items: [],params: {materialType: "luxens",color: {r: .82,g: .78,b: .75}}}, {texture: !0,title: "Gris doré 1",icon: "",action: "wnp.engine3D.paint",items: [],params: {materialType: "luxens",color: {r: .38,g: .33,b: .27}}}, {texture: !0,title: "Gris doré 2",icon: "",action: "wnp.engine3D.paint",items: [],params: {materialType: "luxens",color: {r: .41,g: .38,b: .31}}}, {texture: !0,title: "Gris doré 3",icon: "",action: "wnp.engine3D.paint",items: [],params: {materialType: "luxens",color: {r: .53,g: .45,b: .36}}}, {texture: !0,title: "Gris doré 4",icon: "",action: "wnp.engine3D.paint",items: [],params: {materialType: "luxens",color: {r: .56,g: .52,b: .46}}}, {texture: !0,title: "Gris doré 5",icon: "",action: "wnp.engine3D.paint",items: [],params: {materialType: "luxens",color: {r: .64,g: .58,b: .48}}}, {texture: !0,title: "Gris doré 6",icon: "",action: "wnp.engine3D.paint",items: [],params: {materialType: "luxens",color: {r: .8,g: .77,b: .72}}}, {texture: !0,title: "Brun taupe 1",icon: "",action: "wnp.engine3D.paint",items: [],params: {materialType: "luxens",color: {r: .27,g: .24,b: .23}}}, {texture: !0,title: "Brun taupe 2",icon: "",action: "wnp.engine3D.paint",items: [],params: {materialType: "luxens",color: {r: .35,g: .29,b: .27}}}, {texture: !0,title: "Brun taupe 3",icon: "",action: "wnp.engine3D.paint",items: [],params: {materialType: "luxens",color: {r: .46,g: .41,b: .37}}}, {texture: !0,title: "Brun taupe 4",icon: "",action: "wnp.engine3D.paint",items: [],params: {materialType: "luxens",color: {r: .53,g: .47,b: .46}}}, {texture: !0,title: "Brun taupe 5",icon: "",action: "wnp.engine3D.paint",items: [],params: {materialType: "luxens",color: {r: .67,g: .57,b: .56}}}, {texture: !0,title: "Brun taupe 6",icon: "",action: "wnp.engine3D.paint",items: [],params: {materialType: "luxens",color: {r: .81,g: .75,b: .75}}}, {texture: !0,title: "Brun gatsby 1",icon: "",action: "wnp.engine3D.paint",items: [],params: {materialType: "luxens",color: {r: .25,g: .18,b: .19}}}, {texture: !0,title: "Brun gatsby 2",icon: "",action: "wnp.engine3D.paint",items: [],params: {materialType: "luxens",color: {r: .3,g: .22,b: .22}}}, {texture: !0,title: "Brun gatsby 3",icon: "",action: "wnp.engine3D.paint",items: [],params: {materialType: "luxens",color: {r: .43,g: .31,b: .27}}}, {texture: !0,title: "Brun gatsby 4",icon: "",action: "wnp.engine3D.paint",items: [],params: {materialType: "luxens",color: {r: .61,g: .5,b: .43}}}, {texture: !0,title: "Brun gatsby 5",icon: "",action: "wnp.engine3D.paint",items: [],params: {materialType: "luxens",color: {r: .73,g: .63,b: .54}}}, {texture: !0,title: "Brun gatsby 6",icon: "",action: "wnp.engine3D.paint",items: [],params: {materialType: "luxens",color: {r: .85,g: .78,b: .68}}}, {texture: !0,title: "Brun brun 1",icon: "",action: "wnp.engine3D.paint",items: [],params: {materialType: "luxens",color: {r: .27,g: .22,b: .18}}}, {texture: !0,title: "Brun brun 2",icon: "",action: "wnp.engine3D.paint",items: [],params: {materialType: "luxens",color: {r: .42,g: .31,b: .22}}}, {texture: !0,title: "Brun brun 3",icon: "",action: "wnp.engine3D.paint",items: [],params: {materialType: "luxens",color: {r: .47,g: .39,b: .31}}}, {texture: !0,title: "Brun brun 4",icon: "",action: "wnp.engine3D.paint",items: [],params: {materialType: "luxens",color: {r: .67,g: .57,b: .42}}}, {texture: !0,title: "Brun brun 5",icon: "",action: "wnp.engine3D.paint",items: [],params: {materialType: "luxens",color: {r: .81,g: .69,b: .52}}}, {texture: !0,title: "Brun brun 6",icon: "",action: "wnp.engine3D.paint",items: [],params: {materialType: "luxens",color: {r: .83,g: .75,b: .62}}}, {texture: !0,title: "Brun argileux 1",icon: "",action: "wnp.engine3D.paint",items: [],params: {materialType: "luxens",color: {r: .27,g: .25,b: .24}}}, {texture: !0,title: "Brun argileux 2",icon: "",action: "wnp.engine3D.paint",items: [],params: {materialType: "luxens",color: {r: .31,g: .29,b: .2}}}, {texture: !0,title: "Brun argileux 3",icon: "",action: "wnp.engine3D.paint",items: [],params: {materialType: "luxens",color: {r: .53,g: .42,b: .23}}}, {texture: !0,title: "Brun argileux 4",icon: "",action: "wnp.engine3D.paint",items: [],params: {materialType: "luxens",color: {r: .57,g: .51,b: .36}}}, {texture: !0,title: "Brun argileux 5",icon: "",action: "wnp.engine3D.paint",items: [],params: {materialType: "luxens",color: {r: .71,g: .68,b: .58}}}, {texture: !0,title: "Brun argileux 6",icon: "",action: "wnp.engine3D.paint",items: [],params: {materialType: "luxens",color: {r: .81,g: .79,b: .69}}}, {texture: !0,title: "Brun chocolat 1",icon: "",action: "wnp.engine3D.paint",items: [],params: {materialType: "luxens",color: {r: .22,g: .17,b: .14}}}, {texture: !0,title: "Brun chocolat 2",icon: "",action: "wnp.engine3D.paint",items: [],params: {materialType: "luxens",color: {r: .32,g: .21,b: .16}}}, {texture: !0,title: "Brun chocolat 3",icon: "",action: "wnp.engine3D.paint",items: [],params: {materialType: "luxens",color: {r: .36,g: .21,b: .15}}}, {texture: !0,title: "Brun chocolat 4",icon: "",action: "wnp.engine3D.paint",items: [],params: {materialType: "luxens",color: {r: .5,g: .35,b: .25}}}, {texture: !0,title: "Brun chocolat 5",icon: "",action: "wnp.engine3D.paint",items: [],params: {materialType: "luxens",color: {r: .8,g: .66,b: .49}}}, {texture: !0,title: "Brun chocolat 6",icon: "",action: "wnp.engine3D.paint",items: [],params: {materialType: "luxens",color: {r: .91,g: .81,b: .71}}}, {texture: !0,title: "Brun havane 1",icon: "",action: "wnp.engine3D.paint",items: [],params: {materialType: "luxens",color: {r: .16,g: .12,b: .12}}}, {texture: !0,title: "Brun havane 2",icon: "",action: "wnp.engine3D.paint",items: [],params: {materialType: "luxens",color: {r: .25,g: .14,b: .14}}}, {texture: !0,title: "Brun havane 3",icon: "",action: "wnp.engine3D.paint",items: [],params: {materialType: "luxens",color: {r: .5,g: .28,b: .24}}}, {texture: !0,title: "Brun havane 4",icon: "",action: "wnp.engine3D.paint",items: [],params: {materialType: "luxens",color: {r: .62,g: .39,b: .29}}}, {texture: !0,title: "Brun havane 5",icon: "",action: "wnp.engine3D.paint",items: [],params: {materialType: "luxens",color: {r: .77,g: .5,b: .39}}}, {texture: !0,title: "Brun havane 6",icon: "",action: "wnp.engine3D.paint",items: [],params: {materialType: "luxens",color: {r: .88,g: .73,b: .63}}}, {texture: !0,title: "Rouge velours 1",icon: "",action: "wnp.engine3D.paint",items: [],params: {materialType: "luxens",color: {r: .27,g: .12,b: .12}}}, {texture: !0,title: "Rouge velours 2",icon: "",action: "wnp.engine3D.paint",items: [],params: {materialType: "luxens",color: {r: .43,g: .12,b: .16}}}, {texture: !0,title: "Rouge velours 3",icon: "",action: "wnp.engine3D.paint",items: [],params: {materialType: "luxens",color: {r: .48,g: .13,b: .18}}}, {texture: !0,title: "Rouge velours 4",icon: "",action: "wnp.engine3D.paint",items: [],params: {materialType: "luxens",color: {r: .58,g: .22,b: .22}}}, {texture: !0,title: "Rouge velours 5",icon: "",action: "wnp.engine3D.paint",items: [],params: {materialType: "luxens",color: {r: .81,g: .32,b: .31}}}, {texture: !0,title: "Rouge velours 6",icon: "",action: "wnp.engine3D.paint",items: [],params: {materialType: "luxens",color: {r: .85,g: .45,b: .43}}}, {texture: !0,title: "Rouge rubis 1",icon: "",action: "wnp.engine3D.paint",items: [],params: {materialType: "luxens",color: {r: .25,g: .11,b: .11}}}, {texture: !0,title: "Rouge rubis 2",icon: "",action: "wnp.engine3D.paint",items: [],params: {materialType: "luxens",color: {r: .4,g: .08,b: .14}}}, {texture: !0,title: "Rouge rubis 3",icon: "",action: "wnp.engine3D.paint",items: [],params: {materialType: "luxens",color: {r: .6,g: .07,b: .24}}}, {texture: !0,title: "Rouge rubis 4",icon: "",action: "wnp.engine3D.paint",items: [],params: {materialType: "luxens",color: {r: .64,g: .14,b: .27}}}, {texture: !0,title: "Rouge rubis 5",icon: "",action: "wnp.engine3D.paint",items: [],params: {materialType: "luxens",color: {r: .75,g: .33,b: .43}}}, {texture: !0,title: "Rouge rubis 6",icon: "",action: "wnp.engine3D.paint",items: [],params: {materialType: "luxens",color: {r: .89,g: .61,b: .63}}}, {texture: !0,title: "Rouge gourmand 1",icon: "",action: "wnp.engine3D.paint",items: [],params: {materialType: "luxens",color: {r: .27,g: .05,b: .09}}}, {texture: !0,title: "Rouge gourmand 2",icon: "",action: "wnp.engine3D.paint",items: [],params: {materialType: "luxens",color: {r: .54,g: .02,b: .15}}}, {texture: !0,title: "Rouge gourmand 3",icon: "",action: "wnp.engine3D.paint",items: [],params: {materialType: "luxens",color: {r: .65,g: 0,b: .18}}}, {texture: !0,title: "Rouge gourmand 4",icon: "",action: "wnp.engine3D.paint",items: [],params: {materialType: "luxens",color: {r: .84,g: .07,b: .2}}}, {texture: !0,title: "Rouge gourmand 5",icon: "",action: "wnp.engine3D.paint",items: [],params: {materialType: "luxens",color: {r: .87,g: .15,b: .28}}}, {texture: !0,title: "Rouge gourmand 6",icon: "",action: "wnp.engine3D.paint",items: [],params: {materialType: "luxens",color: {r: .99,g: .76,b: .76}}}, {texture: !0,title: "Rouge-rouge 1",icon: "",action: "wnp.engine3D.paint",items: [],params: {materialType: "luxens",color: {r: .4,g: .12,b: .12}}}, {texture: !0,title: "Rouge-rouge 2",icon: "",action: "wnp.engine3D.paint",items: [],params: {materialType: "luxens",color: {r: .59,g: .06,b: .14}}}, {texture: !0,title: "Rouge-rouge 3",icon: "",action: "wnp.engine3D.paint",items: [],params: {materialType: "luxens",color: {r: .65,g: 0,b: .11}}}, {texture: !0,title: "Rouge-rouge 4",icon: "",action: "wnp.engine3D.paint",items: [],params: {materialType: "luxens",color: {r: .85,g: .07,b: .09}}}, {texture: !0,title: "Rouge-rouge 5",icon: "",action: "wnp.engine3D.paint",items: [],params: {materialType: "luxens",color: {r: .91,g: .16,b: .19}}}, {texture: !0,title: "Rouge-rouge 6",icon: "",action: "wnp.engine3D.paint",items: [],params: {materialType: "luxens",color: {r: .99,g: .88,b: .84}}}, {texture: !0,title: "Rouge corail 1",icon: "",action: "wnp.engine3D.paint",items: [],params: {materialType: "luxens",color: {r: .55,g: .12,b: .13}}}, {texture: !0,title: "Rouge corail 2",icon: "",action: "wnp.engine3D.paint",items: [],params: {materialType: "luxens",color: {r: .69,g: .16,b: .21}}}, {texture: !0,title: "Rouge corail 3",icon: "",action: "wnp.engine3D.paint",items: [],params: {materialType: "luxens",color: {r: .74,g: .15,b: .16}}}, {texture: !0,title: "Rouge corail 4",icon: "",action: "wnp.engine3D.paint",items: [],params: {materialType: "luxens",color: {r: .87,g: .24,b: .25}}}, {texture: !0,title: "Rouge corail 5",icon: "",action: "wnp.engine3D.paint",items: [],params: {materialType: "luxens",color: {r: .92,g: .26,b: .19}}}, {texture: !0,title: "Rouge corail 6",icon: "",action: "wnp.engine3D.paint",items: [],params: {materialType: "luxens",color: {r: 1,g: .54,b: .45}}}, {texture: !0,title: "Orange vitaminé 1",icon: "",action: "wnp.engine3D.paint",items: [],params: {materialType: "luxens",color: {r: .69,g: .21,b: .13}}}, {texture: !0,title: "Orange vitaminé 2",icon: "",action: "wnp.engine3D.paint",items: [],params: {materialType: "luxens",color: {r: .82,g: .18,b: .09}}}, {texture: !0,title: "Orange vitaminé 3",icon: "",action: "wnp.engine3D.paint",items: [],params: {materialType: "luxens",color: {r: 1,g: .23,b: .11}}}, {texture: !0,title: "Orange vitaminé 4",icon: "",action: "wnp.engine3D.paint",items: [],params: {materialType: "luxens",color: {r: 1,g: .31,b: .16}}}, {texture: !0,title: "Orange vitaminé 5",icon: "",action: "wnp.engine3D.paint",items: [],params: {materialType: "luxens",color: {r: 1,g: .38,b: .29}}}, {texture: !0,title: "Orange vitaminé 6",icon: "",action: "wnp.engine3D.paint",items: [],params: {materialType: "luxens",color: {r: 1,g: .81,b: .69}}}, {texture: !0,title: "Orange fusion 1",icon: "",action: "wnp.engine3D.paint",items: [],params: {materialType: "luxens",color: {r: .95,g: .24,b: .07}}}, {texture: !0,title: "Orange fusion 2",icon: "",action: "wnp.engine3D.paint",items: [],params: {materialType: "luxens",color: {r: .81,g: .43,b: .29}}}, {texture: !0,title: "Orange fusion 3",icon: "",action: "wnp.engine3D.paint",items: [],params: {materialType: "luxens",color: {r: .97,g: .37,b: .11}}}, {texture: !0,title: "Orange fusion 4",icon: "",action: "wnp.engine3D.paint",items: [],params: {materialType: "luxens",color: {r: 1,g: .39,b: .15}}}, {texture: !0,title: "Orange fusion 5",icon: "",action: "wnp.engine3D.paint",items: [],params: {materialType: "luxens",color: {r: 1,g: .55,b: .28}}}, {texture: !0,title: "Orange fusion 6",icon: "",action: "wnp.engine3D.paint",items: [],params: {materialType: "luxens",color: {r: 1,g: .65,b: .42}}}, {texture: !0,title: "Orange-orange 1",icon: "",action: "wnp.engine3D.paint",items: [],params: {materialType: "luxens",color: {r: .62,g: .29,b: .11}}}, {texture: !0,title: "Orange-orange 2",icon: "",action: "wnp.engine3D.paint",items: [],params: {materialType: "luxens",color: {r: .76,g: .29,b: .07}}}, {texture: !0,title: "Orange-orange 3",icon: "",action: "wnp.engine3D.paint",items: [],params: {materialType: "luxens",color: {r: .87,g: .38,b: .09}}}, {texture: !0,title: "Orange-orange 4",icon: "",action: "wnp.engine3D.paint",items: [],params: {materialType: "luxens",color: {r: 1,g: .45,b: .04}}}, {texture: !0,title: "Orange-orange 5",icon: "",action: "wnp.engine3D.paint",items: [],params: {materialType: "luxens",color: {r: 1,g: .56,b: .12}}}, {texture: !0,title: "Orange-orange 6",icon: "",action: "wnp.engine3D.paint",items: [],params: {materialType: "luxens",color: {r: 1,g: .74,b: .41}}}, {texture: !0,title: "Orange doré 1",icon: "",action: "wnp.engine3D.paint",items: [],params: {materialType: "luxens",color: {r: .73,g: .33,b: .06}}}, {texture: !0,title: "Orange doré 2",icon: "",action: "wnp.engine3D.paint",items: [],params: {materialType: "luxens",color: {r: .84,g: .45,b: 0}}}, {texture: !0,title: "Orange doré 3",icon: "",action: "wnp.engine3D.paint",items: [],params: {materialType: "luxens",color: {r: .99,g: .48,b: .07}}}, {texture: !0,title: "Orange doré 4",icon: "",action: "wnp.engine3D.paint",items: [],params: {materialType: "luxens",color: {r: 1,g: .56,b: .15}}}, {texture: !0,title: "Orange doré 5",icon: "",action: "wnp.engine3D.paint",items: [],params: {materialType: "luxens",color: {r: 1,g: .56,b: 0}}}, {texture: !0,title: "Orange doré 6",icon: "",action: "wnp.engine3D.paint",items: [],params: {materialType: "luxens",color: {r: 1,g: .82,b: .51}}}, {texture: !0,title: "Jaune solaire 1",icon: "",action: "wnp.engine3D.paint",items: [],params: {materialType: "luxens",color: {r: .96,g: .52,b: .21}}}, {texture: !0,title: "Jaune solaire 2",icon: "",action: "wnp.engine3D.paint",items: [],params: {materialType: "luxens",color: {r: .8,g: .54,b: .16}}}, {texture: !0,title: "Jaune solaire 3",icon: "",action: "wnp.engine3D.paint",items: [],params: {materialType: "luxens",color: {r: 1,g: .63,b: 0}}}, {texture: !0,title: "Jaune solaire 4",icon: "",action: "wnp.engine3D.paint",items: [],params: {materialType: "luxens",color: {r: 1,g: .66,b: .22}}}, {texture: !0,title: "Jaune solaire 5",icon: "",action: "wnp.engine3D.paint",items: [],params: {materialType: "luxens",color: {r: 1,g: .74,b: .29}}}, {texture: !0,title: "Jaune solaire 6",icon: "",action: "wnp.engine3D.paint",items: [],params: {materialType: "luxens",color: {r: 1,g: .89,b: .61}}}, {texture: !0,title: "Jaune pépite 1",icon: "",action: "wnp.engine3D.paint",items: [],params: {materialType: "luxens",color: {r: .67,g: .46,b: .19}}}, {texture: !0,title: "Jaune pépite 2",icon: "",action: "wnp.engine3D.paint",items: [],params: {materialType: "luxens",color: {r: .77,g: .6,b: .34}}}, {texture: !0,title: "Jaune pépite 3",icon: "",action: "wnp.engine3D.paint",items: [],params: {materialType: "luxens",color: {r: .92,g: .62,b: 0}}}, {texture: !0,title: "Jaune pépite 4",icon: "",action: "wnp.engine3D.paint",items: [],params: {materialType: "luxens",color: {r: 1,g: .73,b: .2}}}, {texture: !0,title: "Jaune pépite 5",icon: "",action: "wnp.engine3D.paint",items: [],params: {materialType: "luxens",color: {r: 1,g: .78,b: .38}}}, {texture: !0,title: "Jaune pépite 6",icon: "",action: "wnp.engine3D.paint",items: [],params: {materialType: "luxens",color: {r: .95,g: .88,b: .69}}}, {texture: !0,title: "Jaune louxor 1",icon: "",action: "wnp.engine3D.paint",items: [],params: {materialType: "luxens",color: {r: .77,g: .55,b: .08}}}, {texture: !0,title: "Jaune louxor 2",icon: "",action: "wnp.engine3D.paint",items: [],params: {materialType: "luxens",color: {r: 1,g: .72,b: 0}}}, {texture: !0,title: "Jaune louxor 3",icon: "",action: "wnp.engine3D.paint",items: [],params: {materialType: "luxens",color: {r: .94,g: .72,b: 0}}}, {texture: !0,title: "Jaune louxor 4",icon: "",action: "wnp.engine3D.paint",items: [],params: {materialType: "luxens",color: {r: 1,g: .8,b: .19}}}, {texture: !0,title: "Jaune louxor 5",icon: "",action: "wnp.engine3D.paint",items: [],params: {materialType: "luxens",color: {r: 1,g: .9,b: .4}}}, {texture: !0,title: "Jaune louxor 6",icon: "",action: "wnp.engine3D.paint",items: [],params: {materialType: "luxens",color: {r: .98,g: .86,b: .48}}}, {texture: !0,title: "Jaune-jaune 1",icon: "",action: "wnp.engine3D.paint",items: [],params: {materialType: "luxens",color: {r: .56,g: .4,b: .12}}}, {texture: !0,title: "Jaune-jaune 2",icon: "",action: "wnp.engine3D.paint",items: [],params: {materialType: "luxens",color: {r: .83,g: .68,b: 0}}}, {texture: !0,title: "Jaune-jaune 3",icon: "",action: "wnp.engine3D.paint",items: [],params: {materialType: "luxens",color: {r: .93,g: .69,b: 0}}}, {texture: !0,title: "Jaune-jaune 4",icon: "",action: "wnp.engine3D.paint",items: [],params: {materialType: "luxens",color: {r: .94,g: .73,b: 0}}}, {texture: !0,title: "Jaune-jaune 5",icon: "",action: "wnp.engine3D.paint",items: [],params: {materialType: "luxens",color: {r: .96,g: .87,b: .32}}}, {texture: !0,title: "Jaune-jaune 6",icon: "",action: "wnp.engine3D.paint",items: [],params: {materialType: "luxens",color: {r: .94,g: .91,b: .64}}}, {texture: !0,title: "Jaune anis 1",icon: "",action: "wnp.engine3D.paint",items: [],params: {materialType: "luxens",color: {r: .55,g: .47,b: .14}}}, {texture: !0,title: "Jaune anis 2",icon: "",action: "wnp.engine3D.paint",items: [],params: {materialType: "luxens",color: {r: .71,g: .62,b: .07}}}, {texture: !0,title: "Jaune anis 3",icon: "",action: "wnp.engine3D.paint",items: [],params: {materialType: "luxens",color: {r: .76,g: .81,b: 0}}}, {texture: !0,title: "Jaune anis 4",icon: "",action: "wnp.engine3D.paint",items: [],params: {materialType: "luxens",color: {r: .82,g: .78,b: 0}}}, {texture: !0,title: "Jaune anis 5",icon: "",action: "wnp.engine3D.paint",items: [],params: {materialType: "luxens",color: {r: .91,g: .79,b: .09}}}, {texture: !0,title: "Jaune anis 6",icon: "",action: "wnp.engine3D.paint",items: [],params: {materialType: "luxens",color: {r: .93,g: .91,b: .4}}}, {texture: !0,title: "Vert botanique 1",icon: "",action: "wnp.engine3D.paint",items: [],params: {materialType: "luxens",color: {r: .4,g: .35,b: .23}}}, {texture: !0,title: "Vert botanique 2",icon: "",action: "wnp.engine3D.paint",items: [],params: {materialType: "luxens",color: {r: .48,g: .49,b: .11}}}, {texture: !0,title: "Vert botanique 3",icon: "",action: "wnp.engine3D.paint",items: [],params: {materialType: "luxens",color: {r: .6,g: .58,b: 0}}}, {texture: !0,title: "Vert botanique 4",icon: "",action: "wnp.engine3D.paint",items: [],params: {materialType: "luxens",color: {r: .64,g: .65,b: .21}}}, {texture: !0,title: "Vert botanique 5",icon: "",action: "wnp.engine3D.paint",items: [],params: {materialType: "luxens",color: {r: .71,g: .7,b: .32}}}, {texture: !0,title: "Vert botanique 6",icon: "",action: "wnp.engine3D.paint",items: [],params: {materialType: "luxens",color: {r: .82,g: .78,b: .44}}}, {texture: !0,title: "Vert kaki 1",icon: "",action: "wnp.engine3D.paint",items: [],params: {materialType: "luxens",color: {r: .34,g: .38,b: .25}}}, {texture: !0,title: "Vert kaki 2",icon: "",action: "wnp.engine3D.paint",items: [],params: {materialType: "luxens",color: {r: .45,g: .47,b: .31}}}, {texture: !0,title: "Vert kaki 3",icon: "",action: "wnp.engine3D.paint",items: [],params: {materialType: "luxens",color: {r: .58,g: .58,b: .36}}}, {texture: !0,title: "Vert kaki 4",icon: "",action: "wnp.engine3D.paint",items: [],params: {materialType: "luxens",color: {r: .58,g: .59,b: .31}}}, {texture: !0,title: "Vert kaki 5",icon: "",action: "wnp.engine3D.paint",items: [],params: {materialType: "luxens",color: {r: .67,g: .72,b: .4}}}, {texture: !0,title: "Vert kaki 6",icon: "",action: "wnp.engine3D.paint",items: [],params: {materialType: "luxens",color: {r: .75,g: .78,b: .46}}}, {texture: !0,title: "Vert pistache 1",icon: "",action: "wnp.engine3D.paint",items: [],params: {materialType: "luxens",color: {r: .21,g: .35,b: .19}}}, {texture: !0,title: "Vert pistache 2",icon: "",action: "wnp.engine3D.paint",items: [],params: {materialType: "luxens",color: {r: .32,g: .39,b: .21}}}, {texture: !0,title: "Vert pistache 3",icon: "",action: "wnp.engine3D.paint",items: [],params: {materialType: "luxens",color: {r: .43,g: .62,b: 0}}}, {texture: !0,title: "Vert pistache 4",icon: "",action: "wnp.engine3D.paint",items: [],params: {materialType: "luxens",color: {r: .59,g: .67,b: .13}}}, {texture: !0,title: "Vert pistache 5",icon: "",action: "wnp.engine3D.paint",items: [],params: {materialType: "luxens",color: {r: .72,g: .81,b: .36}}}, {texture: !0,title: "Vert pistache 6",icon: "",action: "wnp.engine3D.paint",items: [],params: {materialType: "luxens",color: {r: .81,g: .89,b: .35}}}, {texture: !0,title: "Vert-vert 1",icon: "",action: "wnp.engine3D.paint",items: [],params: {materialType: "luxens",color: {r: .15,g: .23,b: .17}}}, {texture: !0,title: "Vert-vert 2",icon: "",action: "wnp.engine3D.paint",items: [],params: {materialType: "luxens",color: {r: .33,g: .46,b: .18}}}, {texture: !0,title: "Vert-vert 3",icon: "",action: "wnp.engine3D.paint",items: [],params: {materialType: "luxens",color: {r: .33,g: .62,b: .21}}}, {texture: !0,title: "Vert-vert 4",icon: "",action: "wnp.engine3D.paint",items: [],params: {materialType: "luxens",color: {r: .34,g: .69,b: .13}}}, {texture: !0,title: "Vert-vert 5",icon: "",action: "wnp.engine3D.paint",items: [],params: {materialType: "luxens",color: {r: .56,g: .78,b: .25}}}, {texture: !0,title: "Vert-vert 6",icon: "",action: "wnp.engine3D.paint",items: [],params: {materialType: "luxens",color: {r: .78,g: .84,b: .61}}}, {texture: !0,title: "Vert lagon 1",icon: "",action: "wnp.engine3D.paint",items: [],params: {materialType: "luxens",color: {r: 0,g: .29,b: .24}}}, {texture: !0,title: "Vert lagon 2",icon: "",action: "wnp.engine3D.paint",items: [],params: {materialType: "luxens",color: {r: .13,g: .44,b: .33}}}, {texture: !0,title: "Vert lagon 3",icon: "",action: "wnp.engine3D.paint",items: [],params: {materialType: "luxens",color: {r: 0,g: .58,b: .45}}}, {texture: !0,title: "Vert lagon 4",icon: "",action: "wnp.engine3D.paint",items: [],params: {materialType: "luxens",color: {r: 0,g: .63,b: .55}}}, {texture: !0,title: "Vert lagon 5",icon: "",action: "wnp.engine3D.paint",items: [],params: {materialType: "luxens",color: {r: .22,g: .69,b: .64}}}, {texture: !0,title: "Vert lagon 6",icon: "",action: "wnp.engine3D.paint",items: [],params: {materialType: "luxens",color: {r: .52,g: .83,b: .81}}}, {texture: !0,title: "Vert cèdre 1",icon: "",action: "wnp.engine3D.paint",items: [],params: {materialType: "luxens",color: {r: 0,g: .13,b: .12}}}, {texture: !0,title: "Vert cèdre 2",icon: "",action: "wnp.engine3D.paint",items: [],params: {materialType: "luxens",color: {r: .23,g: .33,b: .3}}}, {texture: !0,title: "Vert cèdre 3",icon: "",action: "wnp.engine3D.paint",items: [],params: {materialType: "luxens",color: {r: .3,g: .47,b: .36}}}, {texture: !0,title: "Vert cèdre 4",icon: "",action: "wnp.engine3D.paint",items: [],params: {materialType: "luxens",color: {r: .42,g: .55,b: .47}}}, {texture: !0,title: "Vert cèdre 5",icon: "",action: "wnp.engine3D.paint",items: [],params: {materialType: "luxens",color: {r: .56,g: .71,b: .69}}}, {texture: !0,title: "Vert cèdre 6",icon: "",action: "wnp.engine3D.paint",items: [],params: {materialType: "luxens",color: {r: .71,g: .82,b: .73}}}, {texture: !0,title: "Bleu baltique 1",icon: "",action: "wnp.engine3D.paint",items: [],params: {materialType: "luxens",color: {r: .18,g: .33,b: .41}}}, {texture: !0,title: "Bleu baltique 2",icon: "",action: "wnp.engine3D.paint",items: [],params: {materialType: "luxens",color: {r: .25,g: .46,b: .54}}}, {texture: !0,title: "Bleu baltique 3",icon: "",action: "wnp.engine3D.paint",items: [],params: {materialType: "luxens",color: {r: .36,g: .56,b: .65}}}, {texture: !0,title: "Bleu baltique 4",icon: "",action: "wnp.engine3D.paint",items: [],params: {materialType: "luxens",color: {r: .33,g: .64,b: .66}}}, {texture: !0,title: "Bleu baltique 5",icon: "",action: "wnp.engine3D.paint",items: [],params: {materialType: "luxens",color: {r: .49,g: .64,b: .64}}}, {texture: !0,title: "Bleu baltique 6",icon: "",action: "wnp.engine3D.paint",items: [],params: {materialType: "luxens",color: {r: .7,g: .78,b: .78}}}, {texture: !0,title: "Bleu atoll 1",icon: "",action: "wnp.engine3D.paint",items: [],params: {materialType: "luxens",color: {r: 0,g: .31,b: .38}}}, {texture: !0,title: "Bleu atoll 2",icon: "",action: "wnp.engine3D.paint",items: [],params: {materialType: "luxens",color: {r: 0,g: .46,b: .5}}}, {texture: !0,title: "Bleu atoll 3",icon: "",action: "wnp.engine3D.paint",items: [],params: {materialType: "luxens",color: {r: .13,g: .55,b: .6}}}, {texture: !0,title: "Bleu atoll 4",icon: "",action: "wnp.engine3D.paint",items: [],params: {materialType: "luxens",color: {r: 0,g: .62,b: .71}}}, {texture: !0,title: "Bleu atoll 5",icon: "",action: "wnp.engine3D.paint",items: [],params: {materialType: "luxens",color: {r: .19,g: .76,b: .78}}}, {texture: !0,title: "Bleu atoll 6",icon: "",action: "wnp.engine3D.paint",items: [],params: {materialType: "luxens",color: {r: .51,g: .73,b: .74}}}, {texture: !0,title: "Bleu turquoise 1",icon: "",action: "wnp.engine3D.paint",items: [],params: {materialType: "luxens",color: {r: 0,g: .2,b: .3}}}, {texture: !0,title: "Bleu turquoise 2",icon: "",action: "wnp.engine3D.paint",items: [],params: {materialType: "luxens",color: {r: 0,g: .38,b: .53}}}, {texture: !0,title: "Bleu turquoise 3",icon: "",action: "wnp.engine3D.paint",items: [],params: {materialType: "luxens",color: {r: 0,g: .48,b: .63}}}, {texture: !0,title: "Bleu turquoise 4",icon: "",action: "wnp.engine3D.paint",items: [],params: {materialType: "luxens",color: {r: .13,g: .62,b: .71}}}, {texture: !0,title: "Bleu turquoise 5",icon: "",action: "wnp.engine3D.paint",items: [],params: {materialType: "luxens",color: {r: .34,g: .65,b: .71}}}, {texture: !0,title: "Bleu turquoise 6",icon: "",action: "wnp.engine3D.paint",items: [],params: {materialType: "luxens",color: {r: .56,g: .81,b: .84}}}, {texture: !0,title: "Bleu cyclades 1",icon: "",action: "wnp.engine3D.paint",items: [],params: {materialType: "luxens",color: {r: 0,g: .33,b: .53}}}, {texture: !0,title: "Bleu cyclades 2",icon: "",action: "wnp.engine3D.paint",items: [],params: {materialType: "luxens",color: {r: 0,g: .32,b: .57}}}, {texture: !0,title: "Bleu cyclades 3",icon: "",action: "wnp.engine3D.paint",items: [],params: {materialType: "luxens",color: {r: 0,g: .49,b: .75}}}, {texture: !0,title: "Bleu cyclades 4",icon: "",action: "wnp.engine3D.paint",items: [],params: {materialType: "luxens",color: {r: .18,g: .5,b: .7}}}, {texture: !0,title: "Bleu cyclades 5",icon: "",action: "wnp.engine3D.paint",items: [],params: {materialType: "luxens",color: {r: .29,g: .6,b: .78}}}, {texture: !0,title: "Bleu cyclades 6",icon: "",action: "wnp.engine3D.paint",items: [],params: {materialType: "luxens",color: {r: .48,g: .76,b: .89}}}, {texture: !0,title: "Bleu-bleu 1",icon: "",action: "wnp.engine3D.paint",items: [],params: {materialType: "luxens",color: {r: 0,g: .14,b: .36}}}, {texture: !0,title: "Bleu-bleu 2",icon: "",action: "wnp.engine3D.paint",items: [],params: {materialType: "luxens",color: {r: 0,g: .21,b: .5}}}, {texture: !0,title: "Bleu-bleu 3",icon: "",action: "wnp.engine3D.paint",items: [],params: {materialType: "luxens",color: {r: .14,g: .38,b: .66}}}, {texture: !0,title: "Bleu-bleu 4",icon: "",action: "wnp.engine3D.paint",items: [],params: {materialType: "luxens",color: {r: .29,g: .52,b: .78}}}, {texture: !0,title: "Bleu-bleu 5",icon: "",action: "wnp.engine3D.paint",items: [],params: {materialType: "luxens",color: {r: .4,g: .57,b: .76}}}, {texture: !0,title: "Bleu-bleu 6",icon: "",action: "wnp.engine3D.paint",items: [],params: {materialType: "luxens",color: {r: .53,g: .72,b: .87}}}, {texture: !0,title: "Bleu orageux 1",icon: "",action: "wnp.engine3D.paint",items: [],params: {materialType: "luxens",color: {r: .06,g: .11,b: .25}}}, {texture: !0,title: "Bleu orageux 2",icon: "",action: "wnp.engine3D.paint",items: [],params: {materialType: "luxens",color: {r: .24,g: .27,b: .36}}}, {texture: !0,title: "Bleu orageux 3",icon: "",action: "wnp.engine3D.paint",items: [],params: {materialType: "luxens",color: {r: .19,g: .25,b: .56}}}, {texture: !0,title: "Bleu orageux 4",icon: "",action: "wnp.engine3D.paint",items: [],params: {materialType: "luxens",color: {r: .25,g: .31,b: .57}}}, {texture: !0,title: "Bleu orageux 5",icon: "",action: "wnp.engine3D.paint",items: [],params: {materialType: "luxens",color: {r: .53,g: .63,b: .78}}}, {texture: !0,title: "Bleu orageux 6",icon: "",action: "wnp.engine3D.paint",items: [],params: {materialType: "luxens",color: {r: .62,g: .69,b: .8}}}, {texture: !0,title: "Violet-violet 1",icon: "",action: "wnp.engine3D.paint",items: [],params: {materialType: "luxens",color: {r: .22,g: .19,b: .28}}}, {texture: !0,title: "Violet-violet 2",icon: "",action: "wnp.engine3D.paint",items: [],params: {materialType: "luxens",color: {r: .29,g: .22,b: .36}}}, {texture: !0,title: "Violet-violet 3",icon: "",action: "wnp.engine3D.paint",items: [],params: {materialType: "luxens",color: {r: .4,g: .18,b: .44}}}, {texture: !0,title: "Violet-violet 4",icon: "",action: "wnp.engine3D.paint",items: [],params: {materialType: "luxens",color: {r: .5,g: .32,b: .57}}}, {texture: !0,title: "Violet-violet 5",icon: "",action: "wnp.engine3D.paint",items: [],params: {materialType: "luxens",color: {r: .69,g: .49,b: .73}}}, {texture: !0,title: "Violet-violet 6",icon: "",action: "wnp.engine3D.paint",items: [],params: {materialType: "luxens",color: {r: .77,g: .71,b: .85}}}, {texture: !0,title: "Violet tulipe 1",icon: "",action: "wnp.engine3D.paint",items: [],params: {materialType: "luxens",color: {r: .24,g: .17,b: .25}}}, {texture: !0,title: "Violet tulipe 2",icon: "",action: "wnp.engine3D.paint",items: [],params: {materialType: "luxens",color: {r: .37,g: .25,b: .36}}}, {texture: !0,title: "Violet tulipe 3",icon: "",action: "wnp.engine3D.paint",items: [],params: {materialType: "luxens",color: {r: .48,g: .18,b: .41}}}, {texture: !0,title: "Violet tulipe 4",icon: "",action: "wnp.engine3D.paint",items: [],params: {materialType: "luxens",color: {r: .62,g: .29,b: .59}}}, {texture: !0,title: "Violet tulipe 5",icon: "",action: "wnp.engine3D.paint",items: [],params: {materialType: "luxens",color: {r: .73,g: .47,b: .68}}}, {texture: !0,title: "Violet tulipe 6",icon: "",action: "wnp.engine3D.paint",items: [],params: {materialType: "luxens",color: {r: .81,g: .7,b: .82}}}, {texture: !0,title: "Violet aubergine 1",icon: "",action: "wnp.engine3D.paint",items: [],params: {materialType: "luxens",color: {r: .22,g: .11,b: .16}}}, {texture: !0,title: "Violet aubergine 2",icon: "",action: "wnp.engine3D.paint",items: [],params: {materialType: "luxens",color: {r: .37,g: .2,b: .33}}}, {texture: !0,title: "Violet aubergine 3",icon: "",action: "wnp.engine3D.paint",items: [],params: {materialType: "luxens",color: {r: .48,g: .35,b: .4}}}, {texture: !0,title: "Violet aubergine 4",icon: "",action: "wnp.engine3D.paint",items: [],params: {materialType: "luxens",color: {r: .55,g: .43,b: .49}}}, {texture: !0,title: "Violet aubergine 5",icon: "",action: "wnp.engine3D.paint",items: [],params: {materialType: "luxens",color: {r: .69,g: .58,b: .64}}}, {texture: !0,title: "Violet aubergine 6",icon: "",action: "wnp.engine3D.paint",items: [],params: {materialType: "luxens",color: {r: .72,g: .65,b: .71}}}, {texture: !0,title: "Violet figue 1",icon: "",action: "wnp.engine3D.paint",items: [],params: {materialType: "luxens",color: {r: .35,g: .14,b: .22}}}, {texture: !0,title: "Violet figue 2",icon: "",action: "wnp.engine3D.paint",items: [],params: {materialType: "luxens",color: {r: .46,g: .18,b: .33}}}, {texture: !0,title: "Violet figue 3",icon: "",action: "wnp.engine3D.paint",items: [],params: {materialType: "luxens",color: {r: .47,g: .13,b: .31}}}, {texture: !0,title: "Violet figue 4",icon: "",action: "wnp.engine3D.paint",items: [],params: {materialType: "luxens",color: {r: .52,g: .3,b: .39}}}, {texture: !0,title: "Violet figue 5",icon: "",action: "wnp.engine3D.paint",items: [],params: {materialType: "luxens",color: {r: .62,g: .4,b: .49}}}, {texture: !0,title: "Violet figue 6",icon: "",action: "wnp.engine3D.paint",items: [],params: {materialType: "luxens",color: {r: .86,g: .62,b: .77}}}, {texture: !0,title: "Rose antique 1",icon: "",action: "wnp.engine3D.paint",items: [],params: {materialType: "luxens",color: {r: .29,g: .13,b: .16}}}, {texture: !0,title: "Rose antique 2",icon: "",action: "wnp.engine3D.paint",items: [],params: {materialType: "luxens",color: {r: .42,g: .15,b: .22}}}, {texture: !0,title: "Rose antique 3",icon: "",action: "wnp.engine3D.paint",items: [],params: {materialType: "luxens",color: {r: .59,g: .21,b: .36}}}, {texture: !0,title: "Rose antique 4",icon: "",action: "wnp.engine3D.paint",items: [],params: {materialType: "luxens",color: {r: .74,g: .45,b: .55}}}, {texture: !0,title: "Rose antique 5",icon: "",action: "wnp.engine3D.paint",items: [],params: {materialType: "luxens",color: {r: .82,g: .64,b: .64}}}, {texture: !0,title: "Rose antique 6",icon: "",action: "wnp.engine3D.paint",items: [],params: {materialType: "luxens",color: {r: .95,g: .84,b: .84}}}, {texture: !0,title: "Rose-rose 1",icon: "",action: "wnp.engine3D.paint",items: [],params: {materialType: "luxens",color: {r: .49,g: .09,b: .31}}}, {texture: !0,title: "Rose-rose 2",icon: "",action: "wnp.engine3D.paint",items: [],params: {materialType: "luxens",color: {r: .67,g: .11,b: .38}}}, {texture: !0,title: "Rose-rose 3",icon: "",action: "wnp.engine3D.paint",items: [],params: {materialType: "luxens",color: {r: .69,g: .28,b: .51}}}, {texture: !0,title: "Rose-rose 4",icon: "",action: "wnp.engine3D.paint",items: [],params: {materialType: "luxens",color: {r: .82,g: .3,b: .6}}}, {texture: !0,title: "Rose-rose 5",icon: "",action: "wnp.engine3D.paint",items: [],params: {materialType: "luxens",color: {r: .92,g: .44,b: .69}}}, {texture: !0,title: "Rose-rose 6",icon: "",action: "wnp.engine3D.paint",items: [],params: {materialType: "luxens",color: {r: .95,g: .69,b: .8}}}, {texture: !0,title: "Rose shocking 1",icon: "",action: "wnp.engine3D.paint",items: [],params: {materialType: "luxens",color: {r: .46,g: .07,b: .2}}}, {texture: !0,title: "Rose shocking 2",icon: "",action: "wnp.engine3D.paint",items: [],params: {materialType: "luxens",color: {r: .75,g: .18,b: .37}}}, {texture: !0,title: "Rose shocking 3",icon: "",action: "wnp.engine3D.paint",items: [],params: {materialType: "luxens",color: {r: .75,g: .12,b: .36}}}, {texture: !0,title: "Rose shocking 4",icon: "",action: "wnp.engine3D.paint",items: [],params: {materialType: "luxens",color: {r: .89,g: .25,b: .42}}}, {texture: !0,title: "Rose shocking 5",icon: "",action: "wnp.engine3D.paint",items: [],params: {materialType: "luxens",color: {r: .97,g: .53,b: .71}}}, {texture: !0,title: "Rose shocking 6",icon: "",action: "wnp.engine3D.paint",items: [],params: {materialType: "luxens",color: {r: .95,g: .71,b: .76}}}];
    return t
}(), OutsideComponent3D = function() {
    var t = function(t) {
        BaseComponent3D.call(this, t, "OutsideComponent3D")
    };
    t.prototype = new BaseComponent3D, t.prototype.initialize = function() {
        var t = {title: _("Ground"),id: "ground",items: e,layout: "layout-table-60"}, i = {title: _("Sky"),id: "sky",items: n,layout: "layout-table-60"}, o = {title: _("Outside"),id: "outside",items: [t, i],layout: "layout-list"};
        ujs.notify("wnp.menu.main.add", {item: o,menuPath: "decorate3D",position: 1e3})
    };
    var e = [{title: "Grid (default)",texture: !0,icon: "",action: "wnp.engine3D.changeGround",id: "0",items: [],params: {materialType: "wnp.MattMaterial",url: "textures/textureset/ground/ground01.jpg",id: "0"}}, {title: "Macadam",texture: !0,icon: "",action: "wnp.engine3D.changeGround",id: "1",items: [],params: {materialType: "wnp.MattMaterial",url: "textures/textureset/ground/ground02.jpg",id: "1"}}, {title: "Soil",texture: !0,icon: "",action: "wnp.engine3D.changeGround",id: "2",items: [],params: {materialType: "wnp.MattMaterial",url: "textures/textureset/ground/ground03.jpg",id: "2"}}, {title: "Grass",texture: !0,icon: "",action: "wnp.engine3D.changeGround",id: "3",items: [],params: {materialType: "wnp.MattMaterial",url: "textures/textureset/ground/ground04.jpg",id: "3"}}, {title: "Grass 2",texture: !0,icon: "",action: "wnp.engine3D.changeGround",id: "4",items: [],params: {materialType: "wnp.MattMaterial",url: "textures/textureset/ground/ground05.jpg",id: "4"}}, {title: "Grass 3",texture: !0,icon: "",action: "wnp.engine3D.changeGround",id: "5",items: [],params: {materialType: "wnp.MattMaterial",url: "textures/textureset/ground/ground06.jpg"}}, {title: "Grass 4",texture: !0,icon: "",action: "wnp.engine3D.changeGround",id: "6",items: [],params: {materialType: "wnp.MattMaterial",url: "textures/textureset/ground/ground07.jpg"}}, {title: "Grass 5",texture: !0,icon: "",action: "wnp.engine3D.changeGround",id: "7",items: [],params: {materialType: "wnp.MattMaterial",url: "textures/textureset/ground/ground08.jpg"}}, {title: "Grass 6",texture: !0,icon: "",action: "wnp.engine3D.changeGround",id: "8",items: [],params: {materialType: "wnp.MattMaterial",url: "textures/textureset/ground/ground09.jpg"}}, {title: "Soil",texture: !0,icon: "",action: "wnp.engine3D.changeGround",id: "9",items: [],params: {materialType: "wnp.MattMaterial",url: "textures/textureset/ground/ground10.jpg"}}, {title: "Gray gravel",texture: !0,icon: "",action: "wnp.engine3D.changeGround",id: "10",items: [],params: {materialType: "wnp.MattMaterial",url: "textures/textureset/ground/ground11.jpg"}}, {title: "Brick",texture: !0,icon: "",action: "wnp.engine3D.changeGround",id: "11",items: [],params: {materialType: "wnp.MattMaterial",url: "textures/textureset/ground/ground12.jpg"}}, {title: "Brick 2",texture: !0,icon: "",action: "wnp.engine3D.changeGround",id: "12",items: [],params: {materialType: "wnp.MattMaterial",url: "textures/textureset/ground/ground13.jpg"}}, {title: "Brick 3",texture: !0,icon: "",action: "wnp.engine3D.changeGround",id: "13",items: [],params: {materialType: "wnp.MattMaterial",url: "textures/textureset/ground/ground14.jpg"}}, {title: "Brick 4",texture: !0,icon: "",action: "wnp.engine3D.changeGround",id: "14",items: [],params: {materialType: "wnp.MattMaterial",url: "textures/textureset/ground/ground15.jpg"}}], n = [{title: "Default sky",texture: !0,icon: "",action: "wnp.engine3D.changeSky",id: "0",items: [],params: {materialType: "lambert",url: "textures/textureset/sky/sky01.jpg"}}, {title: "Sky 1",texture: !0,icon: "",action: "wnp.engine3D.changeSky",id: "1",items: [],params: {materialType: "lambert",url: "textures/textureset/sky/sky02.jpg"}}, {title: "Sky 2",texture: !0,icon: "",action: "wnp.engine3D.changeSky",id: "2",items: [],params: {materialType: "lambert",url: "textures/textureset/sky/sky03.jpg"}}, {title: "Sky 3",texture: !0,icon: "",action: "wnp.engine3D.changeSky",id: "3",items: [],params: {materialType: "lambert",url: "textures/textureset/sky/sky04.jpg"}}];
    return t
}(), ObjectComponent3D = function() {
    function t(t) {
        t.traverse(function(t) {
            wanaplan.engine3D.castShadows(t), t.receiveShadows = !0
        })
    }
    var e, n = (new BABYLON.Vector3(50, 50, 50), new BABYLON.Vector3(0, 0, 0), "js/Components/CoreComponents/Object/Programmable/"), i = null, o = -1, r = (ujs.getById("container3d"), function(t) {
        BaseComponent3D.call(this, t, "ObjectComponent3D"), i = t.version, e = this
    });
    return r.prototype = new BaseComponent3D, r.prototype.initialize = function() {
        wnp.Constants.PRODUCTS_CATEGORY_FILE && ujs.ajax({url: wnp.Constants.PRODUCTS_CATEGORY_FILE,method: "GET",params: ["t=", Math.round(100 * Math.random())].join(""),success: function(t) {
                try {
                    productsMenu = JSON.parse(t), ujs.notify("wnp.menu.main.add", {item: productsMenu,menuPath: "1",position: 0})
                } catch (e) {
                    Logger.message("BAD JSON FILE")
                }
            }.bind(this)})
    }, r.prototype.onFloorReady = function(t) {
        for (var n = t.floor || e.getFloor(), i = t.structure || wanaplan.getSelectedStructure(), o = i.getElements("objects"), r = 0; r < o.length; r++)
            o[r].isRecentlyAdded = !1, e.buildObject(o[r], o[r].programmableInstance, n)
    }, r.prototype.loadProgrammableFile = function(t, e, o) {
        var r = e || t + ".js";
        "undefined" == typeof wnp.Programmable[t] ? HTMLHelper.addScript(n + r + "?t=" + i, void 0, o) : o(void 0)
    }, r.prototype.startListening = function() {
        document.addEventListener("wnp.request.floorSelected", this.onFloorChanged, !1), document.addEventListener("wnp.engine3d.floorReady", this.onFloorReady, !1), document.addEventListener("wnp.engine3D.addObject", this.onAddObject, !1), document.addEventListener("wnp.engine3D.addGroup", this.onAddGroup, !1), document.addEventListener("wnp.engine3D.addProgrammable", this.onAddObject, !1), document.addEventListener("wnp.engine3D.object.remove", this.onRemoveObject, !1)
    }, r.prototype.stopListening = function() {
        document.removeEventListener("wnp.request.floorSelected", this.onFloorChanged, !1), document.removeEventListener("wnp.engine3d.floorReady", this.onFloorReady, !1), document.removeEventListener("wnp.engine3D.addObject", this.onAddObject), document.removeEventListener("wnp.engine3D.addGroup", this.onAddGroup), document.removeEventListener("wnp.engine3D.addProgrammable", this.onAddObject, !1), document.removeEventListener("wnp.engine3D.object.remove", this.onRemoveObject, !1)
    }, r.prototype.onAddGroup = function(t) {
        var n = t.objectParams, i = JSON.parse(n.params), o = JSON.parse(n.materials), r = (new Date).getTime(), s = e.getFloor(), a = wanaplan.getComponentByName("AvatarComponent3D", this.engine3D), l = a.avatar.position.clone();
        l.y -= 5 + +s.position.y;
        for (var h in i)
            t.objectType = i[h].type || "programmable", i[h].position.z *= -1, t.position = l.add(i[h].position), t.rotation = i[h].rotation, t.objectParams = {params: i[h].params,builder_id: i[h].builder_id,path: i[h].filename,materials: JSON.stringify(o[h]),customData: {groupId: r}}, e.onAddObject(t)
    }, r.prototype.onAddObject = function(t) {
        var n = wanaplan.getSelectedStructure(), i = e.getFloor(), o = t.objectParams, r = new ObjectStructure;
        if (r.builderId = o.builder_id, "string" == typeof o.params && "" !== o.params && (o.params = JSON.parse(o.params)), "string" == typeof o.materials && "" !== o.materials && (o.materials = "[]" === o.materials ? {} : ujs.deserializeObject(JSON.parse(o.materials))), o.customData && (r.customData = o.customData), r.filename = o.path, r.baseUrl = o.baseUrl || null, t.position)
            r.position.x = t.position.x, r.position.y = t.position.y, r.position.z = t.position.z;
        else {
            var s = wanaplan.getComponentByName("AvatarComponent3D", this.engine3D);
            avatarPosition = s.avatar.position, r.position.x = avatarPosition.x, r.position.z = avatarPosition.z, r.position.y += 5
        }
        t.rotation && (r.rotation.x = t.rotation.x, r.rotation.y = t.rotation.y, r.rotation.z = t.rotation.z), n.insertElement("objects", r), r.isRecentlyAdded = !0, e.buildObject(r, o, i)
    }, r.prototype.onRemoveObject = function(t) {
        for (var e, n = 0; n < wanaplan.structure.getLength(); n++)
            e = wanaplan.structure.getElement(n), e.removeElement("objects", t.structure)
    }, r.prototype.refreshObject = function(t, e) {
        for (var n = t.structure.programmableInstance, i = (t.getFloor(), t.getChildren()), o = i.length; o--; )
            i[o].dispose();
        this.buildObject(t.structure, n, t.parent, function(n) {
            t.position = n.position, t.rotation = n.rotation, t.parent = n.parent;
            for (var i = n.getVerticesDataKinds(), o = i.length; o--; )
                t.setVerticesData(i[o], n.getVerticesData(i[o]).slice());
            if (t.setIndices(n.getIndices().slice()), n._vertexBuffers) {
                var r = BABYLON.Tools.ExtractMinAndMax(n.getVerticesData(BABYLON.VertexBuffer.PositionKind), 0, n.getTotalVertices());
                t._boundingInfo = new BABYLON.BoundingInfo(r.minimum, r.maximum)
            }
            t.material = n.material;
            for (var s = n.getChildren(), o = s.length; o--; )
                s[o].parent = t;
            t.computeWorldMatrix(!0), t.getBoundingBox(!0), n.silentDispose = !0, n.dispose(), n.silentDispose = !1, ujs.notify("wnp.engine3D.object.refresh", {object: t}), e && e(t)
        }, !0)
    }, r.prototype.buildObject = function(t, n, i, o, r) {
        var s, o = o || function() {
        }, i = i || e.getFloor();
        t.programmableInstance ? s = t.programmableInstance.materials : n.materials && (s = n.materials);
        var a, l = function(n) {
            return n ? (t.programmableInstance = a, t.objectInstance = n, void e.addObjectToScene(n, t, i, o, r)) : (Logger.warning("[ObjectComponent3D] onObject3dLoaded : unable to build the following object : "), void Logger.warning(a))
        }, h = t.baseUrl || null;
        t.filename && wnp.Programmable.createInstance(t.filename, n, s, t, function(t) {
            if (a = t, a.async)
                a.getObject3D(wanaplan.engine3D.scene, l);
            else {
                var e = a.getObject3D(wanaplan.engine3D.scene);
                l(e)
            }
        }, h, e.engine3D)
    }, r.prototype.addObjectToScene = function(t, n, i, o, r) {
        var o = o || function() {
        };
        return e.prepareObject3D(t, n, i), o(t), r || ujs.notify("wnp.engine3D.object.create", {object: t,objectStructure: n}), t
    }, r.prototype.prepareObject3D = function(n, i, r) {
        n.structure = i, n.name = "Object_" + ++o, i.id = o, n.parent = r, n.position.copyFrom(i.position), n.rotation.copyFrom(i.rotation), n.scaling.copyFrom(i.scaling), i.position = n.position, i.rotation = n.rotation, i.scaling = n.scaling, i.position.x = +i.position.x, i.position.y = +i.position.y, i.position.z = +i.position.z, i.rotationQuaternion && (n.rotationQuaternion = i.rotationQuaternion), n.structure.group && (n.parent = n.structure.group, n.changeFrame(r)), n.computeWorldMatrix(!0), r.markAsDirty(), n.isDecorable = !0, n.decorate = i.programmableInstance.decorate.bind(n), n.animate = i.programmableInstance.animate.bind(i.programmableInstance);
        var s = i.programmableInstance.materials;
        if (i.programmableInstance.getDefaultMaterials) {
            var a = i.programmableInstance.getDefaultMaterials(wanaplan.engine3D.scene);
            s = ujs.mergeObjects(a, i.programmableInstance.materials)
        }
        n.initMaterials(s), n.onDispose = function() {
            n.silentDispose || ujs.notify("wnp.engine3D.object.dispose", {object: n})
        }, t(n);
        var l = wanaplan.getComponentByName("EditionComponent3D");
        return l && e.getFloor().structureId == r.structureId && l.addDraggable(n), n
    }, r
}(), EditionComponent3D = function() {
    var t = null, e = !1, n = -1, i = null, o = !1, r = 1, s = 2, a = 4, l = 8, h = [], c = function(e) {
        BaseComponent3D.call(this, e, "EditionComponent3D"), t = this, this.scene = wanaplan.engine3D.scene, this.camera = wanaplan.engine3D.camera, this.rotatorWidget = new wnp.Widget.Rotator(this), this.infoWidget = new wnp.Widget.Info(this), this.infoWidget.setClickCallback(this.onIAction.bind(this)), this.elevationWidget = new wnp.Widget.Elevation(this), this.widgets = [], this.widgets.push(this.rotatorWidget), this.widgets.push(this.infoWidget), this.widgets.push(this.elevationWidget), this.dragControl = new wnp.DragControls(this.scene, wanaplan.engine3D.canvas), this.dragControl.constrains("xz"), this.addUnremovableDraggable = this.dragControl.addUnremovableDraggable, this.addDraggable = this.dragControl.addDraggable, this.removeDraggable = this.dragControl.removeDraggable, this.resetDraggable = this.dragControl.resetDraggable
    };
    c.prototype = new BaseComponent3D, c.prototype.addWidget = function(t) {
        return this.widgets.push(t), t
    }, c.prototype.on = function(e, n) {
        return h[e] || (h[e] = []), h[e].push(n), t
    }, c.prototype.off = function(e, n) {
        var i = h[e];
        return i ? (i.indexOf(n) > -1 && i.splice(n, 1), t) : t
    };
    var u = function(t, e) {
        var n = h[t];
        if (n)
            for (var i = 0; i < n.length; i++)
                n[i](e)
    };
    c.prototype.initialize = function() {
        this.ephemeralInfos = document.getElementById("ephemeralInfos"), this.historycmp = null, this.MOVEACTION = 0, this.ROTATEACTION = 1, this.GROUPACTION = 3, this.DELETEACTION = 4, this.ADDACTION = 5, this.isViewer || (this.dragControl.on("mousedown", function(e) {
            e.hit && (t.camera.enabled = !1, ujs.notify("wnp.engine3D.editorComponent.hideEditBox"))
        }, !1), this.dragControl.on("mouseup", function() {
            t.camera.enabled = !0
        }, !1)), this.setupHistory()
    }, c.prototype.startListening = function() {
        this.onMouseDown = this.onMouseDown.bind(this), this.onMouseMove = this.onMouseMove.bind(this), this.onMouseUp = this.onMouseUp.bind(this), this.onClick = this.onClick.bind(this), this.onDoubleClick = this.onDoubleClick.bind(this), this.onGroup = this.onGroup.bind(this), this.onKeyDown = this.onKeyDown.bind(this), this.onCloneObject = this.onCloneObject.bind(this), this.onAddToProducts = this.onAddToProducts.bind(this), this.onRemoveObject = this.onRemoveObject.bind(this), this.onCreateObject = this.onCreateObject.bind(this), this.onDisposeObject = this.onDisposeObject.bind(this), this.onFloorChanged = this.onFloorChanged.bind(this), this.onNewPlan = this.onNewPlan.bind(this), this.onDragEnd = this.onDragEnd.bind(this), this.onDragging = this.onDragging.bind(this), this.onDragStart = this.onDragStart.bind(this), wanaplan.engine3D.canvas.addEventListener("pointerdown", this.onMouseDown, !1), wanaplan.engine3D.canvas.addEventListener("pointermove", this.onMouseMove, !1), wanaplan.engine3D.canvas.addEventListener("pointerup", this.onMouseUp, !1), this.dragControl.on("dragstart", this.onDragStart), this.dragControl.on("drag", this.onDragging), this.dragControl.on("dragend", this.onDragEnd), document.addEventListener("wnp.engine3D.click.collided", this.onClick, !1), document.addEventListener("wnp.engine3D.dblclick.collided", this.onDoubleClick, !1), document.addEventListener("wnp.engine3D.contextMenu.group", this.onGroup, !1), document.addEventListener("wnp.keyboardManager.keyDown", this.onKeyDown, !0), document.addEventListener("wnp.request.object.clone", this.onCloneObject, !1), document.addEventListener("wnp.request.object.addToProducts", this.onAddToProducts, !1), document.addEventListener("wnp.request.object.remove", this.onRemoveObject, !1), document.addEventListener("wnp.engine3D.object.create", this.onCreateObject, !1), document.addEventListener("wnp.engine3D.object.refresh", this.onRefreshObject, !1), document.addEventListener("wnp.engine3D.object.dispose", this.onDisposeObject, !1), document.addEventListener("wnp.engine3d.globaleFloorReady", this.onFloorChanged, !1), document.addEventListener("wnp.request.newPlanReady", this.onNewPlan, !1)
    }, c.prototype.stopListening = function() {
        wanaplan.engine3D.canvas.removeEventListener("pointerdown", this.onMouseDown), wanaplan.engine3D.canvas.removeEventListener("pointermove", this.onMouseMove, !1), wanaplan.engine3D.canvas.removeEventListener("pointerup", this.onMouseUp, !1), this.dragControl.off("dragstart", this.onDragStart), this.dragControl.off("drag", this.onDragging), this.dragControl.off("dragend", this.onDragEnd), document.removeEventListener("wnp.engine3D.click.collided", this.onClick, !1), document.removeEventListener("wnp.engine3D.dblclick.collided", this.onDoubleClick, !1), document.removeEventListener("wnp.engine3D.contextMenu.group", this.onGroup, !1), document.removeEventListener("wnp.keyboardManager.keyDown", this.onKeyDown, !0), document.removeEventListener("wnp.request.object.clone", this.onCloneObject, !1), document.removeEventListener("wnp.request.object.addToProducts", this.onAddToProducts, !1), document.removeEventListener("wnp.request.object.remove", this.onRemoveObject, !1), document.removeEventListener("wnp.engine3D.object.create", this.onCreateObject, !1), document.removeEventListener("wnp.engine3D.object.dispose", this.onDisposeObject, !1), document.removeEventListener("wnp.engine3d.globaleFloorReady", this.onFloorChanged, !1), document.removeEventListener("wnp.request.newPlan", this.onNewPlan, !1)
    }, c.prototype.onIAction = function() {
        var t = this.getSelectedObject();
        ujs.notify(this.isGroup(t) ? "wnp.request.groupConfigurator.start" : "wnp.request.configurator.start")
    }, c.prototype.onMouseDown = function(t) {
        t.collided = wanaplan.engine3D.collideWithScene(t.clientX, t.clientY), u("mousedown", t);
        var e = wanaplan.engine3D.keyboardManager.isPressed([17, 91, 224]);
        this.dragControl.constrains(e ? "y" : "xz")
    }, c.prototype.onMouseUp = function(t) {
        u("mouseup", t)
    }, c.prototype.onMouseMove = function(t) {
        u("mousemove", t)
    }, c.prototype.onDragStart = function(t) {
        var e = t.pickedMesh;
        t.oldPosition = e.position.clone(), t.oldRotation = e.rotation.clone(), u("dragstart", {object: e})
    }, c.prototype.onDragEnd = function(e) {
        var n = e.pickedMesh;
        u("dragend", {object: n}), t.ephemeralInfos.classList.add("hidden");
        var i = n.getTopLevelObject(!0);
        ujs.notify("wnp.request.historyAction", {component: t,object: i,params: {oldPosition: e.oldPosition,newPosition: n.position.clone(),oldRotation: e.oldRotation,newRotation: n.rotation.clone()},action: t.MOVEACTION})
    }, c.prototype.onDragging = function(e) {
        var n = e.pickedMesh;
        u("dragging", {object: n});
        var i = n.position, o = "<table>";
        o += "<tr>", o += "<td>x: " + Math.round(i.x) + "</td>", o += "<td>z: " + Math.round(i.z) + "</td>", o += "<td>" + _("elevation:") + Math.round(i.y) + "</td>", o += "</tr>", t.ephemeralInfos.innerHTML = o, t.ephemeralInfos.classList.remove("hidden")
    }, c.prototype.onClick = function(n) {
        if (this.engine3D.mode == this.engine3D.MODE_NORMAL && (u("click", n), !o)) {
            var i = n.collided;
            if (i && i.hit) {
                t.dragControl.setDraggingMode(t.dragControl.GROUPS);
                var r = wanaplan.engine3D.keyboardManager.isPressed([17, 91, 224]), s = i.pickedMesh.getTopLevelObject();
                if (this.isGroup(s) || this.isSelectableObject(s)) {
                    if (r)
                        this.addToGroup(s, this.getSelectedObject()), this.deselectObject(), s = i.pickedMesh.getTopLevelObject();
                    else {
                        var a = i.pickedMesh.getTopLevelObject(!0);
                        (a.parent === this.getSelectedObject() || a === this.getSelectedObject()) && (this.deselectObject(), s = a, t.dragControl.setDraggingMode(t.dragControl.OBJECTS))
                    }
                    this.centerGroup(s), this.selectObject(s), 2 == n.button && u("special")
                } else
                    this.deleteGroup(), this.deselectObject();
                s !== e && this.deleteGroup()
            }
        }
    }, c.prototype.onDoubleClick = function(t) {
        var e = t.collided ? t.collided.pickedMesh.getTopLevelObject(!0) : null, n = e ? e.animate : null;
        n && n(e, t.collided.pickedMesh)
    }, c.prototype.onKeyDown = function(e) {
        var n = wanaplan.engine3D.keyboardManager.isPressed([17, 91, 224]);
        n && i && 68 == e.keyCode && t.onCloneObject(), 46 == e.keyCode && t.getSelectedObject() && ujs.notify("wnp.request.object.remove", {object: t.getSelectedObject(),structure: t.getSelectedObject().structure})
    }, c.prototype.onRemoveObject = function(e) {
        t.removeObject(e.object || t.getSelectedObject())
    }, c.prototype.onNewPlan = function() {
        t.deselectObject()
    }, c.prototype.onCreateObject = function(e) {
        var n, i = e.objectStructure.customData.groupId, o = e.object.getFloor();
        void 0 !== i && null !== i ? (n = o.getChildByName("group_" + i), n || (n = t.createGroup(i, o), e.object.structure.isRecentlyAdded && this.addHistory(n, {floor: o,isGroup: !0}, t.ADDACTION)), t.addToGroup(e.object, n, !0), t.setGroupId(e.object, i)) : e.object.structure.isRecentlyAdded && this.addHistory(e.object, {floor: o}, t.ADDACTION), e.object.traverse(function(t) {
            t.isVisible && (t.wasVisible = !0)
        })
    }, c.prototype.onRefreshObject = function(t) {
        t.object === i && u("refresh", t)
    }, c.prototype.onDisposeObject = function(t) {
        u("dispose", t.object), t.object === i && this.deselectObject()
    }, c.prototype.onFloorChanged = function() {
        t.deselectObject(), t.resetDraggable()
    }, c.prototype.lock = function(e, n) {
        o && o !== e || (n = "undefined" != typeof n ? n : s + r + a + l, n & s && (this.dragControl.enabled = !1, this.dragControl.reset()), n & r && (this.camera.enabled = !1), n & l && (t.camera.cameraTranslationenabled = !1), wanaplan.keyboardManager && n & a && (wanaplan.keyboardManager.preventDefault = !1), o = e)
    }, c.prototype.unlock = function(e, n) {
        o && o !== e && e !== this || (n = "undefined" != typeof n ? n : s + r + a + l, n & s && (this.dragControl.enabled = !0, this.dragControl.reset()), n & r && (this.camera.enabled = !0), n & l && (t.camera.cameraTranslationenabled = !0), wanaplan.keyboardManager && n & a && (wanaplan.keyboardManager.preventDefault = !0), o = null)
    }, c.prototype.disableWidget = function() {
        u("deselectObject")
    }, c.prototype.enableWidget = function() {
        i && u("selectObject", {object: i})
    }, c.prototype.getLocker = function() {
        return o
    }, c.prototype.isGroup = function(t) {
        return -1 !== t.name.indexOf("group_")
    }, c.prototype.isVirtualGroup = function(t) {
        return t && t.name.indexOf("group_virtual") >= 0
    }, c.prototype.isSelectableObject = function(t) {
        return -1 !== t.name.indexOf("Object_")
    }, c.prototype.getSelectedObject = function() {
        return i
    }, c.prototype.selectObject = function(t) {
        i = t, u("selectObject", {object: t})
    }, c.prototype.deselectObject = function() {
        u("deselectObject"), i = null
    }, c.prototype.moveObject = function(e, n) {
        if (t.isSelectableObject(e) || t.isGroup(e)) {
            e.position.addInPlace(n);
            var i = e.getFloor();
            i && i.markAsDirty(), u("objectMoves", {object: e,delta: n}), ujs.notify("wnp.engine3D.object.translate", {object: e})
        }
    }, c.prototype.rotateObject = function(e, n) {
        (t.isSelectableObject(e) || t.isGroup(e)) && (e.rotation.addInPlace(n), u("objectRotates", {object: e,delta: n}), ujs.notify("wnp.engine3D.object.rotate", {object: e}))
    };
    var p = function(e, n) {
        var i = n.pickedMesh.material.subMaterials ? n.pickedMesh.material.subMaterials[n.pickedSubMeshIndex] : n.pickedMesh.material;
        if (t.isGroup(this))
            for (var o = this.getChildren(), r = 0, s = o.length; s > r; r++)
                o[r].decorate && o[r].decorate(e, n);
        return i
    };
    return c.prototype.createGroup = function(e, i) {
        var o;
        return null !== e && void 0 !== e ? (o = new BABYLON.Mesh("group_" + e, wanaplan.engine3D.scene), t.setGroupId(o, e), n = Math.max(n, e)) : o = new BABYLON.Mesh("group_virtual", wanaplan.engine3D.scene), o.isDecorable = !0, o.decorate = p.bind(o), o.isVisible = !1, o.parent = i, this.addDraggable(o), o
    }, c.prototype.mergeGroup = function(e, n) {
        var i = !!n && this.isGroup(n), o = !!e && this.isGroup(e);
        if (i && (!o || o && this.isVirtualGroup(e)))
            return this.mergeGroup(n, e);
        var r, s = o ? e.getChildren() : e ? [e] : [], a = i ? n.getChildren() : n ? [n] : [];
        r = o ? e : t.createGroup(null, e.parent), i && this.deleteGroup(n);
        for (var l = s.concat(a), h = l.length; h--; ) {
            if (r.getChildByName(l[h].name))
                continue;
            l[h].changeFrame(l[h].parent), l[h].changeFrame(r), l[h].structure.group = r, this.isVirtualGroup(r) || this.setGroupId(l[h], r.groupId)
        }
        return r
    }, c.prototype.addToGroup = function(n, i, o) {
        n && (i = this.mergeGroup(n, i || e), e = this.isVirtualGroup(i) ? i : !1, o || this.addHistory(n, {wasAdd: 1,object: n,group: i}, t.GROUPACTION))
    }, c.prototype.removeFromGroup = function(n, i) {
        var i = i || e;
        if (i && n.parent === i) {
            var o = i.parent, r = i.getWorldMatrix().clone(), s = o.getWorldMatrix().clone();
            s.invert();
            var a = r.multiply(s);
            n.parent = o, n.position.copyFrom(BABYLON.Vector3.TransformCoordinates(n.position, a)), n.rotation.addInPlace(i.rotation), n.rotation.subtractInPlace(i.parent.rotation), t.removeGroupId(n), n.changeFrame(i.parent)
        }
    }, c.prototype.deleteGroup = function(n, i) {
        var n = n || e;
        if (n) {
            t.removeGroupId(n);
            var o = n.parent, r = n.getChildren().slice(), s = n.getWorldMatrix().clone(), a = o.getWorldMatrix().clone();
            a.invert();
            for (var l = s.multiply(a), h = 0, c = r.length; c > h; h++)
                r[h].parent = o, r[h].position.copyFrom(BABYLON.Vector3.TransformCoordinates(r[h].position, l)), r[h].rotation.addInPlace(n.rotation), r[h].rotation.subtractInPlace(n.parent.rotation);
            this.removeDraggable(n), n.dispose(), n === e && (e = null), i && this.addHistory(n, {component: t,params: {wasAdd: 0,object: r,group: n},action: t.GROUPACTION}, t.GROUPACTION)
        }
    }, c.prototype.deleteSelectedGroup = function() {
        t.deleteGroup(i), t.deselectObject()
    }, c.prototype.centerGroup = function(t) {
        if (t && this.isGroup(t)) {
            var e = t.getBoundingBox(!0).center.clone();
            e.y = t.getBoundingBox().minimum.y;
            var n = t.getChildren(), i = t.getWorldMatrix().clone(), o = t.parent.getWorldMatrix().clone();
            o.invert();
            for (var r = i.multiply(o), s = BABYLON.Vector3.TransformNormal(e, r), a = n.length - 1; a >= 0; a--) {
                var l = n[a];
                l.position.subtractInPlace(e), l.computeWorldMatrix(!0)
            }
            t.position.addInPlace(s), t.computeWorldMatrix(!0), t.getFloor().markAsDirty()
        }
    }, c.prototype.refreshObject = function(t, e) {
        e = e || {};
        var n = wanaplan.getComponentByName("ObjectComponent3D");
        !e.noHistory && e.modifiedProperties && ujs.notify("wnp.request.historyAction", {component: this,object: t,params: e.modifiedProperties || {},action: this.REFRESHACTION}), n.refreshObject(t, e.callback)
    }, c.prototype.setGroupId = function(e, n) {
        if (t.isGroup(e)) {
            e.groupId = n;
            for (var i = e.getChildren(), o = 0, r = i.length; r > o; o++)
                t.setGroupId(i[o], n)
        } else
            t.isSelectableObject(e) && (e.structure.customData.groupId = n)
    }, c.prototype.removeGroupId = function(e) {
        if (t.isGroup(e))
            for (var n = e.getChildren(), i = 0, o = n.length; o > i; i++)
                t.removeGroupId(n[i]);
        else
            t.isSelectableObject(e) && (e.structure.customData.groupId = null, e.structure.group = null)
    }, c.prototype.virtualToRealGroup = function() {
        e && (e.name = "group_" + ++n, t.setGroupId(e, n), e = null)
    }, c.prototype.onGroup = function(e) {
        e.value ? t.virtualToRealGroup(e) : t.deleteSelectedGroup()
    }, c.prototype.onCloneGroup = function(e) {
        var i = e.getChildren(), o = wanaplan.getComponentByName("ObjectComponent3D");
        t.virtualToRealGroup(), t.deleteGroup(), t.deselectObject();
        var r = t.createGroup(++n, e.getFloor());
        r.computeWorldMatrix(!0);
        var s = e.getBoundingBox(), a = new BABYLON.Vector3(s.maximum.x - s.minimum.x, 0, 0);
        a = BABYLON.Vector3.TransformNormal(a, e.getWorldMatrix());
        for (var l = 0, h = i.length; h > l; l++) {
            var c = i[l];
            if (t.isSelectableObject(c)) {
                var u = c.structure.clone();
                wanaplan.getSelectedStructure().insertElement("objects", u);
                var p = function(e) {
                    t.deselectObject(), e.position.addInPlace(a), t.selectObject(e), ujs.notify("wnp.request.saveHistory")
                };
                u.customData.groupId = r.groupId, o.buildObject(u, u.programmableInstance, c.getFloor(), p)
            }
        }
    }, c.prototype.onCloneObject = function() {
        var e = wanaplan.getComponentByName("ObjectComponent3D"), n = i;
        if (null != n)
            if (t.isGroup(n))
                t.onCloneGroup(n);
            else if (t.isSelectableObject(n)) {
                var o = n.structure.clone();
                wanaplan.getSelectedStructure().insertElement("objects", o);
                var r = function(e) {
                    t.deselectObject(), t.selectObject(e);
                    var n = e.getBoundingBox(), i = new BABYLON.Vector3(n.maximum.x - n.minimum.x, 0, 0);
                    i = BABYLON.Vector3.TransformNormal(i, e.getWorldMatrix()), e.position.addInPlace(i), ujs.notify("wnp.request.saveHistory"), ujs.notify("wnp.engine3D.object.clone")
                };
                e.buildObject(o, o.programmableInstance, n.getFloor(), r)
            }
    }, c.prototype.removeObject = function(e, n) {
        if (e) {
            this.deselectObject();
            var i = e.getFloor();
            if (this.isGroup(e)) {
                var o = e.getChildren();
                e.isDeleted = !0, this.addHistory(e, {floor: i,isGroup: !0}, t.DELETEACTION);
                for (var r = 0, s = o.length; s > r; r++)
                    this.removeObject(o[r], !0)
            } else
                i.structure.removeElement("objects", e.structure), n || (this.addHistory(e, {floor: i}, t.DELETEACTION), e.structure.isDeleted = !0), e.traverse(function(t) {
                    t.isVisible && (t.wasVisible = !0), t.isVisible = !1
                })
        }
    }, c.prototype.onAddToProducts = function() {
        var e = wnp.Constants.BACK_URL + "ws/add-model";
        if (i && i.structure && t.isSelectableObject(i)) {
            var n = i.structure, o = n.filename || "object";
            ujs.ajax({method: "POST",url: e,withCredentials: !0,params: "action=add&model=model&is_active=0&name=" + o + "&encoded=1&builder_id=" + n.builderId + "&params=" + JSON.stringify(n.programmableInstance.params) + "&materials=" + JSON.stringify(ujs.serializeObject(n.programmableInstance.materials)),success: function(t) {
                    Logger.message(t), wnp.UI.MessageBox.show({title: _("Object added"),message: _("Object is now available in the backoffice"),buttonAText: _("Close"),buttonA: !0})
                }})
        } else if (i && t.isGroup(i)) {
            for (var r = i, s = {}, a = {}, o = "Group", l = 0; l < r.getChildren().length; l++) {
                var h = r.getChildren()[l];
                if (h.structure && -1 !== h.name.indexOf("Object_")) {
                    var c = h.position.clone();
                    s[l] = {builder_id: h.structure.builderId,type: h.structure.type,filename: h.structure.filename,params: h.structure.programmableInstance.params,rotation: {x: h.rotation.x,y: h.rotation.y,z: h.rotation.z},position: {x: c.x,y: c.y + r.position.y,z: c.z}}, a[l] = ujs.serializeObject(h.structure.programmableInstance.materials)
                }
            }
            ujs.ajax({method: "POST",url: e,withCredentials: !0,params: "action=add&model=model&is_active=0&name=" + o + "&encoded=1&builder_id=0&params=" + JSON.stringify(s) + "&materials=" + JSON.stringify(a),success: function(t) {
                    Logger.message(t)
                }})
        }
    }, c.prototype.update = function() {
    }, c.prototype.addHistory = function(t, e, n) {
        if (this.historycmp)
            switch (n) {
                case this.MOVEACTION:
                case this.ROTATEACTION:
                case this.GROUPACTION:
                case this.DELETEACTION:
                case this.ADDACTION:
                case this.REFRESHACTION:
                default:
                    "avatar" !== t.id && this.historycmp.actionDone(t, e, n, this)
            }
    }, c.prototype.undoMove = function(e, n) {
        t.historyMove(e, n.oldPosition, n.oldRotation)
    }, c.prototype.redoMove = function(e, n) {
        t.historyMove(e, n.newPosition, n.newRotation)
    }, c.prototype.undoRotate = c.prototype.undoMove, c.prototype.redoRotate = c.prototype.redoMove, c.prototype.historyMove = function(t, e, n) {
        t.position.copyFromFloats(e.x, e.y, e.z), t.rotation.copyFromFloats(n.x, n.y, n.z), ujs.notify("wnp.request.saveHistory"), ujs.notify("wnp.engine3D.object.translate", {object: t}), ujs.notify("wnp.engine3D.object.rotate", {object: t})
    }, c.prototype.undoRefresh = function(e, n) {
        t.historyRefresh(e, n, "exValue")
    }, c.prototype.redoRefresh = function(e, n) {
        t.historyRefresh(e, n, "newValue")
    }, c.prototype.historyRefresh = function(t, e, n) {
        var i = wanaplan.getComponentByName("ObjectComponent3D");
        for (var o in e)
            "position" == o ? (t.position.copyFrom(e[o][n]), t.structure.position = t.position) : ujs.setProperty(t.structure, o, e[o][n]);
        i.refreshObject(t)
    }, c.prototype.undoGroup = function(e, n) {
        t.historyGroup(e, n)
    }, c.prototype.redoGroup = function(e, n) {
        t.historyGroup(e, n)
    }, c.prototype.historyGroup = function(e, n) {
        n.wasAdd ? (t.deselectObject(), 2 == n.group.getChildren().length ? t.deleteGroup(n.group, !0) : t.removeFromGroup(n.object, n.group, !0)) : t.addToGroup(n.object, n.group, !0)
    }, c.prototype.undoDelete = function(e, n) {
        t.historyDelete(e, n)
    }, c.prototype.redoDelete = function(e, n) {
        t.historyDelete(e, n)
    }, c.prototype.undoAdd = c.prototype.redoDelete, c.prototype.redoAdd = c.prototype.undoDelete, c.prototype.historyDelete = function(t, e) {
        e.isGroup ? t.isDeleted = !t.isDeleted : t.structure.isDeleted = !t.structure.isDeleted;
        var n = e.isGroup ? t.isDeleted : t.structure.isDeleted;
        if (t.traverse(function(t) {
            t.isVisible = !n && t.wasVisible
        }), e.isGroup)
            for (var i = t.getChildren(), o = 0; o < i.length; o++)
                n ? e.floor.structure.removeElement("objects", i[o].structure) : e.floor.structure.insertElement("objects", i[o].structure);
        else
            n ? e.floor.structure.removeElement("objects", t.structure) : e.floor.structure.insertElement("objects", t.structure)
    }, c.prototype.setupHistory = function() {
        this.historycmp = this.core.getComponentByName("HistoryComponent"), this.historycmp && (this.historycmp.registerAction(this.MOVEACTION, this.undoMove, this.redoMove, this), this.historycmp.registerAction(this.ROTATEACTION, this.undoRotate, this.redoRotate, this), this.historycmp.registerAction(this.REFRESHACTION, this.undoRefresh, this.redoRefresh, this), this.historycmp.registerAction(this.GROUPACTION, this.undoGroup, this.redoGroup, this), this.historycmp.registerAction(this.DELETEACTION, this.undoDelete, this.redoDelete, this), this.historycmp.registerAction(this.ADDACTION, this.undoAdd, this.redoAdd, this))
    }, c
}(), MobileComponent = function() {
    function t() {
        var t = window.innerWidth;
        640 > t ? WallComponent2D.WALL_OFFSET = 75 : t >= 640 && 800 > t ? WallComponent2D.WALL_OFFSET = 50 : t >= 800 && 1280 > t && (WallComponent2D.WALL_OFFSET = 35)
    }
    var e = function(t, e) {
        if (BaseComponent2D.call(this, t, "MobileComponent"), this.dirty = !GlobalHelper.isMobileDevice(), this._isMenuVisible = !0, this._menuModified = !1, this._subMenuContainer = document.getElementById("subMenuContainer"), this._toggleIcon = null, this._mainUI = document.getElementById("main-ui"), this._drawableSurfaces = document.getElementsByClassName("drawableSurface"), "boolean" == typeof e && e === !0 && (this.dirty = !1), !this.dirty) {
            var n = GlobalHelper.getCapabilities();
            HTMLHelper.addStylesheet("css/mobile.css"), wanaplan.configuration.loadConfiguration(), wanaplan.configuration.hasMobileConfig || (n.extensions.elementIndexUint ? (wanaplan.configuration.useMultiTexturing = !0, wanaplan.configuration.useMultiLights = !0) : (wanaplan.configuration.useMultiTexturing = !1, wanaplan.configuration.useMultiLights = !1), wanaplan.configuration.useShadow = !1, wanaplan.configuration.hasMobileConfig = !0, wanaplan.configuration.saveConfiguration()), this._toggleMenu = this._toggleMenu.bind(this), this.onCoreInitialized = this.onCoreInitialized.bind(this), this.onContextChanged = this.onContextChanged.bind(this), document.addEventListener("wnp.core.initialized", this.onCoreInitialized, !1), document.addEventListener("wnp.mobile.toggleMenu", this._toggleMenu, !1)
        }
    };
    return e.prototype = Object.create(BaseComponent2D.prototype), e.prototype.initialize = function() {
        var e = wanaplan.engine2D.searchComponent("PointComponent2D");
        e && (e._SIZE = 45);
        var n = wanaplan.engine3D.searchComponent("CameraComponent");
        n && (GlobalHelper.isAppleDevice() && (n.camera[0].minZ = 250, n.camera[0].maxZ = 45e3), window.PointerEvent || (n.camera[0].detachControl(wanaplan.engine3D.canvas), n.camera[0].attachControlForMobile(wanaplan.engine3D.canvas))), window.addEventListener("resize", t, !1), t(), this._editionController = document.getElementById("edition-controller")
    }, e.prototype.onCoreInitialized = function() {
        document.removeEventListener("wnp.core.initialized", this.onCoreInitialized), GlobalHelper.hasWebGL() && (wanaplan.configuration.useMultiLights || (wanaplan.engine3D.scene.lights[1].dispose(), wanaplan.engine3D.scene.lights[0].intensity = .8, wanaplan.engine3D.scene.lights[0].setDirectionToTarget(new BABYLON.Vector3(0, -1, 0))), wanaplan.configuration.useMultiTexturing || (BABYLON.StandardMaterial.reflectionTextureEnabled = !1, BABYLON.StandardMaterial.SpecularTextureEnabled = !1, BABYLON.StandardMaterial.BumpTextureEnabled = !1), wanaplan.configuration.useShadow || wanaplan.engine3D.shadowGenerator.dispose(), wanaplan.engine3D.scene.lights[0].intensity = .45, wanaplan.engine3D.scene.lights[1].intensity = .05), PerformanceComponent3D.prototype.update = function() {
        }, wanaplan.engine2D.removeComponentByName("PrintComponent2D"), wanaplan.engine3D.removeComponentByName("PrintComponent3D"), wanaplan.engine3D.removeComponentByName("RemoteControlComponent3D"), ujs.notify("wnp.menu.top.sub.replace", {item: {id: "item1",addClass: "hidden"},merge: !0}, !0);
        var t = {title: _("Toggle"),icon: "fa fa-chevron-circle-right",action: "wnp.mobile.toggleMenu",id: "toggle-mobile-button",items: [],index: "0"};
        ujs.notify("wnp.menu.top.sub.add", {item: t,menuPath: "."}), window.innerWidth < 800 && (this._toggleMenu(), wanaplan.engine2D.removeComponentByName("ScreenshotMenuComponent"), wanaplan.engine2D.removeComponentByName("FullscreenComponent"), wanaplan.engine3D.removeComponentByName("HistoryEditionComponent"))
    }, e.prototype.addPointerCallback = function() {
        document.addEventListener("wnp.input.pointerchanged", function(t) {
            wanaplan.engine3D.onMouseEvent(t, t.inputStatus)
        }, !1)
    }, e.prototype._toggleMenu = function() {
        this._toggleIcon = document.getElementById("toggle-mobile-button").getElementsByTagName("i")[0], wanaplan.setMenuWidth(this._isMenuVisible ? 0 : void 0), this._isMenuVisible ? (this._mainUI.style.display = "none", this._subMenuContainer.style.right = "0px", this._toggleIcon.setAttribute("class", "fa fa-chevron-circle-left"), this._editionController && (this._editionController.style.right = "40px"), this._drawableSurfaces[0].classList.remove("with-menu"), this._drawableSurfaces[1].classList.remove("with-menu"), wanaplan.setSize(window.innerWidth, window.innerHeight)) : (this._mainUI.style.display = "block", this._subMenuContainer.style.right = wanaplan.getMenuWidth() + "px", this._toggleIcon.setAttribute("class", "fa fa-chevron-circle-right"), this._editionController && (this._editionController.style.right = window.innerWidth - 320 + "px"), this._drawableSurfaces[0].classList.add("with-menu"), this._drawableSurfaces[1].classList.add("with-menu"), wanaplan.setSize(window.innerWidth - wanaplan.getMenuWidth(), window.innerHeight)), this._isMenuVisible = !this._isMenuVisible
    }, e
}(), MobileInputComponent = function() {
    var t = null, e = !1, n = 0, i = function(e) {
        BaseComponent2D.call(this, e, "MobileInputComponent"), this._evtBinded = !1, this._bindListeners(), t = this
    };
    return i.prototype = Object.create(BaseComponent2D.prototype), i.prototype.destroy = function() {
        this._unbindListeners()
    }, i.prototype._bindListeners = function() {
        this._evtBinded || (this._evtBinded = !0, window.addEventListener("touchstart", this._onInputChanged, !1), window.addEventListener("mousemove", this._onInputChanged, !1), window.addEventListener("pointerdown", this._onInputChanged, !1), window.addEventListener("MSPointerDown", this._onInputChanged, !1))
    }, i.prototype._unbindListeners = function() {
        this._evtBinded && (this._evtBinded = !1, window.removeEventListener("touchstart", this._onInputChanged), window.removeEventListener("mousemove", this._onInputChanged), window.removeEventListener("pointerdown", this._onInputChanged), window.removeEventListener("MSPointerDown", this._onInputChanged))
    }, i.prototype._onInputChanged = function(i) {
        return "onpointerdown" in window ? void (0 === n ? (n++, e = "mousemove" === i.type) : t.removeInputSupport("mousemove" === i.type ? "touch" : "mouse")) : void t.removeInputSupport("touchstart" === i.type || "touch" === i.pointerType ? "mouse" : "touch")
    }, i.prototype.removeInputSupport = function(t) {
        var e = wanaplan.engine2D._pointerManager, n = wanaplan.engine3D.pointerManager;
        if ("mouse" === t) {
            e.removeMouseSupport(), n && n.removeMouseSupport();
            var i = wanaplan.engine2D.searchComponent("MobileComponent");
            i || (console.log("create new"), i = new MobileComponent(wanaplan, !0), wanaplan.engine2D.addInstancedComponent(i), i.onCoreInitialized()), i.addPointerCallback(), GlobalHelper.__forceMobileDevice(!0)
        } else
            e.removeTouchSupport(), n && n.removeTouchSupport();
        this._unbindListeners(), wanaplan.engine2D.removeComponent(this, !0)
    }, i
}(), PedagoComponent = function() {
    var t = function(t) {
        BaseComponent2D.call(this, t, "PedagoComponent"), this.pedagoPath = "js/Components/PedagoComponent/pedago/pages/"
    };
    return t.prototype = Object.create(BaseComponent2D.prototype), t.prototype.checkBrowserCapability = function() {
        GlobalHelper.hasCanvas2D() || this.redirectToPage("no-webgl");
        var t = wnpLocalStorage.getItem("wnp.core.force2D");
        return t ? !0 : GlobalHelper.hasWebGL() ? !0 : (this.redirectToPage(GlobalHelper.isAppleDevice() ? "ios" : "Mac" == BrowserDetect.OS && "Safari" == BrowserDetect.browser ? "safari" : GlobalHelper.isAndroidDevice() && navigator.userAgent.match(/chrome/i) ? "no-webgl-chrome-android" : GlobalHelper.isMobileDevice() ? "mobile" : "no-webgl"), !1)
    }, t.prototype.getPageURL = function(t) {
        return [this.pedagoPath, t, ".php"].join("")
    }, t.prototype.redirectToPage = function(t) {
        window.location.href = this.getPageURL(t)
    }, t
}(), LockComponent = function() {
    var t = "js/Components/LockComponent/Assets/", e = function(t) {
        BaseComponent3D.call(this, t, "LockComponent"), this._editionComponent = null, this._isLocked = !1
    };
    return e.prototype = Object.create(BaseComponent3D.prototype), e.prototype.onContextChanged = function(t) {
        "2D" === t ? ujs.notify("wnp.menu.top.sub.replace", {item: {id: "lock-icon",addClass: "hidden"},merge: !0}, !0) : ujs.notify("wnp.menu.top.sub.replace", {item: {id: "lock-icon",addClass: ""},merge: !0}, !0)
    }, e.prototype.initialize = function() {
        HTMLHelper.addStylesheet(t + "lockComponent.css", {media: "screen"}), this._editionComponent = wanaplan.engine3D.searchComponent("EditionComponent3D"), this.toggleLock = this.toggleLock.bind(this);
        var e = {action: "wnp.component.lock",id: "lock-icon",index: 1,addClass: "hidden",icon: "fa fa-unlock",title: _("Lock/Unlock")};
        ujs.notify("wnp.menu.top.sub.add", {item: e,menuPath: "."}), document.addEventListener("wnp.component.lock", this.toggleLock, !1)
    }, e.prototype.destroy = function() {
        ujs.notify("wnp.menu.top.sub.delete", {id: "lock-icon",menuPath: "."}), document.removeEventListener("wnp.component.lock", this.toggleLock)
    }, e.prototype.toggleLock = function() {
        this._isLocked = !this._isLocked;
        var t = document.getElementById("lock-icon"), e = t.children[0].children[0];
        this._isLocked ? (this._editionComponent.dragControl.lock(), e.setAttribute("class", "fa fa-lock")) : (this._editionComponent.dragControl.unlock(), e.setAttribute("class", "fa fa-unlock"))
    }, e
}(), wnp = window.wnp || {};
wnp.LoopTimer = function() {
    var t = function() {
        var t = 0, e = 0;
        this.start = function() {
            t = (new Date).getTime()
        }, this.update = function() {
            var n = (new Date).getTime();
            e = n - t, t = n
        }, this.getElapsedTime = function() {
            return t
        }, this.getDeltaTime = function() {
            return e
        }
    };
    return t
}(), BABYLON.Engine.ShadersRepository = "js/Vendors/Babylon/Shaders/", window.location.href.split("#").length < 2 && (window.location.href = "http://www.wanaplan.com");
var wanaplan = null, wnpLocalStorage;
try {
    wnpLocalStorage = localStorage
} catch (e) {
    wnpLocalStorage = {fallback: !0,item: {},setItem: function(t, e) {
            this.item[t] = e
        },getItem: function(t) {
            return this.item[t] || null
        },removeItem: function(t) {
            delete this.item[t]
        }}
}
!function() {
    function t(t, e) {
        var e = e || 1;
        switch ("fr" == t.toLowerCase() && (a.Constants.LANG = "fr"), t.toLowerCase()) {
            case "es":
                h.setLocale("es_ES", e);
                break;
            case "de":
                h.setLocale("de_DE", e);
                break;
            case "fr":
                h.setLocale("fr_FR", e);
                break;
            case "it":
                h.setLocale("it_IT", e);
                break;
            case "pt":
                h.setLocale("pt_PT", e);
                break;
            case "pl":
                h.setLocale("pl_PL", e);
                break;
            case "jp":
                h.setLocale("jp_JP", e);
                break;
            default:
                h.setLocale("C", e)
        }
    }
    function e() {
        var e = wnpLocalStorage.getItem("wnp.core.force2D"), n = "", r = document.location.href.split("#");
        r[1] && (n = s(r[1]));
        var u = function(t) {
            for (var e = {}, n = t.split("&"), i = 0; i < n.length; i++) {
                var o = n[i].split("=");
                e[o[0]] = o[1]
            }
            return e
        }, p = u(n);
        if (!GlobalHelper.hasWebGL() && e && (p.allow3D = !1), p.apiKey || (document.location.href = "http://www.wanaplan.com"), c = p.lang ? p.lang : c, t(c), wanaplan = new a.Core(l, h, p), wanaplan.engine2D.addComponent(GridComponent2D), wanaplan.engine2D.addComponent(PointComponent2D), wanaplan.engine2D.addComponent(WallComponent2D), wanaplan.engine2D.addComponent(RoomComponent2D), wanaplan.engine2D.addComponent(StairwayComponent2D), wanaplan.engine2D.addComponent(HopperComponent2D), wanaplan.engine2D.addComponent(SubSlopeComponent2D), wanaplan.engine2D.addComponent(SubSlopeOvertureComponent2D), wanaplan.engine2D.addComponent(OvertureComponent2D), wanaplan.engine2D.addComponent(MobileComponent), wanaplan.engine2D.addComponent(MobileInputComponent), wanaplan.engine2D.addComponent(AnalyticsComponent), wanaplan.engine2D.addComponent(FloorController), wanaplan.engine3D.addComponent(CameraComponent), wanaplan.engine3D.addComponent(GridComponent3D), wanaplan.engine3D.addComponent(AvatarComponent3D), wanaplan.engine3D.addComponent(RoomComponent3D), wanaplan.engine3D.addComponent(OvertureComponent3D), wanaplan.engine3D.addComponent(SubSlopeComponent3D), wanaplan.engine3D.addComponent(WallComponent3D), wanaplan.engine3D.addComponent(StairwayComponent3D), wanaplan.engine3D.addComponent(HopperComponent3D), wanaplan.engine3D.addComponent(ObjectComponent3D), wanaplan.engine3D.addComponent(FloorComponent3D), wanaplan.engine3D.addComponent(RemoteControlComponent3D), o(), i(p), wanaplan.setSelectedEngine(wanaplan.ENGINE_2D), wanaplan.mode == wanaplan.MODE_VIEWER) {
            var d = +p.startOn2D ? wanaplan.ENGINE_2D : wanaplan.ENGINE_3D;
            wanaplan.initialize(function() {
                wanaplan.engine2D.requestStaticDraw(), wanaplan.engine2D.update(!0), wanaplan.setSelectedEngine(d), wanaplan.hideSplashScreen()
            })
        } else
            wanaplan.initialize()
    }
    function n(t) {
        if (t.mode == wanaplan.mode || 0 == t.mode) {
            var e = t.configuration || {};
            if (1 != t.type)
                return;
            var i = wanaplan["engine" + (t.engine || "2D")];
            if (!i)
                return void Logger.message(t.name + " not loaded");
            var o = window[t.name];
            if (o) {
                var r = i.addComponent(o);
                if (r) {
                    if (e["extends"])
                        for (var s = 0; s < e["extends"].length; s++) {
                            var a = i.searchComponent(e["extends"][s]);
                            a && a.disable()
                        }
                    r.initialize()
                }
            } else {
                var l = t.url || !1;
                if (l) {
                    var h = function() {
                        n(t)
                    };
                    HTMLHelper.addScript(l, void 0, h)
                } else
                    Logger.message(t.name + " not loaded")
            }
        }
    }
    function i(t) {
        ujs.ajax({method: "get",url: a.Constants.WNP_URL + "/data/api/" + t.apiKey + ".json",success: function(t) {
                var e = JSON.parse(t);
                if ("ok" == e.status)
                    for (var i = e.components, o = 0; o < i.length; o++)
                        n(i[o])
            }})
    }
    function o() {
        wanaplan.mode == wanaplan.MODE_EDITOR ? (wanaplan.engine2D.addComponent(MainMenuComponent), wanaplan.engine2D.addComponent(TopMenuComponent), wanaplan.engine2D.addComponent(SaveComponent), wanaplan.engine2D.addComponent(NewComponent), wanaplan.engine2D.addComponent(OptionsComponent), wanaplan.engine2D.addComponent(ExitComponent), wanaplan.engine2D.addComponent(ScreenshotMenuComponent), wanaplan.engine2D.addComponent(FullscreenComponent), wanaplan.engine3D.addComponent(HistoryComponent), wanaplan.engine3D.addComponent(HistoryEditionComponent), wanaplan.engine2D.addComponent(GeneralOptionComponent2D), wanaplan.engine2D.addComponent(GridBackgroundComponent2D), wanaplan.engine2D.addComponent(MagnetismComponent2D), wanaplan.engine2D.addComponent(PrintComponent2D), wanaplan.engine2D.addComponent(DebugComponent2D), wanaplan.engine3D.addComponent(PrintComponent3D), wanaplan.engine3D.addComponent(EditionComponent3D), wanaplan.engine3D.addComponent(GroupConfiguratorModComponent3D), wanaplan.engine3D.addComponent(ConfiguratorModComponent3D), wanaplan.engine3D.addComponent(GroupConfiguratorPanelComponent3D), wanaplan.engine3D.addComponent(ConfiguratorPanelComponent3D), wanaplan.engine3D.addComponent(ConfiguratorInOutAnimationComponent3D), wanaplan.engine3D.addComponent(ConfiguratorXrayComponent3D), wanaplan.engine3D.addComponent(MesureDisplayerForDimensionReshaperFactoryComponent3D), wanaplan.engine3D.addComponent(HandlesDisplayerForDimensionReshaperFactoryComponent3D), wanaplan.engine3D.addComponent(BoundingLimitDisplayerForDimensionReshaperFactoryComponent3D), wanaplan.engine3D.addComponent(MasterReshaperComponent3D), wanaplan.engine3D.addComponent(DimensionReshaperComponent3D), wanaplan.engine3D.addComponent(MagnetismComponent3D), wanaplan.engine3D.addComponent(DecorationComponent3D), wanaplan.engine3D.addComponent(LuxensComponent3D), wanaplan.engine3D.addComponent(OutsideComponent3D), wanaplan.engine3D.addComponent(DebugComponent3D), wanaplan.engine3D.addComponent(LockComponent), wanaplan.engine3D.addComponent(PerformanceComponent3D), wanaplan.engine3D.addComponent(HardwareScalingComponent3D)) : wanaplan.mode == wanaplan.MODE_VIEWER
    }
    function r() {
        requestAnimationFrame(r), wanaplan.update(), wanaplan.draw()
    }
    var s = window.atob || function(t) {
        return t
    };
    window.WNP_DEBUG = !1, Logger.setDebugMode(window.WNP_DEBUG);
    var a = window.wnp || {}, l = a.Constants.VERSION;
    window.WNP_DEBUG && (l += Math.round(100 * Math.random()));
    var h = new I18njs("./l10n/"), c = navigator.language || navigator.browserLanguage || "fr_FR", u = wnpLocalStorage.getItem(a.Constants.LC_LANG_KEY);
    if (null !== u)
        c = u;
    else {
        var p = c.split("-");
        c = p instanceof Array ? p[0] : p
    }
    t(c, l), window.onload = function() {
        var t = new PedagoComponent;
        if (t.checkBrowserCapability()) {
            if (!GlobalHelper.isMobileDevice() && "Windows" == BrowserDetect.OS)
                var n = setTimeout(function() {
                    clearTimeout(n), wanaplan.isFullyInitialized || t.redirectToPage("graphics")
                }, 15e3);
            e(), wanaplan.engine2D.addInstancedComponent(t), r()
        }
    }
}();
