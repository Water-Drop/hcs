
window.requestAnimationFrame=function(){return window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.oRequestAnimationFrame||window.msRequestAnimationFrame||function(a){window.setTimeout(a,1e3/60)}}(),window.cancelRequestAnimationFrame=function(){return window.cancelAnimationFrame||window.webkitCancelRequestAnimationFrame||window.mozCancelRequestAnimationFrame||window.oCancelRequestAnimationFrame||window.msCancelRequestAnimationFrame||clearTimeout}(),String.prototype.startsWith=String.prototype.startsWith||function(a){return a=String(a),String(this).substring(0,a.length)===a},String.prototype.endsWith=String.prototype.endsWith||function(a){a=String(a);var b=String(this);return b.substring(b.length-a.length)===a},String.prototype.trimLeft=String.prototype.trimLeft||function(){return this.replace(/^\s+/,"")},String.prototype.trimRight=String.prototype.trimRight||function(){return this.replace(/\s+$/,"")},String.prototype.trim=String.prototype.trim||function(){return this.replace(/^\s+|\s+$/g,"")},Math.sign=function(a){return 0>a?-1:1};var Logger=function(){var a=!1,b=function(b){a&&console.log(b)},c=function(b){a&&console.warn(b)},d=function(b){a&&console.error(b)},e=function(b){if(a){var c=document.getElementById("debugArea");c.innerHTML="<div>"+b+"</div>"+c.innerHTML}},f=function(){if(a){var b=document.getElementById("debugArea");b.innerHTML=""}},g=function(b){a=b?!0:!1};return{message:b,warning:c,error:d,setDebugMode:g,out:e,clear:f}}(),HANDJS=HANDJS||{};!function(){function a(){z=!0,clearTimeout(A),A=setTimeout(function(){z=!1},700)}function b(a){var b=[];if(a)for(b.unshift(a);a.parentNode;)b.unshift(a.parentNode),a=a.parentNode;return b}function c(a,c){for(var d=b(a),e=b(c),f=null;d.length>0&&d[0]==e.shift();)f=d.shift();return f}function d(a,b,d){for(var e=c(a,b),f=a,g=[];f&&f!=e;)q(f,"pointerenter")&&g.push(f),f=f.parentNode;for(;g.length>0;)d(g.pop())}function e(a,b,d){for(var e=c(a,b),f=a;f&&f!=e;)q(f,"pointerleave")&&d(f),f=f.parentNode}function f(a,b){["pointerdown","pointermove","pointerup","pointerover","pointerout"].forEach(function(c){window.addEventListener(a(c),function(a){!z&&r(a.target,c)&&b(a,c,!0)})}),void 0===window["on"+a("pointerenter").toLowerCase()]&&window.addEventListener(a("pointerover"),function(a){if(!z){var c=r(a.target,"pointerenter");c&&c!==window&&(c.contains(a.relatedTarget)||d(c,a.relatedTarget,function(c){b(a,"pointerenter",!1,c,a.relatedTarget)}))}}),void 0===window["on"+a("pointerleave").toLowerCase()]&&window.addEventListener(a("pointerout"),function(a){if(!z){var c=r(a.target,"pointerleave");c&&c!==window&&(c.contains(a.relatedTarget)||e(c,a.relatedTarget,function(c){b(a,"pointerleave",!1,c,a.relatedTarget)}))}})}if(!window.PointerEvent){Array.prototype.indexOf||(Array.prototype.indexOf=function(a){var b=Object(this),c=b.length>>>0;if(0===c)return-1;var d=0;if(arguments.length>0&&(d=Number(arguments[1]),d!=d?d=0:0!=d&&1/0!=d&&d!=-1/0&&(d=(d>0||-1)*Math.floor(Math.abs(d)))),d>=c)return-1;for(var e=d>=0?d:Math.max(c-Math.abs(d),0);c>e;e++)if(e in b&&b[e]===a)return e;return-1}),Array.prototype.forEach||(Array.prototype.forEach=function(a,b){if(!(this&&a instanceof Function))throw new TypeError;for(var c=0;c<this.length;c++)a.call(b,this[c],c,this)}),String.prototype.trim||(String.prototype.trim=function(){return this.replace(/^\s+|\s+$/,"")});var g=["pointerdown","pointerup","pointermove","pointerover","pointerout","pointercancel","pointerenter","pointerleave"],h=["PointerDown","PointerUp","PointerMove","PointerOver","PointerOut","PointerCancel","PointerEnter","PointerLeave"],i="touch",j="pen",k="mouse",l={},m=function(a){for(;a&&!a.handjs_forcePreventDefault;)a=a.parentNode;return!!a||window.handjs_forcePreventDefault},n=function(a,b,c,d,e){var f;if(document.createEvent?(f=document.createEvent("MouseEvents"),f.initMouseEvent(b,c,!0,window,1,a.screenX,a.screenY,a.clientX,a.clientY,a.ctrlKey,a.altKey,a.shiftKey,a.metaKey,a.button,e||a.relatedTarget)):(f=document.createEventObject(),f.screenX=a.screenX,f.screenY=a.screenY,f.clientX=a.clientX,f.clientY=a.clientY,f.ctrlKey=a.ctrlKey,f.altKey=a.altKey,f.shiftKey=a.shiftKey,f.metaKey=a.metaKey,f.button=a.button,f.relatedTarget=e||a.relatedTarget),void 0===f.offsetX&&(void 0!==a.offsetX?(Object&&void 0!==Object.defineProperty&&(Object.defineProperty(f,"offsetX",{writable:!0}),Object.defineProperty(f,"offsetY",{writable:!0})),f.offsetX=a.offsetX,f.offsetY=a.offsetY):Object&&void 0!==Object.defineProperty?(Object.defineProperty(f,"offsetX",{get:function(){return this.currentTarget&&this.currentTarget.offsetLeft?a.clientX-this.currentTarget.offsetLeft:a.clientX}}),Object.defineProperty(f,"offsetY",{get:function(){return this.currentTarget&&this.currentTarget.offsetTop?a.clientY-this.currentTarget.offsetTop:a.clientY}})):void 0!==a.layerX&&(f.offsetX=a.layerX-a.currentTarget.offsetLeft,f.offsetY=a.layerY-a.currentTarget.offsetTop)),f.isPrimary=void 0!==a.isPrimary?a.isPrimary:!0,a.pressure)f.pressure=a.pressure;else{var g=0;void 0!==a.which?g=a.which:void 0!==a.button&&(g=a.button),f.pressure=0==g?0:.5}if(f.rotation=a.rotation?a.rotation:0,f.hwTimestamp=a.hwTimestamp?a.hwTimestamp:0,f.tiltX=a.tiltX?a.tiltX:0,f.tiltY=a.tiltY?a.tiltY:0,f.height=a.height?a.height:0,f.width=a.width?a.width:0,f.preventDefault=function(){void 0!==a.preventDefault&&a.preventDefault()},void 0!==f.stopPropagation){var h=f.stopPropagation;f.stopPropagation=function(){void 0!==a.stopPropagation&&a.stopPropagation(),h.call(this)}}switch(f.pointerId=a.pointerId,f.pointerType=a.pointerType,f.pointerType){case 2:f.pointerType=i;break;case 3:f.pointerType=j;break;case 4:f.pointerType=k}d?d.dispatchEvent(f):a.target?a.target.dispatchEvent(f):a.srcElement.fireEvent("on"+t(b),f)},o=function(a,b,c,d,e){a.pointerId=1,a.pointerType=k,n(a,b,c,d,e)},p=function(a,b,c,d,e,f){var g=b.identifier+2;b.pointerId=g,b.pointerType=i,b.currentTarget=c,void 0!==d.preventDefault&&(b.preventDefault=function(){d.preventDefault()}),n(b,a,e,c,f)},q=function(a,b){return a.__handjsGlobalRegisteredEvents&&a.__handjsGlobalRegisteredEvents[b]},r=function(a,b){for(;a&&!q(a,b);)a=a.parentNode;return a?a:q(window,b)?window:void 0},s=function(a,b,c,d,e,f){r(c,a)&&p(a,b,c,d,e,f)},t=function(a){return a.toLowerCase().replace("pointer","mouse")},u=function(a,b){var c=g.indexOf(b),d=a+h[c];return d},v=function(a,b,c,d){if(void 0===a.__handjsRegisteredEvents&&(a.__handjsRegisteredEvents=[]),d){if(void 0!==a.__handjsRegisteredEvents[b])return void a.__handjsRegisteredEvents[b]++;a.__handjsRegisteredEvents[b]=1,a.addEventListener(b,c,!1)}else{if(-1!==a.__handjsRegisteredEvents.indexOf(b)&&(a.__handjsRegisteredEvents[b]--,0!=a.__handjsRegisteredEvents[b]))return;a.removeEventListener(b,c),a.__handjsRegisteredEvents[b]=0}},w=function(a,b,c){if(a.__handjsGlobalRegisteredEvents||(a.__handjsGlobalRegisteredEvents=[]),c){if(void 0!==a.__handjsGlobalRegisteredEvents[b])return void a.__handjsGlobalRegisteredEvents[b]++;a.__handjsGlobalRegisteredEvents[b]=1}else void 0!==a.__handjsGlobalRegisteredEvents[b]&&(a.__handjsGlobalRegisteredEvents[b]--,a.__handjsGlobalRegisteredEvents[b]<0&&(a.__handjsGlobalRegisteredEvents[b]=0));var d,e;switch(window.MSPointerEvent?(d=function(a){return u("MS",a)},e=n):(d=t,e=o),b){case"pointerenter":case"pointerleave":var f=d(b);void 0!==a["on"+f.toLowerCase()]&&v(a,f,function(a){e(a,b)},c)}},x=function(a){var b=a.prototype?a.prototype.addEventListener:a.addEventListener,c=function(a,c,d){-1!=g.indexOf(a)&&w(this,a,!0),void 0===b?this.attachEvent("on"+t(a),c):b.call(this,a,c,d)};a.prototype?a.prototype.addEventListener=c:a.addEventListener=c},y=function(a){var b=a.prototype?a.prototype.removeEventListener:a.removeEventListener,c=function(a,c,d){-1!=g.indexOf(a)&&w(this,a,!1),void 0===b?this.detachEvent(t(a),c):b.call(this,a,c,d)};a.prototype?a.prototype.removeEventListener=c:a.removeEventListener=c};x(window),x(window.HTMLElement||window.Element),x(document),x(HTMLBodyElement),x(HTMLDivElement),x(HTMLImageElement),x(HTMLUListElement),x(HTMLAnchorElement),x(HTMLLIElement),x(HTMLTableElement),window.HTMLSpanElement&&x(HTMLSpanElement),window.HTMLCanvasElement&&x(HTMLCanvasElement),window.SVGElement&&x(SVGElement),y(window),y(window.HTMLElement||window.Element),y(document),y(HTMLBodyElement),y(HTMLDivElement),y(HTMLImageElement),y(HTMLUListElement),y(HTMLAnchorElement),y(HTMLLIElement),y(HTMLTableElement),window.HTMLSpanElement&&y(HTMLSpanElement),window.HTMLCanvasElement&&y(HTMLCanvasElement),window.SVGElement&&y(SVGElement);var z=!1,A=-1;!function(){window.MSPointerEvent?f(function(a){return u("MS",a)},n):(f(t,o),void 0!==window.ontouchstart&&(window.addEventListener("touchstart",function(b){for(var c=0;c<b.changedTouches.length;++c){var e=b.changedTouches[c];l[e.identifier]=e.target,s("pointerover",e,e.target,b,!0),d(e.target,null,function(a){p("pointerenter",e,a,b,!1)}),s("pointerdown",e,e.target,b,!0)}a()}),window.addEventListener("touchend",function(b){for(var c=0;c<b.changedTouches.length;++c){var d=b.changedTouches[c],f=l[d.identifier];s("pointerup",d,f,b,!0),s("pointerout",d,f,b,!0),e(f,null,function(a){p("pointerleave",d,a,b,!1)})}a()}),window.addEventListener("touchmove",function(b){for(var c=0;c<b.changedTouches.length;++c){var f=b.changedTouches[c],g=document.elementFromPoint(f.clientX,f.clientY),h=l[f.identifier];h&&m(h)===!0&&b.preventDefault(),s("pointermove",f,h,b,!0),h!==g&&(h&&(s("pointerout",f,h,b,!0,g),h.contains(g)||e(h,g,function(a){p("pointerleave",f,a,b,!1,g)})),g&&(s("pointerover",f,g,b,!0,h),g.contains(h)||d(g,h,function(a){p("pointerenter",f,a,b,!1,h)})),l[f.identifier]=g)}a()}),window.addEventListener("touchcancel",function(a){for(var b=0;b<a.changedTouches.length;++b){var c=a.changedTouches[b];s("pointercancel",c,l[c.identifier],a,!0)}})))}(),void 0===navigator.pointerEnabled&&(navigator.pointerEnabled=!0,navigator.msPointerEnabled&&(navigator.maxTouchPoints=navigator.msMaxTouchPoints)),document.styleSheets&&document.addEventListener&&document.addEventListener("DOMContentLoaded",function(){if(!HANDJS.doNotProcessCSS&&void 0===document.body.style.touchAction){var a=new RegExp(".+?{.*?}","m"),b=new RegExp(".+?{","m"),c=function(c){var d=a.exec(c);if(d){var e=d[0];c=c.replace(e,"").trim();var f=b.exec(e)[0].replace("{","").trim();if(-1!=e.replace(/\s/g,"").indexOf("touch-action:none"))for(var g=document.querySelectorAll(f),h=0;h<g.length;h++){var i=g[h];void 0!==i.style.msTouchAction?i.style.msTouchAction="none":i.handjs_forcePreventDefault=!0}return c}},d=function(a){if(window.setImmediate)a&&setImmediate(d,c(a));else for(;a;)a=c(a)};try{for(var e=0;e<document.styleSheets.length;e++){var f=document.styleSheets[e];if(void 0!=f.href){var g=new XMLHttpRequest;g.open("get",f.href),g.send();var h=g.responseText.replace(/(\n|\r)/g,"");d(h)}}}catch(i){}for(var j=document.getElementsByTagName("style"),e=0;e<j.length;e++){var k=j[e],l=k.innerHTML.replace(/(\n|\r)/g,"").trim();d(l)}}},!1)}}();var BABYLON;!function(a){var b=function(){function a(a,b,c){"undefined"==typeof a&&(a=0),"undefined"==typeof b&&(b=0),"undefined"==typeof c&&(c=0),this.r=a,this.g=b,this.b=c}return a.prototype.toString=function(){return"{R: "+this.r+" G:"+this.g+" B:"+this.b+"}"},a.prototype.toArray=function(a,b){void 0===b&&(b=0),a[b]=this.r,a[b+1]=this.g,a[b+2]=this.b},a.prototype.asArray=function(){var a=[];return this.toArray(a,0),a},a.prototype.multiply=function(b){return new a(this.r*b.r,this.g*b.g,this.b*b.b)},a.prototype.multiplyToRef=function(a,b){b.r=this.r*a.r,b.g=this.g*a.g,b.b=this.b*a.b},a.prototype.equals=function(a){return a&&this.r===a.r&&this.g===a.g&&this.b===a.b},a.prototype.scale=function(b){return new a(this.r*b,this.g*b,this.b*b)},a.prototype.scaleToRef=function(a,b){b.r=this.r*a,b.g=this.g*a,b.b=this.b*a},a.prototype.add=function(b){return new a(this.r+b.r,this.g+b.g,this.b+b.b)},a.prototype.addToRef=function(a,b){b.r=this.r+a.r,b.g=this.g+a.g,b.b=this.b+a.b},a.prototype.subtract=function(b){return new a(this.r-b.r,this.g-b.g,this.b-b.b)},a.prototype.subtractToRef=function(a,b){b.r=this.r-a.r,b.g=this.g-a.g,b.b=this.b-a.b},a.prototype.clone=function(){return new a(this.r,this.g,this.b)},a.prototype.copyFrom=function(a){this.r=a.r,this.g=a.g,this.b=a.b},a.prototype.copyFromFloats=function(a,b,c){this.r=a,this.g=b,this.b=c},a.FromArray=function(b){return new a(b[0],b[1],b[2])},a.FromInts=function(b,c,d){return new a(b/255,c/255,d/255)},a.Lerp=function(b,c,d){var e=b.r+(c.r-b.r)*d,f=b.g+(c.g-b.g)*d,g=b.b+(c.b-b.b)*d;return new a(e,f,g)},a.Red=function(){return new a(1,0,0)},a.Green=function(){return new a(0,1,0)},a.Blue=function(){return new a(0,0,1)},a.Black=function(){return new a(0,0,0)},a.White=function(){return new a(1,1,1)},a.Purple=function(){return new a(.5,0,.5)},a.Magenta=function(){return new a(1,0,1)},a.Yellow=function(){return new a(1,1,0)},a.Gray=function(){return new a(.5,.5,.5)},a}();a.Color3=b;var c=function(){function b(a,b,c,d){this.r=a,this.g=b,this.b=c,this.a=d}return b.prototype.addInPlace=function(a){this.r+=a.r,this.g+=a.g,this.b+=a.b,this.a+=a.a},b.prototype.asArray=function(){var a=[];return this.toArray(a,0),a},b.prototype.toArray=function(a,b){void 0===b&&(b=0),a[b]=this.r,a[b+1]=this.g,a[b+2]=this.b,a[b+3]=this.a},b.prototype.add=function(a){return new b(this.r+a.r,this.g+a.g,this.b+a.b,this.a+a.a)},b.prototype.subtract=function(a){return new b(this.r-a.r,this.g-a.g,this.b-a.b,this.a-a.a)},b.prototype.subtractToRef=function(a,b){b.r=this.r-a.r,b.g=this.g-a.g,b.b=this.b-a.b,b.a=this.a-a.a},b.prototype.scale=function(a){return new b(this.r*a,this.g*a,this.b*a,this.a*a)},b.prototype.scaleToRef=function(a,b){b.r=this.r*a,b.g=this.g*a,b.b=this.b*a,b.a=this.a*a},b.prototype.toString=function(){return"{R: "+this.r+" G:"+this.g+" B:"+this.b+" A:"+this.a+"}"},b.prototype.clone=function(){return new b(this.r,this.g,this.b,this.a)},b.Lerp=function(c,d,e){var f=new b(0,0,0,0);return a.Color4.LerpToRef(c,d,e,f),f},b.LerpToRef=function(a,b,c,d){d.r=a.r+(b.r-a.r)*c,d.g=a.g+(b.g-a.g)*c,d.b=a.b+(b.b-a.b)*c,d.a=a.a+(b.a-a.a)*c},b.FromArray=function(a,c){return"undefined"==typeof c&&(c=0),new b(a[c],a[c+1],a[c+2],a[c+3])},b.FromInts=function(a,c,d,e){return new b(a/255,c/255,d/255,e/255)},b}();a.Color4=c;var d=function(){function a(a,b){this.x=a,this.y=b}return a.prototype.toString=function(){return"{X: "+this.x+" Y:"+this.y+"}"},a.prototype.toArray=function(a,b){void 0===b&&(b=0),a[b]=this.x,a[b+1]=this.y},a.prototype.asArray=function(){var a=[];return this.toArray(a,0),a},a.prototype.copyFrom=function(a){this.x=a.x,this.y=a.y},a.prototype.add=function(b){return new a(this.x+b.x,this.y+b.y)},a.prototype.subtract=function(b){return new a(this.x-b.x,this.y-b.y)},a.prototype.negate=function(){return new a(-this.x,-this.y)},a.prototype.scaleInPlace=function(a){return this.x*=a,this.y*=a,this},a.prototype.scale=function(b){return new a(this.x*b,this.y*b)},a.prototype.equals=function(a){return a&&this.x===a.x&&this.y===a.y},a.prototype.length=function(){return Math.sqrt(this.x*this.x+this.y*this.y)},a.prototype.lengthSquared=function(){return this.x*this.x+this.y*this.y},a.prototype.normalize=function(){var a=this.length();if(0===a)return this;var b=1/a;return this.x*=b,this.y*=b,this},a.prototype.clone=function(){return new a(this.x,this.y)},a.Zero=function(){return new a(0,0)},a.FromArray=function(b,c){return c||(c=0),new a(b[c],b[c+1])},a.CatmullRom=function(b,c,d,e,f){var g=f*f,h=f*g,i=.5*(2*c.x+(-b.x+d.x)*f+(2*b.x-5*c.x+4*d.x-e.x)*g+(-b.x+3*c.x-3*d.x+e.x)*h),j=.5*(2*c.y+(-b.y+d.y)*f+(2*b.y-5*c.y+4*d.y-e.y)*g+(-b.y+3*c.y-3*d.y+e.y)*h);return new a(i,j)},a.Clamp=function(b,c,d){var e=b.x;e=e>d.x?d.x:e,e=e<c.x?c.x:e;var f=b.y;return f=f>d.y?d.y:f,f=f<c.y?c.y:f,new a(e,f)},a.Hermite=function(b,c,d,e,f){var g=f*f,h=f*g,i=2*h-3*g+1,j=-2*h+3*g,k=h-2*g+f,l=h-g,m=b.x*i+d.x*j+c.x*k+e.x*l,n=b.y*i+d.y*j+c.y*k+e.y*l;return new a(m,n)},a.Lerp=function(b,c,d){var e=b.x+(c.x-b.x)*d,f=b.y+(c.y-b.y)*d;return new a(e,f)},a.Dot=function(a,b){return a.x*b.x+a.y*b.y},a.Normalize=function(a){var b=a.clone();return b.normalize(),b},a.Minimize=function(b,c){var d=b.x<c.x?b.x:c.x,e=b.y<c.y?b.y:c.y;return new a(d,e)},a.Maximize=function(b,c){var d=b.x>c.x?b.x:c.x,e=b.y>c.y?b.y:c.y;return new a(d,e)},a.Transform=function(b,c){var d=b.x*c.m[0]+b.y*c.m[4],e=b.x*c.m[1]+b.y*c.m[5];return new a(d,e)},a.Distance=function(b,c){return Math.sqrt(a.DistanceSquared(b,c))},a.DistanceSquared=function(a,b){var c=a.x-b.x,d=a.y-b.y;return c*c+d*d},a}();a.Vector2=d;var e=function(){function b(a,b,c){this.x=a,this.y=b,this.z=c}return b.prototype.toString=function(){return"{X: "+this.x+" Y:"+this.y+" Z:"+this.z+"}"},b.prototype.asArray=function(){var a=[];return this.toArray(a,0),a},b.prototype.toArray=function(a,b){void 0===b&&(b=0),a[b]=this.x,a[b+1]=this.y,a[b+2]=this.z},b.prototype.addInPlace=function(a){this.x+=a.x,this.y+=a.y,this.z+=a.z},b.prototype.add=function(a){return new b(this.x+a.x,this.y+a.y,this.z+a.z)},b.prototype.addToRef=function(a,b){b.x=this.x+a.x,b.y=this.y+a.y,b.z=this.z+a.z},b.prototype.subtractInPlace=function(a){this.x-=a.x,this.y-=a.y,this.z-=a.z},b.prototype.subtract=function(a){return new b(this.x-a.x,this.y-a.y,this.z-a.z)},b.prototype.subtractToRef=function(a,b){b.x=this.x-a.x,b.y=this.y-a.y,b.z=this.z-a.z},b.prototype.subtractFromFloats=function(a,c,d){return new b(this.x-a,this.y-c,this.z-d)},b.prototype.subtractFromFloatsToRef=function(a,b,c,d){d.x=this.x-a,d.y=this.y-b,d.z=this.z-c},b.prototype.negate=function(){return new b(-this.x,-this.y,-this.z)},b.prototype.scaleInPlace=function(a){return this.x*=a,this.y*=a,this.z*=a,this},b.prototype.scale=function(a){return new b(this.x*a,this.y*a,this.z*a)},b.prototype.scaleToRef=function(a,b){b.x=this.x*a,b.y=this.y*a,b.z=this.z*a},b.prototype.equals=function(a){return a&&this.x===a.x&&this.y===a.y&&this.z===a.z},b.prototype.equalsToFloats=function(a,b,c){return this.x===a&&this.y===b&&this.z===c},b.prototype.multiplyInPlace=function(a){this.x*=a.x,this.y*=a.y,this.z*=a.z},b.prototype.multiply=function(a){return new b(this.x*a.x,this.y*a.y,this.z*a.z)},b.prototype.multiplyToRef=function(a,b){b.x=this.x*a.x,b.y=this.y*a.y,b.z=this.z*a.z},b.prototype.multiplyByFloats=function(a,c,d){return new b(this.x*a,this.y*c,this.z*d)},b.prototype.divide=function(a){return new b(this.x/a.x,this.y/a.y,this.z/a.z)},b.prototype.divideToRef=function(a,b){b.x=this.x/a.x,b.y=this.y/a.y,b.z=this.z/a.z},b.prototype.MinimizeInPlace=function(a){a.x<this.x&&(this.x=a.x),a.y<this.y&&(this.y=a.y),a.z<this.z&&(this.z=a.z)},b.prototype.MaximizeInPlace=function(a){a.x>this.x&&(this.x=a.x),a.y>this.y&&(this.y=a.y),a.z>this.z&&(this.z=a.z)},b.prototype.length=function(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z)},b.prototype.lengthSquared=function(){return this.x*this.x+this.y*this.y+this.z*this.z},b.prototype.normalize=function(){var a=this.length();if(0===a)return this;var b=1/a;return this.x*=b,this.y*=b,this.z*=b,this},b.prototype.clone=function(){return new b(this.x,this.y,this.z)},b.prototype.copyFrom=function(a){return this.x=a.x,this.y=a.y,this.z=a.z,this},b.prototype.copyFromFloats=function(a,b,c){return this.x=a,this.y=b,this.z=c,this},b.FromArray=function(a,c){return c||(c=0),new b(a[c],a[c+1],a[c+2])},b.FromArrayToRef=function(a,b,c){c.x=a[b],c.y=a[b+1],c.z=a[b+2]},b.FromFloatArrayToRef=function(a,b,c){c.x=a[b],c.y=a[b+1],c.z=a[b+2]},b.FromFloatsToRef=function(a,b,c,d){d.x=a,d.y=b,d.z=c},b.Zero=function(){return new b(0,0,0)},b.Up=function(){return new b(0,1,0)},b.TransformCoordinates=function(a,c){var d=b.Zero();return b.TransformCoordinatesToRef(a,c,d),d},b.TransformCoordinatesToRef=function(a,b,c){var d=a.x*b.m[0]+a.y*b.m[4]+a.z*b.m[8]+b.m[12],e=a.x*b.m[1]+a.y*b.m[5]+a.z*b.m[9]+b.m[13],f=a.x*b.m[2]+a.y*b.m[6]+a.z*b.m[10]+b.m[14],g=a.x*b.m[3]+a.y*b.m[7]+a.z*b.m[11]+b.m[15];c.x=d/g,c.y=e/g,c.z=f/g},b.TransformCoordinatesFromFloatsToRef=function(a,b,c,d,e){var f=a*d.m[0]+b*d.m[4]+c*d.m[8]+d.m[12],g=a*d.m[1]+b*d.m[5]+c*d.m[9]+d.m[13],h=a*d.m[2]+b*d.m[6]+c*d.m[10]+d.m[14],i=a*d.m[3]+b*d.m[7]+c*d.m[11]+d.m[15];e.x=f/i,e.y=g/i,e.z=h/i},b.TransformNormal=function(a,c){var d=b.Zero();return b.TransformNormalToRef(a,c,d),d},b.TransformNormalToRef=function(a,b,c){c.x=a.x*b.m[0]+a.y*b.m[4]+a.z*b.m[8],c.y=a.x*b.m[1]+a.y*b.m[5]+a.z*b.m[9],c.z=a.x*b.m[2]+a.y*b.m[6]+a.z*b.m[10]},b.TransformNormalFromFloatsToRef=function(a,b,c,d,e){e.x=a*d.m[0]+b*d.m[4]+c*d.m[8],e.y=a*d.m[1]+b*d.m[5]+c*d.m[9],e.z=a*d.m[2]+b*d.m[6]+c*d.m[10]},b.CatmullRom=function(a,c,d,e,f){var g=f*f,h=f*g,i=.5*(2*c.x+(-a.x+d.x)*f+(2*a.x-5*c.x+4*d.x-e.x)*g+(-a.x+3*c.x-3*d.x+e.x)*h),j=.5*(2*c.y+(-a.y+d.y)*f+(2*a.y-5*c.y+4*d.y-e.y)*g+(-a.y+3*c.y-3*d.y+e.y)*h),k=.5*(2*c.z+(-a.z+d.z)*f+(2*a.z-5*c.z+4*d.z-e.z)*g+(-a.z+3*c.z-3*d.z+e.z)*h);return new b(i,j,k)},b.Clamp=function(a,c,d){var e=a.x;e=e>d.x?d.x:e,e=e<c.x?c.x:e;var f=a.y;f=f>d.y?d.y:f,f=f<c.y?c.y:f;var g=a.z;return g=g>d.z?d.z:g,g=g<c.z?c.z:g,new b(e,f,g)},b.Hermite=function(a,c,d,e,f){var g=f*f,h=f*g,i=2*h-3*g+1,j=-2*h+3*g,k=h-2*g+f,l=h-g,m=a.x*i+d.x*j+c.x*k+e.x*l,n=a.y*i+d.y*j+c.y*k+e.y*l,o=a.z*i+d.z*j+c.z*k+e.z*l;return new b(m,n,o)},b.Lerp=function(a,c,d){var e=a.x+(c.x-a.x)*d,f=a.y+(c.y-a.y)*d,g=a.z+(c.z-a.z)*d;return new b(e,f,g)},b.Dot=function(a,b){return a.x*b.x+a.y*b.y+a.z*b.z},b.Cross=function(a,c){var d=b.Zero();return b.CrossToRef(a,c,d),d},b.CrossToRef=function(a,b,c){c.x=a.y*b.z-a.z*b.y,c.y=a.z*b.x-a.x*b.z,c.z=a.x*b.y-a.y*b.x},b.Normalize=function(a){var c=b.Zero();return b.NormalizeToRef(a,c),c},b.NormalizeToRef=function(a,b){b.copyFrom(a),b.normalize()},b.Project=function(c,d,e,f){var g=f.width,h=f.height,i=f.x,j=f.y,k=a.Matrix.FromValues(g/2,0,0,0,0,-h/2,0,0,0,0,1,0,i+g/2,h/2+j,0,1),l=d.multiply(e).multiply(k);return b.TransformCoordinates(c,l)},b.Unproject=function(b,c,d,e,f,g){var h=e.multiply(f).multiply(g);h.invert(),b.x=b.x/c*2-1,b.y=-(b.y/d*2-1);var i=a.Vector3.TransformCoordinates(b,h),j=b.x*h.m[3]+b.y*h.m[7]+b.z*h.m[11]+h.m[15];return a.Tools.WithinEpsilon(j,1)&&(i=i.scale(1/j)),i},b.Minimize=function(a,b){var c=a.clone();return c.MinimizeInPlace(b),c},b.Maximize=function(a,b){var c=a.clone();return c.MaximizeInPlace(b),c},b.Distance=function(a,c){return Math.sqrt(b.DistanceSquared(a,c))},b.DistanceSquared=function(a,b){var c=a.x-b.x,d=a.y-b.y,e=a.z-b.z;return c*c+d*d+e*e},b.Center=function(a,b){var c=a.add(b);return c.scaleInPlace(.5),c},b}();a.Vector3=e;var f=function(){function a(a,b,c,d){"undefined"==typeof a&&(a=0),"undefined"==typeof b&&(b=0),"undefined"==typeof c&&(c=0),"undefined"==typeof d&&(d=0),this.x=a,this.y=b,this.z=c,this.w=d}return a.prototype.toString=function(){return"{X: "+this.x+" Y:"+this.y+" Z:"+this.z+" W:"+this.w+"}"},a.prototype.asArray=function(){return[this.x,this.y,this.z,this.w]},a.prototype.equals=function(a){return a&&this.x===a.x&&this.y===a.y&&this.z===a.z&&this.w===a.w},a.prototype.clone=function(){return new a(this.x,this.y,this.z,this.w)},a.prototype.copyFrom=function(a){this.x=a.x,this.y=a.y,this.z=a.z,this.w=a.w},a.prototype.add=function(b){return new a(this.x+b.x,this.y+b.y,this.z+b.z,this.w+b.w)},a.prototype.subtract=function(b){return new a(this.x-b.x,this.y-b.y,this.z-b.z,this.w-b.w)},a.prototype.scale=function(b){return new a(this.x*b,this.y*b,this.z*b,this.w*b)},a.prototype.multiply=function(b){var c=new a(0,0,0,1);return this.multiplyToRef(b,c),c},a.prototype.multiplyToRef=function(a,b){b.x=this.x*a.w+this.y*a.z-this.z*a.y+this.w*a.x,b.y=-this.x*a.z+this.y*a.w+this.z*a.x+this.w*a.y,b.z=this.x*a.y-this.y*a.x+this.z*a.w+this.w*a.z,b.w=-this.x*a.x-this.y*a.y-this.z*a.z+this.w*a.w},a.prototype.length=function(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w)},a.prototype.normalize=function(){var a=1/this.length();this.x*=a,this.y*=a,this.z*=a,this.w*=a},a.prototype.toEulerAngles=function(){var a=this.x,b=this.y,c=this.z,d=this.w,f=a*a,g=b*b,h=c*c,i=Math.atan2(2*(b*d-a*c),1-2*(g+h)),j=Math.asin(2*(a*b+c*d)),k=Math.atan2(2*(a*d-b*c),1-2*(f+h)),l=a*b+c*d;return l>.499?(i=2*Math.atan2(a,d),k=0):-.499>l&&(i=-2*Math.atan2(a,d),k=0),new e(j,i,k)},a.prototype.toRotationMatrix=function(a){var b=this.x*this.x,c=this.y*this.y,d=this.z*this.z,e=this.x*this.y,f=this.z*this.w,g=this.z*this.x,h=this.y*this.w,i=this.y*this.z,j=this.x*this.w;a.m[0]=1-2*(c+d),a.m[1]=2*(e+f),a.m[2]=2*(g-h),a.m[3]=0,a.m[4]=2*(e-f),a.m[5]=1-2*(d+b),a.m[6]=2*(i+j),a.m[7]=0,a.m[8]=2*(g+h),a.m[9]=2*(i-j),a.m[10]=1-2*(c+b),a.m[11]=0,a.m[12]=0,a.m[13]=0,a.m[14]=0,a.m[15]=1},a.RotationAxis=function(b,c){var d=new a,e=Math.sin(c/2);return d.w=Math.cos(c/2),d.x=b.x*e,d.y=b.y*e,d.z=b.z*e,d},a.FromArray=function(b,c){return c||(c=0),new a(b[c],b[c+1],b[c+2],b[c+3])},a.RotationYawPitchRoll=function(b,c,d){var e=new a;return a.RotationYawPitchRollToRef(b,c,d,e),e},a.RotationYawPitchRollToRef=function(a,b,c,d){var e=.5*c,f=.5*b,g=.5*a,h=Math.sin(e),i=Math.cos(e),j=Math.sin(f),k=Math.cos(f),l=Math.sin(g),m=Math.cos(g);d.x=m*j*i+l*k*h,d.y=l*k*i-m*j*h,d.z=m*k*h-l*j*i,d.w=m*k*i+l*j*h},a.Slerp=function(b,c,d){var e,f,g=d,h=b.x*c.x+b.y*c.y+b.z*c.z+b.w*c.w,i=!1;if(0>h&&(i=!0,h=-h),h>.999999)f=1-g,e=i?-g:g;else{var j=Math.acos(h),k=1/Math.sin(j);f=Math.sin((1-g)*j)*k,e=i?-Math.sin(g*j)*k:Math.sin(g*j)*k}return new a(f*b.x+e*c.x,f*b.y+e*c.y,f*b.z+e*c.z,f*b.w+e*c.w)},a}();a.Quaternion=f;var g=function(){function a(){this.m=new Float32Array(16)}return a.prototype.isIdentity=function(){return 1!=this.m[0]||1!=this.m[5]||1!=this.m[10]||1!=this.m[15]?!1:0!=this.m[1]||0!=this.m[2]||0!=this.m[3]||0!=this.m[4]||0!=this.m[6]||0!=this.m[7]||0!=this.m[8]||0!=this.m[9]||0!=this.m[11]||0!=this.m[12]||0!=this.m[13]||0!=this.m[14]?!1:!0},a.prototype.determinant=function(){var a=this.m[10]*this.m[15]-this.m[11]*this.m[14],b=this.m[9]*this.m[15]-this.m[11]*this.m[13],c=this.m[9]*this.m[14]-this.m[10]*this.m[13],d=this.m[8]*this.m[15]-this.m[11]*this.m[12],e=this.m[8]*this.m[14]-this.m[10]*this.m[12],f=this.m[8]*this.m[13]-this.m[9]*this.m[12];return this.m[0]*(this.m[5]*a-this.m[6]*b+this.m[7]*c)-this.m[1]*(this.m[4]*a-this.m[6]*d+this.m[7]*e)+this.m[2]*(this.m[4]*b-this.m[5]*d+this.m[7]*f)-this.m[3]*(this.m[4]*c-this.m[5]*e+this.m[6]*f)},a.prototype.toArray=function(){return this.m},a.prototype.asArray=function(){return this.toArray()},a.prototype.invert=function(){this.invertToRef(this)},a.prototype.invertToRef=function(a){var b=this.m[0],c=this.m[1],d=this.m[2],e=this.m[3],f=this.m[4],g=this.m[5],h=this.m[6],i=this.m[7],j=this.m[8],k=this.m[9],l=this.m[10],m=this.m[11],n=this.m[12],o=this.m[13],p=this.m[14],q=this.m[15],r=l*q-m*p,s=k*q-m*o,t=k*p-l*o,u=j*q-m*n,v=j*p-l*n,w=j*o-k*n,x=g*r-h*s+i*t,y=-(f*r-h*u+i*v),z=f*s-g*u+i*w,A=-(f*t-g*v+h*w),B=1/(b*x+c*y+d*z+e*A),C=h*q-i*p,D=g*q-i*o,E=g*p-h*o,F=f*q-i*n,G=f*p-h*n,H=f*o-g*n,I=h*m-i*l,J=g*m-i*k,K=g*l-h*k,L=f*m-i*j,M=f*l-h*j,N=f*k-g*j;a.m[0]=x*B,a.m[4]=y*B,a.m[8]=z*B,a.m[12]=A*B,a.m[1]=-(c*r-d*s+e*t)*B,a.m[5]=(b*r-d*u+e*v)*B,a.m[9]=-(b*s-c*u+e*w)*B,a.m[13]=(b*t-c*v+d*w)*B,a.m[2]=(c*C-d*D+e*E)*B,a.m[6]=-(b*C-d*F+e*G)*B,a.m[10]=(b*D-c*F+e*H)*B,a.m[14]=-(b*E-c*G+d*H)*B,a.m[3]=-(c*I-d*J+e*K)*B,a.m[7]=(b*I-d*L+e*M)*B,a.m[11]=-(b*J-c*L+e*N)*B,a.m[15]=(b*K-c*M+d*N)*B},a.prototype.setTranslation=function(a){this.m[12]=a.x,this.m[13]=a.y,this.m[14]=a.z},a.prototype.multiply=function(b){var c=new a;return this.multiplyToRef(b,c),c},a.prototype.copyFrom=function(a){for(var b=0;16>b;b++)this.m[b]=a.m[b]},a.prototype.copyToArray=function(a,b){"undefined"==typeof b&&(b=0);for(var c=0;16>c;c++)a[b+c]=this.m[c]},a.prototype.multiplyToRef=function(a,b){this.multiplyToArray(a,b.m,0)},a.prototype.multiplyToArray=function(a,b,c){var d=this.m[0],e=this.m[1],f=this.m[2],g=this.m[3],h=this.m[4],i=this.m[5],j=this.m[6],k=this.m[7],l=this.m[8],m=this.m[9],n=this.m[10],o=this.m[11],p=this.m[12],q=this.m[13],r=this.m[14],s=this.m[15],t=a.m[0],u=a.m[1],v=a.m[2],w=a.m[3],x=a.m[4],y=a.m[5],z=a.m[6],A=a.m[7],B=a.m[8],C=a.m[9],D=a.m[10],E=a.m[11],F=a.m[12],G=a.m[13],H=a.m[14],I=a.m[15];b[c]=d*t+e*x+f*B+g*F,b[c+1]=d*u+e*y+f*C+g*G,b[c+2]=d*v+e*z+f*D+g*H,b[c+3]=d*w+e*A+f*E+g*I,b[c+4]=h*t+i*x+j*B+k*F,b[c+5]=h*u+i*y+j*C+k*G,b[c+6]=h*v+i*z+j*D+k*H,b[c+7]=h*w+i*A+j*E+k*I,b[c+8]=l*t+m*x+n*B+o*F,b[c+9]=l*u+m*y+n*C+o*G,b[c+10]=l*v+m*z+n*D+o*H,b[c+11]=l*w+m*A+n*E+o*I,b[c+12]=p*t+q*x+r*B+s*F,b[c+13]=p*u+q*y+r*C+s*G,b[c+14]=p*v+q*z+r*D+s*H,b[c+15]=p*w+q*A+r*E+s*I},a.prototype.equals=function(a){return a&&this.m[0]===a.m[0]&&this.m[1]===a.m[1]&&this.m[2]===a.m[2]&&this.m[3]===a.m[3]&&this.m[4]===a.m[4]&&this.m[5]===a.m[5]&&this.m[6]===a.m[6]&&this.m[7]===a.m[7]&&this.m[8]===a.m[8]&&this.m[9]===a.m[9]&&this.m[10]===a.m[10]&&this.m[11]===a.m[11]&&this.m[12]===a.m[12]&&this.m[13]===a.m[13]&&this.m[14]===a.m[14]&&this.m[15]===a.m[15]},a.prototype.clone=function(){return a.FromValues(this.m[0],this.m[1],this.m[2],this.m[3],this.m[4],this.m[5],this.m[6],this.m[7],this.m[8],this.m[9],this.m[10],this.m[11],this.m[12],this.m[13],this.m[14],this.m[15])},a.FromArray=function(b,c){var d=new a;return c||(c=0),a.FromArrayToRef(b,c,d),d},a.FromArrayToRef=function(a,b,c){for(var d=0;16>d;d++)c.m[d]=a[d+b]},a.FromValuesToRef=function(a,b,c,d,e,f,g,h,i,j,k,l,m,n,o,p,q){q.m[0]=a,q.m[1]=b,q.m[2]=c,q.m[3]=d,q.m[4]=e,q.m[5]=f,q.m[6]=g,q.m[7]=h,q.m[8]=i,q.m[9]=j,q.m[10]=k,q.m[11]=l,q.m[12]=m,q.m[13]=n,q.m[14]=o,q.m[15]=p},a.FromValues=function(b,c,d,e,f,g,h,i,j,k,l,m,n,o,p,q){var r=new a;return r.m[0]=b,r.m[1]=c,r.m[2]=d,r.m[3]=e,r.m[4]=f,r.m[5]=g,r.m[6]=h,r.m[7]=i,r.m[8]=j,r.m[9]=k,r.m[10]=l,r.m[11]=m,r.m[12]=n,r.m[13]=o,r.m[14]=p,r.m[15]=q,r},a.Identity=function(){return a.FromValues(1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1)},a.IdentityToRef=function(b){a.FromValuesToRef(1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1,b)},a.Zero=function(){return a.FromValues(0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0)},a.RotationX=function(b){var c=new a;return a.RotationXToRef(b,c),c},a.RotationXToRef=function(a,b){var c=Math.sin(a),d=Math.cos(a);b.m[0]=1,b.m[15]=1,b.m[5]=d,b.m[10]=d,b.m[9]=-c,b.m[6]=c,b.m[1]=0,b.m[2]=0,b.m[3]=0,b.m[4]=0,b.m[7]=0,b.m[8]=0,b.m[11]=0,b.m[12]=0,b.m[13]=0,b.m[14]=0},a.RotationY=function(b){var c=new a;return a.RotationYToRef(b,c),c},a.RotationYToRef=function(a,b){var c=Math.sin(a),d=Math.cos(a);b.m[5]=1,b.m[15]=1,b.m[0]=d,b.m[2]=-c,b.m[8]=c,b.m[10]=d,b.m[1]=0,b.m[3]=0,b.m[4]=0,b.m[6]=0,b.m[7]=0,b.m[9]=0,b.m[11]=0,b.m[12]=0,b.m[13]=0,b.m[14]=0},a.RotationZ=function(b){var c=new a;return a.RotationZToRef(b,c),c},a.RotationZToRef=function(a,b){var c=Math.sin(a),d=Math.cos(a);b.m[10]=1,b.m[15]=1,b.m[0]=d,b.m[1]=c,b.m[4]=-c,b.m[5]=d,b.m[2]=0,b.m[3]=0,b.m[6]=0,b.m[7]=0,b.m[8]=0,b.m[9]=0,b.m[11]=0,b.m[12]=0,b.m[13]=0,b.m[14]=0},a.RotationAxis=function(b,c){var d=Math.sin(-c),e=Math.cos(-c),f=1-e;b.normalize();var g=a.Zero();return g.m[0]=b.x*b.x*f+e,g.m[1]=b.x*b.y*f-b.z*d,g.m[2]=b.x*b.z*f+b.y*d,g.m[3]=0,g.m[4]=b.y*b.x*f+b.z*d,g.m[5]=b.y*b.y*f+e,g.m[6]=b.y*b.z*f-b.x*d,g.m[7]=0,g.m[8]=b.z*b.x*f-b.y*d,g.m[9]=b.z*b.y*f+b.x*d,g.m[10]=b.z*b.z*f+e,g.m[11]=0,g.m[15]=1,g},a.RotationYawPitchRoll=function(b,c,d){var e=new a;return a.RotationYawPitchRollToRef(b,c,d,e),e},a.RotationYawPitchRollToRef=function(a,b,c,d){f.RotationYawPitchRollToRef(a,b,c,this._tempQuaternion),this._tempQuaternion.toRotationMatrix(d)},a.Scaling=function(b,c,d){var e=a.Zero();return a.ScalingToRef(b,c,d,e),e},a.ScalingToRef=function(a,b,c,d){d.m[0]=a,d.m[1]=0,d.m[2]=0,d.m[3]=0,d.m[4]=0,d.m[5]=b,d.m[6]=0,d.m[7]=0,d.m[8]=0,d.m[9]=0,d.m[10]=c,d.m[11]=0,d.m[12]=0,d.m[13]=0,d.m[14]=0,d.m[15]=1},a.Translation=function(b,c,d){var e=a.Identity();return a.TranslationToRef(b,c,d,e),e},a.TranslationToRef=function(b,c,d,e){a.FromValuesToRef(1,0,0,0,0,1,0,0,0,0,1,0,b,c,d,1,e)},a.LookAtLH=function(b,c,d){var e=a.Zero();return a.LookAtLHToRef(b,c,d,e),e},a.LookAtLHToRef=function(b,c,d,f){c.subtractToRef(b,this._zAxis),this._zAxis.normalize(),e.CrossToRef(d,this._zAxis,this._xAxis),this._xAxis.normalize(),e.CrossToRef(this._zAxis,this._xAxis,this._yAxis),this._yAxis.normalize();var g=-e.Dot(this._xAxis,b),h=-e.Dot(this._yAxis,b),i=-e.Dot(this._zAxis,b);
return a.FromValuesToRef(this._xAxis.x,this._yAxis.x,this._zAxis.x,0,this._xAxis.y,this._yAxis.y,this._zAxis.y,0,this._xAxis.z,this._yAxis.z,this._zAxis.z,0,g,h,i,1,f)},a.OrthoLH=function(b,c,d,e){var f=2/b,g=2/c,h=1/(e-d),i=d/(d-e);return a.FromValues(f,0,0,0,0,g,0,0,0,0,h,0,0,0,i,1)},a.OrthoOffCenterLH=function(b,c,d,e,f,g){var h=a.Zero();return a.OrthoOffCenterLHToRef(b,c,d,e,f,g,h),h},a.OrthoOffCenterLHToRef=function(a,b,c,d,e,f,g){g.m[0]=2/(b-a),g.m[1]=g.m[2]=g.m[3]=0,g.m[5]=2/(d-c),g.m[4]=g.m[6]=g.m[7]=0,g.m[10]=-1/(e-f),g.m[8]=g.m[9]=g.m[11]=0,g.m[12]=(a+b)/(a-b),g.m[13]=(d+c)/(c-d),g.m[14]=e/(e-f),g.m[15]=1},a.PerspectiveLH=function(b,c,d,e){var f=a.Zero();return f.m[0]=2*d/b,f.m[1]=f.m[2]=f.m[3]=0,f.m[5]=2*d/c,f.m[4]=f.m[6]=f.m[7]=0,f.m[10]=-e/(d-e),f.m[8]=f.m[9]=0,f.m[11]=1,f.m[12]=f.m[13]=f.m[15]=0,f.m[14]=d*e/(d-e),f},a.PerspectiveFovLH=function(b,c,d,e){var f=a.Zero();return a.PerspectiveFovLHToRef(b,c,d,e,f),f},a.PerspectiveFovLHToRef=function(a,b,c,d,e){var f=1/Math.tan(.5*a);e.m[0]=f/b,e.m[1]=e.m[2]=e.m[3]=0,e.m[5]=f,e.m[4]=e.m[6]=e.m[7]=0,e.m[8]=e.m[9]=0,e.m[10]=-d/(c-d),e.m[11]=1,e.m[12]=e.m[13]=e.m[15]=0,e.m[14]=c*d/(c-d)},a.GetFinalMatrix=function(b,c,d,e,f,g){var h=b.width,i=b.height,j=b.x,k=b.y,l=a.FromValues(h/2,0,0,0,0,-i/2,0,0,0,0,g-f,0,j+h/2,i/2+k,f,1);return c.multiply(d).multiply(e).multiply(l)},a.Transpose=function(b){var c=new a;return c.m[0]=b.m[0],c.m[1]=b.m[4],c.m[2]=b.m[8],c.m[3]=b.m[12],c.m[4]=b.m[1],c.m[5]=b.m[5],c.m[6]=b.m[9],c.m[7]=b.m[13],c.m[8]=b.m[2],c.m[9]=b.m[6],c.m[10]=b.m[10],c.m[11]=b.m[14],c.m[12]=b.m[3],c.m[13]=b.m[7],c.m[14]=b.m[11],c.m[15]=b.m[15],c},a.Reflection=function(b){var c=new a;return a.ReflectionToRef(b,c),c},a.ReflectionToRef=function(a,b){a.normalize();var c=a.normal.x,d=a.normal.y,e=a.normal.z,f=-2*c,g=-2*d,h=-2*e;b.m[0]=f*c+1,b.m[1]=g*c,b.m[2]=h*c,b.m[3]=0,b.m[4]=f*d,b.m[5]=g*d+1,b.m[6]=h*d,b.m[7]=0,b.m[8]=f*e,b.m[9]=g*e,b.m[10]=h*e+1,b.m[11]=0,b.m[12]=f*a.d,b.m[13]=g*a.d,b.m[14]=h*a.d,b.m[15]=1},a._tempQuaternion=new f,a._xAxis=e.Zero(),a._yAxis=e.Zero(),a._zAxis=e.Zero(),a}();a.Matrix=g;var h=function(){function b(a,b,c,d){this.normal=new e(a,b,c),this.d=d}return b.prototype.asArray=function(){return[this.normal.x,this.normal.y,this.normal.z,this.d]},b.prototype.clone=function(){return new b(this.normal.x,this.normal.y,this.normal.z,this.d)},b.prototype.normalize=function(){var a=Math.sqrt(this.normal.x*this.normal.x+this.normal.y*this.normal.y+this.normal.z*this.normal.z),b=0;0!=a&&(b=1/a),this.normal.x*=b,this.normal.y*=b,this.normal.z*=b,this.d*=b},b.prototype.transform=function(b){var c=a.Matrix.Transpose(b),d=this.normal.x,e=this.normal.y,f=this.normal.z,g=this.d,h=d*c.m[0]+e*c.m[1]+f*c.m[2]+g*c.m[3],i=d*c.m[4]+e*c.m[5]+f*c.m[6]+g*c.m[7],j=d*c.m[8]+e*c.m[9]+f*c.m[10]+g*c.m[11],k=d*c.m[12]+e*c.m[13]+f*c.m[14]+g*c.m[15];return new a.Plane(h,i,j,k)},b.prototype.dotCoordinate=function(a){return this.normal.x*a.x+this.normal.y*a.y+this.normal.z*a.z+this.d},b.prototype.copyFromPoints=function(a,b,c){var d,e=b.x-a.x,f=b.y-a.y,g=b.z-a.z,h=c.x-a.x,i=c.y-a.y,j=c.z-a.z,k=f*j-g*i,l=g*h-e*j,m=e*i-f*h,n=Math.sqrt(k*k+l*l+m*m);d=0!=n?1/n:0,this.normal.x=k*d,this.normal.y=l*d,this.normal.z=m*d,this.d=-(this.normal.x*a.x+this.normal.y*a.y+this.normal.z*a.z)},b.prototype.isFrontFacingTo=function(a,b){var c=e.Dot(this.normal,a);return b>=c},b.prototype.signedDistanceTo=function(a){return e.Dot(a,this.normal)+this.d},b.FromArray=function(b){return new a.Plane(b[0],b[1],b[2],b[3])},b.FromPoints=function(b,c,d){var e=new a.Plane(0,0,0,0);return e.copyFromPoints(b,c,d),e},b.FromPositionAndNormal=function(b,c){var d=new a.Plane(0,0,0,0);return c.normalize(),d.normal=c,d.d=-(c.x*b.x+c.y*b.y+c.z*b.z),d},b.SignedDistanceToPlaneFromPositionAndNormal=function(a,b,c){var d=-(b.x*a.x+b.y*a.y+b.z*a.z);return e.Dot(c,b)+d},b}();a.Plane=h;var i=function(){function a(a,b,c,d){this.x=a,this.y=b,this.width=c,this.height=d}return a.prototype.toGlobal=function(b){var c=b.getRenderWidth(),d=b.getRenderHeight();return new a(this.x*c,this.y*d,this.width*c,this.height*d)},a}();a.Viewport=i;var j=function(){function a(){}return a.GetPlanes=function(b){for(var c=[],d=0;6>d;d++)c.push(new h(0,0,0,0));return a.GetPlanesToRef(b,c),c},a.GetPlanesToRef=function(a,b){b[0].normal.x=a.m[3]+a.m[2],b[0].normal.y=a.m[7]+a.m[6],b[0].normal.z=a.m[10]+a.m[10],b[0].d=a.m[15]+a.m[14],b[0].normalize(),b[1].normal.x=a.m[3]-a.m[2],b[1].normal.y=a.m[7]-a.m[6],b[1].normal.z=a.m[11]-a.m[10],b[1].d=a.m[15]-a.m[14],b[1].normalize(),b[2].normal.x=a.m[3]+a.m[0],b[2].normal.y=a.m[7]+a.m[4],b[2].normal.z=a.m[11]+a.m[8],b[2].d=a.m[15]+a.m[12],b[2].normalize(),b[3].normal.x=a.m[3]-a.m[0],b[3].normal.y=a.m[7]-a.m[4],b[3].normal.z=a.m[11]-a.m[8],b[3].d=a.m[15]-a.m[12],b[3].normalize(),b[4].normal.x=a.m[3]-a.m[1],b[4].normal.y=a.m[7]-a.m[5],b[4].normal.z=a.m[11]-a.m[9],b[4].d=a.m[15]-a.m[13],b[4].normalize(),b[5].normal.x=a.m[3]+a.m[1],b[5].normal.y=a.m[7]+a.m[5],b[5].normal.z=a.m[11]+a.m[9],b[5].d=a.m[15]+a.m[13],b[5].normalize()},a}();a.Frustum=j;var k=function(){function b(a,b){this.origin=a,this.direction=b}return b.prototype.intersectsBoxMinMax=function(a,b){var c=0,d=Number.MAX_VALUE;if(Math.abs(this.direction.x)<1e-7){if(this.origin.x<a.x||this.origin.x>b.x)return!1}else{var e=1/this.direction.x,f=(a.x-this.origin.x)*e,g=(b.x-this.origin.x)*e;if(f>g){var h=f;f=g,g=h}if(c=Math.max(f,c),d=Math.min(g,d),c>d)return!1}if(Math.abs(this.direction.y)<1e-7){if(this.origin.y<a.y||this.origin.y>b.y)return!1}else if(e=1/this.direction.y,f=(a.y-this.origin.y)*e,g=(b.y-this.origin.y)*e,f>g&&(h=f,f=g,g=h),c=Math.max(f,c),d=Math.min(g,d),c>d)return!1;if(Math.abs(this.direction.z)<1e-7){if(this.origin.z<a.z||this.origin.z>b.z)return!1}else if(e=1/this.direction.z,f=(a.z-this.origin.z)*e,g=(b.z-this.origin.z)*e,f>g&&(h=f,f=g,g=h),c=Math.max(f,c),d=Math.min(g,d),c>d)return!1;return!0},b.prototype.intersectsBox=function(a){return this.intersectsBoxMinMax(a.minimum,a.maximum)},b.prototype.intersectsSphere=function(a){var b=a.center.x-this.origin.x,c=a.center.y-this.origin.y,d=a.center.z-this.origin.z,e=b*b+c*c+d*d,f=a.radius*a.radius;if(f>=e)return!0;var g=b*this.direction.x+c*this.direction.y+d*this.direction.z;if(0>g)return!1;var h=e-g*g;return f>=h},b.prototype.intersectsTriangle=function(b,c,d){this._edge1||(this._edge1=a.Vector3.Zero(),this._edge2=a.Vector3.Zero(),this._pvec=a.Vector3.Zero(),this._tvec=a.Vector3.Zero(),this._qvec=a.Vector3.Zero()),c.subtractToRef(b,this._edge1),d.subtractToRef(b,this._edge2),a.Vector3.CrossToRef(this.direction,this._edge2,this._pvec);var f=e.Dot(this._edge1,this._pvec);if(0===f)return null;var g=1/f;this.origin.subtractToRef(b,this._tvec);var h=e.Dot(this._tvec,this._pvec)*g;if(0>h||h>1)return null;e.CrossToRef(this._tvec,this._edge1,this._qvec);var i=e.Dot(this.direction,this._qvec)*g;return 0>i||h+i>1?null:new a.IntersectionInfo(h,i,e.Dot(this._edge2,this._qvec)*g)},b.CreateNew=function(c,d,e,f,g,h,i){var j=a.Vector3.Unproject(new a.Vector3(c,d,0),e,f,g,h,i),k=a.Vector3.Unproject(new a.Vector3(c,d,1),e,f,g,h,i),l=k.subtract(j);return l.normalize(),new b(j,l)},b.Transform=function(c,d){var e=a.Vector3.TransformCoordinates(c.origin,d),f=a.Vector3.TransformNormal(c.direction,d);return new b(e,f)},b}();a.Ray=k,function(a){a[a.LOCAL=0]="LOCAL",a[a.WORLD=1]="WORLD"}(a.Space||(a.Space={}));var l=(a.Space,function(){function b(){}return b.X=new a.Vector3(1,0,0),b.Y=new a.Vector3(0,1,0),b.Z=new a.Vector3(0,0,1),b}());a.Axis=l}(BABYLON||(BABYLON={}));var BABYLON;!function(a){var b=function(){function b(b,c){this.idbFactory=window.indexedDB||window.mozIndexedDB||window.webkitIndexedDB||window.msIndexedDB,this.callbackManifestChecked=c,this.currentSceneUrl=a.Database.ReturnFullUrlLocation(b),this.db=null,this.enableSceneOffline=!1,this.enableTexturesOffline=!1,this.manifestVersionFound=0,this.mustUpdateRessources=!1,this.hasReachedQuota=!1,this.checkManifestFile()}return b.prototype.checkManifestFile=function(){function b(){a.Tools.Log("Valid manifest file not found. Scene & textures will be loaded directly from the web server."),c.enableSceneOffline=!1,c.enableTexturesOffline=!1,c.callbackManifestChecked(!1)}var c=this,d=this.currentSceneUrl+" ",e=new XMLHttpRequest,f=d;e.open("GET",f,!0),e.addEventListener("load",function(){if(200===e.status||a.Tools.ValidateXHRData(e,1))try{var d=JSON.parse(e.response);c.enableSceneOffline=d.enableSceneOffline,c.enableTexturesOffline=d.enableTexturesOffline,d.version&&!isNaN(parseInt(d.version))&&(c.manifestVersionFound=d.version),c.callbackManifestChecked&&c.callbackManifestChecked(!0)}catch(f){b()}else b()},!1),e.addEventListener("error",function(){b()},!1);try{e.send()}catch(g){}},b.prototype.openAsync=function(b,c){function d(){e.isSupported=!1,c&&c()}var e=this;if(this.idbFactory&&(this.enableSceneOffline||this.enableTexturesOffline))if(this.db)b&&b();else{this.hasReachedQuota=!1,this.isSupported=!0;var f=this.idbFactory.open("babylonjs",1);f.onerror=function(){d()},f.onblocked=function(){a.Tools.Error("IDB request blocked. Please reload the page."),d()},f.onsuccess=function(){e.db=f.result,b()},f.onupgradeneeded=function(b){e.db=b.target.result;try{b.oldVersion>0&&(e.db.deleteObjectStore("scenes"),e.db.deleteObjectStore("versions"),e.db.deleteObjectStore("textures")),e.db.createObjectStore("scenes",{keyPath:"sceneUrl"}),e.db.createObjectStore("versions",{keyPath:"sceneUrl"}),e.db.createObjectStore("textures",{keyPath:"textureUrl"})}catch(c){a.Tools.Error("Error while creating object stores. Exception: "+c.message),d()}}}else this.isSupported=!1,c&&c()},b.prototype.loadImageFromDB=function(b,c){var d=this,e=a.Database.ReturnFullUrlLocation(b),f=function(){d.hasReachedQuota||null===d.db?c.src=b:d._saveImageIntoDBAsync(e,c)};this.mustUpdateRessources?f():this._loadImageFromDBAsync(e,c,f)},b.prototype._loadImageFromDBAsync=function(b,c,d){if(this.isSupported&&null!==this.db){var e,f=this.db.transaction(["textures"]);f.onabort=function(){c.src=b},f.oncomplete=function(){var f;if(e){var g=window.URL||window.webkitURL;f=g.createObjectURL(e.data,{oneTimeOnly:!0}),c.onerror=function(){a.Tools.Error("Error loading image from blob URL: "+f+" switching back to web url: "+b),c.src=b},c.src=f}else d()};var g=f.objectStore("textures").get(b);g.onsuccess=function(a){e=a.target.result},g.onerror=function(){a.Tools.Error("Error loading texture "+b+" from DB."),c.src=b}}else a.Tools.Error("Error: IndexedDB not supported by your browser or BabylonJS Database is not open."),c.src=b},b.prototype._saveImageIntoDBAsync=function(b,c){if(this.isSupported){var d=function(){var a;if(e){var b=window.URL||window.webkitURL;try{a=b.createObjectURL(e,{oneTimeOnly:!0})}catch(d){a=b.createObjectURL(e)}}c.src=a};if(a.Database.isUASupportingBlobStorage){var e,f=this,g=new XMLHttpRequest;g.open("GET",b,!0),g.responseType="blob",g.addEventListener("load",function(){if(200===g.status){e=g.response;var h=f.db.transaction(["textures"],"readwrite");h.onabort=function(a){try{"QuotaExceededError"===a.srcElement.error.name&&(f.hasReachedQuota=!0)}catch(b){}d()},h.oncomplete=function(){d()};var i={textureUrl:b,data:e};try{var j=h.objectStore("textures").put(i);j.onsuccess=function(){},j.onerror=function(){d()}}catch(k){25===k.code&&(a.Database.isUASupportingBlobStorage=!1),c.src=b}}else c.src=b},!1),g.addEventListener("error",function(){a.Tools.Error("Error in XHR request in BABYLON.Database."),c.src=b},!1),g.send()}else c.src=b}else a.Tools.Error("Error: IndexedDB not supported by your browser or BabylonJS Database is not open."),c.src=b},b.prototype._checkVersionFromDB=function(a,b){var c=this,d=function(){c._saveVersionIntoDBAsync(a,b)};this._loadVersionFromDBAsync(a,b,d)},b.prototype._loadVersionFromDBAsync=function(b,c,d){if(this.isSupported){var e,f=this;try{var g=this.db.transaction(["versions"]);g.oncomplete=function(){e?f.manifestVersionFound>e.data?(f.mustUpdateRessources=!0,d()):c(e.data):(f.mustUpdateRessources=!0,d())},g.onabort=function(){c(-1)};var h=g.objectStore("versions").get(b);h.onsuccess=function(a){e=a.target.result},h.onerror=function(){a.Tools.Error("Error loading version for scene "+b+" from DB."),c(-1)}}catch(i){a.Tools.Error("Error while accessing 'versions' object store (READ OP). Exception: "+i.message),c(-1)}}else a.Tools.Error("Error: IndexedDB not supported by your browser or BabylonJS Database is not open."),c(-1)},b.prototype._saveVersionIntoDBAsync=function(b,c){if(this.isSupported&&!this.hasReachedQuota){var d=this;try{var e=this.db.transaction(["versions"],"readwrite");e.onabort=function(a){try{"QuotaExceededError"===a.srcElement.error.name&&(d.hasReachedQuota=!0)}catch(b){}c(-1)},e.oncomplete=function(){c(d.manifestVersionFound)};var f={sceneUrl:b,data:this.manifestVersionFound},g=e.objectStore("versions").put(f);g.onsuccess=function(){},g.onerror=function(){a.Tools.Error("Error in DB add version request in BABYLON.Database.")}}catch(h){a.Tools.Error("Error while accessing 'versions' object store (WRITE OP). Exception: "+h.message),c(-1)}}else c(-1)},b.prototype.loadFileFromDB=function(b,c,d,e,f){var g=this,h=a.Database.ReturnFullUrlLocation(b),i=function(){g._saveFileIntoDBAsync(h,c,d)};this._checkVersionFromDB(h,function(a){-1!==a?g.mustUpdateRessources?g._saveFileIntoDBAsync(h,c,d,f):g._loadFileFromDBAsync(h,c,i,f):e()})},b.prototype._loadFileFromDBAsync=function(b,c,d){if(this.isSupported){var e;e=-1!==b.indexOf(".babylon")?"scenes":"textures";var f,g=this.db.transaction([e]);g.oncomplete=function(){f?c(f.data):d()},g.onabort=function(){d()};var h=g.objectStore(e).get(b);h.onsuccess=function(a){f=a.target.result},h.onerror=function(){a.Tools.Error("Error loading file "+b+" from DB."),d()}}else a.Tools.Error("Error: IndexedDB not supported by your browser or BabylonJS Database is not open."),c()},b.prototype._saveFileIntoDBAsync=function(b,c,d,e){if(this.isSupported){var f;f=-1!==b.indexOf(".babylon")?"scenes":"textures";var g,h=new XMLHttpRequest,i=this;h.open("GET",b,!0),e&&(h.responseType="arraybuffer"),h.onprogress=d,h.addEventListener("load",function(){if(200===h.status||a.Tools.ValidateXHRData(h,e?6:1))if(g=e?h.response:h.responseText,i.hasReachedQuota)c(g);else{var d=i.db.transaction([f],"readwrite");d.onabort=function(a){try{"QuotaExceededError"===a.srcElement.error.name&&(i.hasReachedQuota=!0)}catch(b){}c(g)},d.oncomplete=function(){c(g)};var j;j="scenes"===f?{sceneUrl:b,data:g,version:i.manifestVersionFound}:{textureUrl:b,data:g};try{var k=d.objectStore(f).put(j);k.onsuccess=function(){},k.onerror=function(){a.Tools.Error("Error in DB add file request in BABYLON.Database.")}}catch(l){c(g)}}else c()},!1),h.addEventListener("error",function(){a.Tools.Error("error on XHR request."),c()},!1),h.send()}else a.Tools.Error("Error: IndexedDB not supported by your browser or BabylonJS Database is not open."),c()},b.isUASupportingBlobStorage=!0,b.parseURL=function(a){var b=document.createElement("a");b.href=a;var c=a.substring(a.lastIndexOf("/")+1,a.length),d=a.substring(0,a.indexOf(c,0));return d},b.ReturnFullUrlLocation=function(b){return-1===b.indexOf("http:/")?a.Database.parseURL(window.location.href)+b:b},b}();a.Database=b}(BABYLON||(BABYLON={}));var BABYLON;!function(a){!function(b){var c=function(){function b(){}return b.GetTGAHeader=function(a){var b=0,c={id_length:a[b++],colormap_type:a[b++],image_type:a[b++],colormap_index:a[b++]|a[b++]<<8,colormap_length:a[b++]|a[b++]<<8,colormap_size:a[b++],origin:[a[b++]|a[b++]<<8,a[b++]|a[b++]<<8],width:a[b++]|a[b++]<<8,height:a[b++]|a[b++]<<8,pixel_size:a[b++],flags:a[b++]};return c},b.UploadContent=function(c,d){if(d.length<19)return void a.Tools.Error("Unable to load TGA file - Not enough data to contain header");var e=18,f=b.GetTGAHeader(d);if(f.id_length+e>d.length)return void a.Tools.Error("Unable to load TGA file - Not enough data");e+=f.id_length;var g=!1,h=!1,i=!1,j=!1;switch(f.image_type){case b._TYPE_RLE_INDEXED:g=!0;case b._TYPE_INDEXED:h=!0;break;case b._TYPE_RLE_RGB:g=!0;case b._TYPE_RGB:i=!0;break;case b._TYPE_RLE_GREY:g=!0;case b._TYPE_GREY:j=!0}var k,l,m=(15&f.flags,f.pixel_size>>3),n=f.width*f.height*m;if(h&&(l=d.subarray(e,e+=f.colormap_length*(f.colormap_size>>3))),g){k=new Uint8Array(n);for(var o,p,q,r=0,s=new Uint8Array(m);n>e;)if(o=d[e++],p=(127&o)+1,128&o){for(q=0;m>q;++q)s[q]=d[e++];for(q=0;p>q;++q)k.set(s,r+q*m);r+=m*p}else{for(p*=m,q=0;p>q;++q)k[r+q]=d[e++];r+=p}}else k=d.subarray(e,e+=h?f.width*f.height:n);var t,u,v,w,x,y;switch((f.flags&b._ORIGIN_MASK)>>b._ORIGIN_SHIFT){default:case b._ORIGIN_UL:t=0,v=1,y=f.width,u=0,w=1,x=f.height;break;case b._ORIGIN_BL:t=0,v=1,y=f.width,u=f.height-1,w=-1,x=-1;break;case b._ORIGIN_UR:t=f.width-1,v=-1,y=-1,u=0,w=1,x=f.height;break;case b._ORIGIN_BR:t=f.width-1,v=-1,y=-1,u=f.height-1,w=-1,x=-1}var z="_getImageData"+(j?"Grey":"")+f.pixel_size+"bits",A=b[z](f,l,k,u,w,x,t,v,y);c.texImage2D(c.TEXTURE_2D,0,c.RGBA,f.width,f.height,0,c.RGBA,c.UNSIGNED_BYTE,A)},b._getImageData8bits=function(a,b,c,d,e,f,g,h,i){var j,k,l,m=c,n=b,o=a.width,p=a.height,q=0,r=new Uint8Array(o*p*4);for(l=d;l!==f;l+=e)for(k=g;k!==i;k+=h,q++)j=m[q],r[4*(k+o*l)+3]=255,r[4*(k+o*l)+2]=n[3*j+0],r[4*(k+o*l)+1]=n[3*j+1],r[4*(k+o*l)+0]=n[3*j+2];return r},b._getImageData16bits=function(a,b,c,d,e,f,g,h,i){var j,k,l,m=c,n=a.width,o=a.height,p=0,q=new Uint8Array(n*o*4);for(l=d;l!==f;l+=e)for(k=g;k!==i;k+=h,p+=2)j=m[p+0]+(m[p+1]<<8),q[4*(k+n*l)+0]=(31744&j)>>7,q[4*(k+n*l)+1]=(992&j)>>2,q[4*(k+n*l)+2]=(31&j)>>3,q[4*(k+n*l)+3]=32768&j?0:255;return q},b._getImageData24bits=function(a,b,c,d,e,f,g,h,i){var j,k,l=c,m=a.width,n=a.height,o=0,p=new Uint8Array(m*n*4);for(k=d;k!==f;k+=e)for(j=g;j!==i;j+=h,o+=3)p[4*(j+m*k)+3]=255,p[4*(j+m*k)+2]=l[o+0],p[4*(j+m*k)+1]=l[o+1],p[4*(j+m*k)+0]=l[o+2];return p},b._getImageData32bits=function(a,b,c,d,e,f,g,h,i){var j,k,l=c,m=a.width,n=a.height,o=0,p=new Uint8Array(m*n*4);for(k=d;k!==f;k+=e)for(j=g;j!==i;j+=h,o+=4)p[4*(j+m*k)+2]=l[o+0],p[4*(j+m*k)+1]=l[o+1],p[4*(j+m*k)+0]=l[o+2],p[4*(j+m*k)+3]=l[o+3];return p},b._getImageDataGrey8bits=function(a,b,c,d,e,f,g,h,i){var j,k,l,m=c,n=a.width,o=a.height,p=0,q=new Uint8Array(n*o*4);for(l=d;l!==f;l+=e)for(k=g;k!==i;k+=h,p++)j=m[p],q[4*(k+n*l)+0]=j,q[4*(k+n*l)+1]=j,q[4*(k+n*l)+2]=j,q[4*(k+n*l)+3]=255;return q},b._getImageDataGrey16bits=function(a,b,c,d,e,f,g,h,i){var j,k,l=c,m=a.width,n=a.height,o=0,p=new Uint8Array(m*n*4);for(k=d;k!==f;k+=e)for(j=g;j!==i;j+=h,o+=2)p[4*(j+m*k)+0]=l[o+0],p[4*(j+m*k)+1]=l[o+0],p[4*(j+m*k)+2]=l[o+0],p[4*(j+m*k)+3]=l[o+1];return p},b._TYPE_NO_DATA=0,b._TYPE_INDEXED=1,b._TYPE_RGB=2,b._TYPE_GREY=3,b._TYPE_RLE_INDEXED=9,b._TYPE_RLE_RGB=10,b._TYPE_RLE_GREY=11,b._ORIGIN_MASK=48,b._ORIGIN_SHIFT=4,b._ORIGIN_BL=0,b._ORIGIN_BR=1,b._ORIGIN_UL=2,b._ORIGIN_UR=3,b}();b.TGATools=c}(a.Internals||(a.Internals={})),a.Internals}(BABYLON||(BABYLON={}));var BABYLON;!function(a){!function(b){function c(a){return a.charCodeAt(0)+(a.charCodeAt(1)<<8)+(a.charCodeAt(2)<<16)+(a.charCodeAt(3)<<24)}function d(a){return String.fromCharCode(255&a,a>>8&255,a>>16&255,a>>24&255)}var e=542327876,f=131072,g=512,h=4,i=64,j=131072,k=c("DXT1"),l=c("DXT3"),m=c("DXT5"),n=31,o=0,p=1,q=2,r=3,s=4,t=7,u=20,v=21,w=22,x=28,y=function(){function b(){}return b.GetDDSInfo=function(a){var b=new Int32Array(a,0,n),c=1;return b[q]&f&&(c=Math.max(1,b[t])),{width:b[s],height:b[r],mipmapCount:c,isFourCC:(b[u]&h)===h,isRGB:(b[u]&i)===i,isLuminance:(b[u]&j)===j,isCube:(b[x]&g)===g}},b.GetRGBAArrayBuffer=function(a,b,c,d,e){for(var f=new Uint8Array(d),g=new Uint8Array(e),h=0,i=b-1;i>=0;i--)for(var j=0;a>j;j++){var k=c+4*(j+i*a);f[h+2]=g[k],f[h+1]=g[k+1],f[h]=g[k+2],f[h+3]=g[k+3],h+=4}return f},b.GetRGBArrayBuffer=function(a,b,c,d,e){for(var f=new Uint8Array(d),g=new Uint8Array(e),h=0,i=b-1;i>=0;i--)for(var j=0;a>j;j++){var k=c+3*(j+i*a);f[h+2]=g[k],f[h+1]=g[k+1],f[h]=g[k+2],h+=3}return f},b.GetLuminanceArrayBuffer=function(a,b,c,d,e){for(var f=new Uint8Array(d),g=new Uint8Array(e),h=0,i=b-1;i>=0;i--)for(var j=0;a>j;j++){var k=c+(j+i*a);f[h]=g[k],h++}return f},b.UploadDDSLevels=function(c,g,h,i,j,u){var x,y,z,A,B,C,D,E,F,G,H=new Int32Array(h,0,n);if(H[o]!=e)return void a.Tools.Error("Invalid magic number in DDS header");if(!i.isFourCC&&!i.isRGB&&!i.isLuminance)return void a.Tools.Error("Unsupported format, must contain a FourCC, RGB or LUMINANCE code");if(i.isFourCC)switch(x=H[v]){case k:y=8,z=g.COMPRESSED_RGBA_S3TC_DXT1_EXT;break;case l:y=16,z=g.COMPRESSED_RGBA_S3TC_DXT3_EXT;break;case m:y=16,z=g.COMPRESSED_RGBA_S3TC_DXT5_EXT;break;default:return void console.error("Unsupported FourCC code:",d(x))}F=1,H[q]&f&&j!==!1&&(F=Math.max(1,H[t]));for(var I=H[w],J=0;u>J;J++){var K=1==u?c.TEXTURE_2D:c.TEXTURE_CUBE_MAP_POSITIVE_X+J;for(A=H[s],B=H[r],D=H[p]+4,G=0;F>G;++G){if(i.isRGB)24==I?(C=A*B*3,E=b.GetRGBArrayBuffer(A,B,D,C,h),c.texImage2D(K,G,c.RGB,A,B,0,c.RGB,c.UNSIGNED_BYTE,E)):(C=A*B*4,E=b.GetRGBAArrayBuffer(A,B,D,C,h),c.texImage2D(K,G,c.RGBA,A,B,0,c.RGBA,c.UNSIGNED_BYTE,E));else if(i.isLuminance){var L=c.getParameter(c.UNPACK_ALIGNMENT),M=A,N=Math.floor((A+L-1)/L)*L;C=N*(B-1)+M,E=b.GetLuminanceArrayBuffer(A,B,D,C,h),c.texImage2D(K,G,c.LUMINANCE,A,B,0,c.LUMINANCE,c.UNSIGNED_BYTE,E)}else C=Math.max(4,A)/4*Math.max(4,B)/4*y,E=new Uint8Array(h,D,C),c.compressedTexImage2D(K,G,z,A,B,0,E);D+=C,A*=.5,B*=.5,A=Math.max(1,A),B=Math.max(1,B)}}},b}();b.DDSTools=y}(a.Internals||(a.Internals={})),a.Internals}(BABYLON||(BABYLON={}));var BABYLON;!function(a){var b=function(){function a(b){this.length=0,this._duplicateId=0,this.data=new Array(b),this._id=a._GlobalId++}return a.prototype.push=function(a){this.data[this.length++]=a,this.length>this.data.length&&(this.data.length*=2),a.__smartArrayFlags||(a.__smartArrayFlags={}),a.__smartArrayFlags[this._id]=this._duplicateId},a.prototype.pushNoDuplicate=function(a){a.__smartArrayFlags&&a.__smartArrayFlags[this._id]===this._duplicateId||this.push(a)},a.prototype.sort=function(a){this.data.sort(a)},a.prototype.reset=function(){this.length=0,this._duplicateId++},a.prototype.concat=function(a){if(0!==a.length){this.length+a.length>this.data.length&&(this.data.length=2*(this.length+a.length));for(var b=0;b<a.length;b++)this.data[this.length++]=(a.data||a)[b]}},a.prototype.concatWithNoDuplicate=function(a){if(0!==a.length){this.length+a.length>this.data.length&&(this.data.length=2*(this.length+a.length));for(var b=0;b<a.length;b++){var c=(a.data||a)[b];this.pushNoDuplicate(c)}}},a.prototype.indexOf=function(a){var b=this.data.indexOf(a);return b>=this.length?-1:b},a._GlobalId=0,a}();a.SmartArray=b}(BABYLON||(BABYLON={}));var BABYLON;!function(a){var b,c=60,d=[],e=60,f=0,g=function(b,c){return b?b instanceof a.Mesh?null:b instanceof a.SubMesh?b.clone(c):b.clone?b.clone():null:null},h=function(){function h(){}return h.GetFilename=function(a){var b=a.lastIndexOf("/");return 0>b?a:a.substring(b+1)},h.GetDOMTextContent=function(a){for(var b="",c=a.firstChild;c;)3==c.nodeType&&(b+=c.textContent),c=c.nextSibling;return b},h.ToDegrees=function(a){return 180*a/Math.PI},h.ToRadians=function(a){return a*Math.PI/180},h.ExtractMinAndMaxIndexed=function(b,c,d,e){for(var f=new a.Vector3(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE),g=new a.Vector3(-Number.MAX_VALUE,-Number.MAX_VALUE,-Number.MAX_VALUE),h=d;d+e>h;h++){var i=new a.Vector3(b[3*c[h]],b[3*c[h]+1],b[3*c[h]+2]);f=a.Vector3.Minimize(i,f),g=a.Vector3.Maximize(i,g)}return{minimum:f,maximum:g}},h.ExtractMinAndMax=function(b,c,d){for(var e=new a.Vector3(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE),f=new a.Vector3(-Number.MAX_VALUE,-Number.MAX_VALUE,-Number.MAX_VALUE),g=c;c+d>g;g++){var h=new a.Vector3(b[3*g],b[3*g+1],b[3*g+2]);e=a.Vector3.Minimize(h,e),f=a.Vector3.Maximize(h,f)}return{minimum:e,maximum:f}},h.MakeArray=function(a,b){return b===!0||void 0!==a&&null!=a?Array.isArray(a)?a:[a]:void 0},h.GetPointerPrefix=function(){var a="pointer";return navigator.pointerEnabled||(a="mouse"),a},h.QueueNewFrame=function(a){window.requestAnimationFrame?window.requestAnimationFrame(a):window.msRequestAnimationFrame?window.msRequestAnimationFrame(a):window.webkitRequestAnimationFrame?window.webkitRequestAnimationFrame(a):window.mozRequestAnimationFrame?window.mozRequestAnimationFrame(a):window.oRequestAnimationFrame?window.oRequestAnimationFrame(a):window.setTimeout(a,16)},h.RequestFullscreen=function(a){a.requestFullscreen?a.requestFullscreen():a.msRequestFullscreen?a.msRequestFullscreen():a.webkitRequestFullscreen?a.webkitRequestFullscreen():a.mozRequestFullScreen&&a.mozRequestFullScreen()},h.ExitFullscreen=function(){document.exitFullscreen?document.exitFullscreen():document.mozCancelFullScreen?document.mozCancelFullScreen():document.webkitCancelFullScreen?document.webkitCancelFullScreen():document.msCancelFullScreen&&document.msCancelFullScreen()},h.CleanUrl=function(a){return a=a.replace(/#/gm,"%23")},h.LoadImage=function(b,c,d,e){b=h.CleanUrl(b);var f=new Image;f.crossOrigin="anonymous",f.onload=function(){c(f)},f.onerror=function(a){d(f,a)};var g=function(){f.src=b},i=function(){e.loadImageFromDB(b,f)};if(e&&e.enableTexturesOffline&&a.Database.isUASupportingBlobStorage)e.openAsync(i,g);else if(-1===b.indexOf("file:"))g();else try{var j,k=b.substring(5);try{j=URL.createObjectURL(a.FilesInput.FilesTextures[k],{oneTimeOnly:!0})}catch(l){j=URL.createObjectURL(a.FilesInput.FilesTextures[k])}f.src=j}catch(m){h.Log("Error while trying to load texture: "+k),f.src=null}return f},h.LoadFile=function(b,c,d,e,f){b=h.CleanUrl(b);var g=function(){var e=new XMLHttpRequest,g=h.BaseUrl+b;e.open("GET",g,!0),f&&(e.responseType="arraybuffer"),e.onprogress=d,e.onreadystatechange=function(){if(4==e.readyState){if(200!=e.status&&!a.Tools.ValidateXHRData(e,f?6:1))throw new Error("Error status: "+e.status+" - Unable to load "+g);c(f?e.response:e.responseText)}},e.send(null)},i=function(){e.loadFileFromDB(b,c,d,g,f)};if(-1!==b.indexOf("file:")){var j=b.substring(5);a.Tools.ReadFile(a.FilesInput.FilesToLoad[j],c,d,!0)}else e&&e.enableSceneOffline?e.openAsync(i,g):g()},h.ReadFile=function(a,b,c,d){var e=new FileReader;e.onload=function(a){b(a.target.result)},e.onprogress=c,d?e.readAsArrayBuffer(a):e.readAsText(a)},h.CheckExtends=function(a,b,c){a.x<b.x&&(b.x=a.x),a.y<b.y&&(b.y=a.y),a.z<b.z&&(b.z=a.z),a.x>c.x&&(c.x=a.x),a.y>c.y&&(c.y=a.y),a.z>c.z&&(c.z=a.z)},h.WithinEpsilon=function(a,b){var c=a-b;return c>=-1.401298e-45&&1.401298e-45>=c},h.DeepCopy=function(a,b,c,d){for(var e in a)if(("_"!==e[0]||d&&-1!==d.indexOf(e))&&(!c||-1===c.indexOf(e))){var f=a[e],h=typeof f;if("function"!=h)if("object"==h)if(f instanceof Array){if(b[e]=[],f.length>0)if("object"==typeof f[0])for(var i=0;i<f.length;i++){var j=g(f[i],b);-1===b[e].indexOf(j)&&b[e].push(j)}else b[e]=f.slice(0)}else b[e]=g(f,b);else b[e]=f}},h.IsEmpty=function(a){for(var b in a)return!1;return!0},h.RegisterTopRootEvents=function(a){for(var b=0;b<a.length;b++){var c=a[b];window.addEventListener(c.name,c.handler,!1);try{window.parent&&window.parent.addEventListener(c.name,c.handler,!1)}catch(d){}}},h.UnregisterTopRootEvents=function(a){for(var b=0;b<a.length;b++){var c=a[b];window.removeEventListener(c.name,c.handler);try{window.parent&&window.parent.removeEventListener(c.name,c.handler)}catch(d){}}},h.GetFps=function(){return e},h.GetDeltaTime=function(){return f},h._MeasureFps=function(){d.push((new Date).getTime());var a=d.length;if(a>=2&&(f=d[a-1]-d[a-2]),a>=c){a>c&&(d.splice(0,1),a=d.length);for(var b=0,g=0;a-1>g;g++)b+=d[g+1]-d[g];e=1e3/(b/(a-1))}},h.CreateScreenshot=function(c,d,e){var f,g,i=d.getScene(),j=null;if(i.activeCamera!==d&&(j=i.activeCamera,i.activeCamera=d),e.precision)f=Math.round(c.getRenderWidth()*e.precision),g=Math.round(f/c.getAspectRatio(d)),e={width:f,height:g};else if(e.width&&e.height)f=e.width,g=e.height;else if(e.width&&!e.height)f=e.width,g=Math.round(f/c.getAspectRatio(d)),e={width:f,height:g};else if(e.height&&!e.width)g=e.height,f=Math.round(g*c.getAspectRatio(d)),e={width:f,height:g};else{if(isNaN(e))return void h.Error("Invalid 'size' parameter !");g=e,f=e}var k=new a.RenderTargetTexture("screenShot",e,c.scenes[0],!1,!1);k.renderList=c.scenes[0].meshes,k.onAfterRender=function(){for(var a=4*f,d=g/2,e=c.readPixels(0,0,f,g),h=0;d>h;h++)for(var i=0;a>i;i++){var j=i+h*a,k=g-h-1,l=i+k*a,m=e[j];e[j]=e[l],e[l]=m}b||(b=document.createElement("canvas")),b.width=f,b.height=g;var n=b.getContext("2d"),o=n.createImageData(f,g);o.data.set(e),n.putImageData(o,0,0);var p=b.toDataURL();if("download"in document.createElement("a")){var q=window.document.createElement("a");q.href=p;var r=new Date,s=r.getFullYear()+"/"+r.getMonth()+"/"+r.getDate()+"-"+r.getHours()+":"+r.getMinutes();q.setAttribute("download","screenshot-"+s+".png"),window.document.body.appendChild(q),q.addEventListener("click",function(){q.parentElement.removeChild(q)}),q.click()}else{var t=window.open(""),u=t.document.createElement("img");u.src=p,t.document.body.appendChild(u)}},k.render(!0),k.dispose(),j&&(i.activeCamera=j)},h.ValidateXHRData=function(b,c){"undefined"==typeof c&&(c=7);try{if(1&c){if(b.responseText&&b.responseText.length>0)return!0;if(1===c)return!1}if(2&c){var d=a.Internals.TGATools.GetTGAHeader(b.response);if(d.width&&d.height&&d.width>0&&d.height>0)return!0;if(2===c)return!1}if(4&c){var e=new Uint8Array(b.response,0,3);return 68==e[0]&&68==e[1]&&83==e[2]?!0:!1}}catch(f){}return!1},Object.defineProperty(h,"NoneLogLevel",{get:function(){return h._NoneLogLevel},enumerable:!0,configurable:!0}),Object.defineProperty(h,"MessageLogLevel",{get:function(){return h._MessageLogLevel},enumerable:!0,configurable:!0}),Object.defineProperty(h,"WarningLogLevel",{get:function(){return h._WarningLogLevel},enumerable:!0,configurable:!0}),Object.defineProperty(h,"ErrorLogLevel",{get:function(){return h._ErrorLogLevel},enumerable:!0,configurable:!0}),Object.defineProperty(h,"AllLogLevel",{get:function(){return h._MessageLogLevel|h._WarningLogLevel|h._ErrorLogLevel},enumerable:!0,configurable:!0}),h._FormatMessage=function(a){var b=function(a){return 10>a?"0"+a:""+a},c=new Date;return"BJS - ["+b(c.getHours())+":"+b(c.getMinutes())+":"+b(c.getSeconds())+"]: "+a},h._LogDisabled=function(){},h._LogEnabled=function(a){console.log(h._FormatMessage(a))},h._WarnDisabled=function(){},h._WarnEnabled=function(a){console.warn(h._FormatMessage(a))},h._ErrorDisabled=function(){},h._ErrorEnabled=function(a){console.error(h._FormatMessage(a))},Object.defineProperty(h,"LogLevels",{set:function(a){h.Log=(a&h.MessageLogLevel)===h.MessageLogLevel?h._LogEnabled:h._LogDisabled,h.Warn=(a&h.WarningLogLevel)===h.WarningLogLevel?h._WarnEnabled:h._WarnDisabled,h.Error=(a&h.ErrorLogLevel)===h.ErrorLogLevel?h._ErrorEnabled:h._ErrorDisabled},enumerable:!0,configurable:!0}),h.BaseUrl="",h._NoneLogLevel=0,h._MessageLogLevel=1,h._WarningLogLevel=2,h._ErrorLogLevel=4,h.Log=h._LogEnabled,h.Warn=h._WarnEnabled,h.Error=h._ErrorEnabled,h}();a.Tools=h}(BABYLON||(BABYLON={}));var BABYLON;!function(a){var b=function(a,b,c,d){var e=a.createShader("vertex"===c?a.VERTEX_SHADER:a.FRAGMENT_SHADER);if(a.shaderSource(e,(d?d+"\n":"")+b),a.compileShader(e),!a.getShaderParameter(e,a.COMPILE_STATUS))throw new Error(a.getShaderInfoLog(e));return e},c=function(b,c,d){var e=d.NEAREST,f=d.NEAREST;return b===a.Texture.BILINEAR_SAMPLINGMODE?(e=d.LINEAR,f=c?d.LINEAR_MIPMAP_NEAREST:d.LINEAR):b===a.Texture.TRILINEAR_SAMPLINGMODE?(e=d.LINEAR,f=c?d.LINEAR_MIPMAP_LINEAR:d.LINEAR):b===a.Texture.NEAREST_SAMPLINGMODE&&(e=d.NEAREST,f=c?d.NEAREST_MIPMAP_LINEAR:d.NEAREST),{min:f,mag:e}},d=function(a,b){var c=1;do c*=2;while(a>c);return c>b&&(c=b),c},e=function(b,e,f,g,h,i,j,k,l,m){"undefined"==typeof m&&(m=a.Texture.TRILINEAR_SAMPLINGMODE);var n=f.getEngine(),o=d(g,n.getCaps().maxTextureSize),p=d(h,n.getCaps().maxTextureSize);e.bindTexture(e.TEXTURE_2D,b),e.pixelStorei(e.UNPACK_FLIP_Y_WEBGL,void 0===i?1:i?1:0),l(o,p);var q=c(m,!j,e);e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MAG_FILTER,q.mag),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,q.min),j||k||e.generateMipmap(e.TEXTURE_2D),e.bindTexture(e.TEXTURE_2D,null),n._activeTexturesCache=[],b._baseWidth=g,b._baseHeight=h,b._width=o,b._height=p,b.isReady=!0,f._removePendingData(b)
},f=function(b,c,d,e,g,h){var i,j=function(){d.push(i),e._removePendingData(i),c!=h.length-1?f(b,c+1,d,e,g,h):g(d)},k=function(){e._removePendingData(i)};i=a.Tools.LoadImage(b+h[c],j,k,e.database),e._addPendingData(i)},g=function(){function a(){}return a}();a.EngineCapabilities=g;var h=function(){function h(a,b,c){var d=this;this.isFullscreen=!1,this.isPointerLock=!1,this.forceWireframe=!1,this.cullBackFaces=!0,this.renderEvenInBackground=!0,this.scenes=new Array,this._windowIsBackground=!1,this._runningLoop=!1,this._loadedTexturesCache=new Array,this._activeTexturesCache=new Array,this._compiledEffects={},this._depthMask=!1,this._renderingCanvas=a,this._canvasClientRect=this._renderingCanvas.getBoundingClientRect(),c=c||{},c.antialias=b;try{this._gl=a.getContext("webgl",c)||a.getContext("experimental-webgl",c)}catch(e){throw new Error("WebGL not supported")}if(!this._gl)throw new Error("WebGL not supported");this._onBlur=function(){d._windowIsBackground=!0},this._onFocus=function(){d._windowIsBackground=!1},window.addEventListener("blur",this._onBlur),window.addEventListener("focus",this._onFocus),this._workingCanvas=document.createElement("canvas"),this._workingContext=this._workingCanvas.getContext("2d"),this._hardwareScalingLevel=1/(window.devicePixelRatio||1),this.resize(),this._caps=new g,this._caps.maxTexturesImageUnits=this._gl.getParameter(this._gl.MAX_TEXTURE_IMAGE_UNITS),this._caps.maxTextureSize=this._gl.getParameter(this._gl.MAX_TEXTURE_SIZE),this._caps.maxCubemapTextureSize=this._gl.getParameter(this._gl.MAX_CUBE_MAP_TEXTURE_SIZE),this._caps.maxRenderTextureSize=this._gl.getParameter(this._gl.MAX_RENDERBUFFER_SIZE),this._caps.standardDerivatives=null!==this._gl.getExtension("OES_standard_derivatives"),this._caps.s3tc=this._gl.getExtension("WEBGL_compressed_texture_s3tc"),this._caps.textureFloat=null!==this._gl.getExtension("OES_texture_float"),this._caps.textureAnisotropicFilterExtension=this._gl.getExtension("EXT_texture_filter_anisotropic")||this._gl.getExtension("WEBKIT_EXT_texture_filter_anisotropic")||this._gl.getExtension("MOZ_EXT_texture_filter_anisotropic"),this._caps.maxAnisotropy=this._caps.textureAnisotropicFilterExtension?this._gl.getParameter(this._caps.textureAnisotropicFilterExtension.MAX_TEXTURE_MAX_ANISOTROPY_EXT):0,this._caps.instancedArrays=null,this.setDepthBuffer(!0),this.setDepthFunctionToLessOrEqual(),this.setDepthWrite(!0),this._onFullscreenChange=function(){void 0!==document.fullscreen?d.isFullscreen=document.fullscreen:void 0!==document.mozFullScreen?d.isFullscreen=document.mozFullScreen:void 0!==document.webkitIsFullScreen?d.isFullscreen=document.webkitIsFullScreen:void 0!==document.msIsFullScreen&&(d.isFullscreen=document.msIsFullScreen),d.isFullscreen&&d._pointerLockRequested&&(a.requestPointerLock=a.requestPointerLock||a.msRequestPointerLock||a.mozRequestPointerLock||a.webkitRequestPointerLock,a.requestPointerLock&&a.requestPointerLock())},document.addEventListener("fullscreenchange",this._onFullscreenChange,!1),document.addEventListener("mozfullscreenchange",this._onFullscreenChange,!1),document.addEventListener("webkitfullscreenchange",this._onFullscreenChange,!1),document.addEventListener("msfullscreenchange",this._onFullscreenChange,!1),this._onPointerLockChange=function(){d.isPointerLock=document.mozPointerLockElement===a||document.webkitPointerLockElement===a||document.msPointerLockElement===a||document.pointerLockElement===a},document.addEventListener("pointerlockchange",this._onPointerLockChange,!1),document.addEventListener("mspointerlockchange",this._onPointerLockChange,!1),document.addEventListener("mozpointerlockchange",this._onPointerLockChange,!1),document.addEventListener("webkitpointerlockchange",this._onPointerLockChange,!1)}return Object.defineProperty(h,"ALPHA_DISABLE",{get:function(){return h._ALPHA_DISABLE},enumerable:!0,configurable:!0}),Object.defineProperty(h,"ALPHA_ADD",{get:function(){return h._ALPHA_ADD},enumerable:!0,configurable:!0}),Object.defineProperty(h,"ALPHA_COMBINE",{get:function(){return h._ALPHA_COMBINE},enumerable:!0,configurable:!0}),Object.defineProperty(h,"DELAYLOADSTATE_NONE",{get:function(){return h._DELAYLOADSTATE_NONE},enumerable:!0,configurable:!0}),Object.defineProperty(h,"DELAYLOADSTATE_LOADED",{get:function(){return h._DELAYLOADSTATE_LOADED},enumerable:!0,configurable:!0}),Object.defineProperty(h,"DELAYLOADSTATE_LOADING",{get:function(){return h._DELAYLOADSTATE_LOADING},enumerable:!0,configurable:!0}),Object.defineProperty(h,"DELAYLOADSTATE_NOTLOADED",{get:function(){return h._DELAYLOADSTATE_NOTLOADED},enumerable:!0,configurable:!0}),Object.defineProperty(h,"Version",{get:function(){return"1.13.0"},enumerable:!0,configurable:!0}),h.prototype.getAspectRatio=function(a){var b=a.viewport;return this.getRenderWidth()*b.width/(this.getRenderHeight()*b.height)},h.prototype.getRenderWidth=function(){return this._currentRenderTarget?this._currentRenderTarget._width:this._renderingCanvas.width},h.prototype.getRenderHeight=function(){return this._currentRenderTarget?this._currentRenderTarget._height:this._renderingCanvas.height},h.prototype.getRenderingCanvas=function(){return this._renderingCanvas},h.prototype.getRenderingCanvasClientRect=function(){return this._renderingCanvas.getBoundingClientRect()},h.prototype.setHardwareScalingLevel=function(a){this._hardwareScalingLevel=a,this.resize()},h.prototype.getHardwareScalingLevel=function(){return this._hardwareScalingLevel},h.prototype.getLoadedTexturesCache=function(){return this._loadedTexturesCache},h.prototype.getCaps=function(){return this._caps},h.prototype.setDepthFunctionToGreater=function(){this._gl.depthFunc(this._gl.GREATER)},h.prototype.setDepthFunctionToGreaterOrEqual=function(){this._gl.depthFunc(this._gl.GEQUAL)},h.prototype.setDepthFunctionToLess=function(){this._gl.depthFunc(this._gl.LESS)},h.prototype.setDepthFunctionToLessOrEqual=function(){this._gl.depthFunc(this._gl.LEQUAL)},h.prototype.stopRenderLoop=function(){this._renderFunction=null,this._runningLoop=!1},h.prototype._renderLoop=function(){var b=this,c=!0;!this.renderEvenInBackground&&this._windowIsBackground&&(c=!1),c&&(this.beginFrame(),this._renderFunction&&this._renderFunction(),this.endFrame()),this._runningLoop&&a.Tools.QueueNewFrame(function(){b._renderLoop()})},h.prototype.runRenderLoop=function(b){var c=this;this._runningLoop=!0,this._renderFunction=b,a.Tools.QueueNewFrame(function(){c._renderLoop()})},h.prototype.switchFullscreen=function(b){this.isFullscreen?a.Tools.ExitFullscreen():(this._pointerLockRequested=b,a.Tools.RequestFullscreen(this._renderingCanvas))},h.prototype.clear=function(a,b,c){this._gl.clearColor(a.r,a.g,a.b,void 0!==a.a?a.a:1),this._depthMask&&this._gl.clearDepth(1);var d=0;b&&(d|=this._gl.COLOR_BUFFER_BIT),c&&this._depthMask&&(d|=this._gl.DEPTH_BUFFER_BIT),this._gl.clear(d)},h.prototype.setViewport=function(a,b,c){var d=b||this._renderingCanvas.width,e=c||this._renderingCanvas.height,f=a.x||0,g=a.y||0;this._cachedViewport=a,this._gl.viewport(f*d,g*e,d*a.width,e*a.height)},h.prototype.setDirectViewport=function(a,b,c,d){this._cachedViewport=null,this._gl.viewport(a,b,c,d)},h.prototype.beginFrame=function(){a.Tools._MeasureFps()},h.prototype.endFrame=function(){this.flushFramebuffer()},h.prototype.resize=function(){this._renderingCanvas.width=this._renderingCanvas.clientWidth/this._hardwareScalingLevel,this._renderingCanvas.height=this._renderingCanvas.clientHeight/this._hardwareScalingLevel,this._canvasClientRect=this._renderingCanvas.getBoundingClientRect()},h.prototype.bindFramebuffer=function(a){this._currentRenderTarget=a;var b=this._gl;b.bindFramebuffer(b.FRAMEBUFFER,a._framebuffer),this._gl.viewport(0,0,a._width,a._height),this.wipeCaches()},h.prototype.unBindFramebuffer=function(a){if(this._currentRenderTarget=null,a.generateMipMaps){var b=this._gl;b.bindTexture(b.TEXTURE_2D,a),b.generateMipmap(b.TEXTURE_2D),b.bindTexture(b.TEXTURE_2D,null)}this._gl.bindFramebuffer(this._gl.FRAMEBUFFER,null)},h.prototype.flushFramebuffer=function(){this._gl.flush()},h.prototype.restoreDefaultFramebuffer=function(){this._gl.bindFramebuffer(this._gl.FRAMEBUFFER,null),this.setViewport(this._cachedViewport),this.wipeCaches()},h.prototype._resetVertexBufferBinding=function(){this._gl.bindBuffer(this._gl.ARRAY_BUFFER,null),this._cachedVertexBuffers=null},h.prototype.createVertexBuffer=function(a){var b=this._gl.createBuffer();return this._gl.bindBuffer(this._gl.ARRAY_BUFFER,b),this._gl.bufferData(this._gl.ARRAY_BUFFER,new Float32Array(a),this._gl.STATIC_DRAW),this._resetVertexBufferBinding(),b.references=1,b},h.prototype.createDynamicVertexBuffer=function(a){var b=this._gl.createBuffer();return this._gl.bindBuffer(this._gl.ARRAY_BUFFER,b),this._gl.bufferData(this._gl.ARRAY_BUFFER,a,this._gl.DYNAMIC_DRAW),this._resetVertexBufferBinding(),b.references=1,b},h.prototype.updateDynamicVertexBuffer=function(a,b){this._gl.bindBuffer(this._gl.ARRAY_BUFFER,a),b instanceof Float32Array?this._gl.bufferSubData(this._gl.ARRAY_BUFFER,0,b):this._gl.bufferSubData(this._gl.ARRAY_BUFFER,0,new Float32Array(b)),this._resetVertexBufferBinding()},h.prototype._resetIndexBufferBinding=function(){this._gl.bindBuffer(this._gl.ELEMENT_ARRAY_BUFFER,null),this._cachedIndexBuffer=null},h.prototype.createIndexBuffer=function(a){var b=this._gl.createBuffer();return this._gl.bindBuffer(this._gl.ELEMENT_ARRAY_BUFFER,b),this._gl.bufferData(this._gl.ELEMENT_ARRAY_BUFFER,new Uint16Array(a),this._gl.STATIC_DRAW),this._resetIndexBufferBinding(),b.references=1,b},h.prototype.bindBuffers=function(a,b,c,d,e){if(this._cachedVertexBuffers!==a||this._cachedEffectForVertexBuffers!==e){this._cachedVertexBuffers=a,this._cachedEffectForVertexBuffers=e,this._gl.bindBuffer(this._gl.ARRAY_BUFFER,a);for(var f=0,g=0;g<c.length;g++){var h=e.getAttributeLocation(g);h>=0&&this._gl.vertexAttribPointer(h,c[g],this._gl.FLOAT,!1,d,f),f+=4*c[g]}}this._cachedIndexBuffer!==b&&(this._cachedIndexBuffer=b,this._gl.bindBuffer(this._gl.ELEMENT_ARRAY_BUFFER,b))},h.prototype.bindMultiBuffers=function(a,b,c){if(this._cachedVertexBuffers!==a||this._cachedEffectForVertexBuffers!==c){this._cachedVertexBuffers=a,this._cachedEffectForVertexBuffers=c;for(var d=c.getAttributesNames(),e=0;e<d.length;e++){var f=c.getAttributeLocation(e);if(f>=0){var g=a[d[e]];if(!g)continue;var h=g.getStrideSize();this._gl.bindBuffer(this._gl.ARRAY_BUFFER,g.getBuffer()),this._gl.vertexAttribPointer(f,h,this._gl.FLOAT,!1,4*h,0)}}}this._cachedIndexBuffer!==b&&(this._cachedIndexBuffer=b,this._gl.bindBuffer(this._gl.ELEMENT_ARRAY_BUFFER,b))},h.prototype._releaseBuffer=function(a){return a.references--,0===a.references?(this._gl.deleteBuffer(a),!0):!1},h.prototype.createInstancesBuffer=function(a){var b=this._gl.createBuffer();return b.capacity=a,this._gl.bindBuffer(this._gl.ARRAY_BUFFER,b),this._gl.bufferData(this._gl.ARRAY_BUFFER,a,this._gl.DYNAMIC_DRAW),b},h.prototype.deleteInstancesBuffer=function(a){this._gl.deleteBuffer(a)},h.prototype.updateAndBindInstancesBuffer=function(a,b,c){this._gl.bindBuffer(this._gl.ARRAY_BUFFER,a),this._gl.bufferSubData(this._gl.ARRAY_BUFFER,0,b);for(var d=0;4>d;d++){var e=c[d];this._gl.enableVertexAttribArray(e),this._gl.vertexAttribPointer(e,4,this._gl.FLOAT,!1,64,16*d),this._caps.instancedArrays.vertexAttribDivisorANGLE(e,1)}},h.prototype.unBindInstancesBuffer=function(a,b){this._gl.bindBuffer(this._gl.ARRAY_BUFFER,a);for(var c=0;4>c;c++){var d=b[c];this._gl.disableVertexAttribArray(d),this._caps.instancedArrays.vertexAttribDivisorANGLE(d,0)}},h.prototype.draw=function(a,b,c,d){return d?void this._caps.instancedArrays.drawElementsInstancedANGLE(a?this._gl.TRIANGLES:this._gl.LINES,c,this._gl.UNSIGNED_SHORT,2*b,d):void this._gl.drawElements(a?this._gl.TRIANGLES:this._gl.LINES,c,this._gl.UNSIGNED_SHORT,2*b)},h.prototype._releaseEffect=function(a){this._compiledEffects[a._key]&&(delete this._compiledEffects[a._key],a.getProgram()&&this._gl.deleteProgram(a.getProgram()))},h.prototype.createEffect=function(b,c,d,e,f,g,h,i){var j=b.vertexElement||b.vertex||b,k=b.fragmentElement||b.fragment||b,l=j+"+"+k+"@"+f;if(this._compiledEffects[l])return this._compiledEffects[l];var m=new a.Effect(b,c,d,e,this,f,g,h,i);return m._key=l,this._compiledEffects[l]=m,m},h.prototype.createShaderProgram=function(a,c,d){var e=b(this._gl,a,"vertex",d),f=b(this._gl,c,"fragment",d),g=this._gl.createProgram();this._gl.attachShader(g,e),this._gl.attachShader(g,f),this._gl.linkProgram(g);var h=this._gl.getProgramParameter(g,this._gl.LINK_STATUS);if(!h){var i=this._gl.getProgramInfoLog(g);if(i)throw new Error(i)}return this._gl.deleteShader(e),this._gl.deleteShader(f),g},h.prototype.getUniforms=function(a,b){for(var c=[],d=0;d<b.length;d++)c.push(this._gl.getUniformLocation(a,b[d]));return c},h.prototype.getAttributes=function(a,b){for(var c=[],d=0;d<b.length;d++)try{c.push(this._gl.getAttribLocation(a,b[d]))}catch(e){c.push(-1)}return c},h.prototype.enableEffect=function(a){if(!a||!a.getAttributesCount()||this._currentEffect===a)return!1;this._vertexAttribArrays=this._vertexAttribArrays||[],this._gl.useProgram(a.getProgram());for(var b in this._vertexAttribArrays)b>this._gl.VERTEX_ATTRIB_ARRAY_ENABLED||!this._vertexAttribArrays[b]||(this._vertexAttribArrays[b]=!1,this._gl.disableVertexAttribArray(b));for(var c=a.getAttributesCount(),d=0;c>d;d++){var e=a.getAttributeLocation(d);e>=0&&(this._vertexAttribArrays[e]=!0,this._gl.enableVertexAttribArray(e))}return this._currentEffect=a,!0},h.prototype.setArray=function(a,b){a&&this._gl.uniform1fv(a,b)},h.prototype.setMatrices=function(a,b){a&&this._gl.uniformMatrix4fv(a,!1,b)},h.prototype.setMatrix=function(a,b){a&&this._gl.uniformMatrix4fv(a,!1,b.toArray())},h.prototype.setFloat=function(a,b){a&&this._gl.uniform1f(a,b)},h.prototype.setFloat2=function(a,b,c){a&&this._gl.uniform2f(a,b,c)},h.prototype.setFloat3=function(a,b,c,d){a&&this._gl.uniform3f(a,b,c,d)},h.prototype.setBool=function(a,b){a&&this._gl.uniform1i(a,b)},h.prototype.setFloat4=function(a,b,c,d,e){a&&this._gl.uniform4f(a,b,c,d,e)},h.prototype.setColor3=function(a,b){a&&this._gl.uniform3f(a,b.r,b.g,b.b)},h.prototype.setColor4=function(a,b,c){a&&this._gl.uniform4f(a,b.r,b.g,b.b,c)},h.prototype.setState=function(a){this._cullingState!==a&&(a?(this._gl.cullFace(this.cullBackFaces?this._gl.BACK:this._gl.FRONT),this._gl.enable(this._gl.CULL_FACE)):this._gl.disable(this._gl.CULL_FACE),this._cullingState=a)},h.prototype.setDepthBuffer=function(a){a?this._gl.enable(this._gl.DEPTH_TEST):this._gl.disable(this._gl.DEPTH_TEST)},h.prototype.setDepthWrite=function(a){this._gl.depthMask(a),this._depthMask=a},h.prototype.setColorWrite=function(a){this._gl.colorMask(a,a,a,a)},h.prototype.setAlphaMode=function(b){switch(b){case a.Engine.ALPHA_DISABLE:this.setDepthWrite(!0),this._gl.disable(this._gl.BLEND);break;case a.Engine.ALPHA_COMBINE:this.setDepthWrite(!1),this._gl.blendFuncSeparate(this._gl.SRC_ALPHA,this._gl.ONE_MINUS_SRC_ALPHA,this._gl.ONE,this._gl.ONE),this._gl.enable(this._gl.BLEND);break;case a.Engine.ALPHA_ADD:this.setDepthWrite(!1),this._gl.blendFuncSeparate(this._gl.ONE,this._gl.ONE,this._gl.ZERO,this._gl.ONE),this._gl.enable(this._gl.BLEND)}},h.prototype.setAlphaTesting=function(a){this._alphaTest=a},h.prototype.getAlphaTesting=function(){return this._alphaTest},h.prototype.wipeCaches=function(){this._activeTexturesCache=[],this._currentEffect=null,this._cullingState=null,this._cachedVertexBuffers=null,this._cachedIndexBuffer=null,this._cachedEffectForVertexBuffers=null},h.prototype.setSamplingMode=function(b,c){var d=this._gl;d.bindTexture(d.TEXTURE_2D,b);var e=d.NEAREST,f=d.NEAREST;c===a.Texture.BILINEAR_SAMPLINGMODE?(e=d.LINEAR,f=d.LINEAR):c===a.Texture.TRILINEAR_SAMPLINGMODE&&(e=d.LINEAR,f=d.LINEAR_MIPMAP_LINEAR),d.texParameteri(d.TEXTURE_2D,d.TEXTURE_MAG_FILTER,e),d.texParameteri(d.TEXTURE_2D,d.TEXTURE_MIN_FILTER,f),d.bindTexture(d.TEXTURE_2D,null)},h.prototype.createTexture=function(b,c,d,f,g){var h=this;"undefined"==typeof g&&(g=a.Texture.TRILINEAR_SAMPLINGMODE);var i=this._gl.createTexture(),j=b.substr(b.length-4,4).toLowerCase(),k=this.getCaps().s3tc&&".dds"===j,l=".tga"===j;if(f._addPendingData(i),i.url=b,i.noMipmap=c,i.references=1,this._loadedTexturesCache.push(i),l)a.Tools.LoadFile(b,function(b){var j=new Uint8Array(b),k=a.Internals.TGATools.GetTGAHeader(j);e(i,h._gl,f,k.width,k.height,d,c,!1,function(){a.Internals.TGATools.UploadContent(h._gl,j)},g)},null,f.database,!0);else if(k)a.Tools.LoadFile(b,function(j){var k=a.Internals.DDSTools.GetDDSInfo(j),l=(k.isRGB||k.isLuminance||k.mipmapCount>1)&&!c&&k.width>>k.mipmapCount-1==1;e(i,h._gl,f,k.width,k.height,d,!l,k.isFourCC,function(){console.log("loading "+b),a.Internals.DDSTools.UploadDDSLevels(h._gl,h.getCaps().s3tc,j,k,l,1)},g)},null,f.database,!0);else{var m=function(a){e(i,h._gl,f,a.width,a.height,d,c,!1,function(b,c){var d=a.width==b&&a.height==c;d||(h._workingCanvas.width=b,h._workingCanvas.height=c,h._workingContext.drawImage(a,0,0,a.width,a.height,0,0,b,c)),h._gl.texImage2D(h._gl.TEXTURE_2D,0,h._gl.RGBA,h._gl.RGBA,h._gl.UNSIGNED_BYTE,d?a:h._workingCanvas)},g)},n=function(){f._removePendingData(i)};a.Tools.LoadImage(b,m,n,f.database)}return i},h.prototype.createDynamicTexture=function(a,b,e,f){var g=this._gl.createTexture();a=d(a,this._caps.maxTextureSize),b=d(b,this._caps.maxTextureSize),this._gl.bindTexture(this._gl.TEXTURE_2D,g);var h=c(f,e,this._gl);return this._gl.texParameteri(this._gl.TEXTURE_2D,this._gl.TEXTURE_MAG_FILTER,h.mag),this._gl.texParameteri(this._gl.TEXTURE_2D,this._gl.TEXTURE_MIN_FILTER,h.min),this._gl.bindTexture(this._gl.TEXTURE_2D,null),this._activeTexturesCache=[],g._baseWidth=a,g._baseHeight=b,g._width=a,g._height=b,g.isReady=!1,g.generateMipMaps=e,g.references=1,this._loadedTexturesCache.push(g),g},h.prototype.updateDynamicTexture=function(a,b,c){this._gl.bindTexture(this._gl.TEXTURE_2D,a),this._gl.pixelStorei(this._gl.UNPACK_FLIP_Y_WEBGL,c?1:0),this._gl.texImage2D(this._gl.TEXTURE_2D,0,this._gl.RGBA,this._gl.RGBA,this._gl.UNSIGNED_BYTE,b),a.generateMipMaps&&this._gl.generateMipmap(this._gl.TEXTURE_2D),this._gl.bindTexture(this._gl.TEXTURE_2D,null),this._activeTexturesCache=[],a.isReady=!0},h.prototype.updateVideoTexture=function(a,b,c){this._gl.bindTexture(this._gl.TEXTURE_2D,a),this._gl.pixelStorei(this._gl.UNPACK_FLIP_Y_WEBGL,c?0:1),b.videoWidth!==a._width||b.videoHeight!==a._height?(a._workingCanvas||(a._workingCanvas=document.createElement("canvas"),a._workingContext=a._workingCanvas.getContext("2d"),a._workingCanvas.width=a._width,a._workingCanvas.height=a._height),a._workingContext.drawImage(b,0,0,b.videoWidth,b.videoHeight,0,0,a._width,a._height),this._gl.texImage2D(this._gl.TEXTURE_2D,0,this._gl.RGBA,this._gl.RGBA,this._gl.UNSIGNED_BYTE,a._workingCanvas)):this._gl.texImage2D(this._gl.TEXTURE_2D,0,this._gl.RGBA,this._gl.RGBA,this._gl.UNSIGNED_BYTE,b),a.generateMipMaps&&this._gl.generateMipmap(this._gl.TEXTURE_2D),this._gl.bindTexture(this._gl.TEXTURE_2D,null),this._activeTexturesCache=[],a.isReady=!0},h.prototype.createRenderTargetTexture=function(b,d){var e=!1,f=!0,g=a.Texture.TRILINEAR_SAMPLINGMODE;void 0!==d&&(e=void 0===d.generateMipMaps?d:d.generateMipmaps,f=void 0===d.generateDepthBuffer?!0:d.generateDepthBuffer,void 0!==d.samplingMode&&(g=d.samplingMode));var h=this._gl,i=h.createTexture();h.bindTexture(h.TEXTURE_2D,i);var j=b.width||b,k=b.height||b,l=c(g,e,h);h.texParameteri(h.TEXTURE_2D,h.TEXTURE_MAG_FILTER,l.mag),h.texParameteri(h.TEXTURE_2D,h.TEXTURE_MIN_FILTER,l.min),h.texParameteri(h.TEXTURE_2D,h.TEXTURE_WRAP_S,h.CLAMP_TO_EDGE),h.texParameteri(h.TEXTURE_2D,h.TEXTURE_WRAP_T,h.CLAMP_TO_EDGE),h.texImage2D(h.TEXTURE_2D,0,h.RGBA,j,k,0,h.RGBA,h.UNSIGNED_BYTE,null);var m;f&&(m=h.createRenderbuffer(),h.bindRenderbuffer(h.RENDERBUFFER,m),h.renderbufferStorage(h.RENDERBUFFER,h.DEPTH_COMPONENT16,j,k));var n=h.createFramebuffer();return h.bindFramebuffer(h.FRAMEBUFFER,n),h.framebufferTexture2D(h.FRAMEBUFFER,h.COLOR_ATTACHMENT0,h.TEXTURE_2D,i,0),f&&h.framebufferRenderbuffer(h.FRAMEBUFFER,h.DEPTH_ATTACHMENT,h.RENDERBUFFER,m),h.bindTexture(h.TEXTURE_2D,null),h.bindRenderbuffer(h.RENDERBUFFER,null),h.bindFramebuffer(h.FRAMEBUFFER,null),i._framebuffer=n,f&&(i._depthBuffer=m),i._width=j,i._height=k,i.isReady=!0,i.generateMipMaps=e,i.references=1,this._activeTexturesCache=[],this._loadedTexturesCache.push(i),i},h.prototype.createCubeTexture=function(b,c,e,g){var h=this,i=this._gl,j=i.createTexture();j.isCube=!0,j.url=b,j.references=1,this._loadedTexturesCache.push(j);var k=b.substr(b.length-4,4).toLowerCase(),l=this.getCaps().s3tc&&".dds"===k;return l?a.Tools.LoadFile(b,function(b){var c=a.Internals.DDSTools.GetDDSInfo(b),d=(c.isRGB||c.isLuminance||c.mipmapCount>1)&&!g;i.bindTexture(i.TEXTURE_CUBE_MAP,j),i.pixelStorei(i.UNPACK_FLIP_Y_WEBGL,1),a.Internals.DDSTools.UploadDDSLevels(h._gl,h.getCaps().s3tc,b,c,d,6),g||c.isFourCC||1!=c.mipmapCount||i.generateMipmap(i.TEXTURE_CUBE_MAP),i.texParameteri(i.TEXTURE_CUBE_MAP,i.TEXTURE_MAG_FILTER,i.LINEAR),i.texParameteri(i.TEXTURE_CUBE_MAP,i.TEXTURE_MIN_FILTER,d?i.LINEAR_MIPMAP_LINEAR:i.LINEAR),i.texParameteri(i.TEXTURE_CUBE_MAP,i.TEXTURE_WRAP_S,i.CLAMP_TO_EDGE),i.texParameteri(i.TEXTURE_CUBE_MAP,i.TEXTURE_WRAP_T,i.CLAMP_TO_EDGE),i.bindTexture(i.TEXTURE_CUBE_MAP,null),h._activeTexturesCache=[],j._width=c.width,j._height=c.height,j.isReady=!0}):f(b,0,[],c,function(a){var b=d(a[0].width,h._caps.maxCubemapTextureSize),c=b;h._workingCanvas.width=b,h._workingCanvas.height=c;var e=[i.TEXTURE_CUBE_MAP_POSITIVE_X,i.TEXTURE_CUBE_MAP_POSITIVE_Y,i.TEXTURE_CUBE_MAP_POSITIVE_Z,i.TEXTURE_CUBE_MAP_NEGATIVE_X,i.TEXTURE_CUBE_MAP_NEGATIVE_Y,i.TEXTURE_CUBE_MAP_NEGATIVE_Z];i.bindTexture(i.TEXTURE_CUBE_MAP,j),i.pixelStorei(i.UNPACK_FLIP_Y_WEBGL,0);for(var f=0;f<e.length;f++)h._workingContext.drawImage(a[f],0,0,a[f].width,a[f].height,0,0,b,c),i.texImage2D(e[f],0,i.RGBA,i.RGBA,i.UNSIGNED_BYTE,h._workingCanvas);g||i.generateMipmap(i.TEXTURE_CUBE_MAP),i.texParameteri(i.TEXTURE_CUBE_MAP,i.TEXTURE_MAG_FILTER,i.LINEAR),i.texParameteri(i.TEXTURE_CUBE_MAP,i.TEXTURE_MIN_FILTER,g?i.LINEAR:i.LINEAR_MIPMAP_LINEAR),i.texParameteri(i.TEXTURE_CUBE_MAP,i.TEXTURE_WRAP_S,i.CLAMP_TO_EDGE),i.texParameteri(i.TEXTURE_CUBE_MAP,i.TEXTURE_WRAP_T,i.CLAMP_TO_EDGE),i.bindTexture(i.TEXTURE_CUBE_MAP,null),h._activeTexturesCache=[],j._width=b,j._height=c,j.isReady=!0},e),j},h.prototype._releaseTexture=function(a){var b=this._gl;a._framebuffer&&b.deleteFramebuffer(a._framebuffer),a._depthBuffer&&b.deleteRenderbuffer(a._depthBuffer),b.deleteTexture(a);for(var c=0;c<this._caps.maxTexturesImageUnits;c++)this._gl.activeTexture(this._gl["TEXTURE"+c]),this._gl.bindTexture(this._gl.TEXTURE_2D,null),this._gl.bindTexture(this._gl.TEXTURE_CUBE_MAP,null),this._activeTexturesCache[c]=null;var d=this._loadedTexturesCache.indexOf(a);-1!==d&&this._loadedTexturesCache.splice(d,1)},h.prototype.bindSamplers=function(a){this._gl.useProgram(a.getProgram());for(var b=a.getSamplers(),c=0;c<b.length;c++){var d=a.getUniform(b[c]);this._gl.uniform1i(d,c)}this._currentEffect=null},h.prototype._bindTexture=function(a,b){this._gl.activeTexture(this._gl["TEXTURE"+a]),this._gl.bindTexture(this._gl.TEXTURE_2D,b),this._activeTexturesCache[a]=null},h.prototype.setTextureFromPostProcess=function(a,b){this._bindTexture(a,b._textures.data[b._currentRenderTextureInd])},h.prototype.setTexture=function(b,c){if(!(0>b)){if(!c||!c.isReady())return void(null!=this._activeTexturesCache[b]&&(this._gl.activeTexture(this._gl["TEXTURE"+b]),this._gl.bindTexture(this._gl.TEXTURE_2D,null),this._gl.bindTexture(this._gl.TEXTURE_CUBE_MAP,null),this._activeTexturesCache[b]=null));if(c instanceof a.VideoTexture)c.update()&&(this._activeTexturesCache[b]=null);else if(c.delayLoadState==a.Engine.DELAYLOADSTATE_NOTLOADED)return void c.delayLoad();if(this._activeTexturesCache[b]!=c){this._activeTexturesCache[b]=c;var d=c.getInternalTexture();if(this._gl.activeTexture(this._gl["TEXTURE"+b]),d.isCube){if(this._gl.bindTexture(this._gl.TEXTURE_CUBE_MAP,d),d._cachedCoordinatesMode!==c.coordinatesMode){d._cachedCoordinatesMode=c.coordinatesMode;var e=c.coordinatesMode!==a.Texture.CUBIC_MODE&&c.coordinatesMode!==a.Texture.SKYBOX_MODE?this._gl.REPEAT:this._gl.CLAMP_TO_EDGE;this._gl.texParameteri(this._gl.TEXTURE_CUBE_MAP,this._gl.TEXTURE_WRAP_S,e),this._gl.texParameteri(this._gl.TEXTURE_CUBE_MAP,this._gl.TEXTURE_WRAP_T,e)}this._setAnisotropicLevel(this._gl.TEXTURE_CUBE_MAP,c)}else{if(this._gl.bindTexture(this._gl.TEXTURE_2D,d),d._cachedWrapU!==c.wrapU)switch(d._cachedWrapU=c.wrapU,c.wrapU){case a.Texture.WRAP_ADDRESSMODE:this._gl.texParameteri(this._gl.TEXTURE_2D,this._gl.TEXTURE_WRAP_S,this._gl.REPEAT);break;case a.Texture.CLAMP_ADDRESSMODE:this._gl.texParameteri(this._gl.TEXTURE_2D,this._gl.TEXTURE_WRAP_S,this._gl.CLAMP_TO_EDGE);break;case a.Texture.MIRROR_ADDRESSMODE:this._gl.texParameteri(this._gl.TEXTURE_2D,this._gl.TEXTURE_WRAP_S,this._gl.MIRRORED_REPEAT)}if(d._cachedWrapV!==c.wrapV)switch(d._cachedWrapV=c.wrapV,c.wrapV){case a.Texture.WRAP_ADDRESSMODE:this._gl.texParameteri(this._gl.TEXTURE_2D,this._gl.TEXTURE_WRAP_T,this._gl.REPEAT);break;case a.Texture.CLAMP_ADDRESSMODE:this._gl.texParameteri(this._gl.TEXTURE_2D,this._gl.TEXTURE_WRAP_T,this._gl.CLAMP_TO_EDGE);break;case a.Texture.MIRROR_ADDRESSMODE:this._gl.texParameteri(this._gl.TEXTURE_2D,this._gl.TEXTURE_WRAP_T,this._gl.MIRRORED_REPEAT)}this._setAnisotropicLevel(this._gl.TEXTURE_2D,c)}}}},h.prototype._setAnisotropicLevel=function(a,b){var c=this._caps.textureAnisotropicFilterExtension;c&&b._cachedAnisotropicFilteringLevel!==b.anisotropicFilteringLevel&&(this._gl.texParameterf(a,c.TEXTURE_MAX_ANISOTROPY_EXT,Math.min(b.anisotropicFilteringLevel,this._caps.maxAnisotropy)),b._cachedAnisotropicFilteringLevel=b.anisotropicFilteringLevel)},h.prototype.readPixels=function(a,b,c,d){var e=new Uint8Array(d*c*4);return this._gl.readPixels(0,0,c,d,this._gl.RGBA,this._gl.UNSIGNED_BYTE,e),e},h.prototype.dispose=function(){for(this.stopRenderLoop();this.scenes.length;)this.scenes[0].dispose();for(var a in this._compiledEffects)this._gl.deleteProgram(this._compiledEffects[a]._program);for(var b in this._vertexAttribArrays)b>this._gl.VERTEX_ATTRIB_ARRAY_ENABLED||!this._vertexAttribArrays[b]||this._gl.disableVertexAttribArray(b);window.removeEventListener("blur",this._onBlur),window.removeEventListener("focus",this._onFocus),document.removeEventListener("fullscreenchange",this._onFullscreenChange),document.removeEventListener("mozfullscreenchange",this._onFullscreenChange),document.removeEventListener("webkitfullscreenchange",this._onFullscreenChange),document.removeEventListener("msfullscreenchange",this._onFullscreenChange),document.removeEventListener("pointerlockchange",this._onPointerLockChange),document.removeEventListener("mspointerlockchange",this._onPointerLockChange),document.removeEventListener("mozpointerlockchange",this._onPointerLockChange),document.removeEventListener("webkitpointerlockchange",this._onPointerLockChange)},h.isSupported=function(){try{var a=document.createElement("canvas"),b=a.getContext("webgl")||a.getContext("experimental-webgl");return null!=b&&!!window.WebGLRenderingContext}catch(c){return!1}},h._ALPHA_DISABLE=0,h._ALPHA_ADD=1,h._ALPHA_COMBINE=2,h._DELAYLOADSTATE_NONE=0,h._DELAYLOADSTATE_LOADED=1,h._DELAYLOADSTATE_LOADING=2,h._DELAYLOADSTATE_NOTLOADED=4,h.Epsilon=.001,h.CollisionsEpsilon=.001,h.ShadersRepository="Babylon/Shaders/",h}();a.Engine=h}(BABYLON||(BABYLON={}));var BABYLON;!function(a){var b=function(){function b(a,b){this.state="",this.animations=new Array,this._childrenFlag=-1,this._isEnabled=!0,this._isReady=!0,this._currentRenderId=-1,this.name=a,this.id=a,this._scene=b,this._initCache()}return b.prototype.getScene=function(){return this._scene},b.prototype.getEngine=function(){return this._scene.getEngine()},b.prototype.getWorldMatrix=function(){return a.Matrix.Identity()},b.prototype._initCache=function(){this._cache={},this._cache.parent=void 0},b.prototype.updateCache=function(a){(a||!this.isSynchronized())&&(this._cache.parent=this.parent,this._updateCache())},b.prototype._updateCache=function(){},b.prototype._isSynchronized=function(){return!0},b.prototype.isSynchronizedWithParent=function(){return this.parent?this.parent._currentRenderId<=this._currentRenderId:!0},b.prototype.isSynchronized=function(a){var b=this.hasNewParent();return b=b||!this.isSynchronizedWithParent(),b=b||!this._isSynchronized(),a&&this.updateCache(!0),!b},b.prototype.hasNewParent=function(a){return this._cache.parent===this.parent?!1:(a&&(this._cache.parent=this.parent),!0)},b.prototype.isReady=function(){return this._isReady},b.prototype.isEnabled=function(){return this._isEnabled?this.parent?this.parent.isEnabled():!0:!1},b.prototype.setEnabled=function(a){this._isEnabled=a},b.prototype.isDescendantOf=function(a){return this.parent?this.parent===a?!0:this.parent.isDescendantOf(a):!1},b.prototype._getDescendants=function(a,b){for(var c=0;c<a.length;c++){var d=a[c];d.isDescendantOf(this)&&b.push(d)}},b.prototype.getDescendants=function(){var a=[];return this._getDescendants(this._scene.meshes,a),this._getDescendants(this._scene.lights,a),this._getDescendants(this._scene.cameras,a),a},b.prototype._setReady=function(a){if(a!=this._isReady){if(!a)return void(this._isReady=!1);this._isReady=!0,this.onReady&&this.onReady(this)}},b}();a.Node=b}(BABYLON||(BABYLON={}));var BABYLON;!function(a){var b=function(){function b(a,b,c,d,e,f,g,h){this.engine=a,this.canvas=c,this.currentScene=b,this.sceneLoadedCallback=d,this.progressCallback=e,this.additionnalRenderLoopLogicCallback=f,this.textureLoadingCallback=g,this.startingProcessingFilesCallback=h}return b.prototype.monitorElementForDragNDrop=function(a){var b=this;a&&(this.elementToMonitor=a,this.elementToMonitor.addEventListener("dragenter",function(a){b.drag(a)},!1),this.elementToMonitor.addEventListener("dragover",function(a){b.drag(a)},!1),this.elementToMonitor.addEventListener("drop",function(a){b.drop(a)},!1))},b.prototype.renderFunction=function(){if(this.additionnalRenderLoopLogicCallback&&this.additionnalRenderLoopLogicCallback(),this.currentScene){if(this.textureLoadingCallback){var a=this.currentScene.getWaitingItemsCount();a>0&&this.textureLoadingCallback(a)}this.currentScene.render()}},b.prototype.drag=function(a){a.stopPropagation(),a.preventDefault()},b.prototype.drop=function(a){a.stopPropagation(),a.preventDefault(),this.loadFiles(a)},b.prototype.loadFiles=function(b){var c=this,d=this;this.startingProcessingFilesCallback&&this.startingProcessingFilesCallback();var e,f;if(b&&b.dataTransfer&&b.dataTransfer.files&&(f=b.dataTransfer.files),b&&b.target&&b.target.files&&(f=b.target.files),f&&f.length>0){for(var g=0;g<f.length;g++)switch(f[g].type){case"image/jpeg":case"image/png":a.FilesInput.FilesTextures[f[g].name]=f[g];break;case"image/targa":case"image/vnd.ms-dds":a.FilesInput.FilesToLoad[f[g].name]=f[g];break;default:-1!==f[g].name.indexOf(".babylon")&&-1===f[g].name.indexOf(".manifest")&&-1===f[g].name.indexOf(".incremental")&&-1===f[g].name.indexOf(".babylonmeshdata")&&-1===f[g].name.indexOf(".babylongeometrydata")&&(e=f[g])}e?(this.currentScene&&(this.engine.stopRenderLoop(),this.currentScene.dispose()),a.SceneLoader.Load("file:",e,this.engine,function(a){d.currentScene=a,d.currentScene.executeWhenReady(function(){d.currentScene.activeCamera&&d.currentScene.activeCamera.attachControl(d.canvas),d.sceneLoadedCallback&&d.sceneLoadedCallback(e,d.currentScene),d.engine.runRenderLoop(function(){d.renderFunction()})})},function(a){c.progressCallback&&c.progressCallback(a)})):a.Tools.Error("Please provide a valid .babylon file.")}},b.FilesTextures=new Array,b.FilesToLoad=new Array,b}();a.FilesInput=b}(BABYLON||(BABYLON={}));var BABYLON;!function(a){var b=function(){function a(a,b,c){this.bu=a,this.bv=b,this.distance=c,this.faceId=0}return a}();a.IntersectionInfo=b;var c=function(){function b(){this.hit=!1,this.distance=0,this.pickedPoint=null,this.pickedMesh=null,this.pickedSubMeshIndex=null,this.bu=0,this.bv=0,this.faceId=-1
}return b.prototype.getNormal=function(){if(!this.pickedMesh||!this.pickedMesh.isVerticesDataPresent(a.VertexBuffer.NormalKind))return null;var b=this.pickedMesh.getIndices(),c=this.pickedMesh.getVerticesData(a.VertexBuffer.NormalKind),d=a.Vector3.FromArray(c,3*b[3*this.faceId]),e=a.Vector3.FromArray(c,3*b[3*this.faceId+1]),f=a.Vector3.FromArray(c,3*b[3*this.faceId+2]);return d=d.scale(this.bu),e=e.scale(this.bv),f=f.scale(1-this.bu-this.bv),new a.Vector3(d.x+e.x+f.x,d.y+e.y+f.y,d.z+e.z+f.z)},b.prototype.getTextureCoordinates=function(){if(!this.pickedMesh||!this.pickedMesh.isVerticesDataPresent(a.VertexBuffer.UVKind))return null;var b=this.pickedMesh.getIndices(),c=this.pickedMesh.getVerticesData(a.VertexBuffer.UVKind),d=a.Vector2.FromArray(c,2*b[3*this.faceId]),e=a.Vector2.FromArray(c,2*b[3*this.faceId+1]),f=a.Vector2.FromArray(c,2*b[3*this.faceId+2]);return d=d.scale(this.bu),e=e.scale(this.bv),f=f.scale(1-this.bu-this.bv),new a.Vector2(d.x+e.x+f.x,d.y+e.y+f.y)},b}();a.PickingInfo=c}(BABYLON||(BABYLON={}));var BABYLON;!function(a){var b=function(){function b(b,c){this.minimum=b,this.maximum=c,this._tempRadiusVector=a.Vector3.Zero();var d=a.Vector3.Distance(b,c);this.center=a.Vector3.Lerp(b,c,.5),this.radius=.5*d,this.centerWorld=a.Vector3.Zero(),this._update(a.Matrix.Identity())}return b.prototype._update=function(b){a.Vector3.TransformCoordinatesToRef(this.center,b,this.centerWorld),a.Vector3.TransformNormalFromFloatsToRef(1,1,1,b,this._tempRadiusVector),this.radiusWorld=Math.max(Math.abs(this._tempRadiusVector.x),Math.abs(this._tempRadiusVector.y),Math.abs(this._tempRadiusVector.z))*this.radius},b.prototype.isInFrustum=function(a){for(var b=0;6>b;b++)if(a[b].dotCoordinate(this.centerWorld)<=-this.radiusWorld)return!1;return!0},b.prototype.intersectsPoint=function(b){var c=this.centerWorld.x-b.x,d=this.centerWorld.y-b.y,e=this.centerWorld.z-b.z,f=Math.sqrt(c*c+d*d+e*e);return Math.abs(this.radiusWorld-f)<a.Engine.Epsilon?!1:!0},b.Intersects=function(a,b){var c=a.centerWorld.x-b.centerWorld.x,d=a.centerWorld.y-b.centerWorld.y,e=a.centerWorld.z-b.centerWorld.z,f=Math.sqrt(c*c+d*d+e*e);return a.radiusWorld+b.radiusWorld<f?!1:!0},b}();a.BoundingSphere=b}(BABYLON||(BABYLON={}));var BABYLON;!function(a){var b=function(){function b(b,c){this.minimum=b,this.maximum=c,this.vectors=new Array,this.vectorsWorld=new Array,this.vectors.push(this.minimum.clone()),this.vectors.push(this.maximum.clone()),this.vectors.push(this.minimum.clone()),this.vectors[2].x=this.maximum.x,this.vectors.push(this.minimum.clone()),this.vectors[3].y=this.maximum.y,this.vectors.push(this.minimum.clone()),this.vectors[4].z=this.maximum.z,this.vectors.push(this.maximum.clone()),this.vectors[5].z=this.minimum.z,this.vectors.push(this.maximum.clone()),this.vectors[6].x=this.minimum.x,this.vectors.push(this.maximum.clone()),this.vectors[7].y=this.minimum.y,this.center=this.maximum.add(this.minimum).scale(.5),this["extends"]=this.maximum.subtract(this.minimum).scale(.5),this.directions=[a.Vector3.Zero(),a.Vector3.Zero(),a.Vector3.Zero()];for(var d=0;d<this.vectors.length;d++)this.vectorsWorld[d]=a.Vector3.Zero();this.minimumWorld=a.Vector3.Zero(),this.maximumWorld=a.Vector3.Zero(),this._update(a.Matrix.Identity())}return b.prototype.getWorldMatrix=function(){return this._worldMatrix},b.prototype._update=function(b){a.Vector3.FromFloatsToRef(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE,this.minimumWorld),a.Vector3.FromFloatsToRef(-Number.MAX_VALUE,-Number.MAX_VALUE,-Number.MAX_VALUE,this.maximumWorld);for(var c=0;c<this.vectors.length;c++){var d=this.vectorsWorld[c];a.Vector3.TransformCoordinatesToRef(this.vectors[c],b,d),d.x<this.minimumWorld.x&&(this.minimumWorld.x=d.x),d.y<this.minimumWorld.y&&(this.minimumWorld.y=d.y),d.z<this.minimumWorld.z&&(this.minimumWorld.z=d.z),d.x>this.maximumWorld.x&&(this.maximumWorld.x=d.x),d.y>this.maximumWorld.y&&(this.maximumWorld.y=d.y),d.z>this.maximumWorld.z&&(this.maximumWorld.z=d.z)}this.maximumWorld.addToRef(this.minimumWorld,this.center),this.center.scaleInPlace(.5),a.Vector3.FromFloatArrayToRef(b.m,0,this.directions[0]),a.Vector3.FromFloatArrayToRef(b.m,4,this.directions[1]),a.Vector3.FromFloatArrayToRef(b.m,8,this.directions[2]),this._worldMatrix=b},b.prototype.isInFrustum=function(a){return b.IsInFrustum(this.vectorsWorld,a)},b.prototype.intersectsPoint=function(b){var c=a.Engine.Epsilon;return this.maximumWorld.x-b.x<c||c>b.x-this.minimumWorld.x?!1:this.maximumWorld.y-b.y<c||c>b.y-this.minimumWorld.y?!1:this.maximumWorld.z-b.z<c||c>b.z-this.minimumWorld.z?!1:!0},b.prototype.intersectsSphere=function(a){return b.IntersectsSphere(this.minimumWorld,this.maximumWorld,a.centerWorld,a.radiusWorld)},b.prototype.intersectsMinMax=function(a,b){return this.maximumWorld.x<a.x||this.minimumWorld.x>b.x?!1:this.maximumWorld.y<a.y||this.minimumWorld.y>b.y?!1:this.maximumWorld.z<a.z||this.minimumWorld.z>b.z?!1:!0},b.Intersects=function(a,b){return a.maximumWorld.x<b.minimumWorld.x||a.minimumWorld.x>b.maximumWorld.x?!1:a.maximumWorld.y<b.minimumWorld.y||a.minimumWorld.y>b.maximumWorld.y?!1:a.maximumWorld.z<b.minimumWorld.z||a.minimumWorld.z>b.maximumWorld.z?!1:!0},b.IntersectsSphere=function(b,c,d,e){var f=a.Vector3.Clamp(d,b,c),g=a.Vector3.DistanceSquared(d,f);return e*e>=g},b.IsInFrustum=function(a,b){for(var c=0;6>c;c++){for(var d=8,e=0;8>e&&b[c].dotCoordinate(a[e])<0;e++)--d;if(0==d)return!1}return!0},b}();a.BoundingBox=b}(BABYLON||(BABYLON={}));var BABYLON;!function(a){var b=function(b,c){var d=a.Vector3.Dot(c.center,b),e=Math.abs(a.Vector3.Dot(c.directions[0],b))*c["extends"].x,f=Math.abs(a.Vector3.Dot(c.directions[1],b))*c["extends"].y,g=Math.abs(a.Vector3.Dot(c.directions[2],b))*c["extends"].z,h=e+f+g;return{min:d-h,max:d+h}},c=function(a,b,c,d){return!(a>d||c>b)},d=function(a,d,e){var f=b(a,d),g=b(a,e);return c(f.min,f.max,g.min,g.max)},e=function(){function b(b,c){this.minimum=b,this.maximum=c,this.boundingBox=new a.BoundingBox(b,c),this.boundingSphere=new a.BoundingSphere(b,c)}return b.prototype._update=function(a){this.boundingBox._update(a),this.boundingSphere._update(a)},b.prototype.isInFrustum=function(a){return this.boundingSphere.isInFrustum(a)?this.boundingBox.isInFrustum(a):!1},b.prototype._checkCollision=function(a){return a._canDoCollision(this.boundingSphere.centerWorld,this.boundingSphere.radiusWorld,this.boundingBox.minimumWorld,this.boundingBox.maximumWorld)},b.prototype.intersectsPoint=function(a){return this.boundingSphere.centerWorld&&this.boundingSphere.intersectsPoint(a)&&this.boundingBox.intersectsPoint(a)?!0:!1},b.prototype.intersects=function(b,c){if(!this.boundingSphere.centerWorld||!b.boundingSphere.centerWorld)return!1;if(!a.BoundingSphere.Intersects(this.boundingSphere,b.boundingSphere))return!1;if(!a.BoundingBox.Intersects(this.boundingBox,b.boundingBox))return!1;if(!c)return!0;var e=this.boundingBox,f=b.boundingBox;return d(e.directions[0],e,f)&&d(e.directions[1],e,f)&&d(e.directions[2],e,f)&&d(f.directions[0],e,f)&&d(f.directions[1],e,f)&&d(f.directions[2],e,f)&&d(a.Vector3.Cross(e.directions[0],f.directions[0]),e,f)&&d(a.Vector3.Cross(e.directions[0],f.directions[1]),e,f)&&d(a.Vector3.Cross(e.directions[0],f.directions[2]),e,f)&&d(a.Vector3.Cross(e.directions[1],f.directions[0]),e,f)&&d(a.Vector3.Cross(e.directions[1],f.directions[1]),e,f)&&d(a.Vector3.Cross(e.directions[1],f.directions[2]),e,f)&&d(a.Vector3.Cross(e.directions[2],f.directions[0]),e,f)&&d(a.Vector3.Cross(e.directions[2],f.directions[1]),e,f)&&d(a.Vector3.Cross(e.directions[2],f.directions[2]),e,f)?!0:!1},b}();a.BoundingInfo=e}(BABYLON||(BABYLON={}));var __extends=this.__extends||function(a,b){function c(){this.constructor=a}for(var d in b)b.hasOwnProperty(d)&&(a[d]=b[d]);c.prototype=b.prototype,a.prototype=new c},BABYLON;!function(a){var b=function(b){function c(c,d){b.call(this,c,d),this.position=new a.Vector3(0,0,0),this.rotation=new a.Vector3(0,0,0),this.scaling=new a.Vector3(1,1,1),this.billboardMode=a.AbstractMesh.BILLBOARDMODE_NONE,this.visibility=1,this.infiniteDistance=!1,this.isVisible=!0,this.isPickable=!0,this.showBoundingBox=!1,this.showSubMeshesBoundingBox=!1,this.onDispose=null,this.checkCollisions=!1,this.renderingGroupId=0,this.receiveShadows=!1,this.useOctreeForRenderingSelection=!0,this.useOctreeForPicking=!0,this.useOctreeForCollisions=!0,this.layerMask=4294967295,this._physicImpostor=a.PhysicsEngine.NoImpostor,this.ellipsoid=new a.Vector3(.5,1,.5),this.ellipsoidOffset=new a.Vector3(0,0,0),this._collider=new a.Collider,this._oldPositionForCollisions=new a.Vector3(0,0,0),this._diffPositionForCollisions=new a.Vector3(0,0,0),this._newPositionForCollisions=new a.Vector3(0,0,0),this._localScaling=a.Matrix.Zero(),this._localRotation=a.Matrix.Zero(),this._localTranslation=a.Matrix.Zero(),this._localBillboard=a.Matrix.Zero(),this._localPivotScaling=a.Matrix.Zero(),this._localPivotScalingRotation=a.Matrix.Zero(),this._localWorld=a.Matrix.Zero(),this._worldMatrix=a.Matrix.Zero(),this._rotateYByPI=a.Matrix.RotationY(Math.PI),this._absolutePosition=a.Vector3.Zero(),this._collisionsTransformMatrix=a.Matrix.Zero(),this._collisionsScalingMatrix=a.Matrix.Zero(),this._isDirty=!1,this._pivotMatrix=a.Matrix.Identity(),this._isDisposed=!1,this._renderId=0,this._intersectionsInProgress=new Array,d.meshes.push(this)}return __extends(c,b),Object.defineProperty(c,"BILLBOARDMODE_NONE",{get:function(){return c._BILLBOARDMODE_NONE},enumerable:!0,configurable:!0}),Object.defineProperty(c,"BILLBOARDMODE_X",{get:function(){return c._BILLBOARDMODE_X},enumerable:!0,configurable:!0}),Object.defineProperty(c,"BILLBOARDMODE_Y",{get:function(){return c._BILLBOARDMODE_Y},enumerable:!0,configurable:!0}),Object.defineProperty(c,"BILLBOARDMODE_Z",{get:function(){return c._BILLBOARDMODE_Z},enumerable:!0,configurable:!0}),Object.defineProperty(c,"BILLBOARDMODE_ALL",{get:function(){return c._BILLBOARDMODE_ALL},enumerable:!0,configurable:!0}),c.prototype.getTotalVertices=function(){return 0},c.prototype.getIndices=function(){return null},c.prototype.getVerticesData=function(){return null},c.prototype.isVerticesDataPresent=function(){return!1},c.prototype.getBoundingInfo=function(){return this._boundingInfo||this._updateBoundingInfo(),this._boundingInfo},c.prototype._preActivate=function(){},c.prototype._activate=function(a){this._renderId=a},c.prototype.getWorldMatrix=function(){return this._currentRenderId!==this.getScene().getRenderId()&&this.computeWorldMatrix(),this._worldMatrix},Object.defineProperty(c.prototype,"worldMatrixFromCache",{get:function(){return this._worldMatrix},enumerable:!0,configurable:!0}),Object.defineProperty(c.prototype,"absolutePosition",{get:function(){return this._absolutePosition},enumerable:!0,configurable:!0}),c.prototype.rotate=function(b,c,d){if(this.rotationQuaternion||(this.rotationQuaternion=a.Quaternion.RotationYawPitchRoll(this.rotation.y,this.rotation.x,this.rotation.z),this.rotation=a.Vector3.Zero()),d&&0!=d){if(this.parent){var e=this.parent.getWorldMatrix().clone();e.invert(),b=a.Vector3.TransformNormal(b,e)}f=a.Quaternion.RotationAxis(b,c),this.rotationQuaternion=f.multiply(this.rotationQuaternion)}else{var f=a.Quaternion.RotationAxis(b,c);this.rotationQuaternion=this.rotationQuaternion.multiply(f)}},c.prototype.translate=function(a,b,c){var d=a.scale(b);if(c&&0!=c)this.setAbsolutePosition(this.getAbsolutePosition().add(d));else{var e=this.getPositionExpressedInLocalSpace().add(d);this.setPositionWithLocalVector(e)}},c.prototype.getAbsolutePosition=function(){return this.computeWorldMatrix(),this._absolutePosition},c.prototype.setAbsolutePosition=function(b){if(b){var c,d,e;if(void 0===b.x){if(arguments.length<3)return;c=arguments[0],d=arguments[1],e=arguments[2]}else c=b.x,d=b.y,e=b.z;if(this.parent){var f=this.parent.getWorldMatrix().clone();f.invert();var g=new a.Vector3(c,d,e);this.position=a.Vector3.TransformCoordinates(g,f)}else this.position.x=c,this.position.y=d,this.position.z=e}},c.prototype.setPivotMatrix=function(a){this._pivotMatrix=a,this._cache.pivotMatrixUpdated=!0},c.prototype.getPivotMatrix=function(){return this._pivotMatrix},c.prototype._isSynchronized=function(){if(this._isDirty)return!1;if(this.billboardMode!==c.BILLBOARDMODE_NONE)return!1;if(this._cache.pivotMatrixUpdated)return!1;if(this.infiniteDistance)return!1;if(!this._cache.position.equals(this.position))return!1;if(this.rotationQuaternion){if(!this._cache.rotationQuaternion.equals(this.rotationQuaternion))return!1}else if(!this._cache.rotation.equals(this.rotation))return!1;return this._cache.scaling.equals(this.scaling)?!0:!1},c.prototype._initCache=function(){b.prototype._initCache.call(this),this._cache.localMatrixUpdated=!1,this._cache.position=a.Vector3.Zero(),this._cache.scaling=a.Vector3.Zero(),this._cache.rotation=a.Vector3.Zero(),this._cache.rotationQuaternion=new a.Quaternion(0,0,0,0)},c.prototype.markAsDirty=function(a){"rotation"===a&&(this.rotationQuaternion=null),this._currentRenderId=Number.MAX_VALUE,this._isDirty=!0},c.prototype._updateBoundingInfo=function(){if(this._boundingInfo=this._boundingInfo||new a.BoundingInfo(this.absolutePosition,this.absolutePosition),this._boundingInfo._update(this.worldMatrixFromCache),this.subMeshes)for(var b=0;b<this.subMeshes.length;b++){var c=this.subMeshes[b];c.updateBoundingInfo(this.worldMatrixFromCache)}},c.prototype.computeWorldMatrix=function(b){if(!b&&(this._currentRenderId==this.getScene().getRenderId()||this.isSynchronized(!0)))return this._worldMatrix;if(this._cache.position.copyFrom(this.position),this._cache.scaling.copyFrom(this.scaling),this._cache.pivotMatrixUpdated=!1,this._currentRenderId=this.getScene().getRenderId(),this._isDirty=!1,a.Matrix.ScalingToRef(this.scaling.x,this.scaling.y,this.scaling.z,this._localScaling),this.rotationQuaternion?(this.rotationQuaternion.toRotationMatrix(this._localRotation),this._cache.rotationQuaternion.copyFrom(this.rotationQuaternion)):(a.Matrix.RotationYawPitchRollToRef(this.rotation.y,this.rotation.x,this.rotation.z,this._localRotation),this._cache.rotation.copyFrom(this.rotation)),this.infiniteDistance&&!this.parent){var d=this.getScene().activeCamera,e=d.getWorldMatrix(),f=new a.Vector3(e.m[12],e.m[13],e.m[14]);a.Matrix.TranslationToRef(this.position.x+f.x,this.position.y+f.y,this.position.z+f.z,this._localTranslation)}else a.Matrix.TranslationToRef(this.position.x,this.position.y,this.position.z,this._localTranslation);if(this._pivotMatrix.multiplyToRef(this._localScaling,this._localPivotScaling),this._localPivotScaling.multiplyToRef(this._localRotation,this._localPivotScalingRotation),this.billboardMode!==c.BILLBOARDMODE_NONE){var g=this.position.clone(),h=this.getScene().activeCamera.position.clone();this.parent&&this.parent.position&&(g.addInPlace(this.parent.position),a.Matrix.TranslationToRef(g.x,g.y,g.z,this._localTranslation)),(this.billboardMode&c.BILLBOARDMODE_ALL)===c.BILLBOARDMODE_ALL?h=this.getScene().activeCamera.position:(this.billboardMode&a.AbstractMesh.BILLBOARDMODE_X&&(h.x=g.x+a.Engine.Epsilon),this.billboardMode&a.AbstractMesh.BILLBOARDMODE_Y&&(h.y=g.y+.001),this.billboardMode&a.AbstractMesh.BILLBOARDMODE_Z&&(h.z=g.z+.001)),a.Matrix.LookAtLHToRef(g,h,a.Vector3.Up(),this._localBillboard),this._localBillboard.m[12]=this._localBillboard.m[13]=this._localBillboard.m[14]=0,this._localBillboard.invert(),this._localPivotScalingRotation.multiplyToRef(this._localBillboard,this._localWorld),this._rotateYByPI.multiplyToRef(this._localWorld,this._localPivotScalingRotation)}return this._localPivotScalingRotation.multiplyToRef(this._localTranslation,this._localWorld),this.parent&&this.parent.getWorldMatrix&&this.billboardMode===a.AbstractMesh.BILLBOARDMODE_NONE?this._localWorld.multiplyToRef(this.parent.getWorldMatrix(),this._worldMatrix):this._worldMatrix.copyFrom(this._localWorld),this._updateBoundingInfo(),this._absolutePosition.copyFromFloats(this._worldMatrix.m[12],this._worldMatrix.m[13],this._worldMatrix.m[14]),this._worldMatrix},c.prototype.setPositionWithLocalVector=function(b){this.computeWorldMatrix(),this.position=a.Vector3.TransformNormal(b,this._localWorld)},c.prototype.getPositionExpressedInLocalSpace=function(){this.computeWorldMatrix();var b=this._localWorld.clone();return b.invert(),a.Vector3.TransformNormal(this.position,b)},c.prototype.locallyTranslate=function(b){this.computeWorldMatrix(),this.position=a.Vector3.TransformCoordinates(b,this._localWorld)},c.prototype.lookAt=function(b,c,d,e){c=c||0,d=d||0,e=e||0;var f=b.subtract(this.position),g=-Math.atan2(f.z,f.x)-Math.PI/2,h=Math.sqrt(f.x*f.x+f.z*f.z),i=Math.atan2(f.y,h);this.rotationQuaternion=a.Quaternion.RotationYawPitchRoll(g+c,i+d,e)},c.prototype.isInFrustum=function(a){return this._boundingInfo.isInFrustum(a)?!0:!1},c.prototype.intersectsMesh=function(a,b){return this._boundingInfo&&a._boundingInfo?this._boundingInfo.intersects(a._boundingInfo,b):!1},c.prototype.intersectsPoint=function(a){return this._boundingInfo?this._boundingInfo.intersectsPoint(a):!1},c.prototype.setPhysicsState=function(b,c){var d=this.getScene().getPhysicsEngine();if(d){if(b.impostor&&(c=b,b=b.impostor),b=b||a.PhysicsEngine.NoImpostor,b===a.PhysicsEngine.NoImpostor)return void d._unregisterMesh(this);c.mass=c.mass||0,c.friction=c.friction||.2,c.restitution=c.restitution||.9,this._physicImpostor=b,this._physicsMass=c.mass,this._physicsFriction=c.friction,this._physicRestitution=c.restitution,d._registerMesh(this,b,c)}},c.prototype.getPhysicsImpostor=function(){return this._physicImpostor?this._physicImpostor:a.PhysicsEngine.NoImpostor},c.prototype.getPhysicsMass=function(){return this._physicsMass?this._physicsMass:0},c.prototype.getPhysicsFriction=function(){return this._physicsFriction?this._physicsFriction:0},c.prototype.getPhysicsRestitution=function(){return this._physicRestitution?this._physicRestitution:0},c.prototype.applyImpulse=function(a,b){this._physicImpostor&&this.getScene().getPhysicsEngine()._applyImpulse(this,a,b)},c.prototype.setPhysicsLinkWith=function(a,b,c){this._physicImpostor&&this.getScene().getPhysicsEngine()._createLink(this,a,b,c)},c.prototype.moveWithCollisions=function(b){var c=this.getAbsolutePosition();c.subtractFromFloatsToRef(0,this.ellipsoid.y,0,this._oldPositionForCollisions),this._oldPositionForCollisions.addInPlace(this.ellipsoidOffset),this._collider.radius=this.ellipsoid,this.getScene()._getNewPosition(this._oldPositionForCollisions,b,this._collider,3,this._newPositionForCollisions,this),this._newPositionForCollisions.subtractToRef(this._oldPositionForCollisions,this._diffPositionForCollisions),this._diffPositionForCollisions.length()>a.Engine.CollisionsEpsilon&&this.position.addInPlace(this._diffPositionForCollisions)},c.prototype.createOrUpdateSubmeshesOctree=function(b,c){"undefined"==typeof b&&(b=64),"undefined"==typeof c&&(c=2),this._submeshesOctree||(this._submeshesOctree=new a.Octree(a.Octree.CreationFuncForSubMeshes,b,c)),this.computeWorldMatrix(!0);var d=this.getBoundingInfo().boundingBox;return this._submeshesOctree.update(d.minimumWorld,d.maximumWorld,this.subMeshes),this._submeshesOctree},c.prototype._collideForSubMesh=function(b,c,d){if(this._generatePointsArray(),!b._lastColliderWorldVertices||!b._lastColliderTransformMatrix.equals(c)){b._lastColliderTransformMatrix=c.clone(),b._lastColliderWorldVertices=[],b._trianglePlanes=[];for(var e=b.verticesStart,f=b.verticesStart+b.verticesCount,g=e;f>g;g++)b._lastColliderWorldVertices.push(a.Vector3.TransformCoordinates(this._positions[g],c))}d._collide(b,b._lastColliderWorldVertices,this.getIndices(),b.indexStart,b.indexStart+b.indexCount,b.verticesStart)},c.prototype._processCollisionsForSubMeshes=function(a,b){var c,d;if(this._submeshesOctree&&this.useOctreeForCollisions){var e=a.velocityWorldLength+Math.max(a.radius.x,a.radius.y,a.radius.z),f=this._submeshesOctree.intersects(a.basePointWorld,e);d=f.length,c=f.data}else c=this.subMeshes,d=c.length;for(var g=0;d>g;g++){var h=c[g];d>1&&!h._checkCollision(a)||this._collideForSubMesh(h,b,a)}},c.prototype._checkCollision=function(b){this._boundingInfo._checkCollision(b)&&(a.Matrix.ScalingToRef(1/b.radius.x,1/b.radius.y,1/b.radius.z,this._collisionsScalingMatrix),this.worldMatrixFromCache.multiplyToRef(this._collisionsScalingMatrix,this._collisionsTransformMatrix),this._processCollisionsForSubMeshes(b,this._collisionsTransformMatrix))},c.prototype._generatePointsArray=function(){return!1},c.prototype.intersects=function(b,c,d,e){var f=new a.PickingInfo;if(!(this.subMeshes&&this._boundingInfo&&b.intersectsSphere(this._boundingInfo.boundingSphere)&&b.intersectsBox(this._boundingInfo.boundingBox)))return f;if(!this._generatePointsArray())return f;var g,h,i,j=null;if(this._submeshesOctree&&this.useOctreeForPicking){var k=a.Ray.Transform(b,this.getWorldMatrix()),l=this._submeshesOctree.intersectsRay(k);i=l.length,h=l.data}else h=this.subMeshes,i=h.length;for(var m=0;i>m;m++){var n=h[m];if(!(i>1)||n.canIntersects(b)){var o=n.intersects(b,this._positions,this.getIndices(),c,e);if(o){if(d&&n.getMaterial().alpha<.3)continue;if((c||!j||o.distance<j.distance)&&(j=o,g=m,c))break}}}if(j){var p=this.getWorldMatrix(),q=a.Vector3.TransformCoordinates(b.origin,p),r=b.direction.clone();r.normalize(),r=r.scale(j.distance);var s=a.Vector3.TransformNormal(r,p),t=q.add(s);return f.hit=!0,f.distance=a.Vector3.Distance(q,t),f.pickedPoint=t,f.pickedMesh=this,f.pickedSubMeshIndex=g,f.bu=j.bu,f.bv=j.bv,f.faceId=j.faceId,f}return f},c.prototype.clone=function(){return null},c.prototype.releaseSubMeshes=function(){if(this.subMeshes)for(;this.subMeshes.length;)this.subMeshes[0].dispose();else this.subMeshes=new Array},c.prototype.dispose=function(b){for(this.getPhysicsImpostor()!=a.PhysicsEngine.NoImpostor&&this.setPhysicsState(a.PhysicsEngine.NoImpostor),e=0;e<this._intersectionsInProgress.length;e++){var c=this._intersectionsInProgress[e],d=c._intersectionsInProgress.indexOf(this);c._intersectionsInProgress.splice(d,1)}this._intersectionsInProgress=[],this.releaseSubMeshes();var e=this.getScene().meshes.indexOf(this);if(this.getScene().meshes.splice(e,1),b)for(e=0;e<this.getScene().meshes.length;e++){var f=this.getScene().meshes[e];f.parent===this&&(f.parent=null,f.computeWorldMatrix(!0))}else{for(e=0;e<this.getScene().particleSystems.length;e++)this.getScene().particleSystems[e].emitter==this&&(this.getScene().particleSystems[e].dispose(),e--);var g=this.getScene().meshes.slice(0);for(e=0;e<g.length;e++)g[e].parent==this&&g[e].dispose()}this._isDisposed=!0,this.onDispose&&this.onDispose()},c._BILLBOARDMODE_NONE=0,c._BILLBOARDMODE_X=1,c._BILLBOARDMODE_Y=2,c._BILLBOARDMODE_Z=4,c._BILLBOARDMODE_ALL=7,c}(a.Node);a.AbstractMesh=b}(BABYLON||(BABYLON={}));var __extends=this.__extends||function(a,b){function c(){this.constructor=a}for(var d in b)b.hasOwnProperty(d)&&(a[d]=b[d]);c.prototype=b.prototype,a.prototype=new c},BABYLON;!function(a){var b=function(b){function c(c,d){b.call(this,c,d),this.diffuse=new a.Color3(1,1,1),this.specular=new a.Color3(1,1,1),this.intensity=1,this.range=Number.MAX_VALUE,this.excludedMeshes=new Array,this._excludedMeshesIds=new Array,d.lights.push(this)}return __extends(c,b),c.prototype.getShadowGenerator=function(){return this._shadowGenerator},c.prototype.transferToEffect=function(){},c.prototype._getWorldMatrix=function(){return a.Matrix.Identity()},c.prototype.getWorldMatrix=function(){this._currentRenderId=this.getScene().getRenderId();var b=this._getWorldMatrix();return this.parent&&this.parent.getWorldMatrix?(this._parentedWorldMatrix||(this._parentedWorldMatrix=a.Matrix.Identity()),b.multiplyToRef(this.parent.getWorldMatrix(),this._parentedWorldMatrix),this._parentedWorldMatrix):b},c.prototype.dispose=function(){this._shadowGenerator&&(this._shadowGenerator.dispose(),this._shadowGenerator=null);var a=this.getScene().lights.indexOf(this);this.getScene().lights.splice(a,1)},c}(a.Node);a.Light=b}(BABYLON||(BABYLON={}));var __extends=this.__extends||function(a,b){function c(){this.constructor=a}for(var d in b)b.hasOwnProperty(d)&&(a[d]=b[d]);c.prototype=b.prototype,a.prototype=new c},BABYLON;!function(a){var b=function(b){function c(a,c,d){b.call(this,a,d),this.position=c}return __extends(c,b),c.prototype.transferToEffect=function(b,c){return this.parent&&this.parent.getWorldMatrix?(this._transformedPosition||(this._transformedPosition=a.Vector3.Zero()),a.Vector3.TransformCoordinatesToRef(this.position,this.parent.getWorldMatrix(),this._transformedPosition),void b.setFloat4(c,this._transformedPosition.x,this._transformedPosition.y,this._transformedPosition.z,0)):void b.setFloat4(c,this.position.x,this.position.y,this.position.z,0)},c.prototype.getShadowGenerator=function(){return null},c.prototype._getWorldMatrix=function(){return this._worldMatrix||(this._worldMatrix=a.Matrix.Identity()),a.Matrix.TranslationToRef(this.position.x,this.position.y,this.position.z,this._worldMatrix),this._worldMatrix},c}(a.Light);a.PointLight=b}(BABYLON||(BABYLON={}));var __extends=this.__extends||function(a,b){function c(){this.constructor=a}for(var d in b)b.hasOwnProperty(d)&&(a[d]=b[d]);c.prototype=b.prototype,a.prototype=new c},BABYLON;!function(a){var b=function(b){function c(a,c,d,e,f,g){b.call(this,a,g),this.position=c,this.direction=d,this.angle=e,this.exponent=f}return __extends(c,b),c.prototype.setDirectionToTarget=function(b){return this.direction=a.Vector3.Normalize(b.subtract(this.position)),this.direction},c.prototype.transferToEffect=function(b,c,d){var e;if(this.parent&&this.parent.getWorldMatrix){this._transformedDirection||(this._transformedDirection=a.Vector3.Zero()),this._transformedPosition||(this._transformedPosition=a.Vector3.Zero());var f=this.parent.getWorldMatrix();a.Vector3.TransformCoordinatesToRef(this.position,f,this._transformedPosition),a.Vector3.TransformNormalToRef(this.direction,f,this._transformedDirection),b.setFloat4(c,this._transformedPosition.x,this._transformedPosition.y,this._transformedPosition.z,this.exponent),e=a.Vector3.Normalize(this._transformedDirection)}else b.setFloat4(c,this.position.x,this.position.y,this.position.z,this.exponent),e=a.Vector3.Normalize(this.direction);b.setFloat4(d,e.x,e.y,e.z,Math.cos(.5*this.angle))},c.prototype._getWorldMatrix=function(){return this._worldMatrix||(this._worldMatrix=a.Matrix.Identity()),a.Matrix.TranslationToRef(this.position.x,this.position.y,this.position.z,this._worldMatrix),this._worldMatrix},c}(a.Light);a.SpotLight=b}(BABYLON||(BABYLON={}));var __extends=this.__extends||function(a,b){function c(){this.constructor=a}for(var d in b)b.hasOwnProperty(d)&&(a[d]=b[d]);c.prototype=b.prototype,a.prototype=new c},BABYLON;!function(a){var b=function(b){function c(c,d,e){b.call(this,c,e),this.direction=d,this.groundColor=new a.Color3(0,0,0)}return __extends(c,b),c.prototype.setDirectionToTarget=function(b){return this.direction=a.Vector3.Normalize(b.subtract(a.Vector3.Zero())),this.direction},c.prototype.getShadowGenerator=function(){return null},c.prototype.transferToEffect=function(b,c,d){var e=a.Vector3.Normalize(this.direction);b.setFloat4(c,e.x,e.y,e.z,0),b.setColor3(d,this.groundColor.scale(this.intensity))},c.prototype._getWorldMatrix=function(){return this._worldMatrix||(this._worldMatrix=a.Matrix.Identity()),this._worldMatrix},c}(a.Light);a.HemisphericLight=b}(BABYLON||(BABYLON={}));var __extends=this.__extends||function(a,b){function c(){this.constructor=a}for(var d in b)b.hasOwnProperty(d)&&(a[d]=b[d]);c.prototype=b.prototype,a.prototype=new c},BABYLON;!function(a){var b=function(b){function c(a,c,d){b.call(this,a,d),this.direction=c,this.position=c.scale(-1)}return __extends(c,b),c.prototype.setDirectionToTarget=function(b){return this.direction=a.Vector3.Normalize(b.subtract(this.position)),this.direction},c.prototype._computeTransformedPosition=function(){return this.parent&&this.parent.getWorldMatrix?(this._transformedPosition||(this._transformedPosition=a.Vector3.Zero()),a.Vector3.TransformCoordinatesToRef(this.position,this.parent.getWorldMatrix(),this._transformedPosition),!0):!1},c.prototype.transferToEffect=function(b,c){return this.parent&&this.parent.getWorldMatrix?(this._transformedDirection||(this._transformedDirection=a.Vector3.Zero()),a.Vector3.TransformNormalToRef(this.direction,this.parent.getWorldMatrix(),this._transformedDirection),void b.setFloat4(c,this._transformedDirection.x,this._transformedDirection.y,this._transformedDirection.z,1)):void b.setFloat4(c,this.direction.x,this.direction.y,this.direction.z,1)},c.prototype._getWorldMatrix=function(){return this._worldMatrix||(this._worldMatrix=a.Matrix.Identity()),a.Matrix.TranslationToRef(this.position.x,this.position.y,this.position.z,this._worldMatrix),this._worldMatrix},c}(a.Light);a.DirectionalLight=b}(BABYLON||(BABYLON={}));var BABYLON;!function(a){var b=function(){function b(c,d){var e=this;this.filter=b.FILTER_VARIANCESHADOWMAP,this.usePoissonSampling=!1,this._darkness=0,this._transparencyShadow=!1,this._viewMatrix=a.Matrix.Zero(),this._projectionMatrix=a.Matrix.Zero(),this._transformMatrix=a.Matrix.Zero(),this._worldViewProjection=a.Matrix.Zero(),this._light=d,this._scene=d.getScene(),d._shadowGenerator=this,this._shadowMap=new a.RenderTargetTexture(d.name+"_shadowMap",c,this._scene,!1),this._shadowMap.wrapU=a.Texture.CLAMP_ADDRESSMODE,this._shadowMap.wrapV=a.Texture.CLAMP_ADDRESSMODE,this._shadowMap.renderParticles=!1;var f=function(b){var c=b.getRenderingMesh(),d=e._scene,f=d.getEngine();f.setState(b.getMaterial().backFaceCulling);var g=c._getInstancesRenderList(b._id);if(!g.mustReturn){var h=null!==f.getCaps().instancedArrays&&null!==g.visibleInstances;if(e.isReady(b,h)){f.enableEffect(e._effect),c._bind(b,e._effect,!1);var i=b.getMaterial();if(e._effect.setMatrix("viewProjection",e.getTransformMatrix()),i&&i.needAlphaTesting()){var j=i.getAlphaTestTexture();e._effect.setTexture("diffuseSampler",j),e._effect.setMatrix("diffuseMatrix",j.getTextureMatrix())}var k=c.skeleton&&c.isVerticesDataPresent(a.VertexBuffer.MatricesIndicesKind)&&c.isVerticesDataPresent(a.VertexBuffer.MatricesWeightsKind);if(k&&e._effect.setMatrices("mBones",c.skeleton.getTransformMatrices()),h)c._renderWithInstances(b,!1,g,e._effect,f);else if(g.renderSelf[b._id]&&(e._effect.setMatrix("world",c.getWorldMatrix()),c._draw(b,!0)),g.visibleInstances[b._id])for(var l=0;l<g.visibleInstances[b._id].length;l++){var m=g.visibleInstances[b._id][l];e._effect.setMatrix("world",m.getWorldMatrix()),c._draw(b,!0)}}else e._shadowMap.resetRefreshCounter()}};this._shadowMap.customRenderFunction=function(a,b,c){var d;for(d=0;d<a.length;d++)f(a.data[d]);for(d=0;d<b.length;d++)f(b.data[d]);if(e._transparencyShadow)for(d=0;d<c.length;d++)f(c.data[d])}}return Object.defineProperty(b,"FILTER_NONE",{get:function(){return b._FILTER_NONE},enumerable:!0,configurable:!0}),Object.defineProperty(b,"FILTER_VARIANCESHADOWMAP",{get:function(){return b._FILTER_VARIANCESHADOWMAP},enumerable:!0,configurable:!0}),Object.defineProperty(b,"FILTER_POISSONSAMPLING",{get:function(){return b._FILTER_POISSONSAMPLING},enumerable:!0,configurable:!0}),Object.defineProperty(b.prototype,"useVarianceShadowMap",{get:function(){return this.filter===b.FILTER_VARIANCESHADOWMAP},set:function(a){this.filter=a?b.FILTER_VARIANCESHADOWMAP:b.FILTER_NONE},enumerable:!0,configurable:!0}),Object.defineProperty(b.prototype,"usePoissonSampling",{get:function(){return this.filter===b.FILTER_POISSONSAMPLING},set:function(a){this.filter=a?b.FILTER_POISSONSAMPLING:b.FILTER_NONE},enumerable:!0,configurable:!0}),b.prototype.isReady=function(b,c){var d=[];this.useVarianceShadowMap&&d.push("#define VSM");var e=[a.VertexBuffer.PositionKind],f=b.getMesh(),g=b.getMaterial();g&&g.needAlphaTesting()&&(d.push("#define ALPHATEST"),f.isVerticesDataPresent(a.VertexBuffer.UVKind)&&(e.push(a.VertexBuffer.UVKind),d.push("#define UV1")),f.isVerticesDataPresent(a.VertexBuffer.UV2Kind)&&(e.push(a.VertexBuffer.UV2Kind),d.push("#define UV2"))),f.skeleton&&f.isVerticesDataPresent(a.VertexBuffer.MatricesIndicesKind)&&f.isVerticesDataPresent(a.VertexBuffer.MatricesWeightsKind)&&(e.push(a.VertexBuffer.MatricesIndicesKind),e.push(a.VertexBuffer.MatricesWeightsKind),d.push("#define BONES"),d.push("#define BonesPerMesh "+(f.skeleton.bones.length+1))),c&&(d.push("#define INSTANCES"),e.push("world0"),e.push("world1"),e.push("world2"),e.push("world3"));
var h=d.join("\n");return this._cachedDefines!=h&&(this._cachedDefines=h,this._effect=this._scene.getEngine().createEffect("shadowMap",e,["world","mBones","viewProjection","diffuseMatrix"],["diffuseSampler"],h)),this._effect.isReady()},b.prototype.getShadowMap=function(){return this._shadowMap},b.prototype.getLight=function(){return this._light},b.prototype.getTransformMatrix=function(){var b=this._light.position,c=this._light.direction;if(this._light._computeTransformedPosition()&&(b=this._light._transformedPosition),!(this._cachedPosition&&this._cachedDirection&&b.equals(this._cachedPosition)&&c.equals(this._cachedDirection))){this._cachedPosition=b.clone(),this._cachedDirection=c.clone();var d=this._scene.activeCamera;a.Matrix.LookAtLHToRef(b,this._light.position.add(c),a.Vector3.Up(),this._viewMatrix),a.Matrix.PerspectiveFovLHToRef(Math.PI/2,1,d.minZ,d.maxZ,this._projectionMatrix),this._viewMatrix.multiplyToRef(this._projectionMatrix,this._transformMatrix)}return this._transformMatrix},b.prototype.getDarkness=function(){return this._darkness},b.prototype.setDarkness=function(a){this._darkness=a>=1?1:0>=a?0:a},b.prototype.setTransparencyShadow=function(a){this._transparencyShadow=a},b.prototype.dispose=function(){this._shadowMap.dispose()},b._FILTER_NONE=0,b._FILTER_VARIANCESHADOWMAP=1,b._FILTER_POISSONSAMPLING=2,b}();a.ShadowGenerator=b}(BABYLON||(BABYLON={}));var BABYLON;!function(a){var b=function(a,b,c,d){return a.x>c.x+d?!1:c.x-d>b.x?!1:a.y>c.y+d?!1:c.y-d>b.y?!1:a.z>c.z+d?!1:c.z-d>b.z?!1:!0},c=function(a,b,c,d){var e=b*b-4*a*c,f={root:0,found:!1};if(0>e)return f;var g=Math.sqrt(e),h=(-b-g)/(2*a),i=(-b+g)/(2*a);if(h>i){var j=i;i=h,h=j}return h>0&&d>h?(f.root=h,f.found=!0,f):i>0&&d>i?(f.root=i,f.found=!0,f):f},d=function(){function d(){this.radius=new a.Vector3(1,1,1),this.retry=0,this.basePointWorld=a.Vector3.Zero(),this.velocityWorld=a.Vector3.Zero(),this.normalizedVelocity=a.Vector3.Zero(),this._collisionPoint=a.Vector3.Zero(),this._planeIntersectionPoint=a.Vector3.Zero(),this._tempVector=a.Vector3.Zero(),this._tempVector2=a.Vector3.Zero(),this._tempVector3=a.Vector3.Zero(),this._tempVector4=a.Vector3.Zero(),this._edge=a.Vector3.Zero(),this._baseToVertex=a.Vector3.Zero(),this._destinationPoint=a.Vector3.Zero(),this._slidePlaneNormal=a.Vector3.Zero(),this._displacementVector=a.Vector3.Zero()}return d.prototype._initialize=function(b,c,d){this.velocity=c,a.Vector3.NormalizeToRef(c,this.normalizedVelocity),this.basePoint=b,b.multiplyToRef(this.radius,this.basePointWorld),c.multiplyToRef(this.radius,this.velocityWorld),this.velocityWorldLength=this.velocityWorld.length(),this.epsilon=d,this.collisionFound=!1},d.prototype._checkPointInTriangle=function(b,c,d,e,f){c.subtractToRef(b,this._tempVector),d.subtractToRef(b,this._tempVector2),a.Vector3.CrossToRef(this._tempVector,this._tempVector2,this._tempVector4);var g=a.Vector3.Dot(this._tempVector4,f);return 0>g?!1:(e.subtractToRef(b,this._tempVector3),a.Vector3.CrossToRef(this._tempVector2,this._tempVector3,this._tempVector4),g=a.Vector3.Dot(this._tempVector4,f),0>g?!1:(a.Vector3.CrossToRef(this._tempVector3,this._tempVector,this._tempVector4),g=a.Vector3.Dot(this._tempVector4,f),g>=0))},d.prototype._canDoCollision=function(c,d,e,f){var g=a.Vector3.Distance(this.basePointWorld,c),h=Math.max(this.radius.x,this.radius.y,this.radius.z);return g>this.velocityWorldLength+h+d?!1:b(e,f,this.basePointWorld,this.velocityWorldLength+h)?!0:!1},d.prototype._testTriangle=function(b,d,e,f,g){var h,i=!1;d._trianglePlanes||(d._trianglePlanes=[]),d._trianglePlanes[b]||(d._trianglePlanes[b]=new a.Plane(0,0,0,0),d._trianglePlanes[b].copyFromPoints(e,f,g));var j=d._trianglePlanes[b];if(d.getMaterial()||j.isFrontFacingTo(this.normalizedVelocity,0)){var k=j.signedDistanceTo(this.basePoint),l=a.Vector3.Dot(j.normal,this.velocity);if(0==l){if(Math.abs(k)>=1)return;i=!0,h=0}else{h=(-1-k)/l;var m=(1-k)/l;if(h>m){var n=m;m=h,h=n}if(h>1||0>m)return;0>h&&(h=0),h>1&&(h=1)}this._collisionPoint.copyFromFloats(0,0,0);var o=!1,p=1;if(i||(this.basePoint.subtractToRef(j.normal,this._planeIntersectionPoint),this.velocity.scaleToRef(h,this._tempVector),this._planeIntersectionPoint.addInPlace(this._tempVector),this._checkPointInTriangle(this._planeIntersectionPoint,e,f,g,j.normal)&&(o=!0,p=h,this._collisionPoint.copyFrom(this._planeIntersectionPoint))),!o){var q=this.velocity.lengthSquared(),r=q;this.basePoint.subtractToRef(e,this._tempVector);var s=2*a.Vector3.Dot(this.velocity,this._tempVector),t=this._tempVector.lengthSquared()-1,u=c(r,s,t,p);u.found&&(p=u.root,o=!0,this._collisionPoint.copyFrom(e)),this.basePoint.subtractToRef(f,this._tempVector),s=2*a.Vector3.Dot(this.velocity,this._tempVector),t=this._tempVector.lengthSquared()-1,u=c(r,s,t,p),u.found&&(p=u.root,o=!0,this._collisionPoint.copyFrom(f)),this.basePoint.subtractToRef(g,this._tempVector),s=2*a.Vector3.Dot(this.velocity,this._tempVector),t=this._tempVector.lengthSquared()-1,u=c(r,s,t,p),u.found&&(p=u.root,o=!0,this._collisionPoint.copyFrom(g)),f.subtractToRef(e,this._edge),e.subtractToRef(this.basePoint,this._baseToVertex);var v=this._edge.lengthSquared(),w=a.Vector3.Dot(this._edge,this.velocity),x=a.Vector3.Dot(this._edge,this._baseToVertex);if(r=v*-q+w*w,s=2*v*a.Vector3.Dot(this.velocity,this._baseToVertex)-2*w*x,t=v*(1-this._baseToVertex.lengthSquared())+x*x,u=c(r,s,t,p),u.found){var y=(w*u.root-x)/v;y>=0&&1>=y&&(p=u.root,o=!0,this._edge.scaleInPlace(y),e.addToRef(this._edge,this._collisionPoint))}g.subtractToRef(f,this._edge),f.subtractToRef(this.basePoint,this._baseToVertex),v=this._edge.lengthSquared(),w=a.Vector3.Dot(this._edge,this.velocity),x=a.Vector3.Dot(this._edge,this._baseToVertex),r=v*-q+w*w,s=2*v*a.Vector3.Dot(this.velocity,this._baseToVertex)-2*w*x,t=v*(1-this._baseToVertex.lengthSquared())+x*x,u=c(r,s,t,p),u.found&&(y=(w*u.root-x)/v,y>=0&&1>=y&&(p=u.root,o=!0,this._edge.scaleInPlace(y),f.addToRef(this._edge,this._collisionPoint))),e.subtractToRef(g,this._edge),g.subtractToRef(this.basePoint,this._baseToVertex),v=this._edge.lengthSquared(),w=a.Vector3.Dot(this._edge,this.velocity),x=a.Vector3.Dot(this._edge,this._baseToVertex),r=v*-q+w*w,s=2*v*a.Vector3.Dot(this.velocity,this._baseToVertex)-2*w*x,t=v*(1-this._baseToVertex.lengthSquared())+x*x,u=c(r,s,t,p),u.found&&(y=(w*u.root-x)/v,y>=0&&1>=y&&(p=u.root,o=!0,this._edge.scaleInPlace(y),g.addToRef(this._edge,this._collisionPoint)))}if(o){var z=p*this.velocity.length();(!this.collisionFound||z<this.nearestDistance)&&(this.intersectionPoint?this.intersectionPoint.copyFrom(this._collisionPoint):this.intersectionPoint=this._collisionPoint.clone(),this.nearestDistance=z,this.collisionFound=!0,this.collidedMesh=d.getMesh())}}},d.prototype._collide=function(a,b,c,d,e,f){for(var g=d;e>g;g+=3){var h=b[c[g]-f],i=b[c[g+1]-f],j=b[c[g+2]-f];this._testTriangle(g,a,j,i,h)}},d.prototype._getResponse=function(b,c){b.addToRef(c,this._destinationPoint),c.scaleInPlace(this.nearestDistance/c.length()),this.basePoint.addToRef(c,b),b.subtractToRef(this.intersectionPoint,this._slidePlaneNormal),this._slidePlaneNormal.normalize(),this._slidePlaneNormal.scaleToRef(this.epsilon,this._displacementVector),b.addInPlace(this._displacementVector),this.intersectionPoint.addInPlace(this._displacementVector),this._slidePlaneNormal.scaleInPlace(a.Plane.SignedDistanceToPlaneFromPositionAndNormal(this.intersectionPoint,this._slidePlaneNormal,this._destinationPoint)),this._destinationPoint.subtractInPlace(this._slidePlaneNormal),this._destinationPoint.subtractToRef(this.intersectionPoint,c)},d}();a.Collider=d}(BABYLON||(BABYLON={}));var __extends=this.__extends||function(a,b){function c(){this.constructor=a}for(var d in b)b.hasOwnProperty(d)&&(a[d]=b[d]);c.prototype=b.prototype,a.prototype=new c},BABYLON;!function(a){var b=function(b){function c(d,e,f){b.call(this,d,f),this.position=e,this.upVector=a.Vector3.Up(),this.orthoLeft=null,this.orthoRight=null,this.orthoBottom=null,this.orthoTop=null,this.fov=.8,this.minZ=.1,this.maxZ=1e3,this.inertia=.9,this.mode=c.PERSPECTIVE_CAMERA,this.isIntermediate=!1,this.viewport=new a.Viewport(0,0,1,1),this.subCameras=[],this.layerMask=4294967295,this._computedViewMatrix=a.Matrix.Identity(),this._projectionMatrix=new a.Matrix,this._postProcesses=new Array,this._postProcessesTakenIndices=[],f.cameras.push(this),f.activeCamera||(f.activeCamera=this)}return __extends(c,b),c.prototype._initCache=function(){b.prototype._initCache.call(this),this._cache.position=new a.Vector3(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE),this._cache.upVector=new a.Vector3(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE),this._cache.mode=void 0,this._cache.minZ=void 0,this._cache.maxZ=void 0,this._cache.fov=void 0,this._cache.aspectRatio=void 0,this._cache.orthoLeft=void 0,this._cache.orthoRight=void 0,this._cache.orthoBottom=void 0,this._cache.orthoTop=void 0,this._cache.renderWidth=void 0,this._cache.renderHeight=void 0},c.prototype._updateCache=function(a){a||b.prototype._updateCache.call(this);var c=this.getEngine();this._cache.position.copyFrom(this.position),this._cache.upVector.copyFrom(this.upVector),this._cache.mode=this.mode,this._cache.minZ=this.minZ,this._cache.maxZ=this.maxZ,this._cache.fov=this.fov,this._cache.aspectRatio=c.getAspectRatio(this),this._cache.orthoLeft=this.orthoLeft,this._cache.orthoRight=this.orthoRight,this._cache.orthoBottom=this.orthoBottom,this._cache.orthoTop=this.orthoTop,this._cache.renderWidth=c.getRenderWidth(),this._cache.renderHeight=c.getRenderHeight()},c.prototype._updateFromScene=function(){this.updateCache(),this._update()},c.prototype._isSynchronized=function(){return this._isSynchronizedViewMatrix()&&this._isSynchronizedProjectionMatrix()},c.prototype._isSynchronizedViewMatrix=function(){return b.prototype._isSynchronized.call(this)?this._cache.position.equals(this.position)&&this._cache.upVector.equals(this.upVector)&&this.isSynchronizedWithParent():!1},c.prototype._isSynchronizedProjectionMatrix=function(){var b=this._cache.mode===this.mode&&this._cache.minZ===this.minZ&&this._cache.maxZ===this.maxZ;if(!b)return!1;var c=this.getEngine();return b=this.mode===a.Camera.PERSPECTIVE_CAMERA?this._cache.fov===this.fov&&this._cache.aspectRatio===c.getAspectRatio(this):this._cache.orthoLeft===this.orthoLeft&&this._cache.orthoRight===this.orthoRight&&this._cache.orthoBottom===this.orthoBottom&&this._cache.orthoTop===this.orthoTop&&this._cache.renderWidth===c.getRenderWidth()&&this._cache.renderHeight===c.getRenderHeight()},c.prototype.attachControl=function(){},c.prototype.detachControl=function(){},c.prototype._update=function(){},c.prototype.attachPostProcess=function(b,c){if("undefined"==typeof c&&(c=null),!b.isReusable()&&this._postProcesses.indexOf(b)>-1)return a.Tools.Error("You're trying to reuse a post process not defined as reusable."),0;if(null==c||0>c)return this._postProcesses.push(b),this._postProcessesTakenIndices.push(this._postProcesses.length-1),this._postProcesses.length-1;var d=0;if(this._postProcesses[c]){for(var e=this._postProcesses.length-1,f=e;f>=c+1;--f)this._postProcesses[f+1]=this._postProcesses[f];d=1}for(f=0;f<this._postProcessesTakenIndices.length;++f)if(!(this._postProcessesTakenIndices[f]<c)){e=this._postProcessesTakenIndices.length-1;for(var g=e;g>=f;--g)this._postProcessesTakenIndices[g+1]=this._postProcessesTakenIndices[g]+d;this._postProcessesTakenIndices[f]=c;break}d||-1!=this._postProcessesTakenIndices.indexOf(c)||this._postProcessesTakenIndices.push(c);var h=c+d;return this._postProcesses[h]=b,h},c.prototype.detachPostProcess=function(a,b){"undefined"==typeof b&&(b=null);var c=[];if(b)for(b=b instanceof Array?b:[b],f=0;f<b.length;f++){var d=this._postProcesses[b[f]];d===a?(delete this._postProcesses[b[f]],g=this._postProcessesTakenIndices.indexOf(b[f]),this._postProcessesTakenIndices.splice(g,1)):c.push(f)}else for(var e=this._postProcesses.length,f=0;e>f;f++)if(this._postProcesses[f]===a){delete this._postProcesses[f];var g=this._postProcessesTakenIndices.indexOf(f);this._postProcessesTakenIndices.splice(g,1)}return c},c.prototype.getWorldMatrix=function(){this._worldMatrix||(this._worldMatrix=a.Matrix.Identity());var b=this.getViewMatrix();return b.invertToRef(this._worldMatrix),this._worldMatrix},c.prototype._getViewMatrix=function(){return a.Matrix.Identity()},c.prototype.getViewMatrix=function(){return this._computedViewMatrix=this._computeViewMatrix(),this.parent&&this.parent.getWorldMatrix&&!this.isSynchronized()?(this._worldMatrix||(this._worldMatrix=a.Matrix.Identity()),this._computedViewMatrix.invertToRef(this._worldMatrix),this._worldMatrix.multiplyToRef(this.parent.getWorldMatrix(),this._computedViewMatrix),this._computedViewMatrix.invert(),this._currentRenderId=this.getScene().getRenderId(),this._computedViewMatrix):this._computedViewMatrix},c.prototype._computeViewMatrix=function(a){return!a&&this._isSynchronizedViewMatrix()?this._computedViewMatrix:(this._computedViewMatrix=this._getViewMatrix(),this.parent&&this.parent.getWorldMatrix||(this._currentRenderId=this.getScene().getRenderId()),this._computedViewMatrix)},c.prototype.getProjectionMatrix=function(b){if(!b&&this._isSynchronizedProjectionMatrix())return this._projectionMatrix;var c=this.getEngine();if(this.mode===a.Camera.PERSPECTIVE_CAMERA)return this.minZ<=0&&(this.minZ=.1),a.Matrix.PerspectiveFovLHToRef(this.fov,c.getAspectRatio(this),this.minZ,this.maxZ,this._projectionMatrix),this._projectionMatrix;var d=c.getRenderWidth()/2,e=c.getRenderHeight()/2;return a.Matrix.OrthoOffCenterLHToRef(this.orthoLeft||-d,this.orthoRight||d,this.orthoBottom||-e,this.orthoTop||e,this.minZ,this.maxZ,this._projectionMatrix),this._projectionMatrix},c.prototype.dispose=function(){var a=this.getScene().cameras.indexOf(this);this.getScene().cameras.splice(a,1);for(var b=0;b<this._postProcessesTakenIndices.length;++b)this._postProcesses[this._postProcessesTakenIndices[b]].dispose(this)},c.PERSPECTIVE_CAMERA=0,c.ORTHOGRAPHIC_CAMERA=1,c}(a.Node);a.Camera=b}(BABYLON||(BABYLON={}));var __extends=this.__extends||function(a,b){function c(){this.constructor=a}for(var d in b)b.hasOwnProperty(d)&&(a[d]=b[d]);c.prototype=b.prototype,a.prototype=new c},BABYLON;!function(a){var b=function(b){function c(c,d,e){b.call(this,c,d,e),this.cameraDirection=new a.Vector3(0,0,0),this.cameraRotation=new a.Vector2(0,0),this.rotation=new a.Vector3(0,0,0),this.ellipsoid=new a.Vector3(.5,1,.5),this.keysUp=[38],this.keysDown=[40],this.keysLeft=[37],this.keysRight=[39],this.speed=2,this.checkCollisions=!1,this.applyGravity=!1,this.noRotationConstraint=!1,this.angularSensibility=2e3,this.lockedTarget=null,this.onCollide=null,this._keys=[],this._collider=new a.Collider,this._needMoveForGravity=!0,this._currentTarget=a.Vector3.Zero(),this._viewMatrix=a.Matrix.Zero(),this._camMatrix=a.Matrix.Zero(),this._cameraTransformMatrix=a.Matrix.Zero(),this._cameraRotationMatrix=a.Matrix.Zero(),this._referencePoint=new a.Vector3(0,0,1),this._transformedReferencePoint=a.Vector3.Zero(),this._oldPosition=a.Vector3.Zero(),this._diffPosition=a.Vector3.Zero(),this._newPosition=a.Vector3.Zero(),this._lookAtTemp=a.Matrix.Zero(),this._tempMatrix=a.Matrix.Zero()}return __extends(c,b),c.prototype._getLockedTargetPosition=function(){return this.lockedTarget?this.lockedTarget.position||this.lockedTarget:null},c.prototype._initCache=function(){b.prototype._initCache.call(this),this._cache.lockedTarget=new a.Vector3(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE),this._cache.rotation=new a.Vector3(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE)},c.prototype._updateCache=function(a){a||b.prototype._updateCache.call(this);var c=this._getLockedTargetPosition();c?this._cache.lockedTarget?this._cache.lockedTarget.copyFrom(c):this._cache.lockedTarget=c.clone():this._cache.lockedTarget=null,this._cache.rotation.copyFrom(this.rotation)},c.prototype._isSynchronizedViewMatrix=function(){if(!b.prototype._isSynchronizedViewMatrix.call(this))return!1;var a=this._getLockedTargetPosition();return(this._cache.lockedTarget?this._cache.lockedTarget.equals(a):!a)&&this._cache.rotation.equals(this.rotation)},c.prototype._computeLocalCameraSpeed=function(){return this.speed*(a.Tools.GetDeltaTime()/(10*a.Tools.GetFps()))},c.prototype.setTarget=function(b){this.upVector.normalize(),a.Matrix.LookAtLHToRef(this.position,b,this.upVector,this._camMatrix),this._camMatrix.invert(),this.rotation.x=Math.atan(this._camMatrix.m[6]/this._camMatrix.m[10]);var c=b.subtract(this.position);this.rotation.y=c.x>=0?-Math.atan(c.z/c.x)+Math.PI/2:-Math.atan(c.z/c.x)-Math.PI/2,this.rotation.z=-Math.acos(a.Vector3.Dot(new a.Vector3(0,1,0),this.upVector)),isNaN(this.rotation.x)&&(this.rotation.x=0),isNaN(this.rotation.y)&&(this.rotation.y=0),isNaN(this.rotation.z)&&(this.rotation.z=0)},c.prototype.getTarget=function(){return this._currentTarget},c.prototype.attachControl=function(b,c){var d,e=this,f=this.getEngine();this._attachedElement||(this._attachedElement=b,void 0===this._onMouseDown&&(this._onMouseDown=function(a){d={x:a.clientX,y:a.clientY},c||a.preventDefault()},this._onMouseUp=function(a){d=null,c||a.preventDefault()},this._onMouseOut=function(a){d=null,e._keys=[],c||a.preventDefault()},this._onMouseMove=function(a){if(d||f.isPointerLock){var b,g;f.isPointerLock?(b=a.movementX||a.mozMovementX||a.webkitMovementX||a.msMovementX||0,g=a.movementY||a.mozMovementY||a.webkitMovementY||a.msMovementY||0):(b=a.clientX-d.x,g=a.clientY-d.y),e.cameraRotation.y+=b/e.angularSensibility,e.cameraRotation.x+=g/e.angularSensibility,d={x:a.clientX,y:a.clientY},c||a.preventDefault()}},this._onKeyDown=function(a){if(-1!==e.keysUp.indexOf(a.keyCode)||-1!==e.keysDown.indexOf(a.keyCode)||-1!==e.keysLeft.indexOf(a.keyCode)||-1!==e.keysRight.indexOf(a.keyCode)){var b=e._keys.indexOf(a.keyCode);-1===b&&e._keys.push(a.keyCode),c||a.preventDefault()}},this._onKeyUp=function(a){if(-1!==e.keysUp.indexOf(a.keyCode)||-1!==e.keysDown.indexOf(a.keyCode)||-1!==e.keysLeft.indexOf(a.keyCode)||-1!==e.keysRight.indexOf(a.keyCode)){var b=e._keys.indexOf(a.keyCode);b>=0&&e._keys.splice(b,1),c||a.preventDefault()}},this._onLostFocus=function(){e._keys=[]},this._reset=function(){e._keys=[],d=null,e.cameraDirection=new a.Vector3(0,0,0),e.cameraRotation=new a.Vector2(0,0)}),b.addEventListener("mousedown",this._onMouseDown,!1),b.addEventListener("mouseup",this._onMouseUp,!1),b.addEventListener("mouseout",this._onMouseOut,!1),b.addEventListener("mousemove",this._onMouseMove,!1),a.Tools.RegisterTopRootEvents([{name:"keydown",handler:this._onKeyDown},{name:"keyup",handler:this._onKeyUp},{name:"blur",handler:this._onLostFocus}]))},c.prototype.detachControl=function(b){this._attachedElement==b&&(b.removeEventListener("mousedown",this._onMouseDown),b.removeEventListener("mouseup",this._onMouseUp),b.removeEventListener("mouseout",this._onMouseOut),b.removeEventListener("mousemove",this._onMouseMove),a.Tools.UnregisterTopRootEvents([{name:"keydown",handler:this._onKeyDown},{name:"keyup",handler:this._onKeyUp},{name:"blur",handler:this._onLostFocus}]),this._attachedElement=null,this._reset&&this._reset())},c.prototype._collideWithWorld=function(b){var c;c=this.parent?a.Vector3.TransformCoordinates(this.position,this.parent.getWorldMatrix()):this.position,c.subtractFromFloatsToRef(0,this.ellipsoid.y,0,this._oldPosition),this._collider.radius=this.ellipsoid,this.getScene()._getNewPosition(this._oldPosition,b,this._collider,3,this._newPosition),this._newPosition.subtractToRef(this._oldPosition,this._diffPosition),this._diffPosition.length()>a.Engine.CollisionsEpsilon&&(this.position.addInPlace(this._diffPosition),this.onCollide&&this.onCollide(this._collider.collidedMesh))},c.prototype._checkInputs=function(){this._localDirection||(this._localDirection=a.Vector3.Zero(),this._transformedDirection=a.Vector3.Zero());for(var b=0;b<this._keys.length;b++){var c=this._keys[b],d=this._computeLocalCameraSpeed();-1!==this.keysLeft.indexOf(c)?this._localDirection.copyFromFloats(-d,0,0):-1!==this.keysUp.indexOf(c)?this._localDirection.copyFromFloats(0,0,d):-1!==this.keysRight.indexOf(c)?this._localDirection.copyFromFloats(d,0,0):-1!==this.keysDown.indexOf(c)&&this._localDirection.copyFromFloats(0,0,-d),this.getViewMatrix().invertToRef(this._cameraTransformMatrix),a.Vector3.TransformNormalToRef(this._localDirection,this._cameraTransformMatrix,this._transformedDirection),this.cameraDirection.addInPlace(this._transformedDirection)}},c.prototype._update=function(){this._checkInputs();var b=this._needMoveForGravity||Math.abs(this.cameraDirection.x)>0||Math.abs(this.cameraDirection.y)>0||Math.abs(this.cameraDirection.z)>0,c=Math.abs(this.cameraRotation.x)>0||Math.abs(this.cameraRotation.y)>0;if(b)if(this.checkCollisions&&this.getScene().collisionsEnabled){if(this._collideWithWorld(this.cameraDirection),this.applyGravity){var d=this.position;this._collideWithWorld(this.getScene().gravity),this._needMoveForGravity=0!=a.Vector3.DistanceSquared(d,this.position)}}else this.position.addInPlace(this.cameraDirection);if(c&&(this.rotation.x+=this.cameraRotation.x,this.rotation.y+=this.cameraRotation.y,!this.noRotationConstraint)){var e=Math.PI/2*.95;this.rotation.x>e&&(this.rotation.x=e),this.rotation.x<-e&&(this.rotation.x=-e)}b&&(Math.abs(this.cameraDirection.x)<a.Engine.Epsilon&&(this.cameraDirection.x=0),Math.abs(this.cameraDirection.y)<a.Engine.Epsilon&&(this.cameraDirection.y=0),Math.abs(this.cameraDirection.z)<a.Engine.Epsilon&&(this.cameraDirection.z=0),this.cameraDirection.scaleInPlace(this.inertia)),c&&(Math.abs(this.cameraRotation.x)<a.Engine.Epsilon&&(this.cameraRotation.x=0),Math.abs(this.cameraRotation.y)<a.Engine.Epsilon&&(this.cameraRotation.y=0),this.cameraRotation.scaleInPlace(this.inertia))},c.prototype._getViewMatrix=function(){return this.lockedTarget?this._currentTarget.copyFrom(this._getLockedTargetPosition()):(0!=this.upVector.x||1!=this.upVector.y||0!=this.upVector.z?(a.Matrix.LookAtLHToRef(a.Vector3.Zero(),this._referencePoint,this.upVector,this._lookAtTemp),a.Matrix.RotationYawPitchRollToRef(this.rotation.y,this.rotation.x,this.rotation.z,this._cameraRotationMatrix),this._lookAtTemp.multiplyToRef(this._cameraRotationMatrix,this._tempMatrix),this._lookAtTemp.invert(),this._tempMatrix.multiplyToRef(this._lookAtTemp,this._cameraRotationMatrix)):a.Matrix.RotationYawPitchRollToRef(this.rotation.y,this.rotation.x,this.rotation.z,this._cameraRotationMatrix),a.Vector3.TransformCoordinatesToRef(this._referencePoint,this._cameraRotationMatrix,this._transformedReferencePoint),this.position.addToRef(this._transformedReferencePoint,this._currentTarget)),a.Matrix.LookAtLHToRef(this.position,this._currentTarget,this.upVector,this._viewMatrix),this._viewMatrix},c}(a.Camera);a.FreeCamera=b}(BABYLON||(BABYLON={}));var __extends=this.__extends||function(a,b){function c(){this.constructor=a}for(var d in b)b.hasOwnProperty(d)&&(a[d]=b[d]);c.prototype=b.prototype,a.prototype=new c},BABYLON;!function(a){var b=function(b){function c(a,c,d){b.call(this,a,c,d),this._offsetX=null,this._offsetY=null,this._pointerCount=0,this._pointerPressed=[],this.angularSensibility=2e5,this.moveSensibility=500}return __extends(c,b),c.prototype.attachControl=function(b,c){var d,e=this;this._attachedCanvas||(this._attachedCanvas=b,void 0===this._onPointerDown&&(this._onPointerDown=function(a){c||a.preventDefault(),e._pointerPressed.push(a.pointerId),1===e._pointerPressed.length&&(d={x:a.clientX,y:a.clientY})},this._onPointerUp=function(a){c||a.preventDefault();var b=e._pointerPressed.indexOf(a.pointerId);-1!==b&&(e._pointerPressed.splice(b,1),0==b&&(d=null,e._offsetX=null,e._offsetY=null))},this._onPointerMove=function(a){if(c||a.preventDefault(),d){var b=e._pointerPressed.indexOf(a.pointerId);0==b&&(e._offsetX=a.clientX-d.x,e._offsetY=-(a.clientY-d.y))}},this._onLostFocus=function(){e._offsetX=null,e._offsetY=null}),b.addEventListener("pointerdown",this._onPointerDown),b.addEventListener("pointerup",this._onPointerUp),b.addEventListener("pointerout",this._onPointerUp),b.addEventListener("pointermove",this._onPointerMove),a.Tools.RegisterTopRootEvents([{name:"blur",handler:this._onLostFocus}]))},c.prototype.detachControl=function(b){this._attachedCanvas==b&&(b.removeEventListener("pointerdown",this._onPointerDown),b.removeEventListener("pointerup",this._onPointerUp),b.removeEventListener("pointerout",this._onPointerUp),b.removeEventListener("pointermove",this._onPointerMove),a.Tools.UnregisterTopRootEvents([{name:"blur",handler:this._onLostFocus}]),this._attachedCanvas=null)},c.prototype._checkInputs=function(){if(this._offsetX)if(this.cameraRotation.y+=this._offsetX/this.angularSensibility,this._pointerPressed.length>1)this.cameraRotation.x+=-this._offsetY/this.angularSensibility;else{var b=this._computeLocalCameraSpeed(),c=new a.Vector3(0,0,b*this._offsetY/this.moveSensibility);a.Matrix.RotationYawPitchRollToRef(this.rotation.y,this.rotation.x,0,this._cameraRotationMatrix),this.cameraDirection.addInPlace(a.Vector3.TransformCoordinates(c,this._cameraRotationMatrix))}},c}(a.FreeCamera);a.TouchCamera=b}(BABYLON||(BABYLON={}));var __extends=this.__extends||function(a,b){function c(){this.constructor=a}for(var d in b)b.hasOwnProperty(d)&&(a[d]=b[d]);c.prototype=b.prototype,a.prototype=new c},BABYLON;!function(a){var b=a.Tools.GetPointerPrefix(),c=function(c){function d(b,d,e,f,g,h){c.call(this,b,a.Vector3.Zero(),h),this.alpha=d,this.beta=e,this.radius=f,this.target=g,this.inertialAlphaOffset=0,this.inertialBetaOffset=0,this.inertialRadiusOffset=0,this.lowerAlphaLimit=null,this.upperAlphaLimit=null,this.lowerBetaLimit=.01,this.upperBetaLimit=Math.PI,this.lowerRadiusLimit=null,this.upperRadiusLimit=null,this.angularSensibility=1e3,this.wheelPrecision=3,this.keysUp=[38],this.keysDown=[40],this.keysLeft=[37],this.keysRight=[39],this.zoomOnFactor=1,this._keys=[],this._viewMatrix=new a.Matrix,this.getViewMatrix()}return __extends(d,c),d.prototype._getTargetPosition=function(){return this.target.position||this.target},d.prototype._initCache=function(){c.prototype._initCache.call(this),this._cache.target=new a.Vector3(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE),this._cache.alpha=void 0,this._cache.beta=void 0,this._cache.radius=void 0},d.prototype._updateCache=function(a){a||c.prototype._updateCache.call(this),this._cache.target.copyFrom(this._getTargetPosition()),this._cache.alpha=this.alpha,this._cache.beta=this.beta,this._cache.radius=this.radius},d.prototype._isSynchronizedViewMatrix=function(){return c.prototype._isSynchronizedViewMatrix.call(this)?this._cache.target.equals(this._getTargetPosition())&&this._cache.alpha===this.alpha&&this._cache.beta===this.beta&&this._cache.radius===this.radius:!1},d.prototype.attachControl=function(c,d){var e,f,g=this;if(!this._attachedElement){this._attachedElement=c;var h=this.getEngine();void 0===this._onPointerDown&&(this._onPointerDown=function(a){f||(f=a.pointerId,e={x:a.clientX,y:a.clientY},d||a.preventDefault())},this._onPointerUp=function(a){e=null,f=null,d||a.preventDefault()},this._onPointerMove=function(a){if(e&&f===a.pointerId){var b=a.clientX-e.x,c=a.clientY-e.y;g.inertialAlphaOffset-=b/g.angularSensibility,g.inertialBetaOffset-=c/g.angularSensibility,e={x:a.clientX,y:a.clientY},d||a.preventDefault()}},this._onMouseMove=function(a){if(h.isPointerLock){var b=a.movementX||a.mozMovementX||a.webkitMovementX||a.msMovementX||0,c=a.movementY||a.mozMovementY||a.webkitMovementY||a.msMovementY||0;g.inertialAlphaOffset-=b/g.angularSensibility,g.inertialBetaOffset-=c/g.angularSensibility,d||a.preventDefault()}},this._wheel=function(a){var b=0;a.wheelDelta?b=a.wheelDelta/(40*g.wheelPrecision):a.detail&&(b=-a.detail/g.wheelPrecision),b&&(g.inertialRadiusOffset+=b),a.preventDefault&&(d||a.preventDefault())},this._onKeyDown=function(a){if(-1!==g.keysUp.indexOf(a.keyCode)||-1!==g.keysDown.indexOf(a.keyCode)||-1!==g.keysLeft.indexOf(a.keyCode)||-1!==g.keysRight.indexOf(a.keyCode)){var b=g._keys.indexOf(a.keyCode);-1===b&&g._keys.push(a.keyCode),a.preventDefault&&(d||a.preventDefault())}},this._onKeyUp=function(a){if(-1!==g.keysUp.indexOf(a.keyCode)||-1!==g.keysDown.indexOf(a.keyCode)||-1!==g.keysLeft.indexOf(a.keyCode)||-1!==g.keysRight.indexOf(a.keyCode)){var b=g._keys.indexOf(a.keyCode);b>=0&&g._keys.splice(b,1),a.preventDefault&&(d||a.preventDefault())}},this._onLostFocus=function(){g._keys=[],f=null},this._onGestureStart=function(a){void 0!==window.MSGesture&&(g._MSGestureHandler||(g._MSGestureHandler=new MSGesture,g._MSGestureHandler.target=c),g._MSGestureHandler.addPointer(a.pointerId))},this._onGesture=function(a){g.radius*=a.scale,a.preventDefault&&(d||(a.stopPropagation(),a.preventDefault()))},this._reset=function(){g._keys=[],g.inertialAlphaOffset=0,g.inertialBetaOffset=0,g.inertialRadiusOffset=0,e=null,f=null}),c.addEventListener(b+"down",this._onPointerDown,!1),c.addEventListener(b+"up",this._onPointerUp,!1),c.addEventListener(b+"out",this._onPointerUp,!1),c.addEventListener(b+"move",this._onPointerMove,!1),c.addEventListener("mousemove",this._onMouseMove,!1),c.addEventListener("MSPointerDown",this._onGestureStart,!1),c.addEventListener("MSGestureChange",this._onGesture,!1),c.addEventListener("mousewheel",this._wheel,!1),c.addEventListener("DOMMouseScroll",this._wheel,!1),a.Tools.RegisterTopRootEvents([{name:"keydown",handler:this._onKeyDown},{name:"keyup",handler:this._onKeyUp},{name:"blur",handler:this._onLostFocus}])}},d.prototype.detachControl=function(c){this._attachedElement==c&&(c.removeEventListener(b+"down",this._onPointerDown),c.removeEventListener(b+"up",this._onPointerUp),c.removeEventListener(b+"out",this._onPointerUp),c.removeEventListener(b+"move",this._onPointerMove),c.removeEventListener("mousemove",this._onMouseMove),c.removeEventListener("MSPointerDown",this._onGestureStart),c.removeEventListener("MSGestureChange",this._onGesture),c.removeEventListener("mousewheel",this._wheel),c.removeEventListener("DOMMouseScroll",this._wheel),a.Tools.UnregisterTopRootEvents([{name:"keydown",handler:this._onKeyDown},{name:"keyup",handler:this._onKeyUp},{name:"blur",handler:this._onLostFocus}]),this._MSGestureHandler=null,this._attachedElement=null,this._reset&&this._reset())},d.prototype._update=function(){for(var b=0;b<this._keys.length;b++){var c=this._keys[b];-1!==this.keysLeft.indexOf(c)?this.inertialAlphaOffset-=.01:-1!==this.keysUp.indexOf(c)?this.inertialBetaOffset-=.01:-1!==this.keysRight.indexOf(c)?this.inertialAlphaOffset+=.01:-1!==this.keysDown.indexOf(c)&&(this.inertialBetaOffset+=.01)}(0!=this.inertialAlphaOffset||0!=this.inertialBetaOffset||0!=this.inertialRadiusOffset)&&(this.alpha+=this.inertialAlphaOffset,this.beta+=this.inertialBetaOffset,this.radius-=this.inertialRadiusOffset,this.inertialAlphaOffset*=this.inertia,this.inertialBetaOffset*=this.inertia,this.inertialRadiusOffset*=this.inertia,Math.abs(this.inertialAlphaOffset)<a.Engine.Epsilon&&(this.inertialAlphaOffset=0),Math.abs(this.inertialBetaOffset)<a.Engine.Epsilon&&(this.inertialBetaOffset=0),Math.abs(this.inertialRadiusOffset)<a.Engine.Epsilon&&(this.inertialRadiusOffset=0)),this.lowerAlphaLimit&&this.alpha<this.lowerAlphaLimit&&(this.alpha=this.lowerAlphaLimit),this.upperAlphaLimit&&this.alpha>this.upperAlphaLimit&&(this.alpha=this.upperAlphaLimit),this.lowerBetaLimit&&this.beta<this.lowerBetaLimit&&(this.beta=this.lowerBetaLimit),this.upperBetaLimit&&this.beta>this.upperBetaLimit&&(this.beta=this.upperBetaLimit),this.lowerRadiusLimit&&this.radius<this.lowerRadiusLimit&&(this.radius=this.lowerRadiusLimit),this.upperRadiusLimit&&this.radius>this.upperRadiusLimit&&(this.radius=this.upperRadiusLimit)},d.prototype.setPosition=function(a){var b=a.subtract(this._getTargetPosition());this.radius=b.length(),this.alpha=Math.acos(b.x/Math.sqrt(Math.pow(b.x,2)+Math.pow(b.z,2))),b.z<0&&(this.alpha=2*Math.PI-this.alpha),this.beta=Math.acos(b.y/this.radius)},d.prototype._getViewMatrix=function(){var b=Math.cos(this.alpha),c=Math.sin(this.alpha),d=Math.cos(this.beta),e=Math.sin(this.beta),f=this._getTargetPosition();
return f.addToRef(new a.Vector3(this.radius*b*e,this.radius*d,this.radius*c*e),this.position),a.Matrix.LookAtLHToRef(this.position,f,this.upVector,this._viewMatrix),this._viewMatrix},d.prototype.zoomOn=function(b){b=b||this.getScene().meshes;var c=a.Mesh.MinMax(b),d=a.Vector3.Distance(c.min,c.max);this.radius=d*this.zoomOnFactor,this.focusOn({min:c.min,max:c.max,distance:d})},d.prototype.focusOn=function(b){var c,d;void 0===b.min?(c=b||this.getScene().meshes,c=a.Mesh.MinMax(c),d=a.Vector3.Distance(c.min,c.max)):(c=b,d=b.distance),this.target=a.Mesh.Center(c),this.maxZ=2*d},d}(a.Camera);a.ArcRotateCamera=c}(BABYLON||(BABYLON={}));var __extends=this.__extends||function(a,b){function c(){this.constructor=a}for(var d in b)b.hasOwnProperty(d)&&(a[d]=b[d]);c.prototype=b.prototype,a.prototype=new c},BABYLON;!function(a){var b=function(b){function c(a,c,d){var e=this;b.call(this,a,c,d),this._offsetX=null,this._offsetY=null,this._orientationGamma=0,this._orientationBeta=0,this._initialOrientationGamma=0,this._initialOrientationBeta=0,this.angularSensibility=1e4,this.moveSensibility=50,window.addEventListener("resize",function(){e._initialOrientationGamma=null},!1)}return __extends(c,b),c.prototype.attachControl=function(a){var b=this;this._attachedCanvas||(this._attachedCanvas=a,this._orientationChanged||(this._orientationChanged=function(a){b._initialOrientationGamma||(b._initialOrientationGamma=a.gamma,b._initialOrientationBeta=a.beta),b._orientationGamma=a.gamma,b._orientationBeta=a.beta,b._offsetY=b._initialOrientationBeta-b._orientationBeta,b._offsetX=b._initialOrientationGamma-b._orientationGamma}),window.addEventListener("deviceorientation",this._orientationChanged))},c.prototype.detachControl=function(a){this._attachedCanvas==a&&(window.removeEventListener("deviceorientation",this._orientationChanged),this._attachedCanvas=null,this._orientationGamma=0,this._orientationBeta=0,this._initialOrientationGamma=0,this._initialOrientationBeta=0)},c.prototype._checkInputs=function(){if(this._offsetX){this.cameraRotation.y-=this._offsetX/this.angularSensibility;var b=this._computeLocalCameraSpeed(),c=new a.Vector3(0,0,b*this._offsetY/this.moveSensibility);a.Matrix.RotationYawPitchRollToRef(this.rotation.y,this.rotation.x,0,this._cameraRotationMatrix),this.cameraDirection.addInPlace(a.Vector3.TransformCoordinates(c,this._cameraRotationMatrix))}},c}(a.FreeCamera);a.DeviceOrientationCamera=b}(BABYLON||(BABYLON={}));var BABYLON;!function(a){var b=function(){function b(a){this._renderingGroups=new Array,this._scene=a}return b.prototype._renderParticles=function(a,b){if(0!==this._scene._activeParticleSystems.length){for(var c=(new Date).getTime(),d=0;d<this._scene._activeParticleSystems.length;d++){var e=this._scene._activeParticleSystems.data[d];e.renderingGroupId===a&&(this._clearDepthBuffer(),e.emitter.position&&b&&-1===b.indexOf(e.emitter)||(this._scene._activeParticles+=e.render()))}this._scene._particlesDuration+=(new Date).getTime()-c}},b.prototype._renderSprites=function(a){if(0!==this._scene.spriteManagers.length){for(var b=(new Date).getTime(),c=0;c<this._scene.spriteManagers.length;c++){var d=this._scene.spriteManagers[c];d.renderingGroupId===a&&(this._clearDepthBuffer(),d.render())}this._scene._spritesDuration+=(new Date).getTime()-b}},b.prototype._clearDepthBuffer=function(){this._depthBufferAlreadyCleaned||(this._scene.getEngine().clear(0,!1,!0),this._depthBufferAlreadyCleaned=!0)},b.prototype.render=function(b,c,d,e){for(var f=this,g=0;g<a.RenderingManager.MAX_RENDERINGGROUPS;g++){this._depthBufferAlreadyCleaned=!1;var h=this._renderingGroups[g];h?(this._clearDepthBuffer(),h.render(b,function(){e&&f._renderSprites(g)})||this._renderingGroups.splice(g,1)):e&&this._renderSprites(g),d&&this._renderParticles(g,c)}},b.prototype.reset=function(){for(var a in this._renderingGroups){var b=this._renderingGroups[a];b.prepare()}},b.prototype.dispatch=function(b){var c=b.getMesh(),d=c.renderingGroupId||0;this._renderingGroups[d]||(this._renderingGroups[d]=new a.RenderingGroup(d,this._scene)),this._renderingGroups[d].dispatch(b)},b.MAX_RENDERINGGROUPS=4,b}();a.RenderingManager=b}(BABYLON||(BABYLON={}));var BABYLON;!function(a){var b=function(){function b(b,c){this.index=b,this._opaqueSubMeshes=new a.SmartArray(256),this._transparentSubMeshes=new a.SmartArray(256),this._alphaTestSubMeshes=new a.SmartArray(256),this._scene=c}return b.prototype.render=function(b,c){if(b)return b(this._opaqueSubMeshes,this._alphaTestSubMeshes,this._transparentSubMeshes,c),!0;if(0===this._opaqueSubMeshes.length&&0===this._alphaTestSubMeshes.length&&0===this._transparentSubMeshes.length)return!1;var d,e,f=this._scene.getEngine();for(this._opaqueSubMeshes.sort(function(a,b){return(a.category||0)-(b.category||0)}),d=0;d<this._opaqueSubMeshes.length;d++)e=this._opaqueSubMeshes.data[d],this._activeVertices+=e.verticesCount,e.render();for(f.setAlphaTesting(!0),d=0;d<this._alphaTestSubMeshes.length;d++)e=this._alphaTestSubMeshes.data[d],this._activeVertices+=e.verticesCount,e.render();if(f.setAlphaTesting(!1),c&&c(),this._transparentSubMeshes.length){for(d=0;d<this._transparentSubMeshes.length;d++)e=this._transparentSubMeshes.data[d],e._distanceToCamera=e.getBoundingInfo().boundingSphere.centerWorld.subtract(this._scene.activeCamera.position).length();var g=this._transparentSubMeshes.data.slice(0,this._transparentSubMeshes.length);for(g.sort(function(a,b){return a._distanceToCamera<b._distanceToCamera?1:a._distanceToCamera>b._distanceToCamera?-1:0}),f.setAlphaMode(a.Engine.ALPHA_COMBINE),d=0;d<g.length;d++)e=g[d],this._activeVertices+=e.verticesCount,e.render();f.setAlphaMode(a.Engine.ALPHA_DISABLE)}return!0},b.prototype.prepare=function(){this._opaqueSubMeshes.reset(),this._transparentSubMeshes.reset(),this._alphaTestSubMeshes.reset()},b.prototype.dispatch=function(a){var b=a.getMaterial(),c=a.getMesh();b.needAlphaBlending()||c.visibility<1?(b.alpha>0||c.visibility<1)&&this._transparentSubMeshes.push(a):b.needAlphaTesting()?this._alphaTestSubMeshes.push(a):this._opaqueSubMeshes.push(a)},b}();a.RenderingGroup=b}(BABYLON||(BABYLON={}));var BABYLON;!function(a){var b=function(){function b(b){this.autoClear=!0,this.clearColor=new a.Color3(.2,.2,.3),this.ambientColor=new a.Color3(0,0,0),this.forceWireframe=!1,this.cameraToUseForPointers=null,this.fogMode=a.Scene.FOGMODE_NONE,this.fogColor=new a.Color3(.2,.2,.3),this.fogDensity=.1,this.fogStart=0,this.fogEnd=1e3,this.lightsEnabled=!0,this.lights=new Array,this.cameras=new Array,this.activeCameras=new Array,this.meshes=new Array,this._geometries=new Array,this.materials=new Array,this.multiMaterials=new Array,this.defaultMaterial=new a.StandardMaterial("default material",this),this.texturesEnabled=!0,this.textures=new Array,this.particlesEnabled=!0,this.particleSystems=new Array,this.spriteManagers=new Array,this.layers=new Array,this.skeletons=new Array,this.lensFlareSystems=new Array,this.collisionsEnabled=!0,this.gravity=new a.Vector3(0,-9,0),this.postProcessesEnabled=!0,this.renderTargetsEnabled=!0,this.customRenderTargets=new Array,this.importedMeshesFiles=new Array,this._actionManagers=new Array,this._meshesForIntersections=new a.SmartArray(256),this._totalVertices=0,this._activeVertices=0,this._activeParticles=0,this._lastFrameDuration=0,this._evaluateActiveMeshesDuration=0,this._renderTargetsDuration=0,this._particlesDuration=0,this._renderDuration=0,this._spritesDuration=0,this._animationRatio=0,this._renderId=0,this._executeWhenReadyTimeoutId=-1,this._toBeDisposed=new a.SmartArray(256),this._onReadyCallbacks=new Array,this._pendingData=[],this._onBeforeRenderCallbacks=new Array,this._activeMeshes=new a.SmartArray(256),this._processedMaterials=new a.SmartArray(256),this._renderTargets=new a.SmartArray(256),this._activeParticleSystems=new a.SmartArray(256),this._activeSkeletons=new a.SmartArray(32),this._activeAnimatables=new Array,this._transformMatrix=a.Matrix.Zero(),this._scaledPosition=a.Vector3.Zero(),this._scaledVelocity=a.Vector3.Zero(),this._engine=b,b.scenes.push(this),this._renderingManager=new a.RenderingManager(this),this.postProcessManager=new a.PostProcessManager(this),this.postProcessRenderPipelineManager=new a.PostProcessRenderPipelineManager,this._boundingBoxRenderer=new a.BoundingBoxRenderer(this)}return Object.defineProperty(b.prototype,"meshUnderPointer",{get:function(){return this._meshUnderPointer},enumerable:!0,configurable:!0}),Object.defineProperty(b.prototype,"pointerX",{get:function(){return this._pointerX},enumerable:!0,configurable:!0}),Object.defineProperty(b.prototype,"pointerY",{get:function(){return this._pointerY},enumerable:!0,configurable:!0}),b.prototype.getBoundingBoxRenderer=function(){return this._boundingBoxRenderer},b.prototype.getEngine=function(){return this._engine},b.prototype.getTotalVertices=function(){return this._totalVertices},b.prototype.getActiveVertices=function(){return this._activeVertices},b.prototype.getActiveParticles=function(){return this._activeParticles},b.prototype.getLastFrameDuration=function(){return this._lastFrameDuration},b.prototype.getEvaluateActiveMeshesDuration=function(){return this._evaluateActiveMeshesDuration},b.prototype.getActiveMeshes=function(){return this._activeMeshes},b.prototype.getRenderTargetsDuration=function(){return this._renderTargetsDuration},b.prototype.getRenderDuration=function(){return this._renderDuration},b.prototype.getParticlesDuration=function(){return this._particlesDuration},b.prototype.getSpritesDuration=function(){return this._spritesDuration},b.prototype.getAnimationRatio=function(){return this._animationRatio},b.prototype.getRenderId=function(){return this._renderId},b.prototype._updatePointerPosition=function(a){var b=this._engine.getRenderingCanvasClientRect();this._pointerX=a.clientX-b.left,this._pointerY=a.clientY-b.top,this.cameraToUseForPointers&&(this._pointerX=this._pointerX-this.cameraToUseForPointers.viewport.x*this._engine.getRenderWidth(),this._pointerY=this._pointerY-this.cameraToUseForPointers.viewport.y*this._engine.getRenderHeight())},b.prototype.attachControl=function(){var b=this;this._onPointerMove=function(a){var c=b._engine.getRenderingCanvas();b._updatePointerPosition(a);var d=b.pick(b._pointerX,b._pointerY,function(a){return a.isPickable&&a.isVisible&&a.isReady()&&a.actionManager&&a.actionManager.hasPointerTriggers},!1,b.cameraToUseForPointers);d.hit?(b.setPointerOverMesh(d.pickedMesh),c.style.cursor="pointer",b._meshUnderPointer=d.pickedMesh):(b.setPointerOverMesh(null),c.style.cursor="",b._meshUnderPointer=null)},this._onPointerDown=function(c){var d=null;b.onPointerDown||(d=function(a){return a.isPickable&&a.isVisible&&a.isReady()&&a.actionManager&&a.actionManager.hasPickTriggers}),b._updatePointerPosition(c);var e=b.pick(b._pointerX,b._pointerY,d,!1,b.cameraToUseForPointers);if(e.hit&&e.pickedMesh.actionManager){switch(c.button){case 0:e.pickedMesh.actionManager.processTrigger(a.ActionManager.OnLeftPickTrigger,a.ActionEvent.CreateNew(e.pickedMesh));break;case 1:e.pickedMesh.actionManager.processTrigger(a.ActionManager.OnCenterPickTrigger,a.ActionEvent.CreateNew(e.pickedMesh));break;case 2:e.pickedMesh.actionManager.processTrigger(a.ActionManager.OnRightPickTrigger,a.ActionEvent.CreateNew(e.pickedMesh))}e.pickedMesh.actionManager.processTrigger(a.ActionManager.OnPickTrigger,a.ActionEvent.CreateNew(e.pickedMesh))}b.onPointerDown&&b.onPointerDown(c,e)};var c=a.Tools.GetPointerPrefix();this._engine.getRenderingCanvas().addEventListener(c+"move",this._onPointerMove,!1),this._engine.getRenderingCanvas().addEventListener(c+"down",this._onPointerDown,!1)},b.prototype.detachControl=function(){var b=a.Tools.GetPointerPrefix();this._engine.getRenderingCanvas().removeEventListener(b+"move",this._onPointerMove),this._engine.getRenderingCanvas().removeEventListener(b+"down",this._onPointerDown)},b.prototype.isReady=function(){if(this._pendingData.length>0)return!1;for(var b=0;b<this._geometries.length;b++){var c=this._geometries[b];if(c.delayLoadState===a.Engine.DELAYLOADSTATE_LOADING)return!1}for(b=0;b<this.meshes.length;b++){var d=this.meshes[b];if(!d.isReady())return!1;var e=d.material;if(e&&!e.isReady(d))return!1}return!0},b.prototype.registerBeforeRender=function(a){this._onBeforeRenderCallbacks.push(a)},b.prototype.unregisterBeforeRender=function(a){var b=this._onBeforeRenderCallbacks.indexOf(a);b>-1&&this._onBeforeRenderCallbacks.splice(b,1)},b.prototype._addPendingData=function(a){this._pendingData.push(a)},b.prototype._removePendingData=function(a){var b=this._pendingData.indexOf(a);-1!==b&&this._pendingData.splice(b,1)},b.prototype.getWaitingItemsCount=function(){return this._pendingData.length},b.prototype.executeWhenReady=function(a){var b=this;this._onReadyCallbacks.push(a),-1===this._executeWhenReadyTimeoutId&&(this._executeWhenReadyTimeoutId=setTimeout(function(){b._checkIsReady()},150))},b.prototype._checkIsReady=function(){var a=this;return this.isReady()?(this._onReadyCallbacks.forEach(function(a){a()}),this._onReadyCallbacks=[],void(this._executeWhenReadyTimeoutId=-1)):void(this._executeWhenReadyTimeoutId=setTimeout(function(){a._checkIsReady()},150))},b.prototype.beginAnimation=function(b,c,d,e,f,g,h){if(void 0===f&&(f=1),this.stopAnimation(b),h||(h=new a.Animatable(this,b,c,d,e,f,g)),b.animations&&h.appendAnimations(b,b.animations),b.getAnimatables)for(var i=b.getAnimatables(),j=0;j<i.length;j++)this.beginAnimation(i[j],c,d,e,f,g,h);return h},b.prototype.beginDirectAnimation=function(b,c,d,e,f,g,h){void 0===g&&(g=1);var i=new a.Animatable(this,b,d,e,f,g,h,c);return i},b.prototype.getAnimatableByTarget=function(a){for(var b=0;b<this._activeAnimatables.length;b++)if(this._activeAnimatables[b].target===a)return this._activeAnimatables[b];return null},b.prototype.stopAnimation=function(a){var b=this.getAnimatableByTarget(a);b&&b.stop()},b.prototype._animate=function(){this._animationStartDate||(this._animationStartDate=(new Date).getTime());for(var a=(new Date).getTime(),b=a-this._animationStartDate,c=0;c<this._activeAnimatables.length;c++)this._activeAnimatables[c]._animate(b)||(this._activeAnimatables.splice(c,1),c--)},b.prototype.getViewMatrix=function(){return this._viewMatrix},b.prototype.getProjectionMatrix=function(){return this._projectionMatrix},b.prototype.getTransformMatrix=function(){return this._transformMatrix},b.prototype.setTransformMatrix=function(a,b){this._viewMatrix=a,this._projectionMatrix=b,this._viewMatrix.multiplyToRef(this._projectionMatrix,this._transformMatrix)},b.prototype.setActiveCameraByID=function(a){var b=this.getCameraByID(a);return b?(this.activeCamera=b,b):null},b.prototype.setActiveCameraByName=function(a){var b=this.getCameraByName(a);return b?(this.activeCamera=b,b):null},b.prototype.getMaterialByID=function(a){for(var b=0;b<this.materials.length;b++)if(this.materials[b].id===a)return this.materials[b];return null},b.prototype.getMaterialByName=function(a){for(var b=0;b<this.materials.length;b++)if(this.materials[b].name===a)return this.materials[b];return null},b.prototype.getCameraByID=function(a){for(var b=0;b<this.cameras.length;b++)if(this.cameras[b].id===a)return this.cameras[b];return null},b.prototype.getCameraByName=function(a){for(var b=0;b<this.cameras.length;b++)if(this.cameras[b].name===a)return this.cameras[b];return null},b.prototype.getLightByName=function(a){for(var b=0;b<this.lights.length;b++)if(this.lights[b].name===a)return this.lights[b];return null},b.prototype.getLightByID=function(a){for(var b=0;b<this.lights.length;b++)if(this.lights[b].id===a)return this.lights[b];return null},b.prototype.getGeometryByID=function(a){for(var b=0;b<this._geometries.length;b++)if(this._geometries[b].id===a)return this._geometries[b];return null},b.prototype.pushGeometry=function(a,b){return!b&&this.getGeometryByID(a.id)?!1:(this._geometries.push(a),!0)},b.prototype.getGeometries=function(){return this._geometries},b.prototype.getMeshByID=function(a){for(var b=0;b<this.meshes.length;b++)if(this.meshes[b].id===a)return this.meshes[b];return null},b.prototype.getLastMeshByID=function(a){for(var b=this.meshes.length-1;b>=0;b--)if(this.meshes[b].id===a)return this.meshes[b];return null},b.prototype.getLastEntryByID=function(a){for(var b=this.meshes.length-1;b>=0;b--)if(this.meshes[b].id===a)return this.meshes[b];for(b=this.cameras.length-1;b>=0;b--)if(this.cameras[b].id===a)return this.cameras[b];for(b=this.lights.length-1;b>=0;b--)if(this.lights[b].id===a)return this.lights[b];return null},b.prototype.getMeshByName=function(a){for(var b=0;b<this.meshes.length;b++)if(this.meshes[b].name===a)return this.meshes[b];return null},b.prototype.getLastSkeletonByID=function(a){for(var b=this.skeletons.length-1;b>=0;b--)if(this.skeletons[b].id===a)return this.skeletons[b];return null},b.prototype.getSkeletonById=function(a){for(var b=0;b<this.skeletons.length;b++)if(this.skeletons[b].id===a)return this.skeletons[b];return null},b.prototype.getSkeletonByName=function(a){for(var b=0;b<this.skeletons.length;b++)if(this.skeletons[b].name===a)return this.skeletons[b];return null},b.prototype.isActiveMesh=function(a){return-1!==this._activeMeshes.indexOf(a)},b.prototype._evaluateSubMesh=function(a,b){if(1==b.subMeshes.length||a.isInFrustum(this._frustumPlanes)){var c=a.getMaterial();b.showSubMeshesBoundingBox&&this._boundingBoxRenderer.renderList.push(a.getBoundingInfo().boundingBox),c&&(c.getRenderTargetTextures&&-1===this._processedMaterials.indexOf(c)&&(this._processedMaterials.push(c),this._renderTargets.concat(c.getRenderTargetTextures())),this._activeVertices+=a.verticesCount,this._renderingManager.dispatch(a))}},b.prototype._evaluateActiveMeshes=function(){this._activeMeshes.reset(),this._renderingManager.reset(),this._processedMaterials.reset(),this._activeParticleSystems.reset(),this._activeSkeletons.reset(),this._boundingBoxRenderer.reset(),this._frustumPlanes?a.Frustum.GetPlanesToRef(this._transformMatrix,this._frustumPlanes):this._frustumPlanes=a.Frustum.GetPlanes(this._transformMatrix);var b,c;if(this._selectionOctree){var d=this._selectionOctree.select(this._frustumPlanes);b=d.data,c=d.length}else c=this.meshes.length,b=this.meshes;for(var e=0;c>e;e++){var f=b[e];this._totalVertices+=f.getTotalVertices(),f.isReady()&&(f.computeWorldMatrix(),f._preActivate(),f.actionManager&&f.actionManager.hasSpecificTriggers([a.ActionManager.OnIntersectionEnterTrigger,a.ActionManager.OnIntersectionExitTrigger])&&this._meshesForIntersections.pushNoDuplicate(f),f.isEnabled()&&f.isVisible&&f.visibility>0&&0!=(f.layerMask&this.activeCamera.layerMask)&&f.isInFrustum(this._frustumPlanes)&&(this._activeMeshes.push(f),f._activate(this._renderId),this._activeMesh(f)))}var g=(new Date).getTime();if(this.particlesEnabled)for(var h=0;h<this.particleSystems.length;h++){var i=this.particleSystems[h];i.isStarted()&&(!i.emitter.position||i.emitter&&i.emitter.isEnabled())&&(this._activeParticleSystems.push(i),i.animate())}this._particlesDuration+=(new Date).getTime()-g},b.prototype._activeMesh=function(a){if(a.skeleton&&this._activeSkeletons.pushNoDuplicate(a.skeleton),a.showBoundingBox&&this._boundingBoxRenderer.renderList.push(a.getBoundingInfo().boundingBox),a.subMeshes){var b,c;if(a._submeshesOctree&&a.useOctreeForRenderingSelection){var d=a._submeshesOctree.select(this._frustumPlanes);b=d.length,c=d.data}else c=a.subMeshes,b=c.length;for(var e=0;b>e;e++){var f=c[e];this._evaluateSubMesh(f,a)}}},b.prototype.updateTransformMatrix=function(a){this.setTransformMatrix(this.activeCamera.getViewMatrix(),this.activeCamera.getProjectionMatrix(a))},b.prototype._renderForCamera=function(a){var b=this._engine;if(this.activeCamera=a,!this.activeCamera)throw new Error("Active camera not set");b.setViewport(this.activeCamera.viewport),this._renderId++,this.updateTransformMatrix(),this.beforeCameraRender&&this.beforeCameraRender(this.activeCamera);var c=(new Date).getTime();this._evaluateActiveMeshes(),this._evaluateActiveMeshesDuration+=(new Date).getTime()-c;for(var d=0;d<this._activeSkeletons.length;d++){var e=this._activeSkeletons.data[d];e.prepare()}for(var f=0;f<this.customRenderTargets.length;f++){var g=this.customRenderTargets[f];this._renderTargets.push(g)}var h=(new Date).getTime();if(this.renderTargetsEnabled){for(var i=0;i<this._renderTargets.length;i++)g=this._renderTargets.data[i],g._shouldRender()&&(this._renderId++,g.render());this._renderId++}this._renderTargets.length>0&&b.restoreDefaultFramebuffer(),this._renderTargetsDuration=(new Date).getTime()-h,this.postProcessManager._prepareFrame();var j=(new Date).getTime();if(this.layers.length){b.setDepthBuffer(!1);var k,l;for(k=0;k<this.layers.length;k++)l=this.layers[k],l.isBackground&&l.render();b.setDepthBuffer(!0)}this._renderingManager.render(null,null,!0,!0),this._boundingBoxRenderer.render();for(var m=0;m<this.lensFlareSystems.length;m++)this.lensFlareSystems[m].render();if(this.layers.length){for(b.setDepthBuffer(!1),k=0;k<this.layers.length;k++)l=this.layers[k],l.isBackground||l.render();b.setDepthBuffer(!0)}this._renderDuration+=(new Date).getTime()-j,this.postProcessManager._finalizeFrame(a.isIntermediate),this.activeCamera._updateFromScene(),this._renderTargets.reset(),this.afterCameraRender&&this.afterCameraRender(this.activeCamera)},b.prototype._processSubCameras=function(a){if(0==a.subCameras.length)return void this._renderForCamera(a);for(var b=0;b<a.subCameras.length;b++)this._renderForCamera(a.subCameras[b]);this.activeCamera=a,this.setTransformMatrix(this.activeCamera.getViewMatrix(),this.activeCamera.getProjectionMatrix()),this.activeCamera._updateFromScene()},b.prototype._checkIntersections=function(){for(var b=0;b<this._meshesForIntersections.length;b++)for(var c=this._meshesForIntersections.data[b],d=0;d<c.actionManager.actions.length;d++){var e=c.actionManager.actions[d];if(e.trigger==a.ActionManager.OnIntersectionEnterTrigger||e.trigger==a.ActionManager.OnIntersectionExitTrigger){var f=e.getTriggerParameter(),g=f.intersectsMesh(c,!1),h=c._intersectionsInProgress.indexOf(f);if(g&&-1===h&&e.trigger==a.ActionManager.OnIntersectionEnterTrigger)c.actionManager.processTrigger(a.ActionManager.OnIntersectionEnterTrigger,a.ActionEvent.CreateNew(c)),c._intersectionsInProgress.push(f);else if(!g&&h>-1&&e.trigger==a.ActionManager.OnIntersectionExitTrigger){c.actionManager.processTrigger(a.ActionManager.OnIntersectionExitTrigger,a.ActionEvent.CreateNew(c));var i=c._intersectionsInProgress.indexOf(f);i>-1&&c._intersectionsInProgress.splice(i,1)}}}},b.prototype.render=function(){var c=(new Date).getTime();this._particlesDuration=0,this._spritesDuration=0,this._activeParticles=0,this._renderDuration=0,this._evaluateActiveMeshesDuration=0,this._totalVertices=0,this._activeVertices=0,this._meshesForIntersections.reset(),this.actionManager&&this.actionManager.processTrigger(a.ActionManager.OnEveryFrameTrigger,null),this.beforeRender&&this.beforeRender();for(var d=0;d<this._onBeforeRenderCallbacks.length;d++)this._onBeforeRenderCallbacks[d]();var e=Math.max(b.MinDeltaTime,Math.min(a.Tools.GetDeltaTime(),b.MaxDeltaTime));this._animationRatio=.06*e,this._animate(),this._physicsEngine&&this._physicsEngine._runOneStep(e/1e3),this._engine.clear(this.clearColor,this.autoClear||this.forceWireframe,!0);for(var f=0;f<this.lights.length;f++){var g=this.lights[f],h=g.getShadowGenerator();g.isEnabled()&&h&&-1!==h.getShadowMap().getScene().textures.indexOf(h.getShadowMap())&&this._renderTargets.push(h.getShadowMap())}if(this.postProcessRenderPipelineManager.update(),this.activeCameras.length>0)for(var i=this._renderId,j=0;j<this.activeCameras.length;j++)this._renderId=i,this._processSubCameras(this.activeCameras[j]);else this._processSubCameras(this.activeCamera);this._checkIntersections(),this.afterRender&&this.afterRender();for(var k=0;k<this._toBeDisposed.length;k++)this._toBeDisposed.data[k].dispose(),this._toBeDisposed[k]=null;this._toBeDisposed.reset(),this._lastFrameDuration=(new Date).getTime()-c},b.prototype.dispose=function(){this.beforeRender=null,this.afterRender=null,this.skeletons=[],this._boundingBoxRenderer.dispose(),this.onDispose&&this.onDispose(),this.detachControl();var a,b=this._engine.getRenderingCanvas();for(a=0;a<this.cameras.length;a++)this.cameras[a].detachControl(b);for(;this.lights.length;)this.lights[0].dispose();for(;this.meshes.length;)this.meshes[0].dispose(!0);for(;this.cameras.length;)this.cameras[0].dispose();for(;this.materials.length;)this.materials[0].dispose();for(;this.particleSystems.length;)this.particleSystems[0].dispose();for(;this.spriteManagers.length;)this.spriteManagers[0].dispose();for(;this.layers.length;)this.layers[0].dispose();for(;this.textures.length;)this.textures[0].dispose();this.postProcessManager.dispose(),this._physicsEngine&&this.disablePhysicsEngine(),a=this._engine.scenes.indexOf(this),this._engine.scenes.splice(a,1),this._engine.wipeCaches()},b.prototype._getNewPosition=function(a,b,c,d,e,f){"undefined"==typeof f&&(f=null),a.divideToRef(c.radius,this._scaledPosition),b.divideToRef(c.radius,this._scaledVelocity),c.retry=0,c.initialVelocity=this._scaledVelocity,c.initialPosition=this._scaledPosition,this._collideWithWorld(this._scaledPosition,this._scaledVelocity,c,d,e,f),e.multiplyInPlace(c.radius)},b.prototype._collideWithWorld=function(b,c,d,e,f,g){"undefined"==typeof g&&(g=null);var h=10*a.Engine.CollisionsEpsilon;if(d.retry>=e)return void f.copyFrom(b);d._initialize(b,c,h);for(var i=0;i<this.meshes.length;i++){var j=this.meshes[i];j.isEnabled()&&j.checkCollisions&&j.subMeshes&&j!==g&&j._checkCollision(d)}return d.collisionFound?((0!=c.x||0!=c.y||0!=c.z)&&d._getResponse(b,c),c.length()<=h?void f.copyFrom(b):(d.retry++,void this._collideWithWorld(b,c,d,e,f,g))):void b.addToRef(c,f)},b.prototype.createOrUpdateSelectionOctree=function(b,c){"undefined"==typeof b&&(b=64),"undefined"==typeof c&&(c=2),this._selectionOctree||(this._selectionOctree=new a.Octree(a.Octree.CreationFuncForMeshes,b,c));for(var d=new a.Vector3(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE),e=new a.Vector3(-Number.MAX_VALUE,-Number.MAX_VALUE,-Number.MAX_VALUE),f=0;f<this.meshes.length;f++){var g=this.meshes[f];g.computeWorldMatrix(!0);var h=g.getBoundingInfo().boundingBox.minimumWorld,i=g.getBoundingInfo().boundingBox.maximumWorld;a.Tools.CheckExtends(h,d,e),a.Tools.CheckExtends(i,d,e)}return this._selectionOctree.update(d,e,this.meshes),this._selectionOctree},b.prototype.createPickingRay=function(b,c,d,e){var f=this._engine;if(!e){if(!this.activeCamera)throw new Error("Active camera not set");e=this.activeCamera}var g=e.viewport,h=g.toGlobal(f);return b=b/this._engine.getHardwareScalingLevel()-h.x,c=c/this._engine.getHardwareScalingLevel()-(this._engine.getRenderHeight()-h.y-h.height),a.Ray.CreateNew(b/window.devicePixelRatio,c/window.devicePixelRatio,h.width,h.height,d?d:a.Matrix.Identity(),e.getViewMatrix(),e.getProjectionMatrix())},b.prototype._internalPick=function(b,c,d){for(var e=null,f=0;f<this.meshes.length;f++){var g=this.meshes[f];if(c){if(!c(g))continue}else if(!g.isEnabled()||!g.isVisible||!g.isPickable)continue;var h=g.getWorldMatrix(),i=b(h),j=g.intersects(i,d);if(j&&j.hit&&(d||null==e||!(j.distance>=e.distance))&&(e=j,d))break}return e||new a.PickingInfo},b.prototype.pick=function(a,b,c,d,e){var f=this;return this._internalPick(function(c){return f.createPickingRay(a,b,c,e)},c,d)},b.prototype.pickWithRay=function(b,c,d){var e=this;return this._internalPick(function(c){return e._pickWithRayInverseMatrix||(e._pickWithRayInverseMatrix=a.Matrix.Identity()),c.invertToRef(e._pickWithRayInverseMatrix),a.Ray.Transform(b,e._pickWithRayInverseMatrix)},c,d)},b.prototype.setPointerOverMesh=function(b){this._pointerOverMesh!==b&&(this._pointerOverMesh&&this._pointerOverMesh.actionManager&&this._pointerOverMesh.actionManager.processTrigger(a.ActionManager.OnPointerOutTrigger,a.ActionEvent.CreateNew(this._pointerOverMesh)),this._pointerOverMesh=b,this._pointerOverMesh&&this._pointerOverMesh.actionManager&&this._pointerOverMesh.actionManager.processTrigger(a.ActionManager.OnPointerOverTrigger,a.ActionEvent.CreateNew(this._pointerOverMesh)))},b.prototype.getPointerOverMesh=function(){return this._pointerOverMesh},b.prototype.getPhysicsEngine=function(){return this._physicsEngine},b.prototype.enablePhysics=function(b,c){return this._physicsEngine?!0:(this._physicsEngine=new a.PhysicsEngine(c),this._physicsEngine.isSupported()?(this._physicsEngine._initialize(b),!0):(this._physicsEngine=null,!1))},b.prototype.disablePhysicsEngine=function(){this._physicsEngine&&(this._physicsEngine.dispose(),this._physicsEngine=void 0)},b.prototype.isPhysicsEnabled=function(){return void 0!==this._physicsEngine},b.prototype.setGravity=function(a){this._physicsEngine&&this._physicsEngine._setGravity(a)},b.prototype.createCompoundImpostor=function(a,b){if(a.parts&&(b=a,a=a.parts),!this._physicsEngine)return null;for(var c=0;c<a.length;c++){var d=a[c].mesh;d._physicImpostor=a[c].impostor,d._physicsMass=b.mass/a.length,d._physicsFriction=b.friction,d._physicRestitution=b.restitution}return this._physicsEngine._registerMeshesAsCompound(a,b)},b.prototype.deleteCompoundImpostor=function(b){for(var c=0;c<b.parts.length;c++){var d=b.parts[c].mesh;d._physicImpostor=a.PhysicsEngine.NoImpostor,this._physicsEngine._unregisterMesh(d)}},b.prototype._getByTags=function(b,c){if(void 0===c)return b;var d=[];for(var e in b){var f=b[e];a.Tags.MatchesQuery(f,c)&&d.push(f)}return d},b.prototype.getMeshesByTags=function(a){return this._getByTags(this.meshes,a)},b.prototype.getCamerasByTags=function(a){return this._getByTags(this.cameras,a)},b.prototype.getLightsByTags=function(a){return this._getByTags(this.lights,a)},b.prototype.getMaterialByTags=function(a){return this._getByTags(this.materials,a).concat(this._getByTags(this.multiMaterials,a))},b.FOGMODE_NONE=0,b.FOGMODE_EXP=1,b.FOGMODE_EXP2=2,b.FOGMODE_LINEAR=3,b.MinDeltaTime=1,b.MaxDeltaTime=1e3,b}();a.Scene=b}(BABYLON||(BABYLON={}));var BABYLON;!function(a){var b=function(){function b(c,d,e,f,g){switch(this._engine=c instanceof a.Mesh?c.getScene().getEngine():c,this._updatable=f,this._data=d,g||this.create(),this._kind=e,e){case b.PositionKind:this._strideSize=3;break;case b.NormalKind:this._strideSize=3;break;case b.UVKind:this._strideSize=2;break;case b.UV2Kind:this._strideSize=2;break;case b.ColorKind:this._strideSize=3;break;case b.MatricesIndicesKind:this._strideSize=4;break;case b.MatricesWeightsKind:this._strideSize=4}}return b.prototype.isUpdatable=function(){return this._updatable},b.prototype.getData=function(){return this._data},b.prototype.getBuffer=function(){return this._buffer},b.prototype.getStrideSize=function(){return this._strideSize},b.prototype.create=function(a){(a||!this._buffer)&&(a=a||this._data,this._buffer||(this._buffer=this._updatable?this._engine.createDynamicVertexBuffer(4*a.length):this._engine.createVertexBuffer(a)),this._updatable&&(this._engine.updateDynamicVertexBuffer(this._buffer,a),this._data=a))},b.prototype.update=function(a){this.create(a)},b.prototype.dispose=function(){this._buffer&&this._engine._releaseBuffer(this._buffer)&&(this._buffer=null)},Object.defineProperty(b,"PositionKind",{get:function(){return b._PositionKind},enumerable:!0,configurable:!0}),Object.defineProperty(b,"NormalKind",{get:function(){return b._NormalKind},enumerable:!0,configurable:!0}),Object.defineProperty(b,"UVKind",{get:function(){return b._UVKind},enumerable:!0,configurable:!0}),Object.defineProperty(b,"UV2Kind",{get:function(){return b._UV2Kind},enumerable:!0,configurable:!0}),Object.defineProperty(b,"ColorKind",{get:function(){return b._ColorKind},enumerable:!0,configurable:!0}),Object.defineProperty(b,"MatricesIndicesKind",{get:function(){return b._MatricesIndicesKind},enumerable:!0,configurable:!0}),Object.defineProperty(b,"MatricesWeightsKind",{get:function(){return b._MatricesWeightsKind},enumerable:!0,configurable:!0}),b._PositionKind="position",b._NormalKind="normal",b._UVKind="uv",b._UV2Kind="uv2",b._ColorKind="color",b._MatricesIndicesKind="matricesIndices",b._MatricesWeightsKind="matricesWeights",b
}();a.VertexBuffer=b}(BABYLON||(BABYLON={}));var __extends=this.__extends||function(a,b){function c(){this.constructor=a}for(var d in b)b.hasOwnProperty(d)&&(a[d]=b[d]);c.prototype=b.prototype,a.prototype=new c},BABYLON;!function(a){var b=function(b){function c(a,c){b.call(this,a,c.getScene()),c.instances.push(this),this._sourceMesh=c,this.position.copyFrom(c.position),this.rotation.copyFrom(c.rotation),this.scaling.copyFrom(c.scaling),c.rotationQuaternion&&(this.rotationQuaternion=c.rotationQuaternion.clone()),this.infiniteDistance=c.infiniteDistance,this.setPivotMatrix(c.getPivotMatrix()),this.refreshBoundingInfo(),this._syncSubMeshes()}return __extends(c,b),Object.defineProperty(c.prototype,"receiveShadows",{get:function(){return this._sourceMesh.receiveShadows},enumerable:!0,configurable:!0}),Object.defineProperty(c.prototype,"material",{get:function(){return this._sourceMesh.material},enumerable:!0,configurable:!0}),Object.defineProperty(c.prototype,"visibility",{get:function(){return this._sourceMesh.visibility},enumerable:!0,configurable:!0}),Object.defineProperty(c.prototype,"skeleton",{get:function(){return this._sourceMesh.skeleton},enumerable:!0,configurable:!0}),c.prototype.getTotalVertices=function(){return this._sourceMesh.getTotalVertices()},Object.defineProperty(c.prototype,"sourceMesh",{get:function(){return this._sourceMesh},enumerable:!0,configurable:!0}),c.prototype.getVerticesData=function(a){return this._sourceMesh.getVerticesData(a)},c.prototype.isVerticesDataPresent=function(a){return this._sourceMesh.isVerticesDataPresent(a)},c.prototype.getIndices=function(){return this._sourceMesh.getIndices()},Object.defineProperty(c.prototype,"_positions",{get:function(){return this._sourceMesh._positions},enumerable:!0,configurable:!0}),c.prototype.refreshBoundingInfo=function(){var b=this._sourceMesh.getVerticesData(a.VertexBuffer.PositionKind);if(b){var c=a.Tools.ExtractMinAndMax(b,0,this._sourceMesh.getTotalVertices());this._boundingInfo=new a.BoundingInfo(c.minimum,c.maximum)}this._updateBoundingInfo()},c.prototype._activate=function(a){this.sourceMesh._registerInstanceForRenderId(this,a)},c.prototype._syncSubMeshes=function(){this.releaseSubMeshes();for(var a=0;a<this._sourceMesh.subMeshes.length;a++)this._sourceMesh.subMeshes[a].clone(this,this._sourceMesh)},c.prototype._generatePointsArray=function(){return this._sourceMesh._generatePointsArray()},c.prototype.clone=function(b,c,d){var e=this._sourceMesh.createInstance(b);if(a.Tools.DeepCopy(this,e,["name"],[]),this.refreshBoundingInfo(),c&&(e.parent=c),!d)for(var f=0;f<this.getScene().meshes.length;f++){var g=this.getScene().meshes[f];g.parent==this&&g.clone(g.name,e)}return e.computeWorldMatrix(!0),e},c.prototype.dispose=function(a){var c=this._sourceMesh.instances.indexOf(this);this._sourceMesh.instances.splice(c,1),b.prototype.dispose.call(this,a)},c}(a.AbstractMesh);a.InstancedMesh=b}(BABYLON||(BABYLON={}));var __extends=this.__extends||function(a,b){function c(){this.constructor=a}for(var d in b)b.hasOwnProperty(d)&&(a[d]=b[d]);c.prototype=b.prototype,a.prototype=new c},BABYLON;!function(a){var b=function(){function a(){this.mustReturn=!1,this.visibleInstances=new Array,this.renderSelf=new Array}return a}();a._InstancesBatch=b;var c=function(c){function d(d,e){c.call(this,d,e),this.delayLoadState=a.Engine.DELAYLOADSTATE_NONE,this.instances=new Array,this._onBeforeRenderCallbacks=[],this._visibleInstances={},this._renderIdForInstances=new Array,this._batchCache=new b,this._instancesBufferSize=2048}return __extends(d,c),d.prototype.getTotalVertices=function(){return this._geometry?this._geometry.getTotalVertices():0},d.prototype.getVerticesData=function(a){return this._geometry?this._geometry.getVerticesData(a):null},d.prototype.getVertexBuffer=function(a){return this._geometry?this._geometry.getVertexBuffer(a):void 0},d.prototype.isVerticesDataPresent=function(a){return this._geometry?this._geometry.isVerticesDataPresent(a):this._delayInfo?-1!==this._delayInfo.indexOf(a):!1},d.prototype.getVerticesDataKinds=function(){if(!this._geometry){var a=[];if(this._delayInfo)for(var b in this._delayInfo)a.push(b);return a}return this._geometry.getVerticesDataKinds()},d.prototype.getTotalIndices=function(){return this._geometry?this._geometry.getTotalIndices():0},d.prototype.getIndices=function(){return this._geometry?this._geometry.getIndices():[]},d.prototype.isReady=function(){return this.delayLoadState===a.Engine.DELAYLOADSTATE_LOADING?!1:c.prototype.isReady.call(this)},d.prototype.isDisposed=function(){return this._isDisposed},d.prototype._preActivate=function(){this._visibleInstances=null},d.prototype._registerInstanceForRenderId=function(a,b){this._visibleInstances||(this._visibleInstances={},this._visibleInstances.defaultRenderId=b,this._visibleInstances.selfDefaultRenderId=this._renderId),this._visibleInstances[b]||(this._visibleInstances[b]=new Array),this._visibleInstances[b].push(a)},d.prototype.refreshBoundingInfo=function(){var b=this.getVerticesData(a.VertexBuffer.PositionKind);if(b){var c=a.Tools.ExtractMinAndMax(b,0,this.getTotalVertices());this._boundingInfo=new a.BoundingInfo(c.minimum,c.maximum)}if(this.subMeshes)for(var d=0;d<this.subMeshes.length;d++)this.subMeshes[d].refreshBoundingInfo();this._updateBoundingInfo()},d.prototype._createGlobalSubMesh=function(){var b=this.getTotalVertices();return b&&this.getIndices()?(this.releaseSubMeshes(),new a.SubMesh(0,0,b,0,this.getTotalIndices(),this)):null},d.prototype.subdivide=function(b){if(!(1>b)){for(var c=this.getTotalIndices(),d=c/b|0,e=0;d%3!=0;)d++;this.releaseSubMeshes();for(var f=0;b>f&&!(e>=c);f++)a.SubMesh.CreateFromIndices(0,e,Math.min(d,c-e),this),e+=d;this.synchronizeInstances()}},d.prototype.setVerticesData=function(b,c,d){if(b instanceof Array){var e=c;c=b,b=e,a.Tools.Warn("Deprecated usage of setVerticesData detected (since v1.12). Current signature is setVerticesData(kind, data, updatable).")}if(this._geometry)this._geometry.setVerticesData(b,c,d);else{var f=new a.VertexData;f.set(c,b);var g=this.getScene();new a.Geometry(a.Geometry.RandomId(),g,f,d,this)}},d.prototype.updateVerticesData=function(a,b,c,d){this._geometry&&(d?(this.makeGeometryUnique(),this.updateVerticesData(a,b,c,!1)):this._geometry.updateVerticesData(a,b,c))},d.prototype.makeGeometryUnique=function(){if(this._geometry){var b=this._geometry.copy(a.Geometry.RandomId());b.applyToMesh(this)}},d.prototype.setIndices=function(b){if(this._geometry)this._geometry.setIndices(b);else{var c=new a.VertexData;c.indices=b;var d=this.getScene();new a.Geometry(a.Geometry.RandomId(),d,c,!1,this)}},d.prototype._bind=function(a,b,c){var d=this.getScene().getEngine(),e=this._geometry.getIndexBuffer();c&&(e=a.getLinesIndexBuffer(this.getIndices(),d)),d.bindMultiBuffers(this._geometry.getVertexBuffers(),e,b)},d.prototype._draw=function(a,b,c){if(this._geometry&&this._geometry.getVertexBuffers()&&this._geometry.getIndexBuffer()){var d=this.getScene().getEngine();d.draw(b,b?a.indexStart:0,b?a.indexCount:a.linesIndexCount,c)}},d.prototype.registerBeforeRender=function(a){this._onBeforeRenderCallbacks.push(a)},d.prototype.unregisterBeforeRender=function(a){var b=this._onBeforeRenderCallbacks.indexOf(a);b>-1&&this._onBeforeRenderCallbacks.splice(b,1)},d.prototype._getInstancesRenderList=function(a){var b=this.getScene();if(this._batchCache.mustReturn=!1,this._batchCache.renderSelf[a]=!0,this._batchCache.visibleInstances[a]=null,this._visibleInstances){var c=b.getRenderId();this._batchCache.visibleInstances[a]=this._visibleInstances[c];var d=this._renderId;if(!this._batchCache.visibleInstances[a]&&this._visibleInstances.defaultRenderId&&(this._batchCache.visibleInstances[a]=this._visibleInstances[this._visibleInstances.defaultRenderId],c=this._visibleInstances.defaultRenderId,d=this._visibleInstances.selfDefaultRenderId),this._batchCache.visibleInstances[a]&&this._batchCache.visibleInstances[a].length){if(this._renderIdForInstances[a]===c)return this._batchCache.mustReturn=!0,this._batchCache;c!==d&&(this._batchCache.renderSelf[a]=!1)}this._renderIdForInstances[a]=c}return this._batchCache},d.prototype._renderWithInstances=function(a,b,c,d,e){for(var f=this.instances.length+1,g=16*f*4;this._instancesBufferSize<g;)this._instancesBufferSize*=2;(!this._worldMatricesInstancesBuffer||this._worldMatricesInstancesBuffer.capacity<this._instancesBufferSize)&&(this._worldMatricesInstancesBuffer&&e.deleteInstancesBuffer(this._worldMatricesInstancesBuffer),this._worldMatricesInstancesBuffer=e.createInstancesBuffer(this._instancesBufferSize),this._worldMatricesInstancesArray=new Float32Array(this._instancesBufferSize/4));var h=0,i=0,j=this.getWorldMatrix();c.renderSelf[a._id]&&(j.copyToArray(this._worldMatricesInstancesArray,h),h+=16,i++);var k=c.visibleInstances[a._id];if(k)for(var l=0;l<k.length;l++){var m=k[l];m.getWorldMatrix().copyToArray(this._worldMatricesInstancesArray,h),h+=16,i++}var n=d.getAttributeLocationByName("world0"),o=d.getAttributeLocationByName("world1"),p=d.getAttributeLocationByName("world2"),q=d.getAttributeLocationByName("world3"),r=[n,o,p,q];e.updateAndBindInstancesBuffer(this._worldMatricesInstancesBuffer,this._worldMatricesInstancesArray,r),this._draw(a,!b,i),e.unBindInstancesBuffer(this._worldMatricesInstancesBuffer,r)},d.prototype.render=function(a){var b=this.getScene(),c=this._getInstancesRenderList(a._id);if(!c.mustReturn&&this._geometry&&this._geometry.getVertexBuffers()&&this._geometry.getIndexBuffer()){for(var d=0;d<this._onBeforeRenderCallbacks.length;d++)this._onBeforeRenderCallbacks[d]();var e=b.getEngine(),f=null!==e.getCaps().instancedArrays&&null!==c.visibleInstances[a._id],g=a.getMaterial();if(g&&g.isReady(this,f)){g._preBind();var h=g.getEffect(),i=e.forceWireframe||g.wireframe;this._bind(a,h,i);var j=this.getWorldMatrix();if(g.bind(j,this),f)this._renderWithInstances(a,i,c,h,e);else if(c.renderSelf[a._id]&&this._draw(a,!i),c.visibleInstances[a._id])for(var k=0;k<c.visibleInstances[a._id].length;k++){var l=c.visibleInstances[a._id][k];j=l.getWorldMatrix(),g.bindOnlyWorldMatrix(j),this._draw(a,!i)}g.unbind()}}},d.prototype.getEmittedParticleSystems=function(){for(var a=new Array,b=0;b<this.getScene().particleSystems.length;b++){var c=this.getScene().particleSystems[b];c.emitter===this&&a.push(c)}return a},d.prototype.getHierarchyEmittedParticleSystems=function(){var a=new Array,b=this.getDescendants();b.push(this);for(var c=0;c<this.getScene().particleSystems.length;c++){var d=this.getScene().particleSystems[c];-1!==b.indexOf(d.emitter)&&a.push(d)}return a},d.prototype.getChildren=function(){for(var a=[],b=0;b<this.getScene().meshes.length;b++){var c=this.getScene().meshes[b];c.parent==this&&a.push(c)}return a},d.prototype._checkDelayState=function(){var b=this,c=this,d=this.getScene();this._geometry?this._geometry.load(d):c.delayLoadState===a.Engine.DELAYLOADSTATE_NOTLOADED&&(c.delayLoadState=a.Engine.DELAYLOADSTATE_LOADING,d._addPendingData(c),a.Tools.LoadFile(this.delayLoadingFile,function(c){b._delayLoadingFunction(JSON.parse(c),b),b.delayLoadState=a.Engine.DELAYLOADSTATE_LOADED,d._removePendingData(b)},function(){},d.database))},d.prototype.isInFrustum=function(b){return this.delayLoadState===a.Engine.DELAYLOADSTATE_LOADING?!1:c.prototype.isInFrustum.call(this,b)?(this._checkDelayState(),!0):!1},d.prototype.setMaterialByID=function(a){for(var b=this.getScene().materials,c=b.length-1;c>=0;c--)if(b[c].id==a)return void(this.material=b[c]);var d=this.getScene().multiMaterials;for(c=0;c<d.length;c++)if(d[c].id==a)return void(this.material=d[c])},d.prototype.getAnimatables=function(){var a=[];return this.material&&a.push(this.material),a},d.prototype.bakeTransformIntoVertices=function(b){if(this.isVerticesDataPresent(a.VertexBuffer.PositionKind)){this._resetPointsArrayCache();for(var c=this.getVerticesData(a.VertexBuffer.PositionKind),d=[],e=0;e<c.length;e+=3)a.Vector3.TransformCoordinates(a.Vector3.FromArray(c,e),b).toArray(d,e);if(this.setVerticesData(a.VertexBuffer.PositionKind,d,this.getVertexBuffer(a.VertexBuffer.PositionKind).isUpdatable()),this.isVerticesDataPresent(a.VertexBuffer.NormalKind)){for(c=this.getVerticesData(a.VertexBuffer.NormalKind),d=[],e=0;e<c.length;e+=3)a.Vector3.TransformNormal(a.Vector3.FromArray(c,e),b).toArray(d,e);this.setVerticesData(a.VertexBuffer.NormalKind,d,this.getVertexBuffer(a.VertexBuffer.NormalKind).isUpdatable())}}},d.prototype._resetPointsArrayCache=function(){this._positions=null},d.prototype._generatePointsArray=function(){if(this._positions)return!0;this._positions=[];var b=this.getVerticesData(a.VertexBuffer.PositionKind);if(!b)return!1;for(var c=0;c<b.length;c+=3)this._positions.push(a.Vector3.FromArray(b,c));return!0},d.prototype.clone=function(a,b,c){return this.duplicate(a,b,c)},d.prototype.dispose=function(a){for(this._geometry&&this._geometry.releaseForMesh(this,!0),this._worldMatricesInstancesBuffer&&(this.getEngine().deleteInstancesBuffer(this._worldMatricesInstancesBuffer),this._worldMatricesInstancesBuffer=null);this.instances.length;)this.instances[0].dispose();c.prototype.dispose.call(this,a)},d.prototype.convertToFlatShadedMesh=function(){for(var b=this.getVerticesDataKinds(),c=[],d=[],e=[],f=!1,g=0;g<b.length;g++){var h=b[g],i=this.getVertexBuffer(h);h!==a.VertexBuffer.NormalKind?(c[h]=i,d[h]=c[h].getData(),e[h]=[]):(f=i.isUpdatable(),b.splice(g,1),g--)}var j=this.subMeshes.slice(0),k=this.getIndices(),l=this.getTotalIndices();for(r=0;l>r;r++){var m=k[r];for(g=0;g<b.length;g++){h=b[g];for(var n=c[h].getStrideSize(),o=0;n>o;o++)e[h].push(d[h][m*n+o])}}for(var p=[],q=e[a.VertexBuffer.PositionKind],r=0;l>r;r+=3){k[r]=r,k[r+1]=r+1,k[r+2]=r+2;for(var s=a.Vector3.FromArray(q,3*r),t=a.Vector3.FromArray(q,3*(r+1)),u=a.Vector3.FromArray(q,3*(r+2)),v=s.subtract(t),w=u.subtract(t),x=a.Vector3.Normalize(a.Vector3.Cross(v,w)),y=0;3>y;y++)p.push(x.x),p.push(x.y),p.push(x.z)}for(this.setIndices(k),this.setVerticesData(a.VertexBuffer.NormalKind,p,f),g=0;g<b.length;g++)h=b[g],this.setVerticesData(h,e[h],c[h].isUpdatable());this.releaseSubMeshes();for(var z=0;z<j.length;z++){var A=j[z];new a.SubMesh(A.materialIndex,A.indexStart,A.indexCount,A.indexStart,A.indexCount,this)}this.synchronizeInstances()},d.prototype.createInstance=function(b){return new a.InstancedMesh(b,this)},d.prototype.synchronizeInstances=function(){for(var a=0;a<this.instances.length;a++){var b=this.instances[a];b._syncSubMeshes()}},d.CreateBox=function(b,c,d,e){var f=new a.Mesh(b,d),g=a.VertexData.CreateBox(c);return g.applyToMesh(f,e),f},d.CreateSphere=function(b,c,d,e,f){var g=new a.Mesh(b,e),h=a.VertexData.CreateSphere(c,d);return h.applyToMesh(g,f),g},d.CreateCylinder=function(b,c,d,e,f,g,h,i,j){void 0!==i&&i instanceof a.Scene||(void 0!==i&&(j=i),i=g,g=1);var k=new a.Mesh(b,i),l=a.VertexData.CreateCylinder(c,d,e,f,g,h);return l.applyToMesh(k,j),k},d.CreateTorus=function(b,c,d,e,f,g){var h=new a.Mesh(b,f),i=a.VertexData.CreateTorus(c,d,e);return i.applyToMesh(h,g),h},d.CreateTorusKnot=function(b,c,d,e,f,g,h,i,j){var k=new a.Mesh(b,i),l=a.VertexData.CreateTorusKnot(c,d,e,f,g,h);return l.applyToMesh(k,j),k},d.CreateLines=function(b,c,d,e){var f=new a.LinesMesh(b,d,e),g=a.VertexData.CreateLines(c);return g.applyToMesh(f,e),f},d.CreatePlane=function(b,c,d,e){var f=new a.Mesh(b,d),g=a.VertexData.CreatePlane(c);return g.applyToMesh(f,e),f},d.CreateGround=function(b,c,d,e,f,g){var h=new a.GroundMesh(b,f);h._setReady(!1),h._subdivisions=e;var i=a.VertexData.CreateGround(c,d,e);return i.applyToMesh(h,g),h._setReady(!0),h},d.CreateTiledGround=function(b,c,d,e,f,g,h,i,j){var k=new a.Mesh(b,i),l=a.VertexData.CreateTiledGround(c,d,e,f,g,h);return l.applyToMesh(k,j),k},d.CreateGroundFromHeightMap=function(b,c,d,e,f,g,h,i,j){var k=new a.GroundMesh(b,i);k._subdivisions=f,k._setReady(!1);var l=function(b){var c=document.createElement("canvas"),i=c.getContext("2d"),l=b.width,m=b.height;c.width=l,c.height=m,i.drawImage(b,0,0);var n=i.getImageData(0,0,l,m).data,o=a.VertexData.CreateGroundFromHeightMap(d,e,f,g,h,n,l,m);o.applyToMesh(k,j),k._setReady(!0)};return a.Tools.LoadImage(c,l,function(){},i.database),k},d.MinMax=function(a){var b=null,c=null;for(var d in a){var e=a[d],f=e.getBoundingInfo().boundingBox;b?(b.MinimizeInPlace(f.minimumWorld),c.MaximizeInPlace(f.maximumWorld)):(b=f.minimumWorld,c=f.maximumWorld)}return{min:b,max:c}},d.Center=function(b){var c=void 0!==b.min?b:a.Mesh.MinMax(b);return a.Vector3.Center(c.min,c.max)},d}(a.AbstractMesh);a.Mesh=c}(BABYLON||(BABYLON={}));var __extends=this.__extends||function(a,b){function c(){this.constructor=a}for(var d in b)b.hasOwnProperty(d)&&(a[d]=b[d]);c.prototype=b.prototype,a.prototype=new c},BABYLON;!function(a){var b=function(b){function c(c,d){b.call(this,c,d),this.generateOctree=!1,this._worldInverse=new a.Matrix}return __extends(c,b),Object.defineProperty(c.prototype,"subdivisions",{get:function(){return this._subdivisions},enumerable:!0,configurable:!0}),c.prototype.optimize=function(){this.subdivide(this._subdivisions),this.createOrUpdateSubmeshesOctree(32)},c.prototype.getHeightAtCoordinates=function(b,c){var d=new a.Ray(new a.Vector3(b,this.getBoundingInfo().boundingBox.maximumWorld.y+1,c),new a.Vector3(0,-1,0));this.getWorldMatrix().invertToRef(this._worldInverse),d=a.Ray.Transform(d,this._worldInverse);var e=this.intersects(d);return e.hit?e.pickedPoint.y:0},c}(a.Mesh);a.GroundMesh=b}(BABYLON||(BABYLON={}));var BABYLON;!function(a){var b=function(){function b(a,b,c,d,e,f,g,h){"undefined"==typeof h&&(h=!0),this.materialIndex=a,this.verticesStart=b,this.verticesCount=c,this.indexStart=d,this.indexCount=e,this._renderId=0,this._mesh=f,this._renderingMesh=g||f,f.subMeshes.push(this),this._id=f.subMeshes.length-1,h&&this.refreshBoundingInfo()}return b.prototype.getBoundingInfo=function(){return this._boundingInfo},b.prototype.getMesh=function(){return this._mesh},b.prototype.getRenderingMesh=function(){return this._renderingMesh},b.prototype.getMaterial=function(){var b=this._renderingMesh.material;if(b&&b instanceof a.MultiMaterial){var c=b;return c.getSubMaterial(this.materialIndex)}return b?b:this._mesh.getScene().defaultMaterial},b.prototype.refreshBoundingInfo=function(){var b=this._renderingMesh.getVerticesData(a.VertexBuffer.PositionKind);if(!b)return void(this._boundingInfo=this._mesh._boundingInfo);var c,d=this._renderingMesh.getIndices();c=0===this.indexStart&&this.indexCount===d.length?a.Tools.ExtractMinAndMax(b,this.verticesStart,this.verticesCount):a.Tools.ExtractMinAndMaxIndexed(b,d,this.indexStart,this.indexCount),this._boundingInfo=new a.BoundingInfo(c.minimum,c.maximum)},b.prototype._checkCollision=function(a){return this._boundingInfo._checkCollision(a)},b.prototype.updateBoundingInfo=function(a){this._boundingInfo||this.refreshBoundingInfo(),this._boundingInfo._update(a)},b.prototype.isInFrustum=function(a){return this._boundingInfo.isInFrustum(a)},b.prototype.render=function(){this._renderingMesh.render(this)},b.prototype.getLinesIndexBuffer=function(a,b){if(!this._linesIndexBuffer){for(var c=[],d=this.indexStart;d<this.indexStart+this.indexCount;d+=3)c.push(a[d],a[d+1],a[d+1],a[d+2],a[d+2],a[d]);this._linesIndexBuffer=b.createIndexBuffer(c),this.linesIndexCount=c.length}return this._linesIndexBuffer},b.prototype.canIntersects=function(a){return a.intersectsBox(this._boundingInfo.boundingBox)},b.prototype.intersects=function(b,c,d,e,f){for(var g=null,h=this.indexStart;h<this.indexStart+this.indexCount;h+=3){var i=c[d[h]],j=c[d[h+1]],k=c[d[h+2]],l=b.intersectsTriangle(i,j,k);if(l&&(e||!g||l.distance<g.distance)){if(f){var m=a.PickingInfo.GetNormal(i,j,k),n=b.direction.dot(m);if(n>0)continue}if(g=l,g.faceId=h/3,e)break}}return g},b.prototype.clone=function(c,d){var e=new b(this.materialIndex,this.verticesStart,this.verticesCount,this.indexStart,this.indexCount,c,d,!1);return e._boundingInfo=new a.BoundingInfo(this._boundingInfo.minimum,this._boundingInfo.maximum),e},b.prototype.dispose=function(){this._linesIndexBuffer&&(this._mesh.getScene().getEngine()._releaseBuffer(this._linesIndexBuffer),this._linesIndexBuffer=null);var a=this._mesh.subMeshes.indexOf(this);this._mesh.subMeshes.splice(a,1)},b.CreateFromIndices=function(b,c,d,e,f){var g=Number.MAX_VALUE,h=-Number.MAX_VALUE;f=f||e;for(var i=f.getIndices(),j=c;c+d>j;j++){var k=i[j];g>k&&(g=k),k>h&&(h=k)}return new a.SubMesh(b,g,h-g+1,c,d,e,f)},b}();a.SubMesh=b}(BABYLON||(BABYLON={}));var BABYLON;!function(a){var b=function(){function b(b){this.delayLoadState=a.Engine.DELAYLOADSTATE_NONE,this.hasAlpha=!1,this.getAlphaFromRGB=!1,this.level=1,this.isCube=!1,this.isRenderTarget=!1,this.animations=new Array,this.coordinatesIndex=0,this.coordinatesMode=a.Texture.EXPLICIT_MODE,this.wrapU=a.Texture.WRAP_ADDRESSMODE,this.wrapV=a.Texture.WRAP_ADDRESSMODE,this.anisotropicFilteringLevel=4,this._scene=b,this._scene.textures.push(this)}return b.prototype.getScene=function(){return this._scene},b.prototype.getTextureMatrix=function(){return null},b.prototype.getReflectionTextureMatrix=function(){return null},b.prototype.getInternalTexture=function(){return this._texture},b.prototype.isReady=function(){return this.delayLoadState===a.Engine.DELAYLOADSTATE_NOTLOADED?!0:this._texture?this._texture.isReady:!1},b.prototype.getSize=function(){return this._texture._width?{width:this._texture._width,height:this._texture._height}:this._texture._size?{width:this._texture._size,height:this._texture._size}:{width:0,height:0}},b.prototype.getBaseSize=function(){return this.isReady()?this._texture._size?{width:this._texture._size,height:this._texture._size}:{width:this._texture._baseWidth,height:this._texture._baseHeight}:{width:0,height:0}},b.prototype._getFromCache=function(a,b){for(var c=this._scene.getEngine().getLoadedTexturesCache(),d=0;d<c.length;d++){var e=c[d];if(e.url===a&&e.noMipmap===b)return e.references++,e}return null},b.prototype.delayLoad=function(){},b.prototype.releaseInternalTexture=function(){if(this._texture){var a=this._scene.getEngine().getLoadedTexturesCache();if(this._texture.references--,0==this._texture.references){var b=a.indexOf(this._texture);a.splice(b,1),this._scene.getEngine()._releaseTexture(this._texture),delete this._texture}}},b.prototype.clone=function(){return null},b.prototype.dispose=function(){var a=this._scene.textures.indexOf(this);a>=0&&this._scene.textures.splice(a,1),void 0!==this._texture&&(this.releaseInternalTexture(),this.onDispose&&this.onDispose())},b}();a.BaseTexture=b}(BABYLON||(BABYLON={}));var __extends=this.__extends||function(a,b){function c(){this.constructor=a}for(var d in b)b.hasOwnProperty(d)&&(a[d]=b[d]);c.prototype=b.prototype,a.prototype=new c},BABYLON;!function(a){var b=function(b){function c(d,e,f,g,h){"undefined"==typeof h&&(h=c.TRILINEAR_SAMPLINGMODE),b.call(this,e),this.uOffset=0,this.vOffset=0,this.uScale=1,this.vScale=1,this.uAng=0,this.vAng=0,this.wAng=0,this.name=d,this.url=d,this._noMipmap=f,this._invertY=g,this._samplingMode=h,d&&(this._texture=this._getFromCache(d,f),this._texture||(e.useDelayedTextureLoading?this.delayLoadState=a.Engine.DELAYLOADSTATE_NOTLOADED:this._texture=e.getEngine().createTexture(d,f,g,e,this._samplingMode)))}return __extends(c,b),c.prototype.delayLoad=function(){this.delayLoadState==a.Engine.DELAYLOADSTATE_NOTLOADED&&(this.delayLoadState=a.Engine.DELAYLOADSTATE_LOADED,this._texture=this._getFromCache(this.url,this._noMipmap),this._texture||(this._texture=this.getScene().getEngine().createTexture(this.url,this._noMipmap,this._invertY,this.getScene(),this._samplingMode)))},c.prototype._prepareRowForTextureGeneration=function(b,c,d,e){b-=this.uOffset+.5,c-=this.vOffset+.5,d-=.5,a.Vector3.TransformCoordinatesFromFloatsToRef(b,c,d,this._rowGenerationMatrix,e),e.x*=this.uScale,e.y*=this.vScale,e.x+=.5,e.y+=.5,e.z+=.5},c.prototype.getTextureMatrix=function(){return this.uOffset===this._cachedUOffset&&this.vOffset===this._cachedVOffset&&this.uScale===this._cachedUScale&&this.vScale===this._cachedVScale&&this.uAng===this._cachedUAng&&this.vAng===this._cachedVAng&&this.wAng===this._cachedWAng?this._cachedTextureMatrix:(this._cachedUOffset=this.uOffset,this._cachedVOffset=this.vOffset,this._cachedUScale=this.uScale,this._cachedVScale=this.vScale,this._cachedUAng=this.uAng,this._cachedVAng=this.vAng,this._cachedWAng=this.wAng,this._cachedTextureMatrix||(this._cachedTextureMatrix=a.Matrix.Zero(),this._rowGenerationMatrix=new a.Matrix,this._t0=a.Vector3.Zero(),this._t1=a.Vector3.Zero(),this._t2=a.Vector3.Zero()),a.Matrix.RotationYawPitchRollToRef(this.vAng,this.uAng,this.wAng,this._rowGenerationMatrix),this._prepareRowForTextureGeneration(0,0,0,this._t0),this._prepareRowForTextureGeneration(1,0,0,this._t1),this._prepareRowForTextureGeneration(0,1,0,this._t2),this._t1.subtractInPlace(this._t0),this._t2.subtractInPlace(this._t0),a.Matrix.IdentityToRef(this._cachedTextureMatrix),this._cachedTextureMatrix.m[0]=this._t1.x,this._cachedTextureMatrix.m[1]=this._t1.y,this._cachedTextureMatrix.m[2]=this._t1.z,this._cachedTextureMatrix.m[4]=this._t2.x,this._cachedTextureMatrix.m[5]=this._t2.y,this._cachedTextureMatrix.m[6]=this._t2.z,this._cachedTextureMatrix.m[8]=this._t0.x,this._cachedTextureMatrix.m[9]=this._t0.y,this._cachedTextureMatrix.m[10]=this._t0.z,this._cachedTextureMatrix)},c.prototype.getReflectionTextureMatrix=function(){if(this.uOffset===this._cachedUOffset&&this.vOffset===this._cachedVOffset&&this.uScale===this._cachedUScale&&this.vScale===this._cachedVScale&&this.coordinatesMode===this._cachedCoordinatesMode)return this._cachedTextureMatrix;switch(this._cachedTextureMatrix||(this._cachedTextureMatrix=a.Matrix.Zero(),this._projectionModeMatrix=a.Matrix.Zero()),this.coordinatesMode){case a.Texture.SPHERICAL_MODE:a.Matrix.IdentityToRef(this._cachedTextureMatrix),this._cachedTextureMatrix[0]=-.5*this.uScale,this._cachedTextureMatrix[5]=-.5*this.vScale,this._cachedTextureMatrix[12]=.5+this.uOffset,this._cachedTextureMatrix[13]=.5+this.vOffset;break;case a.Texture.PLANAR_MODE:a.Matrix.IdentityToRef(this._cachedTextureMatrix),this._cachedTextureMatrix[0]=this.uScale,this._cachedTextureMatrix[5]=this.vScale,this._cachedTextureMatrix[12]=this.uOffset,this._cachedTextureMatrix[13]=this.vOffset;break;case a.Texture.PROJECTION_MODE:a.Matrix.IdentityToRef(this._projectionModeMatrix),this._projectionModeMatrix.m[0]=.5,this._projectionModeMatrix.m[5]=-.5,this._projectionModeMatrix.m[10]=0,this._projectionModeMatrix.m[12]=.5,this._projectionModeMatrix.m[13]=.5,this._projectionModeMatrix.m[14]=1,this._projectionModeMatrix.m[15]=1,this.getScene().getProjectionMatrix().multiplyToRef(this._projectionModeMatrix,this._cachedTextureMatrix);break;default:a.Matrix.IdentityToRef(this._cachedTextureMatrix)}return this._cachedTextureMatrix},c.prototype.clone=function(){var b=new a.Texture(this._texture.url,this.getScene(),this._noMipmap,this._invertY);return b.hasAlpha=this.hasAlpha,b.level=this.level,b.wrapU=this.wrapU,b.wrapV=this.wrapV,b.coordinatesIndex=this.coordinatesIndex,b.coordinatesMode=this.coordinatesMode,b.uOffset=this.uOffset,b.vOffset=this.vOffset,b.uScale=this.uScale,b.vScale=this.vScale,b.uAng=this.uAng,b.vAng=this.vAng,b.wAng=this.wAng,b},c.NEAREST_SAMPLINGMODE=1,c.BILINEAR_SAMPLINGMODE=2,c.TRILINEAR_SAMPLINGMODE=3,c.EXPLICIT_MODE=0,c.SPHERICAL_MODE=1,c.PLANAR_MODE=2,c.CUBIC_MODE=3,c.PROJECTION_MODE=4,c.SKYBOX_MODE=5,c.CLAMP_ADDRESSMODE=0,c.WRAP_ADDRESSMODE=1,c.MIRROR_ADDRESSMODE=2,c}(a.BaseTexture);a.Texture=b}(BABYLON||(BABYLON={}));var __extends=this.__extends||function(a,b){function c(){this.constructor=a}for(var d in b)b.hasOwnProperty(d)&&(a[d]=b[d]);c.prototype=b.prototype,a.prototype=new c},BABYLON;!function(a){var b=function(b){function c(c,d,e,f){b.call(this,d),this.coordinatesMode=a.Texture.CUBIC_MODE,this.name=c,this.url=c,this._noMipmap=f,this.hasAlpha=!1,this._texture=this._getFromCache(c,f),e||(e=["_px.jpg","_py.jpg","_pz.jpg","_nx.jpg","_ny.jpg","_nz.jpg"]),this._extensions=e,this._texture||(d.useDelayedTextureLoading?this.delayLoadState=a.Engine.DELAYLOADSTATE_NOTLOADED:this._texture=d.getEngine().createCubeTexture(c,d,e,f)),this.isCube=!0,this._textureMatrix=a.Matrix.Identity()}return __extends(c,b),c.prototype.clone=function(){var b=new a.CubeTexture(this.url,this.getScene(),this._extensions,this._noMipmap);return b.level=this.level,b.wrapU=this.wrapU,b.wrapV=this.wrapV,b.coordinatesIndex=this.coordinatesIndex,b.coordinatesMode=this.coordinatesMode,b},c.prototype.delayLoad=function(){this.delayLoadState==a.Engine.DELAYLOADSTATE_NOTLOADED&&(this.delayLoadState=a.Engine.DELAYLOADSTATE_LOADED,this._texture=this._getFromCache(this.url,this._noMipmap),this._texture||(this._texture=this.getScene().getEngine().createCubeTexture(this.url,this.getScene(),this._extensions)))},c.prototype.getReflectionTextureMatrix=function(){return this._textureMatrix},c}(a.BaseTexture);a.CubeTexture=b}(BABYLON||(BABYLON={}));var __extends=this.__extends||function(a,b){function c(){this.constructor=a}for(var d in b)b.hasOwnProperty(d)&&(a[d]=b[d]);c.prototype=b.prototype,a.prototype=new c},BABYLON;!function(a){var b=function(b){function c(c,d,e,f,g){"undefined"==typeof g&&(g=!0),b.call(this,null,e,!f),this.renderList=new Array,this.renderParticles=!0,this.renderSprites=!1,this.coordinatesMode=a.Texture.PROJECTION_MODE,this._currentRefreshId=-1,this._refreshRate=1,this.name=c,this.isRenderTarget=!0,this._size=d,this._generateMipMaps=f,this._doNotChangeAspectRatio=g,this._texture=e.getEngine().createRenderTargetTexture(d,f),this._renderingManager=new a.RenderingManager(e)}return __extends(c,b),c.prototype.resetRefreshCounter=function(){this._currentRefreshId=-1},Object.defineProperty(c.prototype,"refreshRate",{get:function(){return this._refreshRate},set:function(a){this._refreshRate=a,this.resetRefreshCounter()},enumerable:!0,configurable:!0}),c.prototype._shouldRender=function(){return-1===this._currentRefreshId?(this._currentRefreshId=1,!0):this.refreshRate==this._currentRefreshId?(this._currentRefreshId=1,!0):(this._currentRefreshId++,!1)},c.prototype.getRenderSize=function(){return this._size},c.prototype.resize=function(a,b){this.releaseInternalTexture(),this._texture=this.getScene().getEngine().createRenderTargetTexture(a,b)},c.prototype.render=function(a){var b=this.getScene(),c=b.getEngine();if(this._waitingRenderList){this.renderList=[];for(var d=0;d<this._waitingRenderList.length;d++){var e=this._waitingRenderList[d];this.renderList.push(b.getMeshByID(e))}delete this._waitingRenderList}if(this.renderList&&0!=this.renderList.length){a&&b.postProcessManager._prepareFrame(this._texture)||c.bindFramebuffer(this._texture),c.clear(b.clearColor,!0,!0),this._renderingManager.reset();for(var f=0;f<this.renderList.length;f++){var g=this.renderList[f];if(g){if(!g.isReady()||g.material&&!g.material.isReady(g)){this.resetRefreshCounter();continue}if(g.isEnabled()&&g.isVisible&&g.subMeshes&&0!=(g.layerMask&b.activeCamera.layerMask)){g._activate(b.getRenderId());for(var h=0;h<g.subMeshes.length;h++){var i=g.subMeshes[h];b._activeVertices+=i.verticesCount,this._renderingManager.dispatch(i)}}}}this._doNotChangeAspectRatio||b.updateTransformMatrix(!0),this.onBeforeRender&&this.onBeforeRender(),this._renderingManager.render(this.customRenderFunction,this.renderList,this.renderParticles,this.renderSprites),a&&b.postProcessManager._finalizeFrame(!1,this._texture),this.onAfterRender&&this.onAfterRender(),c.unBindFramebuffer(this._texture),this._doNotChangeAspectRatio||b.updateTransformMatrix(!0)}},c.prototype.clone=function(){var b=this.getSize(),c=new a.RenderTargetTexture(this.name,b.width,this.getScene(),this._generateMipMaps);return c.hasAlpha=this.hasAlpha,c.level=this.level,c.coordinatesMode=this.coordinatesMode,c.renderList=this.renderList.slice(0),c},c}(a.Texture);a.RenderTargetTexture=b}(BABYLON||(BABYLON={}));var __extends=this.__extends||function(a,b){function c(){this.constructor=a}for(var d in b)b.hasOwnProperty(d)&&(a[d]=b[d]);c.prototype=b.prototype,a.prototype=new c},BABYLON;!function(a){var b=function(b){function c(c,d,e,f){var g=this;
b.call(this,c,d,e,f,!0),this.mirrorPlane=new a.Plane(0,1,0,1),this._transformMatrix=a.Matrix.Zero(),this._mirrorMatrix=a.Matrix.Zero(),this.onBeforeRender=function(){a.Matrix.ReflectionToRef(g.mirrorPlane,g._mirrorMatrix),g._savedViewMatrix=e.getViewMatrix(),g._mirrorMatrix.multiplyToRef(g._savedViewMatrix,g._transformMatrix),e.setTransformMatrix(g._transformMatrix,e.getProjectionMatrix()),e.clipPlane=g.mirrorPlane,e.getEngine().cullBackFaces=!1},this.onAfterRender=function(){e.setTransformMatrix(g._savedViewMatrix,e.getProjectionMatrix()),e.getEngine().cullBackFaces=!0,delete e.clipPlane}}return __extends(c,b),c.prototype.clone=function(){var b=this.getSize(),c=new a.MirrorTexture(this.name,b.width,this.getScene(),this._generateMipMaps);return c.hasAlpha=this.hasAlpha,c.level=this.level,c.mirrorPlane=this.mirrorPlane.clone(),c.renderList=this.renderList.slice(0),c},c}(a.RenderTargetTexture);a.MirrorTexture=b}(BABYLON||(BABYLON={}));var __extends=this.__extends||function(a,b){function c(){this.constructor=a}for(var d in b)b.hasOwnProperty(d)&&(a[d]=b[d]);c.prototype=b.prototype,a.prototype=new c},BABYLON;!function(a){var b=function(b){function c(c,d,e,f,g){"undefined"==typeof g&&(g=a.Texture.TRILINEAR_SAMPLINGMODE),b.call(this,null,e,!f),this.name=c,this.wrapU=a.Texture.CLAMP_ADDRESSMODE,this.wrapV=a.Texture.CLAMP_ADDRESSMODE,this._generateMipMaps=f,d.getContext?(this._canvas=d,this._texture=e.getEngine().createDynamicTexture(d.width,d.height,f,g)):(this._canvas=document.createElement("canvas"),this._texture=d.width?e.getEngine().createDynamicTexture(d.width,d.height,f,g):e.getEngine().createDynamicTexture(d,d,f,g));var h=this.getSize();this._canvas.width=h.width,this._canvas.height=h.height,this._context=this._canvas.getContext("2d")}return __extends(c,b),c.prototype.getContext=function(){return this._context},c.prototype.update=function(a){this.getScene().getEngine().updateDynamicTexture(this._texture,this._canvas,void 0===a?!0:a)},c.prototype.drawText=function(a,b,c,d,e,f,g){var h=this.getSize();if(f&&(this._context.fillStyle=f,this._context.fillRect(0,0,h.width,h.height)),this._context.font=d,null===b){var i=this._context.measureText(a);b=(h.width-i.width)/2}this._context.fillStyle=e,this._context.fillText(a,b,c),this.update(g)},c.prototype.clone=function(){var b=this.getSize(),c=new a.DynamicTexture(this.name,b.width,this.getScene(),this._generateMipMaps);return c.hasAlpha=this.hasAlpha,c.level=this.level,c.wrapU=this.wrapU,c.wrapV=this.wrapV,c},c}(a.Texture);a.DynamicTexture=b}(BABYLON||(BABYLON={}));var __extends=this.__extends||function(a,b){function c(){this.constructor=a}for(var d in b)b.hasOwnProperty(d)&&(a[d]=b[d]);c.prototype=b.prototype,a.prototype=new c},BABYLON;!function(a){var b=function(b){function c(c,d,e,f,g,h,i){"undefined"==typeof i&&(i=a.Texture.TRILINEAR_SAMPLINGMODE);var j=this;b.call(this,null,f,!g,h),this._autoLaunch=!0,this.name=c,this.wrapU=a.Texture.WRAP_ADDRESSMODE,this.wrapV=a.Texture.WRAP_ADDRESSMODE;var k=e.width||e,l=e.height||e;this._texture=f.getEngine().createDynamicTexture(k,l,g,i);var m=this.getSize();this.video=document.createElement("video"),this.video.width=m.width,this.video.height=m.height,this.video.autoplay=!1,this.video.loop=!0,this.video.addEventListener("canplaythrough",function(){j._texture&&(j._texture.isReady=!0)}),d.forEach(function(a){var b=document.createElement("source");b.src=a,j.video.appendChild(b)}),this._lastUpdate=(new Date).getTime()}return __extends(c,b),c.prototype.update=function(){this._autoLaunch&&(this._autoLaunch=!1,this.video.play());var a=(new Date).getTime();return a-this._lastUpdate<15?!1:(this._lastUpdate=a,this.getScene().getEngine().updateVideoTexture(this._texture,this.video,this._invertY),!0)},c}(a.Texture);a.VideoTexture=b}(BABYLON||(BABYLON={}));var BABYLON;!function(a){var b=function(){function b(a,b,c,d,e,f,g,h,i){var j=this;this._isReady=!1,this._compilationError="",this._valueCache=[],this._engine=e,this.name=a,this.defines=f,this._uniformsNames=c.concat(d),this._samplers=d,this._attributesNames=b,this.onError=i,this.onCompiled=h;var k,l;a.vertexElement?(k=document.getElementById(a.vertexElement),l=document.getElementById(a.fragmentElement)):(k=a.vertexElement||a.vertex||a,l=a.fragmentElement||a.fragment||a),this._loadVertexShader(k,function(a){j._loadFragmentShader(l,function(c){j._prepareEffect(a,c,b,f,g)})})}return b.prototype.isReady=function(){return this._isReady},b.prototype.getProgram=function(){return this._program},b.prototype.getAttributesNames=function(){return this._attributesNames},b.prototype.getAttributeLocation=function(a){return this._attributes[a]},b.prototype.getAttributeLocationByName=function(a){var b=this._attributesNames.indexOf(a);return this._attributes[b]},b.prototype.getAttributesCount=function(){return this._attributes.length},b.prototype.getUniformIndex=function(a){return this._uniformsNames.indexOf(a)},b.prototype.getUniform=function(a){return this._uniforms[this._uniformsNames.indexOf(a)]},b.prototype.getSamplers=function(){return this._samplers},b.prototype.getCompilationError=function(){return this._compilationError},b.prototype._loadVertexShader=function(b,c){if(b instanceof HTMLElement){var d=a.Tools.GetDOMTextContent(b);return void c(d)}if(a.Effect.ShadersStore[b+"VertexShader"])return void c(a.Effect.ShadersStore[b+"VertexShader"]);var e;e="."===b[0]?b:a.Engine.ShadersRepository+b,a.Tools.LoadFile(e+".vertex.fx",c)},b.prototype._loadFragmentShader=function(b,c){if(b instanceof HTMLElement){var d=a.Tools.GetDOMTextContent(b);return void c(d)}if(a.Effect.ShadersStore[b+"PixelShader"])return void c(a.Effect.ShadersStore[b+"PixelShader"]);var e;e="."===b[0]?b:a.Engine.ShadersRepository+b,a.Tools.LoadFile(e+".fragment.fx",c)},b.prototype._prepareEffect=function(b,c,d,e,f,g){try{var h=this._engine;this._program=h.createShaderProgram(b,c,e),this._uniforms=h.getUniforms(this._program,this._uniformsNames),this._attributes=h.getAttributes(this._program,d);for(var i=0;i<this._samplers.length;i++){var j=this.getUniform(this._samplers[i]);null==j&&(this._samplers.splice(i,1),i--)}h.bindSamplers(this),this._isReady=!0,this.onCompiled&&this.onCompiled(this)}catch(k){if(!g&&f){for(i=0;i<f.length;i++)e=e.replace(f[i],"");this._prepareEffect(b,c,d,e,f,!0)}else a.Tools.Error("Unable to compile effect: "+this.name),a.Tools.Error("Defines: "+e),a.Tools.Error("Optional defines: "+f),a.Tools.Error("Error: "+k.message),this._compilationError=k.message,this.onError&&this.onError(this,this._compilationError)}},b.prototype._bindTexture=function(a,b){this._engine._bindTexture(this._samplers.indexOf(a),b)},b.prototype.setTexture=function(a,b){this._engine.setTexture(this._samplers.indexOf(a),b)},b.prototype.setTextureFromPostProcess=function(a,b){this._engine.setTextureFromPostProcess(this._samplers.indexOf(a),b)},b.prototype._cacheFloat2=function(a,b,c){return this._valueCache[a]?(this._valueCache[a][0]=b,void(this._valueCache[a][1]=c)):void(this._valueCache[a]=[b,c])},b.prototype._cacheFloat3=function(a,b,c,d){return this._valueCache[a]?(this._valueCache[a][0]=b,this._valueCache[a][1]=c,void(this._valueCache[a][2]=d)):void(this._valueCache[a]=[b,c,d])},b.prototype._cacheFloat4=function(a,b,c,d,e){return this._valueCache[a]?(this._valueCache[a][0]=b,this._valueCache[a][1]=c,this._valueCache[a][2]=d,void(this._valueCache[a][3]=e)):void(this._valueCache[a]=[b,c,d,e])},b.prototype.setArray=function(a,b){return this._engine.setArray(this.getUniform(a),b),this},b.prototype.setMatrices=function(a,b){return this._engine.setMatrices(this.getUniform(a),b),this},b.prototype.setMatrix=function(a,b){return this._engine.setMatrix(this.getUniform(a),b),this},b.prototype.setFloat=function(a,b){return this._valueCache[a]&&this._valueCache[a]===b?this:(this._valueCache[a]=b,this._engine.setFloat(this.getUniform(a),b),this)},b.prototype.setBool=function(a,b){return this._valueCache[a]&&this._valueCache[a]===b?this:(this._valueCache[a]=b,this._engine.setBool(this.getUniform(a),b?1:0),this)},b.prototype.setVector2=function(a,b){return this._valueCache[a]&&this._valueCache[a][0]==b.x&&this._valueCache[a][1]==b.y?this:(this._cacheFloat2(a,b.x,b.y),this._engine.setFloat2(this.getUniform(a),b.x,b.y),this)},b.prototype.setFloat2=function(a,b,c){return this._valueCache[a]&&this._valueCache[a][0]==b&&this._valueCache[a][1]==c?this:(this._cacheFloat2(a,b,c),this._engine.setFloat2(this.getUniform(a),b,c),this)},b.prototype.setVector3=function(a,b){return this._valueCache[a]&&this._valueCache[a][0]==b.x&&this._valueCache[a][1]==b.y&&this._valueCache[a][2]==b.z?this:(this._cacheFloat3(a,b.x,b.y,b.z),this._engine.setFloat3(this.getUniform(a),b.x,b.y,b.z),this)},b.prototype.setFloat3=function(a,b,c,d){return this._valueCache[a]&&this._valueCache[a][0]==b&&this._valueCache[a][1]==c&&this._valueCache[a][2]==d?this:(this._cacheFloat3(a,b,c,d),this._engine.setFloat3(this.getUniform(a),b,c,d),this)},b.prototype.setFloat4=function(a,b,c,d,e){return this._valueCache[a]&&this._valueCache[a][0]==b&&this._valueCache[a][1]==c&&this._valueCache[a][2]==d&&this._valueCache[a][3]==e?this:(this._cacheFloat4(a,b,c,d,e),this._engine.setFloat4(this.getUniform(a),b,c,d,e),this)},b.prototype.setColor3=function(a,b){return this._valueCache[a]&&this._valueCache[a][0]==b.r&&this._valueCache[a][1]==b.g&&this._valueCache[a][2]==b.b?this:(this._cacheFloat3(a,b.r,b.g,b.b),this._engine.setColor3(this.getUniform(a),b),this)},b.prototype.setColor4=function(a,b,c){return this._valueCache[a]&&this._valueCache[a][0]==b.r&&this._valueCache[a][1]==b.g&&this._valueCache[a][2]==b.b&&this._valueCache[a][3]==c?this:(this._cacheFloat4(a,b.r,b.g,b.b,c),this._engine.setColor4(this.getUniform(a),b,c),this)},b.ShadersStore={},b}();a.Effect=b}(BABYLON||(BABYLON={}));var BABYLON;!function(a){var b=function(){function a(a,b,c){this.name=a,this.checkReadyOnEveryCall=!1,this.checkReadyOnlyOnce=!0,this.state="",this.alpha=1,this.wireframe=!1,this.backFaceCulling=!0,this._wasPreviouslyReady=!1,this.id=a,this._scene=b,c||b.materials.push(this)}return a.prototype.isReady=function(){return!0},a.prototype.getEffect=function(){return this._effect},a.prototype.getScene=function(){return this._scene},a.prototype.needAlphaBlending=function(){return this.alpha<1},a.prototype.needAlphaTesting=function(){return!1},a.prototype.getAlphaTestTexture=function(){return null},a.prototype.trackCreation=function(){},a.prototype._preBind=function(){var a=this._scene.getEngine();return a.setState(this.backFaceCulling),a.enableEffect(this._effect)},a.prototype.bind=function(){},a.prototype.bindOnlyWorldMatrix=function(){},a.prototype.unbind=function(){},a.prototype.dispose=function(a){var b=this._scene.materials.indexOf(this);this._scene.materials.splice(b,1),a&&this._effect&&(this._scene.getEngine()._releaseEffect(this._effect),this._effect=null),this.onDispose&&this.onDispose()},a}();a.Material=b}(BABYLON||(BABYLON={}));var __extends=this.__extends||function(a,b){function c(){this.constructor=a}for(var d in b)b.hasOwnProperty(d)&&(a[d]=b[d]);c.prototype=b.prototype,a.prototype=new c},BABYLON;!function(a){var b=4,c=function(c){function d(b,d){var e=this;c.call(this,b,d),this.ambientColor=new a.Color3(0,0,0),this.diffuseColor=new a.Color3(1,1,1),this.specularColor=new a.Color3(1,1,1),this.specularPower=64,this.emissiveColor=new a.Color3(0,0,0),this.useAlphaFromDiffuseTexture=!1,this._cachedDefines=null,this._renderTargets=new a.SmartArray(16),this._worldViewProjectionMatrix=a.Matrix.Zero(),this._globalAmbientColor=new a.Color3(0,0,0),this._baseColor=new a.Color3,this._scaledDiffuse=new a.Color3,this._scaledSpecular=new a.Color3,this.getRenderTargetTextures=function(){return e._renderTargets.reset(),e.reflectionTexture&&e.reflectionTexture.isRenderTarget&&e._renderTargets.push(e.reflectionTexture),e._renderTargets}}return __extends(d,c),d.prototype.needAlphaBlending=function(){return this.alpha<1||null!=this.opacityTexture||this._shouldUseAlphaFromDiffuseTexture()},d.prototype.needAlphaTesting=function(){return null!=this.diffuseTexture&&this.diffuseTexture.hasAlpha&&!this.diffuseTexture.getAlphaFromRGB},d.prototype._shouldUseAlphaFromDiffuseTexture=function(){return null!=this.diffuseTexture&&this.diffuseTexture.hasAlpha&&this.useAlphaFromDiffuseTexture},d.prototype.getAlphaTestTexture=function(){return this.diffuseTexture},d.prototype._shouldUseAlphaFromDiffuseTexture=function(){return null!=this.diffuseTexture&&this.diffuseTexture.hasAlpha&&this.useAlphaFromDiffuseTexture},d.prototype.isReady=function(c,d){if(this.checkReadyOnlyOnce&&this._wasPreviouslyReady)return!0;var e=this.getScene();if(!this.checkReadyOnEveryCall&&this._renderId===e.getRenderId())return!0;var f=e.getEngine(),g=[],h=new Array;if(e.texturesEnabled){if(this.diffuseTexture&&a.StandardMaterial.DiffuseTextureEnabled){if(!this.diffuseTexture.isReady())return!1;g.push("#define DIFFUSE")}if(this.ambientTexture&&a.StandardMaterial.AmbientTextureEnabled){if(!this.ambientTexture.isReady())return!1;g.push("#define AMBIENT")}if(this.opacityTexture&&a.StandardMaterial.OpacityTextureEnabled){if(!this.opacityTexture.isReady())return!1;g.push("#define OPACITY"),this.opacityTexture.getAlphaFromRGB&&g.push("#define OPACITYRGB")}if(this.reflectionTexture&&a.StandardMaterial.ReflectionTextureEnabled){if(!this.reflectionTexture.isReady())return!1;g.push("#define REFLECTION")}if(this.emissiveTexture&&a.StandardMaterial.EmissiveTextureEnabled){if(!this.emissiveTexture.isReady())return!1;g.push("#define EMISSIVE")}if(this.specularTexture&&a.StandardMaterial.SpecularTextureEnabled){if(!this.specularTexture.isReady())return!1;g.push("#define SPECULAR"),h.push(g[g.length-1])}}if(e.getEngine().getCaps().standardDerivatives&&this.bumpTexture&&a.StandardMaterial.BumpTextureEnabled){if(!this.bumpTexture.isReady())return!1;g.push("#define BUMP"),h.push(g[g.length-1])}e.clipPlane&&g.push("#define CLIPPLANE"),f.getAlphaTesting()&&g.push("#define ALPHATEST"),this._shouldUseAlphaFromDiffuseTexture()&&g.push("#define ALPHAFROMDIFFUSE"),e.fogMode!==a.Scene.FOGMODE_NONE&&(g.push("#define FOG"),h.push(g[g.length-1]));var i=!1,j=0;if(e.lightsEnabled)for(var k=0;k<e.lights.length;k++){var l=e.lights[k];if(l.isEnabled()){if(l._excludedMeshesIds.length>0){for(var m=0;m<l._excludedMeshesIds.length;m++){var n=e.getMeshByID(l._excludedMeshesIds[m]);n&&l.excludedMeshes.push(n)}l._excludedMeshesIds=[]}if(!c||-1===l.excludedMeshes.indexOf(c)){g.push("#define LIGHT"+j),j>0&&h.push(g[g.length-1]);var o;o=l instanceof a.SpotLight?"#define SPOTLIGHT"+j:l instanceof a.HemisphericLight?"#define HEMILIGHT"+j:"#define POINTDIRLIGHT"+j,g.push(o),j>0&&h.push(g[g.length-1]);var p=l.getShadowGenerator();if(c&&c.receiveShadows&&p&&(g.push("#define SHADOW"+j),j>0&&h.push(g[g.length-1]),i||(g.push("#define SHADOWS"),i=!0),p.useVarianceShadowMap&&(g.push("#define SHADOWVSM"+j),j>0&&h.push(g[g.length-1])),p.usePoissonSampling&&(g.push("#define SHADOWPCF"+j),j>0&&h.push(g[g.length-1]))),j++,j==b)break}}}var q=[a.VertexBuffer.PositionKind,a.VertexBuffer.NormalKind];c&&(c.isVerticesDataPresent(a.VertexBuffer.UVKind)&&(q.push(a.VertexBuffer.UVKind),g.push("#define UV1")),c.isVerticesDataPresent(a.VertexBuffer.UV2Kind)&&(q.push(a.VertexBuffer.UV2Kind),g.push("#define UV2")),c.isVerticesDataPresent(a.VertexBuffer.ColorKind)&&(q.push(a.VertexBuffer.ColorKind),g.push("#define VERTEXCOLOR")),c.skeleton&&c.isVerticesDataPresent(a.VertexBuffer.MatricesIndicesKind)&&c.isVerticesDataPresent(a.VertexBuffer.MatricesWeightsKind)&&(q.push(a.VertexBuffer.MatricesIndicesKind),q.push(a.VertexBuffer.MatricesWeightsKind),g.push("#define BONES"),g.push("#define BonesPerMesh "+(c.skeleton.bones.length+1)),g.push("#define BONES4"),h.push(g[g.length-1])),d&&(g.push("#define INSTANCES"),q.push("world0"),q.push("world1"),q.push("world2"),q.push("world3")));var r=g.join("\n");if(this._cachedDefines!=r){this._cachedDefines=r;var s="default";e.getEngine().getCaps().standardDerivatives||(s="legacydefault"),this._effect=e.getEngine().createEffect(s,q,["world","view","viewProjection","vEyePosition","vLightsType","vAmbientColor","vDiffuseColor","vSpecularColor","vEmissiveColor","vLightData0","vLightDiffuse0","vLightSpecular0","vLightDirection0","vLightGround0","lightMatrix0","vLightData1","vLightDiffuse1","vLightSpecular1","vLightDirection1","vLightGround1","lightMatrix1","vLightData2","vLightDiffuse2","vLightSpecular2","vLightDirection2","vLightGround2","lightMatrix2","vLightData3","vLightDiffuse3","vLightSpecular3","vLightDirection3","vLightGround3","lightMatrix3","vFogInfos","vFogColor","vDiffuseInfos","vAmbientInfos","vOpacityInfos","vReflectionInfos","vEmissiveInfos","vSpecularInfos","vBumpInfos","mBones","vClipPlane","diffuseMatrix","ambientMatrix","opacityMatrix","reflectionMatrix","emissiveMatrix","specularMatrix","bumpMatrix","darkness0","darkness1","darkness2","darkness3"],["diffuseSampler","ambientSampler","opacitySampler","reflectionCubeSampler","reflection2DSampler","emissiveSampler","specularSampler","bumpSampler","shadowSampler0","shadowSampler1","shadowSampler2","shadowSampler3"],r,h,this.onCompiled,this.onError)}return this._effect.isReady()?(this._renderId=e.getRenderId(),this._wasPreviouslyReady=!0,!0):!1},d.prototype.unbind=function(){this.reflectionTexture&&this.reflectionTexture.isRenderTarget&&this._effect.setTexture("reflection2DSampler",null)},d.prototype.bindOnlyWorldMatrix=function(a){this._effect.setMatrix("world",a)},d.prototype.bind=function(c,d){var e=this.getScene();if(this._baseColor.copyFrom(this.diffuseColor),this.bindOnlyWorldMatrix(c),this._effect.setMatrix("viewProjection",e.getTransformMatrix()),d.skeleton&&d.isVerticesDataPresent(a.VertexBuffer.MatricesIndicesKind)&&d.isVerticesDataPresent(a.VertexBuffer.MatricesWeightsKind)&&this._effect.setMatrices("mBones",d.skeleton.getTransformMatrices()),this.diffuseTexture&&a.StandardMaterial.DiffuseTextureEnabled&&(this._effect.setTexture("diffuseSampler",this.diffuseTexture),this._effect.setFloat2("vDiffuseInfos",this.diffuseTexture.coordinatesIndex,this.diffuseTexture.level),this._effect.setMatrix("diffuseMatrix",this.diffuseTexture.getTextureMatrix()),this._baseColor.copyFromFloats(1,1,1)),this.ambientTexture&&a.StandardMaterial.AmbientTextureEnabled&&(this._effect.setTexture("ambientSampler",this.ambientTexture),this._effect.setFloat2("vAmbientInfos",this.ambientTexture.coordinatesIndex,this.ambientTexture.level),this._effect.setMatrix("ambientMatrix",this.ambientTexture.getTextureMatrix())),this.opacityTexture&&a.StandardMaterial.OpacityTextureEnabled&&(this._effect.setTexture("opacitySampler",this.opacityTexture),this._effect.setFloat2("vOpacityInfos",this.opacityTexture.coordinatesIndex,this.opacityTexture.level),this._effect.setMatrix("opacityMatrix",this.opacityTexture.getTextureMatrix())),this.reflectionTexture&&a.StandardMaterial.ReflectionTextureEnabled&&(this.reflectionTexture.isCube?this._effect.setTexture("reflectionCubeSampler",this.reflectionTexture):this._effect.setTexture("reflection2DSampler",this.reflectionTexture),this._effect.setMatrix("reflectionMatrix",this.reflectionTexture.getReflectionTextureMatrix()),this._effect.setFloat3("vReflectionInfos",this.reflectionTexture.coordinatesMode,this.reflectionTexture.level,this.reflectionTexture.isCube?1:0)),this.emissiveTexture&&a.StandardMaterial.EmissiveTextureEnabled&&(this._effect.setTexture("emissiveSampler",this.emissiveTexture),this._effect.setFloat2("vEmissiveInfos",this.emissiveTexture.coordinatesIndex,this.emissiveTexture.level),this._effect.setMatrix("emissiveMatrix",this.emissiveTexture.getTextureMatrix())),this.specularTexture&&a.StandardMaterial.SpecularTextureEnabled&&(this._effect.setTexture("specularSampler",this.specularTexture),this._effect.setFloat2("vSpecularInfos",this.specularTexture.coordinatesIndex,this.specularTexture.level),this._effect.setMatrix("specularMatrix",this.specularTexture.getTextureMatrix())),this.bumpTexture&&e.getEngine().getCaps().standardDerivatives&&a.StandardMaterial.BumpTextureEnabled&&(this._effect.setTexture("bumpSampler",this.bumpTexture),this._effect.setFloat2("vBumpInfos",this.bumpTexture.coordinatesIndex,this.bumpTexture.level),this._effect.setMatrix("bumpMatrix",this.bumpTexture.getTextureMatrix())),e.ambientColor.multiplyToRef(this.ambientColor,this._globalAmbientColor),this._effect.setVector3("vEyePosition",e.activeCamera.position),this._effect.setColor3("vAmbientColor",this._globalAmbientColor),this._effect.setColor4("vDiffuseColor",this._baseColor,this.alpha*d.visibility),this._effect.setColor4("vSpecularColor",this.specularColor,this.specularPower),this._effect.setColor3("vEmissiveColor",this.emissiveColor),e.lightsEnabled)for(var f=0,g=0;g<e.lights.length;g++){var h=e.lights[g];if(h.isEnabled()&&(!d||-1===h.excludedMeshes.indexOf(d))){h instanceof a.PointLight?h.transferToEffect(this._effect,"vLightData"+f):h instanceof a.DirectionalLight?h.transferToEffect(this._effect,"vLightData"+f):h instanceof a.SpotLight?h.transferToEffect(this._effect,"vLightData"+f,"vLightDirection"+f):h instanceof a.HemisphericLight&&h.transferToEffect(this._effect,"vLightData"+f,"vLightGround"+f),h.diffuse.scaleToRef(h.intensity,this._scaledDiffuse),h.specular.scaleToRef(h.intensity,this._scaledSpecular),this._effect.setColor4("vLightDiffuse"+f,this._scaledDiffuse,h.range),this._effect.setColor3("vLightSpecular"+f,this._scaledSpecular);var i=h.getShadowGenerator();if(d.receiveShadows&&i&&(this._effect.setMatrix("lightMatrix"+f,i.getTransformMatrix()),this._effect.setTexture("shadowSampler"+f,i.getShadowMap()),this._effect.setFloat("darkness"+f,i.getDarkness())),f++,f==b)break}}if(e.clipPlane){var j=e.clipPlane;this._effect.setFloat4("vClipPlane",j.normal.x,j.normal.y,j.normal.z,j.d)}(e.fogMode!==a.Scene.FOGMODE_NONE||this.reflectionTexture)&&this._effect.setMatrix("view",e.getViewMatrix()),e.fogMode!==a.Scene.FOGMODE_NONE&&(this._effect.setFloat4("vFogInfos",e.fogMode,e.fogStart,e.fogEnd,e.fogDensity),this._effect.setColor3("vFogColor",e.fogColor))},d.prototype.getAnimatables=function(){var a=[];return this.diffuseTexture&&this.diffuseTexture.animations&&this.diffuseTexture.animations.length>0&&a.push(this.diffuseTexture),this.ambientTexture&&this.ambientTexture.animations&&this.ambientTexture.animations.length>0&&a.push(this.ambientTexture),this.opacityTexture&&this.opacityTexture.animations&&this.opacityTexture.animations.length>0&&a.push(this.opacityTexture),this.reflectionTexture&&this.reflectionTexture.animations&&this.reflectionTexture.animations.length>0&&a.push(this.reflectionTexture),this.emissiveTexture&&this.emissiveTexture.animations&&this.emissiveTexture.animations.length>0&&a.push(this.emissiveTexture),this.specularTexture&&this.specularTexture.animations&&this.specularTexture.animations.length>0&&a.push(this.specularTexture),this.bumpTexture&&this.bumpTexture.animations&&this.bumpTexture.animations.length>0&&a.push(this.bumpTexture),a},d.prototype.dispose=function(a){this.diffuseTexture&&this.diffuseTexture.dispose(),this.ambientTexture&&this.ambientTexture.dispose(),this.opacityTexture&&this.opacityTexture.dispose(),this.reflectionTexture&&this.reflectionTexture.dispose(),this.emissiveTexture&&this.emissiveTexture.dispose(),this.specularTexture&&this.specularTexture.dispose(),this.bumpTexture&&this.bumpTexture.dispose(),c.prototype.dispose.call(this,a)},d.prototype.clone=function(b){var c=new a.StandardMaterial(b,this.getScene());return c.checkReadyOnEveryCall=this.checkReadyOnEveryCall,c.alpha=this.alpha,c.wireframe=this.wireframe,c.backFaceCulling=this.backFaceCulling,this.diffuseTexture&&this.diffuseTexture.clone&&(c.diffuseTexture=this.diffuseTexture.clone()),this.ambientTexture&&this.ambientTexture.clone&&(c.ambientTexture=this.ambientTexture.clone()),this.opacityTexture&&this.opacityTexture.clone&&(c.opacityTexture=this.opacityTexture.clone()),this.reflectionTexture&&this.reflectionTexture.clone&&(c.reflectionTexture=this.reflectionTexture.clone()),this.emissiveTexture&&this.emissiveTexture.clone&&(c.emissiveTexture=this.emissiveTexture.clone()),this.specularTexture&&this.specularTexture.clone&&(c.specularTexture=this.specularTexture.clone()),this.bumpTexture&&this.bumpTexture.clone&&(c.bumpTexture=this.bumpTexture.clone()),c.ambientColor=this.ambientColor.clone(),c.diffuseColor=this.diffuseColor.clone(),c.specularColor=this.specularColor.clone(),c.specularPower=this.specularPower,c.emissiveColor=this.emissiveColor.clone(),c},d.DiffuseTextureEnabled=!0,d.AmbientTextureEnabled=!0,d.OpacityTextureEnabled=!0,d.ReflectionTextureEnabled=!0,d.EmissiveTextureEnabled=!0,d.SpecularTextureEnabled=!0,d.BumpTextureEnabled=!0,d}(a.Material);a.StandardMaterial=c}(BABYLON||(BABYLON={}));var __extends=this.__extends||function(a,b){function c(){this.constructor=a}for(var d in b)b.hasOwnProperty(d)&&(a[d]=b[d]);c.prototype=b.prototype,a.prototype=new c},BABYLON;!function(a){var b=function(a){function b(b,c){a.call(this,b,c,!0),this.subMaterials=new Array,c.multiMaterials.push(this)}return __extends(b,a),b.prototype.getSubMaterial=function(a){return 0>a||a>=this.subMaterials.length?this.getScene().defaultMaterial:this.subMaterials[a]},b.prototype.isReady=function(a){for(var b=0;b<this.subMaterials.length;b++){var c=this.subMaterials[b];if(c&&!this.subMaterials[b].isReady(a))return!1}return!0},b}(a.Material);a.MultiMaterial=b}(BABYLON||(BABYLON={}));var BABYLON;!function(a){var b=function(){function b(){}return Object.defineProperty(b,"ForceFullSceneLoadingForIncremental",{get:function(){return b._ForceFullSceneLoadingForIncremental},set:function(a){b._ForceFullSceneLoadingForIncremental=a},enumerable:!0,configurable:!0}),b._getPluginForFilename=function(a){for(var b=a.lastIndexOf("."),c=a.substring(b).toLowerCase(),d=0;d<this._registeredPlugins.length;d++){var e=this._registeredPlugins[d];if(-1!==e.extensions.indexOf(c))return e}return this._registeredPlugins[this._registeredPlugins.length-1]},b.RegisterPlugin=function(a){a.extensions=a.extensions.toLowerCase(),b._registeredPlugins.push(a)},b.ImportMesh=function(b,c,d,e,f,g,h){var i=this,j=function(){e.database=k;var j=i._getPluginForFilename(d),l=function(a){var g=[],i=[],k=[];return j.importMesh(b,e,a,c,g,i,k)?void(f&&(e.importedMeshesFiles.push(c+d),f(g,i,k))):void(h&&h(e))};return d.substr&&"data:"===d.substr(0,5)?void l(d.substr(5)):void a.Tools.LoadFile(c+d,function(a){l(a)},g,k)},k=new a.Database(c+d,j)},b.Load=function(b,c,d,e,f,g){var h,i=this._getPluginForFilename(c.name||c),j=function(c){var f=new a.Scene(d);return f.database=h,i.load(f,c,b)?void(e&&e(f)):void(g&&g(f))},k=function(){a.Tools.LoadFile(b+c,j,f,h)};return c.substr&&"data:"===c.substr(0,5)?void j(c.substr(5)):void(-1===b.indexOf("file:")?h=new a.Database(b+c,k):a.Tools.ReadFile(c,j,f))},b._ForceFullSceneLoadingForIncremental=!1,b._registeredPlugins=new Array,b}();a.SceneLoader=b}(BABYLON||(BABYLON={}));var BABYLON;!function(a){!function(){var b=function(b,c,d){var e=new a.CubeTexture(b+c.name,d);return e.name=c.name,e.hasAlpha=c.hasAlpha,e.level=c.level,e.coordinatesMode=c.coordinatesMode,e},c=function(c,d,e){if(!d.name&&!d.isRenderTarget)return null;if(d.isCube)return b(c,d,e);var f;if(d.mirrorPlane?(f=new a.MirrorTexture(d.name,d.renderTargetSize,e),f._waitingRenderList=d.renderList,f.mirrorPlane=a.Plane.FromArray(d.mirrorPlane)):d.isRenderTarget?(f=new a.RenderTargetTexture(d.name,d.renderTargetSize,e),f._waitingRenderList=d.renderList):f=new a.Texture(c+d.name,e),f.name=d.name,f.hasAlpha=d.hasAlpha,f.getAlphaFromRGB=d.getAlphaFromRGB,f.level=d.level,f.coordinatesIndex=d.coordinatesIndex,f.coordinatesMode=d.coordinatesMode,f.uOffset=d.uOffset,f.vOffset=d.vOffset,f.uScale=d.uScale,f.vScale=d.vScale,f.uAng=d.uAng,f.vAng=d.vAng,f.wAng=d.wAng,f.wrapU=d.wrapU,f.wrapV=d.wrapV,d.animations)for(var g=0;g<d.animations.length;g++){var h=d.animations[g];f.animations.push(k(h))}return f},d=function(b,c){for(var d=new a.Skeleton(b.name,b.id,c),e=0;e<b.bones.length;e++){var f=b.bones[e],g=null;f.parentBoneIndex>-1&&(g=d.bones[f.parentBoneIndex]);var h=new a.Bone(f.name,d,g,a.Matrix.FromArray(f.matrix));f.animation&&h.animations.push(k(f.animation))}return d},e=function(b,d,e){var f;return f=new a.StandardMaterial(b.name,d),f.ambientColor=a.Color3.FromArray(b.ambient),f.diffuseColor=a.Color3.FromArray(b.diffuse),f.specularColor=a.Color3.FromArray(b.specular),f.specularPower=b.specularPower,f.emissiveColor=a.Color3.FromArray(b.emissive),f.alpha=b.alpha,f.id=b.id,a.Tags.AddTagsTo(f,b.tags),f.backFaceCulling=b.backFaceCulling,f.wireframe=b.wireframe,b.diffuseTexture&&(f.diffuseTexture=c(e,b.diffuseTexture,d)),b.ambientTexture&&(f.ambientTexture=c(e,b.ambientTexture,d)),b.opacityTexture&&(f.opacityTexture=c(e,b.opacityTexture,d)),b.reflectionTexture&&(f.reflectionTexture=c(e,b.reflectionTexture,d)),b.emissiveTexture&&(f.emissiveTexture=c(e,b.emissiveTexture,d)),b.specularTexture&&(f.specularTexture=c(e,b.specularTexture,d)),b.bumpTexture&&(f.bumpTexture=c(e,b.bumpTexture,d)),f},f=function(a,b,c,d){for(var f=0;f<b.materials.length;f++){var g=b.materials[f];if(g.id===a)return e(g,c,d)}return null},g=function(b,c){var d=new a.MultiMaterial(b.name,c);d.id=b.id,a.Tags.AddTagsTo(d,b.tags);for(var e=0;e<b.materials.length;e++){var f=b.materials[e];d.subMaterials.push(f?c.getMaterialByID(f):null)}return d},h=function(b,c,d){var e=c.getLastEntryByID(b.emitterId),f=new a.LensFlareSystem("lensFlareSystem#"+b.emitterId,e,c);f.borderLimit=b.borderLimit;for(var g=0;g<b.flares.length;g++){var h=b.flares[g];new a.LensFlare(h.size,h.position,a.Color3.FromArray(h.color),d+h.textureName,f)}return f},i=function(b,c,d){var e=c.getLastMeshByID(b.emitterId),f=new a.ParticleSystem("particles#"+e.name,b.capacity,c);return b.textureName&&(f.particleTexture=new a.Texture(d+b.textureName,c),f.particleTexture.name=b.textureName),f.minAngularSpeed=b.minAngularSpeed,f.maxAngularSpeed=b.maxAngularSpeed,f.minSize=b.minSize,f.maxSize=b.maxSize,f.minLifeTime=b.minLifeTime,f.maxLifeTime=b.maxLifeTime,f.emitter=e,f.emitRate=b.emitRate,f.minEmitBox=a.Vector3.FromArray(b.minEmitBox),f.maxEmitBox=a.Vector3.FromArray(b.maxEmitBox),f.gravity=a.Vector3.FromArray(b.gravity),f.direction1=a.Vector3.FromArray(b.direction1),f.direction2=a.Vector3.FromArray(b.direction2),f.color1=a.Color4.FromArray(b.color1),f.color2=a.Color4.FromArray(b.color2),f.colorDead=a.Color4.FromArray(b.colorDead),f.updateSpeed=b.updateSpeed,f.targetStopDuration=b.targetStopFrame,f.textureMask=a.Color4.FromArray(b.textureMask),f.blendMode=b.blendMode,f.start(),f},j=function(b,c){for(var d=c.getLightByID(b.lightId),e=new a.ShadowGenerator(b.mapSize,d),f=0;f<b.renderList.length;f++){var g=c.getMeshByID(b.renderList[f]);e.getShadowMap().renderList.push(g)}return b.usePoissonSampling?e.usePoissonSampling=!0:e.useVarianceShadowMap=b.useVarianceShadowMap,e},k=function(b){for(var c=new a.Animation(b.name,b.property,b.framePerSecond,b.dataType,b.loopBehavior),d=b.dataType,e=[],f=0;f<b.keys.length;f++){var g,h=b.keys[f];switch(d){case a.Animation.ANIMATIONTYPE_FLOAT:g=h.values[0];break;case a.Animation.ANIMATIONTYPE_QUATERNION:g=a.Quaternion.FromArray(h.values);break;case a.Animation.ANIMATIONTYPE_MATRIX:g=a.Matrix.FromArray(h.values);break;case a.Animation.ANIMATIONTYPE_VECTOR3:default:g=a.Vector3.FromArray(h.values)}e.push({frame:h.frame,value:g})}return c.setKeys(e),c},l=function(b,c){var d;switch(b.type){case 0:d=new a.PointLight(b.name,a.Vector3.FromArray(b.position),c);break;case 1:d=new a.DirectionalLight(b.name,a.Vector3.FromArray(b.direction),c),d.position=a.Vector3.FromArray(b.position);break;case 2:d=new a.SpotLight(b.name,a.Vector3.FromArray(b.position),a.Vector3.FromArray(b.direction),b.angle,b.exponent,c);break;case 3:d=new a.HemisphericLight(b.name,a.Vector3.FromArray(b.direction),c),d.groundColor=a.Color3.FromArray(b.groundColor)}if(d.id=b.id,a.Tags.AddTagsTo(d,b.tags),void 0!==b.intensity&&(d.intensity=b.intensity),b.range&&(d.range=b.range),d.diffuse=a.Color3.FromArray(b.diffuse),d.specular=a.Color3.FromArray(b.specular),b.excludedMeshesIds&&(d._excludedMeshesIds=b.excludedMeshesIds),b.animations)for(var e=0;e<b.animations.length;e++){var f=b.animations[e];
d.animations.push(k(f))}b.autoAnimate&&c.beginAnimation(d,b.autoAnimateFrom,b.autoAnimateTo,b.autoAnimateLoop,1)},m=function(b,c){var d=new a.FreeCamera(b.name,a.Vector3.FromArray(b.position),c);if(d.id=b.id,a.Tags.AddTagsTo(d,b.tags),b.parentId&&(d._waitingParentId=b.parentId),b.target?d.setTarget(a.Vector3.FromArray(b.target)):d.rotation=a.Vector3.FromArray(b.rotation),b.lockedTargetId&&(d._waitingLockedTargetId=b.lockedTargetId),d.fov=b.fov,d.minZ=b.minZ,d.maxZ=b.maxZ,d.speed=b.speed,d.inertia=b.inertia,d.checkCollisions=b.checkCollisions,d.applyGravity=b.applyGravity,b.ellipsoid&&(d.ellipsoid=a.Vector3.FromArray(b.ellipsoid)),b.animations)for(var e=0;e<b.animations.length;e++){var f=b.animations[e];d.animations.push(k(f))}return b.autoAnimate&&c.beginAnimation(d,b.autoAnimateFrom,b.autoAnimateTo,b.autoAnimateLoop,1),d.layerMask=b.layerMask&&!isNaN(b.layerMask)?Math.abs(parseInt(b.layerMask)):4294967295,d},n=function(a,b){var c=a.id;return b.getGeometryByID(c)},o=function(b,c){if(n(b,c))return null;var d=new a.Geometry.Primitives.Box(b.id,c,b.size,b.canBeRegenerated,null);return a.Tags.AddTagsTo(d,b.tags),c.pushGeometry(d,!0),d},p=function(b,c){if(n(b,c))return null;var d=new a.Geometry.Primitives.Sphere(b.id,c,b.segments,b.diameter,b.canBeRegenerated,null);return a.Tags.AddTagsTo(d,b.tags),c.pushGeometry(d,!0),d},q=function(b,c){if(n(b,c))return null;var d=new a.Geometry.Primitives.Cylinder(b.id,c,b.height,b.diameterTop,b.diameterBottom,b.tessellation,b.subdivisions,b.canBeRegenerated,null);return a.Tags.AddTagsTo(d,b.tags),c.pushGeometry(d,!0),d},r=function(b,c){if(n(b,c))return null;var d=new a.Geometry.Primitives.Torus(b.id,c,b.diameter,b.thickness,b.tessellation,b.canBeRegenerated,null);return a.Tags.AddTagsTo(d,b.tags),c.pushGeometry(d,!0),d},s=function(b,c){if(n(b,c))return null;var d=new a.Geometry.Primitives.Ground(b.id,c,b.width,b.height,b.subdivisions,b.canBeRegenerated,null);return a.Tags.AddTagsTo(d,b.tags),c.pushGeometry(d,!0),d},t=function(b,c){if(n(b,c))return null;var d=new a.Geometry.Primitives.Plane(b.id,c,b.size,b.canBeRegenerated,null);return a.Tags.AddTagsTo(d,b.tags),c.pushGeometry(d,!0),d},u=function(b,c){if(n(b,c))return null;var d=new a.Geometry.Primitives.TorusKnot(b.id,c,b.radius,b.tube,b.radialSegments,b.tubularSegments,b.p,b.q,b.canBeRegenerated,null);return a.Tags.AddTagsTo(d,b.tags),c.pushGeometry(d,!0),d},v=function(b,c,d){if(n(b,c))return null;var e=new a.Geometry(b.id,c);return a.Tags.AddTagsTo(e,b.tags),b.delayLoadingFile?(e.delayLoadState=a.Engine.DELAYLOADSTATE_NOTLOADED,e.delayLoadingFile=d+b.delayLoadingFile,e._boundingInfo=new a.BoundingInfo(a.Vector3.FromArray(b.boundingBoxMinimum),a.Vector3.FromArray(b.boundingBoxMaximum)),e._delayInfo=[],b.hasUVs&&e._delayInfo.push(a.VertexBuffer.UVKind),b.hasUVs2&&e._delayInfo.push(a.VertexBuffer.UV2Kind),b.hasColors&&e._delayInfo.push(a.VertexBuffer.ColorKind),b.hasMatricesIndices&&e._delayInfo.push(a.VertexBuffer.MatricesIndicesKind),b.hasMatricesWeights&&e._delayInfo.push(a.VertexBuffer.MatricesWeightsKind),e._delayLoadingFunction=y):y(b,e),c.pushGeometry(e,!0),e},w=function(b,c,d){var e=new a.Mesh(b.name,c);if(e.id=b.id,a.Tags.AddTagsTo(e,b.tags),e.position=a.Vector3.FromArray(b.position),b.rotationQuaternion?e.rotationQuaternion=a.Quaternion.FromArray(b.rotationQuaternion):b.rotation&&(e.rotation=a.Vector3.FromArray(b.rotation)),e.scaling=a.Vector3.FromArray(b.scaling),b.localMatrix?e.setPivotMatrix(a.Matrix.FromArray(b.localMatrix)):b.pivotMatrix&&e.setPivotMatrix(a.Matrix.FromArray(b.pivotMatrix)),e.setEnabled(b.isEnabled),e.isVisible=b.isVisible,e.infiniteDistance=b.infiniteDistance,e.showBoundingBox=b.showBoundingBox,e.showSubMeshesBoundingBox=b.showSubMeshesBoundingBox,void 0!==b.pickable&&(e.isPickable=b.pickable),e.receiveShadows=b.receiveShadows,e.billboardMode=b.billboardMode,void 0!==b.visibility&&(e.visibility=b.visibility),e.checkCollisions=b.checkCollisions,e._shouldGenerateFlatShading=b.useFlatShading,b.parentId&&(e.parent=c.getLastEntryByID(b.parentId)),b.delayLoadingFile?(e.delayLoadState=a.Engine.DELAYLOADSTATE_NOTLOADED,e.delayLoadingFile=d+b.delayLoadingFile,e._boundingInfo=new a.BoundingInfo(a.Vector3.FromArray(b.boundingBoxMinimum),a.Vector3.FromArray(b.boundingBoxMaximum)),e._delayInfo=[],b.hasUVs&&e._delayInfo.push(a.VertexBuffer.UVKind),b.hasUVs2&&e._delayInfo.push(a.VertexBuffer.UV2Kind),b.hasColors&&e._delayInfo.push(a.VertexBuffer.ColorKind),b.hasMatricesIndices&&e._delayInfo.push(a.VertexBuffer.MatricesIndicesKind),b.hasMatricesWeights&&e._delayInfo.push(a.VertexBuffer.MatricesWeightsKind),e._delayLoadingFunction=z,a.SceneLoader.ForceFullSceneLoadingForIncremental&&e._checkDelayState()):z(b,e),b.materialId?e.setMaterialByID(b.materialId):e.material=null,b.skeletonId>-1&&(e.skeleton=c.getLastSkeletonByID(b.skeletonId)),b.physicsImpostor&&(c.isPhysicsEnabled()||c.enablePhysics(),e.setPhysicsState({impostor:b.physicsImpostor,mass:b.physicsMass,friction:b.physicsFriction,restitution:b.physicsRestitution})),b.animations)for(var f=0;f<b.animations.length;f++){var g=b.animations[f];e.animations.push(k(g))}if(b.autoAnimate&&c.beginAnimation(e,b.autoAnimateFrom,b.autoAnimateTo,b.autoAnimateLoop,1),e.layerMask=b.layerMask&&!isNaN(b.layerMask)?Math.abs(parseInt(b.layerMask)):4294967295,b.instances)for(var h=0;h<b.instances.length;h++){var i=b.instances[h],j=e.createInstance(i.name);if(a.Tags.AddTagsTo(j,i.tags),j.position=a.Vector3.FromArray(i.position),i.rotationQuaternion?j.rotationQuaternion=a.Quaternion.FromArray(i.rotationQuaternion):i.rotation&&(j.rotation=a.Vector3.FromArray(i.rotation)),j.scaling=a.Vector3.FromArray(i.scaling),j.checkCollisions=e.checkCollisions,b.animations)for(f=0;f<b.animations.length;f++)g=b.animations[f],j.animations.push(k(g))}return e},x=function(a,b,c){b=b instanceof Array?b:[b];for(var d in b)if(a.name===b[d])return c.push(a.id),!0;return a.parentId&&-1!==c.indexOf(a.parentId)?(c.push(a.id),!0):!1},y=function(b,c){var d=new a.VertexData,e=b.positions;e&&d.set(e,a.VertexBuffer.PositionKind);var f=b.normals;f&&d.set(f,a.VertexBuffer.NormalKind);var g=b.uvs;g&&d.set(g,a.VertexBuffer.UVKind);var h=b.uv2s;h&&d.set(h,a.VertexBuffer.UV2Kind);var i=b.colors;i&&d.set(i,a.VertexBuffer.ColorKind);var j=b.matricesIndices;j&&d.set(j,a.VertexBuffer.MatricesIndicesKind);var k=b.matricesWeights;k&&d.set(k,a.VertexBuffer.MatricesWeightsKind);var l=b.indices;l&&(d.indices=l),c.setAllVerticesData(d,b.updatable)},z=function(b,c){var d=c.getScene(),e=b.geometryId;if(e){var f=d.getGeometryByID(e);f&&f.applyToMesh(c)}else if(b.positions&&b.normals&&b.indices){if(c.setVerticesData(a.VertexBuffer.PositionKind,b.positions,!1),c.setVerticesData(a.VertexBuffer.NormalKind,b.normals,!1),b.uvs&&c.setVerticesData(a.VertexBuffer.UVKind,b.uvs,!1),b.uvs2&&c.setVerticesData(a.VertexBuffer.UV2Kind,b.uvs2,!1),b.colors&&c.setVerticesData(a.VertexBuffer.ColorKind,b.colors,!1),b.matricesIndices)if(b.matricesIndices._isExpanded)delete b.matricesIndices._isExpanded,c.setVerticesData(a.VertexBuffer.MatricesIndicesKind,b.matricesIndices,!1);else{for(var g=[],h=0;h<b.matricesIndices.length;h++){var i=b.matricesIndices[h];g.push(255&i),g.push((65280&i)>>8),g.push((16711680&i)>>16),g.push(i>>24)}c.setVerticesData(a.VertexBuffer.MatricesIndicesKind,g,!1)}b.matricesWeights&&c.setVerticesData(a.VertexBuffer.MatricesWeightsKind,b.matricesWeights,!1),c.setIndices(b.indices)}if(b.subMeshes){c.subMeshes=[];for(var j=0;j<b.subMeshes.length;j++){var k=b.subMeshes[j];new a.SubMesh(k.materialIndex,k.verticesStart,k.verticesCount,k.indexStart,k.indexCount,c)}}c._shouldGenerateFlatShading&&(c.convertToFlatShadedMesh(),delete c._shouldGenerateFlatShading),c.computeWorldMatrix(!0),d._selectionOctree&&d._selectionOctree.addMesh(c)};a.SceneLoader.RegisterPlugin({extensions:".babylon",importMesh:function(a,b,c,e,h,j,k){for(var l=JSON.parse(c),m=[],n=[],o=[],p=0;p<l.meshes.length;p++){var q=l.meshes[p];if(!a||x(q,a,o)){if(a instanceof Array&&delete a[a.indexOf(q.name)],q.materialId){var r=-1!==n.indexOf(q.materialId);if(!r)for(var s=0;s<l.multiMaterials.length;s++){var t=l.multiMaterials[s];if(t.id==q.materialId){for(var u=0;u<t.materials.length;u++){var v=t.materials[u];n.push(v),f(v,l,b,e)}n.push(t.id),g(t,b),r=!0;break}}r||(n.push(q.materialId),f(q.materialId,l,b,e))}if(q.skeletonId>-1&&b.skeletons){var y=m.indexOf(q.skeletonId)>-1;if(!y)for(var z=0;z<l.skeletons.length;z++){var A=l.skeletons[z];A.id===q.skeletonId&&(k.push(d(A,b)),m.push(A.id))}}var B=w(q,b,e);h.push(B)}}if(l.particleSystems)for(p=0;p<l.particleSystems.length;p++){var C=l.particleSystems[p];-1!==o.indexOf(C.emitterId)&&j.push(i(C,b,e))}return!0},load:function(b,c,f){var k=JSON.parse(c);b.useDelayedTextureLoading=k.useDelayedTextureLoading&&!a.SceneLoader.ForceFullSceneLoadingForIncremental,b.autoClear=k.autoClear,b.clearColor=a.Color3.FromArray(k.clearColor),b.ambientColor=a.Color3.FromArray(k.ambientColor),b.gravity=a.Vector3.FromArray(k.gravity),k.fogMode&&0!==k.fogMode&&(b.fogMode=k.fogMode,b.fogColor=a.Color3.FromArray(k.fogColor),b.fogStart=k.fogStart,b.fogEnd=k.fogEnd,b.fogDensity=k.fogDensity);for(var n=0;n<k.lights.length;n++){var x=k.lights[n];l(x,b)}for(n=0;n<k.cameras.length;n++){var y=k.cameras[n];m(y,b)}if(k.activeCameraID&&b.setActiveCameraByID(k.activeCameraID),k.materials)for(n=0;n<k.materials.length;n++){var z=k.materials[n];e(z,b,f)}if(k.multiMaterials)for(n=0;n<k.multiMaterials.length;n++){var A=k.multiMaterials[n];g(A,b)}if(k.skeletons)for(n=0;n<k.skeletons.length;n++){var B=k.skeletons[n];d(B,b)}var C=k.geometries;if(C){var D=C.boxes;if(D)for(n=0;n<D.length;n++){var E=D[n];o(E,b)}var F=C.spheres;if(F)for(n=0;n<F.length;n++){var G=F[n];p(G,b)}var H=C.cylinders;if(H)for(n=0;n<H.length;n++){var I=H[n];q(I,b)}var J=C.toruses;if(J)for(n=0;n<J.length;n++){var K=J[n];r(K,b)}var L=C.grounds;if(L)for(n=0;n<L.length;n++){var M=L[n];s(M,b)}var N=C.planes;if(N)for(n=0;n<N.length;n++){var O=N[n];t(O,b)}var P=C.torusKnots;if(P)for(n=0;n<P.length;n++){var Q=P[n];u(Q,b)}var R=C.vertexData;if(R)for(n=0;n<R.length;n++){var S=R[n];v(S,b,f)}}for(n=0;n<k.meshes.length;n++){var T=k.meshes[n];w(T,b,f)}for(n=0;n<b.cameras.length;n++){var U=b.cameras[n];if(U._waitingParentId&&(U.parent=b.getLastEntryByID(U._waitingParentId),delete U._waitingParentId),U instanceof a.FreeCamera){var V=U;V._waitingLockedTargetId&&(V.lockedTarget=b.getLastEntryByID(V._waitingLockedTargetId),delete V._waitingLockedTargetId)}}if(k.particleSystems)for(n=0;n<k.particleSystems.length;n++){var W=k.particleSystems[n];i(W,b,f)}if(k.lensFlareSystems)for(n=0;n<k.lensFlareSystems.length;n++){var X=k.lensFlareSystems[n];h(X,b,f)}if(k.shadowGenerators)for(n=0;n<k.shadowGenerators.length;n++){var Y=k.shadowGenerators[n];j(Y,b)}return!0}})}(a.Internals||(a.Internals={})),a.Internals}(BABYLON||(BABYLON={}));var BABYLON;!function(a){var b=function(){function b(b,c,d,e,f,g){this.name=b,this.cellSize=e,this.sprites=new Array,this.renderingGroupId=0,this._vertexDeclaration=[3,4,4,4],this._vertexStrideSize=60,this._capacity=d,this._spriteTexture=new a.Texture(c,f,!0,!1),this._spriteTexture.wrapU=a.Texture.CLAMP_ADDRESSMODE,this._spriteTexture.wrapV=a.Texture.CLAMP_ADDRESSMODE,this._epsilon=void 0===g?.01:g,this._scene=f,this._scene.spriteManagers.push(this),this._vertexDeclaration=[3,4,4,4],this._vertexStrideSize=60,this._vertexBuffer=f.getEngine().createDynamicVertexBuffer(d*this._vertexStrideSize*4);for(var h=[],i=0,j=0;d>j;j++)h.push(i),h.push(i+1),h.push(i+2),h.push(i),h.push(i+2),h.push(i+3),i+=4;this._indexBuffer=f.getEngine().createIndexBuffer(h),this._vertices=new Float32Array(d*this._vertexStrideSize),this._effectBase=this._scene.getEngine().createEffect("sprites",["position","options","cellInfo","color"],["view","projection","textureInfos","alphaTest"],["diffuseSampler"],""),this._effectFog=this._scene.getEngine().createEffect("sprites",["position","options","cellInfo","color"],["view","projection","textureInfos","alphaTest","vFogInfos","vFogColor"],["diffuseSampler"],"#define FOG")}return b.prototype._appendSpriteVertex=function(a,b,c,d,e){var f=15*a;0==c?c=this._epsilon:1==c&&(c=1-this._epsilon),0==d?d=this._epsilon:1==d&&(d=1-this._epsilon),this._vertices[f]=b.position.x,this._vertices[f+1]=b.position.y,this._vertices[f+2]=b.position.z,this._vertices[f+3]=b.angle,this._vertices[f+4]=b.size,this._vertices[f+5]=c,this._vertices[f+6]=d,this._vertices[f+7]=b.invertU?1:0,this._vertices[f+8]=b.invertV?1:0;var g=b.cellIndex/e>>0;this._vertices[f+9]=b.cellIndex-g*e,this._vertices[f+10]=g,this._vertices[f+11]=b.color.r,this._vertices[f+12]=b.color.g,this._vertices[f+13]=b.color.b,this._vertices[f+14]=b.color.a},b.prototype.render=function(){if(this._effectBase.isReady()&&this._effectFog.isReady()&&this._spriteTexture&&this._spriteTexture.isReady()){for(var b=this._scene.getEngine(),c=this._spriteTexture.getBaseSize(),d=a.Tools.GetDeltaTime(),e=Math.min(this._capacity,this.sprites.length),f=c.width/this.cellSize,g=0,h=0;e>h;h++){var i=this.sprites[h];i&&(i._animate(d),this._appendSpriteVertex(g++,i,0,0,f),this._appendSpriteVertex(g++,i,1,0,f),this._appendSpriteVertex(g++,i,1,1,f),this._appendSpriteVertex(g++,i,0,1,f))}b.updateDynamicVertexBuffer(this._vertexBuffer,this._vertices,e*this._vertexStrideSize);var j=this._effectBase;this._scene.fogMode!==a.Scene.FOGMODE_NONE&&(j=this._effectFog),b.enableEffect(j);var k=this._scene.getViewMatrix();j.setTexture("diffuseSampler",this._spriteTexture),j.setMatrix("view",k),j.setMatrix("projection",this._scene.getProjectionMatrix()),j.setFloat2("textureInfos",this.cellSize/c.width,this.cellSize/c.height),this._scene.fogMode!==a.Scene.FOGMODE_NONE&&(j.setFloat4("vFogInfos",this._scene.fogMode,this._scene.fogStart,this._scene.fogEnd,this._scene.fogDensity),j.setColor3("vFogColor",this._scene.fogColor)),b.bindBuffers(this._vertexBuffer,this._indexBuffer,this._vertexDeclaration,this._vertexStrideSize,j),j.setBool("alphaTest",!0),b.setColorWrite(!1),b.draw(!0,0,6*e),b.setColorWrite(!0),j.setBool("alphaTest",!1),b.setAlphaMode(a.Engine.ALPHA_COMBINE),b.draw(!0,0,6*e),b.setAlphaMode(a.Engine.ALPHA_DISABLE)}},b.prototype.dispose=function(){this._vertexBuffer&&(this._scene.getEngine()._releaseBuffer(this._vertexBuffer),this._vertexBuffer=null),this._indexBuffer&&(this._scene.getEngine()._releaseBuffer(this._indexBuffer),this._indexBuffer=null),this._spriteTexture&&(this._spriteTexture.dispose(),this._spriteTexture=null);var a=this._scene.spriteManagers.indexOf(this);this._scene.spriteManagers.splice(a,1),this.onDispose&&this.onDispose()},b}();a.SpriteManager=b}(BABYLON||(BABYLON={}));var BABYLON;!function(a){var b=function(){function b(b,c){this.name=b,this.color=new a.Color4(1,1,1,1),this.size=1,this.angle=0,this.cellIndex=0,this.invertU=0,this.invertV=0,this.animations=new Array,this._animationStarted=!1,this._loopAnimation=!1,this._fromIndex=0,this._toIndex=0,this._delay=0,this._direction=1,this._frameCount=0,this._time=0,this._manager=c,this._manager.sprites.push(this),this.position=a.Vector3.Zero(),this._colliderMesh=a.Mesh.CreatePlane("_sprite_"+b,c.cellSize/4,c._scene),this._colliderMesh.material=new a.StandardMaterial("_",c._scene),this._colliderMesh.material.backFaceCulling=!1,this._colliderMesh.sprite=this,this._colliderMesh.isVisible=!1,this._colliderMesh.position=this.position,this._colliderMesh.rotation=a.Vector3.Zero()}return b.prototype.playAnimation=function(a,b,c,d){this._fromIndex=a,this._toIndex=b,this._loopAnimation=c,this._delay=d,this._animationStarted=!0,this._direction=b>a?1:-1,this.cellIndex=a,this._time=0},b.prototype.stopAnimation=function(){this._animationStarted=!1},b.prototype.updateCollider=function(){var a=this._manager._scene.activeCamera.position,b=a.subtract(this.position).normalize();this._colliderMesh.position=this.position,this._colliderMesh.rotation.x=Math.acos(b.y)+Math.PI/2,this._colliderMesh.rotation.y=Math.atan2(b.x,b.z),this._colliderMesh.rotation.z=0},b.prototype._animate=function(a){this._animationStarted&&(this._time+=a,this._time>this._delay&&(this._time=this._time%this._delay,this.cellIndex+=this._direction,this.cellIndex==this._toIndex&&(this._loopAnimation?this.cellIndex=this._fromIndex:(this._animationStarted=!1,this.disposeWhenFinishedAnimating&&this.dispose()))))},b.prototype.dispose=function(){for(var a=0;a<this._manager.sprites.length;a++)this._manager.sprites[a]==this&&this._manager.sprites.splice(a,1);this._colliderMesh.dispose()},b}();a.Sprite=b}(BABYLON||(BABYLON={}));var BABYLON;!function(a){var b=function(){function b(b,c,d,e,f){this.name=b,this._vertexDeclaration=[2],this._vertexStrideSize=8,this.texture=c?new a.Texture(c,d,!0):null,this.isBackground=void 0===e?!0:e,this.color=void 0===f?new a.Color4(1,1,1,1):f,this._scene=d,this._scene.layers.push(this);var g=[];g.push(1,1),g.push(-1,1),g.push(-1,-1),g.push(1,-1),this._vertexBuffer=d.getEngine().createVertexBuffer(g);var h=[];h.push(0),h.push(1),h.push(2),h.push(0),h.push(2),h.push(3),this._indexBuffer=d.getEngine().createIndexBuffer(h),this._effect=this._scene.getEngine().createEffect("layer",["position"],["textureMatrix","color"],["textureSampler"],"")}return b.prototype.render=function(){if(this._effect.isReady()&&this.texture&&this.texture.isReady()){var b=this._scene.getEngine();b.enableEffect(this._effect),b.setState(!1),this._effect.setTexture("textureSampler",this.texture),this._effect.setMatrix("textureMatrix",this.texture.getTextureMatrix()),this._effect.setFloat4("color",this.color.r,this.color.g,this.color.b,this.color.a),b.bindBuffers(this._vertexBuffer,this._indexBuffer,this._vertexDeclaration,this._vertexStrideSize,this._effect),b.setAlphaMode(a.Engine.ALPHA_COMBINE),b.draw(!0,0,6),b.setAlphaMode(a.Engine.ALPHA_DISABLE)}},b.prototype.dispose=function(){this._vertexBuffer&&(this._scene.getEngine()._releaseBuffer(this._vertexBuffer),this._vertexBuffer=null),this._indexBuffer&&(this._scene.getEngine()._releaseBuffer(this._indexBuffer),this._indexBuffer=null),this.texture&&(this.texture.dispose(),this.texture=null);var a=this._scene.layers.indexOf(this);this._scene.layers.splice(a,1),this.onDispose&&this.onDispose()},b}();a.Layer=b}(BABYLON||(BABYLON={}));var BABYLON;!function(a){var b=function(){function b(){this.position=a.Vector3.Zero(),this.direction=a.Vector3.Zero(),this.color=new a.Color4(0,0,0,0),this.colorStep=new a.Color4(0,0,0,0),this.lifeTime=1,this.age=0,this.size=0,this.angle=0,this.angularSpeed=0}return b}();a.Particle=b}(BABYLON||(BABYLON={}));var BABYLON;!function(a){var b=function(a,b){if(a==b)return a;var c=Math.random();return c*(b-a)+a},c=function(){function c(c,d,e){var f=this;this.name=c,this.renderingGroupId=0,this.emitter=null,this.emitRate=10,this.manualEmitCount=-1,this.updateSpeed=.01,this.targetStopDuration=0,this.disposeOnStop=!1,this.minEmitPower=1,this.maxEmitPower=1,this.minLifeTime=1,this.maxLifeTime=1,this.minSize=1,this.maxSize=1,this.minAngularSpeed=0,this.maxAngularSpeed=0,this.blendMode=a.ParticleSystem.BLENDMODE_ONEONE,this.forceDepthWrite=!1,this.gravity=a.Vector3.Zero(),this.direction1=new a.Vector3(0,1,0),this.direction2=new a.Vector3(0,1,0),this.minEmitBox=new a.Vector3(-.5,-.5,-.5),this.maxEmitBox=new a.Vector3(.5,.5,.5),this.color1=new a.Color4(1,1,1,1),this.color2=new a.Color4(1,1,1,1),this.colorDead=new a.Color4(0,0,0,1),this.textureMask=new a.Color4(1,1,1,1),this.particles=new Array,this._vertexDeclaration=[3,4,4],this._vertexStrideSize=44,this._stockParticles=new Array,this._newPartsExcess=0,this._scaledColorStep=new a.Color4(0,0,0,0),this._colorDiff=new a.Color4(0,0,0,0),this._scaledDirection=a.Vector3.Zero(),this._scaledGravity=a.Vector3.Zero(),this._currentRenderId=-1,this._started=!1,this._stopped=!1,this._actualFrame=0,this.id=c,this._capacity=d,this._scene=e,e.particleSystems.push(this),this._vertexBuffer=e.getEngine().createDynamicVertexBuffer(d*this._vertexStrideSize*4);for(var g=[],h=0,i=0;d>i;i++)g.push(h),g.push(h+1),g.push(h+2),g.push(h),g.push(h+2),g.push(h+3),h+=4;this._indexBuffer=e.getEngine().createIndexBuffer(g),this._vertices=new Float32Array(d*this._vertexStrideSize),this.startDirectionFunction=function(c,d,e){var g=b(f.direction1.x,f.direction2.x),h=b(f.direction1.y,f.direction2.y),i=b(f.direction1.z,f.direction2.z);a.Vector3.TransformNormalFromFloatsToRef(g*c,h*c,i*c,d,e)},this.startPositionFunction=function(c,d){var e=b(f.minEmitBox.x,f.maxEmitBox.x),g=b(f.minEmitBox.y,f.maxEmitBox.y),h=b(f.minEmitBox.z,f.maxEmitBox.z);a.Vector3.TransformCoordinatesFromFloatsToRef(e,g,h,c,d)}}return c.prototype.getCapacity=function(){return this._capacity},c.prototype.isAlive=function(){return this._alive},c.prototype.isStarted=function(){return this._started},c.prototype.start=function(){this._started=!0,this._stopped=!1,this._actualFrame=0},c.prototype.stop=function(){this._stopped=!0},c.prototype._appendParticleVertex=function(a,b,c,d){var e=11*a;this._vertices[e]=b.position.x,this._vertices[e+1]=b.position.y,this._vertices[e+2]=b.position.z,this._vertices[e+3]=b.color.r,this._vertices[e+4]=b.color.g,this._vertices[e+5]=b.color.b,this._vertices[e+6]=b.color.a,this._vertices[e+7]=b.angle,this._vertices[e+8]=b.size,this._vertices[e+9]=c,this._vertices[e+10]=d},c.prototype._update=function(c){this._alive=this.particles.length>0;for(var d=0;d<this.particles.length;d++){var e=this.particles[d];e.age+=this._scaledUpdateSpeed,e.age>=e.lifeTime?(this._stockParticles.push(this.particles.splice(d,1)[0]),d--):(e.colorStep.scaleToRef(this._scaledUpdateSpeed,this._scaledColorStep),e.color.addInPlace(this._scaledColorStep),e.color.a<0&&(e.color.a=0),e.angle+=e.angularSpeed*this._scaledUpdateSpeed,e.direction.scaleToRef(this._scaledUpdateSpeed,this._scaledDirection),e.position.addInPlace(this._scaledDirection),this.gravity.scaleToRef(this._scaledUpdateSpeed,this._scaledGravity),e.direction.addInPlace(this._scaledGravity))}var f;for(f=this.emitter.position?this.emitter.getWorldMatrix():a.Matrix.Translation(this.emitter.x,this.emitter.y,this.emitter.z),d=0;c>d&&this.particles.length!=this._capacity;d++){0!==this._stockParticles.length?(e=this._stockParticles.pop(),e.age=0):e=new a.Particle,this.particles.push(e);var g=b(this.minEmitPower,this.maxEmitPower);this.startDirectionFunction(g,f,e.direction),e.lifeTime=b(this.minLifeTime,this.maxLifeTime),e.size=b(this.minSize,this.maxSize),e.angularSpeed=b(this.minAngularSpeed,this.maxAngularSpeed),this.startPositionFunction(f,e.position);var h=b(0,1);a.Color4.LerpToRef(this.color1,this.color2,h,e.color),this.colorDead.subtractToRef(e.color,this._colorDiff),this._colorDiff.scaleToRef(1/e.lifeTime,e.colorStep)}},c.prototype._getEffect=function(){var a=[];this._scene.clipPlane&&a.push("#define CLIPPLANE");var b=a.join("\n");return this._cachedDefines!=b&&(this._cachedDefines=b,this._effect=this._scene.getEngine().createEffect("particles",["position","color","options"],["invView","view","projection","vClipPlane","textureMask"],["diffuseSampler"],b)),this._effect},c.prototype.animate=function(){if(this._started){var a=this._getEffect();if(this.emitter&&a.isReady()&&this.particleTexture&&this.particleTexture.isReady()&&this._currentRenderId!==this._scene.getRenderId()){this._currentRenderId=this._scene.getRenderId(),this._scaledUpdateSpeed=this.updateSpeed*this._scene.getAnimationRatio();var b;this.manualEmitCount>-1?(b=this.manualEmitCount,this.manualEmitCount=0):b=this.emitRate;var c=b*this._scaledUpdateSpeed>>0;this._newPartsExcess+=b*this._scaledUpdateSpeed-c,this._newPartsExcess>1&&(c+=this._newPartsExcess>>0,this._newPartsExcess-=this._newPartsExcess>>0),this._alive=!1,this._stopped?c=0:(this._actualFrame+=this._scaledUpdateSpeed,this.targetStopDuration&&this._actualFrame>=this.targetStopDuration&&this.stop()),this._update(c),this._stopped&&(this._alive||(this._started=!1,this.disposeOnStop&&this._scene._toBeDisposed.push(this)));for(var d=0,e=0;e<this.particles.length;e++){var f=this.particles[e];this._appendParticleVertex(d++,f,0,0),this._appendParticleVertex(d++,f,1,0),this._appendParticleVertex(d++,f,1,1),this._appendParticleVertex(d++,f,0,1)}var g=this._scene.getEngine();g.updateDynamicVertexBuffer(this._vertexBuffer,this._vertices,this.particles.length*this._vertexStrideSize)}}},c.prototype.render=function(){var b=this._getEffect();if(!(this.emitter&&b.isReady()&&this.particleTexture&&this.particleTexture.isReady()&&this.particles.length))return 0;var c=this._scene.getEngine();c.enableEffect(b);var d=this._scene.getViewMatrix();if(b.setTexture("diffuseSampler",this.particleTexture),b.setMatrix("view",d),b.setMatrix("projection",this._scene.getProjectionMatrix()),b.setFloat4("textureMask",this.textureMask.r,this.textureMask.g,this.textureMask.b,this.textureMask.a),this._scene.clipPlane){var e=this._scene.clipPlane,f=d.clone();f.invert(),b.setMatrix("invView",f),b.setFloat4("vClipPlane",e.normal.x,e.normal.y,e.normal.z,e.d)}return c.bindBuffers(this._vertexBuffer,this._indexBuffer,this._vertexDeclaration,this._vertexStrideSize,b),c.setAlphaMode(this.blendMode===a.ParticleSystem.BLENDMODE_ONEONE?a.Engine.ALPHA_ADD:a.Engine.ALPHA_COMBINE),this.forceDepthWrite&&c.setDepthWrite(!0),c.draw(!0,0,6*this.particles.length),c.setAlphaMode(a.Engine.ALPHA_DISABLE),this.particles.length},c.prototype.dispose=function(){this._vertexBuffer&&(this._scene.getEngine()._releaseBuffer(this._vertexBuffer),this._vertexBuffer=null),this._indexBuffer&&(this._scene.getEngine()._releaseBuffer(this._indexBuffer),this._indexBuffer=null),this.particleTexture&&(this.particleTexture.dispose(),this.particleTexture=null);var a=this._scene.particleSystems.indexOf(this);this._scene.particleSystems.splice(a,1),this.onDispose&&this.onDispose()},c.prototype.clone=function(b,c){var d=new a.ParticleSystem(b,this._capacity,this._scene);return a.Tools.DeepCopy(this,d,["particles"],["_vertexDeclaration","_vertexStrideSize"]),void 0===c&&(c=this.emitter),d.emitter=c,this.particleTexture&&(d.particleTexture=new a.Texture(this.particleTexture.url,this._scene)),d.start(),d},c.BLENDMODE_ONEONE=0,c.BLENDMODE_STANDARD=1,c}();a.ParticleSystem=c}(BABYLON||(BABYLON={}));var BABYLON;!function(a){var b=function(){function b(a,c,d,e,f){this.name=a,this.targetProperty=c,this.framePerSecond=d,this.dataType=e,this.loopMode=f,this._offsetsCache={},this._highLimitsCache={},this._stopped=!1,this.targetPropertyPath=c.split("."),this.dataType=e,this.loopMode=void 0===f?b.ANIMATIONLOOPMODE_CYCLE:f}return b.prototype.isStopped=function(){return this._stopped},b.prototype.getKeys=function(){return this._keys},b.prototype.floatInterpolateFunction=function(a,b,c){return a+(b-a)*c},b.prototype.quaternionInterpolateFunction=function(b,c,d){return a.Quaternion.Slerp(b,c,d)},b.prototype.vector3InterpolateFunction=function(b,c,d){return a.Vector3.Lerp(b,c,d)},b.prototype.color3InterpolateFunction=function(b,c,d){return a.Color3.Lerp(b,c,d)},b.prototype.clone=function(){var a=new b(this.name,this.targetPropertyPath.join("."),this.framePerSecond,this.dataType,this.loopMode);return a.setKeys(this._keys),a},b.prototype.setKeys=function(a){this._keys=a.slice(0),this._offsetsCache={},this._highLimitsCache={}},b.prototype._interpolate=function(a,c,d,e,f){if(d===b.ANIMATIONLOOPMODE_CONSTANT&&c>0)return f.clone?f.clone():f;this.currentFrame=a;for(var g=0;g<this._keys.length;g++)if(this._keys[g+1].frame>=a){var h=this._keys[g].value,i=this._keys[g+1].value,j=(a-this._keys[g].frame)/(this._keys[g+1].frame-this._keys[g].frame);switch(this.dataType){case b.ANIMATIONTYPE_FLOAT:switch(d){case b.ANIMATIONLOOPMODE_CYCLE:case b.ANIMATIONLOOPMODE_CONSTANT:return this.floatInterpolateFunction(h,i,j);case b.ANIMATIONLOOPMODE_RELATIVE:return e*c+this.floatInterpolateFunction(h,i,j)}break;case b.ANIMATIONTYPE_QUATERNION:var k=null;switch(d){case b.ANIMATIONLOOPMODE_CYCLE:case b.ANIMATIONLOOPMODE_CONSTANT:k=this.quaternionInterpolateFunction(h,i,j);break;case b.ANIMATIONLOOPMODE_RELATIVE:k=this.quaternionInterpolateFunction(h,i,j).add(e.scale(c))}return k;case b.ANIMATIONTYPE_VECTOR3:switch(d){case b.ANIMATIONLOOPMODE_CYCLE:case b.ANIMATIONLOOPMODE_CONSTANT:return this.vector3InterpolateFunction(h,i,j);case b.ANIMATIONLOOPMODE_RELATIVE:return this.vector3InterpolateFunction(h,i,j).add(e.scale(c))}case b.ANIMATIONTYPE_COLOR3:switch(d){case b.ANIMATIONLOOPMODE_CYCLE:case b.ANIMATIONLOOPMODE_CONSTANT:return this.color3InterpolateFunction(h,i,j);case b.ANIMATIONLOOPMODE_RELATIVE:return this.color3InterpolateFunction(h,i,j).add(e.scale(c))}case b.ANIMATIONTYPE_MATRIX:switch(d){case b.ANIMATIONLOOPMODE_CYCLE:case b.ANIMATIONLOOPMODE_CONSTANT:case b.ANIMATIONLOOPMODE_RELATIVE:return h}}break}return this._keys[this._keys.length-1].value},b.prototype.animate=function(a,c,d,e,f){if(!this.targetPropertyPath||this.targetPropertyPath.length<1)return this._stopped=!0,!1;var g=!0;if(0!=this._keys[0].frame){var h={frame:0,value:this._keys[0].value};this._keys.splice(0,0,h)}(c<this._keys[0].frame||c>this._keys[this._keys.length-1].frame)&&(c=this._keys[0].frame),(d<this._keys[0].frame||d>this._keys[this._keys.length-1].frame)&&(d=this._keys[this._keys.length-1].frame);var i=d-c,j=a*this.framePerSecond*f/1e3;if(j>i&&!e)k=0,g=!1,l=this._keys[this._keys.length-1].value;else{var k=0,l=0;if(this.loopMode!=b.ANIMATIONLOOPMODE_CYCLE){var m=d.toString()+c.toString();if(!this._offsetsCache[m]){var n=this._interpolate(c,0,b.ANIMATIONLOOPMODE_CYCLE),o=this._interpolate(d,0,b.ANIMATIONLOOPMODE_CYCLE);switch(this.dataType){case b.ANIMATIONTYPE_FLOAT:this._offsetsCache[m]=o-n;break;case b.ANIMATIONTYPE_QUATERNION:this._offsetsCache[m]=o.subtract(n);break;case b.ANIMATIONTYPE_VECTOR3:this._offsetsCache[m]=o.subtract(n);case b.ANIMATIONTYPE_COLOR3:this._offsetsCache[m]=o.subtract(n)}this._highLimitsCache[m]=o}l=this._highLimitsCache[m],k=this._offsetsCache[m]}}var p=j/i>>0,q=g?c+j%i:d,r=this._interpolate(q,p,this.loopMode,k,l);if(this.targetPropertyPath.length>1){for(var s=this._target[this.targetPropertyPath[0]],t=1;t<this.targetPropertyPath.length-1;t++)s=s[this.targetPropertyPath[t]];s[this.targetPropertyPath[this.targetPropertyPath.length-1]]=r}else this._target[this.targetPropertyPath[0]]=r;return this._target.markAsDirty&&this._target.markAsDirty(this.targetProperty),g||(this._stopped=!0),g},Object.defineProperty(b,"ANIMATIONTYPE_FLOAT",{get:function(){return b._ANIMATIONTYPE_FLOAT},enumerable:!0,configurable:!0}),Object.defineProperty(b,"ANIMATIONTYPE_VECTOR3",{get:function(){return b._ANIMATIONTYPE_VECTOR3},enumerable:!0,configurable:!0}),Object.defineProperty(b,"ANIMATIONTYPE_QUATERNION",{get:function(){return b._ANIMATIONTYPE_QUATERNION},enumerable:!0,configurable:!0}),Object.defineProperty(b,"ANIMATIONTYPE_MATRIX",{get:function(){return b._ANIMATIONTYPE_MATRIX},enumerable:!0,configurable:!0}),Object.defineProperty(b,"ANIMATIONTYPE_COLOR3",{get:function(){return b._ANIMATIONTYPE_COLOR3},enumerable:!0,configurable:!0}),Object.defineProperty(b,"ANIMATIONLOOPMODE_RELATIVE",{get:function(){return b._ANIMATIONLOOPMODE_RELATIVE},enumerable:!0,configurable:!0}),Object.defineProperty(b,"ANIMATIONLOOPMODE_CYCLE",{get:function(){return b._ANIMATIONLOOPMODE_CYCLE},enumerable:!0,configurable:!0}),Object.defineProperty(b,"ANIMATIONLOOPMODE_CONSTANT",{get:function(){return b._ANIMATIONLOOPMODE_CONSTANT},enumerable:!0,configurable:!0}),b._ANIMATIONTYPE_FLOAT=0,b._ANIMATIONTYPE_VECTOR3=1,b._ANIMATIONTYPE_QUATERNION=2,b._ANIMATIONTYPE_MATRIX=3,b._ANIMATIONTYPE_COLOR3=4,b._ANIMATIONLOOPMODE_RELATIVE=0,b._ANIMATIONLOOPMODE_CYCLE=1,b._ANIMATIONLOOPMODE_CONSTANT=2,b}();a.Animation=b}(BABYLON||(BABYLON={}));var BABYLON;!function(a){var b=function(){function a(a,b,c,d,e,f,g,h){"undefined"==typeof c&&(c=0),"undefined"==typeof d&&(d=100),"undefined"==typeof e&&(e=!1),"undefined"==typeof f&&(f=1),this.target=b,this.fromFrame=c,this.toFrame=d,this.loopAnimation=e,this.speedRatio=f,this.onAnimationEnd=g,this._animations=new Array,this._paused=!1,this.animationStarted=!1,h&&this.appendAnimations(b,h),this._scene=a,a._activeAnimatables.push(this)}return a.prototype.appendAnimations=function(a,b){for(var c=0;c<b.length;c++){var d=b[c];
d._target=a,this._animations.push(d)}},a.prototype.getAnimationByTargetProperty=function(a){for(var b=this._animations,c=0;c<b.length;c++)if(b[c].targetProperty===a)return b[c];return null},a.prototype.pause=function(){this._paused=!0},a.prototype.restart=function(){this._paused=!1},a.prototype.stop=function(){var a=this._scene._activeAnimatables.indexOf(this);a>-1&&this._scene._activeAnimatables.splice(a,1),this.onAnimationEnd&&this.onAnimationEnd()},a.prototype._animate=function(a){if(this._paused)return!0;this._localDelayOffset||(this._localDelayOffset=a);for(var b=!1,c=this._animations,d=0;d<c.length;d++){var e=c[d],f=e.animate(a-this._localDelayOffset,this.fromFrame,this.toFrame,this.loopAnimation,this.speedRatio);b=b||f}return!b&&this.onAnimationEnd&&this.onAnimationEnd(),b},a}();a.Animatable=b}(BABYLON||(BABYLON={}));var BABYLON;!function(a){var b=function(){function b(b,c,d){"undefined"==typeof d&&(d=2),this.maxDepth=d,this.dynamicContent=new Array,this._maxBlockCapacity=c||64,this._selectionContent=new a.SmartArray(1024),this._creationFunc=b}return b.prototype.update=function(a,c,d){b._CreateBlocks(a,c,d,this._maxBlockCapacity,0,this.maxDepth,this,this._creationFunc)},b.prototype.addMesh=function(a){for(var b=0;b<this.blocks.length;b++){var c=this.blocks[b];c.addEntry(a)}},b.prototype.select=function(a,b){this._selectionContent.reset();for(var c=0;c<this.blocks.length;c++){var d=this.blocks[c];d.select(a,this._selectionContent,b)}return b?this._selectionContent.concat(this.dynamicContent):this._selectionContent.concatWithNoDuplicate(this.dynamicContent),this._selectionContent},b.prototype.intersects=function(a,b,c){this._selectionContent.reset();for(var d=0;d<this.blocks.length;d++){var e=this.blocks[d];e.intersects(a,b,this._selectionContent,c)}return c?this._selectionContent.concat(this.dynamicContent):this._selectionContent.concatWithNoDuplicate(this.dynamicContent),this._selectionContent},b.prototype.intersectsRay=function(a){this._selectionContent.reset();for(var b=0;b<this.blocks.length;b++){var c=this.blocks[b];c.intersectsRay(a,this._selectionContent)}return this._selectionContent.concatWithNoDuplicate(this.dynamicContent),this._selectionContent},b._CreateBlocks=function(b,c,d,e,f,g,h,i){h.blocks=new Array;for(var j=new a.Vector3((c.x-b.x)/2,(c.y-b.y)/2,(c.z-b.z)/2),k=0;2>k;k++)for(var l=0;2>l;l++)for(var m=0;2>m;m++){var n=b.add(j.multiplyByFloats(k,l,m)),o=b.add(j.multiplyByFloats(k+1,l+1,m+1)),p=new a.OctreeBlock(n,o,e,f+1,g,i);p.addEntries(d),h.blocks.push(p)}},b.CreationFuncForMeshes=function(a,b){a.getBoundingInfo().boundingBox.intersectsMinMax(b.minPoint,b.maxPoint)&&b.entries.push(a)},b.CreationFuncForSubMeshes=function(a,b){a.getBoundingInfo().boundingBox.intersectsMinMax(b.minPoint,b.maxPoint)&&b.entries.push(a)},b}();a.Octree=b}(BABYLON||(BABYLON={}));var BABYLON;!function(a){var b=function(){function b(a,b,c,d,e,f){this.entries=new Array,this._boundingVectors=new Array,this._capacity=c,this._depth=d,this._maxDepth=e,this._creationFunc=f,this._minPoint=a,this._maxPoint=b,this._boundingVectors.push(a.clone()),this._boundingVectors.push(b.clone()),this._boundingVectors.push(a.clone()),this._boundingVectors[2].x=b.x,this._boundingVectors.push(a.clone()),this._boundingVectors[3].y=b.y,this._boundingVectors.push(a.clone()),this._boundingVectors[4].z=b.z,this._boundingVectors.push(b.clone()),this._boundingVectors[5].z=a.z,this._boundingVectors.push(b.clone()),this._boundingVectors[6].x=a.x,this._boundingVectors.push(b.clone()),this._boundingVectors[7].y=a.y}return Object.defineProperty(b.prototype,"capacity",{get:function(){return this._capacity},enumerable:!0,configurable:!0}),Object.defineProperty(b.prototype,"minPoint",{get:function(){return this._minPoint},enumerable:!0,configurable:!0}),Object.defineProperty(b.prototype,"maxPoint",{get:function(){return this._maxPoint},enumerable:!0,configurable:!0}),b.prototype.addEntry=function(a){if(this.blocks)for(var b=0;b<this.blocks.length;b++){var c=this.blocks[b];c.addEntry(a)}else this._creationFunc(a,this),this.entries.length>this.capacity&&this._depth<this._maxDepth&&this.createInnerBlocks()},b.prototype.addEntries=function(a){for(var b=0;b<a.length;b++){var c=a[b];this.addEntry(c)}},b.prototype.select=function(b,c,d){if(a.BoundingBox.IsInFrustum(this._boundingVectors,b)){if(this.blocks){for(var e=0;e<this.blocks.length;e++){var f=this.blocks[e];f.select(b,c,d)}return}d?c.concat(this.entries):c.concatWithNoDuplicate(this.entries)}},b.prototype.intersects=function(b,c,d,e){if(a.BoundingBox.IntersectsSphere(this._minPoint,this._maxPoint,b,c)){if(this.blocks){for(var f=0;f<this.blocks.length;f++){var g=this.blocks[f];g.intersects(b,c,d,e)}return}e?d.concat(this.entries):d.concatWithNoDuplicate(this.entries)}},b.prototype.intersectsRay=function(a,b){if(a.intersectsBoxMinMax(this._minPoint,this._maxPoint)){if(this.blocks){for(var c=0;c<this.blocks.length;c++){var d=this.blocks[c];d.intersectsRay(a,b)}return}b.concatWithNoDuplicate(this.entries)}},b.prototype.createInnerBlocks=function(){a.Octree._CreateBlocks(this._minPoint,this._maxPoint,this.entries,this._capacity,this._depth,this._maxDepth,this,this._creationFunc)},b}();a.OctreeBlock=b}(BABYLON||(BABYLON={}));var BABYLON;!function(a){var b=function(){function b(b,c,d,e){this.name=b,this.children=new Array,this.animations=new Array,this._worldTransform=new a.Matrix,this._absoluteTransform=new a.Matrix,this._invertedAbsoluteTransform=new a.Matrix,this._skeleton=c,this._matrix=e,this._baseMatrix=e,c.bones.push(this),d?(this._parent=d,d.children.push(this)):this._parent=null,this._updateDifferenceMatrix()}return b.prototype.getParent=function(){return this._parent},b.prototype.getLocalMatrix=function(){return this._matrix},b.prototype.getBaseMatrix=function(){return this._baseMatrix},b.prototype.getWorldMatrix=function(){return this._worldTransform},b.prototype.getInvertedAbsoluteTransform=function(){return this._invertedAbsoluteTransform},b.prototype.getAbsoluteMatrix=function(){for(var a=this._matrix.clone(),b=this._parent;b;)a=a.multiply(b.getLocalMatrix()),b=b.getParent();return a},b.prototype.updateMatrix=function(a){this._matrix=a,this._skeleton._markAsDirty(),this._updateDifferenceMatrix()},b.prototype._updateDifferenceMatrix=function(){this._parent?this._matrix.multiplyToRef(this._parent._absoluteTransform,this._absoluteTransform):this._absoluteTransform.copyFrom(this._matrix),this._absoluteTransform.invertToRef(this._invertedAbsoluteTransform);for(var a=0;a<this.children.length;a++)this.children[a]._updateDifferenceMatrix()},b.prototype.markAsDirty=function(){this._skeleton._markAsDirty()},b}();a.Bone=b}(BABYLON||(BABYLON={}));var BABYLON;!function(a){var b=function(){function b(b,c,d){this.name=b,this.id=c,this.bones=new Array,this._isDirty=!0,this._identity=a.Matrix.Identity(),this.bones=[],this._scene=d,d.skeletons.push(this)}return b.prototype.getTransformMatrices=function(){return this._transformMatrices},b.prototype._markAsDirty=function(){this._isDirty=!0},b.prototype.prepare=function(){if(this._isDirty){this._transformMatrices&&this._transformMatrices.length===16*(this.bones.length+1)||(this._transformMatrices=new Float32Array(16*(this.bones.length+1)));for(var a=0;a<this.bones.length;a++){var b=this.bones[a],c=b.getParent();c?b.getLocalMatrix().multiplyToRef(c.getWorldMatrix(),b.getWorldMatrix()):b.getWorldMatrix().copyFrom(b.getLocalMatrix()),b.getInvertedAbsoluteTransform().multiplyToArray(b.getWorldMatrix(),this._transformMatrices,16*a)}this._identity.copyToArray(this._transformMatrices,16*this.bones.length),this._isDirty=!1}},b.prototype.getAnimatables=function(){if(!this._animatables||this._animatables.length!=this.bones.length){this._animatables=[];for(var a=0;a<this.bones.length;a++)this._animatables.push(this.bones[a])}return this._animatables},b.prototype.clone=function(b,c){for(var d=new a.Skeleton(b,c||b,this._scene),e=0;e<this.bones.length;e++){var f=this.bones[e],g=null;if(f.getParent()){var h=this.bones.indexOf(f.getParent());g=d.bones[h]}var i=new a.Bone(f.name,d,g,f.getBaseMatrix());a.Tools.DeepCopy(f.animations,i.animations)}return d},b}();a.Skeleton=b}(BABYLON||(BABYLON={}));var BABYLON;!function(a){var b=function(){function b(b,c,d){this.name=b,this.id=c,this.bones=new Array,this._isDirty=!0,this._identity=a.Matrix.Identity(),this.bones=[],this._scene=d,d.skeletons.push(this)}return b.prototype.getTransformMatrices=function(){return this._transformMatrices},b.prototype._markAsDirty=function(){this._isDirty=!0},b.prototype.prepare=function(){if(this._isDirty){this._transformMatrices&&this._transformMatrices.length===16*(this.bones.length+1)||(this._transformMatrices=new Float32Array(16*(this.bones.length+1)));for(var a=0;a<this.bones.length;a++){var b=this.bones[a],c=b.getParent();c?b.getLocalMatrix().multiplyToRef(c.getWorldMatrix(),b.getWorldMatrix()):b.getWorldMatrix().copyFrom(b.getLocalMatrix()),b.getInvertedAbsoluteTransform().multiplyToArray(b.getWorldMatrix(),this._transformMatrices,16*a)}this._identity.copyToArray(this._transformMatrices,16*this.bones.length),this._isDirty=!1}},b.prototype.getAnimatables=function(){if(!this._animatables||this._animatables.length!=this.bones.length){this._animatables=[];for(var a=0;a<this.bones.length;a++)this._animatables.push(this.bones[a])}return this._animatables},b.prototype.clone=function(b,c){for(var d=new a.Skeleton(b,c||b,this._scene),e=0;e<this.bones.length;e++){var f=this.bones[e],g=null;if(f.getParent()){var h=this.bones.indexOf(f.getParent());g=d.bones[h]}var i=new a.Bone(f.name,d,g,f.getBaseMatrix());a.Tools.DeepCopy(f.animations,i.animations)}return d},b}();a.Skeleton=b}(BABYLON||(BABYLON={}));var BABYLON;!function(a){var b=function(){function b(b,c,d,e,f,g,h,i,j){this.name=b,this.width=-1,this.height=-1,this._reusable=!1,this._textures=new a.SmartArray(2),this._currentRenderTextureInd=0,null!=g?(this._camera=g,this._scene=g.getScene(),g.attachPostProcess(this),this._engine=this._scene.getEngine()):this._engine=i,this._renderRatio=f,this.renderTargetSamplingMode=h?h:a.Texture.NEAREST_SAMPLINGMODE,this._reusable=j||!1,e=e||[],e.push("textureSampler"),this._effect=this._engine.createEffect({vertex:"postprocess",fragment:c},["position"],d||[],e,"")}return b.prototype.isReusable=function(){return this._reusable},b.prototype.activate=function(a,b){a=a||this._camera;var c=a.getScene(),d=(b?b._width:this._engine.getRenderingCanvas().width)*this._renderRatio,e=(b?b._height:this._engine.getRenderingCanvas().height)*this._renderRatio;if(this.width!==d||this.height!==e){if(this._textures.length>0){for(var f=0;f<this._textures.length;f++)this._engine._releaseTexture(this._textures.data[f]);this._textures.reset()}this.width=d,this.height=e,this._textures.push(this._engine.createRenderTargetTexture({width:this.width,height:this.height},{generateMipMaps:!1,generateDepthBuffer:a._postProcesses.indexOf(this)===a._postProcessesTakenIndices[0],samplingMode:this.renderTargetSamplingMode})),this._reusable&&this._textures.push(this._engine.createRenderTargetTexture({width:this.width,height:this.height},{generateMipMaps:!1,generateDepthBuffer:a._postProcesses.indexOf(this)===a._postProcessesTakenIndices[0],samplingMode:this.renderTargetSamplingMode})),this.onSizeChanged&&this.onSizeChanged()}this._engine.bindFramebuffer(this._textures.data[this._currentRenderTextureInd]),this.onActivate&&this.onActivate(a),this._engine.clear(c.clearColor,c.autoClear||c.forceWireframe,!0),this._reusable&&(this._currentRenderTextureInd=(this._currentRenderTextureInd+1)%2)},b.prototype.apply=function(){return this._effect.isReady()?(this._engine.enableEffect(this._effect),this._engine.setState(!1),this._engine.setAlphaMode(a.Engine.ALPHA_DISABLE),this._engine.setDepthBuffer(!1),this._engine.setDepthWrite(!1),this._effect._bindTexture("textureSampler",this._textures.data[this._currentRenderTextureInd]),this.onApply&&this.onApply(this._effect),this._effect):null},b.prototype.dispose=function(a){if(a=a||this._camera,this._textures.length>0){for(var b=0;b<this._textures.length;b++)this._engine._releaseTexture(this._textures.data[b]);this._textures.reset()}a.detachPostProcess(this);var c=a._postProcesses.indexOf(this);c===a._postProcessesTakenIndices[0]&&a._postProcessesTakenIndices.length>0&&(this._camera._postProcesses[a._postProcessesTakenIndices[0]].width=-1)},b}();a.PostProcess=b}(BABYLON||(BABYLON={}));var BABYLON;!function(a){var b=function(){function a(a){this._vertexDeclaration=[2],this._vertexStrideSize=8,this._scene=a;var b=[];b.push(1,1),b.push(-1,1),b.push(-1,-1),b.push(1,-1),this._vertexBuffer=a.getEngine().createVertexBuffer(b);var c=[];c.push(0),c.push(1),c.push(2),c.push(0),c.push(2),c.push(3),this._indexBuffer=a.getEngine().createIndexBuffer(c)}return a.prototype._prepareFrame=function(a){var b=this._scene.activeCamera._postProcesses,c=this._scene.activeCamera._postProcessesTakenIndices;return 0!==c.length&&this._scene.postProcessesEnabled?(b[this._scene.activeCamera._postProcessesTakenIndices[0]].activate(this._scene.activeCamera,a),!0):!1},a.prototype._finalizeFrame=function(a,b){var c=this._scene.activeCamera._postProcesses,d=this._scene.activeCamera._postProcessesTakenIndices;if(0!==d.length&&this._scene.postProcessesEnabled){for(var e=this._scene.getEngine(),f=0;f<d.length&&(f<d.length-1?c[d[f+1]].activate(this._scene.activeCamera):b?e.bindFramebuffer(b):e.restoreDefaultFramebuffer(),!a);f++){var g=c[d[f]].apply();g&&(e.bindBuffers(this._vertexBuffer,this._indexBuffer,this._vertexDeclaration,this._vertexStrideSize,g),e.draw(!0,0,6))}e.setDepthBuffer(!0),e.setDepthWrite(!0)}},a.prototype.dispose=function(){this._vertexBuffer&&(this._scene.getEngine()._releaseBuffer(this._vertexBuffer),this._vertexBuffer=null),this._indexBuffer&&(this._scene.getEngine()._releaseBuffer(this._indexBuffer),this._indexBuffer=null)},a}();a.PostProcessManager=b}(BABYLON||(BABYLON={}));var __extends=this.__extends||function(a,b){function c(){this.constructor=a}for(var d in b)b.hasOwnProperty(d)&&(a[d]=b[d]);c.prototype=b.prototype,a.prototype=new c},BABYLON;!function(a){var b=function(a){function b(b,c,d,e,f,g){a.call(this,b,"pass",null,null,c,d,e,f,g)}return __extends(b,a),b}(a.PostProcess);a.PassPostProcess=b}(BABYLON||(BABYLON={}));var __extends=this.__extends||function(a,b){function c(){this.constructor=a}for(var d in b)b.hasOwnProperty(d)&&(a[d]=b[d]);c.prototype=b.prototype,a.prototype=new c},BABYLON;!function(a){var b=function(b){function c(c,d,e,f,g,h,i,j){"undefined"==typeof h&&(h=a.Texture.BILINEAR_SAMPLINGMODE);var k=this;b.call(this,c,"blur",["screenSize","direction","blurWidth"],null,f,g,h,i,j),this.direction=d,this.blurWidth=e,this.onApply=function(a){a.setFloat2("screenSize",k.width,k.height),a.setVector2("direction",k.direction),a.setFloat("blurWidth",k.blurWidth)}}return __extends(c,b),c}(a.PostProcess);a.BlurPostProcess=b}(BABYLON||(BABYLON={}));var __extends=this.__extends||function(a,b){function c(){this.constructor=a}for(var d in b)b.hasOwnProperty(d)&&(a[d]=b[d]);c.prototype=b.prototype,a.prototype=new c},BABYLON;!function(a){var b=function(b){function c(c,d,e,f,g,h,i,j,k,l){var m=this;b.call(this,c,"refraction",["baseColor","depth","colorLevel"],["refractionSampler"],h,i,j,k,l),this.color=e,this.depth=f,this.colorLevel=g,this.onActivate=function(b){m._refRexture=m._refRexture||new a.Texture(d,b.getScene())},this.onApply=function(a){a.setColor3("baseColor",m.color),a.setFloat("depth",m.depth),a.setFloat("colorLevel",m.colorLevel),a.setTexture("refractionSampler",m._refRexture)}}return __extends(c,b),c.prototype.dispose=function(a){this._refRexture&&this._refRexture.dispose(),b.prototype.dispose.call(this,a)},c}(a.PostProcess);a.RefractionPostProcess=b}(BABYLON||(BABYLON={}));var __extends=this.__extends||function(a,b){function c(){this.constructor=a}for(var d in b)b.hasOwnProperty(d)&&(a[d]=b[d]);c.prototype=b.prototype,a.prototype=new c},BABYLON;!function(a){var b=function(a){function b(b,c,d,e,f,g){a.call(this,b,"blackAndWhite",null,null,c,d,e,f,g)}return __extends(b,a),b}(a.PostProcess);a.BlackAndWhitePostProcess=b}(BABYLON||(BABYLON={}));var __extends=this.__extends||function(a,b){function c(){this.constructor=a}for(var d in b)b.hasOwnProperty(d)&&(a[d]=b[d]);c.prototype=b.prototype,a.prototype=new c},BABYLON;!function(a){var b=function(a){function b(b,c,d,e,f,g,h){var i=this;a.call(this,b,"convolution",["kernel","screenSize"],null,d,e,f,g,h),this.kernel=c,this.onApply=function(a){a.setFloat2("screenSize",i.width,i.height),a.setArray("kernel",i.kernel)}}return __extends(b,a),b.EdgeDetect0Kernel=[1,0,-1,0,0,0,-1,0,1],b.EdgeDetect1Kernel=[0,1,0,1,-4,1,0,1,0],b.EdgeDetect2Kernel=[-1,-1,-1,-1,8,-1,-1,-1,-1],b.SharpenKernel=[0,-1,0,-1,5,-1,0,-1,0],b.EmbossKernel=[-2,-1,0,-1,1,1,0,1,2],b.GaussianKernel=[0,1,0,1,1,1,0,1,0],b}(a.PostProcess);a.ConvolutionPostProcess=b}(BABYLON||(BABYLON={}));var __extends=this.__extends||function(a,b){function c(){this.constructor=a}for(var d in b)b.hasOwnProperty(d)&&(a[d]=b[d]);c.prototype=b.prototype,a.prototype=new c},BABYLON;!function(a){var b=function(a){function b(b,c,d,e,f,g,h){var i=this;a.call(this,b,"filter",["kernelMatrix"],null,d,e,f,g,h),this.kernelMatrix=c,this.onApply=function(a){a.setMatrix("kernelMatrix",i.kernelMatrix)}}return __extends(b,a),b}(a.PostProcess);a.FilterPostProcess=b}(BABYLON||(BABYLON={}));var __extends=this.__extends||function(a,b){function c(){this.constructor=a}for(var d in b)b.hasOwnProperty(d)&&(a[d]=b[d]);c.prototype=b.prototype,a.prototype=new c},BABYLON;!function(a){var b=function(a){function b(b,c,d,e,f,g){var h=this;a.call(this,b,"fxaa",["texelSize"],null,c,d,e,f,g),this.onSizeChanged=function(){h.texelWidth=1/h.width,h.texelHeight=1/h.height},this.onApply=function(a){a.setFloat2("texelSize",h.texelWidth,h.texelHeight)}}return __extends(b,a),b}(a.PostProcess);a.FxaaPostProcess=b}(BABYLON||(BABYLON={}));var BABYLON;!function(a){var b=function(){function b(b,c,d,e,f){this.size=b,this.position=c,this.dispose=function(){this.texture&&this.texture.dispose();var a=this._system.lensFlares.indexOf(this);this._system.lensFlares.splice(a,1)},this.color=d||new a.Color3(1,1,1),this.texture=e?new a.Texture(e,f.getScene(),!0):null,this._system=f,f.lensFlares.push(this)}return b}();a.LensFlare=b}(BABYLON||(BABYLON={}));var BABYLON;!function(a){var b=function(){function b(a,b,c){this.name=a,this.lensFlares=new Array,this.borderLimit=300,this._vertexDeclaration=[2],this._vertexStrideSize=8,this._isEnabled=!0,this._scene=c,this._emitter=b,c.lensFlareSystems.push(this),this.meshesSelectionPredicate=function(a){return a.material&&a.isVisible&&a.isEnabled()&&a.checkCollisions&&0!=(a.layerMask&c.activeCamera.layerMask)};var d=[];d.push(1,1),d.push(-1,1),d.push(-1,-1),d.push(1,-1),this._vertexBuffer=c.getEngine().createVertexBuffer(d);var e=[];e.push(0),e.push(1),e.push(2),e.push(0),e.push(2),e.push(3),this._indexBuffer=c.getEngine().createIndexBuffer(e),this._effect=this._scene.getEngine().createEffect("lensFlare",["position"],["color","viewportMatrix"],["textureSampler"],"")}return Object.defineProperty(b.prototype,"isEnabled",{get:function(){return this._isEnabled},set:function(a){this._isEnabled=a},enumerable:!0,configurable:!0}),b.prototype.getScene=function(){return this._scene},b.prototype.getEmitter=function(){return this._emitter},b.prototype.getEmitterPosition=function(){return this._emitter.getAbsolutePosition?this._emitter.getAbsolutePosition():this._emitter.position},b.prototype.computeEffectivePosition=function(b){var c=this.getEmitterPosition();return c=a.Vector3.Project(c,a.Matrix.Identity(),this._scene.getTransformMatrix(),b),this._positionX=c.x,this._positionY=c.y,c=a.Vector3.TransformCoordinates(this.getEmitterPosition(),this._scene.getViewMatrix()),c.z>0&&this._positionX>b.x&&this._positionX<b.x+b.width&&this._positionY>b.y&&this._positionY<b.y+b.height?!0:!1},b.prototype._isVisible=function(){if(!this._isEnabled)return!1;var b=this.getEmitterPosition(),c=b.subtract(this._scene.activeCamera.position),d=c.length();c.normalize();var e=new a.Ray(this._scene.activeCamera.position,c),f=this._scene.pickWithRay(e,this.meshesSelectionPredicate,!0);return!f.hit||f.distance>d},b.prototype.render=function(){if(!this._effect.isReady())return!1;var b=this._scene.getEngine(),c=this._scene.activeCamera.viewport,d=c.toGlobal(b);if(!this.computeEffectivePosition(d))return!1;if(!this._isVisible())return!1;var e,f;e=this._positionX<this.borderLimit+d.x?this.borderLimit+d.x-this._positionX:this._positionX>d.x+d.width-this.borderLimit?this._positionX-d.x-d.width+this.borderLimit:0,f=this._positionY<this.borderLimit+d.y?this.borderLimit+d.y-this._positionY:this._positionY>d.y+d.height-this.borderLimit?this._positionY-d.y-d.height+this.borderLimit:0;var g=e>f?e:f;g>this.borderLimit&&(g=this.borderLimit);var h=1-g/this.borderLimit;if(0>h)return!1;h>1&&(h=1);var i=d.x+d.width/2,j=d.y+d.height/2,k=i-this._positionX,l=j-this._positionY;b.enableEffect(this._effect),b.setState(!1),b.setDepthBuffer(!1),b.setAlphaMode(a.Engine.ALPHA_ADD),b.bindBuffers(this._vertexBuffer,this._indexBuffer,this._vertexDeclaration,this._vertexStrideSize,this._effect);for(var m=0;m<this.lensFlares.length;m++){var n=this.lensFlares[m],o=i-k*n.position,p=j-l*n.position,q=n.size,r=n.size*b.getAspectRatio(this._scene.activeCamera),s=2*(o/d.width)-1,t=1-2*(p/d.height),u=a.Matrix.FromValues(q/2,0,0,0,0,r/2,0,0,0,0,1,0,s,t,0,1);this._effect.setMatrix("viewportMatrix",u),this._effect.setTexture("textureSampler",n.texture),this._effect.setFloat4("color",n.color.r*h,n.color.g*h,n.color.b*h,1),b.draw(!0,0,6)}return b.setDepthBuffer(!0),b.setAlphaMode(a.Engine.ALPHA_DISABLE),!0},b.prototype.dispose=function(){for(this._vertexBuffer&&(this._scene.getEngine()._releaseBuffer(this._vertexBuffer),this._vertexBuffer=null),this._indexBuffer&&(this._scene.getEngine()._releaseBuffer(this._indexBuffer),this._indexBuffer=null);this.lensFlares.length;)this.lensFlares[0].dispose();var a=this._scene.lensFlareSystems.indexOf(this);this._scene.lensFlareSystems.splice(a,1)},b}();a.LensFlareSystem=b}(BABYLON||(BABYLON={}));var BABYLON;!function(a){var b=function(){function b(){this._registeredMeshes=[],this._physicsMaterials=[]}return b.prototype.initialize=function(a){"undefined"==typeof a&&(a=10),this._world=new CANNON.World,this._world.broadphase=new CANNON.NaiveBroadphase,this._world.solver.iterations=a},b.prototype._checkWithEpsilon=function(b){return b<a.PhysicsEngine.Epsilon?a.PhysicsEngine.Epsilon:b},b.prototype.runOneStep=function(b){this._world.step(b);for(var c=0;c<this._registeredMeshes.length;c++){var d=this._registeredMeshes[c];d.isChild||(d.mesh.position.x=d.body.position.x,d.mesh.position.y=d.body.position.z,d.mesh.position.z=d.body.position.y,d.mesh.rotationQuaternion||(d.mesh.rotationQuaternion=new a.Quaternion(0,0,0,1)),d.mesh.rotationQuaternion.x=d.body.quaternion.x,d.mesh.rotationQuaternion.y=d.body.quaternion.z,d.mesh.rotationQuaternion.z=d.body.quaternion.y,d.mesh.rotationQuaternion.w=-d.body.quaternion.w)}},b.prototype.setGravity=function(a){this._world.gravity.set(a.x,a.z,a.y)},b.prototype.registerMesh=function(b,c,d){switch(this.unregisterMesh(b),b.computeWorldMatrix(!0),c){case a.PhysicsEngine.SphereImpostor:var e=b.getBoundingInfo().boundingBox,f=e.maximumWorld.x-e.minimumWorld.x,g=e.maximumWorld.y-e.minimumWorld.y,h=e.maximumWorld.z-e.minimumWorld.z;return this._createSphere(Math.max(this._checkWithEpsilon(f),this._checkWithEpsilon(g),this._checkWithEpsilon(h))/2,b,d);case a.PhysicsEngine.BoxImpostor:e=b.getBoundingInfo().boundingBox;var i=e.minimumWorld,j=e.maximumWorld,k=j.subtract(i).scale(.5);return this._createBox(this._checkWithEpsilon(k.x),this._checkWithEpsilon(k.y),this._checkWithEpsilon(k.z),b,d);case a.PhysicsEngine.PlaneImpostor:return this._createPlane(b,d);case a.PhysicsEngine.MeshImpostor:var l=b.getVerticesData(a.VertexBuffer.PositionKind),m=b.getIndices();return this._createConvexPolyhedron(l,m,b,d)}return null},b.prototype._createSphere=function(a,b,c){var d=new CANNON.Sphere(a);return c?this._createRigidBodyFromShape(d,b,c.mass,c.friction,c.restitution):d},b.prototype._createBox=function(a,b,c,d,e){var f=new CANNON.Box(new CANNON.Vec3(a,c,b));return e?this._createRigidBodyFromShape(f,d,e.mass,e.friction,e.restitution):f},b.prototype._createPlane=function(a,b){var c=new CANNON.Plane;return b?this._createRigidBodyFromShape(c,a,b.mass,b.friction,b.restitution):c},b.prototype._createConvexPolyhedron=function(b,c,d,e){var f=[],g=[];d.computeWorldMatrix(!0);for(var h=0;h<b.length;h+=3){var i=a.Vector3.Zero();a.Vector3.TransformNormalFromFloatsToRef(b[h],b[h+1],b[h+2],d.getWorldMatrix(),i),f.push(new CANNON.Vec3(i.x,i.z,i.y))}for(var j=0;j<c.length;j+=3)g.push([c[j],c[j+2],c[j+1]]);var k=new CANNON.ConvexPolyhedron(f,g);return e?this._createRigidBodyFromShape(k,d,e.mass,e.friction,e.restitution):k},b.prototype._addMaterial=function(a,b){var c,d;for(c=0;c<this._physicsMaterials.length;c++)if(d=this._physicsMaterials[c],d.friction===a&&d.restitution===b)return d;var e=new CANNON.Material;for(e.friction=a,e.restitution=b,this._physicsMaterials.push(e),c=0;c<this._physicsMaterials.length;c++){d=this._physicsMaterials[c];var f=new CANNON.ContactMaterial(d,e,d.friction*e.friction,d.restitution*e.restitution);f.contactEquationStiffness=1e10,f.contactEquationRegularizationTime=10,this._world.addContactMaterial(f)}return e},b.prototype._createRigidBodyFromShape=function(b,c,d,e,f){var g=null;c.rotationQuaternion&&(g=c.rotationQuaternion.clone(),c.rotationQuaternion=new a.Quaternion(0,0,0,1));var h=this._addMaterial(e,f),i=new CANNON.RigidBody(d,b,h);return g&&(i.quaternion.x=g.x,i.quaternion.z=g.y,i.quaternion.y=g.z,i.quaternion.w=-g.w),i.position.set(c.position.x,c.position.z,c.position.y),this._world.add(i),this._registeredMeshes.push({mesh:c,body:i,material:h}),i},b.prototype.registerMeshesAsCompound=function(a,b){for(var c=new CANNON.Compound,d=0;d<a.length;d++){var e=a[d].mesh,f=this.registerMesh(e,a[d].impostor);0==d?c.addChild(f,new CANNON.Vec3(0,0,0)):c.addChild(f,new CANNON.Vec3(e.position.x,e.position.z,e.position.y))}var g=a[0].mesh,h=this._createRigidBodyFromShape(c,g,b.mass,b.friction,b.restitution);return h.parts=a,h},b.prototype._unbindBody=function(a){for(var b=0;b<this._registeredMeshes.length;b++){var c=this._registeredMeshes[b];c.body===a&&(c.body=null)}},b.prototype.unregisterMesh=function(a){for(var b=0;b<this._registeredMeshes.length;b++){var c=this._registeredMeshes[b];if(c.mesh===a)return c.body&&(this._world.remove(c.body),this._unbindBody(c.body)),void this._registeredMeshes.splice(b,1)}},b.prototype.applyImpulse=function(a,b,c){for(var d=new CANNON.Vec3(c.x,c.z,c.y),e=new CANNON.Vec3(b.x,b.z,b.y),f=0;f<this._registeredMeshes.length;f++){var g=this._registeredMeshes[f];if(g.mesh===a)return void g.body.applyImpulse(e,d)}},b.prototype.createLink=function(a,b,c,d){for(var e=null,f=null,g=0;g<this._registeredMeshes.length;g++){var h=this._registeredMeshes[g];h.mesh===a?e=h.body:h.mesh===b&&(f=h.body)}if(!e||!f)return!1;var i=new CANNON.PointToPointConstraint(e,new CANNON.Vec3(c.x,c.z,c.y),f,new CANNON.Vec3(d.x,d.z,d.y));return this._world.addConstraint(i),!0},b.prototype.dispose=function(){for(;this._registeredMeshes.length;)this.unregisterMesh(this._registeredMeshes[0].mesh)},b.prototype.isSupported=function(){return void 0!==window.CANNON},b}();a.CannonJSPlugin=b}(BABYLON||(BABYLON={}));var BABYLON;!function(a){var b=function(){function b(b){this._currentPlugin=b||new a.CannonJSPlugin}return b.prototype._initialize=function(a){this._currentPlugin.initialize(),this._setGravity(a)},b.prototype._runOneStep=function(a){a>.1?a=.1:0>=a&&(a=1/60),this._currentPlugin.runOneStep(a)},b.prototype._setGravity=function(b){this.gravity=b||new a.Vector3(0,-9.82,0),this._currentPlugin.setGravity(this.gravity)},b.prototype._registerMesh=function(a,b,c){return this._currentPlugin.registerMesh(a,b,c)},b.prototype._registerMeshesAsCompound=function(a,b){return this._currentPlugin.registerMeshesAsCompound(a,b)},b.prototype._unregisterMesh=function(a){this._currentPlugin.unregisterMesh(a)},b.prototype._applyImpulse=function(a,b,c){this._currentPlugin.applyImpulse(a,b,c)},b.prototype._createLink=function(a,b,c,d){return this._currentPlugin.createLink(a,b,c,d)},b.prototype.dispose=function(){this._currentPlugin.dispose()},b.prototype.isSupported=function(){return this._currentPlugin.isSupported()},b.NoImpostor=0,b.SphereImpostor=1,b.BoxImpostor=2,b.PlaneImpostor=3,b.CompoundImpostor=4,b.MeshImpostor=4,b.CapsuleImpostor=5,b.ConeImpostor=6,b.CylinderImpostor=7,b.ConvexHullImpostor=8,b.Epsilon=.001,b}();a.PhysicsEngine=b}(BABYLON||(BABYLON={}));var BABYLON;!function(a){var b=function(b){var c={};if(c.name=b.name,c.id=b.id,c.tags=a.Tags.GetTags(b),b instanceof a.PointLight)c.type=0,c.position=b.position.asArray();else if(b instanceof a.DirectionalLight){c.type=1;var d=b;c.position=d.position.asArray(),c.direction=d.direction.asArray()}else if(b instanceof a.SpotLight){c.type=2;var e=b;c.position=e.position.asArray(),c.direction=e.position.asArray(),c.angle=e.angle,c.exponent=e.exponent}else if(b instanceof a.HemisphericLight){c.type=3;var f=b;c.direction=f.direction.asArray(),c.groundColor=f.groundColor.asArray()}return b.intensity&&(c.intensity=b.intensity),c.range=b.range,c.diffuse=b.diffuse.asArray(),c.specular=b.specular.asArray(),c},c=function(b){var c={};return c.name=b.name,c.tags=a.Tags.GetTags(b),c.id=b.id,c.position=b.position.asArray(),b.parent&&(c.parentId=b.parent.id),c.rotation=b.rotation.asArray(),b.lockedTarget&&b.lockedTarget.id&&(c.lockedTargetId=b.lockedTarget.id),c.fov=b.fov,c.minZ=b.minZ,c.maxZ=b.maxZ,c.speed=b.speed,c.inertia=b.inertia,c.checkCollisions=b.checkCollisions,c.applyGravity=b.applyGravity,b.ellipsoid&&(c.ellipsoid=b.ellipsoid.asArray()),d(b,c),c.layerMask=b.layerMask,c},d=function(a,b){if(a.animations){b.animations=[];for(var c=0;c<a.animations.length;c++){var d=a.animations[c];b.animations.push(e(d))}}},e=function(b){var c={};c.name=b.name,c.property=b.targetProperty,c.framePerSecond=b.framePerSecond,c.dataType=b.dataType,c.loopBehavior=b.loopMode;var d=b.dataType;c.keys=[];for(var e=b.getKeys(),f=0;f<e.length;f++){var g=e[f],h={};switch(h.frame=g.frame,d){case a.Animation.ANIMATIONTYPE_FLOAT:h.values=[g.value];break;case a.Animation.ANIMATIONTYPE_QUATERNION:case a.Animation.ANIMATIONTYPE_MATRIX:case a.Animation.ANIMATIONTYPE_VECTOR3:h.values=g.value.asArray()}c.keys.push(h)}return c},f=function(b){var c={};c.name=b.name,c.id=b.id,c.tags=a.Tags.GetTags(b),c.materials=[];for(var d=0;d<b.subMaterials.length;d++){var e=b.subMaterials[d];c.materials.push(e?e.id:null)}return c},g=function(b){var c={};return c.name=b.name,c.ambient=b.ambientColor.asArray(),c.diffuse=b.diffuseColor.asArray(),c.specular=b.specularColor.asArray(),c.specularPower=b.specularPower,c.emissive=b.emissiveColor.asArray(),c.alpha=b.alpha,c.id=b.id,c.tags=a.Tags.GetTags(b),c.backFaceCulling=b.backFaceCulling,b.diffuseTexture&&(c.diffuseTexture=h(b.diffuseTexture)),b.ambientTexture&&(c.ambientTexture=h(b.ambientTexture)),b.opacityTexture&&(c.opacityTexture=h(b.opacityTexture)),b.reflectionTexture&&(c.reflectionTexture=h(b.reflectionTexture)),b.emissiveTexture&&(c.emissiveTexture=h(b.emissiveTexture)),b.specularTexture&&(c.specularTexture=h(b.specularTexture)),b.bumpTexture&&(c.bumpTexture=h(b.bumpTexture)),c},h=function(b){var c={};if(!b.name)return null;if(b instanceof a.CubeTexture)return c.name=b.name,c.hasAlpha=b.hasAlpha,c.level=b.level,c.coordinatesMode=b.coordinatesMode,c;if(b instanceof a.MirrorTexture){var e=b;c.renderTargetSize=e.getRenderSize(),c.renderList=[];for(var f=0;f<e.renderList.length;f++)c.renderList.push(e.renderList[f].id);c.mirrorPlane=e.mirrorPlane.asArray()}else if(b instanceof a.RenderTargetTexture){var g=b;for(c.renderTargetSize=g.getRenderSize(),c.renderList=[],f=0;f<g.renderList.length;f++)c.renderList.push(g.renderList[f].id)}var h=b;return c.name=b.name,c.hasAlpha=b.hasAlpha,c.level=b.level,c.coordinatesIndex=b.coordinatesIndex,c.coordinatesMode=b.coordinatesMode,c.uOffset=h.uOffset,c.vOffset=h.vOffset,c.uScale=h.uScale,c.vScale=h.vScale,c.uAng=h.uAng,c.vAng=h.vAng,c.wAng=h.wAng,c.wrapU=b.wrapU,c.wrapV=b.wrapV,d(b,c),c
},i=function(a){var b={};b.name=a.name,b.id=a.id,b.bones=[];for(var c=0;c<a.bones.length;c++){var d=a.bones[c],f={parentBoneIndex:d.getParent()?a.bones.indexOf(d.getParent()):-1,name:d.name,matrix:d.getLocalMatrix().toArray()};b.bones.push(f),d.animations&&d.animations.length>0&&(f.animation=e(d.animations[0]))}return b},j=function(a){var b={};return b.emitterId=a.emitter.id,b.capacity=a.getCapacity(),a.particleTexture&&(b.textureName=a.particleTexture.name),b.minAngularSpeed=a.minAngularSpeed,b.maxAngularSpeed=a.maxAngularSpeed,b.minSize=a.minSize,b.maxSize=a.maxSize,b.minLifeTime=a.minLifeTime,b.maxLifeTime=a.maxLifeTime,b.emitRate=a.emitRate,b.minEmitBox=a.minEmitBox.asArray(),b.maxEmitBox=a.maxEmitBox.asArray(),b.gravity=a.gravity.asArray(),b.direction1=a.direction1.asArray(),b.direction2=a.direction2.asArray(),b.color1=a.color1.asArray(),b.color2=a.color2.asArray(),b.colorDead=a.colorDead.asArray(),b.updateSpeed=a.updateSpeed,b.targetStopDuration=a.targetStopDuration,b.textureMask=a.textureMask.asArray(),b.blendMode=a.blendMode,b},k=function(b){var c={};c.emitterId=b.getEmitter().id,c.borderLimit=b.borderLimit,c.flares=[];for(var d=0;d<b.lensFlares.length;d++){var e=b.lensFlares[d];c.flares.push({size:e.size,position:e.position,color:e.color.asArray(),textureName:a.Tools.GetFilename(e.texture.name)})}return c},l=function(a){var b={},c=a.getShadowGenerator();b.lightId=a.id,b.mapSize=c.getShadowMap().getRenderSize(),b.useVarianceShadowMap=c.useVarianceShadowMap,b.usePoissonSampling=c.usePoissonSampling,b.renderList=[];for(var d=0;d<c.getShadowMap().renderList.length;d++){var e=c.getShadowMap().renderList[d];b.renderList.push(e.id)}return b},m=[],n=function(b,c){if(!m[b.id]){if(b instanceof a.Geometry.Primitives.Box)c.boxes.push(r(b));else if(b instanceof a.Geometry.Primitives.Sphere)c.spheres.push(s(b));else if(b instanceof a.Geometry.Primitives.Cylinder)c.cylinders.push(t(b));else if(b instanceof a.Geometry.Primitives.Torus)c.toruses.push(u(b));else if(b instanceof a.Geometry.Primitives.Ground)c.grounds.push(v(b));else if(b instanceof a.Geometry.Primitives.Plane)c.planes.push(w(b));else if(b instanceof a.Geometry.Primitives.TorusKnot)c.torusKnots.push(x(b));else{if(b instanceof a.Geometry.Primitives._Primitive)throw new Error("Unknow primitive type");c.vertexData.push(p(b))}m[b.id]=!0}},o=function(b){var c={};return c.id=b.id,a.Tags.HasTags(b)&&(c.tags=a.Tags.GetTags(b)),c},p=function(b){var c=o(b);return b.isVerticesDataPresent(a.VertexBuffer.PositionKind)&&(c.positions=b.getVerticesData(a.VertexBuffer.PositionKind)),b.isVerticesDataPresent(a.VertexBuffer.NormalKind)&&(c.normals=b.getVerticesData(a.VertexBuffer.NormalKind)),b.isVerticesDataPresent(a.VertexBuffer.UVKind)&&(c.uvs=b.getVerticesData(a.VertexBuffer.UVKind)),b.isVerticesDataPresent(a.VertexBuffer.UV2Kind)&&(c.uvs2=b.getVerticesData(a.VertexBuffer.UV2Kind)),b.isVerticesDataPresent(a.VertexBuffer.ColorKind)&&(c.colors=b.getVerticesData(a.VertexBuffer.ColorKind)),b.isVerticesDataPresent(a.VertexBuffer.MatricesIndicesKind)&&(c.matricesIndices=b.getVerticesData(a.VertexBuffer.MatricesIndicesKind),c.matricesIndices._isExpanded=!0),b.isVerticesDataPresent(a.VertexBuffer.MatricesWeightsKind)&&(c.matricesWeights=b.getVerticesData(a.VertexBuffer.MatricesWeightsKind)),c.indices=b.getIndices(),c},q=function(a){var b=o(a);return b.canBeRegenerated=a.canBeRegenerated(),b},r=function(a){var b=q(a);return b.size=a.size,b},s=function(a){var b=q(a);return b.segments=a.segments,b.diameter=a.diameter,b},t=function(a){var b=q(a);return b.height=a.height,b.diameterTop=a.diameterTop,b.diameterBottom=a.diameterBottom,b.tessellation=a.tessellation,b},u=function(a){var b=q(a);return b.diameter=a.diameter,b.thickness=a.thickness,b.tessellation=a.tessellation,b},v=function(a){var b=q(a);return b.width=a.width,b.height=a.height,b.subdivisions=a.subdivisions,b},w=function(a){var b=q(a);return b.size=a.size,b},x=function(a){var b=q(a);return b.radius=a.radius,b.tube=a.tube,b.radialSegments=a.radialSegments,b.tubularSegments=a.tubularSegments,b.p=a.p,b.q=a.q,b},y=function(b,c){var e={};e.name=b.name,e.id=b.id,a.Tags.HasTags(b)&&(e.tags=a.Tags.GetTags(b)),e.position=b.position.asArray(),b.rotationQuaternion?e.rotationQuaternion=b.rotationQuaternion.asArray():b.rotation&&(e.rotation=b.rotation.asArray()),e.scaling=b.scaling.asArray(),e.localMatrix=b.getPivotMatrix().asArray(),e.isEnabled=b.isEnabled(),e.isVisible=b.isVisible,e.infiniteDistance=b.infiniteDistance,e.pickable=b.isPickable,e.receiveShadows=b.receiveShadows,e.billboardMode=b.billboardMode,e.visibility=b.visibility,e.checkCollisions=b.checkCollisions,b.parent&&(e.parentId=b.parent.id);var f=b._geometry;if(f){var g=f.id;e.geometryId=g,b.getScene().getGeometryByID(g)||n(f,c.geometries),e.subMeshes=[];for(var h=0;h<b.subMeshes.length;h++){var i=b.subMeshes[h];e.subMeshes.push({materialIndex:i.materialIndex,verticesStart:i.verticesStart,verticesCount:i.verticesCount,indexStart:i.indexStart,indexCount:i.indexCount})}}if(b.material?e.materialId=b.material.id:b.material=null,b.skeleton&&(e.skeletonId=b.skeleton.id),b.getPhysicsImpostor()!==a.PhysicsEngine.NoImpostor)switch(e.physicsMass=b.getPhysicsMass(),e.physicsFriction=b.getPhysicsFriction(),e.physicsRestitution=b.getPhysicsRestitution(),b.getPhysicsImpostor()){case a.PhysicsEngine.BoxImpostor:e.physicsImpostor=1;break;case a.PhysicsEngine.SphereImpostor:e.physicsImpostor=2}return d(b,e),e.layerMask=b.layerMask,e},z=function(){function d(){}return d.Serialize=function(d){var e={};e.useDelayedTextureLoading=d.useDelayedTextureLoading,e.autoClear=d.autoClear,e.clearColor=d.clearColor.asArray(),e.ambientColor=d.ambientColor.asArray(),e.gravity=d.gravity.asArray(),d.fogMode&&0!==d.fogMode&&(e.fogMode=d.fogMode,e.fogColor=d.fogColor.asArray(),e.fogStart=d.fogStart,e.fogEnd=d.fogEnd,e.fogDensity=d.fogDensity),e.lights=[];for(var h=0;h<d.lights.length;h++){var o=d.lights[h];e.lights.push(b(o))}for(e.cameras=[],h=0;h<d.cameras.length;h++){var p=d.cameras[h];p instanceof a.FreeCamera&&e.cameras.push(c(p))}for(d.activeCamera&&(e.activeCameraID=d.activeCamera.id),e.materials=[],e.multiMaterials=[],h=0;h<d.materials.length;h++){var q=d.materials[h];q instanceof a.StandardMaterial?e.materials.push(g(q)):q instanceof a.MultiMaterial&&e.multiMaterials.push(f(q))}for(e.skeletons=[],h=0;h<d.skeletons.length;h++)e.skeletons.push(i(d.skeletons[h]));e.geometries={},e.geometries.boxes=[],e.geometries.spheres=[],e.geometries.cylinders=[],e.geometries.toruses=[],e.geometries.grounds=[],e.geometries.planes=[],e.geometries.torusKnots=[],e.geometries.vertexData=[],m=[];for(var r=d.getGeometries(),h=0;h<r.length;h++){var s=r[h];s.isReady()&&n(s,e.geometries)}for(e.meshes=[],h=0;h<d.meshes.length;h++){var t=d.meshes[h];if(t instanceof a.Mesh){var u=t;(u.delayLoadState===a.Engine.DELAYLOADSTATE_LOADED||u.delayLoadState===a.Engine.DELAYLOADSTATE_NONE)&&e.meshes.push(y(u,e))}}for(e.particleSystems=[],h=0;h<d.particleSystems.length;h++)e.particleSystems.push(j(d.particleSystems[h]));for(e.lensFlareSystems=[],h=0;h<d.lensFlareSystems.length;h++)e.lensFlareSystems.push(k(d.lensFlareSystems[h]));for(e.shadowGenerators=[],h=0;h<d.lights.length;h++)o=d.lights[h],o.getShadowGenerator()&&e.shadowGenerators.push(l(o));return e},d}();a.SceneSerializer=z}(BABYLON||(BABYLON={}));var BABYLON;!function(a){var b=0,c=function(){function b(a,b,c){this.pos=a,this.normal=b,this.uv=c}return b.prototype.clone=function(){return new b(this.pos.clone(),this.normal.clone(),this.uv.clone())},b.prototype.flip=function(){this.normal.scaleInPlace(-1)},b.prototype.interpolate=function(c,d){return new b(a.Vector3.Lerp(this.pos,c.pos,d),a.Vector3.Lerp(this.normal,c.normal,d),a.Vector2.Lerp(this.uv,c.uv,d))},b}(),d=function(){function b(a,b){this.normal=a,this.w=b}return b.FromPoints=function(c,d,e){var f=e.subtract(c),g=d.subtract(c);if(0===f.lengthSquared()||0===g.lengthSquared())return null;var h=a.Vector3.Normalize(a.Vector3.Cross(f,g));return new b(h,a.Vector3.Dot(h,c))},b.prototype.clone=function(){return new b(this.normal.clone(),this.w)},b.prototype.flip=function(){this.normal.scaleInPlace(-1),this.w=-this.w},b.prototype.splitPolygon=function(c,d,f,g,h){for(var i=0,j=1,k=2,l=3,m=0,n=[],o=0;o<c.vertices.length;o++){var p=a.Vector3.Dot(this.normal,c.vertices[o].pos)-this.w,q=p<-b.EPSILON?k:p>b.EPSILON?j:i;m|=q,n.push(q)}switch(m){case i:(a.Vector3.Dot(this.normal,c.plane.normal)>0?d:f).push(c);break;case j:g.push(c);break;case k:h.push(c);break;case l:var r=[],s=[];for(o=0;o<c.vertices.length;o++){var t=(o+1)%c.vertices.length,u=n[o],v=n[t],w=c.vertices[o],x=c.vertices[t];if(u!=k&&r.push(w),u!=j&&s.push(u!=k?w.clone():w),(u|v)==l){p=(this.w-a.Vector3.Dot(this.normal,w.pos))/a.Vector3.Dot(this.normal,x.pos.subtract(w.pos));var y=w.interpolate(x,p);r.push(y),s.push(y.clone())}}if(r.length>=3){var z=new e(r,c.shared);z.plane&&g.push(z)}if(s.length>=3){var z=new e(s,c.shared);z.plane&&h.push(z)}}},b.EPSILON=1e-5,b}(),e=function(){function a(a,b){this.vertices=a,this.shared=b,this.plane=d.FromPoints(a[0].pos,a[1].pos,a[2].pos)}return a.prototype.clone=function(){var b=this.vertices.map(function(a){return a.clone()});return new a(b,this.shared)},a.prototype.flip=function(){this.vertices.reverse().map(function(a){a.flip()}),this.plane.flip()},a}(),f=function(){function a(a){this.plane=null,this.front=null,this.back=null,this.polygons=[],a&&this.build(a)}return a.prototype.clone=function(){var b=new a;return b.plane=this.plane&&this.plane.clone(),b.front=this.front&&this.front.clone(),b.back=this.back&&this.back.clone(),b.polygons=this.polygons.map(function(a){return a.clone()}),b},a.prototype.invert=function(){for(var a=0;a<this.polygons.length;a++)this.polygons[a].flip();this.plane&&this.plane.flip(),this.front&&this.front.invert(),this.back&&this.back.invert();var b=this.front;this.front=this.back,this.back=b},a.prototype.clipPolygons=function(a){if(!this.plane)return a.slice();for(var b=[],c=[],d=0;d<a.length;d++)this.plane.splitPolygon(a[d],b,c,b,c);return this.front&&(b=this.front.clipPolygons(b)),c=this.back?this.back.clipPolygons(c):[],b.concat(c)},a.prototype.clipTo=function(a){this.polygons=a.clipPolygons(this.polygons),this.front&&this.front.clipTo(a),this.back&&this.back.clipTo(a)},a.prototype.allPolygons=function(){var a=this.polygons.slice();return this.front&&(a=a.concat(this.front.allPolygons())),this.back&&(a=a.concat(this.back.allPolygons())),a},a.prototype.debug=function(){},a.prototype.build=function(b){if(b.length){this.plane||(this.plane=b[0].plane.clone());for(var c=[],d=[],e=0;e<b.length;e++)this.plane.splitPolygon(b[e],this.polygons,this.polygons,c,d);c.length&&(this.front||(this.front=new a),this.front.build(c)),d.length&&(this.back||(this.back=new a),this.back.build(d))}},a}(),g=function(){function d(){this.polygons=new Array,this.matrix=a.Matrix.Identity(),this.position=new a.Vector3(0,0,0),this.rotation=new a.Vector3(0,0,0),this.scaling=new a.Vector3(1,1,1)}return d.FromMesh=function(f){var g,h,i,j,k,l,m=[];if(!(f instanceof a.Mesh))throw"BABYLON.CSG: Wrong Mesh type, must be BABYLON.Mesh";f.computeWorldMatrix(!0);for(var n=f.getWorldMatrix(),o=f.position.clone(),p=f.rotation.clone(),q=f.scaling.clone(),r=f.getIndices(),s=f.getVerticesData(a.VertexBuffer.PositionKind),t=f.getVerticesData(a.VertexBuffer.NormalKind),u=f.getVerticesData(a.VertexBuffer.UVKind),v=f.subMeshes,w=v.length-1;w>=0;w--)for(var x=v[w].indexStart,y=v[w].indexCount+v[w].indexStart;y>x;x+=3){l=[];for(var z=0;3>z;z++)h=new a.Vector3(t[3*r[x+z]],t[3*r[x+z]+1],t[3*r[x+z]+2]),i=new a.Vector2(u[2*r[x+z]],u[2*r[x+z]+1]),j=new a.Vector3(s[3*r[x+z]],s[3*r[x+z]+1],s[3*r[x+z]+2]),a.Vector3.TransformCoordinatesToRef(j,n,j),a.Vector3.TransformNormalToRef(h,n,h),g=new c(j,h,i),l.push(g);k=new e(l,{subMeshId:w,meshId:b,materialIndex:v[w].materialIndex,objectInstance:v[w].objectInstance,boundingBox:v[w].boundingBox}),k.plane&&m.push(k)}var A=d.FromPolygons(m);return A.matrix=n,A.position=o,A.rotation=p,A.scaling=q,b++,A},d.FromPolygons=function(b){var c=new a.CSG;return c.polygons=b,c},d.prototype.clone=function(){var b=new a.CSG;return b.polygons=this.polygons.map(function(a){return a.clone()}),b.copyTransformAttributes(this),b},d.prototype.toPolygons=function(){return this.polygons},d.prototype.unionInPlace=function(a){var b=new f(this.polygons),c=new f(a.polygons);b.clipTo(c),c.clipTo(b),c.invert(),c.clipTo(b),c.invert(),b.build(c.allPolygons()),this.polygons=b.allPolygons()},d.prototype.union=function(a){var b=new f(this.clone().polygons),c=new f(a.clone().polygons);return b.clipTo(c),c.clipTo(b),c.invert(),c.clipTo(b),c.invert(),b.build(c.allPolygons()),d.FromPolygons(b.allPolygons()).copyTransformAttributes(this)},d.prototype.subtractInPlace=function(a){var b=new f(this.polygons),c=new f(a.polygons);b.invert(),b.clipTo(c),c.clipTo(b),c.invert(),c.clipTo(b),c.invert(),b.build(c.allPolygons()),b.invert(),this.polygons=b.allPolygons()},d.prototype.subtract=function(a){var b=new f(this.clone().polygons),c=new f(a.clone().polygons);return b.invert(),b.clipTo(c),c.clipTo(b),c.invert(),c.clipTo(b),c.invert(),b.build(c.allPolygons()),b.invert(),d.FromPolygons(b.allPolygons()).copyTransformAttributes(this)},d.prototype.intersectInPlace=function(a){var b=new f(this.polygons),c=new f(a.polygons);b.invert(),c.clipTo(b),c.invert(),b.clipTo(c),c.clipTo(b),b.build(c.allPolygons()),b.invert(),this.polygons=b.allPolygons()},d.prototype.intersect=function(a){var b=new f(this.clone().polygons),c=new f(a.clone().polygons);return b.invert(),c.clipTo(b),c.invert(),b.clipTo(c),c.clipTo(b),b.build(c.allPolygons()),b.invert(),d.FromPolygons(b.allPolygons()).copyTransformAttributes(this)},d.prototype.inverseInPlace=function(){this.polygons.map(function(a){a.flip()})},d.prototype.inverse=function(){var a=this.clone();return a.polygons.map(function(a){a.flip()}),a},d.prototype.copyTransformAttributes=function(a){return this.matrix=a.matrix,this.position=a.position,this.rotation=a.rotation,this.scaling=a.scaling,this},d.prototype.buildMeshGeometry=function(b,c,d){var e=this.matrix.clone();e.invert();var f,g,h,i=new a.Mesh(b,c),j=[],k=[],l=[],m=[],n=a.Vector3.Zero(),o=a.Vector3.Zero(),p=a.Vector2.Zero(),q=this.polygons,r=[0,0,0],s={},t=0,u={};d&&q.sort(function(a,b){return a.shared.meshId===b.shared.meshId?a.shared.subMeshId-b.shared.subMeshId:a.shared.meshId-b.shared.meshId});for(var v=0,w=q.length;w>v;v++){f=q[v],u[f.shared.meshId]||(u[f.shared.meshId]={}),u[f.shared.meshId][f.shared.subMeshId]||(u[f.shared.meshId][f.shared.subMeshId]={indexStart:1/0,indexEnd:-1/0,materialIndex:f.shared.materialIndex,objectInstance:f.shared.objectInstance,boundingBox:f.shared.boundingBox}),h=u[f.shared.meshId][f.shared.subMeshId];for(var x=2,y=f.vertices.length;y>x;x++){r[0]=0,r[1]=x-1,r[2]=x;for(var z=0;3>z;z++)n.copyFrom(f.vertices[r[z]].pos),o.copyFrom(f.vertices[r[z]].normal),p.copyFrom(f.vertices[r[z]].uv),a.Vector3.TransformCoordinatesToRef(n,e,n),a.Vector3.TransformNormalToRef(o,e,o),g=s[n.x+","+n.y+","+n.z],("undefined"==typeof g||l[3*g]!==o.x||l[3*g+1]!==o.y||l[3*g+2]!==o.z||m[2*g]!==p.x||m[2*g+1]!==p.y)&&(j.push(n.x,n.y,n.z),m.push(p.x,p.y),l.push(o.x,o.y,o.z),g=s[n.x+","+n.y+","+n.z]=j.length/3-1),k.push(g),h.indexStart=Math.min(t,h.indexStart),h.indexEnd=Math.max(t,h.indexEnd),t++}}if(i.setVerticesData(a.VertexBuffer.PositionKind,j),i.setVerticesData(a.VertexBuffer.NormalKind,l),i.setVerticesData(a.VertexBuffer.UVKind,m),i.setIndices(k),d){var A,B=0;i.subMeshes=[];for(var C in u){A=-1;for(var D in u[C]){h=u[C][D];var E=a.SubMesh.CreateFromIndices(h.materialIndex+B,h.indexStart,h.indexEnd-h.indexStart+1,i);E.objectInstance=h.objectInstance,E.boundingBox=h.boundingBox,A=Math.max(h.materialIndex,A)}B+=++A}}return i},d.prototype.toMesh=function(a,b,c,d){var e=this.buildMeshGeometry(a,c,d);return e.material=b,e.position.copyFrom(this.position),e.rotation.copyFrom(this.rotation),e.scaling.copyFrom(this.scaling),e.computeWorldMatrix(!0),e},d}();a.CSG=g}(BABYLON||(BABYLON={}));var __extends=this.__extends||function(a,b){function c(){this.constructor=a}for(var d in b)b.hasOwnProperty(d)&&(a[d]=b[d]);c.prototype=b.prototype,a.prototype=new c},BABYLON;!function(a){var b=function(b){function c(c,d,e,f){var g=this;b.call(this,c,"oculusDistortionCorrection",["LensCenter","Scale","ScaleIn","HmdWarpParam"],null,f.PostProcessScaleFactor,d,a.Texture.BILINEAR_SAMPLINGMODE,null,null),this._isRightEye=e,this._distortionFactors=f.DistortionK,this._postProcessScaleFactor=f.PostProcessScaleFactor,this._lensCenterOffset=f.LensCenterOffset,this.onSizeChanged=function(){g.aspectRatio=.5*g.width/g.height,g._scaleIn=new a.Vector2(2,2/g.aspectRatio),g._scaleFactor=new a.Vector2(.5*(1/g._postProcessScaleFactor),.5*(1/g._postProcessScaleFactor)*g.aspectRatio),g._lensCenter=new a.Vector2(g._isRightEye?.5-.5*g._lensCenterOffset:.5+.5*g._lensCenterOffset,.5)},this.onApply=function(a){a.setFloat2("LensCenter",g._lensCenter.x,g._lensCenter.y),a.setFloat2("Scale",g._scaleFactor.x,g._scaleFactor.y),a.setFloat2("ScaleIn",g._scaleIn.x,g._scaleIn.y),a.setFloat4("HmdWarpParam",g._distortionFactors[0],g._distortionFactors[1],g._distortionFactors[2],g._distortionFactors[3])}}return __extends(c,b),c}(a.PostProcess);a.OculusDistortionCorrectionPostProcess=b}(BABYLON||(BABYLON={}));var BABYLON;!function(a){!function(a){a[a.X=0]="X",a[a.Y=1]="Y",a[a.Z=2]="Z"}(a.JoystickAxis||(a.JoystickAxis={}));var b=(a.JoystickAxis,function(){function b(c){var d=this;this._leftJoystick=c?!0:!1,this._joystickIndex=b._globalJoystickIndex,b._globalJoystickIndex++,this._axisTargetedByLeftAndRight=0,this._axisTargetedByUpAndDown=1,this.reverseLeftRight=!1,this.reverseUpDown=!1,this._touches=new a.VirtualJoystick.Collection,this.deltaPosition=a.Vector3.Zero(),this._joystickSensibility=25,this._inversedSensibility=1/(this._joystickSensibility/1e3),this._rotationSpeed=25,this._inverseRotationSpeed=1/(this._rotationSpeed/1e3),this._rotateOnAxisRelativeToMesh=!1,b.vjCanvas||(window.addEventListener("resize",function(){b.vjCanvasWidth=window.innerWidth,b.vjCanvasHeight=window.innerHeight,b.vjCanvas.width=b.vjCanvasWidth,b.vjCanvas.height=b.vjCanvasHeight,b.halfWidth=b.vjCanvasWidth/2,b.halfHeight=b.vjCanvasHeight/2},!1),b.vjCanvas=document.createElement("canvas"),b.vjCanvasWidth=window.innerWidth,b.vjCanvasHeight=window.innerHeight,b.vjCanvas.width=window.innerWidth,b.vjCanvas.height=window.innerHeight,b.vjCanvas.style.width="100%",b.vjCanvas.style.height="100%",b.vjCanvas.style.position="absolute",b.vjCanvas.style.backgroundColor="transparent",b.vjCanvas.style.top="0px",b.vjCanvas.style.left="0px",b.vjCanvas.style.zIndex="5",b.vjCanvas.style.msTouchAction="none",b.vjCanvasContext=b.vjCanvas.getContext("2d"),b.vjCanvasContext.strokeStyle="#ffffff",b.vjCanvasContext.lineWidth=2,document.body.appendChild(b.vjCanvas)),b.halfWidth=b.vjCanvas.width/2,b.halfHeight=b.vjCanvas.height/2,this.pressed=!1,this._joystickColor="cyan",this._joystickPointerID=-1,this._joystickPointerPos=new a.Vector2(0,0),this._joystickPointerStartPos=new a.Vector2(0,0),this._deltaJoystickVector=new a.Vector2(0,0),b.vjCanvas.addEventListener("pointerdown",function(a){d._onPointerDown(a)},!1),b.vjCanvas.addEventListener("pointermove",function(a){d._onPointerMove(a)},!1),b.vjCanvas.addEventListener("pointerup",function(a){d._onPointerUp(a)},!1),b.vjCanvas.addEventListener("pointerout",function(a){d._onPointerUp(a)},!1),b.vjCanvas.addEventListener("contextmenu",function(a){a.preventDefault()},!1),requestAnimationFrame(function(){d._drawVirtualJoystick()})}return b.prototype.setJoystickSensibility=function(a){this._joystickSensibility=a,this._inversedSensibility=1/(this._joystickSensibility/1e3)},b.prototype._onPointerDown=function(a){var c;a.preventDefault(),c=this._leftJoystick===!0?a.clientX<b.halfWidth:a.clientX>b.halfWidth,c&&this._joystickPointerID<0?(this._joystickPointerID=a.pointerId,this._joystickPointerStartPos.x=a.clientX,this._joystickPointerStartPos.y=a.clientY,this._joystickPointerPos=this._joystickPointerStartPos.clone(),this._deltaJoystickVector.x=0,this._deltaJoystickVector.y=0,this.pressed=!0,this._touches.add(a.pointerId.toString(),a)):b._globalJoystickIndex<2&&this._action&&(this._action(),this._touches.add(a.pointerId.toString(),a))},b.prototype._onPointerMove=function(a){if(this._joystickPointerID==a.pointerId){this._joystickPointerPos.x=a.clientX,this._joystickPointerPos.y=a.clientY,this._deltaJoystickVector=this._joystickPointerPos.clone(),this._deltaJoystickVector=this._deltaJoystickVector.subtract(this._joystickPointerStartPos);var b=this.reverseLeftRight?-1:1,c=b*this._deltaJoystickVector.x/this._inversedSensibility;switch(this._axisTargetedByLeftAndRight){case 0:this.deltaPosition.x=Math.min(1,Math.max(-1,c));break;case 1:this.deltaPosition.y=Math.min(1,Math.max(-1,c));break;case 2:this.deltaPosition.z=Math.min(1,Math.max(-1,c))}var d=this.reverseUpDown?1:-1,e=d*this._deltaJoystickVector.y/this._inversedSensibility;switch(this._axisTargetedByUpAndDown){case 0:this.deltaPosition.x=Math.min(1,Math.max(-1,e));break;case 1:this.deltaPosition.y=Math.min(1,Math.max(-1,e));break;case 2:this.deltaPosition.z=Math.min(1,Math.max(-1,e))}}else this._touches.item(a.pointerId.toString())&&(this._touches.item(a.pointerId.toString()).x=a.clientX,this._touches.item(a.pointerId.toString()).y=a.clientY)},b.prototype._onPointerUp=function(a){this._clearCanvas(),this._joystickPointerID==a.pointerId&&(this._joystickPointerID=-1,this.pressed=!1),this._deltaJoystickVector.x=0,this._deltaJoystickVector.y=0,this._touches.remove(a.pointerId.toString())},b.prototype.setJoystickColor=function(a){this._joystickColor=a},b.prototype.setActionOnTouch=function(a){this._action=a},b.prototype.setAxisForLeftRight=function(a){switch(a){case 0:case 1:case 2:this._axisTargetedByLeftAndRight=a;break;default:this._axisTargetedByLeftAndRight=0}},b.prototype.setAxisForUpDown=function(a){switch(a){case 0:case 1:case 2:this._axisTargetedByUpAndDown=a;break;default:this._axisTargetedByUpAndDown=1}},b.prototype._clearCanvas=function(){this._leftJoystick?b.vjCanvasContext.clearRect(0,0,b.vjCanvasWidth/2,b.vjCanvasHeight):b.vjCanvasContext.clearRect(b.vjCanvasWidth/2,0,b.vjCanvasWidth,b.vjCanvasHeight)},b.prototype._drawVirtualJoystick=function(){var a=this;this.pressed&&(this._clearCanvas(),this._touches.forEach(function(c){c.pointerId===a._joystickPointerID?(b.vjCanvasContext.beginPath(),b.vjCanvasContext.strokeStyle=a._joystickColor,b.vjCanvasContext.lineWidth=6,b.vjCanvasContext.arc(a._joystickPointerStartPos.x,a._joystickPointerStartPos.y,40,0,2*Math.PI,!0),b.vjCanvasContext.stroke(),b.vjCanvasContext.beginPath(),b.vjCanvasContext.strokeStyle=a._joystickColor,b.vjCanvasContext.lineWidth=2,b.vjCanvasContext.arc(a._joystickPointerStartPos.x,a._joystickPointerStartPos.y,60,0,2*Math.PI,!0),b.vjCanvasContext.stroke(),b.vjCanvasContext.beginPath(),b.vjCanvasContext.strokeStyle=a._joystickColor,b.vjCanvasContext.arc(a._joystickPointerPos.x,a._joystickPointerPos.y,40,0,2*Math.PI,!0),b.vjCanvasContext.stroke()):(b.vjCanvasContext.beginPath(),b.vjCanvasContext.fillStyle="white",b.vjCanvasContext.beginPath(),b.vjCanvasContext.strokeStyle="red",b.vjCanvasContext.lineWidth=6,b.vjCanvasContext.arc(c.x,c.y,40,0,2*Math.PI,!0),b.vjCanvasContext.stroke())})),requestAnimationFrame(function(){a._drawVirtualJoystick()})},b.prototype.releaseCanvas=function(){b.vjCanvas&&(document.body.removeChild(b.vjCanvas),b.vjCanvas=null)},b._globalJoystickIndex=0,b}());a.VirtualJoystick=b}(BABYLON||(BABYLON={}));var BABYLON;!function(a){!function(a){var b=function(){function a(){this._count=0,this._collection=new Array}return a.prototype.Count=function(){return this._count},a.prototype.add=function(a,b){return void 0!=this._collection[a]?void 0:(this._collection[a]=b,++this._count)},a.prototype.remove=function(a){return void 0==this._collection[a]?void 0:(delete this._collection[a],--this._count)},a.prototype.item=function(a){return this._collection[a]},a.prototype.forEach=function(a){var b;for(b in this._collection)this._collection.hasOwnProperty(b)&&a(this._collection[b])},a}();a.Collection=b}(a.VirtualJoystick||(a.VirtualJoystick={})),a.VirtualJoystick}(BABYLON||(BABYLON={}));var __extends=this.__extends||function(a,b){function c(){this.constructor=a}for(var d in b)b.hasOwnProperty(d)&&(a[d]=b[d]);c.prototype=b.prototype,a.prototype=new c},BABYLON;!function(a){var b={HResolution:1280,VResolution:800,HScreenSize:.149759993,VScreenSize:.0935999975,VScreenCenter:.0467999987,EyeToScreenDistance:.0410000011,LensSeparationDistance:.063500002,InterpupillaryDistance:.064000003,DistortionK:[1,.219999999,.239999995,0],ChromaAbCorrection:[.995999992,-.00400000019,1.01400006,0],PostProcessScaleFactor:1.714605507808412,LensCenterOffset:.151976421},c=function(c){function d(d,e,f,g){c.call(this,d,e,f),this._workMatrix=new a.Matrix,this._actualUp=new a.Vector3(0,0,0),this._aspectRatioAspectRatio=b.HResolution/(2*b.VResolution),this._aspectRatioFov=2*Math.atan(b.PostProcessScaleFactor*b.VScreenSize/(2*b.EyeToScreenDistance));var h=b.HScreenSize/4-b.LensSeparationDistance/2,i=4*h/b.HScreenSize;this._hMatrix=a.Matrix.Translation(g?i:-i,0,0),this.viewport=new a.Viewport(g?0:.5,0,.5,1),this._preViewMatrix=a.Matrix.Translation(g?.5*b.InterpupillaryDistance:-.5*b.InterpupillaryDistance,0,0),new a.OculusDistortionCorrectionPostProcess("Oculus Distortion",this,!g,b)}return __extends(d,c),d.prototype.getProjectionMatrix=function(){return a.Matrix.PerspectiveFovLHToRef(this._aspectRatioFov,this._aspectRatioAspectRatio,this.minZ,this.maxZ,this._workMatrix),this._workMatrix.multiplyToRef(this._hMatrix,this._projectionMatrix),this._projectionMatrix},d.prototype._getViewMatrix=function(){return a.Matrix.RotationYawPitchRollToRef(this.rotation.y,this.rotation.x,this.rotation.z,this._cameraRotationMatrix),a.Vector3.TransformCoordinatesToRef(this._referencePoint,this._cameraRotationMatrix,this._transformedReferencePoint),a.Vector3.TransformNormalToRef(this.upVector,this._cameraRotationMatrix,this._actualUp),this.position.addToRef(this._transformedReferencePoint,this._currentTarget),a.Matrix.LookAtLHToRef(this.position,this._currentTarget,this._actualUp,this._workMatrix),this._workMatrix.multiplyToRef(this._preViewMatrix,this._viewMatrix),this._viewMatrix},d}(a.FreeCamera),d=function(a){function b(b,d,e){a.call(this,b,d,e),this._leftCamera=new c(b+"_left",d.clone(),e,!0),this._rightCamera=new c(b+"_right",d.clone(),e,!1),this.subCameras.push(this._leftCamera),this.subCameras.push(this._rightCamera),this._deviceOrientationHandler=this._onOrientationEvent.bind(this)}return __extends(b,a),b.prototype._update=function(){this._leftCamera.position.copyFrom(this.position),this._rightCamera.position.copyFrom(this.position),this._updateCamera(this._leftCamera),this._updateCamera(this._rightCamera),a.prototype._update.call(this)},b.prototype._updateCamera=function(a){a.minZ=this.minZ,a.maxZ=this.maxZ,a.rotation.x=this.rotation.x,a.rotation.y=this.rotation.y,a.rotation.z=this.rotation.z},b.prototype._onOrientationEvent=function(a){var b=a.alpha/180*Math.PI,c=a.beta/180*Math.PI,d=a.gamma/180*Math.PI;return this._offsetOrientation?(this.rotation.y+=b-this._offsetOrientation.yaw,this.rotation.x+=c-this._offsetOrientation.pitch,this.rotation.z+=this._offsetOrientation.roll-d,this._offsetOrientation.yaw=b,this._offsetOrientation.pitch=c,void(this._offsetOrientation.roll=d)):void(this._offsetOrientation={yaw:b,pitch:c,roll:d})},b.prototype.attachControl=function(b,c){a.prototype.attachControl.call(this,b,c),window.addEventListener("deviceorientation",this._deviceOrientationHandler)},b.prototype.detachControl=function(b){a.prototype.detachControl.call(this,b),window.removeEventListener("deviceorientation",this._deviceOrientationHandler)},b}(a.FreeCamera);a.OculusCamera=d}(BABYLON||(BABYLON={}));var __extends=this.__extends||function(a,b){function c(){this.constructor=a}for(var d in b)b.hasOwnProperty(d)&&(a[d]=b[d]);c.prototype=b.prototype,a.prototype=new c},BABYLON;!function(a){var b=function(b){function c(c,d,e){b.call(this,c,d,e),this._leftjoystick=new a.VirtualJoystick(!0),this._leftjoystick.setAxisForUpDown(2),this._leftjoystick.setAxisForLeftRight(0),this._leftjoystick.setJoystickSensibility(.15),this._rightjoystick=new a.VirtualJoystick(!1),this._rightjoystick.setAxisForUpDown(0),this._rightjoystick.setAxisForLeftRight(1),this._rightjoystick.reverseUpDown=!0,this._rightjoystick.setJoystickSensibility(.05),this._rightjoystick.setJoystickColor("yellow")}return __extends(c,b),c.prototype._checkInputs=function(){var b=a.Matrix.RotationYawPitchRoll(this.rotation.y,this.rotation.x,0),c=a.Vector3.TransformCoordinates(this._leftjoystick.deltaPosition,b);this.cameraDirection=this.cameraDirection.add(c),this.cameraRotation=this.cameraRotation.add(this._rightjoystick.deltaPosition),this._leftjoystick.pressed||(this._leftjoystick.deltaPosition=this._leftjoystick.deltaPosition.scale(.9)),this._rightjoystick.pressed||(this._rightjoystick.deltaPosition=this._rightjoystick.deltaPosition.scale(.9))},c.prototype.dispose=function(){this._leftjoystick.releaseCanvas()},c}(a.FreeCamera);a.VirtualJoysticksCamera=b}(BABYLON||(BABYLON={}));var __extends=this.__extends||function(a,b){function c(){this.constructor=a}for(var d in b)b.hasOwnProperty(d)&&(a[d]=b[d]);c.prototype=b.prototype,a.prototype=new c},BABYLON;!function(a){var b=function(b){function c(c,d,e,f){b.call(this,c,d),this._textures=new Array,this._floats=new Array,this._floatsArrays={},this._colors3=new Array,this._colors4=new Array,this._vectors2=new Array,this._vectors3=new Array,this._matrices=new Array,this._cachedWorldViewMatrix=new a.Matrix,this._shaderPath=e,f.needAlphaBlending=f.needAlphaBlending||!1,f.needAlphaTesting=f.needAlphaTesting||!1,f.attributes=f.attributes||["position","normal","uv"],f.uniforms=f.uniforms||["worldViewProjection"],f.samplers=f.samplers||[],this._options=f}return __extends(c,b),c.prototype.needAlphaBlending=function(){return this._options.needAlphaBlending},c.prototype.needAlphaTesting=function(){return this._options.needAlphaTesting},c.prototype._checkUniform=function(a){-1===this._options.uniforms.indexOf(a)&&this._options.uniforms.push(a)},c.prototype.setTexture=function(a,b){return-1===this._options.samplers.indexOf(a)&&this._options.samplers.push(a),this._textures[a]=b,this},c.prototype.setFloat=function(a,b){return this._checkUniform(a),this._floats[a]=b,this},c.prototype.setFloats=function(a,b){return this._checkUniform(a),this._floatsArrays[a]=b,this},c.prototype.setColor3=function(a,b){return this._checkUniform(a),this._colors3[a]=b,this},c.prototype.setColor4=function(a,b){return this._checkUniform(a),this._colors4[a]=b,this},c.prototype.setVector2=function(a,b){return this._checkUniform(a),this._vectors2[a]=b,this},c.prototype.setVector3=function(a,b){return this._checkUniform(a),this._vectors3[a]=b,this},c.prototype.setMatrix=function(a,b){return this._checkUniform(a),this._matrices[a]=b,this},c.prototype.isReady=function(){var a=this.getScene().getEngine();return this._effect=a.createEffect(this._shaderPath,this._options.attributes,this._options.uniforms,this._options.samplers,"",null,this.onCompiled,this.onError),this._effect.isReady()?!0:!1},c.prototype.bind=function(a){-1!==this._options.uniforms.indexOf("world")&&this._effect.setMatrix("world",a),-1!==this._options.uniforms.indexOf("view")&&this._effect.setMatrix("view",this.getScene().getViewMatrix()),-1!==this._options.uniforms.indexOf("worldView")&&(a.multiplyToRef(this.getScene().getViewMatrix(),this._cachedWorldViewMatrix),this._effect.setMatrix("worldView",this._cachedWorldViewMatrix)),-1!==this._options.uniforms.indexOf("projection")&&this._effect.setMatrix("projection",this.getScene().getProjectionMatrix()),-1!==this._options.uniforms.indexOf("worldViewProjection")&&this._effect.setMatrix("worldViewProjection",a.multiply(this.getScene().getTransformMatrix()));for(var b in this._textures)this._effect.setTexture(b,this._textures[b]);
for(b in this._floats)this._effect.setFloat(b,this._floats[b]);for(b in this._floatsArrays)this._effect.setArray(b,this._floatsArrays[b]);for(b in this._colors3)this._effect.setColor3(b,this._colors3[b]);for(b in this._colors4){var c=this._colors4[b];this._effect.setFloat4(b,c.r,c.g,c.b,c.a)}for(b in this._vectors2)this._effect.setVector2(b,this._vectors2[b]);for(b in this._vectors3)this._effect.setVector3(b,this._vectors3[b]);for(b in this._matrices)this._effect.setMatrix(b,this._matrices[b])},c.prototype.dispose=function(a){for(var c in this._textures)this._textures[c].dispose();this._textures=[],b.prototype.dispose.call(this,a)},c}(a.Material);a.ShaderMaterial=b}(BABYLON||(BABYLON={}));var BABYLON;!function(a){var b=function(){function b(){}return b.prototype.set=function(b,c){switch(c){case a.VertexBuffer.PositionKind:this.positions=b;break;case a.VertexBuffer.NormalKind:this.normals=b;break;case a.VertexBuffer.UVKind:this.uvs=b;break;case a.VertexBuffer.UV2Kind:this.uv2s=b;break;case a.VertexBuffer.ColorKind:this.colors=b;break;case a.VertexBuffer.MatricesIndicesKind:this.matricesIndices=b;break;case a.VertexBuffer.MatricesWeightsKind:this.matricesWeights=b}},b.prototype.applyToMesh=function(a,b){this._applyTo(a,b)},b.prototype.applyToGeometry=function(a,b){this._applyTo(a,b)},b.prototype.updateMesh=function(a){this._update(a)},b.prototype.updateGeometry=function(a){this._update(a)},b.prototype._applyTo=function(b,c){this.positions&&b.setVerticesData(a.VertexBuffer.PositionKind,this.positions,c),this.normals&&b.setVerticesData(a.VertexBuffer.NormalKind,this.normals,c),this.uvs&&b.setVerticesData(a.VertexBuffer.UVKind,this.uvs,c),this.uv2s&&b.setVerticesData(a.VertexBuffer.UV2Kind,this.uv2s,c),this.colors&&b.setVerticesData(a.VertexBuffer.ColorKind,this.colors,c),this.matricesIndices&&b.setVerticesData(a.VertexBuffer.MatricesIndicesKind,this.matricesIndices,c),this.matricesWeights&&b.setVerticesData(a.VertexBuffer.MatricesWeightsKind,this.matricesWeights,c),this.indices&&b.setIndices(this.indices)},b.prototype._update=function(b,c,d){this.positions&&b.updateVerticesData(a.VertexBuffer.PositionKind,this.positions,c,d),this.normals&&b.updateVerticesData(a.VertexBuffer.NormalKind,this.normals,c,d),this.uvs&&b.updateVerticesData(a.VertexBuffer.UVKind,this.uvs,c,d),this.uv2s&&b.updateVerticesData(a.VertexBuffer.UV2Kind,this.uv2s,c,d),this.colors&&b.updateVerticesData(a.VertexBuffer.ColorKind,this.colors,c,d),this.matricesIndices&&b.updateVerticesData(a.VertexBuffer.MatricesIndicesKind,this.matricesIndices,c,d),this.matricesWeights&&b.updateVerticesData(a.VertexBuffer.MatricesWeightsKind,this.matricesWeights,c,d),this.indices&&b.setIndices(this.indices)},b.prototype.transform=function(b){var c=a.Vector3.Zero();if(this.positions)for(var d=a.Vector3.Zero(),e=0;e<this.positions.length;e+=3)a.Vector3.FromArrayToRef(this.positions,e,d),a.Vector3.TransformCoordinatesToRef(d,b,c),this.positions[e]=c.x,this.positions[e+1]=c.y,this.positions[e+2]=c.z;if(this.normals){var f=a.Vector3.Zero();for(e=0;e<this.normals.length;e+=3)a.Vector3.FromArrayToRef(this.normals,e,f),a.Vector3.TransformNormalToRef(f,b,c),this.normals[e]=c.x,this.normals[e+1]=c.y,this.normals[e+2]=c.z}},b.prototype.merge=function(a){if(a.indices){this.indices||(this.indices=[]);for(var b=this.positions?this.positions.length/3:0,c=0;c<a.indices.length;c++)this.indices.push(a.indices[c]+b)}if(a.positions)for(this.positions||(this.positions=[]),c=0;c<a.positions.length;c++)this.positions.push(a.positions[c]);if(a.normals)for(this.normals||(this.normals=[]),c=0;c<a.normals.length;c++)this.normals.push(a.normals[c]);if(a.uvs)for(this.uvs||(this.uvs=[]),c=0;c<a.uvs.length;c++)this.uvs.push(a.uvs[c]);if(a.uv2s)for(this.uv2s||(this.uv2s=[]),c=0;c<a.uv2s.length;c++)this.uv2s.push(a.uv2s[c]);if(a.matricesIndices)for(this.matricesIndices||(this.matricesIndices=[]),c=0;c<a.matricesIndices.length;c++)this.matricesIndices.push(a.matricesIndices[c]);if(a.matricesWeights)for(this.matricesWeights||(this.matricesWeights=[]),c=0;c<a.matricesWeights.length;c++)this.matricesWeights.push(a.matricesWeights[c]);if(a.colors)for(this.colors||(this.colors=[]),c=0;c<a.colors.length;c++)this.colors.push(a.colors[c])},b.ExtractFromMesh=function(a){return b._ExtractFrom(a)},b.ExtractFromGeometry=function(a){return b._ExtractFrom(a)},b._ExtractFrom=function(b){var c=new a.VertexData;return b.isVerticesDataPresent(a.VertexBuffer.PositionKind)&&(c.positions=b.getVerticesData(a.VertexBuffer.PositionKind)),b.isVerticesDataPresent(a.VertexBuffer.NormalKind)&&(c.normals=b.getVerticesData(a.VertexBuffer.NormalKind)),b.isVerticesDataPresent(a.VertexBuffer.UVKind)&&(c.uvs=b.getVerticesData(a.VertexBuffer.UVKind)),b.isVerticesDataPresent(a.VertexBuffer.UV2Kind)&&(c.uv2s=b.getVerticesData(a.VertexBuffer.UV2Kind)),b.isVerticesDataPresent(a.VertexBuffer.ColorKind)&&(c.colors=b.getVerticesData(a.VertexBuffer.ColorKind)),b.isVerticesDataPresent(a.VertexBuffer.MatricesIndicesKind)&&(c.matricesIndices=b.getVerticesData(a.VertexBuffer.MatricesIndicesKind)),b.isVerticesDataPresent(a.VertexBuffer.MatricesWeightsKind)&&(c.matricesWeights=b.getVerticesData(a.VertexBuffer.MatricesWeightsKind)),c.indices=b.getIndices(),c},b.CreateBox=function(b){var c=[new a.Vector3(0,0,1),new a.Vector3(0,0,-1),new a.Vector3(1,0,0),new a.Vector3(-1,0,0),new a.Vector3(0,1,0),new a.Vector3(0,-1,0)],d=[],e=[],f=[],g=[];b=b||1;for(var h=0;h<c.length;h++){var i=c[h],j=new a.Vector3(i.y,i.z,i.x),k=a.Vector3.Cross(i,j),l=e.length/3;d.push(l),d.push(l+1),d.push(l+2),d.push(l),d.push(l+2),d.push(l+3);var m=i.subtract(j).subtract(k).scale(b/2);e.push(m.x,m.y,m.z),f.push(i.x,i.y,i.z),g.push(1,1),m=i.subtract(j).add(k).scale(b/2),e.push(m.x,m.y,m.z),f.push(i.x,i.y,i.z),g.push(0,1),m=i.add(j).add(k).scale(b/2),e.push(m.x,m.y,m.z),f.push(i.x,i.y,i.z),g.push(0,0),m=i.add(j).subtract(k).scale(b/2),e.push(m.x,m.y,m.z),f.push(i.x,i.y,i.z),g.push(1,0)}var n=new a.VertexData;return n.indices=d,n.positions=e,n.normals=f,n.uvs=g,n},b.CreateSphere=function(b,c){b=b||32,c=c||1;for(var d=c/2,e=2+b,f=2*e,g=[],h=[],i=[],j=[],k=0;e>=k;k++){for(var l=k/e,m=l*Math.PI,n=0;f>=n;n++){var o=n/f,p=o*Math.PI*2,q=a.Matrix.RotationZ(-m),r=a.Matrix.RotationY(p),s=a.Vector3.TransformCoordinates(a.Vector3.Up(),q),t=a.Vector3.TransformCoordinates(s,r),u=t.scale(d),v=a.Vector3.Normalize(u);h.push(u.x,u.y,u.z),i.push(v.x,v.y,v.z),j.push(o,1-l)}if(k>0)for(var w=h.length/3,x=w-2*(f+1);w>x+f+2;x++)g.push(x),g.push(x+1),g.push(x+f+1),g.push(x+f+1),g.push(x+1),g.push(x+f+2)}var y=new a.VertexData;return y.indices=g,y.positions=h,y.normals=i,y.uvs=j,y},b.CreateCylinder=function(b,c,d,e,f,g){"undefined"==typeof f&&(f=1);var h=d/2,i=c/2,j=[],k=[],l=[],m=[];b=b||1,d=d||.5,c=c||1,e=e||16,f=f||1,f=1>f?1:f;for(var n=function(b){var c=2*b*Math.PI/e,d=Math.cos(c),f=Math.sin(c);return new a.Vector3(d,0,f)},o=function(c){var d=c?h:i;if(0!=d){var f=k.length/3,g=new a.Vector3(0,b/2,0),l=new a.Vector2(.5,.5);for(c||(g.scaleInPlace(-1),l.x=-l.x),r=0;e>r;r++){var o=n(r),p=o.scale(d).add(g),q=new a.Vector2(o.x*l.x+.5,o.z*l.y+.5);k.push(p.x,p.y,p.z),m.push(q.x,q.y)}for(var r=0;e-2>r;r++)c?(j.push(f),j.push(f+(r+1)%e),j.push(f+(r+2)%e)):(j.push(f),j.push(f+(r+2)%e),j.push(f+(r+1)%e))}},p=new a.Vector3(0,-1,0).scale(b/2),q=new a.Vector3(0,1,0).scale(b/f),r=e+1,s=0;e>=s;s++)for(var t,u=n(s),v=new a.Vector2(s/e,0),w=i,x=0;f>=x;x++)t=u.scale(w),t.addInPlace(p.add(q.scale(x))),v.y+=1/f,w+=(h-i)/f,k.push(t.x,t.y,t.z),m.push(v.x,v.y);f+=1;for(var x=0;f-1>x;x++)for(var s=0;e>=s;s++)j.push(s*f+x),j.push((s*f+(x+f))%(r*f)),j.push(s*f+(x+1)),j.push(s*f+(x+1)),j.push((s*f+(x+f))%(r*f)),j.push((s*f+(x+f+1))%(r*f));g&&(o(!0),o(!1)),a.VertexData.ComputeNormals(k,j,l);var y=new a.VertexData;return y.indices=j,y.positions=k,y.normals=l,y.uvs=m,y},b.CreateTorus=function(b,c,d){var e=[],f=[],g=[],h=[];b=b||1,c=c||.5,d=d||16;for(var i=d+1,j=0;d>=j;j++)for(var k=j/d,l=j*Math.PI*2/d-Math.PI/2,m=a.Matrix.Translation(b/2,0,0).multiply(a.Matrix.RotationY(l)),n=0;d>=n;n++){var o=1-n/d,p=n*Math.PI*2/d+Math.PI,q=Math.cos(p),r=Math.sin(p),s=new a.Vector3(q,r,0),t=s.scale(c/2),u=new a.Vector2(k,o);t=a.Vector3.TransformCoordinates(t,m),s=a.Vector3.TransformNormal(s,m),f.push(t.x,t.y,t.z),g.push(s.x,s.y,s.z),h.push(u.x,u.y);var v=(j+1)%i,w=(n+1)%i;e.push(j*i+n),e.push(j*i+w),e.push(v*i+n),e.push(j*i+w),e.push(v*i+w),e.push(v*i+n)}var x=new a.VertexData;return x.indices=e,x.positions=f,x.normals=g,x.uvs=h,x},b.CreateLines=function(b){for(var c=[],d=[],e=0;e<b.length;e++)d.push(b[e].x,b[e].y,b[e].z),e>0&&(c.push(e-1),c.push(e));var f=new a.VertexData;return f.indices=c,f.positions=d,f},b.CreateGround=function(b,c,d){var e,f,g=[],h=[],i=[],j=[];for(b=b||1,c=c||1,d=d||1,e=0;d>=e;e++)for(f=0;d>=f;f++){var k=new a.Vector3(f*b/d-b/2,0,(d-e)*c/d-c/2),l=new a.Vector3(0,1,0);h.push(k.x,k.y,k.z),i.push(l.x,l.y,l.z),j.push(f/d,1-e/d)}for(e=0;d>e;e++)for(f=0;d>f;f++)g.push(f+1+(e+1)*(d+1)),g.push(f+1+e*(d+1)),g.push(f+e*(d+1)),g.push(f+(e+1)*(d+1)),g.push(f+1+(e+1)*(d+1)),g.push(f+e*(d+1));var m=new a.VertexData;return m.indices=g,m.positions=h,m.normals=i,m.uvs=j,m},b.CreateTiledGround=function(b,c,d,e,f,g){function h(b,c,d,e){var f=n.length/3,h=g.w+1;for(i=0;i<g.h;i++)for(j=0;j<g.w;j++){var k=[f+j+i*h,f+(j+1)+i*h,f+(j+1)+(i+1)*h,f+j+(i+1)*h];m.push(k[1]),m.push(k[2]),m.push(k[3]),m.push(k[0]),m.push(k[1]),m.push(k[3])}var l=a.Vector3.Zero(),q=new a.Vector3(0,1,0);for(i=0;i<=g.h;i++)for(l.z=i*(e-c)/g.h+c,j=0;j<=g.w;j++)l.x=j*(d-b)/g.w+b,l.y=0,n.push(l.x,l.y,l.z),o.push(q.x,q.y,q.z),p.push(j/g.w,i/g.h)}"undefined"==typeof f&&(f={w:1,h:1}),"undefined"==typeof g&&(g={w:1,h:1});var i,j,k,l,m=[],n=[],o=[],p=[];f.h=f.w<1?1:f.h,f.w=f.w<1?1:f.w,g.w=g.w<1?1:g.w,g.h=g.h<1?1:g.h;var q={w:(d-b)/f.w,h:(e-c)/f.h};for(k=0;k<f.h;k++)for(l=0;l<f.w;l++)h(b+l*q.w,c+k*q.h,b+(l+1)*q.w,c+(k+1)*q.h);var r=new a.VertexData;return r.indices=m,r.positions=n,r.normals=o,r.uvs=p,r},b.CreateGroundFromHeightMap=function(b,c,d,e,f,g,h,i){var j,k,l=[],m=[],n=[],o=[];for(j=0;d>=j;j++)for(k=0;d>=k;k++){var p=new a.Vector3(k*b/d-b/2,0,(d-j)*c/d-c/2),q=(p.x+b/2)/b*(h-1)|0,r=(1-(p.z+c/2)/c)*(i-1)|0,s=4*(q+r*h),t=g[s]/255,u=g[s+1]/255,v=g[s+2]/255,w=.3*t+.59*u+.11*v;p.y=e+(f-e)*w,m.push(p.x,p.y,p.z),n.push(0,0,0),o.push(k/d,1-j/d)}for(j=0;d>j;j++)for(k=0;d>k;k++)l.push(k+1+(j+1)*(d+1)),l.push(k+1+j*(d+1)),l.push(k+j*(d+1)),l.push(k+(j+1)*(d+1)),l.push(k+1+(j+1)*(d+1)),l.push(k+j*(d+1));a.VertexData.ComputeNormals(m,l,n);var x=new a.VertexData;return x.indices=l,x.positions=m,x.normals=n,x.uvs=o,x},b.CreatePlane=function(b){var c=[],d=[],e=[],f=[];b=b||1;var g=b/2;d.push(-g,-g,0),e.push(0,0,-1),f.push(0,0),d.push(g,-g,0),e.push(0,0,-1),f.push(1,0),d.push(g,g,0),e.push(0,0,-1),f.push(1,1),d.push(-g,g,0),e.push(0,0,-1),f.push(0,1),c.push(0),c.push(1),c.push(2),c.push(0),c.push(2),c.push(3);var h=new a.VertexData;return h.indices=c,h.positions=d,h.normals=e,h.uvs=f,h},b.CreateTorusKnot=function(b,c,d,e,f,g){var h=[],i=[],j=[],k=[];b=b||2,c=c||.5,d=d||32,e=e||32,f=f||2,g=g||3;for(var l=function(c){var d=Math.cos(c),e=Math.sin(c),h=g/f*c,i=Math.cos(h),j=b*(2+i)*.5*d,k=b*(2+i)*e*.5,l=b*Math.sin(h)*.5;return new a.Vector3(j,k,l)},m=0;d>=m;m++){var n=m%d,o=n/d*2*f*Math.PI,p=l(o),q=l(o+.01),r=q.subtract(p),s=q.add(p),t=a.Vector3.Cross(r,s);s=a.Vector3.Cross(t,r),t.normalize(),s.normalize();for(var u=0;e>u;u++){var v=u%e,w=v/e*2*Math.PI,x=-c*Math.cos(w),y=c*Math.sin(w);i.push(p.x+x*s.x+y*t.x),i.push(p.y+x*s.y+y*t.y),i.push(p.z+x*s.z+y*t.z),k.push(m/d),k.push(u/e)}}for(m=0;d>m;m++)for(u=0;e>u;u++){var z=(u+1)%e,A=m*e+u,B=(m+1)*e+u,C=(m+1)*e+z,D=m*e+z;h.push(D),h.push(B),h.push(A),h.push(D),h.push(C),h.push(B)}a.VertexData.ComputeNormals(i,h,j);var E=new a.VertexData;return E.indices=h,E.positions=i,E.normals=j,E.uvs=k,E},b.ComputeNormals=function(b,c,d){var e,f=[],g=[];for(e=0;e<b.length;e+=3){var h=new a.Vector3(b[e],b[e+1],b[e+2]);f.push(h),g.push([])}var i=[];for(e=0;e<c.length/3;e++){var j=c[3*e],k=c[3*e+1],l=c[3*e+2],m=f[j],n=f[k],o=f[l],p=m.subtract(n),q=o.subtract(n);i[e]=a.Vector3.Normalize(a.Vector3.Cross(p,q)),g[j].push(e),g[k].push(e),g[l].push(e)}for(e=0;e<f.length;e++){for(var r=g[e],s=a.Vector3.Zero(),t=0;t<r.length;t++)s.addInPlace(i[r[t]]);s=a.Vector3.Normalize(s.scale(1/r.length)),d[3*e]=s.x,d[3*e+1]=s.y,d[3*e+2]=s.z}},b}();a.VertexData=b}(BABYLON||(BABYLON={}));var __extends=this.__extends||function(a,b){function c(){this.constructor=a}for(var d in b)b.hasOwnProperty(d)&&(a[d]=b[d]);c.prototype=b.prototype,a.prototype=new c},BABYLON;!function(a){var b=function(b,c){b._leftCamera.isIntermediate=!0,b.subCameras.push(b._leftCamera),b.subCameras.push(b._rightCamera),b._leftTexture=new a.PassPostProcess(c+"_leftTexture",1,b._leftCamera),b._anaglyphPostProcess=new a.AnaglyphPostProcess(c+"_anaglyph",1,b._rightCamera),b._anaglyphPostProcess.onApply=function(a){a.setTextureFromPostProcess("leftSampler",b._leftTexture)},b._update()},c=function(c){function d(d,e,f,g,h,i,j){c.call(this,d,e,f,g,h,j),this._eyeSpace=a.Tools.ToRadians(i),this._leftCamera=new a.ArcRotateCamera(d+"_left",e-this._eyeSpace,f,g,h,j),this._rightCamera=new a.ArcRotateCamera(d+"_right",e+this._eyeSpace,f,g,h,j),b(this,d)}return __extends(d,c),d.prototype._update=function(){this._updateCamera(this._leftCamera),this._updateCamera(this._rightCamera),this._leftCamera.alpha=this.alpha-this._eyeSpace,this._rightCamera.alpha=this.alpha+this._eyeSpace,c.prototype._update.call(this)},d.prototype._updateCamera=function(a){a.beta=this.beta,a.radius=this.radius,a.minZ=this.minZ,a.maxZ=this.maxZ,a.fov=this.fov,a.target=this.target},d}(a.ArcRotateCamera);a.AnaglyphArcRotateCamera=c;var d=function(c){function d(d,e,f,g){c.call(this,d,e,g),this._eyeSpace=a.Tools.ToRadians(f),this._transformMatrix=new a.Matrix,this._leftCamera=new a.FreeCamera(d+"_left",e.clone(),g),this._rightCamera=new a.FreeCamera(d+"_right",e.clone(),g),b(this,d)}return __extends(d,c),d.prototype._getSubCameraPosition=function(b,c){var d=this.getTarget();a.Matrix.Translation(-d.x,-d.y,-d.z).multiplyToRef(a.Matrix.RotationY(b),this._transformMatrix),this._transformMatrix=this._transformMatrix.multiply(a.Matrix.Translation(d.x,d.y,d.z)),a.Vector3.TransformCoordinatesToRef(this.position,this._transformMatrix,c)},d.prototype._update=function(){this._getSubCameraPosition(-this._eyeSpace,this._leftCamera.position),this._getSubCameraPosition(this._eyeSpace,this._rightCamera.position),this._updateCamera(this._leftCamera),this._updateCamera(this._rightCamera),c.prototype._update.call(this)},d.prototype._updateCamera=function(a){a.minZ=this.minZ,a.maxZ=this.maxZ,a.fov=this.fov,a.viewport=this.viewport,a.setTarget(this.getTarget())},d}(a.FreeCamera);a.AnaglyphFreeCamera=d}(BABYLON||(BABYLON={}));var __extends=this.__extends||function(a,b){function c(){this.constructor=a}for(var d in b)b.hasOwnProperty(d)&&(a[d]=b[d]);c.prototype=b.prototype,a.prototype=new c},BABYLON;!function(a){var b=function(a){function b(b,c,d,e,f,g){a.call(this,b,"anaglyph",null,["leftSampler"],c,d,e,f,g)}return __extends(b,a),b}(a.PostProcess);a.AnaglyphPostProcess=b}(BABYLON||(BABYLON={}));var BABYLON;!function(a){var b=function(){function b(){}return b.EnableFor=function(a){a._tags=a._tags||{},a.hasTags=function(){return b.HasTags(a)},a.addTags=function(c){return b.AddTagsTo(a,c)},a.removeTags=function(c){return b.RemoveTagsFrom(a,c)},a.matchesTagsQuery=function(c){return b.MatchesQuery(a,c)}},b.DisableFor=function(a){delete a._tags,delete a.hasTags,delete a.addTags,delete a.removeTags,delete a.matchesTagsQuery},b.HasTags=function(b){return b._tags?!a.Tools.IsEmpty(b._tags):!1},b.GetTags=function(a){return a._tags?a._tags:null},b.AddTagsTo=function(a,c){if(c){var d=c.split(" ");for(var e in d)b._AddTagTo(a,d[e])}},b._AddTagTo=function(a,c){c=c.trim(),""!==c&&"true"!==c&&"false"!==c&&(c.match(/[\s]/)||c.match(/^([!]|([|]|[&]){2})/)||(b.EnableFor(a),a._tags[c]=!0))},b.RemoveTagsFrom=function(a,c){if(b.HasTags(a)){var d=c.split(" ");for(var e in d)b._RemoveTagFrom(a,d[e])}},b._RemoveTagFrom=function(a,b){delete a._tags[b]},b.MatchesQuery=function(c,d){return void 0===d?!0:""===d?b.HasTags(c):a.Internals.AndOrNotEvaluator.Eval(d,function(a){return b.HasTags(c)&&c._tags[a]})},b}();a.Tags=b}(BABYLON||(BABYLON={}));var BABYLON;!function(a){!function(a){var b=function(){function a(){}return a.Eval=function(b,c){return b=b.match(/\([^\(\)]*\)/g)?b.replace(/\([^\(\)]*\)/g,function(b){return b=b.slice(1,b.length-1),a._HandleParenthesisContent(b,c)}):a._HandleParenthesisContent(b,c),"true"===b?!0:"false"===b?!1:a.Eval(b,c)},a._HandleParenthesisContent=function(b,c){c=c||function(a){return"true"===a?!0:!1};var d,e=b.split("||");for(var f in e){var g=a._SimplifyNegation(e[f].trim()),h=g.split("&&");if(h.length>1)for(var i=0;i<h.length;++i){var j=a._SimplifyNegation(h[i].trim());if(d="true"!==j&&"false"!==j?"!"===j[0]?!c(j.substring(1)):c(j):"true"===j?!0:!1,!d){g="false";break}}if(d||"true"===g){d=!0;break}d="true"!==g&&"false"!==g?"!"===g[0]?!c(g.substring(1)):c(g):"true"===g?!0:!1}return d?"true":"false"},a._SimplifyNegation=function(a){return a=a.replace(/^[\s!]+/,function(a){return a=a.replace(/[\s]/g,function(){return""}),a.length%2?"!":""}),a=a.trim(),"!true"===a?a="false":"!false"===a&&(a="true"),a},a}();a.AndOrNotEvaluator=b}(a.Internals||(a.Internals={})),a.Internals}(BABYLON||(BABYLON={}));var BABYLON;!function(a){var b=function(){function b(b,c,d,e,f,g){this._enabled=!0,this._refCount=0,this._name=c,this._renderTexture=new a.RenderTargetTexture(c,d,b),this.setRenderList(e),this._renderTexture.onBeforeRender=f,this._renderTexture.onAfterRender=g,this._scene=b}return b.prototype._incRefCount=function(){return 0===this._refCount&&this._scene.customRenderTargets.push(this._renderTexture),++this._refCount},b.prototype._decRefCount=function(){return this._refCount--,this._refCount<=0&&this._scene.customRenderTargets.splice(this._scene.customRenderTargets.indexOf(this._renderTexture),1),this._refCount},b.prototype._update=function(){this.setRenderList(this._renderList)},b.prototype.setRenderList=function(a){this._renderTexture.renderList=a},b.prototype.getRenderTexture=function(){return this._renderTexture},b}();a.PostProcessRenderPass=b}(BABYLON||(BABYLON={}));var BABYLON;!function(a){var b=function(){function b(a,b,c,d,e,f){this._engine=a,this._name=b,this._postProcessType=c,this._ratio=d||1,this._samplingMode=e||null,this._singleInstance=f||!0,this._cameras=[],this._postProcesses=[],this._indicesForCamera=[],this._renderPasses=[],this._renderEffectAsPasses=[],this.parameters=function(){}}return b._GetInstance=function(a,c,d,e){for(var f,g,h=[],i=b._GetParametersNames(c),j=0;j<i.length;j++)switch(i[j]){case"name":h[j]=c.toString();break;case"ratio":h[j]=d;break;case"camera":h[j]=null;break;case"samplingMode":h[j]=e;break;case"engine":h[j]=a;break;case"reusable":h[j]=!0;break;default:h[j]=null}return f=function(){},f.prototype=c.prototype,g=new f,c.apply(g,h),g},b._GetParametersNames=function(a){var b=/((\/\/.*$)|(\/\*[\s\S]*?\*\/))/gm,c=a.toString().replace(b,""),d=c.slice(c.indexOf("(")+1,c.indexOf(")")).match(/([^\s,]+)/g);return null===d&&(d=[]),d},b.prototype._update=function(){for(var a in this._renderPasses)this._renderPasses[a]._update()},b.prototype.addPass=function(a){this._renderPasses[a._name]=a,this._linkParameters()},b.prototype.removePass=function(a){delete this._renderPasses[a._name],this._linkParameters()},b.prototype.addRenderEffectAsPass=function(a){this._renderEffectAsPasses[a._name]=a,this._linkParameters()},b.prototype.getPass=function(a){for(var b in this._renderPasses)if(b===a)return this._renderPasses[a]},b.prototype.emptyPasses=function(){this._renderPasses.length=0,this._linkParameters()},b.prototype._attachCameras=function(c){for(var d,e=a.Tools.MakeArray(c||this._cameras),f=0;f<e.length;f++){var g=e[f],h=g.name;d=this._singleInstance?0:h,this._postProcesses[d]=this._postProcesses[d]||b._GetInstance(this._engine,this._postProcessType,this._ratio,this._samplingMode);var i=g.attachPostProcess(this._postProcesses[d]);null===this._indicesForCamera[h]&&(this._indicesForCamera[h]=[]),this._indicesForCamera[h].push(i),-1===this._cameras.indexOf(g)&&(this._cameras[h]=g);for(var j in this._renderPasses)this._renderPasses[j]._incRefCount()}this._linkParameters()},b.prototype._detachCameras=function(b){for(var c=a.Tools.MakeArray(b||this._cameras),d=0;d<c.length;d++){var e=c[d],f=e.name;e.detachPostProcess(this._postProcesses[this._singleInstance?0:f],this._indicesForCamera[f]);var g=this._cameras.indexOf(f);this._indicesForCamera.splice(g,1),this._cameras.splice(g,1);for(var h in this._renderPasses)this._renderPasses[h]._decRefCount()}},b.prototype._enable=function(b){for(var c=a.Tools.MakeArray(b||this._cameras),d=0;d<c.length;d++){for(var e=c[d],f=e.name,g=0;g<this._indicesForCamera[f].length;g++)void 0===e._postProcesses[this._indicesForCamera[f][g]]&&b[d].attachPostProcess(this._postProcesses[this._singleInstance?0:f],this._indicesForCamera[f][g]);for(var h in this._renderPasses)this._renderPasses[h]._incRefCount()}},b.prototype._disable=function(b){for(var c=a.Tools.MakeArray(b||this._cameras),d=0;d<c.length;d++){var e=c[d],f=e.Name;e.detachPostProcess(this._postProcesses[this._singleInstance?0:f],this._indicesForCamera[f]);for(var g in this._renderPasses)this._renderPasses[g]._decRefCount()}},b.prototype.getPostProcess=function(a){return this._singleInstance?this._postProcesses[0]:this._postProcesses[a.name]},b.prototype._linkParameters=function(){var a=this;for(var b in this._postProcesses)this._postProcesses[b].onApply=function(b){a.parameters(b),a._linkTextures(b)}},b.prototype._linkTextures=function(a){for(var b in this._renderPasses)a.setTexture(b,this._renderPasses[b].getRenderTexture());for(var c in this._renderEffectAsPasses)a.setTextureFromPostProcess(c+"Sampler",this._renderEffectAsPasses[c].getPostProcess())},b}();a.PostProcessRenderEffect=b}(BABYLON||(BABYLON={}));var BABYLON;!function(a){var b=function(){function b(a,b){this._engine=a,this._name=b,this._renderEffects=[],this._renderEffectsForIsolatedPass=[],this._cameras=[]}return b.prototype.addEffect=function(a){this._renderEffects[a._name]=a},b.prototype._enableEffect=function(b,c){var d=this._renderEffects[b];d&&d.enable(a.Tools.MakeArray(c||this._cameras))},b.prototype._disableEffect=function(b,c){var d=this._renderEffects[b];d&&d.disable(a.Tools.MakeArray(c||this._cameras))},b.prototype._attachCameras=function(b,c){for(var d=a.Tools.MakeArray(b||this._cameras),e=[],f=0;f<d.length;f++){var g=d[f],h=g.name;-1===this._cameras.indexOf(g)?this._cameras[h]=g:c&&e.push(f)}for(var f=0;f<e.length;f++)b.splice(e[f],1);for(var i in this._renderEffects)this._renderEffects[i]._attachCameras(d)},b.prototype._detachCameras=function(b){var c=a.Tools.MakeArray(b||this._cameras);for(var d in this._renderEffects)this._renderEffects[d]._detachCameras(c);for(var e=0;e<c.length;e++)this._cameras.splice(this._cameras.indexOf(c[e]),1)},b.prototype._enableDisplayOnlyPass=function(c,d){var e=a.Tools.MakeArray(d||this._cameras),f=null;for(var g in this._renderEffects)if(f=this._renderEffects[g].getPass(c),null!=f)break;if(null!==f){for(var g in this._renderEffects)this._renderEffects[g]._disable(e);f._name=b.PASS_SAMPLER_NAME;for(var h=0;h<e.length;h++){var i=e[h],j=i.name;this._renderEffectsForIsolatedPass[j]=this._renderEffectsForIsolatedPass[j]||new a.PostProcessRenderEffect(this._engine,b.PASS_EFFECT_NAME,"BABYLON.DisplayPassPostProcess",1,null,null),this._renderEffectsForIsolatedPass[j].emptyPasses(),this._renderEffectsForIsolatedPass[j].addPass(f),this._renderEffectsForIsolatedPass[j]._attachCameras(i)}}},b.prototype._disableDisplayOnlyPass=function(c){for(var d=a.Tools.MakeArray(c||this._cameras),e=0;e<d.length;e++){var f=d[e],g=f.name;this._renderEffectsForIsolatedPass[g]=this._renderEffectsForIsolatedPass[g]||new a.PostProcessRenderEffect(this._engine,b.PASS_EFFECT_NAME,"BABYLON.DisplayPassPostProcess",1,null,null),this._renderEffectsForIsolatedPass[g]._disable(f)}for(var h in this._renderEffects)this._renderEffects[h]._enable(d)},b.prototype._update=function(){for(var a in this._renderEffects)this._renderEffects[a]._update();for(var b=0;b<this._cameras.length;b++){var c=this._cameras[b].name;this._renderEffectsForIsolatedPass[c]&&this._renderEffectsForIsolatedPass[c]._update()}},b.PASS_EFFECT_NAME="passEffect",b.PASS_SAMPLER_NAME="passSampler",b}();a.PostProcessRenderPipeline=b}(BABYLON||(BABYLON={}));var BABYLON;!function(a){var b=function(){function a(){this._renderPipelines=[]}return a.prototype.addPipeline=function(a){this._renderPipelines[a._name]=a},a.prototype.attachCamerasToRenderPipeline=function(a,b,c){var d=this._renderPipelines[a];d&&d.attachCameras(b,c)},a.prototype.detachCamerasFromRenderPipeline=function(a,b){var c=this._renderPipelines[a];c&&c.detachCameras(b)},a.prototype.enableEffectInPipeline=function(a,b,c){var d=this._renderPipelines[a];d&&d.enableEffect(b,c)},a.prototype.disableEffectInPipeline=function(a,b,c){var d=this._renderPipelines[a];d&&d.disableEffect(b,c)},a.prototype.enableDisplayOnlyPassInPipeline=function(a,b,c){var d=this._renderPipelines[a];d&&d.enableDisplayOnlyPass(b,c)},a.prototype.disableDisplayOnlyPassInPipeline=function(a,b){var c=this._renderPipelines[a];c&&c.disableDisplayOnlyPass(b)},a.prototype.update=function(){for(var a in this._renderPipelines)this._renderPipelines[a]._update()},a}();a.PostProcessRenderPipelineManager=b}(BABYLON||(BABYLON={}));var __extends=this.__extends||function(a,b){function c(){this.constructor=a}for(var d in b)b.hasOwnProperty(d)&&(a[d]=b[d]);c.prototype=b.prototype,a.prototype=new c},BABYLON;!function(a){var b=function(a){function b(b,c,d,e,f,g){a.call(this,b,"displayPass",["passSampler"],["passSampler"],c,d,e,f,g)}return __extends(b,a),b}(a.PostProcess);a.DisplayPassPostProcess=b}(BABYLON||(BABYLON={}));var BABYLON;!function(a){var b=function(){function b(b){this.frontColor=new a.Color3(1,1,1),this.backColor=new a.Color3(.1,.1,.1),this.showBackLines=!0,this.renderList=new a.SmartArray(32),this._scene=b,this._colorShader=new a.ShaderMaterial("colorShader",b,"color",{attributes:["position"],uniforms:["worldViewProjection","color"]});var c=this._scene.getEngine(),d=a.VertexData.CreateBox(1);this._vb=new a.VertexBuffer(c,d.positions,a.VertexBuffer.PositionKind,!1),this._ib=c.createIndexBuffer([0,1,1,2,2,3,3,0,4,5,5,6,6,7,7,4,0,7,1,6,2,5,3,4])}return b.prototype.reset=function(){this.renderList.reset()},b.prototype.render=function(){if(0!=this.renderList.length&&this._colorShader.isReady()){var b=this._scene.getEngine();b.setDepthWrite(!1),this._colorShader._preBind();for(var c=0;c<this.renderList.length;c++){var d=this.renderList.data[c],e=d.minimum,f=d.maximum,g=f.subtract(e),h=e.add(g.scale(.5)),i=a.Matrix.Scaling(g.x,g.y,g.z).multiply(a.Matrix.Translation(h.x,h.y,h.z)).multiply(d.getWorldMatrix());b.bindBuffers(this._vb.getBuffer(),this._ib,[3],12,this._colorShader.getEffect()),this.showBackLines&&(b.setDepthFunctionToGreaterOrEqual(),this._colorShader.setColor3("color",this.backColor),this._colorShader.bind(i),b.draw(!1,0,24)),b.setDepthFunctionToLess(),this._colorShader.setColor3("color",this.frontColor),this._colorShader.bind(i),b.draw(!1,0,24)}this._colorShader.unbind(),b.setDepthFunctionToLessOrEqual(),b.setDepthWrite(!0)}},b.prototype.dispose=function(){this._colorShader.dispose(),this._vb.dispose(),this._scene.getEngine()._releaseBuffer(this._ib)},b}();a.BoundingBoxRenderer=b}(BABYLON||(BABYLON={}));var __extends=this.__extends||function(a,b){function c(){this.constructor=a}for(var d in b)b.hasOwnProperty(d)&&(a[d]=b[d]);c.prototype=b.prototype,a.prototype=new c},BABYLON;!function(a){var b=function(){function a(a){this._actionManager=a}return a.prototype.isValid=function(){return!0},a.prototype._getProperty=function(a){return this._actionManager._getProperty(a)},a.prototype._getEffectiveTarget=function(a,b){return this._actionManager._getEffectiveTarget(a,b)},a}();a.Condition=b;var c=function(a){function b(c,d,e,f,g){"undefined"==typeof g&&(g=b.IsEqual),a.call(this,c),this.propertyPath=e,this.value=f,this.operator=g,this._target=this._getEffectiveTarget(d,this.propertyPath),this._property=this._getProperty(this.propertyPath)}return __extends(b,a),Object.defineProperty(b,"IsEqual",{get:function(){return b._IsEqual},enumerable:!0,configurable:!0}),Object.defineProperty(b,"IsDifferent",{get:function(){return b._IsDifferent},enumerable:!0,configurable:!0}),Object.defineProperty(b,"IsGreater",{get:function(){return b._IsGreater},enumerable:!0,configurable:!0}),Object.defineProperty(b,"IsLesser",{get:function(){return b._IsLesser},enumerable:!0,configurable:!0}),b.prototype.isValid=function(){switch(this.operator){case b.IsGreater:return this._target[this._property]>this.value;case b.IsLesser:return this._target[this._property]<this.value;case b.IsEqual:case b.IsDifferent:var a;return a=this.value.equals?this.value.equals(this._target[this._property]):this.value===this._target[this._property],this.operator===b.IsEqual?a:!a}return!1},b._IsEqual=0,b._IsDifferent=1,b._IsGreater=2,b._IsLesser=3,b}(b);a.ValueCondition=c;var d=function(a){function b(b,c){a.call(this,b),this.predicate=c}return __extends(b,a),b.prototype.isValid=function(){return this.predicate()},b}(b);a.PredicateCondition=d;var e=function(a){function b(b,c,d){a.call(this,b),this.value=d,this._target=c}return __extends(b,a),b.prototype.isValid=function(){return this._target.state===this.value},b}(b);a.StateCondition=e}(BABYLON||(BABYLON={}));var BABYLON;!function(a){var b=function(){function a(a,b){this.triggerOptions=a,a.parameter?(this.trigger=a.trigger,this._triggerParameter=a.parameter):this.trigger=a,this._nextActiveAction=this,this._condition=b}return a.prototype._prepare=function(){},a.prototype.getTriggerParameter=function(){return this._triggerParameter},a.prototype._executeCurrent=function(a){if(this._condition){var b=this._actionManager.getScene().getRenderId();if(this._condition._evaluationId===b){if(!this._condition._currentResult)return}else{if(this._condition._evaluationId=b,!this._condition.isValid())return void(this._condition._currentResult=!1);this._condition._currentResult=!0}}this._nextActiveAction.execute(a),this._nextActiveAction=this._nextActiveAction._child?this._nextActiveAction._child:this},a.prototype.execute=function(){},a.prototype.then=function(a){return this._child=a,a._actionManager=this._actionManager,a._prepare(),a},a.prototype._getProperty=function(a){return this._actionManager._getProperty(a)},a.prototype._getEffectiveTarget=function(a,b){return this._actionManager._getEffectiveTarget(a,b)},a}();a.Action=b}(BABYLON||(BABYLON={}));var BABYLON;!function(a){var b=function(){function a(a,b,c,d){this.source=a,this.pointerX=b,this.pointerY=c,this.meshUnderPointer=d}return a.CreateNew=function(b){var c=b.getScene();return new a(b,c.pointerX,c.pointerY,c.meshUnderPointer)},a}();a.ActionEvent=b;var c=function(){function b(a){this.actions=new Array,this._scene=a,a._actionManagers.push(this)}return Object.defineProperty(b,"NothingTrigger",{get:function(){return b._NothingTrigger},enumerable:!0,configurable:!0}),Object.defineProperty(b,"OnPickTrigger",{get:function(){return b._OnPickTrigger},enumerable:!0,configurable:!0}),Object.defineProperty(b,"OnLeftPickTrigger",{get:function(){return b._OnLeftPickTrigger},enumerable:!0,configurable:!0}),Object.defineProperty(b,"OnRightPickTrigger",{get:function(){return b._OnRightPickTrigger},enumerable:!0,configurable:!0}),Object.defineProperty(b,"OnCenterPickTrigger",{get:function(){return b._OnCenterPickTrigger},enumerable:!0,configurable:!0}),Object.defineProperty(b,"OnPointerOverTrigger",{get:function(){return b._OnPointerOverTrigger},enumerable:!0,configurable:!0}),Object.defineProperty(b,"OnPointerOutTrigger",{get:function(){return b._OnPointerOutTrigger},enumerable:!0,configurable:!0}),Object.defineProperty(b,"OnEveryFrameTrigger",{get:function(){return b._OnEveryFrameTrigger},enumerable:!0,configurable:!0}),Object.defineProperty(b,"OnIntersectionEnterTrigger",{get:function(){return b._OnIntersectionEnterTrigger
},enumerable:!0,configurable:!0}),Object.defineProperty(b,"OnIntersectionExitTrigger",{get:function(){return b._OnIntersectionExitTrigger},enumerable:!0,configurable:!0}),b.prototype.dispose=function(){var a=this._scene._actionManagers.indexOf(this);a>-1&&this._scene._actionManagers.splice(a,1)},b.prototype.getScene=function(){return this._scene},b.prototype.hasSpecificTriggers=function(a){for(var b=0;b<this.actions.length;b++){var c=this.actions[b];if(a.indexOf(c.trigger)>-1)return!0}return!1},Object.defineProperty(b.prototype,"hasPointerTriggers",{get:function(){for(var a=0;a<this.actions.length;a++){var c=this.actions[a];if(c.trigger>=b._OnPickTrigger&&c.trigger<=b._OnPointerOutTrigger)return!0}return!1},enumerable:!0,configurable:!0}),Object.defineProperty(b.prototype,"hasPickTriggers",{get:function(){for(var a=0;a<this.actions.length;a++){var c=this.actions[a];if(c.trigger>=b._OnPickTrigger&&c.trigger<=b._OnCenterPickTrigger)return!0}return!1},enumerable:!0,configurable:!0}),b.prototype.registerAction=function(c){return c.trigger===b.OnEveryFrameTrigger&&this.getScene().actionManager!==this?(a.Tools.Warn("OnEveryFrameTrigger can only be used with scene.actionManager"),null):(this.actions.push(c),c._actionManager=this,c._prepare(),c)},b.prototype.processTrigger=function(a,b){for(var c=0;c<this.actions.length;c++){var d=this.actions[c];d.trigger===a&&d._executeCurrent(b)}},b.prototype._getEffectiveTarget=function(a,b){for(var c=b.split("."),d=0;d<c.length-1;d++)a=a[c[d]];return a},b.prototype._getProperty=function(a){var b=a.split(".");return b[b.length-1]},b._NothingTrigger=0,b._OnPickTrigger=1,b._OnLeftPickTrigger=2,b._OnRightPickTrigger=3,b._OnCenterPickTrigger=4,b._OnPointerOverTrigger=5,b._OnPointerOutTrigger=6,b._OnEveryFrameTrigger=7,b._OnIntersectionEnterTrigger=8,b._OnIntersectionExitTrigger=9,b}();a.ActionManager=c}(BABYLON||(BABYLON={}));var __extends=this.__extends||function(a,b){function c(){this.constructor=a}for(var d in b)b.hasOwnProperty(d)&&(a[d]=b[d]);c.prototype=b.prototype,a.prototype=new c},BABYLON;!function(a){var b=function(b){function c(a,c,d,e,f,g,h){"undefined"==typeof f&&(f=1e3),b.call(this,a,g),this.propertyPath=d,this.value=e,this.duration=f,this.stopOtherAnimations=h,this._target=c}return __extends(c,b),c.prototype._prepare=function(){this._target=this._getEffectiveTarget(this._target,this.propertyPath),this._property=this._getProperty(this.propertyPath)},c.prototype.execute=function(){var b,c=this._actionManager.getScene(),d=[{frame:0,value:this._target[this._property]},{frame:100,value:this.value}];if("number"==typeof this.value)b=a.Animation.ANIMATIONTYPE_FLOAT;else if(this.value instanceof a.Color3)b=a.Animation.ANIMATIONTYPE_COLOR3;else if(this.value instanceof a.Vector3)b=a.Animation.ANIMATIONTYPE_VECTOR3;else if(this.value instanceof a.Matrix)b=a.Animation.ANIMATIONTYPE_MATRIX;else{if(!(this.value instanceof a.Quaternion))return void a.Tools.Warn("InterpolateValueAction: Unsupported type ("+typeof this.value+")");b=a.Animation.ANIMATIONTYPE_QUATERNION}var e=new a.Animation("InterpolateValueAction",this._property,100*(1e3/this.duration),b,a.Animation.ANIMATIONLOOPMODE_CONSTANT);e.setKeys(d),this.stopOtherAnimations&&c.stopAnimation(this._target),c.beginDirectAnimation(this._target,[e],0,100)},c}(a.Action);a.InterpolateValueAction=b}(BABYLON||(BABYLON={}));var __extends=this.__extends||function(a,b){function c(){this.constructor=a}for(var d in b)b.hasOwnProperty(d)&&(a[d]=b[d]);c.prototype=b.prototype,a.prototype=new c},BABYLON;!function(a){var b=function(a){function b(b,c,d,e){a.call(this,b,e),this.propertyPath=d,this._target=c}return __extends(b,a),b.prototype._prepare=function(){this._target=this._getEffectiveTarget(this._target,this.propertyPath),this._property=this._getProperty(this.propertyPath)},b.prototype.execute=function(){this._target[this._property]=!this._target[this._property]},b}(a.Action);a.SwitchBooleanAction=b;var c=function(a){function b(b,c,d,e){a.call(this,b,e),this.value=d,this._target=c}return __extends(b,a),b.prototype.execute=function(){this._target.state=this.value},b}(a.Action);a.SetStateAction=c;var d=function(a){function b(b,c,d,e,f){a.call(this,b,f),this.propertyPath=d,this.value=e,this._target=c}return __extends(b,a),b.prototype._prepare=function(){this._target=this._getEffectiveTarget(this._target,this.propertyPath),this._property=this._getProperty(this.propertyPath)},b.prototype.execute=function(){this._target[this._property]=this.value},b}(a.Action);a.SetValueAction=d;var e=function(b){function c(a,c,d,e,f){b.call(this,a,f),this.propertyPath=d,this.value=e,this._target=c}return __extends(c,b),c.prototype._prepare=function(){this._target=this._getEffectiveTarget(this._target,this.propertyPath),this._property=this._getProperty(this.propertyPath),"number"!=typeof this._target[this._property]&&a.Tools.Warn("Warning: IncrementValueAction can only be used with number values")},c.prototype.execute=function(){this._target[this._property]+=this.value},c}(a.Action);a.IncrementValueAction=e;var f=function(a){function b(b,c,d,e,f,g){a.call(this,b,g),this.from=d,this.to=e,this.loop=f,this._target=c}return __extends(b,a),b.prototype._prepare=function(){},b.prototype.execute=function(){var a=this._actionManager.getScene();a.beginAnimation(this._target,this.from,this.to,this.loop)},b}(a.Action);a.PlayAnimationAction=f;var g=function(a){function b(b,c,d){a.call(this,b,d),this._target=c}return __extends(b,a),b.prototype._prepare=function(){},b.prototype.execute=function(){var a=this._actionManager.getScene();a.stopAnimation(this._target)},b}(a.Action);a.StopAnimationAction=g;var h=function(b){function c(c,d){"undefined"==typeof c&&(c=a.ActionManager.NothingTrigger),b.call(this,c,d)}return __extends(c,b),c.prototype.execute=function(){},c}(a.Action);a.DoNothingAction=h;var i=function(a){function b(b,c,d){a.call(this,b,d),this.children=c}return __extends(b,a),b.prototype._prepare=function(){for(var a=0;a<this.children.length;a++)this.children[a]._actionManager=this._actionManager,this.children[a]._prepare()},b.prototype.execute=function(a){for(var b=0;b<this.children.length;b++)this.children[b].execute(a)},b}(a.Action);a.CombineAction=i;var j=function(a){function b(b,c,d){a.call(this,b,d),this.func=c}return __extends(b,a),b.prototype.execute=function(a){this.func(a)},b}(a.Action);a.ExecuteCodeAction=j;var k=function(b){function c(a,c,d,e){b.call(this,a,e),this._target=c,this._parent=d}return __extends(c,b),c.prototype._prepare=function(){},c.prototype.execute=function(){if(this._target.parent!==this._parent){var b=this._parent.getWorldMatrix().clone();b.invert(),this._target.position=a.Vector3.TransformCoordinates(this._target.position,b),this._target.parent=this._parent}},c}(a.Action);a.SetParentAction=k}(BABYLON||(BABYLON={}));var __extends=this.__extends||function(a,b){function c(){this.constructor=a}for(var d in b)b.hasOwnProperty(d)&&(a[d]=b[d]);c.prototype=b.prototype,a.prototype=new c},BABYLON;!function(a){var b=function(){function b(b,c,d,e,f){this.delayLoadState=a.Engine.DELAYLOADSTATE_NONE,this._totalVertices=0,this._indices=[],this.id=b,this._engine=c.getEngine(),this._meshes=[],this._scene=c,d?this.setAllVerticesData(d,e):(this._totalVertices=0,this._indices=[]),f&&this.applyToMesh(f)}return b.prototype.getScene=function(){return this._scene},b.prototype.getEngine=function(){return this._engine},b.prototype.isReady=function(){return this.delayLoadState===a.Engine.DELAYLOADSTATE_LOADED||this.delayLoadState===a.Engine.DELAYLOADSTATE_NONE},b.prototype.setAllVerticesData=function(a,b){a.applyToGeometry(this,b)},b.prototype.setVerticesData=function(b,c,d){if(this._vertexBuffers=this._vertexBuffers||{},this._vertexBuffers[b]&&this._vertexBuffers[b].dispose(),this._vertexBuffers[b]=new a.VertexBuffer(this._engine,c,b,d,0===this._meshes.length),b===a.VertexBuffer.PositionKind){var e=this._vertexBuffers[b].getStrideSize();this._totalVertices=c.length/e;for(var f=a.Tools.ExtractMinAndMax(c,0,this._totalVertices),g=this._meshes,h=g.length,i=0;h>i;i++){var j=g[i];j._resetPointsArrayCache(),j._boundingInfo=new a.BoundingInfo(f.minimum,f.maximum),j._createGlobalSubMesh(),j.computeWorldMatrix(!0)}}},b.prototype.updateVerticesData=function(b,c,d){var e=this.getVertexBuffer(b);if(e&&(e.update(c),b===a.VertexBuffer.PositionKind)){var f;if(d){var g=e.getStrideSize();this._totalVertices=c.length/g,f=a.Tools.ExtractMinAndMax(c,0,this._totalVertices)}for(var h=this._meshes,i=h.length,j=0;i>j;j++){var k=h[j];k._resetPointsArrayCache(),d&&(k._boundingInfo=new a.BoundingInfo(f.minimum,f.maximum))}}},b.prototype.getTotalVertices=function(){return this.isReady()?this._totalVertices:0},b.prototype.getVerticesData=function(a){var b=this.getVertexBuffer(a);return b?b.getData():null},b.prototype.getVertexBuffer=function(a){return this.isReady()?this._vertexBuffers[a]:null},b.prototype.getVertexBuffers=function(){return this.isReady()?this._vertexBuffers:null},b.prototype.isVerticesDataPresent=function(a){return this._vertexBuffers?void 0!==this._vertexBuffers[a]:this._delayInfo?-1!==this._delayInfo.indexOf(a):!1},b.prototype.getVerticesDataKinds=function(){var a=[];if(!this._vertexBuffers&&this._delayInfo)for(var b in this._delayInfo)a.push(b);else for(b in this._vertexBuffers)a.push(b);return a},b.prototype.setIndices=function(a){this._indexBuffer&&this._engine._releaseBuffer(this._indexBuffer),this._indices=a,0!==this._meshes.length&&this._indices&&(this._indexBuffer=this._engine.createIndexBuffer(this._indices));for(var b=this._meshes,c=b.length,d=0;c>d;d++)b[d]._createGlobalSubMesh()},b.prototype.getTotalIndices=function(){return this.isReady()?this._indices.length:0},b.prototype.getIndices=function(){return this.isReady()?this._indices:null},b.prototype.getIndexBuffer=function(){return this.isReady()?this._indexBuffer:null},b.prototype.releaseForMesh=function(a,b){var c=this._meshes,d=c.indexOf(a);if(-1!==d){for(var e in this._vertexBuffers)this._vertexBuffers[e].dispose();this._indexBuffer&&this._engine._releaseBuffer(this._indexBuffer)&&(this._indexBuffer=null),c.splice(d,1),a._geometry=null,0==c.length&&b&&this.dispose()}},b.prototype.applyToMesh=function(a){if(a._geometry!==this){var b=a._geometry;b&&b.releaseForMesh(a);var c=this._meshes;a._geometry=this,this._scene.pushGeometry(this),c.push(a),this.isReady()?this._applyToMesh(a):a._boundingInfo=this._boundingInfo}},b.prototype._applyToMesh=function(b){var c=this._meshes.length;for(var d in this._vertexBuffers)if(1===c&&this._vertexBuffers[d].create(),this._vertexBuffers[d]._buffer.references=c,d===a.VertexBuffer.PositionKind){b._resetPointsArrayCache();var e=a.Tools.ExtractMinAndMax(this._vertexBuffers[d].getData(),0,this._totalVertices);b._boundingInfo=new a.BoundingInfo(e.minimum,e.maximum),b._createGlobalSubMesh()}1===c&&this._indices&&(this._indexBuffer=this._engine.createIndexBuffer(this._indices)),this._indexBuffer&&(this._indexBuffer.references=c)},b.prototype.load=function(b,c){var d=this;if(this.delayLoadState!==a.Engine.DELAYLOADSTATE_LOADING){if(this.isReady())return void(c&&c());this.delayLoadState=a.Engine.DELAYLOADSTATE_LOADING,b._addPendingData(this),a.Tools.LoadFile(this.delayLoadingFile,function(e){d._delayLoadingFunction(JSON.parse(e),d),d.delayLoadState=a.Engine.DELAYLOADSTATE_LOADED,d._delayInfo=[],b._removePendingData(d);for(var f=d._meshes,g=f.length,h=0;g>h;h++)d._applyToMesh(f[h]);c&&c()},function(){},b.database)}},b.prototype.dispose=function(){for(var b=this._meshes,c=b.length,d=0;c>d;d++)this.releaseForMesh(b[d]);this._meshes=[];for(var e in this._vertexBuffers)this._vertexBuffers[e].dispose();this._vertexBuffers=[],this._totalVertices=0,this._indexBuffer&&this._engine._releaseBuffer(this._indexBuffer),this._indexBuffer=null,this._indices=[],this.delayLoadState=a.Engine.DELAYLOADSTATE_NONE,this.delayLoadingFile=null,this._delayLoadingFunction=null,this._delayInfo=[],this._boundingInfo=null;var f=this._scene.getGeometries();d=f.indexOf(this),d>-1&&f.splice(d,1)},b.prototype.copy=function(b){var c=new a.VertexData;c.indices=[];for(var d=this.getIndices(),e=0;e<d.length;e++)c.indices.push(d[e]);var f=!1,g=!1;for(var h in this._vertexBuffers)c.set(this.getVerticesData(h),h),g||(f=this.getVertexBuffer(h).isUpdatable(),g=!f);var i=new a.Geometry(b,this._scene,c,f,null);i.delayLoadState=this.delayLoadState,i.delayLoadingFile=this.delayLoadingFile,i._delayLoadingFunction=this._delayLoadingFunction;for(h in this._delayInfo)i._delayInfo=i._delayInfo||[],i._delayInfo.push(h);var j=a.Tools.ExtractMinAndMax(this.getVerticesData(a.VertexBuffer.PositionKind),0,this.getTotalVertices());return i._boundingInfo=new a.BoundingInfo(j.minimum,j.maximum),i},b.ExtractFromMesh=function(a,b){var c=a._geometry;return c?c.copy(b):null},b.RandomId=function(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(a){var b=16*Math.random()|0,c="x"==a?b:3&b|8;return c.toString(16)})},b}();a.Geometry=b,function(b){!function(c){var d=function(a){function b(b,c,d,e,f){this._beingRegenerated=!0,this._canBeRegenerated=e,a.call(this,b,c,d,!1,f),this._beingRegenerated=!1}return __extends(b,a),b.prototype.canBeRegenerated=function(){return this._canBeRegenerated},b.prototype.regenerate=function(){this._canBeRegenerated&&(this._beingRegenerated=!0,this.setAllVerticesData(this._regenerateVertexData(),!1),this._beingRegenerated=!1)},b.prototype.asNewGeometry=function(b){return a.prototype.copy.call(this,b)},b.prototype.setAllVerticesData=function(b){this._beingRegenerated&&a.prototype.setAllVerticesData.call(this,b,!1)},b.prototype.setVerticesData=function(b,c){this._beingRegenerated&&a.prototype.setVerticesData.call(this,b,c,!1)},b.prototype._regenerateVertexData=function(){throw new Error("Abstract method")},b.prototype.copy=function(){throw new Error("Must be overriden in sub-classes.")},b}(b);c._Primitive=d;var e=function(b){function c(a,c,d,e,f){this.size=d,b.call(this,a,c,this._regenerateVertexData(),e,f)}return __extends(c,b),c.prototype._regenerateVertexData=function(){return a.VertexData.CreateBox(this.size)},c.prototype.copy=function(a){return new c(a,this.getScene(),this.size,this.canBeRegenerated(),null)},c}(d);c.Box=e;var f=function(b){function c(a,c,d,e,f,g){this.segments=d,this.diameter=e,b.call(this,a,c,this._regenerateVertexData(),f,g)}return __extends(c,b),c.prototype._regenerateVertexData=function(){return a.VertexData.CreateSphere(this.segments,this.diameter)},c.prototype.copy=function(a){return new c(a,this.getScene(),this.segments,this.diameter,this.canBeRegenerated(),null)},c}(d);c.Sphere=f;var g=function(b){function c(a,c,d,e,f,g,h,i,j){"undefined"==typeof h&&(h=1),this.height=d,this.diameterTop=f,this.diameterBottom=e,this.tessellation=g,this.subdivisions=h,b.call(this,a,c,this._regenerateVertexData(),i,j)}return __extends(c,b),c.prototype._regenerateVertexData=function(){return a.VertexData.CreateCylinder(this.height,this.diameterBottom,this.diameterTop,this.tessellation,this.subdivisions)},c.prototype.copy=function(a){return new c(a,this.getScene(),this.height,this.diameterTop,this.diameterBottom,this.tessellation,this.subdivisions,this.canBeRegenerated(),null)},c}(d);c.Cylinder=g;var h=function(b){function c(a,c,d,e,f,g,h){this.diameter=d,this.thickness=e,this.tessellation=f,b.call(this,a,c,this._regenerateVertexData(),g,h)}return __extends(c,b),c.prototype._regenerateVertexData=function(){return a.VertexData.CreateTorus(this.diameter,this.thickness,this.tessellation)},c.prototype.copy=function(a){return new c(a,this.getScene(),this.diameter,this.thickness,this.tessellation,this.canBeRegenerated(),null)},c}(d);c.Torus=h;var i=function(b){function c(a,c,d,e,f,g,h){this.width=d,this.height=e,this.subdivisions=f,b.call(this,a,c,this._regenerateVertexData(),g,h)}return __extends(c,b),c.prototype._regenerateVertexData=function(){return a.VertexData.CreateGround(this.width,this.height,this.subdivisions)},c.prototype.copy=function(a){return new c(a,this.getScene(),this.width,this.height,this.subdivisions,this.canBeRegenerated(),null)},c}(d);c.Ground=i;var j=function(b){function c(a,c,d,e,f,g,h,i,j,k){this.xmin=d,this.zmin=e,this.xmax=f,this.zmax=g,this.subdivisions=h,this.precision=i,b.call(this,a,c,this._regenerateVertexData(),j,k)}return __extends(c,b),c.prototype._regenerateVertexData=function(){return a.VertexData.CreateTiledGround(this.xmin,this.zmin,this.xmax,this.zmax,this.subdivisions,this.precision)},c.prototype.copy=function(a){return new c(a,this.getScene(),this.xmin,this.zmin,this.xmax,this.zmax,this.subdivisions,this.precision,this.canBeRegenerated(),null)},c}(d);c.TiledGround=j;var k=function(b){function c(a,c,d,e,f){this.size=d,b.call(this,a,c,this._regenerateVertexData(),e,f)}return __extends(c,b),c.prototype._regenerateVertexData=function(){return a.VertexData.CreatePlane(this.size)},c.prototype.copy=function(a){return new c(a,this.getScene(),this.size,this.canBeRegenerated(),null)},c}(d);c.Plane=k;var l=function(b){function c(a,c,d,e,f,g,h,i,j,k){this.radius=d,this.tube=e,this.radialSegments=f,this.tubularSegments=g,this.p=h,this.q=i,b.call(this,a,c,this._regenerateVertexData(),j,k)}return __extends(c,b),c.prototype._regenerateVertexData=function(){return a.VertexData.CreateTorusKnot(this.radius,this.tube,this.radialSegments,this.tubularSegments,this.p,this.q)},c.prototype.copy=function(a){return new c(a,this.getScene(),this.radius,this.tube,this.radialSegments,this.tubularSegments,this.p,this.q,this.canBeRegenerated(),null)},c}(d);c.TorusKnot=l}(b.Primitives||(b.Primitives={})),b.Primitives}(a.Geometry||(a.Geometry={}));var b=a.Geometry}(BABYLON||(BABYLON={}));var __extends=this.__extends||function(a,b){function c(){this.constructor=a}for(var d in b)b.hasOwnProperty(d)&&(a[d]=b[d]);c.prototype=b.prototype,a.prototype=new c},BABYLON;!function(a){var b=function(){function b(a){var b=this;this.babylonGamepads=[],this.oneGamepadConnected=!1,this.isMonitoring=!1,this.gamepadEventSupported="GamepadEvent"in window,this.gamepadSupportAvailable=navigator.getGamepads||!!navigator.webkitGetGamepads||!!navigator.msGetGamepads||!!navigator.webkitGamepads,this.buttonADataURL="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAEAAAABACAYAAACqaXHeAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAA9aSURBVHja7FtpbBzneX7m3otcihSpm9Z9UJalxPKhVLZlp6ktNzEaxE0CtAnQAgnSoPWPBi3syuiPwordFi5Qt2haFygCoylSV4Vby6os1I3kOLYrS65kXXQoypJJSaFEUTyXy925+rzfzC6HFFlL1kpAIe7i5czO7H7zPs97ft8MtTAMcSu/dNzirxkCZgiYIWCGgBkCZgi4hV/mDR5fSxAt+0ZiX0ucDxMSTJLK+f83BFSA6TFgK75OclshouKBFbA+xaV4k7Z+fD6sNRlmjYFXQMu4NiUVS/oHe5/ecnHo3MYxd7QthN9UcsdW6FqEPwgDOFbqpAajL2VlTrTULzj4Ow8+s4+nipSxWMoxIUkyrl/pGswFtIR7WzHgDCX77K7vfHNkbOA+AryjYZadb27OIJdzCNZBKmXw4kbk35qPsTEfJbeEkZESentHMdBfGtY142gu1bDvqV/925f4tQJlNCaj4hXX7RHXS0AFuJEAXvfHr/zmk67vPjir0V68aFEe8xtuQ6O1FHlrEXLmHBiaDUtzYBlpNYjrF+GFZfhhCcPeBQy53ehzT+H8QBe6uwfRf7l8xjKsvX/y5X98jl8fThDhJ4i46QQkrS5I6v7oX7/++77vPtLUlFnZtnIRlubvxRxnHbJmE79sxD/SqG0oZk8MFarRqufUkQAFrxcXSkfx0eB+nOggKX2jHYZhvf79r/z4L2IiipO84aYRkASfefnAX695p3P3c9mM/UufuaMVdzRvxVx7A0xaWdOMqVULJ6Z3TZv6KmHo0ztK6CkfxpHe3Th0pAuF0fLbn1u+9cmv3vW77bE3fGoSPi0BVfAvvPEHm9rPv//iooWz5m9Z/wCWZx+Go9UrN48QTD9IGMZ1cJIzTPisRQclPMrhME4W9mDfB2+i+2z/+TXz7/z2E7/85+9OIuGGE6BV3H77zm/d33nx6Ktr18zFg2t+DQude2n1tLJ8tcJ90vDhpG5Am7qTkJAQErywiLOld7G3/d9xvL0Hy1vWPbbtS3//00Q4hDeaAFXintrx1fu7+jp2r13bgofX/gaazbVkJQdLT9P6VqRFDSu2hIgXlBUBLgtCr3cce47/CMePX0Rr08qtzz7+8k8TpfKGtcKq1jPZre7oObyjdWkGd628l7AXwvMCeL7HjO6qrS8S1E5kTE9tfbiur665ccU9EB1EF9Ep0WXesEZIJb9j5/b/XUtzNrt29Rw0og2lchmBVqLo8LSAHlCixbTpddGm8Y7pjkttCCUP+JQy3FiatNuxdvUx9F4ayopO/OL9sQeEN4oA/eHn577oWPbGVes11PsrUBxjDafze1Te1VzouqnK2TgmLQljQqmrnAsT+iaPVb5b2co7EC+QhBgUeM1R1AcrsGp9Jy6+4W8U3fZ8r+e3EnOI2uaAX3l+zgNB4O9rW5/B8tY5WGo9BtOrJ4uMfUl+uj0B8HTmPXj8Pex86xVEnTDBBSE2r78fX9i09RPyZfT2A5ceIMSPwDOH8JH7Kk5+fAHtR0Zh6MZ9e7534Wc3wgO0sXLhD9OpFOa0egjGMhguD8BgTJooMfPbV1h/umz25ondcFP90IzY2iTgrfY9uH31aqSc9CeSEHkBEyITv28M8XMGc2/z0HGCpWCs8BS/9sWrDYOrJuCBZ+vu5sUfXbicia5kYGzUw4DWTwJKbApSjHuTBBjT2H68zg0MD4KlEwabZi0Y7wd85u/3O9/B6sVrPlEXeiF9nMmRxPt6Qf4y/HyIbh3HwkdF1zefGt5fUwK8wP2WAGwh02MFE/5ogYr3Qg/STL0W3d8aB1ppa+Pw0uI2Tz6/134Mg+UoIGZlZ2HMLaJYHkPICr6//RBamvPj/UA4dYKsegGrXqAXMaqNsDT6SreOY5Gu/FptCeBFN+caAphGiKFiGaOjA3AJHoGt6r7GgNbjqjo5yQkBUVHQ8PaJExjiaZ2yue12nO27gCNdHSptvf/xGdw11I2UZSmvCIJgQiJMhoEfeqpNDvUSRvUB5hMX9fUecg0aBi+Hm2uaAz633bmbm1VN8+h07LfKJdkOkQB2fL4BTlsj8No4YLG2putMSjwjp3QNvZdH8YsiExV501isFjU30lpF7D8dVfCA8sFHp7BuWYtaIwiCsCrCSDVhh9IX8k0CoHsoMQ84FrfFAE3zQAK0VaLzO9tK79XKAxSj+aYALt3XLfNipZD1v492YexrE/sP0zBgUIQIoYaflAXbz16CzyY6YKqYl8uheTarRioD7xAxCQHUpv18L1Yud+Iloujtk4zQo9WZcKURqjbHclzKvj0Gvcw8UA6oY2WqonSuGQGb5I+TJgEFEsB4daXzc0eopabcX13W0BXwgAnRZL4Q62s8ppnR/pFz/QjF+tRvxeIsY/cizGwRt83P4czACL8HdA1JUivCNGVogvdkNkgaGDNe4CvXFyJ8n+B5XGLJ1FmJXJ53AzjZKgGbatkKL5c/liNWIPO8uM/4VO2uKCQZjLmBqQAGJ4EmI8NMabDTOuyUobYXmPlCEpiqA1IkYdWSBpjpEDl6wsrF9aAjqHNOPXDyXAGprAknY5B0btOGGk/GlfE1taqofCNuuYNIJ+omOiZ1rpUHtEYWjkpWoP5EWV2sb5isA7aIQTHHxaIniNADui8PIs0Eb6SY/Z0UQc+j+mXYuoM7Vy/Age7zkBUyCZGLhRLSOYcWpfXFA1wPhqup8JNKq5UkKeoqSHxPLSoqnUQtw5ioc60IyE/VkOji8mYE2nZELNgCXLaOkGDFJBg4OzCMDEcxCfAzS1pQX5fHSNDLClLGwmwzls6vQ09hGFJYegdZ1hha2bqIBNelB5Qjog02TzpFNVEquYpMuTSYr/lcQPKPJHoRQ8W1GYO3lDgpO9pPWTEZEQGnuodg5Hyk66Lyd8fKOQQ6gqyWict7GeuWz8HQyWEFw+bB7ksF3Nk2V1nfpZTLQqSLslzXlDmHpsQ1osVoy/Solwf/GpdErpaAQUqjWxL2GWcWaSfAMIis7RBwiuCdtD1OgmNHBJCg7r4uZBnbdjaaq+3YewB+USYicY8juYPnMtloqdCjG3f39eO+3JKIAFadSiiZigBdgdcqItMxsmZbIbvUIKlzzQjoEgLGRjU2KTp8AjRCkzEnAG0mtQh8Ku0oAqok8JzP+Lw0MkB3jpKjKpapaL5WKZxafDdBqoC6O8LtyMAQhoZdzG7MwLU8FUYKPINcl+qimismRj26v2I71I3jDxfdpM41I6CTsmG4X0djKyc8RYu9t0Vl2QJbBJ5xFPiICJIg1hdhR3fs5HnWeldleZXABLA98b7Y5HtjkgwNEtbTN4iFC5oI3I1CTsAbsfVjAizJB3Qbx9HphRp6eqr3TDprSYA0FI/3ntOxbpUNM2OjpEcE6HYEWkhIKw+ICeBxi+T09F1WZU+iJq2n8fRDf4Ymu3XSrcOIgg8H9uOFn31fNUVC0oddZ7B5YxtDwlTgo66SEici2fokwCJjju0hw7J54WypQsB7tSRAza+H+nld30Y+m2b7SS+Qn9PKFl1egRciHIfWpxC8x+7tdA97+3zUcNyWX4Ci/THOoD2x/hmlQTox+3gDjWYeg/4gmF853xjBpUsjaGnJR24fu36FNzX5pmfY7EPStlSLIgb6gwk616QRYk8tS88/l/2PT/loyqbQkEmhPpNGNp1CmvtieQHvONGtL4sdy9Hjp5kkpTWmSzM7L529hErHs0cCpt2qW00BymDV3JXSU8HkAXKIjtNnedxS48m4Mr5cR9YlMrx+XTqNRmbP2ZkMOjvHKir/PNa5pouiitFjH44iZ6YwO5tFAy+eo6SdpOUJyhBQTJR+HT9HYLJaFve0PqQmTQLaVOCdmIRIWE+wrmWTzG8iAugF7qgWjSWkGbYa32EjJQTkGFv5dBZNJKCeHdb77UPXZP1rWhKLZ4Rqjv2Fz86lLMNlpusCY9BnqTNUIyTgrVhhs7rVq2KoW2TSxWlXLOCqWX4svmpzZdEjWvgQcdVWPnu+i4ClUS+HyLIFnsVf/9eBduw8eKYy2D1XMxO8Jg+IB9wl+3s/uAC3qKMpXY88m/ecnUHaSis3Na8Ab1UtaCh3j1y+sm8m9o0J+9Fv9MR4Zhw6DufTWasOebsOs+xZKHJOtvtQtertulrwV+0BtH5yWvyW7CxubsCTX9+KUQZ4ga7qmdGUFmrya8QWHwcxlReMF8Mw4QETrR8oy7tq2ivH5Tvya8n8aXZMGc4An/nRDpy52FfR8b5KCJCImt8YkYF/KDtnegfwz3sPodGajQajCTk9z/4mQ6iphMWv9AA9IeMWdyYdn+gBkVc5amwHWV6lHvVaI2YZzfinN95Ngv/htcT/p31CRNbdV8l8e++xD5HPNeHxhx5Bgf18kTN5T1kvjBfEjGjBJCai4gnjHqAnlvqS8e9NeujEjEul/NokDbai4V/2voafHD1S0evdWLeb8ojMNyly5fS//ffbcD0L33j4K4RX4rtMh/UUGLXmr6BWXN9MEFAhYfzmZ6hcXI+TpISRH8061Ui68gTWGUJP4aU9P8ZrB39S+Xkx1ummPSMkbebnJcxU1jm4D5eGhvB7j32HJcpUJHhxLIfxTZpxwGa8eKrHC51a9Tmp+N5P1RsQ01cJAwEflHw8/+pfYn/HgaQ+n7/a1vd6k+BUS2XvVD401TXhu488gQ0r71QUuLJsrWT8mSYtfkBMm0BAmFhNrgDX4oRqqeaJMw4c6TyIv/qPP0Xf8KUJ6sXuP1XluuEEyGsD5TXKgsqBNQvW4RtbnkDb4ttJQlGt/IQqLMJE7tWqOSBZCSrL6dFSqq3AnzhzDC/tewHt5w4nr3suvgN0+P8o3TeegFe3vYDHtj+xhLt/Q3kkeW5d693YuuHXsWHZPcixW4tCwo+trVU9QEs8G6HFqW5kdBiHTu3H64dfxpGuK8r665Tv7tz2D6e/tP23cT0E1OA5QR2iiIbs1i9u/9qTPPC12CtwlIofjZVvW/BZ3LVsC5bPW4u5DQuxaPay2NpRIuy61IkLA+dw8hdHceDUPpw49z9TXUysvWPXtl3bQ4yQtMJ1a18DAsbvRO/atvM5DXXPPbp9yzP8+GXBXTkngKYBdTWvE5RXdm87+HQEfLh2T57UIAdM95Js9+04LKSDbLzG31+Omxpx9xfxKR6AukkhMP0aKuUHsag5VEzE3fGSddsUVu6KFzIE+H/iJry0mX+bu8VfMwTMEDBDwAwBMwTMEHALv/5XgAEASpR5N6rB30UAAAAASUVORK5CYII=",this._callbackGamepadConnected=a,this.gamepadSupportAvailable?(this.gamepadEventSupported?(window.addEventListener("gamepadconnected",function(a){b._onGamepadConnected(a)},!1),window.addEventListener("gamepaddisconnected",function(a){b._onGamepadDisconnected(a)},!1)):this._startMonitoringGamepads(),this.oneGamepadConnected||this._insertGamepadDOMInstructions()):this._insertGamepadDOMNotSupported()}return b.prototype._insertGamepadDOMInstructions=function(){b.gamepadDOMInfo=document.createElement("div");var a=document.createElement("img");a.src=this.buttonADataURL;var c=document.createElement("span");c.innerHTML="<strong>to activate gamepad</strong>",b.gamepadDOMInfo.appendChild(a),b.gamepadDOMInfo.appendChild(c),b.gamepadDOMInfo.style.position="absolute",b.gamepadDOMInfo.style.width="100%",b.gamepadDOMInfo.style.height="48px",b.gamepadDOMInfo.style.bottom="0px",b.gamepadDOMInfo.style.backgroundColor="rgba(1, 1, 1, 0.15)",b.gamepadDOMInfo.style.textAlign="center",b.gamepadDOMInfo.style.zIndex="10",a.style.position="relative",a.style.bottom="8px",c.style.position="relative",c.style.fontSize="32px",c.style.bottom="32px",c.style.color="green",document.body.appendChild(b.gamepadDOMInfo)},b.prototype._insertGamepadDOMNotSupported=function(){b.gamepadDOMInfo=document.createElement("div");var a=document.createElement("span");a.innerHTML="<strong>gamepad not supported</strong>",b.gamepadDOMInfo.appendChild(a),b.gamepadDOMInfo.style.position="absolute",b.gamepadDOMInfo.style.width="100%",b.gamepadDOMInfo.style.height="40px",b.gamepadDOMInfo.style.bottom="0px",b.gamepadDOMInfo.style.backgroundColor="rgba(1, 1, 1, 0.15)",b.gamepadDOMInfo.style.textAlign="center",b.gamepadDOMInfo.style.zIndex="10",a.style.position="relative",a.style.fontSize="32px",a.style.color="red",document.body.appendChild(b.gamepadDOMInfo)},b.prototype.dispose=function(){document.body.removeChild(b.gamepadDOMInfo)},b.prototype._onGamepadConnected=function(a){var b=this._addNewGamepad(a.gamepad);this._callbackGamepadConnected&&this._callbackGamepadConnected(b),this._startMonitoringGamepads()},b.prototype._addNewGamepad=function(c){this.oneGamepadConnected||(this.oneGamepadConnected=!0,b.gamepadDOMInfo&&(document.body.removeChild(b.gamepadDOMInfo),b.gamepadDOMInfo=null));var d;return d=-1!==c.id.search("Xbox 360")||-1!==c.id.search("xinput")?new a.Xbox360Pad(c.id,c.index,c):new a.GenericPad(c.id,c.index,c),this.babylonGamepads.push(d),d},b.prototype._onGamepadDisconnected=function(a){for(var b in this.babylonGamepads)if(this.babylonGamepads[b].index==a.gamepad.index){this.babylonGamepads.splice(b,1);break}0==this.babylonGamepads.length&&this._stopMonitoringGamepads()},b.prototype._startMonitoringGamepads=function(){this.isMonitoring||(this.isMonitoring=!0,this._checkGamepadsStatus())},b.prototype._stopMonitoringGamepads=function(){this.isMonitoring=!1},b.prototype._checkGamepadsStatus=function(){var a=this;this._updateGamepadObjects();for(var b in this.babylonGamepads)this.babylonGamepads[b].update();this.isMonitoring&&(window.requestAnimationFrame?window.requestAnimationFrame(function(){a._checkGamepadsStatus()}):window.mozRequestAnimationFrame?window.mozRequestAnimationFrame(function(){a._checkGamepadsStatus()}):window.webkitRequestAnimationFrame&&window.webkitRequestAnimationFrame(function(){a._checkGamepadsStatus()}))},b.prototype._updateGamepadObjects=function(){for(var a=navigator.getGamepads?navigator.getGamepads():navigator.webkitGetGamepads?navigator.webkitGetGamepads():[],b=0;b<a.length;b++)if(a[b])if(a[b].index in this.babylonGamepads)this.babylonGamepads[b].browserGamepad=a[b];else{var c=this._addNewGamepad(a[b]);this._callbackGamepadConnected&&this._callbackGamepadConnected(c)}},b}();a.Gamepads=b;var c=function(){function a(a,b){this.x=a,this.y=b}return a}();a.StickValues=c;var d=function(){function a(a,b,c){this.id=a,this.index=b,this.browserGamepad=c,this.browserGamepad.axes.length>=2&&(this._leftStick={x:this.browserGamepad.axes[0],y:this.browserGamepad.axes[1]}),this.browserGamepad.axes.length>=4&&(this._rightStick={x:this.browserGamepad.axes[2],y:this.browserGamepad.axes[3]})}return a.prototype.onleftstickchanged=function(a){this._onleftstickchanged=a},a.prototype.onrightstickchanged=function(a){this._onrightstickchanged=a},Object.defineProperty(a.prototype,"leftStick",{get:function(){return this._leftStick},set:function(a){!this._onleftstickchanged||this._leftStick.x===a.x&&this._leftStick.y===a.y||this._onleftstickchanged(a),this._leftStick=a},enumerable:!0,configurable:!0}),Object.defineProperty(a.prototype,"rightStick",{get:function(){return this._rightStick},set:function(a){!this._onrightstickchanged||this._rightStick.x===a.x&&this._rightStick.y===a.y||this._onrightstickchanged(a),this._rightStick=a},enumerable:!0,configurable:!0}),a.prototype.update=function(){this._leftStick&&(this.leftStick={x:this.browserGamepad.axes[0],y:this.browserGamepad.axes[1]}),this._rightStick&&(this.rightStick={x:this.browserGamepad.axes[2],y:this.browserGamepad.axes[3]})},a}();a.Gamepad=d;var e=function(a){function b(b,c,d){a.call(this,b,c,d),this.id=b,this.index=c,this.gamepad=d,this._buttons=new Array(d.buttons.length)}return __extends(b,a),b.prototype.onbuttondown=function(a){this._onbuttondown=a},b.prototype.onbuttonup=function(a){this._onbuttonup=a},b.prototype._setButtonValue=function(a,b,c){return a!==b&&(this._onbuttondown&&1===a&&this._onbuttondown(c),this._onbuttonup&&0===a&&this._onbuttonup(c)),a},b.prototype.update=function(){a.prototype.update.call(this);for(var b=0;b<this._buttons.length;b++)this._buttons[b]=this._setButtonValue(this.gamepad.buttons[b].value,this._buttons[b],b)},b}(d);a.GenericPad=e,function(a){a[a.A=0]="A",a[a.B=1]="B",a[a.X=2]="X",a[a.Y=3]="Y",a[a.Start=4]="Start",a[a.Back=5]="Back",a[a.LB=6]="LB",a[a.RB=7]="RB",a[a.LeftStick=8]="LeftStick",a[a.RightStick=9]="RightStick"}(a.Xbox360Button||(a.Xbox360Button={})),a.Xbox360Button,!function(a){a[a.Up=0]="Up",a[a.Down=1]="Down",a[a.Left=2]="Left",a[a.Right=3]="Right"}(a.Xbox360Dpad||(a.Xbox360Dpad={}));var f=(a.Xbox360Dpad,function(a){function b(){a.apply(this,arguments),this._leftTrigger=0,this._rightTrigger=0,this._buttonA=0,this._buttonB=0,this._buttonX=0,this._buttonY=0,this._buttonBack=0,this._buttonStart=0,this._buttonLB=0,this._buttonRB=0,this._buttonLeftStick=0,this._buttonRightStick=0,this._dPadUp=0,this._dPadDown=0,this._dPadLeft=0,this._dPadRight=0}return __extends(b,a),b.prototype.onlefttriggerchanged=function(a){this._onlefttriggerchanged=a},b.prototype.onrighttriggerchanged=function(a){this._onrighttriggerchanged=a},Object.defineProperty(b.prototype,"leftTrigger",{get:function(){return this._leftTrigger},set:function(a){this._onlefttriggerchanged&&this._leftTrigger!==a&&this._onlefttriggerchanged(a),this._leftTrigger=a},enumerable:!0,configurable:!0}),Object.defineProperty(b.prototype,"rightTrigger",{get:function(){return this._rightTrigger},set:function(a){this._onrighttriggerchanged&&this._rightTrigger!==a&&this._onrighttriggerchanged(a),this._rightTrigger=a},enumerable:!0,configurable:!0}),b.prototype.onbuttondown=function(a){this._onbuttondown=a},b.prototype.onbuttonup=function(a){this._onbuttonup=a},b.prototype.ondpaddown=function(a){this._ondpaddown=a},b.prototype.ondpadup=function(a){this._ondpadup=a},b.prototype._setButtonValue=function(a,b,c){return a!==b&&(this._onbuttondown&&1===a&&this._onbuttondown(c),this._onbuttonup&&0===a&&this._onbuttonup(c)),a},b.prototype._setDPadValue=function(a,b,c){return a!==b&&(this._ondpaddown&&1===a&&this._ondpaddown(c),this._ondpadup&&0===a&&this._ondpadup(c)),a},Object.defineProperty(b.prototype,"buttonA",{get:function(){return this._buttonA},set:function(a){this._buttonA=this._setButtonValue(a,this._buttonA,0)},enumerable:!0,configurable:!0}),Object.defineProperty(b.prototype,"buttonB",{get:function(){return this._buttonB},set:function(a){this._buttonB=this._setButtonValue(a,this._buttonB,1)},enumerable:!0,configurable:!0}),Object.defineProperty(b.prototype,"buttonX",{get:function(){return this._buttonX},set:function(a){this._buttonX=this._setButtonValue(a,this._buttonX,2)},enumerable:!0,configurable:!0}),Object.defineProperty(b.prototype,"buttonY",{get:function(){return this._buttonY},set:function(a){this._buttonY=this._setButtonValue(a,this._buttonY,3)},enumerable:!0,configurable:!0}),Object.defineProperty(b.prototype,"buttonStart",{get:function(){return this._buttonStart},set:function(a){this._buttonStart=this._setButtonValue(a,this._buttonStart,4)
},enumerable:!0,configurable:!0}),Object.defineProperty(b.prototype,"buttonBack",{get:function(){return this._buttonBack},set:function(a){this._buttonBack=this._setButtonValue(a,this._buttonBack,5)},enumerable:!0,configurable:!0}),Object.defineProperty(b.prototype,"buttonLB",{get:function(){return this._buttonLB},set:function(a){this._buttonLB=this._setButtonValue(a,this._buttonLB,6)},enumerable:!0,configurable:!0}),Object.defineProperty(b.prototype,"buttonRB",{get:function(){return this._buttonRB},set:function(a){this._buttonRB=this._setButtonValue(a,this._buttonRB,7)},enumerable:!0,configurable:!0}),Object.defineProperty(b.prototype,"buttonLeftStick",{get:function(){return this._buttonLeftStick},set:function(a){this._buttonLeftStick=this._setButtonValue(a,this._buttonLeftStick,8)},enumerable:!0,configurable:!0}),Object.defineProperty(b.prototype,"buttonRightStick",{get:function(){return this._buttonRightStick},set:function(a){this._buttonRightStick=this._setButtonValue(a,this._buttonRightStick,9)},enumerable:!0,configurable:!0}),Object.defineProperty(b.prototype,"dPadUp",{get:function(){return this._dPadUp},set:function(a){this._dPadUp=this._setDPadValue(a,this._dPadUp,0)},enumerable:!0,configurable:!0}),Object.defineProperty(b.prototype,"dPadDown",{get:function(){return this._dPadDown},set:function(a){this._dPadDown=this._setDPadValue(a,this._dPadDown,1)},enumerable:!0,configurable:!0}),Object.defineProperty(b.prototype,"dPadLeft",{get:function(){return this._dPadLeft},set:function(a){this._dPadLeft=this._setDPadValue(a,this._dPadLeft,2)},enumerable:!0,configurable:!0}),Object.defineProperty(b.prototype,"dPadRight",{get:function(){return this._dPadRight},set:function(a){this._dPadRight=this._setDPadValue(a,this._dPadRight,3)},enumerable:!0,configurable:!0}),b.prototype.update=function(){a.prototype.update.call(this),this.buttonA=this.browserGamepad.buttons[0].value,this.buttonB=this.browserGamepad.buttons[1].value,this.buttonX=this.browserGamepad.buttons[2].value,this.buttonY=this.browserGamepad.buttons[3].value,this.buttonLB=this.browserGamepad.buttons[4].value,this.buttonRB=this.browserGamepad.buttons[5].value,this.leftTrigger=this.browserGamepad.buttons[6].value,this.rightTrigger=this.browserGamepad.buttons[7].value,this.buttonBack=this.browserGamepad.buttons[8].value,this.buttonStart=this.browserGamepad.buttons[9].value,this.buttonLeftStick=this.browserGamepad.buttons[10].value,this.buttonRightStick=this.browserGamepad.buttons[11].value,this.dPadUp=this.browserGamepad.buttons[12].value,this.dPadDown=this.browserGamepad.buttons[13].value,this.dPadLeft=this.browserGamepad.buttons[14].value,this.dPadRight=this.browserGamepad.buttons[15].value},b}(d));a.Xbox360Pad=f}(BABYLON||(BABYLON={}));var __extends=this.__extends||function(a,b){function c(){this.constructor=a}for(var d in b)b.hasOwnProperty(d)&&(a[d]=b[d]);c.prototype=b.prototype,a.prototype=new c},BABYLON;!function(a){var b=function(b){function c(c,d,e){var f=this;b.call(this,c,d,e),this.angularSensibility=200,this.moveSensibility=75,this._gamepads=new a.Gamepads(function(a){f._onNewGameConnected(a)})}return __extends(c,b),c.prototype._onNewGameConnected=function(a){0===a.index&&(this._gamepad=a)},c.prototype._checkInputs=function(){if(this._gamepad){var b=this._gamepad.leftStick,c=b.x/this.moveSensibility,d=b.y/this.moveSensibility;b.x=Math.abs(c)>.005?0+c:0,b.y=Math.abs(d)>.005?0+d:0;var e=this._gamepad.rightStick,f=e.x/this.angularSensibility,g=e.y/this.angularSensibility;e.x=Math.abs(f)>.001?0+f:0,e.y=Math.abs(g)>.001?0+g:0;var h=a.Matrix.RotationYawPitchRoll(this.rotation.y,this.rotation.x,0),i=a.Vector3.TransformCoordinates(new a.Vector3(b.x,0,-b.y),h);this.cameraDirection=this.cameraDirection.add(i),this.cameraRotation=this.cameraRotation.add(new a.Vector3(e.y,e.x,0))}},c.prototype.dispose=function(){this._gamepads.dispose()},c}(a.FreeCamera);a.GamepadCamera=b}(BABYLON||(BABYLON={}));var __extends=this.__extends||function(a,b){function c(){this.constructor=a}for(var d in b)b.hasOwnProperty(d)&&(a[d]=b[d]);c.prototype=b.prototype,a.prototype=new c},BABYLON;!function(a){var b=function(b){function c(c,d,e){"undefined"==typeof e&&(e=!1),b.call(this,c,d),this.color=new a.Color3(1,1,1),this._indices=new Array,this._colorShader=new a.ShaderMaterial("colorShader",d,"color",{attributes:["position"],uniforms:["worldViewProjection","color"]})}return __extends(c,b),Object.defineProperty(c.prototype,"material",{get:function(){return this._colorShader},enumerable:!0,configurable:!0}),Object.defineProperty(c.prototype,"isPickable",{get:function(){return!1},enumerable:!0,configurable:!0}),Object.defineProperty(c.prototype,"checkCollisions",{get:function(){return!1},enumerable:!0,configurable:!0}),c.prototype._bind=function(){var b=this.getScene().getEngine(),c=this._geometry.getIndexBuffer();b.bindBuffers(this._geometry.getVertexBuffer(a.VertexBuffer.PositionKind).getBuffer(),c,[3],12,this._colorShader.getEffect()),this._colorShader.setColor3("color",this.color)},c.prototype._draw=function(a){if(this._geometry&&this._geometry.getVertexBuffers()&&this._geometry.getIndexBuffer()){var b=this.getScene().getEngine();b.draw(!1,a.indexStart,a.indexCount)}},c.prototype.intersects=function(){return null},c.prototype.dispose=function(a){this._colorShader.dispose(),b.prototype.dispose.call(this,a)},c}(a.Mesh);a.LinesMesh=b}(BABYLON||(BABYLON={})),BABYLON.Vector2.prototype.distanceTo=function(a){return Math.sqrt(this.distanceToSquared(a))},BABYLON.Vector2.prototype.distanceToSquared=function(a){var b=a.x-this.x,c=a.y-this.y;return b*b+c*c},BABYLON.Vector2.FromArrayToRef=function(a,b,c){b||(b=0),c.x=a[b],c.y=a[b+1]},BABYLON.Vector2.prototype.distToSegment=function(a,b){var c=a.distanceToSquared(b);if(0==c)return this.distanceTo(a);var d=this.subtract(a).dot(b.subtract(a))/c,e=a.add(b.subtract(a).scale(d));return this.distanceTo(e)},BABYLON.Vector3.prototype.distanceTo=function(a){return Math.sqrt(this.distanceToSquared(a))},BABYLON.Vector3.prototype.distanceToSquared=function(a){var b=a.x-this.x,c=a.y-this.y,d=a.z-this.z;return b*b+c*c+d*d},BABYLON.Vector3.prototype.minimize=function(a){return this.x=this.x<a.x?this.x:a.x,this.y=this.y<a.y?this.y:a.y,this.z=this.z<a.z?this.z:a.z,this},BABYLON.Vector3.prototype.maximize=function(a){return this.x=this.x>a.x?this.x:a.x,this.y=this.y>a.y?this.y:a.y,this.z=this.z>a.z?this.z:a.z,this},BABYLON.Vector2.prototype.copyFrom=function(a){return this.x=a.x,this.y=a.y,this},BABYLON.Vector2.prototype.copyFromFloats=function(a,b){return this.x=a,this.y=b,this},BABYLON.Vector2.prototype.addInPlace=function(a){return this.x+=a.x,this.y+=a.y,this},BABYLON.Vector2.prototype.subtractInPlace=function(a){return this.x-=a.x,this.y-=a.y,this},BABYLON.Vector2.prototype.subtractToRef=function(a,b){b.x=this.x-a.x,b.y=this.y-a.y},BABYLON.Vector2.prototype.lerp=function(a,b){return this.x=this.x+(a.x-this.x)*b,this.y=this.y+(a.y-this.y)*b,this},BABYLON.Vector3.prototype.lerp=function(a,b){return this.x=this.x+(a.x-this.x)*b,this.y=this.y+(a.y-this.y)*b,this.z=this.z+(a.z-this.z)*b,this},BABYLON.Vector2.prototype.projectOnVector=function(){var a=new BABYLON.Vector2;return function(b){a.copyFrom(b).normalize();var c=this.dot(a);return this.copyFrom(a).scaleInPlace(c)}}(),BABYLON.Vector3.prototype.projectOnVector=function(){var a=new BABYLON.Vector3;return function(b){a.copyFrom(b).normalize();var c=this.dot(a);return this.copyFrom(a).scaleInPlace(c)}}(),BABYLON.Vector2.prototype.projectOnSegment=function(a,b){var c=b.x-a.x,d=b.y-a.y,e=c*c+d*d,f=((this.x-a.x)*c+(this.y-a.y)*d)/e;return f=BABYLON.Math.clamp(f,0,1),new BABYLON.Vector2(a.x+f*c,a.y+f*d)},BABYLON.Color3.prototype.fromHex=function(a){if(/^\#([0-9a-f]{6})$/i.test(a))var a=parseInt(/^\#([0-9a-f]{6})$/i.exec(a)[1],16);return a=Math.floor(a),this.r=(a>>16&255)/255,this.g=(a>>8&255)/255,this.b=(255&a)/255,this};var roundTo=function(a){return Math.round(1e5*a)/1e5};BABYLON.Vector2.prototype.isPointInPolygon=function(a){var b,c,d,e,f=this.clone();f.x=roundTo(f.x),f.y=roundTo(f.y);for(var g=a.length,h=!1,i=0;g>i;i++)b=roundTo(a[i].x),c=roundTo(a[i].y),d=roundTo(a[(i+1)%g].x),e=roundTo(a[(i+1)%g].y),e===c&&e===f.y?(b<=f.x&&f.x<d||d<=f.x&&f.x<b)&&(h=!h):(c<=f.y&&f.y<e||e<=f.y&&f.y<c)&&f.x<=roundTo((d-b)*(f.y-c)/(e-c)+b)&&(h=!h);return h},BABYLON.Ray.prototype.closestPointToPoint=function(a){var b=a.subtract(this.origin),c=b.dot(this.direction);return b.copyFrom(this.direction).scale(c).add(this.origin)},BABYLON.Vector2.prototype.dot=function(a){return BABYLON.Vector2.Dot(this,a)},BABYLON.Vector3.prototype.dot=function(a){return BABYLON.Vector3.Dot(this,a)},BABYLON.Vector3.prototype.cross=function(){var a=new BABYLON.Vector3;return function(b){return BABYLON.Vector3.CrossToRef(this,b,a),this.copyFrom(a),this}}(),BABYLON.Vector3.prototype.toSpherical=function(){var a=this.length(),b=Math.acos(this.y/a),c=Math.atan2(this.z,this.x);return{r:a,alpha:c,beta:b}},BABYLON.Vector3.FromSphericalToRef=function(a,b,c,d){d.x=a*Math.cos(b)*Math.sin(c),d.y=a*Math.cos(c),d.z=a*Math.sin(b)*Math.sin(c)},BABYLON.Vector3.FromSpherical=function(a,b,c){var d=new BABYLON.Vector3;return BABYLON.Vector3.FromSphericalToRef(a,b,c,d),d},BABYLON.Vector2.prototype.determinant=function(a){return this.x*a.y-this.y*a.x},BABYLON.Math=BABYLON.Math||{},BABYLON.Math.clamp=function(a,b,c){return b>a?b:a>c?c:a},BABYLON.Math.NormalizeAngle=function(a,b){return a%=2*Math.PI,a+=2*Math.PI,a%=2*Math.PI,b?a:a=a>Math.PI?a-2*Math.PI:a},BABYLON.Math.ClosestAngle=function(a,b){var c=2*Math.PI;return a=(a%c+c)%c,rb=Math.floor(b/c),a+=rb*c,Math.abs(b-a)>Math.PI&&(a+=b>a?c:-c),a},BABYLON.Vector2.Precision=1e-5,BABYLON.Vector2.IntersectIsOn=function(){var a,b,c,d,e,f,g,h,i;return function(j,k,l,m,n,o){var n=n||BABYLON.Vector2.Precision,o=o||Math.PI/20;if(d=k.x-j.x,e=k.y-j.y,f=m.x-l.x,g=m.y-l.y,c=d*g-e*f,Math.abs(c)<o)return void 0;c=1/c,a=((j.y-l.y)*f-(j.x-l.x)*g)*c,b=((j.y-l.y)*d-(j.x-l.x)*e)*c;var p=new BABYLON.Vector2(j.x+a*d,j.y+a*e);return h=n/Math.sqrt(d*d+e*e),i=n/Math.sqrt(f*f+g*g),{intersect:p,isOn:a>=-h&&1+h>=a&&b>=-i&&1+i>=b}}}(),BABYLON.Vector2.Intersect=function(a,b,c,d,e){var f,g,h,i=e||BABYLON.Vector2.Precision,j=new BABYLON.Vector2,k=new BABYLON.Vector2;return j=b.subtract(a),k=d.subtract(c),f=j.y*a.x-j.x*a.y,g=k.y*c.x-k.x*c.y,h=j.determinant(k),detnorm=j.clone().normalize().determinant(k.clone().normalize()),Math.abs(detnorm)<i?void 0:new BABYLON.Vector2((j.x*g-k.x*f)/h,(j.y*g-k.y*f)/h)},BABYLON.Vector2.IntersectIsOnOLD=function(a,b,d,e,f,g){var f=f||BABYLON.Vector2.Precision,g=g||Math.PI/20,h=new BABYLON.Vector2,i=new BABYLON.Vector2;if(h=b.subtract(a),i=e.subtract(d),cprime=i.y*d.x-i.x*d.y,det=h.determinant(i),detnorm=h.clone().normalize().determinant(i.clone().normalize()),Math.abs(detnorm)<g)return void 0;var j=new BABYLON.Vector2((h.x*cprime-i.x*c)/det,(h.y*cprime-i.y*c)/det),k=Math.abs(b.x-a.x)>=BABYLON.Vector2.Precision?(j.x-a.x)/(b.x-a.x):(j.y-a.y)/(b.y-a.y),l=Math.abs(e.x-d.x)>=BABYLON.Vector2.Precision?(j.x-d.x)/(e.x-d.x):(j.y-d.y)/(e.y-d.y),m=f/h.length(),n=f/i.length();return{intersect:j,isOn:k>=-m&&1+m>=k&&l>=-n&&1+n>=l}},BABYLON.Vector2.prototype.isOnSegment=function(a,b){var c=.1,d=b.subtract(a),e=d.length();d.scaleInPlace(1/e);var f=this.subtract(a),g=d.x*f.y-d.y*f.x,h=d.dot(f);return Math.abs(g)<c&&h>=0&&e>=h},BABYLON.Vector2.SegmentIntersection=function(a,b,c,d,e,f){var f=f||Math.PI/200,g=BABYLON.Vector2.IntersectIsOn(a,b,c,d,e,f);return g&&g.isOn?g.intersect:null},BABYLON.Vector2.GetAbsoluteSine=function(a,b,c,d){var e=new BABYLON.Vector2,f=new BABYLON.Vector2;return a.subtractToRef(b,e),c.subtractToRef(d,f),e.normalize(),f.normalize(),Math.abs(e.determinant(f))},BABYLON.BoundingBox.ExpandFromPoint=function(a,b,c){a.x<b.x?b.x=a.x:a.x>c.x&&(c.x=a.x),a.y<b.y?b.y=a.y:a.y>c.y&&(c.y=a.y),a.z<b.z?b.z=a.z:a.z>c.z&&(c.z=a.z)},BABYLON.BoundingBox.CreateFromPoints=function(a){if(!(a.length>0))return BABYLON.BoundingBox.Zero();for(var b=a[0],c=b.clone(),d=b.clone(),e=1,f=a.length;f>e;e++)BABYLON.BoundingBox.ExpandFromPoint(a[e],c,d);return new BABYLON.BoundingBox(c,d)},BABYLON.BoundingBox.Zero=function(){return new BABYLON.BoundingBox(new BABYLON.Vector3(0,0,0),new BABYLON.Vector3(0,0,0))},BABYLON.BoundingBox.prototype.intersect=function(a){return this.minimum.max(a.minimum),this.maximum.min(a.maximum),this},BABYLON.BoundingBox.prototype.union=function(a){return this.minimum.min(a.minimum),this.maximum.max(a.maximum),this},BABYLON.Vector2.prototype.min=function(a){return this.x=this.x<a.x?this.x:a.x,this.y=this.y<a.y?this.y:a.y,this},BABYLON.Vector2.prototype.max=function(a){return this.x=this.x>a.x?this.x:a.x,this.y=this.y>a.y?this.y:a.y,this},BABYLON.Vector3.prototype.min=function(a){return this.x=this.x<a.x?this.x:a.x,this.y=this.y<a.y?this.y:a.y,this.z=this.z<a.z?this.z:a.z,this},BABYLON.Vector3.prototype.max=function(a){return this.x=this.x>a.x?this.x:a.x,this.y=this.y>a.y?this.y:a.y,this.z=this.z>a.z?this.z:a.z,this},BABYLON.Quaternion.RotationFromXtoX_=function(a,b){var c=BABYLON.Vector3.Cross(a,b).normalize();c.lengthSquared()<.001&&(c=BABYLON.Vector3.Cross(a,Math.abs(a.x)>.9?new BABYLON.Vector3(0,0,1):new BABYLON.Vector3(1,0,0)).normalize());var d=Math.acos(Math.min(Math.max(BABYLON.Vector3.Dot(a,b),-1),1));return BABYLON.Quaternion.RotationAxis(c,d)},BABYLON.Quaternion.RotationFromXtoX_2=function(b,c,d,e){var f=BABYLON.Vector3.Cross(b,d).normalize(),g=BABYLON.Vector3.Cross(c,e).normalize();f.lengthSquared()<.001&&(f=BABYLON.Vector3.Cross(b,Math.abs(b.x)>.9?new BABYLON.Vector3(0,0,1):new BABYLON.Vector3(1,0,0)).normalize()),g.lengthSquared()<.001&&(g=BABYLON.Vector3.Cross(c,Math.abs(c.x)>.9?new BABYLON.Vector3(0,0,1):new BABYLON.Vector3(1,0,0)).normalize());var h=BABYLON.Quaternion.RotationFromXtoX_(f,g),i=new BABYLON.Matrix;h.toRotationMatrix(i);var j=BABYLON.Vector3.TransformCoordinates(b,i);w=BABYLON.Vector3.Cross(j,c).normalize(),a=Math.acos(Math.min(Math.max(BABYLON.Vector3.Dot(j,c),-1),1));var k=g;BABYLON.Vector3.Dot(w,k)<.9&&(k=k.scale(-1));var l=BABYLON.Quaternion.RotationAxis(k,a);return l.multiply(h)},BABYLON.Mesh.prototype.getMaterial=function(a){for(var b=0,c=this.subMeshes.length;c>b;b++)if(3*a>=this.subMeshes[b].indexStart&&3*a<this.subMeshes[b].indexStart+this.subMeshes[b].indexCount)return this.subMeshes[b].getMaterial();return null},BABYLON.Mesh.prototype.initMaterials=function(a){for(var b in a)this.traverse(function(c){c.name===b&&(c.material=a[b])})},BABYLON.Mesh.prototype.invertFaces=function(){for(var a,b=this.getIndices(),c=0;c<b.length;c+=3)a=b[c],b[c]=b[c+2],b[c+2]=a;this.setIndices(b)},BABYLON.Mesh.prototype.invertNormales=function(){for(var a=this.getVerticesData(BABYLON.VertexBuffer.NormalKind),b=0;b<a.length;b++)a[b]*=-1;this.setVerticesData(BABYLON.VertexBuffer.NormalKind,a)},BABYLON.Ray.prototype.intersectMeshes=function(a,b,c){for(var d,e,f,g,h=1/0,i=new BABYLON.Matrix,j=0,k=a.length;k>j;j++)g=a[j].name&&-1!=a[j].name.indexOf("_sprite_"),(a[j].isVisible||g)&&(g&&a[j].sprite.updateCollider(),a[j].getWorldMatrix().invertToRef(i),f=BABYLON.Ray.Transform(this,i),f.direction.normalize(),d=a[j].intersects(f,!1,b,c),d.hit&&d.distance<h&&(e=d,h=d.distance));return e},BABYLON.Ray.prototype.distanceToPlane=function(a){var b=a.normal.dot(this.direction);if(0==b)return 0==Math.abs(a.signedDistanceTo(this.origin))?0:null;var c=-(this.origin.dot(a.normal)+a.d)/b;return c>=0?c:null},BABYLON.Ray.prototype.intersectPlane=function(a){var b=this.distanceToPlane(a);return null===b?null:this.origin.add(this.direction.scale(b))},BABYLON.Mesh.CreateBloc=function(a,b,c,d,e){b=b||.01,c=c||.01,d=d||.01;var f=new BABYLON.Mesh.CreateBox(a,b,e);return f.bakeTransformIntoVertices(BABYLON.Matrix.Scaling(1,c/b,d/b)),f},BABYLON.Mesh.CreatePlan=function(a,b,c,d){(0==c||0==b)&&console.log("trying to create a bloc with 0 dimension, will probably fail");var e=new BABYLON.Mesh.CreatePlane(a,b,d);return e.scaling.y=c/b,e},BABYLON.Mesh.Triangulate=function(a,b,c,d){for(var e,f=a.slice(0),g=[],h=0,d=d||0,j=c&&c.indices?c.indices:[],k=c&&c.positions?c.positions:[],l=c&&c.normals?c.normals:[],m=a[a.length-1],n=1e-5,o=0,p=a.length;p>o;o++)m.distanceTo(a[o])>n&&(e=new poly2tri.Point(a[o].x,a[o].y),e.index=h++,g.push(e)),m=a[o];if(!(g.length<3)){var q=new poly2tri.SweepContext(g);for(var r in b){var s=b[r],t=[];for(i in s)e=new poly2tri.Point(s[i].x,s[i].y),e.index=h++,t.push(e),f.push(s[i]);q.addHole(t)}for(var o=0,p=f.length;p>o;o++)k.push(f[o].x,d,-f[o].y);try{q.triangulate()}catch(u){return Logger.warning("Erreur de triangulation : "+u.message),null}var v,w=q.getTriangles();w.forEach(function(a){v=a.getPoints();for(var b=v.length-1;b>=0;b--)j.push(v[b].index)});var x=BABYLON.Tools.PlaneUVProjection(k,new BABYLON.Vector3(1,0,0),new BABYLON.Vector3(0,0,1),512);return c&&(c.uvs=x),BABYLON.VertexData.ComputeNormals(k,j,l),c||{positions:k,normals:l,indices:j,uvs:x}}},BABYLON.Mesh.TriangulateNewMesh=function(a,b,c,d,e){var f=new BABYLON.Mesh(a,d),g=BABYLON.Mesh.Triangulate(b,c,void 0,e);return g?(f.setVerticesData(BABYLON.VertexBuffer.PositionKind,g.positions),f.setVerticesData(BABYLON.VertexBuffer.NormalKind,g.normals),f.setVerticesData(BABYLON.VertexBuffer.UVKind,g.uvs),f.setIndices(g.indices),f):null},BABYLON.Mesh.prototype.centerGeometry=function(a){var a=a||"y",b=this.getBoundingBox(!0),c=b.center;if(this.isVerticesDataPresent(BABYLON.VertexBuffer.PositionKind))for(var d=this.getVerticesData(BABYLON.VertexBuffer.PositionKind),e=0,f=d.length;f>e;e+=3)d[e]-=c.x,d[e+1]-=c.y+b["extends"][a],d[e+2]-=c.z;for(var g=this.getChildren(),e=0,h=g.length;h>e;e++)g[e].position.subtractInPlace(c),g[e].position[a]+=b["extends"][a]},BABYLON.Mesh.Extrude=function(a,b,c,d){var c=c||{},e=d&&d.indices?d.indices:[],f=d&&d.positions?d.positions:[],g=d&&d.normals?d.normals:[],h=[],i=BABYLON.Mesh.Triangulate(a,b);if(!i)return null;for(var j,k=i.positions.length/3,l={positions:i.positions.slice(0),normals:i.normals.slice(0),uvs:i.uvs.slice(0),indices:i.indices.slice(0)},m=0,n=l.indices.length;n>m;m+=3)j=l.indices[m],l.indices[m]=l.indices[m+2],l.indices[m+2]=j;for(var o=void 0!==c.amount?c.amount:5,m=1,n=i.positions.length;n>m;m+=3)i.positions[m]+=o;for(var m=0,n=l.positions.length;n>m;m++)f.push(l.positions[m]),g.push(l.normals[m]);for(var m=0,n=i.positions.length;n>m;m++)f.push(i.positions[m]),g.push(i.normals[m]);for(var m=0,n=l.uvs.length;n>m;m++)h.push(l.uvs[m]);for(var m=0,n=i.uvs.length;n>m;m++)h.push(i.uvs[m]);for(var m=0,n=l.indices.length;n>m;m++)e.push(l.indices[m]);for(var m=0,n=i.indices.length;n>m;m++)e.push(i.indices[m]+k);var p=function(a,b){for(var c=a.length,d=f.length/3,i=b?BABYLON.Tools.Area(a)>0:BABYLON.Tools.Area(a)<0,j=0;j<a.length;j++)f.push(a[j].x,0,-a[j].y,a[j].x,o,-a[j].y);for(var j=0;c>j;j++)h.push(0,0),h.push(0,0);for(var k=new BABYLON.Vector2,j=0;c>j;j++)k.copyFrom(a[(j+1)%c]).subtractInPlace(a[j]),k.normalize(),i&&k.scaleInPlace(-1),g.push(-k.y,0,-k.x,-k.y,0,-k.x);for(var j=0;2*c>j;j+=2)i?(e.push(d+j,d+(j+2)%(2*c),d+j+1),e.push(d+(j+2)%(2*c),d+(j+3)%(2*c),d+j+1)):(e.push(d+j+1,d+(j+2)%(2*c),d+j),e.push(d+j+1,d+(j+3)%(2*c),d+(j+2)%(2*c)))};if(p(a),b)for(var m=0,n=b.length;n>m;m++)p(b[m],!0);return d||{positions:f,normals:g,indices:e,uvs:h}},BABYLON.Mesh.ExtrudeNewMesh=function(a,b,c,d,e){var f=new BABYLON.Mesh(a,e),g=BABYLON.Mesh.Extrude(b,c,d);return g?(f.setVerticesData(BABYLON.VertexBuffer.PositionKind,g.positions),f.setVerticesData(BABYLON.VertexBuffer.NormalKind,g.normals),f.setVerticesData(BABYLON.VertexBuffer.UVKind,g.uvs),f.setIndices(g.indices),f):null},BABYLON.Tools.Area=function(a){for(var b=a.length,c=0,d=b-1,e=0;b>e;d=e++)c+=a[d].x*a[e].y-a[e].x*a[d].y;return.5*c},BABYLON.Tools.PlaneUVProjection=function(a,b,c,d){var e;b=b.clone().normalize(),c=c.clone().normalize();var f=BABYLON.Vector3.Cross(b,c),g=[],h=[];if(f.length()<BABYLON.Engine.epsilon)return console.warn("Can't map UVs : basis vectors are linked"),null;if(0==a.length)return null;var i=BABYLON.Matrix.FromValues(b.x,c.x,f.x,0,b.y,c.y,f.y,0,b.z,c.z,f.z,0,0,0,0,1);i=BABYLON.Matrix.Transpose(i),i.invert();for(var j=0,k=a.length;k>j;j+=3)e=new BABYLON.Vector3(a[j],a[j+1],a[j+2]),BABYLON.Vector3.TransformCoordinatesToRef(e,i,e),g.push(e.x),h.push(e.y);for(var l=g[0],m=g[0],n=h[0],o=h[0],j=0,k=g.length;k>j;j++)g[j]<l&&(l=g[j]),g[j]>m&&(m=g[j]),h[j]<n&&(n=h[j]),h[j]>o&&(o=h[j]);var p,q;if(void 0===d&&(d=512),0!=d?(p=(m-l)/d*4,q=(o-n)/d*4):(p=1,q=1),m===l)for(var j=0,k=g.length;k>j;j++)g[j]=0;else for(var j=0,k=g.length;k>j;j++)g[j]=(g[j]-l)/(m-l)*p;if(o===n)for(var j=0,k=h.length;k>j;j++)h[j]=0;else for(var j=0,k=h.length;k>j;j++)h[j]=(h[j]-n)/(o-n)*q;for(var r=[],j=0,k=g.length;k>j;j++)r.push(g[j],h[j]);return r},BABYLON.Mesh.ComputeFlatNormal=function(a,b,c){var d,e=[];for(d=0;d<a.length;d+=3){var f=new BABYLON.Vector3(a[d],a[d+1],a[d+2]);e.push(f)}var g;for(d=0;d<c.length/3;d++){var h=c[3*d],i=c[3*d+1],j=c[3*d+2],k=e[h],l=e[i],m=e[j],n=k.subtract(l),o=m.subtract(l);g=BABYLON.Vector3.Normalize(BABYLON.Vector3.Cross(n,o)),b[3*h]=g.x,b[3*h+1]=g.y,b[3*h+2]=g.z,b[3*i]=g.x,b[3*i+1]=g.y,b[3*i+2]=g.z,b[3*j]=g.x,b[3*j+1]=g.y,b[3*j+2]=g.z}},BABYLON.Mesh.prototype.traverse=function(a){a(this);for(var b=this.getChildren(),c=0;c<b.length;c++)b[c].traverse(a)},BABYLON.Mesh.prototype.getChildByName=function(a,b){for(var c,d=this.getChildren(),e=0;e<d.length;e++){if(d[e].name===a)return d[e];if(!b&&(c=d[e].getChildByName(a)))return c}return null},BABYLON.Mesh.mergeMeshes=function(a,b,c,d){var e=[],f=[],g=[],h=[],j=[],k=[],l=[],m=[],n=[],o=[],p=new BABYLON.Mesh(a,c),q=!0,r=!0,s=!0,t=!0,u=!0;for(i=0;i!=b.length;i++)b[i].isVerticesDataPresent([BABYLON.VertexBuffer.UVKind])||(q=!1),b[i].isVerticesDataPresent([BABYLON.VertexBuffer.UV2Kind])||(r=!1),b[i].isVerticesDataPresent([BABYLON.VertexBuffer.ColorKind])||(s=!1),b[i].isVerticesDataPresent([BABYLON.VertexBuffer.MatricesIndicesKind])||(t=!1),b[i].isVerticesDataPresent([BABYLON.VertexBuffer.MatricesWeightsKind])||(u=!1);for(i=0;i!=b.length;i++){var v=0,w=0;e[i]=b[i].getVerticesData(BABYLON.VertexBuffer.PositionKind),f[i]=b[i].getVerticesData(BABYLON.VertexBuffer.NormalKind),q&&(g=g.concat(b[i].getVerticesData(BABYLON.VertexBuffer.UVKind))),r&&(h=h.concat(b[i].getVerticesData(BABYLON.VertexBuffer.UV2Kind))),s&&(j=j.concat(b[i].getVerticesData(BABYLON.VertexBuffer.ColorKind))),t&&(k=k.concat(b[i].getVerticesData(BABYLON.VertexBuffer.MatricesIndicesKind))),u&&(l=l.concat(b[i].getVerticesData(BABYLON.VertexBuffer.MatricesWeightsKind)));for(var x=n.length/3,y=b[i].computeWorldMatrix(!0);v<e[i].length;){var z=new BABYLON.Vector3.TransformCoordinates(new BABYLON.Vector3(e[i][v],e[i][v+1],e[i][v+2]),y);n.push(z.x),n.push(z.y),n.push(z.z),v+=3}for(;w<f[i].length;){var z=new BABYLON.Vector3.TransformNormal(new BABYLON.Vector3(f[i][w],f[i][w+1],f[i][w+2]),y);o.push(z.x),o.push(z.y),o.push(z.z),w+=3}if(i>0){var A=b[i].getIndices();for(it=0;it!=A.length;it++)A[it]=A[it]+x;m=m.concat(A)}else m=b[i].getIndices()}if(p.setVerticesData(BABYLON.VertexBuffer.PositionKind,n,!1),p.setVerticesData(BABYLON.VertexBuffer.NormalKind,o,!1),g.length>0&&p.setVerticesData(BABYLON.VertexBuffer.UVKind,g,!1),h.length>0&&p.setVerticesData(BABYLON.VertexBuffer.UV2Kind,g,!1),j.length>0&&p.setVerticesData(BABYLON.VertexBuffer.ColorKind,g,!1),k.length>0&&p.setVerticesData(BABYLON.VertexBuffer.MatricesIndicesKind,g,!1),l.length>0&&p.setVerticesData(BABYLON.VertexBuffer.MatricesWeightsKind,g,!1),p.setIndices(m),d){p.subMeshes=[];var B,x=0,C=0;for(i=0;i!=b.length;i++){p.subMeshes.length,i>0&&(x+=b[i-1].getIndices().length),B=-1;for(subMesh in b[i].subMeshes){var D=BABYLON.SubMesh.CreateFromIndices(b[i].subMeshes[subMesh].materialIndex+C,b[i].subMeshes[subMesh].indexStart+x,b[i].subMeshes[subMesh].indexCount,p);D.objectInstance=b[i].subMeshes[subMesh].objectInstance,D.boundingBox=b[i].subMeshes[subMesh].boundingBox,B=Math.max(b[i].subMeshes[subMesh].materialIndex,B)}C+=++B}}for(i=0;i!=b.length;i++)b[i].dispose(!0);return p},BABYLON.Mesh.mergeMeshesRec=function(a,b,c,d){for(var e=[],f=[],g=0;g<b.length;g++)b[g].traverse(function(a){a.computeWorldMatrix(!0),a.isVisible?e.push(a):f.push(a)});var h=BABYLON.Mesh.mergeMeshes(a,e,c,d);return f.forEach(function(a){a.dispose(!0)}),h},BABYLON.Mesh.ComputeFaceNormal=function(a,b,c){for(var d=0;d<c.length;d+=3){var e=new BABYLON.Vector3(a[3*c[d]],a[3*c[d]+1],a[3*c[d]+2]),f=new BABYLON.Vector3(a[3*c[d+1]],a[3*c[d+1]+1],a[3*c[d+1]+2]),g=new BABYLON.Vector3(a[3*c[d+2]],a[3*c[d+2]+1],a[3*c[d+2]+2]),h=e.subtract(f),i=g.subtract(f);h.cross(i),h.normalize(),b[3*c[d]]=h.x,b[3*c[d]+1]=h.y,b[3*c[d]+2]=h.z,b[3*c[d+1]]=h.x,b[3*c[d+1]+1]=h.y,b[3*c[d+1]+2]=h.z,b[3*c[d+2]]=h.x,b[3*c[d+2]+1]=h.y,b[3*c[d+2]+2]=h.z}},BABYLON.BoundingBox.CreateFromData=function(a){if(!(a.length>0&&a.length%3==0))return BABYLON.BoundingBox.Zero();for(var b=[],c=0;c<a.length;c+=3)b.push(new BABYLON.Vector3(a[c],a[c+1],a[c+2]));return BABYLON.BoundingBox.CreateFromPoints(b)},BABYLON.Material.prototype.serialize=function(){return{name:this.name}},BABYLON.Material.prototype.deserialize=function(){},BABYLON.StandardMaterial.prototype.serialize=function(){var a=BABYLON.Material.prototype.serialize.call(this);return a["class"]={name:"BABYLON.StandardMaterial"},ujs.serializeObject(this,a,["diffuseTexture","ambientTexture","opacityTexture","reflectionTexture","emissiveTexture","specularTexture","bumpTexture","ambientColor","diffuseColor","specularColor","specularPower","emissiveColor"]),a},BABYLON.MultiMaterial.prototype.serialize=function(){var a=BABYLON.Material.prototype.serialize.call(this);return a["class"]={name:"BABYLON.MultiMaterial"},ujs.serializeObject(this,a,["subMaterials"]),a},BABYLON.StandardMaterial.prototype.deserialize=function(a){return BABYLON.Material.prototype.deserialize.call(this,a),ujs.deserializeObject(a,this,["diffuseTexture","ambientTexture","opacityTexture","reflectionTexture","emissiveTexture","specularTexture","bumpTexture","ambientColor","diffuseColor","specularColor","specularPower","emissiveColor"]),this},BABYLON.MultiMaterial.prototype.deserialize=function(a){return BABYLON.Material.prototype.deserialize.call(this,a),ujs.deserializeObject(a,this,["subMaterials"]),this},BABYLON.StandardMaterial.Deserialize=function(a){if(!a)return null;var b=new BABYLON.StandardMaterial(a.name,hcsdesign.engine3D.scene);return b.deserialize(a),b},BABYLON.MultiMaterial.Deserialize=function(a){if(!a)return null;var b=new BABYLON.MultiMaterial(a.name,hcsdesign.engine3D.scene);return b.deserialize(a),b},BABYLON.Vector2.prototype.serialize=function(){var a={"class":{name:"BABYLON.Vector2"},x:this.x,y:this.y};return a},BABYLON.Vector2.Deserialize=function(a){var b=new BABYLON.Vector2(a.x,a.y);return b},BABYLON.Quaternion.Deserialize=function(a){var b=new BABYLON.Quaternion(a.x,a.y,a.z,a.w);return b},BABYLON.Quaternion.prototype.serialize=function(){var a={"class":{name:"BABYLON.Quaternion"},x:this.x,y:this.y,z:this.z,w:this.w};return a},BABYLON.Vector3.prototype.serialize=function(){var a={"class":{name:"BABYLON.Vector3"},x:this.x,y:this.y,z:this.z};return a},BABYLON.Vector3.prototype.getPositionFromMatrix=function(a){return this.x=a.m[12],this.y=a.m[13],this.z=a.m[14],this},BABYLON.Vector3.prototype.getScaleFromMatrix=function(a){var b=this.set(a.m[0],a.m[1],a.m[2]).length(),c=this.set(a.m[4],a.m[5],a.m[6]).length(),d=this.set(a.m[8],a.m[9],a.m[10]).length();return this.x=b,this.y=c,this.z=d,this},BABYLON.Vector3.Deserialize=function(a){var b=new BABYLON.Vector3(a.x,a.y,a.z);return b},BABYLON.Color3.prototype.serialize=function(){var a={"class":{name:"BABYLON.Color3"},r:this.r,g:this.g,b:this.b};return a},BABYLON.Color4.prototype.serialize=function(){var a={"class":{name:"BABYLON.Color4"},r:this.r,g:this.g,b:this.b,a:this.a};return a},BABYLON.Color3.Deserialize=function(a){var b=new BABYLON.Color3(a.r,a.g,a.b);return b},BABYLON.Color4.Deserialize=function(a){var b=new BABYLON.Color4(a.r,a.g,a.b,a.a);return b},BABYLON.BaseTexture.prototype.serialize=function(){this.url=GlobalHelper.stripDomainUrl(this.url,"hcsdesign.");var a={"class":{name:"BABYLON.BaseTexture"},uScale:this.uScale,vScale:this.vScale,url:this.url};return a},BABYLON.BaseTexture.Deserialize=function(a){var b=new BABYLON.BaseTexture(a.url,hcsdesign.engine3D.scene);return b.uScale=a.uScale||1,b.vScale=a.vScale||1,b},BABYLON.Texture.prototype.serialize=function(){var a=BABYLON.BaseTexture.prototype.serialize.call(this);return a["class"].name="BABYLON.Texture",a},BABYLON.Texture.Deserialize=function(a){a.url=GlobalHelper.stripDomainUrl(a.url,"hcsdesign.");var b=new BABYLON.Texture(a.url,hcsdesign.engine3D.scene);return b.uScale=a.uScale||1,b.vScale=a.vScale||1,b},BABYLON.CubeTexture.prototype.serialize=function(){var a=BABYLON.BaseTexture.prototype.serialize.call(this);return a["class"].name="BABYLON.CubeTexture",a},BABYLON.CubeTexture.Deserialize=function(a){var b=new BABYLON.CubeTexture(a.url,hcsdesign.engine3D.scene);return b},BABYLON.Mesh.prototype._lastCollidedFaceIndex=-1,BABYLON.Mesh.prototype.getFloor=function(){return this.parent?-1!=this.parent.name.indexOf("FloorMesh")?this.parent:this.parent.getFloor():null},BABYLON.Node.prototype.getTopLevelObject=function(a){return this.parent?-1!=this.parent.name.indexOf("FloorMesh")?this:-1!=this.parent.name.indexOf("group")&&a?this:this.parent.getTopLevelObject(a):this},BABYLON.Node.prototype.getParentByName=function(a){return this.name!=a?this.parent?this.parent.getParentByName(a):void 0:this},BABYLON.Tools.ExtractMinAndMaxWithTransform=function(a,b,c,d){for(var e=new BABYLON.Vector3(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE),f=new BABYLON.Vector3(-Number.MAX_VALUE,-Number.MAX_VALUE,-Number.MAX_VALUE),g=new BABYLON.Vector3,h=b;b+c>h;h++)g.copyFromFloats(a[3*h],a[3*h+1],a[3*h+2]),g=BABYLON.Vector3.TransformCoordinates(g,d),e=BABYLON.Vector3.Minimize(g,e),f=BABYLON.Vector3.Maximize(g,f);return{minimum:e,maximum:f}},BABYLON.Mesh.prototype.getBoundingBox=function(a){if(!a&&this.__boundingInfo)return this.__boundingInfo.boundingBox;var b=1/0,c=1/0,d=1/0,e=-1/0,f=-1/0,g=-1/0;this.computeWorldMatrix(!0);var h=this.getWorldMatrix().clone();h.invert();var i=function(a){a.computeWorldMatrix(!0);var j=a.getWorldMatrix().clone(),k=j.multiply(h);if(a instanceof BABYLON.Mesh&&a.isVisible){var l=BABYLON.Tools.ExtractMinAndMaxWithTransform(a.getVerticesData(BABYLON.VertexBuffer.PositionKind),0,a.getTotalVertices(),k,!0),m=l.minimum,n=l.maximum;b=Math.min(b,m.x),c=Math.min(c,m.y),d=Math.min(d,m.z),e=Math.max(e,n.x),f=Math.max(f,n.y),g=Math.max(g,n.z)}for(var o=a.getChildren(),p=0,q=o.length;q>p;p++)i(o[p])};i(this);var j=new BABYLON.Vector3(b,c,d),k=new BABYLON.Vector3(e,f,g);return this.__boundingInfo=new BABYLON.BoundingInfo(j,k),this.__boundingInfo.boundingBox},BABYLON.Mesh.prototype.getBoundingSphere=function(a){if(!this.__boundingInfo||a){var b=this.getBoundingBox();this.__boundingInfo.boundingSphere=new BABYLON.BoundingSphere(b.maximum.clone(),b.minimum.clone())}return this.__boundingInfo.boundingSphere},BABYLON.Vector3.RotationFromMatrix=function(a){function b(a){return Math.min(Math.max(a,-1),1)}var c=new BABYLON.Vector3,d=a.m,e=d[0],f=d[4],g=d[8],h=(d[1],d[5]),i=d[9],j=(d[2],d[6]),k=d[10];return c.y=Math.asin(b(g)),Math.abs(g)<.99999?(c.x=Math.atan2(-i,k),c.z=Math.atan2(-f,e)):(c.x=Math.atan2(j,h),c.z=0),c},BABYLON.Mesh.prototype.changeFrame=function(a,b){if(a!==this.parent){var c=this.position.clone(),d=this.rotation.clone(),e=this.parent,f=e.getWorldMatrix().clone(),g=a.getWorldMatrix().clone();g.invert();var h=f.multiply(g);return b?(c.copyFrom(BABYLON.Vector3.TransformCoordinates(c,h)),d.addInPlace(BABYLON.Vector3.RotationFromMatrix(h))):(this.parent=a,this.position.copyFrom(BABYLON.Vector3.TransformCoordinates(this.position,h)),this.rotation.addInPlace(BABYLON.Vector3.RotationFromMatrix(h))),{position:c,rotation:d}}},BABYLON.Mesh.prototype.addInternalRotation=function(a){for(var b=this.getChildren(),c=0,d=b.length;d>c;c++)b[c].rotation.y+=a},BABYLON.PickingInfo.prototype.getFlatNormal=function(){if(!this.pickedMesh)return null;
var a=this.pickedMesh.getIndices(),b=this.pickedMesh.getVerticesData(BABYLON.VertexBuffer.PositionKind),c=BABYLON.Vector3.FromArray(b,3*a[3*this.faceId]),d=BABYLON.Vector3.FromArray(b,3*a[3*this.faceId+1]),e=BABYLON.Vector3.FromArray(b,3*a[3*this.faceId+2]),f=c.subtract(d),g=c.subtract(e);return g.cross(f).normalize()},BABYLON.PickingInfo.getFlatNormal=function(a,b){if(!a)return null;var c=a.getIndices(),d=a.getVerticesData(BABYLON.VertexBuffer.PositionKind),e=BABYLON.Vector3.FromArray(d,3*c[3*b]),f=BABYLON.Vector3.FromArray(d,3*c[3*b+1]),g=BABYLON.Vector3.FromArray(d,3*c[3*b+2]),h=e.subtract(f),i=e.subtract(g);return i.cross(h).normalize()},BABYLON.PickingInfo.GetNormal=function(a,b,c){var d=a.subtract(b),e=c.subtract(b);return commonNormal=BABYLON.Vector3.Normalize(BABYLON.Vector3.Cross(d,e))},BABYLON.Mesh.prototype.duplicate=function(a,b,c){var d=new BABYLON.Mesh(a,this.getScene());if(this._geometry){var e=this._geometry.copy(BABYLON.Geometry.RandomId());e.applyToMesh(d)}if(BABYLON.Tools.DeepCopy(this,d,["name","material","skeleton"],[]),d.material=this.material,b&&(d.parent=b),!c)for(var f=0;f<this.getScene().meshes.length;f++){var g=this.getScene().meshes[f];g.parent==this&&g.duplicate(g.name,d)}for(f=0;f<this.getScene().particleSystems.length;f++){var h=this.getScene().particleSystems[f];h.emitter==this&&h.clone(h.name,d)}return d.computeWorldMatrix(!0),d},BABYLON&&function(){BABYLON.Mesh.prototype.getChildren,BABYLON.Mesh.prototype.getChildren=function(){return this._children=this._children||[]};var a=BABYLON.Mesh.prototype.dispose;BABYLON.Mesh.prototype.dispose=function(){return this.parent=null,a.apply(this,arguments)},Object.defineProperty(BABYLON.Mesh.prototype,"parent",{get:function(){return this._parent},set:function(a){if(this._parent&&this._parent._children)for(var b=this.parent._children.length;b--;)this.parent._children[b]==this&&this.parent._children.splice(b,1);return this._parent=a,this._parent&&(this._parent._children=this._parent._children||[]).push(this),this._parent},enumerable:!0,configurable:!0})}();var hcs=window.hcs||{};hcs.Widget=hcs.Widget||{},hcs.Widget.Rotator=function(){var a,b,c=null,d=null,e=null,f=new BABYLON.Plane(0,1,0,0),g=!1,h=0,i=function(c){a=c,b=this,c.on("click",this.onClick),c.on("refresh",this.onRefreshObject),c.on("selectObject",this.onSelectObject),c.on("deselectObject",this.onDeselectObject),c.on("mousedown",this.onMouseDown),c.on("mouseup",this.onMouseUp),c.on("mousemove",this.onMouseMove),this.setupHistory()};return i.prototype.onRefreshObject=function(a){c&&c.dispose(),c=null,b.addSelectionBox(a.object)},i.prototype.onSelectObject=function(a){b.addSelectionBox(a.object)},i.prototype.onDeselectObject=function(){c&&c.dispose(),c=null},i.prototype.isActive=function(){return g},i.prototype.onClick=function(){},i.prototype.onMouseMove=function(){if(g){var b=hcsdesign.engine3D.projectMouseOnPlane(f),h=c.position,i=d.subtract(h),j=b.subtract(h),k=Math.atan2(i.x,i.z),l=Math.atan2(j.x,j.z),m=e+l-k,n=Math.PI/2,o=Math.round(m/n),p=m-o*n;return Math.abs(p)<.3&&(m-=p),a.getSelectedObject().rotation.y=m,a.getSelectedObject().computeWorldMatrix(!0),a.getSelectedObject().getFloor().markAsDirty(),!1}},i.prototype.onMouseDown=function(c){if(!a.getLocker()||a.getLocker()===b){var h=c.collided;h&&"rotator"==h.pickedMesh.name&&(ujs.notify("hcs.engine3d.dragcontrols.start"),a.getSelectedObject().position,f.d=-h.pickedPoint.y,d=h.pickedPoint,e=a.getSelectedObject().rotation.y,g=!0,a.lock(b))}},i.prototype.onMouseUp=function(){a.getLocker()&&a.getLocker()!==b||(a.getSelectedObject()&&null!==e&&null!==a.getSelectedObject().rotation.y&&e!==a.getSelectedObject().rotation.y&&ujs.notify("hcs.request.historyAction",{component:b,object:a.getSelectedObject(),params:{oldAngle:e,newAngle:a.getSelectedObject().rotation.y},action:h}),ujs.notify("hcs.engine3d.dragcontrols.end"),f.d=0,d=null,e=null,a.unlock(b),g=!1)},i.prototype.setupHistory=function(){this.historycmp=hcsdesign.getComponentByName("HistoryComponent"),this.historycmp&&this.historycmp.registerAction(h,this.undoRotate,this.redoRotate,this)},i.prototype.addHistory=function(a,b,c){this.historycmp&&this.historycmp.actionDone(a,b,c,this)},i.prototype.undoRotate=function(a,c){b.historyRotate(a,c.oldAngle)},i.prototype.redoRotate=function(a,c){b.historyRotate(a,c.newAngle)},i.prototype.historyRotate=function(a,b){a.rotation.y=b,ujs.notify("hcs.request.saveHistory")},i.prototype.getRotationMesh=function(a,b){var c=BABYLON.Mesh.CreateCylinder("rotator",10,2*a+10,2*a,32,1,!1,hcsdesign.engine3D.scene);return c.material=new BABYLON.StandardMaterial("rotator",hcsdesign.engine3D.scene),hcs.MaterialFactory.MakeBasicColor(c.material,b),c.material.backFaceCulling=!1,c},i.prototype.addSelectionBox=function(a){c&&c.dispose();var b=a.getBoundingBox(!0),d=Math.sqrt((b.maximum.x-b.minimum.x)*(b.maximum.x-b.minimum.x)/4+(b.maximum.z-b.minimum.z)*(b.maximum.z-b.minimum.z)/4);c=new BABYLON.Mesh("selector",hcsdesign.engine3D.scene),c.isVisible=!1;var e=new BABYLON.Color3;e.fromHex(-1!==a.name.indexOf("group_")?hcs.Assets.groupColor:hcs.Assets.mainUIColor);var f=this.getRotationMesh(d,e);f.position.y=b.minimum.y+10,f.position.x=b.center.x,f.position.z=b.center.z,f.selectorOf=a,f.parent=c;var g=new BABYLON.Mesh.CreatePlan("rotator",28,14,hcsdesign.engine3D.scene);g.material=new BABYLON.StandardMaterial("buttons",hcsdesign.engine3D.scene),g.material.diffuseTexture=new BABYLON.Texture(hcs.Assets.toolbarTextures.rotateTexture,hcsdesign.engine3D.scene),g.material.diffuseTexture.hasAlpha=!0,g.material.backFaceCulling=!1,hcs.MaterialFactory.MakeBasicMaterial(g.material),g.material.emissiveColor.copyFromFloats(1,1,1),g.position.z=-d-6,g.position.y=Math.PI,g.rotation.x=Math.PI/4,g.selectorOf=a,g.parent=f,c.position=a.getAbsolutePosition(),c.rotation=a.rotation},i}();var hcs=window.hcs||{};hcs.Widget=hcs.Widget||{},hcs.Widget.Info=function(){var a,b,c,d,e,f=null,g=!1,h=function(){},i=function(d){c=d,e=this,a=new BABYLON.SpriteManager("objectMgr",hcs.Assets.toolbarTextures.infoTexture,2,128,hcsdesign.engine3D.scene),b=new BABYLON.SpriteManager("groupMgr",hcs.Assets.toolbarTextures.infoTextureGroup,2,128,hcsdesign.engine3D.scene),d.on("click",this.onClick),d.on("special",this.onSpecial),d.on("selectObject",this.onSelectObject),d.on("deselectObject",this.onDeselectObject)};return i.prototype.setClickCallback=function(a){h=a},i.prototype.onClick=function(a){a.collided&&"_sprite_info"==a.collided.pickedMesh.name&&(h(c.getSelectedObject()),ujs.notify("hcs.engine3D.info",{}))},i.prototype.onSpecial=function(){h(c.getSelectedObject())},i.prototype.onSelectObject=function(){e.addInfo()},i.prototype.onDeselectObject=function(){e.removeInfo()},i.prototype.addInfo=function(){f&&this.removeInfo();var e=c.getSelectedObject().getBoundingBox(),g=new BABYLON.Vector3((e.minimum.x+e.maximum.x)/2,e.maximum.y,(e.minimum.z+e.maximum.z)/2);f=c.isGroup(c.getSelectedObject())?new BABYLON.Sprite("info",b):new BABYLON.Sprite("info",a),f.size=30,d=new BABYLON.Mesh("info",hcsdesign.engine3D.scene),d.isVisible=!1,d.position=c.getSelectedObject().getAbsolutePosition();var h=new BABYLON.Mesh("info",hcsdesign.engine3D.scene);return h.parent=d,h.isVisible=!1,h.position=g,h.position.y+=35,f.position=h.getAbsolutePosition(),toolbar},i.prototype.removeInfo=function(){f&&(f.dispose(),d.dispose()),d=null,f=null},i.prototype.isActive=function(){return g},i}();var hcs=window.hcs||{};hcs.Widget=hcs.Widget||{},hcs.Widget.Elevation=function(){var a,b,c,d=document.getElementById("modalWidgets"),e=!1,f=38,g=287,h=function(b){d=document.getElementById("modalWidgets"),a=b,this.imagePath="images/remote-controller/",this.domElement=this.buildHTML(),this.defaultDomStyle="top: "+f+"px;right: "+g+"px;",this.domElement.setAttribute("style",this.defaultDomStyle),d.appendChild(this.domElement),this.slider=document.getElementById("edition-slider"),this.sliderContainer=document.getElementById("edition-slider-content"),this.globalSliderContainer=document.getElementById("edition-slider-bar"),this.globalSliderContainerHeight=this.globalSliderContainer.scrollHeight,this.sliderMin=12,this.sliderMax=114,this.sliderPos=this.sliderMin,this.sliderSelected=!1,c=this,this.buttonState=null,this.running=!0,this.updateSliderPos(0),this.hide(),b.on("selectObject",this.onSelectObject),b.on("deselectObject",this.onDeselectObject)};return h.prototype.buildHTML=function(){var a=document.createElement("div");a.setAttribute("id","edition-controller");var b=document.createElement("ul");b.setAttribute("id","edition-panel");var c=document.createElement("li");c.setAttribute("id","edition-slider-bar"),c.setAttribute("title",_("距地面高度"));var d=document.createElement("div");d.setAttribute("id","edition-slider-content");var e=document.createElement("img");return e.setAttribute("id","edition-slider"),d.appendChild(e),c.appendChild(d),b.appendChild(c),a.appendChild(b),a},h.prototype.updateDomPosition=function(a,b){this.defaultDomStyle="top: "+b+"px;right: "+a+"px;",this.domElement.setAttribute("style",this.defaultDomStyle)},h.prototype.movePanel=function(){var a=hcsdesign.engine3D.canvas.height,b=Math.round(f+(a-f)/2-document.getElementById("edition-panel").offsetHeight/2);c.updateDomPosition(g,b)},h.prototype.show=function(){document.getElementById("edition-panel").style.display="block"},h.prototype.hide=function(){document.getElementById("edition-panel").style.display="none"},h.prototype.onSelectObject=function(){c.show(),c.movePanel(),c.updateSliderPos(),c.slider.addEventListener("pointerdown",c.onSliderMouseDown,!1),document.addEventListener("pointermove",c.onSliderMouseMove,!1),document.addEventListener("pointerup",c.onMouseUp,!1),document.addEventListener("pointercancel",c.onMouseUp,!1),e=!0},h.prototype.onDeselectObject=function(){c.hide(),c.slider.removeEventListener("pointerdown",c.onSliderMouseDown),document.removeEventListener("pointermove",c.onSliderMouseMove),document.removeEventListener("pointerup",c.onMouseUp),document.removeEventListener("pointercancel",c.onMouseUp),e=!1},h.prototype.init=function(a){this.updateSliderPos(this.sliderValue(this.sceneToRelativeValue(a)))},h.prototype.onSliderMouseDown=function(d){d.preventDefault(),c.sliderSelected=!0,b=a.getSelectedObject().position.y},h.prototype.onSliderMouseMove=function(a){if(c.sliderSelected){var b=(a.touches&&a.touches.length?a.touches[0].clientY:a.clientY)||0,d=c.getValueFromMouse(b),e=c.sceneToRelativeValue(),f=c.sceneValue(d-e);c.setElevationVelocity(f),c.updateSliderPos(),a.preventDefault()}},h.prototype.onMouseUp=function(){if(c.sliderSelected){c.sliderSelected=!1;var d=a.getSelectedObject().position.clone(),e=d.clone();d.y=b;var f=a.getSelectedObject().rotation;ujs.notify("hcs.request.historyAction",{component:a,object:a.getSelectedObject(),params:{oldPosition:d,newPosition:e,oldRotation:f,newRotation:f},action:a.MOVEACTION})}},h.prototype.setElevationVelocity=function(b){a.moveObject(a.getSelectedObject(),new BABYLON.Vector3(0,b,0))},h.prototype.updateSliderPos=function(a){this.sliderPos=void 0!==a?a:this.sliderValue(this.sceneToRelativeValue()),this.slider.style.top=this.sliderPos+"px"},h.prototype.sceneToRelativeValue=function(){var b=0,c=a.getSelectedObject().getFloor().structure.height,d=a.getSelectedObject().position.y;return d=ujs.Math.clamp(d,b,c),(d-b)/(c-b)},h.prototype.sliderToRelativeValue=function(a){var b=a||this.sliderPos;return b=ujs.Math.clamp(b,this.sliderMin,this.sliderMax),1-(b-this.sliderMin)/(this.sliderMax-this.sliderMin)},h.prototype.sliderValue=function(a){return a*(-this.sliderMax+this.sliderMin)+this.sliderMax-c.slider.offsetHeight/2},h.prototype.sceneValue=function(b){return b*a.getSelectedObject().getFloor().structure.height},h.prototype.isActive=function(){return e},h.prototype.getValueFromMouse=function(a){for(var b=c.slider,d=b.parentNode,e=0,f=d;f!=document&&f!=window;)e+=f.offsetTop||0,f=f.parentNode;return 1-ujs.Math.clamp((a-e-this.sliderMin)/(this.sliderMax-this.sliderMin),0,1)},h}();var hcs=window.hcs||{};hcs.Widget=hcs.Widget||{},hcs.Widget.Clone=function(){var a,b,c=!1,d=function(c){a=c,this.icon="fa fa-copy",this.button=this.buildHTML(),this.buttonSelected=!1,b=this,c.on("selectObject",this.onSelectObject),c.on("deselectObject",this.onDeselectObject)};return d.prototype.buildHTML=function(){var a=document.getElementById("edition-panel"),b=document.createElement("li");b.setAttribute("id","edition-clone-button"),b.setAttribute("title",_("复制"));var c=document.createElement("span");c.setAttribute("id","edition-clone-icon"),c.setAttribute("class","menu-icon");var d=document.createElement("i");return d.setAttribute("id","edition-clone-img"),d.setAttribute("class",this.icon),c.appendChild(d),b.appendChild(c),a.appendChild(b),b},d.prototype.onSelectObject=function(){b.button.addEventListener("pointerdown",b.onButtonMouseDown,!1),document.addEventListener("pointerup",b.onMouseUp,!1),document.addEventListener("pointercancel",b.onMouseUp,!1),c=!0},d.prototype.onDeselectObject=function(){b.button.removeEventListener("pointerdown",b.onButtonMouseDown),document.removeEventListener("pointerup",b.onMouseUp),document.removeEventListener("pointercancel",b.onMouseUp),c=!1},d.prototype.onButtonMouseDown=function(a){a.preventDefault(),b.buttonSelected||(b.buttonSelected=!0,ujs.notify("hcs.request.object.clone"))},d.prototype.onMouseUp=function(){b.buttonSelected&&(b.buttonSelected=!1)},d.prototype.isActive=function(){return c},d}();var hcs=window.hcs||{};hcs.Widget=hcs.Widget||{},hcs.Widget.Remove=function(){var a,b,c=!1,d=function(c){a=c,this.icon="fa fa-trash-o",this.button=this.buildHTML(),this.buttonSelected=!1,b=this,c.on("selectObject",this.onSelectObject),c.on("deselectObject",this.onDeselectObject)};return d.prototype.buildHTML=function(){var a=document.getElementById("edition-panel"),b=document.createElement("li");b.setAttribute("id","edition-remove-button"),b.setAttribute("title",_("删除"));var c=document.createElement("span");c.setAttribute("id","edition-remove-icon"),c.setAttribute("class","menu-icon");var d=document.createElement("i");return d.setAttribute("id","edition-remove-img"),d.setAttribute("class",this.icon),c.appendChild(d),b.appendChild(c),a.appendChild(b),b},d.prototype.onSelectObject=function(){b.button.addEventListener("pointerdown",b.onButtonMouseDown,!1),document.addEventListener("pointerup",b.onMouseUp,!1),document.addEventListener("pointercancel",b.onMouseUp,!1),c=!0},d.prototype.onDeselectObject=function(){b.button.removeEventListener("pointerdown",b.onButtonMouseDown),document.removeEventListener("pointerup",b.onMouseUp),document.removeEventListener("pointercancel",b.onMouseUp),c=!1},d.prototype.onButtonMouseDown=function(a){a.preventDefault(),b.buttonSelected||(b.buttonSelected=!0,ujs.notify("hcs.request.object.remove"))},d.prototype.onMouseUp=function(){b.buttonSelected&&(b.buttonSelected=!1)},d.prototype.isActive=function(){return c},d}();var hcs=window.hcs||{};hcs.Widget=hcs.Widget||{},hcs.Widget.Group=function(){var a,b,c=!1,d=function(c){a=c,this.imageGroup="fa fa-link",this.imageUngroup="fa fa-chain-broken",this.img=null,this.button=this.buildHTML(),this.selectedObject=null,this.buttonSelected=!1,b=this,this.hide(),c.on("selectObject",this.onSelectObject),c.on("deselectObject",this.onDeselectObject)};return d.prototype.buildHTML=function(){var a=document.getElementById("edition-panel"),b=document.createElement("li");b.setAttribute("id","edition-group-button"),b.setAttribute("title",_("Group/Ungroup"));var c=document.createElement("span");c.setAttribute("id","edition-group-icon"),c.setAttribute("class","menu-icon");var d=document.createElement("i");return d.setAttribute("id","edition-group-img"),d.setAttribute("class",this.imageUngroup),c.appendChild(d),b.appendChild(c),a.appendChild(b),b},d.prototype.updatePanelColor=function(b){var c=document.getElementById("edition-panel");a.isGroup(b)?(c.style.backgroundColor="#a99384",c.style.borderColor="#a99384"):(c.style.backgroundColor="#897364",c.style.borderColor="#897364")},d.prototype.updateGroupImg=function(){this.img=a.isVirtualGroup(b.selectedObject)?this.imageUngroup:this.imageGroup,document.getElementById("edition-group-img").setAttribute("class",this.img)},d.prototype.show=function(){b.button.style.display="block",b.updateGroupImg(),a.elevationWidget.movePanel()},d.prototype.hide=function(){b.button.style.display="none",a.elevationWidget.movePanel()},d.prototype.onSelectObject=function(d){return b.selectedObject=d.object,b.updatePanelColor(b.selectedObject),a.isGroup(b.selectedObject)?(b.show(),b.button.addEventListener("pointerdown",b.onButtonMouseDown,!1),document.addEventListener("pointerup",b.onMouseUp,!1),document.addEventListener("pointercancel",b.onMouseUp,!1),void(c=!0)):void b.hide()},d.prototype.onDeselectObject=function(){b.selectedObject=null,b.button.removeEventListener("pointerdown",b.onButtonMouseDown),document.removeEventListener("pointerup",b.onMouseUp),document.removeEventListener("pointercancel",b.onMouseUp),c=!1},d.prototype.onButtonMouseDown=function(c){c.preventDefault(),b.buttonSelected||(b.buttonSelected=!0,a.isVirtualGroup(b.selectedObject)?a.virtualToRealGroup():a.deleteSelectedGroup(),b.updateGroupImg())},d.prototype.onMouseUp=function(){b.buttonSelected&&(b.buttonSelected=!1)},d.prototype.isActive=function(){return c},d}();var hcsdesign=hcsdesign||{},API=function(){var a={};a.CONTEXT_2D=hcsdesign.ENGINE_2D||1,a.CONTEXT_3D=hcsdesign.ENGINE_3D||2,a.MODE_2D_NORMAL=1,a.MODE_2D_DRAG=2,a.MODE_2D_DRAW=4,a.MODE_2D_CONTEXTMENU=8,a.MODE_2D_SUBSLOPE=16,a.ORBITCAMERA=0,a.FPSCAMERA=1,a.e2D={},a.e3D={},a.material={},a.UI={},a.HTML={},a.Utils={},a.setContext=function(a){hcsdesign.setSelectedEngine(a)},a.getContext=function(){hcsdesign.getSelectedEngine()},a.getMode=function(b){var c=b||hcsdesign.getSelectedEngine();return c==a.CONTEXT_2D?hcsdesign.engine2D.getMode(name):void(c==a.CONTEXT_3D)},a.getComponent=function(a){var b=hcsdesign.getComponentByName(a);return b||Logger.warning("[WnpAPI] getComponent : The component "+a+" has not been found."),b},a.setMode=function(b,c){var d=c||hcsdesign.getSelectedEngine();d==a.CONTEXT_2D?(hcsdesign.engine2D.setMode(b),hcsdesign.engine2D.requestStaticDraw()):d==a.CONTEXT_3D&&hcsdesign.engine2D.setMode(b)},a.setCameraById=function(a){var b=hcsdesign.getComponentByName("CameraComponent");b&&b.getActiveCameraId()!==a&&this.e3D.switchCamera()},a.getCameraId=function(){return hcsdesign.getComponentByName("CameraComponent").getActiveCameraId()},a.getData=function(a){return hcsdesign.structure.customData[a]},a.setData=function(a,b){hcsdesign.structure.customData[a]=b},a.getCurrentFloor=function(){return hcsdesign.getSelectedStructure()},a.getFloor=function(a){var b=hcsdesign.structure.members[a];return b||Logger.warning("[WnpAPI] getFloor : Requested floor id was not found"),b},a.getWalls=function(a){var b=a||hcsdesign.getSelectedStructure();return b.walls},a.getSubSlopes=function(a){var b=a||hcsdesign.getSelectedStructure();return b.subslopes},a.getRooms=function(a,b){var c=b||hcsdesign.getSelectedStructure(),d=a||!0;return d?c.internalRooms:c.externalRooms},a.getObjects=function(a){var b=a||hcsdesign.getSelectedStructure();return b.objects},a.registerAction=function(a,b,c,d){hcsdesign.getComponentByName("HistoryComponent").registerAction(a,b,c,d)},a.addHistory=function(a,b,c,d){hcsdesign.getComponentByName("HistoryComponent").actionDone(a,b,c,d)},a.material.TexturedMaterial=function(a,b){return new hcs.TexturedMaterial(a,hcsdesign.engine3D.scene,b)},a.material.WhiteMaterial=function(a,b){return new hcs.WhiteMaterial(a,hcsdesign.engine3D.scene,b)},a.material.LeatherMaterial=function(a,b){return new hcs.LeatherMaterial(a,hcsdesign.engine3D.scene,b)},a.material.MetalMaterial=function(a,b){return new hcs.MetalMaterial(a,hcsdesign.engine3D.scene,b)},a.material.WoodMaterial=function(a,b){return new hcs.WoodMaterial(a,hcsdesign.engine3D.scene,b)},a.material.MattMaterial=function(a,b){return new hcs.MattMaterial(a,hcsdesign.engine3D.scene,b)},a.material.GlassMaterial=function(a,b){return new hcs.GlassMaterial(a,hcsdesign.engine3D.scene,b)},a.material.PlasticMaterial=function(a,b){return new hcs.PlasticMaterial(a,hcsdesign.engine3D.scene,b)},a.material.TileMaterial=function(a,b){return new hcs.TileMaterial(a,hcsdesign.engine3D.scene,b)},a.UI.getWidgetContainer=function(){return document.getElementById("modalWidgets")},a.HTML.addHTML=function(a,b,c,d){HTMLHelper.insertHTML(a,b||document.body,c,d)},a.HTML.addScript=function(a,b,c){HTMLHelper.addScript(a,void 0,b,c)},a.HTML.addCSS=function(a,b,c){HTMLHelper.addStylesheet(a,void 0,b,c)},a.Utils.ajax=function(a){var b=a||{};b.params=a.data,ujs.ajax(b)};var b={};return a.listen=function(a,c){return b[a]||(b[a]=[]),-1!=b[a].indexOf(c)?void Logger.warning("[WnpAPI] Event Already listened : cannot listen twice with the same function"):(document.addEventListener(a,c,!1),void b[a].push(c))},a.unListen=function(a,c){if(!b[a])return void Logger.warning("[WnpAPI] No such event is listened");var d=b[a].indexOf(c);return-1==d?void Logger.warning("[WnpAPI] No such function listens to this event"):(document.removeEventListener(a,c,!1),void b[a].splice(d,1))},a.getListeners=function(a){return b[a]},a.getFloorAsPolygon=function(a){var b=hcsdesign.getComponentByName("FloorComponent3D");if(a=0,!(a>=b.structure.members.length)){for(var c=b.structure.members[a],d=[],e=c.points.length;e--;){var f=new BABYLON.Vector2;f.copyFrom(c.points[e].position),d.push(f)}return d}},a.e2D.getMousePos=function(){return hcsdesign.engine2D._pointerManager.getStatus().planPos.clone()},a.e2D.requestStaticDraw=function(){hcsdesign.engine2D.requestStaticDraw()},a.e2D.requestDynamicDraw=function(){hcsdesign.engine2D.requestDynamicDraw()},a.e3D.getCanvas=function(){return hcsdesign.engine3D.canvas},a.e3D.getScene=function(){return hcsdesign.engine3D.scene},a.e3D.getCamera=function(){return hcsdesign.engine3D.scene.activeCamera},a.e3D.switchCamera=function(){ujs.notify("hcs.request.cameraChanged",{activeCameraId:this.cameraActiveId,activeCamera:this.cameraActiveId?"fpsCamera":"orbitCamera"})},a.e3D.getCameraFeatures=function(){return hcsdesign.engine3D.cameraFeatures},a.e3D.getMeshes=function(){return hcsdesign.engine3D.scene.meshes},a.e3D.getRoomMesh=function(){return hcsdesign.engine3D.searchComponent("RoomComponent3D").mesh},a.e3D.setRoomFloorMaterial=function(a){a instanceof hcs.StandardMaterial&&hcsdesign.engine3D.searchComponent("RoomComponent3D").setSideMaterial(a)},a.e3D.setRoomCeilingMaterial=function(a){a instanceof hcs.StandardMaterial&&hcsdesign.engine3D.searchComponent("RoomComponent3D").setCeilingMaterial(a)},a.e3D.getTopLevelMeshes=function(){for(var a=hcsdesign.engine3D.scene,b=[],c=null,d=0,e=a.meshes.length;e>d;d++)c=a.meshes[d].getTopLevelObject(),c.parent&&-1===b.indexOf(c)&&b.push(c);return b},a.e3D.getObjects=function(){for(var a,b=hcsdesign.engine3D.scene,c=[],d=0,e=b.meshes.length;e>d;d++)a=b.meshes[d],-1!==a.name.indexOf("Object_")&&c.push(a);return c},a.e3D.getSunlight=function(){return hcsdesign.engine3D.scene.lights.dir},a.e3D.getSkySphere=function(){return hcsdesign.engine3D.scene.getMeshByName("skysphere")},a.e3D.getGround=function(){return hcsdesign.engine3D.scene.getMeshByName("ground")},a.e3D.projectOnPlane=function(a,b,c){return hcsdesign.engine3D.projectMouseOnPlane(a,b,c)},a.e3D.castShadows=function(a){hcsdesign.engine3D.castShadows(a)},a.e3D.uncastShadows=function(a){hcsdesign.engine3D.uncastShadows(a)},a.e3D.getSelectedObject=function(){return hcsdesign.getComponentByName("EditionComponent3D").getSelectedObject()},a.e3D.intersect=function(a,b,c){var d=c||hcsdesign.engine3D.scene.meshes;return hcsdesign.engine3D.collideWithMeshes(a,b,d)},a.e3D.addSelectedEvent=function(a){hcsdesign.getComponentByName("EditionComponent3D").on("selectObject",a)},a.e3D.addDeselectedEvent=function(a){hcsdesign.getComponentByName("EditionComponent3D").on("deselectObject",a)},a}(),API=API||{};API.Menu=function(){var a={};return a.MENU_TOP="hcs.menu.top",a.MENU_TOP_2="hcs.menu.top.sub",a.MENU_MAIN="hcs.menu.main",a.add=function(a,b,c){var d=c||".";ujs.notify(a+".add",{item:b,menuPath:d})},a}();var ujs=function(){var a={};return a.triggerEvent=function(b,c){if(c instanceof Array)for(var d=0,e=c.length;e>d;d++)a.triggerEvent(b,c[d]);else b[c]&&"function"==typeof b[c]&&b[c](b)},a.notify=function(a,b){var c=document.createEvent("HTMLEvents");if(c.initEvent(a,!0,!1),"object"==typeof b)for(var d in b)c[d]=b[d];try{document.dispatchEvent(c)}catch(e){Logger.warning("[ujs.notify]",e)}},a.getURLParameter=function(a){for(var b=document.location.href.split("?"),c=b[1],d=c.split("&"),e=0,f=d.length,g=null;f>e&&null==g;){var h=d[e].split("=");h[0]==a&&(g=h[1]),e++}return g},a.addOnAttribute=function(a,b,c){var d="style"==a?";":" ",e=b.getAttribute(a),f=!1,g=[];if(null!=e&&""!=e){g=e.split(d);for(var h=g.length,i=0;h>i&&!f;)g[i]==c&&(f=!0),i++}f||g.push(c),b.setAttribute(a,g.join(" "))},a.removeOnAttribute=function(a,b,c){if("object"==typeof b){var d="style"==a?";":" ",e=b.getAttribute(a);if(null!=e&&""!=e){for(var f=e.split(d),g=(f.length,[]),h=0,i=f.length;i>h;h++)f[h]!=c&&g.push(f[h]);b.setAttribute(a,g.join(d))}}},a.addClass=function(b,c){if(c instanceof Array)for(var d=0,e=c.length;e>d;d++)a.addOnAttribute("class",b,c[d]);else a.addOnAttribute("class",b,c)},a.removeClass=function(b,c){if(c instanceof Array)for(var d=0,e=c.length;e>d;d++)a.removeOnAttribute("class",b,c[d]);else a.removeOnAttribute("class",b,c)},a.replaceClass=function(b,c,d){if(b instanceof Array)for(var e=0,f=b.length;f>e;e++)a.removeClass(b[e],c),a.addClass(b[e],d);else a.removeClass(b,c),a.addClass(b,d)},a.removeClasses=function(a){a.setAttribute("class","")},a.addStyle=function(b,c){if(c instanceof Array)for(var d=0,e=c.length;e>d;d++)a.addOnAttribute("style",b,c[d]);else a.addOnAttribute("style",b,c)},a.removeStyle=function(b,c){if(c instanceof Array)for(var d=0,e=c.length;e>d;d++)a.removeOnAttribute("style",b,c[d]);a.removeOnAttribute("style",b,c)},a.hasClass=function(a,b){var c=a.getAttribute("class"),d=!1;if(null!=c)for(var e=c.split(" "),f=0,g=e.length;g>f&&!d;)e[f]==b&&(d=!0),f++;return d},a.mergeObjects=function(b,c,d,e){var d=d===!0?!0:!1,f="array"==e?[]:{};for(var g in b)b.hasOwnProperty(g)&&(f[g]=b[g]);for(var g in c)c.hasOwnProperty(g)&&"undefined"!=typeof c[g]&&(f[g]=c[g]instanceof Array&&d?a.mergeObjects(f[g],c[g],d,"array"):c[g]instanceof Object&&d?a.mergeObjects(f[g],c[g]):c[g]);return f},a.getProperty=function(a,b){var c,d,e=b.split(".");for(c=0;c<e.length;c++){if(d=a[e[c]],c==e.length-1)return a[e[c]];void 0===d&&(d=a[e[c]]={}),a=d}return!1},a.setProperty=function(a,b,c){var d,e,f=b.split(".");for(d=0;d<f.length;d++)e=a[f[d]],void 0!==c&&d==f.length-1?e=a[f[d]]=c:void 0===e&&(e=a[f[d]]={}),a=e;return a},a.ajax=function(a){var b,c=a.url,d=a.method||"GET",e=a.params||"",f=a.success||null,g=a.onerror||null,h="undefined"!=typeof a.async?a.async:!0,i="undefined"!=typeof a.withCredentials?a.withCredentials:!1;if(b="undefined"!=typeof window?window.XMLHttpRequest?new XMLHttpRequest:new ActiveXObject("Microsoft.XMLHTTP"):new XMLHttpRequest,a.mimeType&&b.overrideMimeType(a.mimeType),"POST"==d)b.open("POST",c,h),i&&(b.withCredentials=!0),b.setRequestHeader("Content-type","application/x-www-form-urlencoded"),b.onreadystatechange=function(){4==b.readyState&&200==b.status?null!=f&&f(b.responseText):4==b.readyState&&200!=b.status&&null!=g&&g()},b.send(e);else{var j=""!=e?c+"?"+e:c;b.open("GET",j,h),i&&(b.withCredentials=!0),b.onreadystatechange=function(){4==b.readyState&&200==b.status?null!=f&&f(b.responseText):4==b.readyState&&200!=b.status&&null!=g&&g()},b.send(null)}},a.post=function(b,c){var c=c||{};return c.method="POST",c.url=b,a.ajax(c)},a.loadCSS=function(a,b){var c=document.createElement("link");if(c.setAttribute("rel","stylesheet"),c.setAttribute("type","text/css"),c.setAttribute("href",a),"object"==typeof b)for(var d in b)c.setAttribute(d,b[d]);document.getElementsByTagName("head")[0].appendChild(c)},a.loadJavaScript=function(a,b){var c=document.createElement("script");if(c.setAttribute("src",a),"object"==typeof b)for(var d in b)c.setAttribute(d,b[d]);document.getElementsByTagName("body")[0].appendChild(c)},a.inArray=function(a,b){return b.indexOf(a)>-1},a.cloneArray=function(b,c){for(var d=[],c=c||!1,e=0,f=b.length;f>e;e++)d[e]=c?object[e]instanceof Array?a.cloneArray(b[e]):b[e]instanceof Object?a.cloneObject(b[e]):b[e]:b[e];return d},a.cloneObject=function(b){var c={};for(var d in b)b.hasOwnProperty(d)&&(c[d]=b[d]instanceof Array?a.cloneArray(b[d]):b[d]instanceof Object?a.cloneObject(b[d]):b[d]);return c},a.insertSorted=function(a,b,c){var d=0;if(0==c.length)c.push(a);else{for(;d<c.length&&b(a,c[d])>0;)d++;c.splice(d,0,a)}return c},a.getByClass=function(a){return document.getElementsByClassName(a)},a.getByTag=function(a){return document.getElementsByTagName(a)},a.getById=function(a){return document.getElementById(a)},a.isDef=function(a){return"undefined"!=typeof a},a.removeSpaces=function(a){var b=new RegExp("[ ]+","g");return a.replace(b,"")},a.stringToFunction=function(a){for(var b=a.split("."),c=window||this,d=0,e=b.length;e>d;d++)c=c[b[d]];if("function"!=typeof c)throw new Error("function not found");return c},a.deserializeObject=function(b,c,d,e){var f,g=null;if(b&&b["class"]&&b["class"].name&&!c){var h=a.stringToFunction(b["class"].name);g=h.Deserialize(b)}else if(b instanceof Array){if(0==b.length)return g;g=c||[];for(var i=0;i<b.length;i++)f=a.deserializeObject(b[i]),null!==f&&g.push(f)}else if(b instanceof Object){g=c||{};for(var j in b)(!d||d&&-1!=d.indexOf(j))&&(!e||e&&-1==e.indexOf(j))&&(f=a.deserializeObject(b[j]),null!==f&&(g[j]=f))}else void 0!==g&&(g=b);return g},a.serializeObject=function(b,c,d,e){var f,g;if(b&&b.serialize&&!c)f=b.serialize();else if(b instanceof Array){f=[];for(var h=0;h<b.length;h++)f.push(a.serializeObject(b[h]));if(0==f.length)return null}else if(b instanceof Object){if(!(b instanceof Function)){f=c||{};for(var i in b)b.hasOwnProperty(i)&&(!d||d&&-1!=d.indexOf(i))&&(!e||e&&-1==e.indexOf(i))&&(g=a.serializeObject(b[i]),void 0!==g&&null!==g&&(f[i]=g))}}else f=b;return f},a}(),ujs=window.ujs||{};ujs.Math=ujs.Math||{},function(){ujs.Math.getRandomInt=function(a,b){return Math.floor(Math.random()*(b-a+1))+a},ujs.Math.clamp=function(a,b,c){return b>a?b:a>c?c:a},ujs.Math.lerp=function(a,b,c){return c=0>c?0:c,c=c>1?1:c,a+(b-a)*c},ujs.Math.sign=function(a){return 0>a?-1:1}}();var PolygonMerger=function(){var a=1e5,b=function(a,b){var c;c=a,a=b,b=c},c=function(b){return Math.round(b*a)/a},d=function(a){this.position=new BABYLON.Vector2,this.position.copyFromFloats(c(a.x),c(a.y)),this.parents=[]};d.prototype.replaceParent=function(a,b){var c=this.parents.indexOf(a);-1!=c&&(this.parents[c]=b)},d.prototype.clone=function(){var a=new d(this.position);return a.parents=this.parents.slice(0),a},d.prototype.removeParent=function(a){var b=this.parents.indexOf(a);-1!=b&&this.parents.splice(b,1)};var e=function(){this.points=[],this.intersections=[],this.parent=null,this.parentWallSide=null};e.prototype.length=function(){return this.points[1].position.distanceTo(this.points[0].position)},e.prototype.clone=function(){for(var a=new e,b=0,c=this.points.length;c>b;b++)a.points.push(this.points[b].clone());return a.parent=this.parent,a.parentWallSide=this.parentWallSide,a};var f=function(){this.edges=[]};f.prototype.fromWall=function(a){var b=a.getPolygon();if(!(b.length<1)){for(var c,f,g=null,h=null,i=0,j=b.length;j>i;i++)c=new d(b[i]),f=new e,f.parent=a,f.points.push(c),c.parents.push(f),h&&(c.parents.push(h),h.points.push(c)),h=f,g=c,this.edges.push(f);this.edges[0].points[0].parents.push(f),f.points.push(this.edges[0].points[0]);for(var i=0,j=this.edges.length;j>i;i++)this.edges[i].parentWallSide=this.getEdgeNormal(i).normalize();return this}};var g,h,i;e.prototype.debug=function(){g.save(),g.strokeStyle="#FF0000",g.lineWidth=3,g.translate(h.x,h.y),g.scale(i,i),g.beginPath(),g.moveTo(this.points[0].position.x,this.points[0].position.y),g.lineTo(this.points[1].position.x,this.points[1].position.y),g.stroke(),g.restore()
},f.prototype.debug=function(a,b,c){a.save(),a.strokeStyle="#FF0000",a.lineWidth=6,a.translate(b.x,b.y),a.scale(c,c);for(var d=0,e=this.edges.length;e>d;d++)a.beginPath(),a.moveTo(this.edges[d].points[0].position.x,this.edges[d].points[0].position.y),a.lineTo(this.edges[d].points[1].position.x,this.edges[d].points[1].position.y),a.stroke();a.restore()},f.prototype.computeIntersections=function(a){for(var b=[],c=0,e=this.edges.length;e>c;c++)for(var f=0,g=a.edges.length;g>f;f++){var h=BABYLON.Vector2.SegmentIntersection(this.edges[c].points[0].position,this.edges[c].points[1].position,a.edges[f].points[0].position,a.edges[f].points[1].position,0,Math.PI/2e3);if(h){var i=new d(h);i.parents.push(this.edges[c],a.edges[f]),this.edges[c].intersections.push(i),a.edges[f].intersections.push(i),b.push(i)}}this.mergeIntersections(b)},f.prototype.smashEdge=function(a,b){for(var c=new d(BABYLON.Vector2.Lerp(b.position,a.position,.5)),e=this.edges.length-1;e>=0;e--)for(var f=0;2>f;f++)(this.edges[e].points[f]==a||this.edges[e].points[f]==b)&&(this.edges[e].points[f]=c)},f.prototype.splitAtIntersections=function(a){var b,c,d=1e-5,f=[],g=null,h=function(a,c,d){return b=new e,b.parent=d.parent,b.parentWallSide=d.parentWallSide,b.points[0]=a,b.points[1]=c,a.replaceParent(d,b),c.replaceParent(d,b),b},i=function(a,b){a.intersections.sort(function(a,c){return a.position.distanceTo(b)-c.position.distanceTo(b)})},j=(new BABYLON.Vector2,function(b,c){return this.edges[b].parentWallSide.dot(a.edges[c].parentWallSide)>=0}.bind(this)),k=new BABYLON.Vector2,l=function(b,e,f){return k.copyFrom(b.position).lerp(e.position,.5),c=a.edgeIndexVeryClose(k,d),-1!=c?!j(f,c):a.isPointIn(k)},m=function(a,b,c){return a.position.distanceTo(b.position)<d?!0:!l(a,b,c)};if(!(this.edges.length<1)){for(var n=0,o=this.edges.length;o>n;n++){g=this.edges[n].points[0],i(this.edges[n],g.position);for(var p=0,q=this.edges[n].intersections.length;q>p;p++)m(this.edges[n].intersections[p],g,n)?f.push(h(g,this.edges[n].intersections[p],this.edges[n])):PolygonMerger.addDeletedEdge(h(g.clone(),this.edges[n].intersections[p].clone(),this.edges[n])),g=this.edges[n].intersections[p];m(this.edges[n].points[1],g,n)?f.push(h(g,this.edges[n].points[1],this.edges[n])):PolygonMerger.addDeletedEdge(h(g.clone(),this.edges[n].points[1].clone(),this.edges[n]))}return f}},f.prototype.getInstancesOfPoint=function(a){for(var b=[],c=0,d=this.edges.length;d>c;c++)for(var e=0;2>e;e++)this.edges[c].points[e]===a&&b.push({edgeIndex:c,pointIndex:e});return b};var j=function(a,b){var c=this.edges[a.edgeIndex],d=c.points[(a.pointIndex+1)%2];return d.position.subtract(b.position)};f.prototype.updateParents=function(){for(var a=this.edges.length-1;a>=0;a--)for(var b=0;2>b;b++)if(this.edges[a].points[b].parents.length<2)this.edges[a].points[b].parents.push(this.edges[a]);else if(-1==this.edges[a].points[b].parents.indexOf(this.edges[a])){var c=this.getInstancesOfPoint(this.edges[a].points[b]);if(3===c.length){for(var e,f,g,h,i=.01,k=1/0,l=1/0,m=0;3>m;m++){h=this.edges[c[m].edgeIndex].length(),l>h&&(l=h,g=c[m].edgeIndex);for(var n=m+1;3>n;n++)e=Math.abs(h-this.edges[c[n].edgeIndex].length()),k>e&&(f=c[m].edgeIndex,k=e)}i>k?this.edges.splice(f,1):this.edges.splice(g,1);continue}if(4!==c.length)continue;var o=this.edges[a].points[b];o.parents.length=0;var p,q=new d(this.edges[a].points[b].position.clone()),r=c[0];c.splice(0,1);for(var m=0;3>m;m++)if(this.edges[c[m].edgeIndex].parent===this.edges[r.edgeIndex].parent){p=c[m],c.splice(m,1);break}if(!p){Logger.warning("Erreur, instance jumelle du point multiple non trouvée");continue}for(var s=j.call(this,r,o),t=j.call(this,p,o),u=BABYLON.Math.NormalizeAngle(Math.atan2(t.y,t.x)-Math.atan2(s.y,s.x),!0),v=[],m=0;2>m;m++)v.push(j.call(this,c[m],o)),v[m].angle=BABYLON.Math.NormalizeAngle(Math.atan2(v[m].y,v[m].x)-Math.atan2(s.y,s.x),!0);var w,x;Math.PI/40,w=v[0].angle>u?v[0].angle>v[1].angle?c[0]:c[1]:v[0].angle<v[1].angle?c[0]:c[1],c.splice(c.indexOf(w),1),x=c[0],q.parents.push(this.edges[r.edgeIndex],this.edges[w.edgeIndex]),this.edges[r.edgeIndex].points[this.edges[r.pointIndex]]=q,this.edges[w.edgeIndex].points[this.edges[w.pointIndex]]=q,q.parents.push(this.edges[x.edgeIndex],this.edges[p.edgeIndex])}},f.prototype.mergeIntersections=function(a){for(var b=1e-5,c=0,d=a.length;d>c;c++)for(var e=a.length-1;e>c;e--)a[c].position.distanceTo(a[e].position)<b&&(a[e].parents[0].intersections.splice(a[e].parents[0].intersections.indexOf(a[e]),1),a[e].parents[1].intersections.splice(a[e].parents[1].intersections.indexOf(a[e]),1),a.splice(e,1))},f.prototype.deleteSmallEdges=function(){var a=1e-5;if(!(this.edges.length<=3)){for(var b=0,c=this.edges.length;c>b;b++)this.edges[b].length()<a&&(this.smashEdge(this.edges[b].points[0],this.edges[b].points[1],this.edges[b]),this.edges.splice(b,1),b--,c--);this.updateParents()}},f.prototype.normalizePolygon=function(){for(var a,b=1e-5,c=this.edges,f=0,g=c.length;g>f;f++)for(var h=f+1;g>h;h++)if(a=BABYLON.Vector2.SegmentIntersection(c[f].points[0].position,c[f].points[1].position,c[h].points[0].position,c[h].points[1].position,-b)){var i=new d(a),j=new d(a),k=new e;k.parent=c[f].parent,k.parentWallSide=c[f].parentWallSide,k.points.push(c[f].points[0],i),c[f].points[0]=i,i.parents.push(k,c[f]);var l=new e;l.parent=c[h].parent,l.parentWallSide=c[h].parentWallSide,l.points.push(c[h].points[0],j),c[h].points[0]=j,j.parents.push(l,c[h]),c.push(k,l)}},f.prototype.distanceTo=function(a){for(var b,c=new BABYLON.Vector2,d=1/0,e=0,f=this.edges.length;f>e;e++)c.copy(a),c=c.projectOnSegment(this.edges[e].points[0].position,this.edges[e].points[1].position),b=c.distanceTo(a),d=Math.min(d,b);return d},f.prototype.edgeIndexVeryClose=function(a,b){for(var c,d=new BABYLON.Vector2,e=0,f=this.edges.length;f>e;e++)if(d.copyFrom(a),d=d.projectOnSegment(this.edges[e].points[0].position,this.edges[e].points[1].position),c=d.distanceTo(a),b>c)return e;return-1},f.prototype.isPointIn=function(a){var d,e,f,g,a=a.clone();a.x=c(a.x),a.y=c(a.y);for(var h=[],i=!1,j=0,k=this.edges.length;k>j;j++)d=this.edges[j].points[0].position.x,e=this.edges[j].points[0].position.y,f=this.edges[j].points[1].position.x,g=this.edges[j].points[1].position.y,(this.edges[j].points[0].alreadyVisited||this.edges[j].points[1].alreadyVisited)&&(b(d,f),b(e,g)),this.edges[j].points[0].alreadyVisited=!0,this.edges[j].points[1].alreadyVisited=!0,h.push(this.edges[j].points[0],this.edges[j].points[1]),g===e&&g===a.y?(d<=a.x&&a.x<f||f<=a.x&&a.x<d)&&(i=!i):(e<=a.y&&a.y<g||g<=a.y&&a.y<e)&&a.x<=c((f-d)*(a.y-e)/(g-e)+d)&&(i=!i);for(var j=0,k=h.length;k>j;j++)h[j].alreadyVisited=!1;return i},f.prototype.getEdgeNormal=function(a){var d,e,f,g,h=[],i=BABYLON.Vector2.Lerp(this.edges[a].points[0].position,this.edges[a].points[1].position,.5),j="x",k="y";i.y===this.edges[a].points[0].position.y&&(j="y",k="x");for(var l=!1,m=0,n=this.edges.length;n>m;m++)a!==m&&(d=this.edges[m].points[0].position[j],e=this.edges[m].points[0].position[k],f=this.edges[m].points[1].position[j],g=this.edges[m].points[1].position[k],(this.edges[m].points[0].alreadyVisited||this.edges[m].points[1].alreadyVisited)&&(b(d,f),b(e,g)),this.edges[m].points[0].alreadyVisited=!0,this.edges[m].points[1].alreadyVisited=!0,h.push(this.edges[m].points[0],this.edges[m].points[1]),g===e&&g===i[k]?(d<=i[j]&&i[j]<f||f<=i[j]&&i[j]<d)&&(l=!l):(e<=i[k]&&i[k]<g||g<=i[k]&&i[k]<e)&&i[j]<=c((f-d)*(i[k]-e)/(g-e)+d)&&(l=!l));for(var m=0,n=h.length;n>m;m++)h[m].alreadyVisited=!1;var o=this.edges[a].points[1].position.subtract(this.edges[a].points[0].position);return o.copyFromFloats(-o.y,o.x).normalize(),(!l&&o[j]<=0||l&&o[j]>0)&&o.scaleInPlace(-1),o},f.prototype.mergeVertices=function(){for(var a=[],b=1e-5,c=0,d=this.edges.length;d>c;c++)-1===a.indexOf(this.edges[c].points[0])&&a.push(this.edges[c].points[0]),-1===a.indexOf(this.edges[c].points[1])&&a.push(this.edges[c].points[1]);for(var c=0,d=a.length;d>c;c++)for(var e=c+1;d>e;e++)if(a[c].position.distanceTo(a[e].position)<b){for(var f=a[c].parents,g=a[e].parents,h=-1,i=-1,j=0;2>j;j++)-1===this.edges.indexOf(f[j])&&(h=(j+1)%2),-1===this.edges.indexOf(g[j])&&(i=(j+1)%2);-1!=h&&-1!=i&&(g[i].points.splice(g[i].points.indexOf(a[e]),1),g[i].points.push(a[c]),a[c].parents[0]=f[h],a[c].parents[1]=g[i])}},f.prototype.processCycles=function(){for(var a,b=200,c=[],d=function(a,b){var c=(b.points.indexOf(a)+1)%2,d=b.points[c],e=(d.parents.indexOf(b)+1)%2;return{edge:d.parents[e],point:d}},f=function(a){var c,f=[],g=a,h=a.points[0],i=h,j=0;h.parents.length=0,h.parentWallSide=[];do{if(null==g||!(g instanceof e))return null;f.push(h),h.parents.push(g.parent),h.parentWallSide.push(g.parentWallSide),g.visited=!0,c=d(h,g),h=c.point,h.parents.length=0,h.parentWallSide=[],h.parents.push(g.parent),h.parentWallSide.push(g.parentWallSide),g=c.edge}while(++j<3||h!==i&&b>j);return h.parents.push(a.parent),h.parentWallSide.push(a.parentWallSide),j==b?null:f},g=0,h=this.edges.length;h>g;g++)this.edges[g].visited||(a=f(this.edges[g]),a&&c.push(a));return c},f.prototype.toShape=function(){return void console.warn("NOT COMPATIBLE WITH BABYLON.JS")};var k,l,m=[],n=function(){};return n.addDeletedEdge=function(a){m.push(a)},n.merge=function(a,b,c,d,e){var j=[];m.length=0;for(var n=0,o=a.length;o>n;n++)j.push((new f).fromWall(a[n]));if(j.length<1)return null;for(var p,q,r=j[0],n=1,o=j.length;o>n;n++)j[n].normalizePolygon(),r.computeIntersections(j[n]),p=j[n].splitAtIntersections(r),q=r.splitAtIntersections(j[n]),r.edges=p.concat(q),r.deleteSmallEdges();return r.mergeVertices(),c&&(g=c,h=d,i=e),k=r,b?r.edges:l=r.processCycles()},n.reconstitutePolygon=function(a,b){var c=[],d=[],g=[],h=new f;b||(b=this.getCachedPolygon());for(var i,j,k=function(){if(!(h.edges.length<2))for(var b,c,f,i,j=0,k=d.length;k>j;j++)if(2!==d[j].parents.length){b=1/0,f=null;for(var l=j+1;k>l;l++)1===d[l].parents.length&&(c=d[l].position.distanceTo(d[j].position),b>c&&(b=c,f=d[l]));null!==f?(i=new e,i.parent=a,i.points.push(d[j],f),d[j].parents.push(i),f.parents.push(i),g.push(i)):Logger.warning("Warning : could not connect every point in reconstitutePolygon")}},l=0,m=b.edges.length;m>l;l++)if(b.edges[l].parent===a){i=b.edges[l].clone();for(var n=0;2>n;n++)j=c.indexOf(b.edges[l].points[n]),-1===j?(c.push(b.edges[l].points[n]),d.push(i.points[n]),i.points[n].parents.length=0):i.points[n]=d[j],i.points[n].parents.push(i);h.edges.push(i)}return k(),h.edges=h.edges.concat(g),h.edges.length>2?h:null},n.simplifyCycles=function(a){for(var b=0,c=a.length;c>b;b++)this.simplifyCycle(a[b])},n.simplifyCycle=function(a){for(var b=function(a,b){return a.parents[0]==b.parents[0]||a.parents[0]==b.parents[1]?a.parents[0]:a.parents[1]},c=function(a,b,c){var d,e=Math.PI/80,f=10,g=b.subtract(a),h=c.subtract(b);return g.length()<f||h.length()<f?!1:(d=Math.abs(g.determinant(h)),e>d)},d=0,e=a.length;e>d;d++)c(a[d].position,a[(d+1)%e].position,a[(d+2)%e].position)&&b(a[d],a[(d+1)%e]).height===b(a[(d+1)%e],a[(d+2)%e]).height&&(console.log("colinear ! "),a.splice((d+1)%e,1),d--,e--);return a},n.getCachedCycles=function(){return l},n.getCachedPolygon=function(){return k},n.getCachedDeletedEdges=function(){return m},n}();!function(a){if("object"==typeof exports)module.exports=a();else if("function"==typeof define&&define.amd)define(a);else{var b;"undefined"!=typeof window?b=window:"undefined"!=typeof global?b=global:"undefined"!=typeof self&&(b=self),b.poly2tri=a()}}(function(){return function a(b,c,d){function e(g,h){if(!c[g]){if(!b[g]){var i="function"==typeof require&&require;if(!h&&i)return i(g,!0);if(f)return f(g,!0);throw new Error("Cannot find module '"+g+"'")}var j=c[g]={exports:{}};b[g][0].call(j.exports,function(a){var c=b[g][1][a];return e(c?c:a)},j,j.exports,a,b,c,d)}return c[g].exports}for(var f="function"==typeof require&&require,g=0;g<d.length;g++)e(d[g]);return e}({1:[function(a,b){b.exports={version:"1.3.3"}},{}],2:[function(a,b){"use strict";var c=function(a,b){this.point=a,this.triangle=b||null,this.next=null,this.prev=null,this.value=a.x},d=function(a,b){this.head_=a,this.tail_=b,this.search_node_=a};d.prototype.head=function(){return this.head_},d.prototype.setHead=function(a){this.head_=a},d.prototype.tail=function(){return this.tail_},d.prototype.setTail=function(a){this.tail_=a},d.prototype.search=function(){return this.search_node_},d.prototype.setSearch=function(a){this.search_node_=a},d.prototype.findSearchNode=function(){return this.search_node_},d.prototype.locateNode=function(a){var b=this.search_node_;if(a<b.value){for(;b=b.prev;)if(a>=b.value)return this.search_node_=b,b}else for(;b=b.next;)if(a<b.value)return this.search_node_=b.prev,b.prev;return null},d.prototype.locatePoint=function(a){var b=a.x,c=this.findSearchNode(b),d=c.point.x;if(b===d){if(a!==c.point)if(a===c.prev.point)c=c.prev;else{if(a!==c.next.point)throw new Error("poly2tri Invalid AdvancingFront.locatePoint() call");c=c.next}}else if(d>b)for(;(c=c.prev)&&a!==c.point;);else for(;(c=c.next)&&a!==c.point;);return c&&(this.search_node_=c),c},b.exports=d,b.exports.Node=c},{}],3:[function(a,b){"use strict";var c=a("./xy"),d=function(a,b){this.x=+a||0,this.y=+b||0,this._p2t_edge_list=null};d.prototype.toString=function(){return c.toStringBase(this)},d.prototype.clone=function(){return new d(this.x,this.y)},d.prototype.set_zero=function(){return this.x=0,this.y=0,this},d.prototype.set=function(a,b){return this.x=+a||0,this.y=+b||0,this},d.prototype.negate=function(){return this.x=-this.x,this.y=-this.y,this},d.prototype.add=function(a){return this.x+=a.x,this.y+=a.y,this},d.prototype.sub=function(a){return this.x-=a.x,this.y-=a.y,this},d.prototype.mul=function(a){return this.x*=a,this.y*=a,this},d.prototype.length=function(){return Math.sqrt(this.x*this.x+this.y*this.y)},d.prototype.normalize=function(){var a=this.length();return this.x/=a,this.y/=a,a},d.prototype.equals=function(a){return this.x===a.x&&this.y===a.y},d.negate=function(a){return new d(-a.x,-a.y)},d.add=function(a,b){return new d(a.x+b.x,a.y+b.y)},d.sub=function(a,b){return new d(a.x-b.x,a.y-b.y)},d.mul=function(a,b){return new d(a*b.x,a*b.y)},d.cross=function(a,b){return"number"==typeof a?"number"==typeof b?a*b:new d(-a*b.y,a*b.x):"number"==typeof b?new d(b*a.y,-b*a.x):a.x*b.y-a.y*b.x},d.toString=c.toString,d.compare=c.compare,d.cmp=c.compare,d.equals=c.equals,d.dot=function(a,b){return a.x*b.x+a.y*b.y},b.exports=d},{"./xy":10}],4:[function(a,b){"use strict";var c=a("./xy"),d=function(a,b){this.name="PointError",this.points=b=b||[],this.message=a||"Invalid Points!";for(var d=0;d<b.length;d++)this.message+=" "+c.toString(b[d])};d.prototype=new Error,d.prototype.constructor=d,b.exports=d},{"./xy":10}],5:[function(a,b,c){(function(b){"use strict";var d=b.poly2tri;c.noConflict=function(){return b.poly2tri=d,c},c.VERSION=a("../dist/version.json").version,c.PointError=a("./pointerror"),c.Point=a("./point"),c.Triangle=a("./triangle"),c.SweepContext=a("./sweepcontext");var e=a("./sweep");c.triangulate=e.triangulate,c.sweep={Triangulate:e.triangulate}}).call(this,"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"../dist/version.json":1,"./point":3,"./pointerror":4,"./sweep":6,"./sweepcontext":7,"./triangle":8}],6:[function(a,b,c){"use strict";function d(a){a.initTriangulation(),a.createAdvancingFront(),e(a),f(a)}function e(a){var b,c=a.pointCount();for(b=1;c>b;++b)for(var d=a.getPoint(b),e=g(a,d),f=d._p2t_edge_list,i=0;f&&i<f.length;++i)h(a,f[i],e)}function f(a){for(var b=a.front().head().next.triangle,c=a.front().head().next.point;!b.getConstrainedEdgeCW(c);)b=b.neighborCCW(c);a.meshClean(b)}function g(a,b){var c=a.locateNode(b),d=k(a,b,c);return b.x<=c.point.x+O&&l(a,c),m(a,d),d}function h(a,b,c){a.edge_event.constrained_edge=b,a.edge_event.right=b.p.x>b.q.x,j(c.triangle,b.p,b.q)||(v(a,b,c),i(a,b.p,b.q,c.triangle,b.q))}function i(a,b,c,d,e){if(!j(d,b,c)){var f=d.pointCCW(e),g=Q(c,f,b);if(g===P.COLLINEAR)throw new I("poly2tri EdgeEvent: Collinear not supported!",[c,f,b]);var h=d.pointCW(e),k=Q(c,h,b);if(k===P.COLLINEAR)throw new I("poly2tri EdgeEvent: Collinear not supported!",[c,h,b]);g===k?(d=g===P.CW?d.neighborCCW(e):d.neighborCW(e),i(a,b,c,d,e)):E(a,b,c,d,e)}}function j(a,b,c){var d=a.edgeIndex(b,c);if(-1!==d){a.markConstrainedEdgeByIndex(d);var e=a.getNeighbor(d);return e&&e.markConstrainedEdgeByPoints(b,c),!0}return!1}function k(a,b,c){var d=new J(b,c.point,c.next.point);d.markNeighbor(c.triangle),a.addToMap(d);var e=new K(b);return e.next=c.next,e.prev=c,c.next.prev=e,c.next=e,p(a,d)||a.mapTriangleToNodes(d),e}function l(a,b){var c=new J(b.prev.point,b.point,b.next.point);c.markNeighbor(b.prev.triangle),c.markNeighbor(b.triangle),a.addToMap(c),b.prev.next=b.next,b.next.prev=b.prev,p(a,c)||a.mapTriangleToNodes(c)}function m(a,b){for(var c,d=b.next;d.next&&(c=o(d),!(c>N||-N>c));)l(a,d),d=d.next;for(d=b.prev;d.prev&&(c=o(d),!(c>N||-N>c));)l(a,d),d=d.prev;b.next&&b.next.next&&(c=n(b),M>c&&s(a,b))}function n(a){var b=a.point.x-a.next.next.point.x,c=a.point.y-a.next.next.point.y;return Math.atan2(c,b)}function o(a){var b=a.next.point.x-a.point.x,c=a.next.point.y-a.point.y,d=a.prev.point.x-a.point.x,e=a.prev.point.y-a.point.y;return Math.atan2(b*e-c*d,b*d+c*e)}function p(a,b){for(var c=0;3>c;++c)if(!b.delaunay_edge[c]){var d=b.getNeighbor(c);if(d){var e=b.getPoint(c),f=d.oppositePoint(b,e),g=d.index(f);if(d.constrained_edge[g]||d.delaunay_edge[g]){b.constrained_edge[c]=d.constrained_edge[g];continue}var h=q(e,b.pointCCW(e),b.pointCW(e),f);if(h){b.delaunay_edge[c]=!0,d.delaunay_edge[g]=!0,r(b,e,d,f);var i=!p(a,b);return i&&a.mapTriangleToNodes(b),i=!p(a,d),i&&a.mapTriangleToNodes(d),b.delaunay_edge[c]=!1,d.delaunay_edge[g]=!1,!0}}}return!1}function q(a,b,c,d){var e=a.x-d.x,f=a.y-d.y,g=b.x-d.x,h=b.y-d.y,i=e*h,j=g*f,k=i-j;if(0>=k)return!1;var l=c.x-d.x,m=c.y-d.y,n=l*f,o=e*m,p=n-o;if(0>=p)return!1;var q=g*m,r=l*h,s=e*e+f*f,t=g*g+h*h,u=l*l+m*m,v=s*(q-r)+t*p+u*k;return v>0}function r(a,b,c,d){var e,f,g,h;e=a.neighborCCW(b),f=a.neighborCW(b),g=c.neighborCCW(d),h=c.neighborCW(d);var i,j,k,l;i=a.getConstrainedEdgeCCW(b),j=a.getConstrainedEdgeCW(b),k=c.getConstrainedEdgeCCW(d),l=c.getConstrainedEdgeCW(d);var m,n,o,p;m=a.getDelaunayEdgeCCW(b),n=a.getDelaunayEdgeCW(b),o=c.getDelaunayEdgeCCW(d),p=c.getDelaunayEdgeCW(d),a.legalize(b,d),c.legalize(d,b),c.setDelaunayEdgeCCW(b,m),a.setDelaunayEdgeCW(b,n),a.setDelaunayEdgeCCW(d,o),c.setDelaunayEdgeCW(d,p),c.setConstrainedEdgeCCW(b,i),a.setConstrainedEdgeCW(b,j),a.setConstrainedEdgeCCW(d,k),c.setConstrainedEdgeCW(d,l),a.clearNeigbors(),c.clearNeigbors(),e&&c.markNeighbor(e),f&&a.markNeighbor(f),g&&a.markNeighbor(g),h&&c.markNeighbor(h),a.markNeighbor(c)}function s(a,b){for(a.basin.left_node=Q(b.point,b.next.point,b.next.next.point)===P.CCW?b.next.next:b.next,a.basin.bottom_node=a.basin.left_node;a.basin.bottom_node.next&&a.basin.bottom_node.point.y>=a.basin.bottom_node.next.point.y;)a.basin.bottom_node=a.basin.bottom_node.next;if(a.basin.bottom_node!==a.basin.left_node){for(a.basin.right_node=a.basin.bottom_node;a.basin.right_node.next&&a.basin.right_node.point.y<a.basin.right_node.next.point.y;)a.basin.right_node=a.basin.right_node.next;a.basin.right_node!==a.basin.bottom_node&&(a.basin.width=a.basin.right_node.point.x-a.basin.left_node.point.x,a.basin.left_highest=a.basin.left_node.point.y>a.basin.right_node.point.y,t(a,a.basin.bottom_node))}}function t(a,b){if(!u(a,b)){l(a,b);var c;if(b.prev!==a.basin.left_node||b.next!==a.basin.right_node){if(b.prev===a.basin.left_node){if(c=Q(b.point,b.next.point,b.next.next.point),c===P.CW)return;b=b.next}else if(b.next===a.basin.right_node){if(c=Q(b.point,b.prev.point,b.prev.prev.point),c===P.CCW)return;b=b.prev}else b=b.prev.point.y<b.next.point.y?b.prev:b.next;t(a,b)}}}function u(a,b){var c;return c=a.basin.left_highest?a.basin.left_node.point.y-b.point.y:a.basin.right_node.point.y-b.point.y,a.basin.width>c?!0:!1}function v(a,b,c){a.edge_event.right?w(a,b,c):A(a,b,c)}function w(a,b,c){for(;c.next.point.x<b.p.x;)Q(b.q,c.next.point,b.p)===P.CCW?x(a,b,c):c=c.next}function x(a,b,c){c.point.x<b.p.x&&(Q(c.point,c.next.point,c.next.next.point)===P.CCW?y(a,b,c):(z(a,b,c),x(a,b,c)))}function y(a,b,c){l(a,c.next),c.next.point!==b.p&&Q(b.q,c.next.point,b.p)===P.CCW&&Q(c.point,c.next.point,c.next.next.point)===P.CCW&&y(a,b,c)}function z(a,b,c){Q(c.next.point,c.next.next.point,c.next.next.next.point)===P.CCW?y(a,b,c.next):Q(b.q,c.next.next.point,b.p)===P.CCW&&z(a,b,c.next)}function A(a,b,c){for(;c.prev.point.x>b.p.x;)Q(b.q,c.prev.point,b.p)===P.CW?B(a,b,c):c=c.prev}function B(a,b,c){c.point.x>b.p.x&&(Q(c.point,c.prev.point,c.prev.prev.point)===P.CW?D(a,b,c):(C(a,b,c),B(a,b,c)))}function C(a,b,c){Q(c.prev.point,c.prev.prev.point,c.prev.prev.prev.point)===P.CW?D(a,b,c.prev):Q(b.q,c.prev.prev.point,b.p)===P.CW&&C(a,b,c.prev)}function D(a,b,c){l(a,c.prev),c.prev.point!==b.p&&Q(b.q,c.prev.point,b.p)===P.CW&&Q(c.point,c.prev.point,c.prev.prev.point)===P.CW&&D(a,b,c)}function E(a,b,c,d,e){var f=d.neighborAcross(e);if(!f)throw new Error("poly2tri [BUG:FIXME] FLIP failed due to missing triangle!");var g=f.oppositePoint(d,e);if(d.getConstrainedEdgeAcross(e)){var h=d.index(e);throw new I("poly2tri Intersecting Constraints",[e,g,d.getPoint((h+1)%3),d.getPoint((h+2)%3)])}if(R(e,d.pointCCW(e),d.pointCW(e),g))if(r(d,e,f,g),a.mapTriangleToNodes(d),a.mapTriangleToNodes(f),e===c&&g===b)c===a.edge_event.constrained_edge.q&&b===a.edge_event.constrained_edge.p&&(d.markConstrainedEdgeByPoints(b,c),f.markConstrainedEdgeByPoints(b,c),p(a,d),p(a,f));else{var j=Q(c,g,b);d=F(a,j,d,f,e,g),E(a,b,c,d,e)}else{var k=G(b,c,f,g);H(a,b,c,d,f,k),i(a,b,c,d,e)}}function F(a,b,c,d,e,f){var g;return b===P.CCW?(g=d.edgeIndex(e,f),d.delaunay_edge[g]=!0,p(a,d),d.clearDelunayEdges(),c):(g=c.edgeIndex(e,f),c.delaunay_edge[g]=!0,p(a,c),c.clearDelunayEdges(),d)}function G(a,b,c,d){var e=Q(b,d,a);if(e===P.CW)return c.pointCCW(d);if(e===P.CCW)return c.pointCW(d);throw new I("poly2tri [Unsupported] nextFlipPoint: opposing point on constrained edge!",[b,d,a])}function H(a,b,c,d,e,f){var g=e.neighborAcross(f);if(!g)throw new Error("poly2tri [BUG:FIXME] FLIP failed due to missing triangle");var h=g.oppositePoint(e,f);if(R(c,d.pointCCW(c),d.pointCW(c),h))E(a,c,h,g,h);else{var i=G(b,c,g,h);H(a,b,c,d,g,i)}}var I=a("./pointerror"),J=a("./triangle"),K=a("./advancingfront").Node,L=a("./utils"),M=3*Math.PI/4,N=Math.PI/2,O=L.EPSILON,P=L.Orientation,Q=L.orient2d,R=L.inScanArea;c.triangulate=d},{"./advancingfront":2,"./pointerror":4,"./triangle":8,"./utils":9}],7:[function(a,b){"use strict";var c=a("./pointerror"),d=a("./point"),e=a("./triangle"),f=a("./sweep"),g=a("./advancingfront"),h=g.Node,i=.3,j=function(a,b){if(this.p=a,this.q=b,a.y>b.y)this.q=a,this.p=b;else if(a.y===b.y)if(a.x>b.x)this.q=a,this.p=b;else if(a.x===b.x)throw new c("poly2tri Invalid Edge constructor: repeated points!",[a]);this.q._p2t_edge_list||(this.q._p2t_edge_list=[]),this.q._p2t_edge_list.push(this)},k=function(){this.left_node=null,this.bottom_node=null,this.right_node=null,this.width=0,this.left_highest=!1};k.prototype.clear=function(){this.left_node=null,this.bottom_node=null,this.right_node=null,this.width=0,this.left_highest=!1};var l=function(){this.constrained_edge=null,this.right=!1},m=function(a,b){b=b||{},this.triangles_=[],this.map_=[],this.points_=b.cloneArrays?a.slice(0):a,this.edge_list=[],this.pmin_=this.pmax_=null,this.front_=null,this.head_=null,this.tail_=null,this.af_head_=null,this.af_middle_=null,this.af_tail_=null,this.basin=new k,this.edge_event=new l,this.initEdges(this.points_)};m.prototype.addHole=function(a){this.initEdges(a);var b,c=a.length;for(b=0;c>b;b++)this.points_.push(a[b]);return this},m.prototype.AddHole=m.prototype.addHole,m.prototype.addPoint=function(a){return this.points_.push(a),this},m.prototype.AddPoint=m.prototype.addPoint,m.prototype.addPoints=function(a){return this.points_=this.points_.concat(a),this},m.prototype.triangulate=function(){return f.triangulate(this),this},m.prototype.getBoundingBox=function(){return{min:this.pmin_,max:this.pmax_}},m.prototype.getTriangles=function(){return this.triangles_},m.prototype.GetTriangles=m.prototype.getTriangles,m.prototype.front=function(){return this.front_},m.prototype.pointCount=function(){return this.points_.length},m.prototype.head=function(){return this.head_},m.prototype.setHead=function(a){this.head_=a},m.prototype.tail=function(){return this.tail_},m.prototype.setTail=function(a){this.tail_=a},m.prototype.getMap=function(){return this.map_},m.prototype.initTriangulation=function(){var a,b=this.points_[0].x,c=this.points_[0].x,e=this.points_[0].y,f=this.points_[0].y,g=this.points_.length;for(a=1;g>a;a++){var h=this.points_[a];h.x>b&&(b=h.x),h.x<c&&(c=h.x),h.y>e&&(e=h.y),h.y<f&&(f=h.y)}this.pmin_=new d(c,f),this.pmax_=new d(b,e);var j=i*(b-c),k=i*(e-f);this.head_=new d(b+j,f-k),this.tail_=new d(c-j,f-k),this.points_.sort(d.compare)},m.prototype.initEdges=function(a){var b,c=a.length;for(b=0;c>b;++b)this.edge_list.push(new j(a[b],a[(b+1)%c]))},m.prototype.getPoint=function(a){return this.points_[a]},m.prototype.addToMap=function(a){this.map_.push(a)},m.prototype.locateNode=function(a){return this.front_.locateNode(a.x)},m.prototype.createAdvancingFront=function(){var a,b,c,d=new e(this.points_[0],this.tail_,this.head_);this.map_.push(d),a=new h(d.getPoint(1),d),b=new h(d.getPoint(0),d),c=new h(d.getPoint(2)),this.front_=new g(a,c),a.next=b,b.next=c,b.prev=a,c.prev=b},m.prototype.removeNode=function(){},m.prototype.mapTriangleToNodes=function(a){for(var b=0;3>b;++b)if(!a.getNeighbor(b)){var c=this.front_.locatePoint(a.pointCW(a.getPoint(b)));c&&(c.triangle=a)}},m.prototype.removeFromMap=function(a){var b,c=this.map_,d=c.length;for(b=0;d>b;b++)if(c[b]===a){c.splice(b,1);break}},m.prototype.meshClean=function(a){for(var b,c,d=[a];b=d.pop();)if(!b.isInterior())for(b.setInterior(!0),this.triangles_.push(b),c=0;3>c;c++)b.constrained_edge[c]||d.push(b.getNeighbor(c))},b.exports=m},{"./advancingfront":2,"./point":3,"./pointerror":4,"./sweep":6,"./triangle":8}],8:[function(a,b){"use strict";var c=a("./xy"),d=function(a,b,c){this.points_=[a,b,c],this.neighbors_=[null,null,null],this.interior_=!1,this.constrained_edge=[!1,!1,!1],this.delaunay_edge=[!1,!1,!1]},e=c.toString;d.prototype.toString=function(){return"["+e(this.points_[0])+e(this.points_[1])+e(this.points_[2])+"]"},d.prototype.getPoint=function(a){return this.points_[a]},d.prototype.GetPoint=d.prototype.getPoint,d.prototype.getPoints=function(){return this.points_},d.prototype.getNeighbor=function(a){return this.neighbors_[a]},d.prototype.containsPoint=function(a){var b=this.points_;return a===b[0]||a===b[1]||a===b[2]},d.prototype.containsEdge=function(a){return this.containsPoint(a.p)&&this.containsPoint(a.q)},d.prototype.containsPoints=function(a,b){return this.containsPoint(a)&&this.containsPoint(b)},d.prototype.isInterior=function(){return this.interior_},d.prototype.setInterior=function(a){return this.interior_=a,this},d.prototype.markNeighborPointers=function(a,b,c){var d=this.points_;if(a===d[2]&&b===d[1]||a===d[1]&&b===d[2])this.neighbors_[0]=c;else if(a===d[0]&&b===d[2]||a===d[2]&&b===d[0])this.neighbors_[1]=c;else{if(!(a===d[0]&&b===d[1]||a===d[1]&&b===d[0]))throw new Error("poly2tri Invalid Triangle.markNeighborPointers() call");this.neighbors_[2]=c}},d.prototype.markNeighbor=function(a){var b=this.points_;a.containsPoints(b[1],b[2])?(this.neighbors_[0]=a,a.markNeighborPointers(b[1],b[2],this)):a.containsPoints(b[0],b[2])?(this.neighbors_[1]=a,a.markNeighborPointers(b[0],b[2],this)):a.containsPoints(b[0],b[1])&&(this.neighbors_[2]=a,a.markNeighborPointers(b[0],b[1],this))},d.prototype.clearNeigbors=function(){this.neighbors_[0]=null,this.neighbors_[1]=null,this.neighbors_[2]=null},d.prototype.clearDelunayEdges=function(){this.delaunay_edge[0]=!1,this.delaunay_edge[1]=!1,this.delaunay_edge[2]=!1},d.prototype.pointCW=function(a){var b=this.points_;return a===b[0]?b[2]:a===b[1]?b[0]:a===b[2]?b[1]:null},d.prototype.pointCCW=function(a){var b=this.points_;return a===b[0]?b[1]:a===b[1]?b[2]:a===b[2]?b[0]:null},d.prototype.neighborCW=function(a){return a===this.points_[0]?this.neighbors_[1]:a===this.points_[1]?this.neighbors_[2]:this.neighbors_[0]},d.prototype.neighborCCW=function(a){return a===this.points_[0]?this.neighbors_[2]:a===this.points_[1]?this.neighbors_[0]:this.neighbors_[1]},d.prototype.getConstrainedEdgeCW=function(a){return a===this.points_[0]?this.constrained_edge[1]:a===this.points_[1]?this.constrained_edge[2]:this.constrained_edge[0]},d.prototype.getConstrainedEdgeCCW=function(a){return a===this.points_[0]?this.constrained_edge[2]:a===this.points_[1]?this.constrained_edge[0]:this.constrained_edge[1]},d.prototype.getConstrainedEdgeAcross=function(a){return a===this.points_[0]?this.constrained_edge[0]:a===this.points_[1]?this.constrained_edge[1]:this.constrained_edge[2]},d.prototype.setConstrainedEdgeCW=function(a,b){a===this.points_[0]?this.constrained_edge[1]=b:a===this.points_[1]?this.constrained_edge[2]=b:this.constrained_edge[0]=b},d.prototype.setConstrainedEdgeCCW=function(a,b){a===this.points_[0]?this.constrained_edge[2]=b:a===this.points_[1]?this.constrained_edge[0]=b:this.constrained_edge[1]=b},d.prototype.getDelaunayEdgeCW=function(a){return a===this.points_[0]?this.delaunay_edge[1]:a===this.points_[1]?this.delaunay_edge[2]:this.delaunay_edge[0]},d.prototype.getDelaunayEdgeCCW=function(a){return a===this.points_[0]?this.delaunay_edge[2]:a===this.points_[1]?this.delaunay_edge[0]:this.delaunay_edge[1]},d.prototype.setDelaunayEdgeCW=function(a,b){a===this.points_[0]?this.delaunay_edge[1]=b:a===this.points_[1]?this.delaunay_edge[2]=b:this.delaunay_edge[0]=b},d.prototype.setDelaunayEdgeCCW=function(a,b){a===this.points_[0]?this.delaunay_edge[2]=b:a===this.points_[1]?this.delaunay_edge[0]=b:this.delaunay_edge[1]=b},d.prototype.neighborAcross=function(a){return a===this.points_[0]?this.neighbors_[0]:a===this.points_[1]?this.neighbors_[1]:this.neighbors_[2]},d.prototype.oppositePoint=function(a,b){var c=a.pointCW(b);return this.pointCW(c)},d.prototype.legalize=function(a,b){var c=this.points_;if(a===c[0])c[1]=c[0],c[0]=c[2],c[2]=b;else if(a===c[1])c[2]=c[1],c[1]=c[0],c[0]=b;else{if(a!==c[2])throw new Error("poly2tri Invalid Triangle.legalize() call");c[0]=c[2],c[2]=c[1],c[1]=b}},d.prototype.index=function(a){var b=this.points_;if(a===b[0])return 0;if(a===b[1])return 1;if(a===b[2])return 2;throw new Error("poly2tri Invalid Triangle.index() call")},d.prototype.edgeIndex=function(a,b){var c=this.points_;if(a===c[0]){if(b===c[1])return 2;if(b===c[2])return 1}else if(a===c[1]){if(b===c[2])return 0;if(b===c[0])return 2}else if(a===c[2]){if(b===c[0])return 1;if(b===c[1])return 0}return-1},d.prototype.markConstrainedEdgeByIndex=function(a){this.constrained_edge[a]=!0},d.prototype.markConstrainedEdgeByEdge=function(a){this.markConstrainedEdgeByPoints(a.p,a.q)},d.prototype.markConstrainedEdgeByPoints=function(a,b){var c=this.points_;b===c[0]&&a===c[1]||b===c[1]&&a===c[0]?this.constrained_edge[2]=!0:b===c[0]&&a===c[2]||b===c[2]&&a===c[0]?this.constrained_edge[1]=!0:(b===c[1]&&a===c[2]||b===c[2]&&a===c[1])&&(this.constrained_edge[0]=!0)},b.exports=d},{"./xy":10}],9:[function(a,b){"use strict";function c(a,b,c){var d=(a.x-c.x)*(b.y-c.y),g=(a.y-c.y)*(b.x-c.x),h=d-g;return h>-e&&e>h?f.COLLINEAR:h>0?f.CCW:f.CW}function d(a,b,c,d){var f=(a.x-b.x)*(d.y-b.y)-(d.x-b.x)*(a.y-b.y);if(f>=-e)return!1;var g=(a.x-c.x)*(d.y-c.y)-(d.x-c.x)*(a.y-c.y);return e>=g?!1:!0}var e=1e-12,f={CW:1,CCW:-1,COLLINEAR:0};b.exports={EPSILON:e,Orientation:f,orient2d:c,inScanArea:d}},{}],10:[function(a,b){"use strict";function c(a){return"("+a.x+";"+a.y+")"}function d(a){var b=a.toString();return"[object Object]"===b?c(a):b}function e(a,b){return a.y===b.y?a.x-b.x:a.y-b.y}function f(a,b){return a.x===b.x&&a.y===b.y}b.exports={toString:d,toStringBase:c,compare:e,equals:f}},{}]},{},[5])(5)}),function(a){"use strict";var b,c=a.Uint8Array,d=a.HTMLCanvasElement,e=/\s*;\s*base64\s*(?:;|$)/i,f=function(a){for(var d,e,f,g=a.length,h=new c(g/4*3|0),i=0,j=0,k=[0,0],l=0,m=0;g--;)e=a.charCodeAt(i++),d=b[e-43],255!==d&&d!==f&&(k[1]=k[0],k[0]=e,m=m<<6|d,l++,4===l&&(h[j++]=m>>>16,61!==k[1]&&(h[j++]=m>>>8),61!==k[0]&&(h[j++]=m),l=0));
return h.buffer};c&&(b=new c([62,-1,-1,-1,63,52,53,54,55,56,57,58,59,60,61,-1,-1,-1,0,-1,-1,-1,0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,-1,-1,-1,-1,-1,-1,26,27,28,29,30,31,32,33,34,35,36,37,38,39,40,41,42,43,44,45,46,47,48,49,50,51])),d&&!d.prototype.toBlob&&(d.prototype.toBlob=function(a,b){if(b||(b="image/png"),this.mozGetAsFile)return void a(this.mozGetAsFile("canvas",b));var d,g=Array.prototype.slice.call(arguments,1),h=this.toDataURL.apply(this,g),i=h.indexOf(","),j=h.substring(i+1),k=e.test(h.substring(0,i));Blob.fake?(d=new Blob,d.encoding=k?"base64":"URI",d.data=j,d.size=j.length):c&&(d=k?new Blob([f(j)],{type:b}):new Blob([decodeURIComponent(j)],{type:b})),a(d)})}(self);var saveAs=saveAs||navigator.msSaveOrOpenBlob&&navigator.msSaveOrOpenBlob.bind(navigator)||function(a){"use strict";var b=a.document,c=function(){return a.URL||a.webkitURL||a},d=a.URL||a.webkitURL||a,e=b.createElementNS("http://www.w3.org/1999/xhtml","a"),f=!a.externalHost&&"download"in e,g=function(c){var d=b.createEvent("MouseEvents");d.initMouseEvent("click",!0,!1,a,0,0,0,0,0,!1,!1,!1,!1,0,null),c.dispatchEvent(d)},h=a.webkitRequestFileSystem,i=a.requestFileSystem||h||a.mozRequestFileSystem,j=function(b){(a.setImmediate||a.setTimeout)(function(){throw b},0)},k="application/octet-stream",l=0,m=[],n=function(){for(var a=m.length;a--;){var b=m[a];"string"==typeof b?d.revokeObjectURL(b):b.remove()}m.length=0},o=function(a,b,c){b=[].concat(b);for(var d=b.length;d--;){var e=a["on"+b[d]];if("function"==typeof e)try{e.call(a,c||a)}catch(f){j(f)}}},p=function(b,d){var j,n,p,q=this,r=b.type,s=!1,t=function(){var a=c().createObjectURL(b);return m.push(a),a},u=function(){o(q,"writestart progress write writeend".split(" "))},v=function(){(s||!j)&&(j=t(b)),n?n.location.href=j:window.open(j,"_blank"),q.readyState=q.DONE,u()},w=function(a){return function(){return q.readyState!==q.DONE?a.apply(this,arguments):void 0}},x={create:!0,exclusive:!1};return q.readyState=q.INIT,d||(d="download"),f?(j=t(b),e.href=j,e.download=d,g(e),q.readyState=q.DONE,void u()):(a.chrome&&r&&r!==k&&(p=b.slice||b.webkitSlice,b=p.call(b,0,b.size,k),s=!0),h&&"download"!==d&&(d+=".download"),(r===k||h)&&(n=a),i?(l+=b.size,void i(a.TEMPORARY,l,w(function(a){a.root.getDirectory("saved",x,w(function(a){var c=function(){a.getFile(d,x,w(function(a){a.createWriter(w(function(c){c.onwriteend=function(b){n.location.href=a.toURL(),m.push(a),q.readyState=q.DONE,o(q,"writeend",b)},c.onerror=function(){var a=c.error;a.code!==a.ABORT_ERR&&v()},"writestart progress write abort".split(" ").forEach(function(a){c["on"+a]=q["on"+a]}),c.write(b),q.abort=function(){c.abort(),q.readyState=q.DONE},q.readyState=q.WRITING}),v)}),v)};a.getFile(d,{create:!1},w(function(a){a.remove(),c()}),w(function(a){a.code===a.NOT_FOUND_ERR?c():v()}))}),v)}),v)):void v())},q=p.prototype,r=function(a,b){return new p(a,b)};return q.abort=function(){var a=this;a.readyState=a.DONE,o(a,"abort")},q.readyState=q.INIT=0,q.WRITING=1,q.DONE=2,q.error=q.onwritestart=q.onprogress=q.onwrite=q.onabort=q.onerror=q.onwriteend=null,a.addEventListener("unload",n,!1),r}(self),Stats=function(){var a=Date.now(),b=a,c=0,d=1/0,e=0,f=0,g=1/0,h=0,i=0,j=0,k=document.createElement("div");k.id="stats",k.addEventListener("mousedown",function(a){a.preventDefault(),s(++j%2)},!1),k.style.cssText="width:80px;opacity:0.9;cursor:pointer";var l=document.createElement("div");l.id="fps",l.style.cssText="padding:0 0 3px 3px;text-align:left;background-color:#002",k.appendChild(l);var m=document.createElement("div");m.id="fpsText",m.style.cssText="color:#0ff;font-family:Helvetica,Arial,sans-serif;font-size:9px;font-weight:bold;line-height:15px",m.innerHTML="FPS",l.appendChild(m);var n=document.createElement("div");for(n.id="fpsGraph",n.style.cssText="position:relative;width:74px;height:30px;background-color:#0ff",l.appendChild(n);74>n.children.length;){var o=document.createElement("span");o.style.cssText="width:1px;height:30px;float:left;background-color:#113",n.appendChild(o)}var p=document.createElement("div");p.id="ms",p.style.cssText="padding:0 0 3px 3px;text-align:left;background-color:#020;display:none",k.appendChild(p);var q=document.createElement("div");q.id="msText",q.style.cssText="color:#897364;font-family:Helvetica,Arial,sans-serif;font-size:9px;font-weight:bold;line-height:15px",q.innerHTML="MS",p.appendChild(q);var r=document.createElement("div");for(r.id="msGraph",r.style.cssText="position:relative;width:74px;height:30px;background-color:#897364",p.appendChild(r);74>r.children.length;)o=document.createElement("span"),o.style.cssText="width:1px;height:30px;float:left;background-color:#131",r.appendChild(o);var s=function(a){switch(j=a){case 0:l.style.display="block",p.style.display="none";break;case 1:l.style.display="none",p.style.display="block"}};return{REVISION:11,domElement:k,setMode:s,getFps:function(){return f},begin:function(){a=Date.now()},end:function(){var j=Date.now();c=j-a,d=Math.min(d,c),e=Math.max(e,c),q.textContent=c+" MS ("+d+"-"+e+")";var k=Math.min(30,30-30*(c/200));return r.appendChild(r.firstChild).style.height=k+"px",i++,j>b+1e3&&(f=Math.round(1e3*i/(j-b)),g=Math.min(g,f),h=Math.max(h,f),m.textContent=f+" FPS ("+g+"-"+h+")",k=Math.min(30,30-30*(f/100)),n.appendChild(n.firstChild).style.height=k+"px",b=j,i=0),j},update:function(){a=this.end()}}};"undefined"==typeof document||"classList"in document.createElement("a")||!function(a){if("HTMLElement"in a||"Element"in a){var b="classList",c="prototype",d=(a.HTMLElement||a.Element)[c],e=Object,f=String[c].trim||function(){return this.replace(/^\s+|\s+$/g,"")},g=Array[c].indexOf||function(a){for(var b=0,c=this.length;c>b;b++)if(b in this&&this[b]===a)return b;return-1},h=function(a,b){this.name=a,this.code=DOMException[a],this.message=b},i=function(a,b){if(""===b)throw new h("SYNTAX_ERR","An invalid or illegal string was specified");if(/\s/.test(b))throw new h("INVALID_CHARACTER_ERR","String contains an invalid character");return g.call(a,b)},j=function(a){for(var b=f.call(a.className),c=b?b.split(/\s+/):[],d=0,e=c.length;e>d;d++)this.push(c[d]);this._updateClassName=function(){a.className=this.toString()}},k=j[c]=[],l=function(){return new j(this)};if(h[c]=Error[c],k.item=function(a){return this[a]||null},k.contains=function(a){return a+="",-1!==i(this,a)},k.add=function(){var a,b=arguments,c=0,d=b.length,e=!1;do a=b[c]+"",-1===i(this,a)&&(this.push(a),e=!0);while(++c<d);e&&this._updateClassName()},k.remove=function(){var a,b=arguments,c=0,d=b.length,e=!1;do{a=b[c]+"";var f=i(this,a);-1!==f&&(this.splice(f,1),e=!0)}while(++c<d);e&&this._updateClassName()},k.toggle=function(a,b){a+="";var c=this.contains(a),d=c?b!==!0&&"remove":b!==!1&&"add";return d&&this[d](a),!c},k.toString=function(){return this.join(" ")},e.defineProperty){var m={get:l,enumerable:!0,configurable:!0};try{e.defineProperty(d,b,m)}catch(n){-2146823252===n.number&&(m.enumerable=!1,e.defineProperty(d,b,m))}}else e[c].__defineGetter__&&d.__defineGetter__(b,l)}}(self),function(){function a(){b(),new MutationObserver(function(a){a.forEach(function(a){a.addedNodes&&Array.forEach(a.addedNodes,function(a){a instanceof Element&&(a.childElementCount?Array.forEach(a.querySelectorAll("input[type=range]"),c):a.mozMatchesSelector("input[type=range]")&&c(a))})})}).observe(document,{childList:!0,subtree:!0})}function b(){Array.forEach(document.querySelectorAll("input[type=range]"),c)}function c(a){"range"!=a.type&&d(a)}function d(a){function b(a){if(x=!0,setTimeout(function(){x=!1},0),!a.button&&E){var b=parseFloat(getComputedStyle(this).width),e=(b-j.width)/E;if(e){var f=a.clientX-this.getBoundingClientRect().left-j.width/2-(F-B)*e;Math.abs(f)>j.radius&&(w=!0,this.value-=-f/e),z=F,A=a.clientX,this.addEventListener("mousemove",c,!0),this.addEventListener("mouseup",d,!0)}}}function c(b){var c=parseFloat(getComputedStyle(this).width),d=(c-j.width)/E;if(d){z+=(b.clientX-A)/d,A=b.clientX,w=!0;var e=this.value;this.value=z,e!=z&&a.dispatchEvent(o)}}function d(){this.removeEventListener("mousemove",c,!0),this.removeEventListener("mouseup",d,!0),a.dispatchEvent(n),a.dispatchEvent(o)}function f(a){a.keyCode>36&&a.keyCode<41&&(g.call(this),w=!0,this.value=F+(38==a.keyCode||39==a.keyCode?D:-D))}function g(){x||(this.style.boxShadow=i?"inset 0 0 20px rgba(137,115,100,.1), 0 0 1px rgba(137,115,100,.4)":"0 0 0 2px #DDD")}function p(){this.style.boxShadow=""}function q(a){return!isNaN(a)&&+a==parseFloat(a)}function r(){B=q(a.min)?+a.min:0,C=q(a.max)?+a.max:100,B>C&&(C=B>100?B:100),D=q(a.step)&&a.step>0?+a.step:1,E=C-B,t(!0)}function s(){u||v||(F=a.getAttribute("value")),q(F)||(F=(B+C)/2),F=Math.round((F-B)/D)*D+B,B>F?F=B:F>C&&(F=B+~~(E/D)*D)}function t(b){s();var c=w;if(w=!1,c&&F!=y&&a.dispatchEvent(n),b||F!=y){y=F;var d=E?(F-B)/E*100:0,f="-moz-element(#__sliderthumb__) "+d+"% no-repeat, ";e(a,{background:f+k})}}var u,v,w,x,y,z,A,B,C,D,E,F=a.value;h||(h=document.body.appendChild(document.createElement("hr")),e(h,{"-moz-appearance":i?"scale-horizontal":"scalethumb-horizontal",display:"block",visibility:"visible",opacity:1,position:"fixed",top:"-999999px"}),document.mozSetImageElement("__sliderthumb__",h));var G=function(){return""+F},H=function I(b){F=""+b,u=!0,t(),delete a.value,a.value=F,a.__defineGetter__("value",G),a.__defineSetter__("value",I)};a.__defineGetter__("value",G),a.__defineSetter__("value",H),Object.defineProperty(a,"type",{get:function(){return"range"}}),["min","max","step"].forEach(function(b){a.hasAttribute(b)&&(v=!0),Object.defineProperty(a,b,{get:function(){return this.hasAttribute(b)?this.getAttribute(b):""},set:function(a){null===a?this.removeAttribute(b):this.setAttribute(b,a)}})}),a.readOnly=!0,e(a,l),r(),new MutationObserver(function(b){b.forEach(function(b){"value"!=b.attributeName?(r(),v=!0):u||(F=a.getAttribute("value"),t())})}).observe(a,m),a.addEventListener("mousedown",b,!0),a.addEventListener("keydown",f,!0),a.addEventListener("focus",g,!0),a.addEventListener("blur",p,!0)}function e(a,b){for(var c in b)a.style.setProperty(c,b[c],"important")}var f=document.createElement("input");try{if(f.type="range","range"==f.type)return}catch(g){return}if(f.style.background="linear-gradient(red, red)",f.style.backgroundImage&&"MozAppearance"in f.style){var h,i="MacIntel"==navigator.platform,j={radius:i?9:6,width:i?22:12,height:i?16:20},k="linear-gradient(transparent "+(i?"6px, #999 6px, #999 7px, #ccc 8px, #bbb 9px, #bbb 10px, transparent 10px":"9px, #999 9px, #bbb 10px, #fff 11px, transparent 11px")+", transparent)",l={"min-width":j.width+"px","min-height":j.height+"px","max-height":j.height+"px",padding:"0 0 "+(i?"2px":"1px"),border:0,"border-radius":0,cursor:"default","text-indent":"-999999px"},m={attributes:!0,attributeFilter:["min","max","step","value"]},n=document.createEvent("HTMLEvents");n.initEvent("input",!0,!1);var o=document.createEvent("HTMLEvents");o.initEvent("change",!0,!1),"loading"==document.readyState?document.addEventListener("DOMContentLoaded",a,!0):a(),addEventListener("pageshow",b,!0)}}();var I18njs=function(a,b,c){this._baseURL=a||"/l10n/",this._locale=b||"C",this._strings=c||{},window._=this.translate.bind(this)};I18njs.prototype.getLocale=function(){return this._locale},I18njs.prototype.setLocale=function(a,b){this._locale=a||"C",this._loadLocale(b)},I18njs.prototype.translate=function(a,b){if(b){var c="C"==this._locale?"en_EN":this._locale;if(b[c]&&b[c][a])return b[c][a]}return this._strings[a]||a},I18njs.prototype._loadLocale=function(a){var a=a||1;if(this._strings={},"C"!=this._locale){var b=window.XMLHttpRequest?new XMLHttpRequest:new ActiveXObject("Microsoft.XMLHTTP");b.open("GET",this._baseURL+this._locale+".json?version="+a,!1),b.onreadystatechange=function(){4==b.readyState&&(this._strings=JSON.parse(b.responseText))}.bind(this),b.send(null)}};var BrowserDetector=function(){var a=null,b=[{string:navigator.userAgent,subString:"Chrome",identity:"Chrome"},{string:navigator.vendor,subString:"Apple",identity:"Safari",versionSearch:"Version"},{string:navigator.userAgent,subString:"Firefox",identity:"Firefox"},{string:navigator.userAgent,subString:"Netscape",identity:"Netscape"},{string:navigator.userAgent,subString:"MSIE",identity:"Explorer",versionSearch:"MSIE"},{string:navigator.userAgent,subString:"Gecko",identity:"Mozilla",versionSearch:"rv"},{string:navigator.userAgent,subString:"Mozilla",identity:"Netscape",versionSearch:"Mozilla"}],c=[{string:navigator.platform,subString:"Win",identity:"Windows"},{string:navigator.platform,subString:"Mac",identity:"Mac"},{string:navigator.userAgent,subString:"iPhone",identity:"iOS"},{string:navigator.userAgent,subString:"iPod",identity:"iOS"},{string:navigator.userAgent,subString:"iPad",identity:"iOS"},{string:navigator.platform,subString:"Linux",identity:"Linux"},{string:navigator.plateform,subString:"Android",identity:"Android"}],d=function(){this.browser=this._searchString(b)||"An unknown browser",this.version=this._searchVersion(navigator.userAgent)||this._searchVersion(navigator.appVersion)||"an unknown version",this.OS=this._searchString(c)||"an unknown OS",a=this};return d.getInstance=function(){return null===a&&(a=new BrowserDetector),a},d.prototype.isMobile=function(){var a=!1;return function(b){(/(android|bb\d+|meego).+mobile|android|avantgo|bada\/|blackberry|blazer|compal|elaine|fennec|hiptop|iemobile|iphone|ipod|ipad|iris|kindle|lge |maemo|midp|mmp|mobile.+firefox|netfront|opera m(ob|in)i|palm( os)?|phone|p(ixi|re)\/|plucker|pocket|psp|series(4|6)0|symbian|treo|up\.(browser|link)|vodafone|wap|windows (ce|phone)|xda|xiino/i.test(b)||/1207|6310|6590|3gso|4thp|50[1-6]i|770s|802s|a wa|abac|ac(er|oo|s\-)|ai(ko|rn)|al(av|ca|co)|amoi|an(ex|ny|yw)|aptu|ar(ch|go)|as(te|us)|attw|au(di|\-m|r |s )|avan|be(ck|ll|nq)|bi(lb|rd)|bl(ac|az)|br(e|v)w|bumb|bw\-(n|u)|c55\/|capi|ccwa|cdm\-|cell|chtm|cldc|cmd\-|co(mp|nd)|craw|da(it|ll|ng)|dbte|dc\-s|devi|dica|dmob|do(c|p)o|ds(12|\-d)|el(49|ai)|em(l2|ul)|er(ic|k0)|esl8|ez([4-7]0|os|wa|ze)|fetc|fly(\-|_)|g1 u|g560|gene|gf\-5|g\-mo|go(\.w|od)|gr(ad|un)|haie|hcit|hd\-(m|p|t)|hei\-|hi(pt|ta)|hp( i|ip)|hs\-c|ht(c(\-| |_|a|g|p|s|t)|tp)|hu(aw|tc)|i\-(20|go|ma)|i230|iac( |\-|\/)|ibro|idea|ig01|ikom|im1k|inno|ipaq|iris|ja(t|v)a|jbro|jemu|jigs|kddi|keji|kgt( |\/)|klon|kpt |kwc\-|kyo(c|k)|le(no|xi)|lg( g|\/(k|l|u)|50|54|\-[a-w])|libw|lynx|m1\-w|m3ga|m50\/|ma(te|ui|xo)|mc(01|21|ca)|m\-cr|me(rc|ri)|mi(o8|oa|ts)|mmef|mo(01|02|bi|de|do|t(\-| |o|v)|zz)|mt(50|p1|v )|mwbp|mywa|n10[0-2]|n20[2-3]|n30(0|2)|n50(0|2|5)|n7(0(0|1)|10)|ne((c|m)\-|on|tf|wf|wg|wt)|nok(6|i)|nzph|o2im|op(ti|wv)|oran|owg1|p800|pan(a|d|t)|pdxg|pg(13|\-([1-8]|c))|phil|pire|pl(ay|uc)|pn\-2|po(ck|rt|se)|prox|psio|pt\-g|qa\-a|qc(07|12|21|32|60|\-[2-7]|i\-)|qtek|r380|r600|raks|rim9|ro(ve|zo)|s55\/|sa(ge|ma|mm|ms|ny|va)|sc(01|h\-|oo|p\-)|sdk\/|se(c(\-|0|1)|47|mc|nd|ri)|sgh\-|shar|sie(\-|m)|sk\-0|sl(45|id)|sm(al|ar|b3|it|t5)|so(ft|ny)|sp(01|h\-|v\-|v )|sy(01|mb)|t2(18|50)|t6(00|10|18)|ta(gt|lk)|tcl\-|tdg\-|tel(i|m)|tim\-|t\-mo|to(pl|sh)|ts(70|m\-|m3|m5)|tx\-9|up(\.b|g1|si)|utst|v400|v750|veri|vi(rg|te)|vk(40|5[0-3]|\-v)|vm40|voda|vulc|vx(52|53|60|61|70|80|81|83|85|98)|w3c(\-| )|webc|whit|wi(g |nc|nw)|wmlb|wonu|x700|yas\-|your|zeto|zte\-/i.test(b.substr(0,4)))&&(a=!0)}(navigator.userAgent||navigator.vendor||window.opera),a},d.prototype._searchString=function(a){for(var b=0;b<a.length;b++){var c=a[b].string,d=a[b].prop;if(this.version_searchString=a[b].versionSearch||a[b].identity,c){if(-1!=c.indexOf(a[b].subString))return a[b].identity}else if(d)return a[b].identity}},d.prototype._searchVersion=function(a){var b=a.indexOf(this.version_searchString);return-1!=b?parseFloat(a.substring(b+this.version_searchString.length+1)):void 0},d}(),BrowserDetect=new BrowserDetector,photonui=function(a,b){!function(a){"undefined"!=typeof module&&module.exports?module.exports=a():"function"==typeof define&&"object"==typeof define.amd?define(a):this.Class=a()}(function(a){function b(a){return!j||/\B\$super\b/.test(a.toString())}function c(b,c,d){d===a?delete b[c]:b[c]=d}function d(b,c){return Object.prototype.hasOwnProperty.call(b,c)?b[c]:a}function e(a){i=!0;var b=new a;return i=!1,b}var f="1.4",g=this,h=g.Class,i=!1,j=function(){$super()}.toString().indexOf("$super")>0,k=function(){};return k.$noConflict=function(){try{c(g,"Class",h)}catch(a){g.Class=h}return k},k.$classyVersion=f,k.$extend=function(f){var h=this.prototype,j=e(this);if(f.__include__)for(var l=0,m=f.__include__.length;l!=m;++l){var n=f.__include__[l];for(var o in n){var p=d(n,o);p!==a&&(j[o]=n[o])}}if(f.__classvars__=f.__classvars__||{},j.__classvars__)for(var q in j.__classvars__)if(!f.__classvars__[q]){var p=d(j.__classvars__,q);f.__classvars__[q]=p}for(var o in f){var p=d(f,o);"__include__"!==o&&p!==a&&(j[o]="function"==typeof p&&b(p)?function(a,b){return function(){var e=d(this,"$super");this.$super=h[b];try{return a.apply(this,arguments)}finally{c(this,"$super",e)}}}(p,o):p)}var r=function(){if(!i){var a=g===this?e(arguments.callee):this;return a.__init__&&a.__init__.apply(a,arguments),a.$class=r,a}};for(var q in f.__classvars__){var p=d(f.__classvars__,q);p!==a&&(r[q]=p)}return r.prototype=j,r.constructor=r,r.$extend=k.$extend,r.$withData=k.$withData,r},k.$withData=function(b){var c=e(this);for(var f in b){var g=d(b,f);g!==a&&(c[f]=g)}return c},k});var c=c||{};c.e_parent=null,c.domInsert=function(a,b){var b=b||c.e_parent||document.getElementsByTagName("body")[0];b.appendChild(a.html)},a._==b&&(a._=function(a,b){var c=a;if(b)for(var d in b)c=c.replace(new RegExp("{"+d+"}","g"),b[d]);return c});var c=c||{};c.Helpers=function(){},c.Helpers.escapeHtml=function(a){return a.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;")},c.Helpers.uuid4=function(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(a){var b=16*Math.random()|0,c="x"==a?b:3&b|8;return c.toString(16)})},c.Helpers.cleanNode=function(a){for(;a.hasChildNodes();)a.removeChild(a.lastChild)},c.Helpers.getAbsolutePosition=function(a){if(!a instanceof Element)return{x:0,y:0};try{var b=getComputedStyle(a)}catch(c){return{x:0,y:0}}if(!b)return{x:0,y:0};for(var d=-parseInt(b.borderLeftWidth),e=-parseInt(b.borderTopWidth);a.offsetParent;)b=getComputedStyle(a),d+=a.offsetLeft||0,d+=parseInt(b.borderLeftWidth),e+=a.offsetTop||0,e+=parseInt(b.borderTopWidth),a=a.offsetParent;return{x:d,y:e}};var c=c||{};c.Base=Class.$extend({__init__:function(a){this.__events={},this._registerWEvents(["destroy"]);for(var d in this)if(0==d.indexOf("get")){var e=d.slice(3,4).toLowerCase()+d.slice(4,d.length);Object.defineProperty(this,e,{get:this[d],enumerable:!0,configurable:!0})}else if(0==d.indexOf("set")){var e=d.slice(3,4).toLowerCase()+d.slice(4,d.length);Object.defineProperty(this,e,{set:this[d],enumerable:!0,configurable:!0})}else if(0==d.indexOf("is")){var e=d.slice(2,3).toLowerCase()+d.slice(3,d.length);Object.defineProperty(this,e,{get:this[d],enumerable:!0,configurable:!0})}var a=a||{};for(param in a)this[param]!==b&&(this[param]=a[param]);var f=null,g=0,h="";if(a.callbacks)for(var i in a.callbacks)if(f=a.callbacks[i],"function"==typeof f)this.registerCallback(c.Helpers.uuid4(),i,f);else if(f instanceof Array)for(g=0;g<f.length;g++)this.registerCallback(c.Helpers.uuid4(),i,f[g]);else for(h in f)this.registerCallback(h,i,f[h])},__events:null,__callbacks:null,destroy:function(){this._callCallbacks("destroy");for(var a in this.__events)this._unbindEvent(a)},registerCallback:function(a,b,c,d){return this.__callbacks[b]?void(this.__callbacks[b][a]={callback:c,thisArg:d||null}):void console.error("This widget have no '"+b+"' event.")},removeCallback:function(a){for(var b in this.__callbacks)this.__callbacks[b][a]&&delete this.__callbacks[b][a]},_updateProperties:function(a){for(var b=0;b<a.length;b++)this[a[b]]=this[a[b]]},_bindEvent:function(a,b,c,d){this.__events[a]={evName:c,element:b,callback:d},this.__events[a].element.addEventListener(this.__events[a].evName,this.__events[a].callback,!1)},_unbindEvent:function(a){this.__events[a].element.removeEventListener(this.__events[a].evName,this.__events[a].callback,!1),delete this.__events[a]},_registerWEvents:function(a){null==this.__callbacks&&(this.__callbacks={});for(var b in a)this.__callbacks[a[b]]={}},_callCallbacks:function(a,b){var b=b||[];for(var c in this.__callbacks[a])this.__callbacks[a][c].callback.apply(this.__callbacks[a][c].thisArg||this,[this].concat(b))}});var c=c||{},d={};c.getWidget=function(a){return d[a]!==b?d[a]:null},c.Widget=c.Base.$extend({__init__:function(a){this.__html={},this._layoutOptions={},this._buildHtml(),this._registerWEvents(["show","hide"]),this.$super(a),this._updateProperties(["visible"]),this.name||(this.name="widget-"+c.Helpers.uuid4()),a&&a.className&&this.addClass(a.className),this.html&&this._bindEvent("pop-contextmenu",this.html,"contextmenu",this.__onContextMenu.bind(this)),this._bindEvent("locale-changed",document,"stonejs-locale-changed",this.__onLocaleChanged.bind(this)),d[this.name]=this},_name:null,getName:function(){return this._name},setName:function(a){delete d[this.name],this._name=a,d[a]=this,this.html&&(this.html.id=this.name)},_visible:!0,isVisible:function(){return this._visible},setVisible:function(a){this._visible=a,this.html&&(this.visible?(this.html.style.display="",this._callCallbacks("show")):(this.html.style.display="none",this._callCallbacks("hide")))},_tooltip:null,getTooltip:function(){return this._tooltip},setTooltip:function(a){this._tooltip=a,a?this.html.title=a:delete this.html.removeAttribute("title")},_contextMenuName:null,getContextMenuName:function(){return this._contextMenuName},setContextMenuName:function(a){this._contextMenuName=a},getContextMenu:function(){return c.getWidget(this.contextMenuName)},setContextMenu:function(a){this.contextMenuName=a instanceof c.PopupWindow?a.name:null},_layoutOptions:{},getLayoutOptions:function(){return this._layoutOptions},setLayoutOptions:function(a){for(option in a)this._layoutOptions[option]=a[option]},getHtml:function(){return console.warn("getHtml() method not implemented for this widget."),null},getAbsolutePosition:function(){return this.html?c.Helpers.getAbsolutePosition(this.html):{x:0,y:0}},getOffsetWidth:function(){return this.html?this.html.offsetWidth:0},getOffsetHeight:function(){return this.html?this.html.offsetHeight:0},__html:{},show:function(){this.visible=!0},hide:function(){this.visible=!1},destroy:function(){this.$super(),delete d[this.name],this.html&&this.html.parentNode&&this.html.parentNode.removeChild(this.html)},addClass:function(a){if(this.html){var b=this.html.className.split(" ");b.indexOf(a)<0&&b.push(a),this.html.className=b.join(" ")}},removeClass:function(a){if(this.html){var b=this.html.className.split(" "),c=b.indexOf(a);c>=0&&b.splice(c,1),this.html.className=b.join(" ")}},_buildHtml:function(){console.warn("_buildHtml() method not implemented for this widget.")},__onContextMenu:function(a){a.stopPropagation(),a.preventDefault(),this.contextMenuName&&this.contextMenu.popupXY(a.pageX,a.pageY)},__onLocaleChanged:function(){if(a.Stone)for(var b in this)this[b]instanceof Stone.LazyString&&(this[b]=this[b])}});var c=c||{};c.Canvas=c.Widget.$extend({__init__:function(a){this.$super(a),this._updateProperties(["width","height"]),this.getContext=this.__html.canvas.getContext.bind(this.__html.canvas),this.__html.canvas.supportsContext&&(this.supportsContext=this.__html.canvas.supportsContext.bind(this.__html.canvas)),this.__html.canvas.setContext&&(this.setContext=this.__html.canvas.setContext.bind(this.__html.canvas)),this.__html.canvas.transferControlToProxy&&(this.transferControlToProxy=this.__html.canvas.transferControlToProxy.bind(this.__html.canvas)),this.toDataURL=this.__html.canvas.toDataURL.bind(this.__html.canvas),this.__html.canvas.toDataURLHD&&(this.toDataURLHD=this.__html.canvas.toDataURLHD.bind(this.__html.canvas)),this.__html.canvas.toBlob&&(this.toBlob=this.__html.canvas.toBlob.bind(this.__html.canvas)),this.__html.canvas.toBlobHD&&(this.toBlobHD=this.__html.canvas.toBlobHD.bind(this.__html.canvas))},getWidth:function(){return this.__html.canvas.width},setWidth:function(a){this.__html.canvas.width=a||300},getHeight:function(){return this.__html.canvas.height},setHeight:function(a){this.__html.canvas.height=a||150},getCanvas:function(){return this.__html.canvas},getHtml:function(){return this.__html.outer},getInteractiveNode:function(){return this.__html.canvas},_buildHtml:function(){this.__html.outer=document.createElement("div"),this.__html.outer.className="photonui-widget photonui-canvas",this.__html.canvas=document.createElement("canvas"),this.__html.outer.appendChild(this.__html.canvas)},__onLocaleChanged:function(){}});var c=c||{};c.CheckBox=c.Widget.$extend({__init__:function(a){this._registerWEvents(["value-changed","click"]),this.$super(a),this.inputId=this.name+"-input",this._bindEvent("value-changed",this.__html.checkbox,"change",this.__onChange.bind(this)),this._bindEvent("span-click",this.__html.span,"click",this.__onSpanClick.bind(this)),this._bindEvent("checkbox-click",this.__html.checkbox,"click",this.__onCheckboxClick.bind(this)),this._bindEvent("span-keypress",this.__html.span,"keypress",this.__onSpanKeypress.bind(this)),this.__html.checkbox.name=this.name,this.__html.checkbox.id=this.inputId},getValue:function(){return this.__html.checkbox.checked},setValue:function(a){this.__html.checkbox.checked=a},getHtml:function(){return this.__html.outer},_buildHtml:function(){this.__html.outer=document.createElement("div"),this.__html.outer.className="photonui-widget photonui-checkbox",this.__html.checkbox=document.createElement("input"),this.__html.checkbox.type="checkbox",this.__html.outer.appendChild(this.__html.checkbox),this.__html.span=document.createElement("span"),this.__html.span.tabIndex="0",this.__html.outer.appendChild(this.__html.span)},__onChange:function(){this._callCallbacks("value-changed",[this.value]),"none"==a.getComputedStyle(this.__html.checkbox).display&&this.__html.span.focus()},__onSpanClick:function(a){this.value=!this.value,this._callCallbacks("value-changed",[this.value]),this._callCallbacks("click",[a])},__onCheckboxClick:function(a){this._callCallbacks("click",[a])},__onSpanKeypress:function(a){(32==a.charCode||13==a.keyCode)&&(this.value=!this.value,this._callCallbacks("value-changed",[this.value]))}});var c=c||{};c.Container=c.Widget.$extend({_childName:null,getChildName:function(){return this._childName},setChildName:function(a){this.childName&&this.containerNode&&this.child&&this.child.html&&this.containerNode.removeChild(this.child.html),this._childName=a,this.childName&&this.containerNode&&this.child&&this.child.html&&this.containerNode.appendChild(this.child.html)},getChild:function(){return c.getWidget(this.childName)},setChild:function(a){return!a instanceof c.Widget?void(this.childName=null):void(this.childName=a.name)},getContainerNode:function(){return console.warn("getContainerNode() method not implemented for this widget."),null},destroy:function(){this.childName&&this.child.destroy(),this.$super()}});var c=c||{};c.Label=c.Widget.$extend({__init__:function(a){var a=a||{};a.layoutOptions=a.layoutOptions||{},a.layoutOptions.verticalExpansion===b&&(a.layoutOptions.verticalExpansion=!1),this.$super(a),this._updateProperties(["text","textAlign","forInputName"])},_text:"Label",getText:function(){return this._text},setText:function(a){this._text=a,c.Helpers.cleanNode(this.__html.label),this.__html.label.appendChild(document.createTextNode(a))},_textAlign:"left",getTextAlign:function(){return this._textAlign},setTextAlign:function(a){if("left"!=a&&"center"!=a&&"right"!=a)throw"Text alignement sould be 'left', 'center' or 'right'.";this._textAlign=a,this.__html.label.style.textAlign=a},_forInputName:null,getForInputName:function(){return this._forInputName},setForInputName:function(a){this._forInputName=a,this._forInputName&&this.__html.label.setAttribute("for",c.Helpers.escapeHtml(this.forInput.inputId||this.forInput.name))},getForInput:function(){return c.getWidget(this.forInputName)},setForInput:function(a){this.forInputName=a.name},getHtml:function(){return this.__html.label},_buildHtml:function(){this.__html.label=document.createElement("label"),this.__html.label.className="photonui-widget photonui-label"}});var c=c||{};c.Field=c.Widget.$extend({__init__:function(a){this._registerWEvents(["value-changed","keydown","keyup","keypress","selection-changed"]),this.$super(a),this._updateProperties(["value","placeholder"]),this.__html.field.name=this.name},getValue:function(){return this.__html.field.value},setValue:function(a){this.__html.field.value=a},_placeholder:"",getPlaceholder:function(){return this._placeholder},setPlaceholder:function(a){this._placeholder=a,this.__html.field.placeholder=a},getHtml:function(){return this.__html.field},_bindFieldEvents:function(){this._bindEvent("value-changed",this.__html.field,"change",function(){this._callCallbacks("value-changed",[this.getValue()])}.bind(this)),this._bindEvent("keydown",this.__html.field,"keydown",function(a){this._callCallbacks("keydown",[a])}.bind(this)),this._bindEvent("keyup",this.__html.field,"keyup",function(a){this._callCallbacks("keyup",[a])}.bind(this)),this._bindEvent("keypress",this.__html.field,"keypress",function(a){this._callCallbacks("keypress",[a])}.bind(this)),this._bindEvent("selection-changed",this.__html.field,"select",function(a){this._callCallbacks("selection-changed",[this.__html.field.selectionStart,this.__html.field.selectionEnd,(""+this.getValue()).substring(this.__html.field.selectionStart,this.__html.field.selectionEnd),a])}.bind(this))},__onContextMenu:function(a){a.stopPropagation()}});var c=c||{};c.BaseIcon=c.Widget.$extend({__onLocaleChanged:function(){}}),a.Stone=function(){function a(a,c){this.toString=b.bind(this,a,c)}function b(a,b){var c=a;if(i&&h[i]&&h[i][a]&&(c=h[i][a]),b)for(var d in b)c=c.replace(new RegExp("{"+d+"}","g"),b[d]);return c}function c(b,c){return new a(b,c)}function d(a){for(var b in a)h[b]=a[b]}function e(){return i}function f(a){i=a;var b=null;try{b=new Event("stonejs-locale-changed")}catch(c){b=document.createEvent("Event"),b.initEvent("stonejs-locale-changed",!0,!1)}document.dispatchEvent(b)}function g(){var a=navigator.language||navigator.userLanguage||navigator.systemLanguage||navigator.browserLanguage||null;return a&&(a=a.toLowerCase()),a&&a.length>3&&(a=a.split(";")[0],a=a.split(",")[0],a=a.split("-")[0],a=a.split("_")[0],a.length>3&&(a=null)),a||"en"}var h={},i=null;return{LazyString:a,gettext:b,lazyGettext:c,addCatalogs:d,getLocale:e,setLocale:f,guessUserLanguage:g}}(a);var c=c||{};c.Translation=c.Base.$extend({__init__:function(b){this._registerWEvents(["locale-changed"]),this.$super(b),this._bindEvent("locale-changed",document,"stonejs-locale-changed",this.__onStonejsLocaleChanged.bind(this)),a._=this.lazyGettext},getLocale:Stone.getLocale,setLocale:Stone.setLocale,addCatalogs:Stone.addCatalogs,guessUserLanguage:Stone.guessUserLanguage,gettext:Stone.gettext,lazyGettext:Stone.lazyGettext,__onStonejsLocaleChanged:function(){this._callCallbacks("locale-changed",[this.locale])}}),function(a,b){function c(){function a(){var c;return c=b("amd"),c.fork=a,c}return a()}function d(){function a(){var c;return c=b("CommonJS"),c.fork=a,c}module.exports=a()}function e(){function c(){function d(){var b,c;for(c=Array.prototype.slice.apply(arguments),b=0;b<f.length;b+=1)"undefined"==typeof g[f[b]]?delete a[f[b]]:a[f[b]]=g[f[b]];for(g={},b=0;b<c.length;b+=1){if("string"!=typeof c[b])throw new Error("Cannot replace namespaces. All new namespaces must be strings.");g[c[b]]=a[c[b]],a[c[b]]=e}return f=c}var e,f=[],g={};return e=b("global"),e.fork=c,e.noConflict=d,e}var d;d=c(),d.noConflict("KeyboardJS","k")}[].indexOf||(Array.prototype.indexOf=function(a,b,c){for(c=this.length,b=(c+~~b)%c;c>b&&(!(b in this)||this[b]!==a);b++);return b^c?b:-1}),"function"==typeof define&&define.amd?define(c):"undefined"!=typeof module?d():e()}(this,function(){function b(){a.addEventListener?(document.addEventListener("keydown",e,!1),document.addEventListener("keyup",f,!1),a.addEventListener("blur",d,!1),a.addEventListener("webkitfullscreenchange",d,!1),a.addEventListener("mozfullscreenchange",d,!1)):a.attachEvent&&(document.attachEvent("onkeydown",e),document.attachEvent("onkeyup",f),a.attachEvent("onblur",d))
}function c(){d(),a.removeEventListener?(document.removeEventListener("keydown",e,!1),document.removeEventListener("keyup",f,!1),a.removeEventListener("blur",d,!1),a.removeEventListener("webkitfullscreenchange",d,!1),a.removeEventListener("mozfullscreenchange",d,!1)):a.detachEvent&&(document.detachEvent("onkeydown",e),document.detachEvent("onkeyup",f),a.detachEvent("onblur",d))}function d(a){I=[],l(),q(a)}function e(a){var b,c,d;if(b=g(a.keyCode),!(b.length<1)){for(a.isRepeat=!1,d=0;d<b.length;d+=1)c=b[d],-1!=w().indexOf(c)&&(a.isRepeat=!0),x(c);k(),p(a)}}function f(a){var b,c;if(b=g(a.keyCode),!(b.length<1)){for(c=0;c<b.length;c+=1)y(b[c]);l(),q(a)}}function g(a){return C[a]||[]}function h(a){var b;for(b in C)if(C.hasOwnProperty(b)&&C[b].indexOf(a)>-1)return b;return!1}function i(a,b){if("string"!=typeof a&&("object"!=typeof a||"function"!=typeof a.push))throw new Error("Cannot create macro. The combo must be a string or array.");if("object"!=typeof b||"function"!=typeof b.push)throw new Error("Cannot create macro. The injectedKeys must be an array.");D.push([a,b])}function j(a){var b;if("string"!=typeof a&&("object"!=typeof a||"function"!=typeof a.push))throw new Error("Cannot remove macro. The combo must be a string or array.");for(mI=0;mI<D.length;mI+=1)if(b=D[mI],r(a,b[0])){y(b[1]),D.splice(mI,1);break}}function k(){var a,b,c;for(a=0;a<D.length;a+=1)if(b=u(D[a][0]),-1===L.indexOf(D[a])&&s(b))for(L.push(D[a]),c=0;c<D[a][1].length;c+=1)x(D[a][1][c])}function l(){var a,b,c;for(a=0;a<L.length;a+=1)if(b=u(L[a][0]),s(b)===!1){for(c=0;c<L[a][1].length;c+=1)y(L[a][1][c]);L.splice(a,1),a-=1}}function m(a,b,c){function d(){var a;for(a=0;a<j.length;a+=1)J.splice(J.indexOf(j[a]),1)}function e(a){function b(){var b,d;for(b=0;b<c.length;b+=1)if("function"==typeof c[b])if("keyup"===a)for(d=0;d<j.length;d+=1)j[d].keyUpCallback.splice(j[d].keyUpCallback.indexOf(c[b]),1);else for(d=0;d<j.length;d+=1)j[d].keyDownCallback.splice(j[d].keyDownCallback.indexOf(c[b]),1)}var c,d,e,f={};if("string"!=typeof a)throw new Error("Cannot bind callback. The event name must be a string.");if("keyup"!==a&&"keydown"!==a)throw new Error('Cannot bind callback. The event name must be a "keyup" or "keydown".');for(c=Array.prototype.slice.apply(arguments,[1]),d=0;d<c.length;d+=1)if("function"==typeof c[d])if("keyup"===a)for(e=0;e<j.length;e+=1)j[e].keyUpCallback.push(c[d]);else if("keydown"===a)for(e=0;e<j.length;e+=1)j[e].keyDownCallback.push(c[d]);return f.clear=b,f}var f,g,h,i={},j=[];for("string"==typeof a&&(a=u(a)),g=0;g<a.length;g+=1){if(f={},h=v([a[g]]),"string"!=typeof h)throw new Error("Failed to bind key combo. The key combo must be string.");f.keyCombo=h,f.keyDownCallback=[],f.keyUpCallback=[],b&&f.keyDownCallback.push(b),c&&f.keyUpCallback.push(c),J.push(f),j.push(f)}return i.clear=d,i.on=e,i}function n(a){var b,c;for(b=0;b<J.length;b+=1)c=J[b],r(a,c.keyCombo)&&(J.splice(b,1),b-=1)}function o(a){var b,c,d;if(a){for(b=0;b<J.length;b+=1)for(d=J[b],c=0;c<d.keyCombo.length;c+=1)if(d.keyCombo[c].indexOf(a)>-1){J.splice(b,1),b-=1;break}}else J=[]}function p(a){var b,c,d,e,f,g,h,i,j,k,l,m=[];for(f=[].concat(I),b=0;b<J.length;b+=1)l=t(J[b].keyCombo).length,m[l]||(m[l]=[]),m[l].push(J[b]);for(c=m.length-1;c>=0;c-=1)if(m[c])for(b=0;b<m[c].length;b+=1){for(d=m[c][b],e=t(d.keyCombo),j=!0,i=0;i<e.length;i+=1)if(-1===f.indexOf(e[i])){j=!1;break}if(j&&s(d.keyCombo)){for(K.push(d),i=0;i<e.length;i+=1)k=f.indexOf(e[i]),k>-1&&(f.splice(k,1),i-=1);for(g=0;g<d.keyDownCallback.length;g+=1)d.keyDownCallback[g](a,w(),d.keyCombo)===!1&&(h=!0);h===!0&&(a.preventDefault(),a.stopPropagation())}}}function q(a){var b,c,d,e;for(b=0;b<K.length;b+=1)if(d=K[b],s(d.keyCombo)===!1){for(c=0;c<d.keyUpCallback.length;c+=1)d.keyUpCallback[c](a,w(),d.keyCombo)===!1&&(e=!0);e===!0&&(a.preventDefault(),a.stopPropagation()),K.splice(b,1),b-=1}}function r(a,b){var c,d,e;if(a=u(a),b=u(b),a.length!==b.length)return!1;for(c=0;c<a.length;c+=1){if(a[c].length!==b[c].length)return!1;for(d=0;d<a[c].length;d+=1){if(a[c][d].length!==b[c][d].length)return!1;for(e=0;e<a[c][d].length;e+=1)if(-1===b[c][d].indexOf(a[c][d][e]))return!1}}return!0}function s(a){var b,c,d,e,f,g,h=0;for(a=u(a),b=0;b<a.length;b+=1){for(g=!0,h=0,c=0;c<a[b].length;c+=1){for(d=[].concat(a[b][c]),e=h;e<I.length;e+=1)f=d.indexOf(I[e]),f>-1&&(d.splice(f,1),h=e);if(0!==d.length){g=!1;break}}if(g)return!0}return!1}function t(a){var b,c,d=[];for(a=u(a),b=0;b<a.length;b+=1)for(c=0;c<a[b].length;c+=1)d=d.concat(a[b][c]);return d}function u(a){var b=a,c=0,d=0,e=!1,f=!1,g=[],h=[],i=[],j="";if("object"==typeof a&&"function"==typeof a.push)return a;if("string"!=typeof a)throw new Error('Cannot parse "keyCombo" because its type is "'+typeof a+'". It must be a "string".');for(;" "===b.charAt(c);)c+=1;for(;;){if(" "===b.charAt(c)){for(;" "===b.charAt(c);)c+=1;e=!0}else if(","===b.charAt(c)){if(d||f)throw new Error("Failed to parse key combo. Unexpected , at character index "+c+".");f=!0,c+=1}else if("+"===b.charAt(c)){if(j.length&&(i.push(j),j=""),d||f)throw new Error("Failed to parse key combo. Unexpected + at character index "+c+".");d=!0,c+=1}else if(">"===b.charAt(c)){if(j.length&&(i.push(j),j=""),i.length&&(h.push(i),i=[]),d||f)throw new Error("Failed to parse key combo. Unexpected > at character index "+c+".");d=!0,c+=1}else if(c<b.length-1&&"!"===b.charAt(c)&&(">"===b.charAt(c+1)||","===b.charAt(c+1)||"+"===b.charAt(c+1)))j+=b.charAt(c+1),d=!1,e=!1,f=!1,c+=2;else{if(!(c<b.length&&"+"!==b.charAt(c)&&">"!==b.charAt(c)&&","!==b.charAt(c)&&" "!==b.charAt(c))){c+=1;continue}for((d===!1&&e===!0||f===!0)&&(j.length&&(i.push(j),j=""),i.length&&(h.push(i),i=[]),h.length&&(g.push(h),h=[])),d=!1,e=!1,f=!1;c<b.length&&"+"!==b.charAt(c)&&">"!==b.charAt(c)&&","!==b.charAt(c)&&" "!==b.charAt(c);)j+=b.charAt(c),c+=1}if(c>=b.length){j.length&&(i.push(j),j=""),i.length&&(h.push(i),i=[]),h.length&&(g.push(h),h=[]);break}}return g}function v(a){var b,c,d=[];if("string"==typeof a)return a;if("object"!=typeof a||"function"!=typeof a.push)throw new Error("Cannot stringify key combo.");for(b=0;b<a.length;b+=1){for(d[b]=[],c=0;c<a[b].length;c+=1)d[b][c]=a[b][c].join(" + ");d[b]=d[b].join(" > ")}return d.join(" ")}function w(){return[].concat(I)}function x(a){if(a.match(/\s/))throw new Error("Cannot add key name "+a+" to active keys because it contains whitespace.");I.indexOf(a)>-1||I.push(a)}function y(a){var b=h(a);"91"===b||"92"===b?I=[]:I.splice(I.indexOf(a),1)}function z(a,b){if("string"!=typeof a)throw new Error("Cannot register new locale. The locale name must be a string.");if("object"!=typeof b)throw new Error("Cannot register "+a+" locale. The locale map must be an object.");if("object"!=typeof b.map)throw new Error("Cannot register "+a+" locale. The locale map is invalid.");b.macros||(b.macros=[]),H[a]=b}function A(a){if(a){if("string"!=typeof a)throw new Error("Cannot set locale. The locale name must be a string.");if(!H[a])throw new Error("Cannot set locale to "+a+" because it does not exist. If you would like to submit a "+a+" locale map for KeyboardJS please submit it at https://github.com/RobertWHurst/KeyboardJS/issues.");C=H[a].map,D=H[a].macros,B=a}return B}var B,C,D,E,F,G={},H={},I=[],J=[],K=[],L=[];for(F={map:{3:["cancel"],8:["backspace"],9:["tab"],12:["clear"],13:["enter"],16:["shift"],17:["ctrl"],18:["alt","menu"],19:["pause","break"],20:["capslock"],27:["escape","esc"],32:["space","spacebar"],33:["pageup"],34:["pagedown"],35:["end"],36:["home"],37:["left"],38:["up"],39:["right"],40:["down"],41:["select"],42:["printscreen"],43:["execute"],44:["snapshot"],45:["insert","ins"],46:["delete","del"],47:["help"],91:["command","windows","win","super","leftcommand","leftwindows","leftwin","leftsuper"],92:["command","windows","win","super","rightcommand","rightwindows","rightwin","rightsuper"],145:["scrolllock","scroll"],186:["semicolon",";"],187:["equal","equalsign","="],188:["comma",","],189:["dash","-"],190:["period","."],191:["slash","forwardslash","/"],192:["graveaccent","`"],219:["openbracket","["],220:["backslash","\\"],221:["closebracket","]"],222:["apostrophe","'"],48:["zero","0"],49:["one","1"],50:["two","2"],51:["three","3"],52:["four","4"],53:["five","5"],54:["six","6"],55:["seven","7"],56:["eight","8"],57:["nine","9"],96:["numzero","num0"],97:["numone","num1"],98:["numtwo","num2"],99:["numthree","num3"],100:["numfour","num4"],101:["numfive","num5"],102:["numsix","num6"],103:["numseven","num7"],104:["numeight","num8"],105:["numnine","num9"],106:["nummultiply","num*"],107:["numadd","num+"],108:["numenter"],109:["numsubtract","num-"],110:["numdecimal","num."],111:["numdevide","num/"],144:["numlock","num"],112:["f1"],113:["f2"],114:["f3"],115:["f4"],116:["f5"],117:["f6"],118:["f7"],119:["f8"],120:["f9"],121:["f10"],122:["f11"],123:["f12"]},macros:[["shift + `",["tilde","~"]],["shift + 1",["exclamation","exclamationpoint","!"]],["shift + 2",["at","@"]],["shift + 3",["number","#"]],["shift + 4",["dollar","dollars","dollarsign","$"]],["shift + 5",["percent","%"]],["shift + 6",["caret","^"]],["shift + 7",["ampersand","and","&"]],["shift + 8",["asterisk","*"]],["shift + 9",["openparen","("]],["shift + 0",["closeparen",")"]],["shift + -",["underscore","_"]],["shift + =",["plus","+"]],["shift + (",["opencurlybrace","opencurlybracket","{"]],["shift + )",["closecurlybrace","closecurlybracket","}"]],["shift + \\",["verticalbar","|"]],["shift + ;",["colon",":"]],["shift + '",["quotationmark",'"']],["shift + !,",["openanglebracket","<"]],["shift + .",["closeanglebracket",">"]],["shift + /",["questionmark","?"]]]},E=65;90>=E;E+=1)F.map[E]=String.fromCharCode(E+32),F.macros.push(["shift + "+String.fromCharCode(E+32)+", capslock + "+String.fromCharCode(E+32),[String.fromCharCode(E)]]);return z("us",F),A("us"),b(),G.enable=b,G.disable=c,G.activeKeys=w,G.on=m,G.clear=n,G.clear.key=o,G.locale=A,G.locale.register=z,G.macro=i,G.macro.remove=j,G.key={},G.key.name=g,G.key.code=h,G.combo={},G.combo.active=s,G.combo.parse=u,G.combo.stringify=v,G});var c=c||{};c.AccelManager=c.Base.$extend({__init__:function(){this.__kbd={},this.$super()},__kbd:null,addAccel:function(a,c,d,e){var c=c.toLowerCase().replace(/ *\+ */," + ").replace(/ *, */,", ").replace(/ *> */," > ");this.removeAccel(a),this.__kbd[a]={keys:c,safe:e===b?!0:e,callback:d,binding:KeyboardJS.on(c,this.__onAccell.bind(this))}},removeAccel:function(a){this.__kbd[a]&&(this.__kbd[a].binding.clear(),delete this.__kbd[a])},destroy:function(){for(var a in this.__kbd)this.removeAccel(a);this.$super()},__onAccell:function(a,b,c){for(var d in this.__kbd)this.__kbd[d].keys==c&&(this.__kbd[d].safe&&(document.activeElement instanceof HTMLInputElement||document.activeElement instanceof HTMLSelectElement||document.activeElement instanceof HTMLTextAreaElement)||(this.__kbd[d].callback(),a.stopPropagation(),a.preventDefault()))}});var c=c||{};c.Separator=c.Widget.$extend({__init__:function(a){this.$super(a),this._updateProperties(["orientation"])},_orientation:"horizontal",getOrientation:function(){return this._orientation},setOrientation:function(a){if("vertical"!=a&&"horizontal"!=a)throw'Error: The orientation should be "vertical" or "horizontal".';this._orientation=a,this.removeClass("photonui-separator-vertical"),this.removeClass("photonui-separator-horizontal"),this.addClass("photonui-separator-"+this.orientation)},getHtml:function(){return this.__html.outer},_buildHtml:function(){this.__html.outer=document.createElement("div"),this.__html.outer.className="photonui-widget photonui-separator",this.__html.hr=document.createElement("hr"),this.__html.outer.appendChild(this.__html.hr)},__onLocaleChanged:function(){}});var c=c||{};c.Color=c.Base.$extend({__init__:function(a){this._registerWEvents(["value-changed"]),"object"!=typeof a||Array.isArray(a)?(this.$super(),"string"==typeof a?this.hexString=a:Array.isArray(a)?this.setRGBA(a):arguments.length>=3&&this.setRGBA.apply(this,arguments)):this.$super(a)},getHexString:function(){var a=this.red.toString(16).toUpperCase();1==a.length&&(a="0"+a);var b=this.green.toString(16).toUpperCase();1==b.length&&(b="0"+b);var c=this.blue.toString(16).toUpperCase();return 1==c.length&&(c="0"+c),"#"+a+b+c},setHexString:function(a){var a=a.replace(" ","");if(a.match(/^#[0-9a-f]{6}$/i))this._red=parseInt(a[1]+a[2],16),this._green=parseInt(a[3]+a[4],16),this._blue=parseInt(a[5]+a[6],16),this._updateHSB();else if(a.match(/^#[0-9a-f]{3}$/i))this._red=parseInt(a[1]+a[1],16),this._green=parseInt(a[2]+a[2],16),this._blue=parseInt(a[3]+a[3],16),this._updateHSB();else{var c={white:[255,255,255],silver:[192,192,192],gray:[128,128,128],black:[0,0,0],red:[255,0,0],maroon:[128,0,0],yellow:[255,255,0],olive:[128,128,0],lime:[0,255,0],green:[0,128,0],aqua:[0,255,255],teal:[0,128,128],blue:[0,0,255],navy:[0,0,128],fuchsia:[255,0,255],purple:[128,0,128]};c[a]!=b&&this.setRGB(c[a])}},getRgbString:function(){return"rgb("+this._red+", "+this._green+", "+this._blue+")"},getRgbaString:function(){return"rgba("+this._red+", "+this._green+", "+this._blue+", "+this._alpha/255+")"},_red:255,getRed:function(){return this._red},setRed:function(a){this._red=Math.max(0,Math.min(255,0|a)),this._updateHSB()},_green:0,getGreen:function(){return this._green},setGreen:function(a){this._green=Math.max(0,Math.min(255,0|a)),this._updateHSB()},_blue:0,getBlue:function(){return this._blue},setBlue:function(a){this._blue=Math.max(0,Math.min(255,0|a)),this._updateHSB()},_alpha:255,getAlpha:function(){return this._alpha},setAlpha:function(a){this._alpha=Math.max(0,Math.min(255,0|a)),this._callCallbacks("value-changed")},_hue:0,getHue:function(){return this._hue},setHue:function(a){this._hue=Math.max(0,Math.min(360,0|a)),this._updateRGB()},_saturation:100,getSaturation:function(){return this._saturation},setSaturation:function(a){this._saturation=Math.max(0,Math.min(100,0|a)),this._updateRGB()},_brightness:100,getBrightness:function(){return this._brightness},setBrightness:function(a){this._brightness=Math.max(0,Math.min(100,0|a)),this._updateRGB()},setRGB:function(){this.setRGBA.apply(this,arguments)},setRGBA:function(){var a=arguments;1==arguments.length&&Array.isArray(arguments[0])&&(a=arguments[0]),a.length<3||(this._red=Math.max(0,Math.min(255,0|a[0])),this._green=Math.max(0,Math.min(255,0|a[1])),this._blue=Math.max(0,Math.min(255,0|a[2])),a[3]!=b&&(this._alpha=Math.max(0,Math.min(255,0|a[3]))),this._updateHSB())},getRGB:function(){return[this._red,this._green,this._blue]},getRGBA:function(){return[this._red,this._green,this._blue,this._alpha]},setHSB:function(){var a=arguments;1==arguments.length&&Array.isArray(arguments[0])&&(a=arguments[0]),3==a.length&&(this._hue=Math.max(0,Math.min(360,0|a[0])),this._saturation=Math.max(0,Math.min(100,0|a[1])),this._brightness=Math.max(0,Math.min(100,0|a[2])),this._updateRGB())},toString:function(){return this.hexString},_updateHSB:function(){var a=this._red/255,b=this._green/255,c=this._blue/255,d=Math.min(a,b,c),e=Math.max(a,b,c);e==d?this._hue=0:e==a?this._hue=Math.round((60*(b-c)/(e-d)+360)%360):e==b?this._hue=Math.round(60*(c-a)/(e-d)+120):e==c&&(this._hue=Math.round(60*(a-b)/(e-d)+240)),this._saturation=0==e?0:Math.round(100*(1-d/e)),this._brightness=Math.round(100*e),this._callCallbacks("value-changed")},_updateRGB:function(){var a=this.hue%360,b=this.saturation/100,c=this.brightness/100,d=(a/60|0)%6,e=a/60-d,f=c*(1-b),g=c*(1-e*b),h=c*(1-(1-e)*b);switch(d){case 0:this._red=255*c|0,this._green=255*h|0,this._blue=255*f|0;break;case 1:this._red=255*g|0,this._green=255*c|0,this._blue=255*f|0;break;case 2:this._red=255*f|0,this._green=255*c|0,this._blue=255*h|0;break;case 3:this._red=255*f|0,this._green=255*g|0,this._blue=255*c|0;break;case 4:this._red=255*h|0,this._green=255*f|0,this._blue=255*c|0;break;case 5:this._red=255*c|0,this._green=255*f|0,this._blue=255*g|0}this._callCallbacks("value-changed")}});var c=c||{};c.Text=c.Widget.$extend({_lastSet:"text",_raw:"",getText:function(){return this.__html.outer.textContent},setText:function(a){this._lastSet="text",this._raw=a,c.Helpers.cleanNode(this.__html.outer),this.__html.outer.appendChild(document.createTextNode(a))},getRawHtml:function(){return this.__html.outer.innerHTML},setRawHtml:function(a){this._lastSet="rawHtml",this._raw=a,this.__html.outer.innerHTML=a},getHtml:function(){return this.__html.outer},_buildHtml:function(){this.__html.outer=document.createElement("div"),this.__html.outer.className="photonui-widget photonui-text"},__onLocaleChanged:function(){a.Stone&&(this.$super(),this._raw instanceof Stone.LazyString&&(this[this._lastSet]=this._raw))}});var c=c||{};c.FileManager=c.Base.$extend({__init__:function(a){this.__fileField=document.createElement("input"),this.__fileField.type="file",this.__fileField.addEventListener("change",this.__onFileSelected.bind(this),!1),this.__fileField.style.position="fixed",this.__fileField.style.top=0,this.__fileField.style.left=0,this.__fileField.style.opacity=0,this.__fileField.style.display="none",document.getElementsByTagName("body")[0].appendChild(this.__fileField),this._acceptedMimes=[],this._acceptedExts=[],this._registerWEvents(["file-open"]),this.$super(a)},_acceptedMimes:[],getAcceptedMimes:function(){return this._acceptedMimes},setAcceptedMimes:function(a){this._acceptedMimes=a,this._updateAccepted()},_acceptedExts:[],getAcceptedExts:function(){return this._acceptedExts},setAcceptedExts:function(a){this._acceptedExts=a,this._updateAccepted()},_dropZone:null,getDropZone:function(){return this._dropZone},setDropZone:function(a){this._dropZone&&(this._unbindEvent("document-dragover"),this._unbindEvent("document-drop"),this._unbindEvent("element-dragover"),this._unbindEvent("element-drop")),this._dropZone=a,a&&(this._bindEvent("document-dragover",document,"dragover",function(a){a.preventDefault()}),this._bindEvent("document-drop",document,"drop",function(a){a.preventDefault()}),this._bindEvent("element-dragover",document,"dragover",function(){}),this._bindEvent("element-drop",document,"drop",this.__onFileDropped.bind(this)))},_multiselect:!1,getMultiselect:function(){return this._multiselect},setMultiselect:function(a){this._multiselect=a,a?this.__fileField.multiple="true":delete this.__fileField.multiple},__fileField:null,open:function(){this.__fileField.style.display="inline-block",this.__fileField.focus(),this.__fileField.click(),this.__fileField.style.display="none"},destroy:function(){document.getElementsByTagName("body")[0].removeChild(this.__fileField),this.$super()},_updateAccepted:function(){for(var a=[],b=0;b<this.acceptedExts.length;b++)a.push("."+this.acceptedExts[b].toLocaleLowerCase());a=a.concat(this.acceptedMimes),this.__fileField.accept=a.join(",")},_openFile:function(a,b,c){for(var d=!1,e=0;e<this.acceptedMimes.length;e++)if(a.type==this.acceptedMimes[e]){d=!0;break}if(!d)for(var f=a.name.split(".").splice(-1),g=0;g<this.acceptedExts.length;g++)if(f==this.acceptedExts[g]){d=!0;break}d&&this._callCallbacks("file-open",[a,b,c])},__onFileDropped:function(a){for(var b in a.dataTransfer.files){var c=a.dataTransfer.files[b];c instanceof File&&this._openFile(c,a.pageX,a.pageY)}},__onFileSelected:function(){for(var a in this.__fileField.files){var b=this.__fileField.files[a];b instanceof File&&this._openFile(b)}},__onLocaleChanged:function(){}});var c=c||{};c.ProgressBar=c.Widget.$extend({__init__:function(a){this.$super(a),this._updateProperties(["orientation","value","pulsate"])},getHtml:function(){return this.__html.outer},_value:0,getValue:function(){return this._value},setValue:function(a){this._value=Math.min(Math.max(a,0),1),"horizontal"==this.orientation?this.__html.bar.style.width=Math.floor(100*this.value)+"%":this.__html.bar.style.height=Math.floor(100*this.value)+"%",this.__html.textContent.innerHTML=Math.floor(100*this.value)+" %"},_orientation:"horizontal",getOrientation:function(){return this._orientation},setOrientation:function(a){if("vertical"!=a&&"horizontal"!=a)throw'Error: The orientation should be "vertical" or "horizontal".';this._orientation=a,this.removeClass("photonui-progressbar-vertical"),this.removeClass("photonui-progressbar-horizontal"),this.addClass("photonui-progressbar-"+this.orientation)},_pulsate:!1,isPulsate:function(){return this._pulsate},setPulsate:function(a){this._pulsate=a,a?(this.addClass("photonui-progressbar-pulsate"),"horizontal"==this.orientation?this.__html.bar.style.width="":this.__html.bar.style.height=""):(this.removeClass("photonui-progressbar-pulsate"),this.value=this.value)},_textVisible:!0,isTextVisible:function(){return this._textVisible},setTextVisible:function(a){this._textVisible=a,this.__html.text.style.display=this.textVisible?"":"none"},_buildHtml:function(){this.__html.outer=document.createElement("div"),this.__html.outer.className="photonui-widget photonui-progressbar",this.__html.text=document.createElement("div"),this.__html.text.className="photonui-progressbar-text",this.__html.outer.appendChild(this.__html.text),this.__html.textContent=document.createElement("span"),this.__html.text.appendChild(this.__html.textContent),this.__html.bar=document.createElement("div"),this.__html.bar.className="photonui-progressbar-bar",this.__html.outer.appendChild(this.__html.bar)},__onLocaleChanged:function(){}});var c=c||{};c.MouseManager=c.Base.$extend({__init__:function(a){this._registerWEvents(["mouse-event","mouse-down","mouse-up","click","double-click","drag-start","dragging","drag-end","mouse-move","scroll-up","scroll-down"]),this.$super(),this.element=a},_element:null,getElement:function(){return this._element||document},setElement:function(a){this._element=a instanceof c.Widget?a.interactiveNode||a.html:a instanceof HTMLElement?a:null,this._updateEvents()},_threshold:5,getThreshold:function(){return this._threshold},setThreshold:function(a){this._threshold=a},getPageX:function(){return this.__event.pageX||0},getPageY:function(){return this.__event.pageY||0},getX:function(){var a=c.Helpers.getAbsolutePosition(this.element).x;return this.pageX-a},getY:function(){var a=c.Helpers.getAbsolutePosition(this.element).y;return this.pageY-a},getDeltaX:function(){return this.pageX-(this.__prevState.pageX!==b?this.__prevState.pageX:this.pageX)},getDeltaY:function(){return this.pageY-(this.__prevState.pageY!==b?this.__prevState.pageY:this.pageY)},_action:"",getAction:function(){return this._action},_btnLeft:!1,getBtnLeft:function(){return this._btnLeft},_btnMiddle:!1,getBtnMiddle:function(){return this._btnMiddle},_btnRight:!1,getBtnRight:function(){return this._btnRight},_button:null,getButton:function(){return this._button},__prevState:{},__mouseDownEvent:{},__event:{},_updateEvents:function(){for(var a in this.__events)this._unbindEvent(a);this.element&&(this._bindEvent("mouse-down",this.element,"mousedown",this.__onMouseDown.bind(this)),this._bindEvent("mouse-up",this.element,"mouseup",this.__onMouseUp.bind(this)),this._bindEvent("double-click",this.element,"dblclick",this.__onDoubleClick.bind(this)),this._bindEvent("mouse-move",this.element,"mousemove",this.__onMouseMove.bind(this)),this._bindEvent("mousewheel",this.element,"mousewheel",this.__onMouseWheel.bind(this)),this._bindEvent("mousewheel-firefox",this.element,"DOMMouseScroll",this.__onMouseWheel.bind(this)),this._bindEvent("document-mouse-up",document,"mouseup",this.__onDocumentMouseUp.bind(this)),this._bindEvent("document-mouse-move",document,"mousemove",this.__onDocumentMouseMove.bind(this)))},_dump:function(){return{event:this.__event,action:this.action,pageX:this.pageX,pageY:this.pageY,x:this.x,y:this.y,deltaX:this.deltaX,deltaY:this.deltaY,btnLeft:this.btnLeft,btnMiddle:this.btnMiddle,btnRight:this.btnRight,button:this.button}},_stateMachine:function(a,b){this.__prevState=this._dump(),this._action=a,this.__event=b,this._button=null,0===b.button&&(this._button="left"),1===b.button&&(this._button="middle"),2===b.button&&(this._button="right"),"mouse-down"==a?(this.__mouseDownEvent=b,0===b.button&&(this._btnLeft=!0),1===b.button&&(this._btnMiddle=!0),2===b.button&&(this._btnRight=!0),this._callCallbacks("mouse-event",[this._dump()]),this._callCallbacks(this.action,[this._dump()])):"mouse-up"==a?(0===b.button&&(this._btnLeft=!1),1===b.button&&(this._btnMiddle=!1),2===b.button&&(this._btnRight=!1),this._callCallbacks("mouse-event",[this._dump()]),this._callCallbacks(this.action,[this._dump()])):"drag-end"==a&&(0===b.button&&(this._btnLeft=!1),1===b.button&&(this._btnMiddle=!1),2===b.button&&(this._btnRight=!1)),"mouse-up"==a&&Math.abs(this.pageX-this.__mouseDownEvent.pageX)<=this._threshold&&Math.abs(this.pageY-this.__mouseDownEvent.pageY)<=this._threshold&&(this._action="click",this._callCallbacks("mouse-event",[this._dump()]),this._callCallbacks("click",[this._dump()])),"double-click"==a&&"click"==this.__prevState.action&&(this._action="double-click",this._callCallbacks("mouse-event",[this._dump()]),this._callCallbacks(this.action,[this._dump()])),"mouse-move"==a&&(this._callCallbacks("mouse-event",[this._dump()]),this._callCallbacks(this.action,[this._dump()])),"mouse-move"==a&&"drag-start"!=this.__prevState.action&&"dragging"!=this.__prevState.action&&(this.btnLeft||this.btnMiddle||this.btnRight)?(Math.abs(this.pageX-this.__mouseDownEvent.pageX)>this._threshold||Math.abs(this.pageY-this.__mouseDownEvent.pageY)>this._threshold)&&(this._action="drag-start",this.__event=this.__mouseDownEvent,this._callCallbacks("mouse-event",[this._dump()]),this._callCallbacks(this.action,[this._dump()]),this._action="dragging",this.__prevState.event=this.__mouseDownEvent,this.__event=b,this._callCallbacks("mouse-event",[this._dump()]),this._callCallbacks(this.action,[this._dump()])):"dragging"==a||"mouse-move"==a&&("drag-start"==this.__prevState.action||"dragging"==this.__prevState.action)&&(this.btnLeft||this.btnMiddle||this.btnRight)?(this._action="dragging",this._callCallbacks("mouse-event",[this._dump()]),this._callCallbacks(this.action,[this._dump()])):"drag-end"!=a&&("mouse-up"!=a||"dragging"!=this.__prevState.action&&"drag-start"!=this.__prevState.action||this.btnLeft||this.btnMiddle||this.btnRight)||(this._action="drag-end",this._callCallbacks("mouse-event",[this._dump()]),this._callCallbacks(this.action,[this._dump()])),("scroll-up"==a||"scroll-down"==a)&&(this._callCallbacks("mouse-event",[this._dump()]),this._callCallbacks(this.action,[this._dump()]))},__onMouseDown:function(a){this._stateMachine("mouse-down",a)},__onMouseUp:function(a){this._stateMachine("mouse-up",a)},__onDoubleClick:function(a){this._stateMachine("double-click",a)},__onMouseMove:function(a){this._stateMachine("mouse-move",a)},__onDocumentMouseUp:function(a){("dragging"==this.action||"drag-start"==this.action)&&this._stateMachine("drag-end",a)},__onDocumentMouseMove:function(a){("dragging"==this.action||"drag-start"==this.action)&&this._stateMachine("dragging",a)},__onMouseWheel:function(a){var c=null;a.wheelDeltaY!=b&&(c=a.wheelDeltaY),a.wheelDelta!=b&&(c=a.wheelDelta),a.axis!=b&&a.detail!=b&&2==a.axis&&(c=-a.detail),null!=c&&(c>=0?this._stateMachine("scroll-up",a):this._stateMachine("scroll-down",a))}});var c=c||{};c.palette=[["#000000","#424242","#676767","#989898","#C5C5C5","#FFFFFF"],["#E52131","#ED7130","#F0902C","#F0B922","#EDE118","#7DA638"],["#EA4852","#F08D52","#F3A752","#F9D246","#F0EC51","#A7CF41"],["#F19096","#F5BC93","#F9CB94","#F9E48A","#F2F08E","#C6DE84"],["#F8D1D6","#F9E2D2","#F9E8D3","#FDF8D2","#F9F9CF","#E7F1CD"],["#1E9E85","#2A7DB5","#2751A1","#6C3E98","#A33E97","#DF3795"],["#2FB8A3","#40A1D7","#4072B5","#8963AB","#B462A7","#E262A5"],["#88CEC3","#8CC9E9","#87A8D3","#D2A0C9","#D2A0C9","#EDA0C6"],["#CEEAE7","#CDE9F8","#CFDEEF","#EED9E9","#EED9E9","#F8D7E7"]],c.ColorPalette=c.Widget.$extend({__init__:function(a){this._color=new c.Color(c.palette[0][0]),this._registerWEvents(["value-changed"]),this.$super(a),this._updateProperties(["palette","value"])},getValue:function(){return this.color.hexString},setValue:function(a){this.color.hexString=a},_color:null,getColor:function(){return this._color},setColor:function(a){a instanceof c.Color&&(this._color=a)},_palette:null,getPalette:function(){return this._palette||c.palette},setPalette:function(a){if(this._palette=a,!a)var a=c.palette;this.__html.palette.removeChild(this.__html.tbody),c.Helpers.cleanNode(this.__html.tbody);var b,d,e,f;for(f=0;f<a.length;f++){var b=document.createElement("tr");for(e=0;e<a[f].length;e++){var d=document.createElement("td");d.style.backgroundColor=a[f][e],d.onclick=this.__onColorClicked.bind(this,a[f][e]),b.appendChild(d)}this.__html.tbody.appendChild(b)}this.__html.palette.appendChild(this.__html.tbody)},getHtml:function(){return this.__html.palette},_buildHtml:function(){this.__html.palette=document.createElement("table"),this.__html.palette.className="photonui-widget photonui-colorpalette",this.__html.tbody=document.createElement("tbody"),this.__html.palette.appendChild(this.__html.tbody)},__onColorClicked:function(a){this.value=a,this._callCallbacks("value-changed",[this.color])}});var c=c||{};c.FAIcon=c.BaseIcon.$extend({__init__:function(a,b){var c={};if(a&&"string"==typeof a){if(c.iconName=a,b&&"object"==typeof b)for(var d in b)c[d]=b[d]}else a&&(c=a);this.$super(c),this._updateProperties(["iconName","size","color"])},_iconName:"",getIconName:function(){return this._iconName},setIconName:function(a){this._iconName=a||"",this.__html.icon.className="fa "+this.iconName+" "+this.size},_size:"",getSize:function(){return this._size},setSize:function(a){this._size=a||"",this.__html.icon.className="fa "+this.iconName+" "+this.size},_color:"inherit",getColor:function(){return this._color},setColor:function(a){this._color=a||"inherit",this.__html.icon.style.color=this.color},getHtml:function(){return this.__html.outer},_buildHtml:function(){this.__html.outer=document.createElement("span"),this.__html.outer.className="photonui-widget photonui-icon photonui-faicon",this.__html.icon=document.createElement("i"),this.__html.outer.appendChild(this.__html.icon)}});var c=c||{};c.Layout=c.Container.$extend({__init__:function(a){this._childrenNames=[],this.$super(a)},_childrenNames:[],getChildrenNames:function(){return this._childrenNames},setChildrenNames:function(a){this._childrenNames=a,this._updateLayout()},getChildren:function(){for(var a=[],b=0;b<this._childrenNames.length;b++)a.push(c.getWidget(this._childrenNames[b]));return a},setChildren:function(a){for(var b=[],d=0;d<a.length;d++)a[d]instanceof c.Widget&&b.push(a[d].name);this.childrenNames=b},getChildName:function(){return console.warn("Warning: You cannot use getChild() on layout widgets, please use getChildren() instead."),null},setChildName:function(a){this.childrenNames=[a]},getChild:function(){return console.warn("Warning: You cannot use getChild() on layout widgets, please use getChildren() instead."),null},setChild:function(a){this.children=[a]},addChild:function(a,b){b&&(a.layoutOptions=b),this._childrenNames.push(a.name),this._updateLayout()},removeChild:function(a){var b=this._childrenNames.indexOf(a.name);b>=0&&this._childrenNames.splice(b,1),this._updateLayout()},destroy:function(){for(var a=this.children,b=0;b<a.length;b++)a[b].destroy();this.$super()},_updateLayout:function(){throw"Error: you should define the _updateLayout() method when you extend a layout widget."},__onLocaleChanged:function(){}});var c=c||{};c.TextField=c.Field.$extend({__init__:function(a){this.$super(a),this._bindFieldEvents()},getType:function(){return this.__html.field.type},setType:function(a){if("text"!=a&&"password"!=a&&"email"!=a&&"search"!=a&&"tel"!=a&&"url"!=a)throw'Error: The type should be "text", "password", "email", "search", "tel" or "url".';this.__html.field.type=a},_buildHtml:function(){this.__html.field=document.createElement("input"),this.__html.field.className="photonui-widget photonui-field photonui-field-text",this.__html.field.type="text"}});var c=c||{};c.NumericField=c.Field.$extend({__init__:function(a){this.$super(a),this._updateProperties(["value"]),this._bindFieldEvents(),this._unbindEvent("value-changed"),this._bindEvent("keypress",this.__html.field,"keypress",this.__onKeypress.bind(this)),this._bindEvent("keyup",this.__html.field,"keyup",this.__onKeyup.bind(this)),this._bindEvent("keydown",this.__html.field,"keydown",this.__onKeydown.bind(this)),this._bindEvent("change",this.__html.field,"change",this.__onChange.bind(this)),this._bindEvent("mousewheel",this.__html.field,"mousewheel",this.__onMouseWheel.bind(this)),this._bindEvent("mousewheel-firefox",this.__html.field,"DOMMouseScroll",this.__onMouseWheel.bind(this))
},_min:null,getMin:function(){return this._min},setMin:function(a){this._min=a},_max:null,getMax:function(){return this._max},setMax:function(a){this._max=a},_step:1,getStep:function(){return this._step},setStep:function(a){this._step=Math.abs(a)},_decimalDigits:null,getDecimalDigits:function(){return this._decimalDigits},setDecimalDigits:function(a){this._decimalDigits=a},_decimalSymbol:".",getDecimalSymbol:function(){return this._decimalSymbol},setDecimalSymbol:function(a){this._decimalSymbol=a},_value:0,getValue:function(){return parseFloat(this._value)},setValue:function(a){this._updateValue(a),this._updateFieldValue()},_updateValue:function(a){a=(""+a).replace(",","."),a=a.replace(/ /g,""),a=parseFloat(a),isNaN(a)&&(a=0),null!=this.min&&(a=Math.max(this.min,a)),null!=this.max&&(a=Math.min(this.max,a)),null!=this.decimalDigits&&(a=a.toFixed(this.decimalDigits)),this._value=a},_updateFieldValue:function(){this.__html.field.value=(""+this._value).replace(".",this.decimalSymbol)},_validateInput:function(a){var a=""+a;return a=a.replace(/ /g,""),/^-?[0-9]*(\.|,)?[0-9]*$/.test(a)&&(0!=this.decimalDigits||/^-?[0-9]*$/.test(a))?null!==this.min&&this.min>=0&&"-"==a[0]?!1:!0:!1},_buildHtml:function(){this.__html.field=document.createElement("input"),this.__html.field.className="photonui-widget photonui-field photonui-field-numeric",this.__html.field.type="text"},__onKeypress:function(a){if(!a.ctrlKey)if(13==a.keyCode)this._updateFieldValue(),this._callCallbacks("value-changed",[this.value]);else{var b=this.__html.field,c=b.value.slice(0,b.selectionStart)+String.fromCharCode(a.charCode)+b.value.slice(b.selectionEnd);this._validateInput(c)||a.preventDefault()}},__onKeyup:function(){var a=this.__html.field.value.replace(/[^0-9.,-]*/g,"");a!=this.__html.field.value&&(this.__html.field.value=a),this._updateValue(this.__html.field.value)},__onChange:function(){this._updateFieldValue(),this._callCallbacks("value-changed",[this.value])},__onMouseWheel:function(a){if(document.activeElement==this.__html.field){var c=null;a.wheelDeltaY!=b&&(c=a.wheelDeltaY),a.wheelDelta!=b&&(c=a.wheelDelta),a.axis!=b&&a.detail!=b&&2==a.axis&&(c=-a.detail),null!=c&&(c>=0?this.value+=this.step:this.value-=this.step,a.preventDefault()),this._callCallbacks("value-changed",[this.value])}},__onKeydown:function(a){38==a.keyCode?(this.setValue(this.getValue()+this.step),a.preventDefault(),this._callCallbacks("value-changed",[this.value])):40==a.keyCode&&(this.setValue(this.getValue()-this.step),a.preventDefault(),this._callCallbacks("value-changed",[this.value]))}});var c=c||{};c.Viewport=c.Container.$extend({__init__:function(a){this.$super(a),this._updateProperties(["padding","verticalScrollbar","horizontalScrollbar"])},_padding:0,getPadding:function(){return this._padding},setPadding:function(a){this._padding=a,this.containerNode.style.padding=a+"px"},_verticalScrollbar:null,getVerticalScrollbar:function(){return this._verticalScrollbar},setVerticalScrollbar:function(a){this._verticalScrollbar=a,this.__html.viewport.style.overflowY=a===!0?"scroll":a===!1?"hidden":"auto"},_horizontalScrollbar:null,getHorizontalScrollbar:function(){return this._horizontalScrollbar},setHorizontalScrollbar:function(a){this._horizontalScrollbar=a,this.__html.viewport.style.overflowX=a===!0?"scroll":a===!1?"hidden":"auto"},getHtml:function(){return this.__html.viewport},getContainerNode:function(){return this.html},_buildHtml:function(){this.__html.viewport=document.createElement("div"),this.__html.viewport.className="photonui-widget photonui-viewport photonui-container"},__onLocaleChanged:function(){}});var c=c||{};c.Switch=c.CheckBox.$extend({__init__:function(a){this.$super(a),this.removeClass("photonui-checkbox"),this.addClass("photonui-switch")}});var c=c||{};c.BaseWindow=c.Container.$extend({__init__:function(a){this._registerWEvents(["position-changed"]),this.$super(a);var a=a||{};a.visible===b&&(this.visible=!1),c.domInsert(this),this._updateProperties(["position","width","height","minWidth","minHeight","maxWidth","maxHeight","padding"])},getPosition:function(){return this.visible&&this.html.parentNode?this.absolutePosition:{x:this._x,y:this._y}},setPosition:function(a,c){"object"==typeof a&&c==b?(this.html.style.left=a.x+"px",this.html.style.top=a.y+"px",this._x=a.x,this._y=a.y):("number"==typeof a&&(this.html.style.left=a+"px",this._x=a),"number"==typeof c&&(this.html.style.top=c+"px",this._y=c)),this._callCallbacks("position-changed",[this.x,this.y])},_x:0,getX:function(){return this.position.x},setX:function(a){this.setPosition(a,null)},_y:0,getY:function(){return this.position.y},setY:function(a){this.setPosition(null,a)},_width:null,getWidth:function(){return this.visible&&this.html.parenNode?this.containerNode.offsetWidth:this._width||0},setWidth:function(a){this._width=a||null,this.containerNode.style.width=this._width?a+"px":"auto"},_height:null,getHeight:function(){return this.visible&&this.html.parenNode?this.containerNode.offsetHeight:this._height||0},setHeight:function(a){this._height=a||null,this.containerNode.style.height=this._height?a+"px":"auto"},_minWidth:null,getMinWidth:function(){return this._minWidth},setMinWidth:function(a){this._minWidth=a||null,this.containerNode.style.minWidth=this._minWidth?a+"px":"0"},_minHeight:null,getMinHeight:function(){return this._minHeight},setMinHeight:function(a){this._minHeight=a||null,this.containerNode.style.minHeight=this._minHeight?a+"px":"0"},_maxWidth:null,getMaxWidth:function(){return this._maxWidth},setMaxWidth:function(a){this._maxWidth=a||null,this.containerNode.style.maxWidth=this._maxWidth?a+"px":"auto"},_maxHeight:null,getMaxHeight:function(){return this._maxHeight},setMaxHeight:function(a){this._maxHeight=a||null,this.containerNode.style.maxHeight=this._maxHeight?a+"px":"auto"},_padding:0,getPadding:function(){return this._padding},setPadding:function(a){this._padding=a,this.containerNode.style.padding=a+"px"},getHtml:function(){return this.__html.window},getContainerNode:function(){return this.html},center:function(){var a=c.e_parent||document.getElementsByTagName("body")[0];a&&this.setPosition(Math.round((a.offsetWidth-this.offsetWidth)/2),Math.round((a.offsetHeight-this.offsetHeight)/2))},_buildHtml:function(){this.__html.window=document.createElement("div"),this.__html.window.className="photonui-widget photonui-basewindow"}});var c=c||{},e={};c.getSpriteSheet=function(a){return e[a]!==b?e[a]:null},c.SpriteSheet=c.Base.$extend({__init__:function(a){this._icons={},this.$super(a),this._updateProperties(["name"])},_name:"default",getName:function(){return this._name},setName:function(a){e[this.name]==this&&delete e[this.name],this._name=a,e[this.name]=this},_imageUrl:null,getImageUrl:function(){return this._imageUrl},setImageUrl:function(a){if(!a)return void(this._imageUrl=null);if(this._imageUrl!=a){this._imageUrl=a;var b=new Image;b.src=a}},_size:16,getSize:function(){return this._size},setSize:function(a){this._size=a},_icons:{},getIcons:function(){return this._icons},setIcons:function(a){for(icon in a)this._icons[icon]=a[icon]},getIconPosition:function(a){return{x:this.icons[a][0],y:this.icons[a][1]}},getIconCss:function(a){return"width: "+this.size+"px; height: "+this.size+"px; background: url("+this.imageUrl+") -"+this.getIconPosition(a).x+"px -"+this.getIconPosition(a).y+"px;"},addIcon:function(a,b,c){this.icons={iconName:[b,c]}},removeIcon:function(a){delete this._icons[a]}}),c.SpriteIcon=c.BaseIcon.$extend({__init__:function(a,b){var c={};if(a&&"string"==typeof a){if(c.icon=a,b&&"object"==typeof b)for(var d in b)c[d]=b[d]}else a&&(c=a);this.$super(c)},_spriteSheetName:"",getSpriteSheetName:function(){return this._spriteSheetName},setSpriteSheetName:function(a){this._spriteSheetName=a||"",this._update()},_iconName:"",getIconName:function(){return this._iconName},setIconName:function(a){this._iconName=a||"",this._update()},getIcon:function(){return this.spriteSheetName+"/"+this.iconName},setIcon:function(a){var b=a.split("/");this.spriteSheetName=b[0],this.iconName=b[1]},getHtml:function(){return this.__html.outer},_update:function(){var a="";this.spriteSheetName&&this.iconName&&(a=c.getSpriteSheet(this.spriteSheetName).getIconCss(this.iconName)),this.__html.icon.setAttribute("style",a)},_buildHtml:function(){this.__html.outer=document.createElement("span"),this.__html.outer.className="photonui-widget photonui-icon photonui-spriteicon",this.__html.icon=document.createElement("span"),this.__html.outer.appendChild(this.__html.icon)}});var c=c||{};c.TextAreaField=c.Field.$extend({__init__:function(a){this.$super(a),this._bindFieldEvents()},getCols:function(){return parseInt(this.__html.field.cols)},setCols:function(a){this.__html.field.cols=a},getRows:function(){return parseInt(this.__html.field.rows)},setRows:function(a){this.__html.field.rows=a},_buildHtml:function(){this.__html.field=document.createElement("textarea"),this.__html.field.className="photonui-widget photonui-field photonui-field-textarea",this.__html.field.cols=20,this.__html.field.rows=3}});var c=c||{},f=[];c.Window=c.BaseWindow.$extend({__init__:function(a){this._registerWEvents(["close-button-clicked"]),this.$super(a),this._bindEvent("move.dragstart",this.__html.windowTitle,"mousedown",this.__moveDragStart.bind(this)),this._bindEvent("closeButton.click",this.__html.windowTitleCloseButton,"click",this.__closeButtonClicked.bind(this)),this._bindEvent("totop",this.__html.window,"mousedown",this.moveToFront.bind(this)),this._bindEvent("closeButton.mousedown",this.__html.windowTitleCloseButton,"mousedown",function(a){a.stopPropagation()}),this._updateProperties(["title","closeButtonVisible"]),this.moveToFront()},_title:"Window",getTitle:function(){return this._title},setTitle:function(a){this._title=a,c.Helpers.cleanNode(this.__html.windowTitleText),this.__html.windowTitleText.appendChild(document.createTextNode(a))},_movable:!0,isMovable:function(){return this._movable},setMovable:function(a){this._movable=a},_closeButtonVisible:!0,getCloseButtonVisible:function(){return this._closeButtonVisible},setCloseButtonVisible:function(a){this._closeButtonVisible=a,a?(this.addClass("photonui-window-have-button"),this.__html.windowTitleCloseButton.style.display="block"):(this.removeClass("photonui-window-have-button"),this.__html.windowTitleCloseButton.style.display="none")},_modal:!1,isModal:function(){return this._modal},setModal:function(a){if(this._modal=a,a){this.__html.modalBox=document.createElement("div"),this.__html.modalBox.className="photonui-window-modalbox";var b=c.e_parent||document.getElementsByTagName("body")[0];b.appendChild(this.__html.modalBox),this.visible=this.visible}else this.__html.modalBox&&(this.__html.modalBox.parentNode.removeChild(this.__html.modalBox),delete this.__html.modalBox)},getContainerNode:function(){return this.__html.windowContent},setVisible:function(a){this.$super(a),this.visible?(this.moveToFront(),this.modal&&(this.__html.modalBox.style.display="block")):(this.moveToBack(),this.modal&&(this.__html.modalBox.style.display="none"))},moveToFront:function(){var a=f.indexOf(this);a>=0&&f.splice(a,1),f.unshift(this),this._updateWindowList()},moveToBack:function(){var a=f.indexOf(this);a>=0&&f.splice(a,1),f.push(this),this._updateWindowList()},destroy:function(){this.modal=!1;var a=f.indexOf(this);a>=0&&f.splice(a,1),this.$super()},_buildHtml:function(){a.Stone&&a.Stone.lazyGettext,this.$super(),this.__html.window.className+=" photonui-window",this.__html.windowTitle=document.createElement("div"),this.__html.windowTitle.className="photonui-window-title",this.__html.window.appendChild(this.__html.windowTitle),this.__html.windowTitleCloseButton=document.createElement("button"),this.__html.windowTitleCloseButton.className="photonui-window-title-close-button",this.__html.windowTitleCloseButton.title=a.Stone?a.Stone.lazyGettext("Close"):"Close",this.__html.windowTitle.appendChild(this.__html.windowTitleCloseButton),this.__html.windowTitleText=document.createElement("span"),this.__html.windowTitleText.className="photonui-window-title-text",this.__html.windowTitle.appendChild(this.__html.windowTitleText),this.__html.windowContent=document.createElement("div"),this.__html.windowContent.className="photonui-container photonui-window-content photonui-container-expand-child",this.__html.window.appendChild(this.__html.windowContent)},_updateWindowList:function(){for(var a=f.length-1,b=0;a>=0;a--,b++)0==a?(f[a].html.style.zIndex=2001,f[a].addClass("photonui-active")):(f[a].html.style.zIndex=1e3+b,f[a].removeClass("photonui-active")),f[a].modal&&(f[a].html.style.zIndex=3001)},__moveDragStart:function(a){if(this.movable&&!(a.button>0)){var c=a.offsetX!=b?a.offsetX:a.layerX,d=a.offsetY!=b?a.offsetY:a.layerY;this.__html.windowTitle.style.cursor="move",this._bindEvent("move.dragging",document,"mousemove",this.__moveDragging.bind(this,c,d)),this._bindEvent("move.dragend",document,"mouseup",this.__moveDragEnd.bind(this))}},__moveDragging:function(a,b,c){var d=document.getElementsByTagName("body")[0],e=Math.min(Math.max(c.pageX-a,40-this.offsetWidth),d.offsetWidth-40),f=Math.max(c.pageY-b,0);d.offsetHeight>0&&(f=Math.min(f,d.offsetHeight-this.__html.windowTitle.offsetHeight)),this.setPosition(e,f)},__moveDragEnd:function(){this.__html.windowTitle.style.cursor="default",this._unbindEvent("move.dragging"),this._unbindEvent("move.dragend")},__closeButtonClicked:function(){this._callCallbacks("close-button-clicked")},__onLocaleChanged:function(){this.$super(),this.__html.windowTitleCloseButton.title=a.Stone?a.Stone.lazyGettext("Close"):"Close"}});var c=c||{};c.GridLayout=c.Layout.$extend({__init__:function(a){this.$super(a),this._updateProperties(["verticalSpacing"])},_verticalSpacing:5,getVerticalSpacing:function(){return this._verticalSpacing},setVerticalSpacing:function(a){this._verticalSpacing=a,this.__html.grid.style.borderSpacing=this.verticalSpacing+"px "+this.horizontalSpacing+"px"},_horizontalSpacing:5,getHorizontalSpacing:function(){return this._horizontalSpacing},setHorizontalSpacing:function(a){this._horizontalSpacing=a,this.__html.grid.style.borderSpacing=this.verticalSpacing+"px "+this.horizontalSpacing+"px"},getHtml:function(){return this.__html.outerbox},_buildHtml:function(){this.__html.outerbox=document.createElement("div"),this.__html.outerbox.className="photonui-widget photonui-gridlayout",this.__html.grid=document.createElement("table"),this.__html.outerbox.appendChild(this.__html.grid),this.__html.gridBody=document.createElement("tbody"),this.__html.grid.appendChild(this.__html.gridBody)},_updateLayout:function(){for(var a=1/0,d=1/0,e=0,f=0,g=this.children,h=0;h<g.length;h++)g[h].layoutOptions.gridX=g[h].layoutOptions.gridX!=b?g[h].layoutOptions.gridX:0,g[h].layoutOptions.gridY=g[h].layoutOptions.gridY!=b?g[h].layoutOptions.gridY:0,g[h].layoutOptions.gridWidth=Math.max(g[h].layoutOptions.gridWidth,1)||1,g[h].layoutOptions.gridHeight=Math.max(g[h].layoutOptions.gridHeight,1)||1,a=Math.min(a,g[h].layoutOptions.gridX),d=Math.min(d,g[h].layoutOptions.gridY),e=Math.max(e,g[h].layoutOptions.gridX+g[h].layoutOptions.gridWidth),f=Math.max(f,g[h].layoutOptions.gridY+g[h].layoutOptions.gridHeight);e-=a,f-=d,c.Helpers.cleanNode(this.__html.gridBody);for(var i=[],j=0;f>j;j++){for(var k=[],l=0;e>l;l++)k.push(!1);i.push(k)}for(var j=0;f>j;j++){var m=document.createElement("tr");this.__html.gridBody.appendChild(m);for(var l=0;e>l;l++)if(!i[j][l]){var n=!1,o=document.createElement("td");o.className="photonui-container photonui-gridlayout-cell",m.appendChild(o);for(var h=0;h<g.length;h++)if(g[h].layoutOptions.gridX-a==l&&g[h].layoutOptions.gridY-d==j){n=!0;var p=g[h].layoutOptions.gridWidth,q=g[h].layoutOptions.gridHeight;if(o.colSpan=p,o.rowSpan=q,o.appendChild(g[h].html),(g[h].layoutOptions.horizontalExpansion==b||g[h].layoutOptions.horizontalExpansion)&&(o.className+=" photonui-container-expand-child-horizontal"),(g[h].layoutOptions.verticalExpansion==b||g[h].layoutOptions.verticalExpansion)&&(o.className+=" photonui-container-expand-child-vertical"),g[h].layoutOptions.width!=b&&(o.style.height=g[h].layoutOptions.width+"px"),g[h].layoutOptions.height!=b&&(o.style.height=g[h].layoutOptions.height+"px"),g[h].layoutOptions.minWidth!=b&&(o.style.minWidth=g[h].layoutOptions.minWidth+"px"),g[h].layoutOptions.minHeight!=b&&(o.style.minHeight=g[h].layoutOptions.minHeight+"px"),g[h].layoutOptions.maxWidth!=b&&(o.style.maxWidth=g[h].layoutOptions.maxWidth+"px"),g[h].layoutOptions.maxHeight!=b&&(o.style.maxHeight=g[h].layoutOptions.maxHeight+"px"),g[h].layoutOptions.horizontalAlign!=b&&(o.style.textAlign=g[h].layoutOptions.horizontalAlign),p>1||q>1)for(var r=j;j+q>r;r++)for(var s=l;l+p>s;s++)i[r][s]=!0;break}n||(o.innerHTML="&nbsp;")}}}});var c=c||{};c.Slider=c.NumericField.$extend({__init__:function(a){this.$super(a),this.inputId=this.name+"-field",this.__html.field.id=this.inputId,this._updateProperties(["fieldVisible"]),this._bindEvent("slider-mousedown",this.__html.slider,"mousedown",this.__onSliderMouseDown.bind(this)),this._bindEvent("slider-keydown",this.__html.slider,"keydown",this.__onSliderKeyDown.bind(this)),this._bindEvent("slider-mousewheel",this.__html.slider,"mousewheel",this.__onSliderMouseWheel.bind(this)),this._bindEvent("slider-mousewheel-firefox",this.__html.slider,"DOMMouseScroll",this.__onSliderMouseWheel.bind(this)),this._bindEvent("field-contextmenu",this.__html.field,"contextmenu",this.__onFieldContextMenu.bind(this))},_min:0,_max:100,_decimalDigits:0,_fieldVisible:!0,isFieldVisible:function(){return this._fieldVisible},setFieldVisible:function(a){this._fieldVisible=a,a?(this.__html.field.style.display="",this.removeClass("photonui-slider-nofield")):(this.__html.field.style.display="none",this.addClass("photonui-slider-nofield"))},getHtml:function(){return setTimeout(function(){this.value=this.value}.bind(this),.01),this.__html.outer},setValue:function(a){this.$super(a);var b=a-this.min,c=this.max-this.min,d=Math.min(Math.max(b/c,0),1),e=this.__html.slider.offsetWidth-this.__html.grip.offsetWidth-4;this.__html.grip.style.left=Math.floor(d*e)+2+"px"},_buildHtml:function(){this.$super(),this.__html.outer=document.createElement("div"),this.__html.outer.className="photonui-widget photonui-slider",this.__html.slider=document.createElement("div"),this.__html.slider.className="photonui-slider-slider",this.__html.slider.tabIndex=0,this.__html.outer.appendChild(this.__html.slider),this.__html.grip=document.createElement("div"),this.__html.grip.className="photonui-slider-grip",this.__html.slider.appendChild(this.__html.grip),this.__html.outer.appendChild(this.__html.field)},_updateFromMouseEvent:function(a){var b=c.Helpers.getAbsolutePosition(this.__html.slider).x,d=this.__html.grip.offsetWidth,e=Math.round(a.pageX-b-d/2),f=this.__html.slider.offsetWidth-d-3,g=(this.max-this.min)*e/f+this.min;this.value=Math.round(g/this.step)*this.step,this._callCallbacks("value-changed",[this.value])},__onSliderMouseDown:function(a){this._updateFromMouseEvent(a),this._bindEvent("slider-mousemove",document,"mousemove",this.__onSliderMouseMove.bind(this)),this._bindEvent("slider-mouseup",document,"mouseup",this.__onSliderMouseUp.bind(this))},__onSliderMouseMove:function(a){this._updateFromMouseEvent(a)},__onSliderMouseUp:function(a){this._unbindEvent("slider-mousemove"),this._unbindEvent("slider-mouseup"),this._updateFromMouseEvent(a)},__onSliderKeyDown:function(a){38==a.keyCode||39==a.keyCode?(this.value+=this.step,this._callCallbacks("value-changed",[this.value])):(40==a.keyCode||37==a.keyCode)&&(this.value-=this.step,this._callCallbacks("value-changed",[this.value]))},__onSliderMouseWheel:function(a){var c=null;a.wheelDeltaY!=b&&(c=a.wheelDeltaY),a.wheelDelta!=b&&(c=a.wheelDelta),a.axis!=b&&a.detail!=b&&2==a.axis&&(c=-a.detail),null!=c&&(c>=0?this.value+=this.step:this.value-=this.step,a.preventDefault(),a.stopPropagation()),this._callCallbacks("value-changed",[this.value])},__onContextMenu:function(a){a.stopPropagation(),a.preventDefault(),this.contextMenuName&&this.contextMenu.popupXY(a.pageX,a.pageY)},__onFieldContextMenu:function(a){a.stopPropagation()}});var c=c||{};c.Button=c.Widget.$extend({__init__:function(a){this._registerWEvents(["click"]),this.$super(a),this._bindEvent("click",this.__html.button,"click",this.__onButtonClicked.bind(this)),this._updateProperties(["text","leftIconName","rightIconName"]),this._update()},_text:"Button",getText:function(){return this._text},setText:function(a){this._text=a,c.Helpers.cleanNode(this.__html.text),this.__html.text.appendChild(document.createTextNode(a))},_textVisible:!0,isTextVisible:function(){return this._textVisible},setTextVisible:function(a){this._textVisible=a,this._update()},_leftIconName:null,getLeftIconName:function(){return this._leftIconName},setLeftIconName:function(a){this._leftIconName=a,c.Helpers.cleanNode(this.__html.leftIcon),this._leftIconName&&(this.__html.leftIcon.appendChild(this.leftIcon.html),this.leftIconVisible=!0)},getLeftIcon:function(){return c.getWidget(this._leftIconName)},setLeftIcon:function(a){return a instanceof c.BaseIcon?void(this.leftIconName=a.name):void(this.leftIconName=null)},_leftIconVisible:!0,isLeftIconVisible:function(){return this._leftIconVisible},setLeftIconVisible:function(a){this._leftIconVisible=a,this._update()},_rightIconName:null,getRightIconName:function(){return this._rightIconName},setRightIconName:function(a){this._rightIconName=a,c.Helpers.cleanNode(this.__html.rightIcon),this._rightIconName&&(this.__html.rightIcon.appendChild(this.rightIcon.html),this.rightIconVisible=!0)},getRightIcon:function(){return c.getWidget(this._rightIconName)},setRightIcon:function(a){return a instanceof c.BaseIcon?void(this.rightIconName=a.name):void(this.rightIconName=null)},_rightIconVisible:!0,isRightIconVisible:function(){return this._rightIconVisible},setRightIconVisible:function(a){this._rightIconVisible=a,this._update()},_appearance:"normal",getAppearance:function(){return this._appearance},setAppearance:function(a){this._appearance=a,"flat"==a?this.addClass("photonui-button-appearance-flat"):this.removeClass("photonui-button-appearance-flat")},getHtml:function(){return this.__html.button},_update:function(){this.__html.leftIcon.parentNode==this.__html.button&&this.__html.button.removeChild(this.__html.leftIcon),this.__html.text.parentNode==this.__html.button&&this.__html.button.removeChild(this.__html.text),this.__html.rightIcon.parentNode==this.__html.button&&this.__html.button.removeChild(this.__html.rightIcon),this.leftIconName&&this.leftIconVisible&&this.__html.button.appendChild(this.__html.leftIcon),this.text&&this.textVisible&&this.__html.button.appendChild(this.__html.text),this.rightIconName&&this.rightIconVisible&&this.__html.button.appendChild(this.__html.rightIcon)},_buildHtml:function(){this.__html.button=document.createElement("button"),this.__html.button.className="photonui-widget photonui-button",this.__html.leftIcon=document.createElement("span"),this.__html.leftIcon.className="photonui-button-icon",this.__html.button.appendChild(this.__html.leftIcon),this.__html.text=document.createElement("span"),this.__html.text.className="photonui-button-text",this.__html.button.appendChild(this.__html.text),this.__html.rightIcon=document.createElement("span"),this.__html.rightIcon.className="photonui-button-icon",this.__html.button.appendChild(this.__html.rightIcon)},__onButtonClicked:function(a){this._callCallbacks("click",[a])}});var g={_text:c.Button.prototype._text,getText:c.Button.prototype.getText,setText:c.Button.prototype.setText,_textVisible:c.Button.prototype._textVisible,isTextVisible:c.Button.prototype.isTextVisible,setTextVisible:c.Button.prototype.setTextVisible,_leftIconName:c.Button.prototype._leftIconName,getLeftIconName:c.Button.prototype.getLeftIconName,setLeftIconName:c.Button.prototype.setLeftIconName,getLeftIcon:c.Button.prototype.getLeftIcon,setLeftIcon:c.Button.prototype.setLeftIcon,_leftIconVisible:c.Button.prototype._leftIconVisible,isLeftIconVisible:c.Button.prototype.isLeftIconVisible,setLeftIconVisible:c.Button.prototype.setLeftIconVisible,_rightIconName:c.Button.prototype._rightIconName,getRightIconName:c.Button.prototype.getRightIconName,setRightIconName:c.Button.prototype.setRightIconName,getRightIcon:c.Button.prototype.getRightIcon,setRightIcon:c.Button.prototype.setRightIcon,_rightIconVisible:c.Button.prototype._rightIconVisible,isRightIconVisible:c.Button.prototype.isRightIconVisible,setRightIconVisible:c.Button.prototype.setRightIconVisible,_appearance:c.Button.prototype._appearance,getAppearance:c.Button.prototype.getAppearance,setAppearance:c.Button.prototype.setAppearance,_update:c.Button.prototype._update,_buildButtonHtml:c.Button.prototype._buildHtml,__onButtonClicked:c.Button.prototype.__onButtonClicked},c=c||{};c.FluidLayout=c.Layout.$extend({_verticalSpacing:0,getVerticalSpacing:function(){return this._verticalSpacing},setVerticalSpacing:function(a){this._verticalSpacing=a,this._updateLayout()},_horizontalSpacing:2,getHorizontalSpacing:function(){return this._horizontalSpacing},setHorizontalSpacing:function(a){this._horizontalSpacing=a,this._updateLayout()},getHtml:function(){return this.__html.outerbox},_buildHtml:function(){this.__html.outerbox=document.createElement("div"),this.__html.outerbox.className="photonui-widget photonui-fluidlayout"},_updateLayout:function(){for(var a=this.children,b=document.createDocumentFragment(),d=null,e=0;e<a.length;e++)d=document.createElement("div"),d.className="photonui-container",d.style.padding="0 "+this.horizontalSpacing+"px "+this.verticalSpacing+"px 0",d.appendChild(a[e].html),b.appendChild(d);c.Helpers.cleanNode(this.__html.outerbox),this.__html.outerbox.appendChild(b)}});var c=c||{};c.PopupWindow=c.BaseWindow.$extend({__init__:function(a){this.$super(a),this._bindEvent("document-mousedown-close",document,"mousedown",this.hide.bind(this)),this._bindEvent("popup-click-close",this.html,"click",this.hide.bind(this)),this._bindEvent("mousedown-preventclose",this.html,"mousedown",function(a){a.stopPropagation()}.bind(this))},getContainerNode:function(){return this.__html.inner},popupXY:function(a,b){this.setPosition(-1337,-1337),this.show();var c=document.getElementsByTagName("body")[0].offsetWidth,d=document.getElementsByTagName("body")[0].offsetHeight,e=this.offsetWidth,f=this.offsetHeight;a+e>c&&(a=c-e),b+f>d&&(b-=f),0>a&&(a=0),0>b&&(b=0),this.setPosition(a,b)},popupWidget:function(a){this.setPosition(-1337,-1337),this.show();var b=document.getElementsByTagName("body")[0],c=0,d=0,e=a.absolutePosition,f=a.offsetHeight,g=a.offsetWidth,h=this.offsetWidth,i=this.offsetHeight;c=e.x+h<b.offsetWidth?e.x:e.x+g<b.offsetWidth?e.x+g-h:b.offsetWidth-h,e.y+f+i<b.offsetHeight?d=e.y+f+1:e.y-i>=0&&(d=e.y-i-1),0>c&&(c=0),0>d&&(d=0),this.setPosition(c,d)},_buildHtml:function(){this.$super(),this.__html.window.className+=" photonui-popupwindow",this.__html.inner=document.createElement("div"),this.__html.window.appendChild(this.__html.inner)}});var c=c||{},f=[];c.Dialog=c.Window.$extend({__init__:function(a){this._buttonsNames=[],this.$super(a)},_buttonsNames:[],getButtonsNames:function(){return this._buttonsNames},setButtonsNames:function(a){this._buttonsNames=a,this._updateButtons()},getButtons:function(){for(var a=[],b=0;b<this._buttonsNames.length;b++)a.push(c.getWidget(this._buttonsNames[b]));return a},setButtons:function(a){for(var b=[],d=0;d<a.length;d++)a[d]instanceof c.Widget&&b.push(a[d].name);this.buttonsNames=b},addButton:function(a){this._childrenNames.push(a.name),this._updateButtons()},removeButton:function(a){var b=this._buttonsNames.indexOf(a.name);b>=0&&this._buttonsNames.splice(a.name,1),this._updateButtons()},_updateButtons:function(){c.Helpers.cleanNode(this.__html.buttons);for(var a=this.buttons,b=a.length-1;b>=0;b--)this.__html.buttons.appendChild(a[b].html)},_buildHtml:function(){this.$super(),this.addClass("photonui-dialog"),this.__html.buttons=document.createElement("div"),this.__html.buttons.className="photonui-dialog-buttons",this.__html.window.appendChild(this.__html.buttons)}});var c=c||{};c.ColorPicker=c.Widget.$extend({__init__:function(a){this._registerWEvents(["value-changed"]),this._color=new c.Color,this.__buffH=document.createElement("canvas"),this.__buffH.width=200,this.__buffH.height=200,this.__buffSB=document.createElement("canvas"),this.__buffSB.width=100,this.__buffSB.height=100,this.__buffSBmask=document.createElement("canvas"),this.__buffSBmask.width=100,this.__buffSBmask.height=100,this.$super(a),this._updateH(),this._updateSB(),this._updateSBmask(),this._updateCanvas(),this._updateProperties(["color"]),this.__mouseManager=new c.MouseManager(this.__html.canvas),this.__mouseManager.registerCallback("click","mouse-move",this.__onMouseMove.bind(this)),this.__mouseManager.registerCallback("mouse-down","mouse-down",this.__onMouseDown.bind(this)),this.__mouseManager.registerCallback("drag-start","drag-start",this.__onDragStart.bind(this)),this._bindEvent("value-changed",this.__html.preview,"change",this.__onValueChanged.bind(this))},getValue:function(){return this.color.hexString},setValue:function(a){this.color.hexString=a,this._updateSB(),this._updateCanvas()},_color:null,getColor:function(){return this._color},setColor:function(a){a instanceof c.Color&&(this._color&&this._color.removeCallback("photonui.colorpicker.value-changed::"+this.name),this._color=a,this._color.registerCallback("photonui.colorpicker.value-changed::"+this.name,"value-changed",function(){this._updateSB(),this._updateCanvas()}.bind(this)),this._updateSB(),this._updateCanvas())},getHtml:function(){return this.__html.outer},__buffH:null,__buffSB:null,__mouseManager:null,__disableSBUpdate:!1,destroy:function(){this.__mouseManager.destroy(),this._color.removeCallback("photonui.colorpicker.value-changed::"+this.name),this.$super()},_buildHtml:function(){this.__html.outer=document.createElement("div"),this.__html.outer.className="photonui-widget photonui-colorpicker",this.__html.canvas=document.createElement("canvas"),this.__html.canvas.width=200,this.__html.canvas.height=200,this.__html.outer.appendChild(this.__html.canvas),this.__html.previewOuter=document.createElement("span"),this.__html.previewOuter.className="photonui-colorpicker-previewouter",this.__html.outer.appendChild(this.__html.previewOuter),this.__html.preview=document.createElement("input"),this.__html.preview.type="text",this.__html.preview.autocomplete="off",this.__html.preview.spellcheck=!1,this.__html.preview.className="photonui-colorpicker-preview",this.__html.previewOuter.appendChild(this.__html.preview)},_updateH:function(){var a=this.__buffH,b=a.getContext("2d"),d=new c.Color;b.clearRect(0,0,a.width,a.height);for(var e=0;360>e;e++)d.hue=360-e,b.beginPath(),b.fillStyle=d.hexString,b.arc(100,100,90,Math.PI*e/180,Math.PI*((e+2)%360)/180,!1),b.lineTo(100,100),b.fill();b.beginPath(),b.fillStyle="#000",b.arc(100,100,73,2*Math.PI,!1),b.globalCompositeOperation="destination-out",b.fill()},_updateSBmask:function(){var a=this.__buffSBmask,b=a.getContext("2d"),c=b.getImageData(0,0,a.width,a.height),d=0,e=0,f=0,g=0;for(f=0;100>f;f++)for(g=0;100>g;g++)d=400*f+4*g,e=(.5*(1-g/100)+.5)*(1-f/100)*255<<0,c.data[d+0]=e,c.data[d+1]=e,c.data[d+2]=e,c.data[d+3]=255*(1-g/100*(1-f/100))<<0;b.putImageData(c,0,0)},_updateSB:function(){if(!this.__disableSBUpdate){var a=this.__buffSB,b=a.getContext("2d"),d=new c.Color({hue:this.color.hue,saturation:100,brightness:100});b.save(),b.clearRect(0,0,a.width,a.height),b.fillStyle=d.hexString,b.rect(0,0,a.width,a.height),b.fill(),b.drawImage(this.__buffSBmask,0,0),b.restore()}},_updateCanvas:function(){var a=this.__html.canvas,b=a.getContext("2d");b.save(),b.clearRect(0,0,a.width,a.height),b.drawImage(this.__buffH,0,0),b.drawImage(this.__buffSB,50,50),b.strokeStyle="#fff",b.shadowColor="rgba(0, 0, 0, .7)",b.shadowBlur=3,b.lineWidth=2,b.beginPath(),b.arc(this.color.saturation+50,100-this.color.brightness+50,6,2*Math.PI,!1),b.stroke(),b.translate(100,100),b.rotate(-this.color.hue*Math.PI/180),b.beginPath(),b.arc(81,0,6,2*Math.PI,!1),b.stroke(),b.restore(),this.__html.preview.style.backgroundColor=this.color.rgbaString,this.__html.preview.value=this.color.hexString
},_pointerOnSquare:function(a){return a.x>=50&&a.x<=150&&a.y>=50&&a.y<=150},_pointerOnCircle:function(a){var b=Math.abs(100-a.x),c=Math.abs(100-a.y),d=Math.sqrt(b*b+c*c);return d>=74&&90>=d},_pointerAngle:function(a){var b=Math.abs(100-a.x),c=Math.abs(100-a.y),d=180*Math.atan(c/b)/Math.PI;return a.x<100&&a.y<100?d=180-d:a.x<100&&a.y>=100?d+=180:a.x>=100&&a.y>100&&(d=360-d),0|d},__onMouseMove:function(a,b){this.__html.canvas.style.cursor=this._pointerOnSquare(b)||this._pointerOnCircle(b)?"crosshair":"default"},__onMouseDown:function(a,b){this._pointerOnSquare(b)?(this.__disableSBUpdate=!0,this.color.saturation=b.x-50,this.color.brightness=150-b.y,this.__disableSBUpdate=!1,this._callCallbacks("value-changed",this.color)):this._pointerOnCircle(b)&&(this.color.hue=this._pointerAngle(b),this._callCallbacks("value-changed",this.color))},__onDragStart:function(a,b){this._pointerOnSquare(b)?(this.__disableSBUpdate=!0,this.__mouseManager.registerCallback("dragging","dragging",this.__onDraggingSquare.bind(this)),this.__mouseManager.registerCallback("drag-end","drag-end",this.__onDragEnd.bind(this))):this._pointerOnCircle(b)&&(this.__mouseManager.registerCallback("dragging","dragging",this.__onDraggingCircle.bind(this)),this.__mouseManager.registerCallback("drag-end","drag-end",this.__onDragEnd.bind(this)))},__onDraggingSquare:function(a,b){this.color.saturation=b.x-50,this.color.brightness=150-b.y,this._callCallbacks("value-changed",this.color)},__onDraggingCircle:function(a,b){this.color.hue=this._pointerAngle(b),this._callCallbacks("value-changed",this.color)},__onDragEnd:function(){this.__mouseManager.removeCallback("dragging"),this.__mouseManager.removeCallback("drag-end"),this.__disableSBUpdate=!1},__onValueChanged:function(){this.color.hexString=this.__html.preview.value,this.__html.preview.value=this.color.hexString,this._callCallbacks("value-changed",this.color)}});var c=c||{};c.BoxLayout=c.GridLayout.$extend({__init__:function(a){this.$super(a),this._updateProperties(["orientation"])},_orientation:"vertical",getOrientation:function(){return this._orientation},setOrientation:function(a){if("vertical"!=a&&"horizontal"!=a)throw'Error: The orientation should be "vertical" or "horizontal".';this._orientation=a,this.removeClass("photonui-layout-orientation-vertical"),this.removeClass("photonui-layout-orientation-horizontal"),this.addClass("photonui-layout-orientation-"+this.orientation),this._updateLayout()},_buildHtml:function(){this.$super(),this.__html.outerbox.className="photonui-widget photonui-boxlayout"},_updateLayout:function(){c.Helpers.cleanNode(this.__html.gridBody);var a=null;"horizontal"==this.getOrientation()&&(a=document.createElement("tr"),this.__html.gridBody.appendChild(a));for(var d=this.children,e=0;e<d.length;e++){"vertical"==this.getOrientation()&&(a=document.createElement("tr"),this.__html.gridBody.appendChild(a));var f=document.createElement("td");f.className="photonui-container photonui-boxlayout-cell",a.appendChild(f),(d[e].layoutOptions.horizontalExpansion==b||d[e].layoutOptions.horizontalExpansion)&&(f.className+=" photonui-container-expand-child-horizontal"),(d[e].layoutOptions.verticalExpansion==b||d[e].layoutOptions.verticalExpansion)&&(f.className+=" photonui-container-expand-child-vertical"),d[e].layoutOptions.width!=b&&(f.style.height=d[e].layoutOptions.width+"px"),d[e].layoutOptions.height!=b&&(f.style.height=d[e].layoutOptions.height+"px"),d[e].layoutOptions.minWidth!=b&&(f.style.minWidth=this.childrenWidgets[e].layoutOptions.minWidth+"px"),d[e].layoutOptions.minHeight!=b&&(f.style.minHeight=this.childrenWidgets[e].layoutOptions.minHeight+"px"),d[e].layoutOptions.maxWidth!=b&&(f.style.maxWidth=this.childrenWidgets[e].layoutOptions.maxWidth+"px"),d[e].layoutOptions.maxHeight!=b&&(f.style.maxHeight=this.childrenWidgets[e].layoutOptions.maxHeight+"px"),d[e].layoutOptions.horizontalAlign!=b&&(f.style.textAlign=this.childrenWidgets[e].layoutOptions.horizontalAlign,console.log("hhhh")),f.appendChild(d[e].html)}}});var c=c||{};c.Menu=c.Layout.$extend({__init__:function(a){this.$super(a),this._updateProperties(["iconVisible"])},_iconVisible:!0,isIconVisible:function(){return this._iconVisible},setIconVisible:function(a){this._iconVisible=a,a?this.removeClass("photonui-menu-noicon"):this.addClass("photonui-menu-noicon")},getHtml:function(){return this.__html.outer},_buildHtml:function(){this.__html.outer=document.createElement("div"),this.__html.outer.className="photonui-widget photonui-menu photonui-menu-style-default"},_updateLayout:function(){c.Helpers.cleanNode(this.__html.outer);for(var a=this.children,b=0;b<a.length;b++)this.__html.outer.appendChild(a[b].html)}});var c=c||{};c.MenuItem=c.Container.$extend({__init__:function(a){this._registerWEvents(["click"]),this.$super(a),this._updateProperties(["text","icon","active"]),this._bindEvent("click",this.__html.outer,"click",function(a){this._callCallbacks("click",[a])}.bind(this))},_value:"",getValue:function(){return this._value},setValue:function(a){this._value=a},_text:"Menu Item",getText:function(){return this._text},setText:function(a){this._text=a,c.Helpers.cleanNode(this.__html.text),this.__html.text.appendChild(document.createTextNode(a))},_iconName:null,getIconName:function(){return this._iconName},setIconName:function(a){this._iconName=a,c.Helpers.cleanNode(this.__html.icon),this._iconName&&this.__html.icon.appendChild(this.icon.html)},getIcon:function(){return c.getWidget(this._iconName)},setIcon:function(a){return a instanceof c.BaseIcon?void(this.iconName=a.name):void(this.iconName=null)},_active:!1,getActive:function(){return this._active},setActive:function(a){this._active=a,a?this.addClass("photonui-menuitem-active"):this.removeClass("photonui-menuitem-active")},getHtml:function(){return this.__html.outer},getContainerNode:function(){return this.__html.widget},_buildHtml:function(){this.__html.outer=document.createElement("div"),this.__html.outer.className="photonui-widget photonui-menuitem",this.__html.icon=document.createElement("span"),this.__html.icon.className="photonui-menuitem-icon",this.__html.outer.appendChild(this.__html.icon),this.__html.text=document.createElement("span"),this.__html.text.className="photonui-menuitem-text",this.__html.outer.appendChild(this.__html.text),this.__html.widget=document.createElement("span"),this.__html.widget.className="photonui-menuitem-widget",this.__html.outer.appendChild(this.__html.widget)}});var c=c||{};c.SubMenuItem=c.MenuItem.$extend({__init__:function(a){this.$super(a),this.addClass("photonui-submenuitem"),this.registerCallback("toggle-folding","click",this.__onItemClicked,this),this._updateProperties(["menuName"])},_menuName:null,getMenuName:function(){return this._menuName},setMenuName:function(a){this.menuName&&(this.menu.removeCallback("fold"),this.menu.removeCallback("unfold")),this._menuName=a,this.menuName&&(this.menu.registerCallback("fold","hide",this.__onToggleFold,this),this.menu.registerCallback("unfold","show",this.__onToggleFold,this),this.active=this.menu.visible)},getMenu:function(){return c.getWidget(this.menuName)},setMenu:function(a){this.menuName=a instanceof c.Menu?a.name:null},__onToggleFold:function(a){this.active=a.visible},__onItemClicked:function(){this.menu.visible=!this.menu.visible}});var c=c||{};c.ToggleButton=c.CheckBox.$extend({__init__:function(a){this._registerWEvents(["click"]),this.$super(a),this.__buttonInit(),this.removeClass("photonui-checkbox"),this.addClass("photonui-togglebutton")},__buttonInit:function(){this._bindEvent("click",this.__html.button,"click",this.__onButtonClicked.bind(this)),this._updateProperties(["text","leftIconName","rightIconName"]),this._update()},__include__:[g],_buildHtml:function(){this.$super(),this._buildButtonHtml(),this.__html.outer.appendChild(this.__html.button),this.__html.outer.removeChild(this.__html.span),this.__html.span=this.__html.button}});var c=c||{};c.PopupMenu=c.PopupWindow.$extend({__init__:function(a){this._childrenNames=[],this.$super(a)},__include__:[{getChildrenNames:c.Menu.prototype.getChildrenNames,setChildrenNames:c.Menu.prototype.setChildrenNames,getChildren:c.Menu.prototype.getChildren,setChildren:c.Menu.prototype.setChildren,getChildName:c.Menu.prototype.getChildName,setChildName:c.Menu.prototype.setChildName,getChild:c.Menu.prototype.getChild,setChild:c.Menu.prototype.setChild,isIconVisible:c.Menu.prototype.isIconVisible,setIconVisible:c.Menu.prototype.setIconVisible,addChild:c.Menu.prototype.addChild,removeChild:c.Menu.prototype.removeChild,destroy:c.Menu.prototype.destroy,_updateLayout:c.Menu.prototype._updateLayout}],_buildHtml:function(){this.$super(),c.Menu.prototype._buildHtml.call(this),this.__html.inner.appendChild(this.__html.outer),this.__html.window.className+=" photonui-popupmenu",this.__html.outer.className="photonui-widget photonui-menu photonui-menu-style-popupmenu"},__onLocaleChanged:function(){}});var c=c||{};c.Select=c.Widget.$extend({__init__:function(a){this.__popupMenu=new c.PopupMenu({maxHeight:300,className:"photonui-select-popup"}),this.__popupMenu.iconVisible=!1,this._registerWEvents(["value-changed"]),this.$super(a),this._updateProperties(["value"]),this._bindEvent("popup",this.html,"click",this.__onClick.bind(this)),this.setValue(a.value||this.value,!0)},_value:"",getValue:function(){return this._value},setValue:function(a,b){if(this.value!=a||b){for(var d=this.__popupMenu.children,e=0;e<d.length;e++)if(d[e]instanceof c.MenuItem&&d[e].value==a)return this._value=a,c.Helpers.cleanNode(this.__html.select),void this.__html.select.appendChild(d[e].html.cloneNode(!0));this._value="";var f=new c.MenuItem({text:this.placeholder,className:"photonui-select-placeholder"});c.Helpers.cleanNode(this.__html.select),this.__html.select.appendChild(f.html)}},_placeholder:a.Stone?a.Stone.lazyGettext("Select..."):"Select...",getPlaceholder:function(){return this._placeholder},setPlaceholder:function(a){this._placeholder=a},getChildren:function(){return this.__popupMenu.getChildren()},setChildren:function(a){this.__popupMenu.setChildren(a),this._updateItemsBinding()},getChildrenNames:function(){return this.__popupMenu.getChildrenNames()},setChildrenNames:function(a){this.__popupMenu.setChildrenNames(a),this._updateItemsBinding()},getPopupWidth:function(){return this.__popupMenu.getWidth()},setPopupWidth:function(a){this.__popupMenu.setWidth(a)},getPopupHeight:function(){return this.__popupMenu.getHeight()},setPopupHeight:function(a){this.__popupMenu.setHeight(a)},getPopupMaxWidth:function(){return this.__popupMenu.getMaxWidth()},setPopupMaxWidth:function(a){this.__popupMenu.setMaxWidth(a)},getPopupMinWidth:function(){return this.__popupMenu.getMinWidth()},setPopupMinWidth:function(a){this.__popupMenu.setMinWidth(a)},getPopupMaxHeight:function(){return this.__popupMenu.getMaxHeight()},setPopupMaxHeight:function(a){this.__popupMenu.setMaxHeight(a)},getPopupMinHeight:function(){return this.__popupMenu.getMinHeight()},setPopupMinHeight:function(a){this.__popupMenu.setMinHeight(a)},getPopupOffsetWidth:function(){return this.__popupMenu.getOffsetWidth()},getPopupOffsetHeight:function(){return this.__popupMenu.getOffsetHeight()},getPopupPadding:function(){return this.__popupMenu.getPadding()},setPopupPadding:function(a){this.__popupMenu.setPadding(a)},isIconVisible:function(){return this.__popupMenu.isIconVisible()},setIconVisible:function(a){this.__popupMenu.setIconVisible(a)},getHtml:function(){return this.__html.select},__popupMenu:null,addChild:function(a,b){this.__popupMenu.addChild(a,b),this._updateItemsBinding()},destroy:function(){this.__popupMenu.destroy(),this.$super()},_buildHtml:function(){this.__html.select=document.createElement("div"),this.__html.select.className="photonui-widget photonui-select",this.__html.select.tabIndex="0"},_updateItemsBinding:function(){for(var a=this.__popupMenu.children,b=0;b<a.length;b++)a[b]instanceof c.MenuItem&&a[b].registerCallback(this.name+"-click","click",this.__onItemClicked,this)},__onClick:function(){this.__popupMenu.popupWidget(this)},__onItemClicked:function(a){this.value=a.value,this._callCallbacks("value-changed",[this.value])}});var c=c||{};c.FontSelect=c.Select.$extend({__init__:function(a){this._fonts=[],this.$super(a),0==this.fonts.length&&(this.fonts=["sans-serif","serif","monospace"])},_fonts:null,getFonts:function(){return this._fonts},setFonts:function(a){this._fonts=[];for(var b=0;b<a.length;b++)this.addFont(a[b])},_value:"sans-serif",_placeholder:a.Stone?a.Stone.lazyGettext("Select a font..."):"Select a font...",addFont:function(a){var b=new c.MenuItem({value:a,text:a});b.html.style.fontFamily=a,this.addChild(b),this._fonts.push(a)}});var c=c||{};c.ColorPickerDialog=c.Dialog.$extend({__init__:function(a){this.__widgets={},this._color=new c.Color;var a=a||{};a.title==b&&(a.title=_("Select a color...")),this._registerWEvents(["value-changed"]),this.$super(a),this._buildUi(),this._updateProperties(["color"])},_color:null,getColor:function(){return this._color},setColor:function(a){a instanceof c.Color&&(this._color&&this._color.removeCallback("photonui.colorpickerdialog.value-changed::"+this.name),this._color=a,this._color.registerCallback("photonui.colorpickerdialog.value-changed::"+this.name,"value-changed",this.__onColorChanged,this)),this.__onColorChanged()},setVisible:function(a){this.$super(a),this._color&&a&&this.__widgets.labelRed&&this._updateUi()},destroy:function(){this._color.removeCallback("photonui.colorpickerdialog.value-changed::"+this.name),this.$super()},_buildUi:function(){this.__widgets.hbox=new c.BoxLayout({orientation:"horizontal"}),this.child=this.__widgets.hbox,this.__widgets.colorPicker=new c.ColorPicker,this.__widgets.hbox.addChild(this.__widgets.colorPicker),this.__widgets.colorPalette=new c.ColorPalette,this.__widgets.hbox.addChild(this.__widgets.colorPalette),this.__widgets.separator=new c.Separator({orientation:"vertical"}),this.__widgets.hbox.addChild(this.__widgets.separator),this.__widgets.grid=new c.GridLayout,this.__widgets.hbox.addChild(this.__widgets.grid),this.__widgets.fieldRed=new c.Slider({min:0,max:255,decimalDigits:0}),this.__widgets.labelRed=new c.Label({text:_("Red:"),forInput:this.__widgets.fieldRed}),this.__widgets.grid.addChild(this.__widgets.labelRed,{gridX:0,gridY:0,verticalExpansion:!1}),this.__widgets.grid.addChild(this.__widgets.fieldRed,{gridX:1,gridY:0,verticalExpansion:!1}),this.__widgets.fieldGreen=new c.Slider({min:0,max:255,decimalDigits:0}),this.__widgets.labelGreen=new c.Label({text:_("Green:"),forInput:this.__widgets.fieldGreen}),this.__widgets.grid.addChild(this.__widgets.labelGreen,{gridX:0,gridY:1,verticalExpansion:!1}),this.__widgets.grid.addChild(this.__widgets.fieldGreen,{gridX:1,gridY:1,verticalExpansion:!1}),this.__widgets.fieldBlue=new c.Slider({min:0,max:255,decimalDigits:0}),this.__widgets.labelBlue=new c.Label({text:_("Blue:"),forInput:this.__widgets.fieldBlue}),this.__widgets.grid.addChild(this.__widgets.labelBlue,{gridX:0,gridY:2,verticalExpansion:!1}),this.__widgets.grid.addChild(this.__widgets.fieldBlue,{gridX:1,gridY:2,verticalExpansion:!1}),this.__widgets.separator2=new c.Separator,this.__widgets.grid.addChild(this.__widgets.separator2,{gridX:0,gridY:3,verticalExpansion:!1,gridWidth:2}),this.__widgets.fieldHue=new c.Slider({min:0,max:360,decimalDigits:0}),this.__widgets.labelHue=new c.Label({text:_("Hue:"),forInput:this.__widgets.fieldHue}),this.__widgets.grid.addChild(this.__widgets.labelHue,{gridX:0,gridY:4,verticalExpansion:!1}),this.__widgets.grid.addChild(this.__widgets.fieldHue,{gridX:1,gridY:4,verticalExpansion:!1}),this.__widgets.fieldSaturation=new c.Slider({min:0,max:100,decimalDigits:0}),this.__widgets.labelSaturation=new c.Label({text:_("Saturation:"),forInput:this.__widgets.fieldSaturation}),this.__widgets.grid.addChild(this.__widgets.labelSaturation,{gridX:0,gridY:5,verticalExpansion:!1}),this.__widgets.grid.addChild(this.__widgets.fieldSaturation,{gridX:1,gridY:5,verticalExpansion:!1}),this.__widgets.fieldBrightness=new c.Slider({min:0,max:100,decimalDigits:0}),this.__widgets.labelBrightness=new c.Label({text:_("Brightness:"),forInput:this.__widgets.fieldBrightness}),this.__widgets.grid.addChild(this.__widgets.labelBrightness,{gridX:0,gridY:6,verticalExpansion:!1}),this.__widgets.grid.addChild(this.__widgets.fieldBrightness,{gridX:1,gridY:6,verticalExpansion:!1}),this.__widgets.buttonOk=new c.Button({text:_("Ok")}),c.FAIcon&&(this.__widgets.buttonOk.leftIcon=new c.FAIcon("fa-check")),this.__widgets.buttonCancel=new c.Button({text:_("Cancel")}),this.buttons=[this.__widgets.buttonOk,this.__widgets.buttonCancel],c.FAIcon&&(this.__widgets.buttonCancel.leftIcon=new c.FAIcon("fa-times")),this.__widgets.colorPalette.color=this.__widgets.colorPicker.color,this.__widgets.colorPicker.color.registerCallback("colorpickerdialog.colorPicker.value-changed","value-changed",this._updateUi,this),this.__widgets.fieldRed.registerCallback("colorpickerdialog.fieldRed.value-changed","value-changed",function(a,b){this.__widgets.colorPicker.color.red=b},this),this.__widgets.fieldGreen.registerCallback("colorpickerdialog.fieldGreen.value-changed","value-changed",function(a,b){this.__widgets.colorPicker.color.green=b},this),this.__widgets.fieldBlue.registerCallback("colorpickerdialog.fieldBlue.value-changed","value-changed",function(a,b){this.__widgets.colorPicker.color.blue=b},this),this.__widgets.fieldHue.registerCallback("colorpickerdialog.fieldHue.value-changed","value-changed",function(a,b){this.__widgets.colorPicker.color.hue=b},this),this.__widgets.fieldSaturation.registerCallback("colorpickerdialog.fieldSaturation.value-changed","value-changed",function(a,b){this.__widgets.colorPicker.color.saturation=b},this),this.__widgets.fieldBrightness.registerCallback("colorpickerdialog.fieldBrightness.value-changed","value-changed",function(a,b){this.__widgets.colorPicker.color.brightness=b},this),this.__widgets.buttonOk.registerCallback("colorpickerdialog.buttonOk.click","click",this.__onValidate,this),this.__widgets.buttonCancel.registerCallback("colorpickerdialog.buttonCancel.click","click",this.__onCancel,this),this.registerCallback("colorpickerdialog.close","close-button-clicked",this.__onCancel,this)},_updateUi:function(a){var a=a||this.color;this.__widgets.fieldRed.value=a.red,this.__widgets.fieldGreen.value=a.green,this.__widgets.fieldBlue.value=a.blue,this.__widgets.fieldHue.value=a.hue,this.__widgets.fieldSaturation.value=a.saturation,this.__widgets.fieldBrightness.value=a.brightness},__onCancel:function(){this.__widgets.colorPicker.color.setHSB(this._color.hue,this._color.saturation,this._color.brightness),this.hide()},__onValidate:function(){this._color.setHSB(this.__widgets.colorPicker.color.hue,this.__widgets.colorPicker.color.saturation,this.__widgets.colorPicker.color.brightness),this.hide(),this._callCallbacks("value-changed",[this.color])},__onColorChanged:function(){this.__widgets.colorPicker.color.setHSB(this._color.hue,this._color.saturation,this._color.brightness)}});var c=c||{};return c.ColorButton=c.Button.$extend({__init__:function(a){this.__widgets={},this._color=new c.Color,this._registerWEvents(["value-changed"]),this.$super(a),this._buildUi(),this._updateProperties(["color"])},getValue:function(){return this.color.hexString},setValue:function(a){this.color.hexString=a},_color:null,getColor:function(){return this._color},setColor:function(a){a instanceof c.Color&&(this._color&&this._color.removeCallback("photonui.colorbutton.value-changed::"+this.name),this._color=a,this._color.registerCallback("photonui.colorbutton.value-changed::"+this.name,"value-changed",this.__onColorChanged,this)),this.__onColorChanged(),a instanceof c.Color&&(this._color=a)},_dialogOnly:!1,isDialogOnly:function(){return this._dialogOnly},setDialogOnly:function(a){this._dialogOnly=!!a},destroy:function(){this._color.removeCallback("photonui.colorbutton.value-changed::"+this.name),this.$super()},_update:function(){},_buildHtml:function(){this.$super(),this.__html.button=document.createElement("button"),this.__html.button.className="photonui-widget photonui-button",this.__html.button.className+=" photonui-colorbutton",this.__html.color=document.createElement("span"),this.__html.button.appendChild(this.__html.color)},_buildUi:function(){this.__widgets.popup=new c.PopupWindow,this.__widgets.vbox=new c.BoxLayout({verticalSpacing:0,horizontalSpacing:0}),this.__widgets.popup.child=this.__widgets.vbox,this.__widgets.palette=new c.ColorPalette,this.__widgets.vbox.addChild(this.__widgets.palette),this.__widgets.custom=new c.Button({text:_("Custom color..."),appearance:"flat"}),this.__widgets.custom.addClass("photonui-colorbutton-custombutton"),this.__widgets.vbox.addChild(this.__widgets.custom),this.__widgets.colorPickerDialog=new c.ColorPickerDialog,this.__widgets.palette.registerCallback("value-changed","value-changed",this.__onValueChanged,this),this.__widgets.colorPickerDialog.registerCallback("value-changed","value-changed",this.__onValueChanged,this),this.__widgets.custom.registerCallback("click","click",this.__onCustomButtonClicked,this),this.__widgets.palette.color=this.color,this.__widgets.colorPickerDialog.color=this.color},__onButtonClicked:function(a){this._callCallbacks("click",[a]),this.dialogOnly?(this.__widgets.colorPickerDialog.show(),this.__widgets.colorPickerDialog.center()):this.__widgets.popup.popupWidget(this)},__onValueChanged:function(){this._callCallbacks("value-changed",[this.color])},__onColorChanged:function(){this.__html.color.style.backgroundColor=this.color.hexString},__onCustomButtonClicked:function(){this.__widgets.colorPickerDialog.show(),this.__widgets.colorPickerDialog.center()}}),c}(window),GeometryHelper=new function(){this.createHandle=function(a,b,c,d,e){var f,d=d||{};if(d.hinge||1,1==a){var g=b,h=c,i=BABYLON.Mesh.CreateBloc("handle",h,h,4,e);i.position.y=g/2-(d.offset>=0?d.offset:2);var j=BABYLON.Mesh.CreateBloc("handle",h,g,h,e);j.position.z=2;var k=BABYLON.Mesh.CreateBloc("handle",h,h,4,e);k.position.y=-g/2+(d.offset>=0?d.offset:2),f=BABYLON.Mesh.mergeMeshesRec("handle",[i,j,k],e),f.position.z=0,f.rotation.z=Math.PI/2}else if(2==a)f=BABYLON.Mesh.CreateBloc("handle",b,c,3,e);else if(3==a)f=BABYLON.Mesh.CreateBloc("handle",b,1,c,e),f.rotation.x=Math.PI/8;else if(4==a)f=BABYLON.Mesh.CreateCylinder("handle",b,c,3,6,1,!0,e),f.rotation.x=Math.PI/2;else if(5==a)f=this.createCurvedBarGeometry("handle",b,c,1,5,10,e);else if(6==a)d.offset=c/2,f=this.createHandle(1,b,c,d,e);else if(7==a){d.offset=c/2,f=this.createHandle(1,b,c,d,e);var l=BABYLON.Mesh.CreateBloc("handle_deco",c,b+3,.3,e),m=BABYLON.Mesh.CreateBloc("handle_deco",c,b+3,.3,e);l.position.x+=c/2,m.position.x-=c/2,l.position.z=2,l.rotation.y=-Math.PI/10,m.rotation.y=Math.PI/10,m.position.z=2,l.parent=m.parent=f}else if(8==a){var g=b,h=c,i=BABYLON.Mesh.CreateBloc("handle",h,h,4,e);i.position.y=g/2-(d.offset>=0?d.offset:2);var j=BABYLON.Mesh.CreateCylinder("handle",g,2*h,2*h,10,1,!0,e);j.position.z=2;var k=BABYLON.Mesh.CreateCylinder("handle",h,h,4,6,1,!0,e);k.position.y=-g/2+(d.offset>=0?d.offset:2);var k=BABYLON.Mesh.CreateBloc("handle",h,h,4,e);k.position.y=-g/2+(d.offset>=0?d.offset:2),f=BABYLON.Mesh.mergeMeshesRec("handle",[i,j,k],e),f.position.z=0,f.rotation.z=Math.PI/2}else f=BABYLON.Mesh.CreateBloc("handle",3,3,3,e);return f},this.createPoignee=function(a,b,c,d,e){var d=d||{},f=(d.hinge||1,null);if(1==a){var g=b-10,h=1,i=BABYLON.Mesh.CreateBloc("handle",h,h,4,e);i.position.y=g/2-2;var j=BABYLON.Mesh.CreateBloc("handle",h,g,h,e);j.position.z=3;var k=BABYLON.Mesh.CreateBloc("handle",h,h,4,e);k.position.y=-g/2+2,f=BABYLON.Mesh.mergeMeshesRec("handle",[i,j,k],e),f.position.z=0,f.rotation.z=Math.PI/2}else 2==a?f=BABYLON.Mesh.CreateBloc("handle",3,3,3,e):3==a?f=BABYLON.Mesh.CreateBloc("handle",b-10,1,5,e):4==a?(f=BABYLON.Mesh.CreateCylinder("handle",3,3,3,8,1,!0,e),f.rotation.x=Math.PI/2):5==a?(f=this.createPoignee(1,25,null,null,e),f.position.y+=c/2-10):6==a&&(f=this.createPoignee(1,25,null,null,e),f.position.y+=c/2-10);return f},this.createTiroir=function(a,b,c,d,e,f,g){var f=f||{};f.stretched_texture=f.stretched_texture||0;var h=3,i=f.rounded&&(+f.configuration[3]||+f.configuration[0])?f.radius:h,j=[],k=BABYLON.Mesh.CreateBloc("back",a-h,c/2,h,g);k.position.z=-b/2,k.position.y=-c/4+i,j.push(k);var l=BABYLON.Mesh.CreateBloc("left",h,c/2,b,g);l.position.x=-a/2+h,l.position.y=-c/4+i,j.push(l);var m=BABYLON.Mesh.CreateBloc("right",h,c/2,b,g);if(m.position.x=a/2-h,m.position.y=-c/4+i,j.push(m),f.rounded){var n=this.createRoundedPane(a,c,d,f.radius,null,f.configuration,g);n.name="front",n.position.z=d/2}else{var n=BABYLON.Mesh.CreateBloc("front",a,c,d,g);0!==f.stretched_texture&&this.setStretchUV(n)}n.position.z+=b/2,j.push(n);var o=BABYLON.Mesh.CreateBloc("bottom",a-2*h,h,b,g);o.position.y-=c/2-i,j.push(o);var p=BABYLON.Mesh.mergeMeshesRec("tiroir",j,g);if(-1!==+f.handle_position){var e=e.toString(),q=f.handle_position.split(",")[0]||0,r=f.handle_position.split(",")[1]||0,s=f.handle_position.split(",")[2]||0;s=s/180*Math.PI;var e=e.toString()||e,t=e.split(",")[0]||0,u=e.split(",")[1]||a-10,v=e.split(",")[2]||1;u=this.calcMeasure(u,a,c),v=this.calcMeasure(v,a,c),q=this.calcMeasure(q,a,c),r=this.calcMeasure(r,a,c);var w=this.createHandle(t,u,v,{hinge:1},g);w.position.x=q,w.position.y=r,w.position.z+=b/2+d/2,w.rotation.z+=s,w.parent=p}else{var w=this.createPoignee(e,a,c,{hinge:-1},g);w&&(w.position.z+=b/2+d/2,w.position.y=c/2-5,3==e&&(w.rotation.x=Math.PI/8),5==e&&(w.rotation.z=Math.PI/2),w.parent=p)}return 0==f.stretched_texture&&GeometryHelper.giftWraper(p),p},this.calcMeasure=function(measure,w,h){var reg=new RegExp("[^wh0-9?:<>()\\-\\+*/]");return reg.test(measure)===!1?eval(measure):measure},this.setStretchUV=function(a){var b=[];b.push(1,0),b.push(0,0),b.push(0,1),b.push(1,1),b.push(1,1),b.push(0,1),b.push(0,0),b.push(1,0),b.push(1,0),b.push(0,0),b.push(0,0),b.push(1,0),b.push(1,0),b.push(0,0),b.push(0,0),b.push(1,0),b.push(1,0),b.push(0,0),b.push(0,0),b.push(1,0),b.push(1,0),b.push(0,0),b.push(0,0),b.push(1,0),a.setVerticesData(BABYLON.VertexBuffer.UVKind,b)},this.createSimplePorte=function(a,b,c,d,e,f,g){var c=c||3,h=new BABYLON.Mesh("door",g);h.isVisible=!1;var f=f||{};if(f.stretched_texture=f.stretched_texture||0,f.handle_position=f.handle_position||-1,f.rounded){var i=this.createRoundedPane(a,b,c,f.radius,null,f.configuration,g);i.name="casement",i.position.z=c/2}else{var i=BABYLON.Mesh.CreateBloc("casement",a,b,c,g);0!==f.stretched_texture&&this.setStretchUV(i)}if(i.parent=h,1==d||-1==d)h.setPivotMatrix(BABYLON.Matrix.Translation(d*a/2,0,c/2)),h.position.x=-d*a/2;else{var j=-2*-d+5;h.setPivotMatrix(BABYLON.Matrix.Translation(0,j*b/2,c/2)),h.position.y=-j*b/2}if(h.hinge=d,-1!==+f.handle_position){var k=f.handle_position.split(",")[0]||0,l=f.handle_position.split(",")[1]||0,m=f.handle_position.split(",")[2]||0;m=m/180*Math.PI;var e=e.toString()||e,n=e.split(",")[0]||0,o=e.split(",")[1]||a-10,p=e.split(",")[2]||1;o=this.calcMeasure(o,a,b),p=this.calcMeasure(p,a,b),k=this.calcMeasure(k,a,b),l=this.calcMeasure(l,a,b),k=-1==d?-k:k;var q=this.createHandle(n,o,p,{hinge:d},g);q.position.x=k,q.position.y=l,q.position.z+=c/2,q.rotation.z+=m,q.parent=h}else if(1!=d&&-1!=d||6==e){if(6!=e){var j=-2*-d+5,q=this.createPoignee(e,a,a,{hinge:d},g);q&&(q.position.y=j*b/3,q.position.z+=c/2,3==e&&(q.rotation.x=j*Math.PI/8),q.parent=h)}else if(6==e){var q=this.createPoignee(e,a,a,{hinge:d},g);q.position.y=b/3,q&&(q.position.z+=c/2,q.parent=h)}}else{var q=this.createPoignee(e,b,b,{hinge:d},g);q&&(q.rotation.z+=Math.PI/2,q.position.x=d*a/3,q.position.z+=c/2,3==e&&(q.rotation.y=-d*Math.PI/8),4==e&&(q.rotation.z=0),q.parent=h)}return 0==f.stretched_texture&&this.giftWraper(i,128),h},this.createCurvedBarGeometry=function(a,b,c,d,e,f,g){var h=[],i=i||!1,j=[],k=[],l=[],f=f||10,e=e,m=-d/2,n=+d/2,o=new BABYLON.Vector3(-b/2,0,m),p=new BABYLON.Vector3(b/2,0,m),q=new BABYLON.Vector3(0,0,m+e);h.push(o.x,o.y,o.z),GeometryHelper.generateArc(h,f,o,q,p),h.push(p.x,p.y,p.z);var r=new BABYLON.Vector3(-b/2,c,m),s=new BABYLON.Vector3(b/2,c,m),t=new BABYLON.Vector3(0,c,m+e);h.push(r.x,r.y,r.z),GeometryHelper.generateArc(h,f,r,t,s),h.push(s.x,s.y,s.z);var r=new BABYLON.Vector3(-b/2,c,n),s=new BABYLON.Vector3(b/2,c,n),t=new BABYLON.Vector3(0,c,n+e);h.push(r.x,r.y,r.z),GeometryHelper.generateArc(h,f,r,t,s),h.push(s.x,s.y,s.z);var o=new BABYLON.Vector3(-b/2,0,n),p=new BABYLON.Vector3(b/2,0,n),q=new BABYLON.Vector3(0,0,n+e);h.push(o.x,o.y,o.z),GeometryHelper.generateArc(h,f,o,q,p),h.push(p.x,p.y,p.z);for(var u=f+1,v=0,w=4,x=0;w-1>x;x++){v=x*u;for(var y=0;u-1>y;y++)j.push(v+y,v+y+1,v+u+y+1),j.push(v+u+y+1,v+u+y,v+y)}var z=new BABYLON.Mesh(a,g);return BABYLON.VertexData.ComputeNormals(h,j,k),l=BABYLON.Tools.PlaneUVProjection(h,new BABYLON.Vector3(1,0,0),new BABYLON.Vector3(0,1,0),0),z.setVerticesData(BABYLON.VertexBuffer.PositionKind,h,i),z.setVerticesData(BABYLON.VertexBuffer.NormalKind,k,i),z.setVerticesData(BABYLON.VertexBuffer.UVKind,l,i),z.setIndices(j),z},this.createDoublePorte=function(a,b,c,d,e,f){var g=new BABYLON.Mesh("dblPorte",f);g.isVisible=!1;var c=c||3,e=e||{};if(e.rounded){var h=ujs.cloneObject(e),i=ujs.cloneObject(e);h.configuration[3]=0,h.configuration[2]=0,i.configuration[1]=0,i.configuration[0]=0;var j=this.createSimplePorte(a/2,b,c,1,d,h,f),k=this.createSimplePorte(a/2,b,c,-1,d,i,f)}else var j=this.createSimplePorte(a/2,b,c,1,d,e,f),k=this.createSimplePorte(a/2,b,c,-1,d,e,f);return j.position.x+=-a/4-.1,j.hinge=1,k.position.x+=a/4+.1,k.hinge=-1,j.setPivotMatrix(BABYLON.Matrix.Translation(a/4+.1,0,c/2)),k.setPivotMatrix(BABYLON.Matrix.Translation(-a/4-.1,0,c/2)),j.parent=g,k.parent=g,g},this.createRoundedCadreStrate=function(a,b,c,d,e,f,g){var g=g||[1,1,1,1],h=1==g[3]?e:1,i=1==g[2]?e:1,j=1==g[1]?e:1,k=1==g[0]?e:1,l=new BABYLON.Vector3(b/2-h,-c/2,d),m=new BABYLON.Vector3(b/2,-c/2+h,d),n=new BABYLON.Vector3(b/2,c/2-i,d),o=new BABYLON.Vector3(b/2-i,c/2,d),p=new BABYLON.Vector3(-b/2+j,c/2,d),q=new BABYLON.Vector3(-b/2,c/2-j,d),r=new BABYLON.Vector3(-b/2,-c/2+k,d),s=new BABYLON.Vector3(-b/2+k,-c/2,d),t=new BABYLON.Vector3(b/2,-c/2,d),u=new BABYLON.Vector3(b/2,c/2,d),v=new BABYLON.Vector3(-b/2,c/2,d),w=new BABYLON.Vector3(-b/2,-c/2,d);return a.push(s.x,s.y,s.z),this.generateArc(a,f,s,w,r),a.push(r.x,r.y,r.z),a.push(q.x,q.y,q.z),this.generateArc(a,f,q,v,p),a.push(p.x,p.y,p.z),a.push(o.x,o.y,o.z),this.generateArc(a,f,o,u,n),a.push(n.x,n.y,n.z),a.push(m.x,m.y,m.z),this.generateArc(a,f,m,t,l),a.push(l.x,l.y,l.z),a},this.triangulateStrate=function(a,b){for(var c=[],d=a+1;a+b-1>d;d++)c.push(d+1,d,a);return c},this.generateStrateFacesForGeometry=function(a,b,c,d,e,f,g,h){for(var i=i||!1,j=[],k=[],l=[],g=g||[],d=d||!1,e=e||!1,m=b.length/(3*c),n=0,o=new BABYLON.Mesh(a,f),p=0,q=b.slice(0,3*(c-1)),r=this.triangulateStrate(0,c),s=0,t=3;t<q.length;t+=3)s+=new BABYLON.Vector3(q[t],q[t+1],q[t+2]).distanceTo(new BABYLON.Vector3(q[t-3],q[t-2],q[t-1]));s+=new BABYLON.Vector3(q[t-3],q[t-2],q[t-1]).distanceTo(new BABYLON.Vector3(q[0],q[1],q[2]));var u=BABYLON.BoundingBox.CreateFromData(b);if(u.maximum.z-u.minimum.z,d)for(var t=0;t<r.length;t+=3)j.push(r[t],r[t+1],r[t+2]);for(var v,w,x,y,z,A,B=0,C=[],D=!1,E=0;m-1>E;E++){n=E*c,p=j.length,B=0,D=!1;for(var F=0;F<g.length;F++)g[F]===E&&(D=!0);for(var t=0;c-1>t;t++){v=n+t,w=n+1+t,x=n+c+t+1,y=n+c+t+1,z=n+c+t,A=n+t,j.push(v,w,x),j.push(y,z,A),D&&C.push(v,w,x,y,z,A);var G=new BABYLON.Vector3(b[v],b[v+1],b[v+2]).distanceTo(new BABYLON.Vector3(b[w],b[w+1],b[w+2]));B+=G}j.push(n+t,n,n+c),j.push(n+c,n+c+t,n+t),D&&(C.push(n+t,n,n+c),C.push(n+c,n+c+t,n+t))}if(e)for(var H=b.length/3-c,I=(b.slice(3*H,b.length),this.triangulateStrate(H,c)),t=0;t<I.length;t+=3)h?j.push(I[t+2],I[t+1],I[t]):j.push(I[t],I[t+1],I[t+2]);return BABYLON.VertexData.ComputeNormals(b,j,k),d&&BABYLON.Mesh.ComputeFaceNormal(b,k,r),e&&!h&&BABYLON.Mesh.ComputeFaceNormal(b,k,I),BABYLON.Mesh.ComputeFaceNormal(b,k,C),l=BABYLON.Tools.PlaneUVProjection(b,new BABYLON.Vector3(1,0,0),new BABYLON.Vector3(0,0,1)),o.setVerticesData(BABYLON.VertexBuffer.PositionKind,b,i),o.setVerticesData(BABYLON.VertexBuffer.NormalKind,k,i),o.setVerticesData(BABYLON.VertexBuffer.UVKind,l,i),o.setIndices(j),o
},this.createRoundedPane=function(a,b,c,d,e,f,g){var h=[],e=e||6,d=d||20,f=f||[1,1,1,1];this.createRoundedCadreStrate(h,a,b,-c,d,e,f),this.createRoundedCadreStrate(h,a,b,-c,d,e,f),this.createRoundedCadreStrate(h,a,b,0,d,e,f),this.createRoundedCadreStrate(h,a,b,0,d,e,f);var i=8+4*(e-1);return this.generateStrateFacesForGeometry("pane",h,i,!0,!0,g,void 0,!0)},this.createRoundedCadre=function(a,b,c,d,e,f,g){var h=[],i=f.nbseg||6,j=f.radius||20,e=e||[1,1,1,1];this.createRoundedCadreStrate(h,a,b,-d/2,j,i,e),this.createRoundedCadreStrate(h,a,b,d/2,j,i,e),this.createRoundedCadreStrate(h,a,b,d/2,j,i,e),this.createRoundedCadreStrate(h,a-2*c,b-2*c,d/2,j,i,e),this.createRoundedCadreStrate(h,a-2*c,b-2*c,d/2,j,i,e),this.createRoundedCadreStrate(h,a-2*c,b-2*c,-d/2,j,i,e);var k=4*(i+1),l=this.generateStrateFacesForGeometry("cadre",h,k,!1,!1,g,[2]);return this.giftWraper(l,128,!0),l},this.giftWraper=function(a,b,c){if(b=b||128,a&&a.getTotalVertices()){for(var d,e,f,g,h=a.getIndices(),i=a.getVerticesData(BABYLON.VertexBuffer.PositionKind),j=a.getVerticesData(BABYLON.VertexBuffer.NormalKind),k=!1,l=new Array(i.length/3),m=a.scaling.asArray(),n=new BABYLON.Vector3,o=new BABYLON.Vector3,p=new BABYLON.Vector3,q=new Array(i.length/3*2),g=q.length;g--;)q[g]=0;for(var r=0;r<h.length;r+=3)if(BABYLON.Vector3.FromArrayToRef(i,3*h[r],n),BABYLON.Vector3.FromArrayToRef(i,3*h[r+1],o),BABYLON.Vector3.FromArrayToRef(i,3*h[r+2],p),o.subtractInPlace(n),p.subtractInPlace(n),o.multiplyInPlace(a.scaling),p.multiplyInPlace(a.scaling),BABYLON.Vector3.CrossToRef(o,p,n),n.multiplyInPlace(n),!(n.x<1e-4&&n.y<1e-4&&n.z<1e-4))for(n.x>n.y&&n.x>n.z?(d=2,e=1,f=0):n.y>n.x&&n.y>n.z?(d=0,e=2,f=1):(d=0,e=1,f=2),g=0;3>g;g++){if("undefined"!=typeof l[h[r+g]]){if(!c||l[h[r+g]]==f)continue;k=!0,i.push(i[3*h[r+g]],i[3*h[r+g]+1],i[3*h[r+g]+2]),j.push(j[3*h[r+g]],j[3*h[r+g]+1],j[3*h[r+g]+2]),h[r+g]=i.length/3-1}l[h[r+g]]=f,q[2*h[r+g]]=i[3*h[r+g]+d]*m[d]/b,q[2*h[r+g]+1]=i[3*h[r+g]+e]*m[e]/b}return a.setVerticesData(BABYLON.VertexBuffer.UVKind,q),k&&(a.setVerticesData(BABYLON.VertexBuffer.NormalKind,j),a.setVerticesData(BABYLON.VertexBuffer.PositionKind,i),a.setIndices(h)),a}},this.createCadre=function(a,b,c,d,e,f,g){var f=f||{},e=e||[1,1,1,1];if(f.rounded&&f.radius>0)return this.createRoundedCadre(a,b,c,d,e,f,g);var h=new BABYLON.Mesh("cadre",g);if(h.isVisible=!1,0==c){var i=BABYLON.Mesh.CreateBloc("cadreHaut",a,.1,d,g),j=BABYLON.Mesh.CreateBloc("cadreGauche",.1,b,d,g);c=.1}else if(0==d)var i=BABYLON.Mesh.CreatePlane("cadreHaut",a,c,g),j=BABYLON.Mesh.CreatePlane("cadreGauche",c,b-2*c,g);else var i=BABYLON.Mesh.CreateBloc("CadreHaut",a,c,d,g),j=BABYLON.Mesh.CreateBloc("CadreGauche",c,b-2*c,d,g);if(i.parent=h,j.parent=h,1==e[2]){var k=j.duplicate("cadreDroit",h,!0);k.position.x=-a/2+c/2,k.parent=h}if(1==e[3]){var l=i.duplicate("cadreBas",h,!0);l.position.y=-b/2+c/2,l.parent=h}return 1==e[0]?i.position.y=b/2-c/2:i.dispose(),1==e[1]?j.position.x=a/2-c/2:j.dispose(),h=BABYLON.Mesh.mergeMeshesRec("cadre",[h],g),this.giftWraper(h,128),h},this.generateArc=function(a,b,c,d,e){for(var f=1;b>f;f++){var g=c.add(d.subtract(c).scale(f/b)),h=d.add(e.subtract(d).scale(f/b)),i=g.add(h.subtract(g).scale(f/b));a.push(i.x,i.y,i.z)}},this.generateArcPoints=function(a,b,c,d,e){for(var f=1;b>f;f++){var g=c.add(d.subtract(c).scale(f/b)),h=d.add(e.subtract(d).scale(f/b)),i=g.add(h.subtract(g).scale(f/b));a.push(i)}},this.generateVasqueStrate=function(a,b,c,d,e,f,g,h,i){var g=g||3,h=h||f,i=i||f;a.push(-c/2+h,e,d/2),a.push(c/2-h,e,d/2),this.generateArc(a,g,new BABYLON.Vector3(c/2-h,e,d/2),new BABYLON.Vector3(c/2,e,d/2),new BABYLON.Vector3(c/2,e,d/2-i)),a.push(c/2,e,d/2-i),a.push(c/2,e,-d/2+i),this.generateArc(a,g,new BABYLON.Vector3(c/2,e,-d/2+i),new BABYLON.Vector3(c/2,e,-d/2),new BABYLON.Vector3(c/2-h,e,-d/2)),a.push(c/2-h,e,-d/2),a.push(-c/2+h,e,-d/2),this.generateArc(a,g,new BABYLON.Vector3(-c/2+h,e,-d/2),new BABYLON.Vector3(-c/2,e,-d/2),new BABYLON.Vector3(-c/2,e,-d/2+i)),a.push(-c/2,e,-d/2+i),a.push(-c/2,e,+d/2-i),this.generateArc(a,g,new BABYLON.Vector3(-c/2,e,+d/2-i),new BABYLON.Vector3(-c/2,e,d/2),new BABYLON.Vector3(-c/2+h,e,d/2))},this.createVasqueGeometry=function(a,b,c){for(var d=[],b=b||{},e=b.height||35,f=b.bottomL||140,g=b.topL||160,h=b.bottomW||40,i=b.topW||50,j=b.radius||5,k=b.nbseg||10,l=b.thickness||10,m=b.thicknessL||l,n=b.thicknessW||l,o=0,p=0;e>=p;p++)q=f+(Math.asin(2*p/e-1)+Math.PI/2)*(g-f)/Math.PI,r=h+(Math.asin(2*p/e-1)+Math.PI/2)*(i-h)/Math.PI,(.3*e>p||p>.9*e)&&this.generateVasqueStrate(d,++o,q,r,p,j,k);this.generateVasqueStrate(d,++o,g+1,i+1,p,j,k);var q=g+m,r=i+n,j=.1;return this.generateVasqueStrate(d,++o,q,r,p,j,k,void 0,void 0,!0),this.generateVasqueStrate(d,++o,q,r,p-1,j,k,void 0,void 0,!0),GeometryHelper.generateStrateFacesForGeometry(a,d,8+4*(k-1),!0,!1,c,[o-3])},this.createHeadLight=function(a,b,c,d,e,f,g,h,i){var j=j||!1,k=[],l=[],m=[];b=b||50,c=Math.max(3,Math.floor(c)||8),d=Math.max(2,Math.floor(d)||6),e=void 0!==e?e:0,f=void 0!==f?f:2*Math.PI,g=void 0!==g?g:0,h=void 0!==h?h:Math.PI;var n,o,p=[],q=[];for(o=0;d>=o;o++){var r=[],s=[];for(n=0;c>=n;n++){var t=n/c,u=o/d,v=-b*Math.cos(e+t*f)*Math.sin(g+u*h),w=b*Math.cos(g+u*h),x=b*Math.sin(e+t*f)*Math.sin(g+u*h);k.push(v,w,x),r.push(k.length/3-1),s.push(new BABYLON.Vector2(t,1-u))}p.push(r),q.push(s)}for(o=0;d>o;o++)for(n=0;c>n;n++){var y=p[o][n+1],z=p[o][n],A=p[o+1][n],B=p[o+1][n+1],C=(new BABYLON.Vector3(k[y],k[y+1],k[y+2]).normalize(),new BABYLON.Vector3(k[z],k[z+1],k[z+2]).normalize(),new BABYLON.Vector3(k[A],k[A+1],k[A+2]).normalize(),new BABYLON.Vector3(k[B],k[B+1],k[B+2]).normalize(),q[o][n+1].clone()),D=q[o][n].clone(),E=q[o+1][n].clone(),F=q[o+1][n+1].clone();l.push(B,z,y),m.push(C.x,C.y,D.x,D.y,F.x,F.y),l.push(B,A,z),m.push(D.x,D.y,E.x,E.y,F.x,F.y)}var G=[],H=new BABYLON.Mesh(a,i);return BABYLON.VertexData.ComputeNormals(k,l,G),H.setVerticesData(BABYLON.VertexBuffer.PositionKind,k,j),H.setVerticesData(BABYLON.VertexBuffer.NormalKind,G,j),H.setVerticesData(BABYLON.VertexBuffer.UVKind,m,j),H.setIndices(l),H},this.createPillow=function(a,b,c,d,e,f,g,h,i,j,k,l){k||(k=0),l||(l=0);var m=d.clone(),n=new BABYLON.Vector3(m.x,m.y,m.z-g/2),o=new BABYLON.Vector3(m.x,m.y,m.z+g/2),p=new BABYLON.Vector3(m.x,m.y+f/2-i,m.z),q=new BABYLON.Vector3(m.x,m.y-f/2+i,m.z),r=new BABYLON.Vector3(m.x-e/2+h,m.y,m.z),s=(new BABYLON.Vector3(n.x-e/2,n.y+f/2,n.z),new BABYLON.Vector3(m.x-e/2,m.y+f/2,m.z)),t=(new BABYLON.Vector3(o.x-e/2,o.y+f/2,o.z),new BABYLON.Vector3(n.x-e/2,n.y-f/2,n.z),new BABYLON.Vector3(m.x-e/2,m.y-f/2,m.z)),u=(new BABYLON.Vector3(o.x-e/2,o.y-f/2,o.z),new BABYLON.Vector3(m.x+e/2-h,m.y,m.z)),v=(new BABYLON.Vector3(n.x+e/2,n.y+f/2,n.z),new BABYLON.Vector3(m.x+e/2,m.y+f/2,m.z)),w=(new BABYLON.Vector3(o.x+e/2,o.y+f/2,o.z),new BABYLON.Vector3(n.x+e/2,n.y-f/2,n.z),new BABYLON.Vector3(m.x+e/2,m.y-f/2,m.z)),x=(new BABYLON.Vector3(o.x+e/2,o.y-f/2,o.z),x||!1),y=[],z=[],A=[],B=[],C=[],D=[s.x,s.y,s.z];this.generateArc(D,c,s,p,v);for(var E=0;c>E;E++)y.push(o.x,o.y,o.z),y.push(o.x-k+2*E*k/c,o.y+l,o.z),this.generateArc(y,b,new BABYLON.Vector3(o.x-k+2*E*k/c,o.y+l,o.z),new BABYLON.Vector3(D[3*E],D[3*E+1],D[3*E+2]+g/2),new BABYLON.Vector3(D[3*E],D[3*E+1],D[3*E+2])),y.push(D[3*E],D[3*E+1],D[3*E+2]),this.generateArc(y,b,new BABYLON.Vector3(D[3*E],D[3*E+1],D[3*E+2]),new BABYLON.Vector3(D[3*E],D[3*E+1],D[3*E+2]-g/2),new BABYLON.Vector3(n.x-k+2*E*k/c,n.y+l,n.z)),y.push(n.x-k+2*E*k/c,n.y+l,n.z),y.push(n.x,n.y,n.z);D=[v.x,v.y,v.z],this.generateArc(D,c,v,u,w);for(var E=0;c>E;E++)y.push(o.x,o.y,o.z),y.push(o.x+k,o.y+l-2*E*l/c,o.z),this.generateArc(y,b,new BABYLON.Vector3(o.x+k,o.y+l-2*E*l/c,o.z),new BABYLON.Vector3(D[3*E],D[3*E+1],D[3*E+2]+g/2),new BABYLON.Vector3(D[3*E],D[3*E+1],D[3*E+2])),y.push(D[3*E],D[3*E+1],D[3*E+2]),this.generateArc(y,b,new BABYLON.Vector3(D[3*E],D[3*E+1],D[3*E+2]),new BABYLON.Vector3(D[3*E],D[3*E+1],D[3*E+2]-g/2),new BABYLON.Vector3(n.x+k,n.y+l-2*E*l/c,n.z)),y.push(n.x+k,n.y+l-2*E*l/c,n.z),y.push(n.x,n.y,n.z);D=[w.x,w.y,w.z],this.generateArc(D,c,w,q,t);for(var E=0;c>E;E++)y.push(o.x,o.y,o.z),y.push(o.x+k-2*E*k/c,o.y-l,o.z),this.generateArc(y,b,new BABYLON.Vector3(o.x+k-2*E*k/c,o.y-l,o.z),new BABYLON.Vector3(D[3*E],D[3*E+1],D[3*E+2]+g/2),new BABYLON.Vector3(D[3*E],D[3*E+1],D[3*E+2])),y.push(D[3*E],D[3*E+1],D[3*E+2]),this.generateArc(y,b,new BABYLON.Vector3(D[3*E],D[3*E+1],D[3*E+2]),new BABYLON.Vector3(D[3*E],D[3*E+1],D[3*E+2]-g/2),new BABYLON.Vector3(n.x+k-2*E*k/c,n.y-l,n.z)),y.push(n.x+k-2*E*k/c,n.y-l,n.z),y.push(n.x,n.y,n.z);D=[t.x,t.y,t.z],this.generateArc(D,c,t,r,s);for(var E=0;c>E;E++)y.push(o.x,o.y,o.z),y.push(o.x-k,o.y-l+2*E*l/c,o.z),this.generateArc(y,b,new BABYLON.Vector3(o.x-k,o.y-l+2*E*l/c,o.z),new BABYLON.Vector3(D[3*E],D[3*E+1],D[3*E+2]+g/2),new BABYLON.Vector3(D[3*E],D[3*E+1],D[3*E+2])),y.push(D[3*E],D[3*E+1],D[3*E+2]),this.generateArc(y,b,new BABYLON.Vector3(D[3*E],D[3*E+1],D[3*E+2]),new BABYLON.Vector3(D[3*E],D[3*E+1],D[3*E+2]-g/2),new BABYLON.Vector3(n.x-k,n.y-l+2*E*l/c,n.z)),y.push(n.x-k,n.y-l+2*E*l/c,n.z),y.push(n.x,n.y,n.z);for(var F=4*c,G=2*b+3,E=0;F-1>E;E++)for(var H=0;G-2>H;H++)z.push((E+1)*G+H,E*G+H+1,(E+1)*G+H+1),z.push(E*G+H+1,E*G+H+2,(E+1)*G+H+1),0==H&&A.push((E+1)*G+H,E*G+H+1,(E+1)*G+H+1),H==G-3&&A.push(E*G+H+1,E*G+H+2,(E+1)*G+H+1);for(var H=0;G-2>H;H++)z.push((F-1)*G+H+1,H+1,(F-1)*G+H),z.push((F-1)*G+H+1,H+2,H+1);var I=new BABYLON.Mesh(a,j);return BABYLON.VertexData.ComputeNormals(y,z,B),(k||l)&&BABYLON.Mesh.ComputeFlatNormal(y,B,A),C=BABYLON.Tools.PlaneUVProjection(y,new BABYLON.Vector3(1,0,0),new BABYLON.Vector3(0,1,0)),I.setVerticesData(BABYLON.VertexBuffer.PositionKind,y,x),I.setVerticesData(BABYLON.VertexBuffer.NormalKind,B,x),I.setVerticesData(BABYLON.VertexBuffer.UVKind,C,x),I.setIndices(z),I},this.createRoundedAngle=function(a,b,c,d,e,f,g){var h=[],c=c||1,b=b||10;return this.generateVasqueStrate(h,0,d,f,e/2,c,b),this.generateVasqueStrate(h,0,d,f,e/2,c,b),this.generateVasqueStrate(h,0,d,f,-e/2,c,b),this.generateVasqueStrate(h,1,d,f,-e/2,c,b),GeometryHelper.generateStrateFacesForGeometry(a,h,8+4*(b-1),!0,!0,g,void 0,!0)},this.createRoundedBloc=function(a,b,c,d,e,f,g,h){var i=[],d=d||.1,b=b||10,j=0,k=d/c,l=e,m=g,n=f/2+d;this.generateVasqueStrate(i,++j,l,m,n,.1,b);for(var o=k;d>=o;o+=k){var p=d*Math.sin(o/d*Math.PI/2);this.generateVasqueStrate(i,++j,l+2*p,m+2*p,n-d*(1-Math.cos(o/d*Math.PI/2)),p,b)}for(var o=d;o>0;o-=k){var p=d*Math.sin(o/d*Math.PI/2);this.generateVasqueStrate(i,++j,l+2*p,m+2*p,-n+d*(1-Math.cos(o/d*Math.PI/2)),p,b)}this.generateVasqueStrate(i,++j,l,m,-n,.1,b);var i=GeometryHelper.generateStrateFacesForGeometry(a,i,8+4*(b-1),!0,!0,h,void 0,!0);return this.giftWraper(i,128,!0),i},this.generateEllispeStrate=function(a,b,c,d,e,f){var g=2*Math.PI/b;if(f){for(var h=0;h<Math.PI;h+=g){var i=c*Math.cos(h),j=c*Math.sin(h)+d-c;a.push(i,e,j)}for(var h=Math.PI;h<2*Math.PI;h+=g){var i=c*Math.cos(h),j=c*Math.sin(h)-d+c;a.push(i,e,j)}}else for(var h=0;h<2*Math.PI;h+=g){var i=c*Math.cos(h),j=d*Math.sin(h);a.push(i,e,j)}},this.createEllispeTable=function(a,b,c,d,e,f,g){var h=[],b=b||10;return this.generateEllispeStrate(h,b,c,d,-e/2,g),this.generateEllispeStrate(h,b,c,d,-e/2,g),this.generateEllispeStrate(h,b,c,d,e/2,g),this.generateEllispeStrate(h,b,c,d,e/2,g),GeometryHelper.generateStrateFacesForGeometry(a,h,b+1,!0,!0,f,void 0,!0)}},GlobalHelper=function(){function a(){if(hcsdesign&&hcsdesign.engine3D)return hcsdesign.engine3D.engine._gl;var a=document.createElement("canvas");return a.getContext("webgl")||a.getContext("experimental-webgl")}var b={},c=null,d=!!navigator.userAgent.match(/Android/i),e=d&&!!navigator.userAgent.match(/GT-/i),f=!!navigator.userAgent.match(/iPhone|iPad|iPod/i),g=!!navigator.userAgent.match(/trident.*(Windows Phone|NOKIA)/i),h=!!navigator.userAgent.match(/trident.*(arm|tablet|Windows Phone|NOKIA)/i),i=d||f||h,j=/fr/i.test(navigator.language||navigator.languages||navigator.userLanguage||navigator.systemLanguage||"en");return b.getCapabilities=function(){if(null===c){c={maxTextureSize:512,maxCubemapTextureSize:512,extensions:{}};var b=["EXT_texture_filter_anistrotropic","OES_element_index_uint","OES_standard_derivatives","OES_texture_float","OES_texture_float_linear","OES_texture_half_float","OES_texture_half_float_linear","OES_vertex_array_object","WEBGL_compressed_texture_s3tc","WEBGL_lose_context","WEBGL_debug_renderer_info"],d=a();if(d){for(var e=0,f=b.length;f>e;e++){for(var g=b[e].split("_"),h=g[1],i=2,j=g.length;j>i;i++)h+=g[i].replace(g[i][0],g[i][0].toUpperCase());c.extensions[h]=d.getExtension(b[e])?!0:!1}c.maxTextureSize=d.getParameter(d.MAX_TEXTURE_SIZE),c.maxCubemapTextureSize=d.getParameter(d.MAX_CUBE_MAP_TEXTURE_SIZE)}}return c},b.getWrappedMouseEventNames=function(){return"ontouchstart"in window?{down:"touchstart",move:"touchmove",up:"touchend",cancel:"touchcancel"}:{down:"pointerdown",move:"pointermove",up:"pointerup",cancel:"pointercancel",out:"pointerout"}},b.hasWebGL=function(){return a()?!0:!1},b.hasCanvas2D=function(){return window.HTMLCanvasElement},b.hasAzertyKeyboard=function(){return j},b.isMobileDevice=function(){return i},b.isAndroidDevice=function(){return d},b.isAppleDevice=function(){return f},b.isSamsungDevice=function(){return e},b.isWindowsDevice=function(){return h},b.isWindowsPhoneDevice=function(){return g},b.isIE=function(){var a=navigator.userAgent.toLowerCase();return-1!=a.indexOf("msie")?parseInt(a.split("msie")[1]):-1},b.isIE9=function(){return"Explorer"===BrowserDetect.browser&&9===BrowserDetect.version},b.isIE10=function(){return"Explorer"===BrowserDetect.browser&&10===BrowserDetect.version},b.createScreenshot3D=function(a,b,c){var d=document.createElement("canvas"),b=b||{width:window.innerWidth,height:window.innerHeight},e=new BABYLON.RenderTargetTexture("screenShot",b,a.scenes[0]);e.renderList=a.scenes[0].meshes,e.onAfterRender=function(){for(var e=4*b.width,f=b.height/2,g=a.readPixels(0,0,b.width,b.height),h=0;f>h;h++)for(var i=0;e>i;i++){var j=i+h*e,k=b.height-h-1,l=i+k*e,m=g[j];g[j]=g[l],g[l]=m}d.width=b.width,d.height=b.height;var n=d.getContext("2d"),o=n.createImageData(d.width,d.height);o.data.set(g),n.putImageData(o,0,0),c(d)},e.render(),e.dispose()},b.__forceMobileDevice=function(a){i=a},b.stripDomainUrl=function(a,b){if(a&&-1!==a.indexOf("http://")&&-1!==a.indexOf(b)){var c=a.replace("http://","").split("/");a=a.replace("http://"+c[0],"/"),a=a.split("///").join("//"),a=a.split("//").join("/")}return a},b}(),HTMLHelper=function(){var a={};return a.insertHTML=function(a,b,c,d){var e=b,c="function"==typeof c?c:function(){},d="function"==typeof d?d:function(){};"string"==typeof b&&(e=document.getElementById(b)),ujs.ajax({method:"GET",url:a+"?t="+Math.round(100*Math.random()),success:function(a){e.innerHTML=a,c()},onerror:d})},a.addScript=function(a,b,c,d){var c="function"==typeof c?c:function(){},d="function"==typeof d?d:function(){},e=document.createElement("script");if(e.addEventListener("load",c,!1),e.addEventListener("error",d,!1),e.setAttribute("src",a),b)for(var f in b)e.setAttribute(f,b[f]);var g=document.getElementById("scripts");g.appendChild(e)},a.addStylesheet=function(a,b,c,d){var c="function"==typeof c?c:function(){},d="function"==typeof d?d:function(){},e=document.createElement("link");if(e.addEventListener("load",c,!1),e.addEventListener("error",d,!1),e.setAttribute("rel","stylesheet"),e.setAttribute("href",a),b)for(var f in b)e.setAttribute(f,b[f]);var g=document.getElementsByTagName("head")[0];g.appendChild(e)},a.hide3DMenus=function(a){var a=a||"none",b=document.getElementById("decorate3D"),c=document.getElementById("furnishing3D");b&&(b.style.display=a),c&&(c.style.display=a)},a.simulateKey=function(a,b,c){var d="string"==typeof b?"key"+b:"keydown",c=c||{},e={keyCode:a};for(var f in c)e[f]=c[f];ujs.notify(d,e)},a.simulateClick=function(a,b,c,d,e,f){var g=document.createEvent("MouseEvent");g.initEvent(d||"mousedown"),g.clientX=g.layerX=g.pageX=g.screenX=g.x=0|+b,g.clientX=g.layerY=g.pageY=g.screenY=g.y=0|+c,g.button=0|+e,g.detail=g.wheelDeltaY=g.wheelDelta=0|+f,a.dispatchEvent(g)},a}(),hcs=window.hcs||{};hcs.Symbols2D=function(){var a=function(){this.COLOR_ACTIVE_STROKE="#897364",this.COLOR_ACTIVE_STROKE_DARKER="#A99384",this.COLOR_ACTIVE_FILL="rgba(137, 115, 100, 0.2)",this.COLOR_ACTIVE_LARGEZONE_FILL="rgba(137, 137, 137, 0.5)",this.COLOR_INACTIVE_STROKE="#777777",this.COLOR_INACTIVE_FILL="rgba(137, 115, 100, 0.1)",this.COLOR_BACKGROUND="#FAFAFA",this.COLOR_ANNOTATION="#888"};return a.prototype.drawPoint=function(a,b){a.save(),a.fillStyle=this.COLOR_ACTIVE_STROKE,a.beginPath(),a.arc(b.x,b.y,6,0,2*Math.PI,!1),a.fill(),a.restore()},a.prototype.drawPointHover=function(a,b,c){var c=c||1;a.save(),this.drawPoint(a,b),a.strokeStyle=this.COLOR_ACTIVE_STROKE,a.lineWidth=4,a.beginPath();var d=12*c;10>d&&(d=10),a.arc(b.x,b.y,d,0,2*Math.PI,!1),a.stroke(),a.restore()},a.prototype.drawAngle=function(a,b,c,d,e,f,g){a.save(),a.fillStyle=this.COLOR_ACTIVE_LARGEZONE_FILL,a.strokeStyle=this.COLOR_ACTIVE_STROKE,a.beginPath(),a.moveTo(b.x,b.y),a.arc(b.x,b.y,d,e,f,g),a.lineTo(b.x,b.y),a.fill(),a.stroke(),a.font="normal 8pt sans-serif",a.textBaseline="middle",a.textAlign="center";var h={x:b.x+d*Math.cos((f+e)/2),y:b.y+d*Math.sin((f+e)/2)},i=Math.round(180*Math.abs(f-e)/Math.PI)+" °";a.fillStyle=this.COLOR_BACKGROUND,a.beginPath(),a.arc(h.x,h.y,a.measureText(i).width/2+2,0,2*Math.PI),a.fill(),a.stroke(),a.fillStyle=this.COLOR_ANNOTATION,a.fillText(i,h.x,h.y),a.restore()},a.prototype.drawSegment=function(a,b,c){b.x=Math.round(b.x)+.5,b.y=Math.round(b.y)+.5,c.x=Math.round(c.x)+.5,c.y=Math.round(c.y)+.5,a.save(),a.strokeStyle=this.COLOR_ACTIVE_STROKE,a.fillStyle=this.COLOR_ACTIVE_STROKE,a.lineWidth=5,this.drawPoint(a,b),this.drawPoint(a,c),a.beginPath(),a.moveTo(b.x,b.y),a.lineTo(c.x,c.y),a.stroke(),a.restore()},a.prototype.drawArc=function(a,b,c,d){b.x=Math.round(b.x)+.5,b.y=Math.round(b.y)+.5,d.x=Math.round(d.x)+.5,d.y=Math.round(d.y)+.5,c.x=Math.round(c.x)+.5,c.y=Math.round(c.y)+.5,a.save(),a.strokeStyle=this.COLOR_ACTIVE_STROKE,a.fillStyle=this.COLOR_ACTIVE_STROKE,a.lineWidth=5,this.drawPoint(a,b),this.drawPoint(a,d),a.beginPath(),a.moveTo(b.x,b.y),a.quadraticCurveTo(c.x,c.y,d.x,d.y),a.stroke(),a.restore()},a.prototype.drawGrip=function(a,b,c,d){var d=d||0;b.x=Math.round(b.x),b.y=Math.round(b.y),a.save(),a.strokeStyle=this.COLOR_ACTIVE_STROKE,a.fillStyle=this.COLOR_BACKGROUND,a.lineWidth=2,a.translate(b.x,b.y),a.beginPath(),a.arc(0,0,9,0,2*Math.PI,!1),a.fill(),a.stroke(),this.drawArrows(a,{x:0,y:0},c,12,d),a.restore()},a.prototype.drawCheckGrip=function(a,b,c,d){var d=d||0;b.x=Math.round(b.x),b.y=Math.round(b.y),a.save(),a.translate(b.x,b.y),a.strokeStyle=this.COLOR_BACKGROUND,a.fillStyle=this.COLOR_INACTIVE_STROKE,a.lineWidth=2,a.beginPath(),a.arc(0,0,11,0,2*Math.PI,!1),a.fill(),a.stroke(),a.save(),a.fillStyle=this.COLOR_BACKGROUND,a.rotate(Math.PI/4),a.fillRect(-5,2,5,4),a.rotate(Math.PI/2),a.fillRect(-7,-3,13,4),a.restore(),this.drawArrows(a,{x:0,y:0},c,12,d),a.restore()},a.prototype.drawCancelGrip=function(a,b,c,d){var d=d||0;b.x=Math.round(b.x),b.y=Math.round(b.y),a.save(),a.translate(b.x,b.y),a.strokeStyle=this.COLOR_BACKGROUND,a.fillStyle=this.COLOR_INACTIVE_STROKE,a.lineWidth=2,a.beginPath(),a.arc(0,0,11,0,2*Math.PI,!1),a.fill(),a.stroke(),a.save(),a.fillStyle=this.COLOR_BACKGROUND,a.rotate(Math.PI/4),a.fillRect(-7,-2,14,4),a.rotate(Math.PI/2),a.fillRect(-7,-2,14,4),a.restore(),this.drawArrows(a,{x:0,y:0},c,12,d),a.restore()},a.prototype.drawGripSegment=function(a,b,c,d,e,f){var f=f||0;b.x=Math.round(b.x)+.5,b.y=Math.round(b.y)+.5,c.x=Math.round(c.x)+.5,c.y=Math.round(c.y)+.5,a.save(),a.strokeStyle=this.COLOR_ACTIVE_STROKE,a.fillStyle=this.COLOR_ACTIVE_STROKE,a.lineWidth=5,a.beginPath(),a.moveTo(b.x,b.y),a.lineTo(c.x,c.y),a.stroke(),this.drawGrip(a,b,d,f),this.drawGrip(a,c,e,f),a.restore()},a.prototype.drawArrows=function(a,b,c,d,e,f,g){var g=g||{},h=g.size||6,e=e||0;for(a.save(),a.translate(b.x,b.y),a.rotate(e),a.fillStyle=this.COLOR_ACTIVE_STROKE,a.strokeStyle=this.COLOR_BACKGROUND,a.lineWidth=2,i=0;4>i;i++)c[i]&&(a.beginPath(),a.moveTo(0,-d-h),a.lineTo(-h,-d),a.lineTo(h,-d),a.closePath(),f&&a.stroke(),a.fill()),a.rotate(Math.PI/2);a.restore()},a.prototype.drawMeasure=function(a,b,c,d,e){a.save(),a.strokeStyle=e||this.COLOR_ANNOTATION,a.fillStyle=e||this.COLOR_ANNOTATION,a.lineWidth=1,a.font="normal 8pt sans-serif",a.textBaseline="middle",a.textAlign="center";var f=c.x>b.x?c.x-b.x:b.x-c.x,g=c.y>b.y?c.y-b.y:b.y-c.y,h=Math.sqrt(Math.pow(f,2)+Math.pow(g,2)),i=Math.atan2(c.y-b.y,c.x-b.x),j=d?a.measureText(d).width+10:0;j>h-2||(a.translate(Math.round((b.x+c.x)/2),Math.round((b.y+c.y)/2)),a.rotate(i),a.beginPath(),(h-j)/2>5&&(a.moveTo(-Math.round(h/2),.5),a.lineTo(-Math.round(j/2)+1,.5),a.moveTo(Math.round(h/2),.5),a.lineTo(Math.round(j/2)-1,.5)),a.save(),a.translate(-Math.round(h/2),0),a.moveTo(.5,.5),a.lineTo(5,5),a.moveTo(.5,.5),a.lineTo(5,-4),a.stroke(),a.restore(),a.save(),a.translate(Math.round(h/2),0),a.moveTo(-.5,.5),a.lineTo(-5,5),a.moveTo(-.5,.5),a.lineTo(-5,-4),a.restore(),a.stroke(),d&&((i>=Math.PI/2||i<-Math.PI/2)&&a.rotate(Math.PI),a.fillText(d,0,-.5)),a.restore())},a.prototype.drawCursorCheck=function(a,b){var c=b.x+20,d=b.y+20;a.save(),a.translate(c,d),a.fillStyle="rgba(0,0,0,.2)",a.rotate(Math.PI/4),a.fillRect(-6,2,7,6),a.rotate(Math.PI/2),a.fillRect(-7,-5,15,6),a.restore(),a.save(),a.translate(c,d),a.fillStyle=this.COLOR_ACTIVE_STROKE_DARKER,a.fillStyle="#000",a.rotate(Math.PI/4),a.fillRect(-7,1,7,6),a.rotate(Math.PI/2),a.fillRect(-8,-4,15,6),a.restore(),a.save(),a.translate(c,d),a.fillStyle=this.COLOR_BACKGROUND,a.rotate(Math.PI/4),a.fillRect(-6,2,6,4),a.rotate(Math.PI/2),a.fillRect(-7,-3,13,4),a.restore()},a.prototype._drawAllSymbols=function(a){this.drawPoint(a,{x:100,y:100}),this.drawPointHover(a,{x:150,y:100}),this.drawPointHover(a,{x:200,y:100},1.5),this.drawSegment(a,{x:250,y:90},{x:300,y:110}),this.drawGrip(a,{x:350,y:100},[!0,!0,!0,!0]),this.drawGrip(a,{x:400,y:100},[!1,!0,!1,!0],Math.PI/4),this.drawCheckGrip(a,{x:450,y:100},[!0,!0,!0,!0]),this.drawCancelGrip(a,{x:500,y:100},[!1,!0,!1,!0],3*Math.PI/4),this.drawGripSegment(a,{x:550,y:90},{x:600,y:110},[!1,!1,!1,!0],[!1,!0,!1,!1],.4),this.drawMeasure(a,{x:650,y:80},{x:750,y:80},"measure"),this.drawMeasure(a,{x:650,y:100},{x:715,y:100},"measure"),this.drawMeasure(a,{x:650,y:120},{x:706,y:120},"measure"),this.drawCursorCheck(a,{x:100,y:150})},a}();var hcs=window.hcs||{};hcs.uuid=function(){function a(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(a){var b=16*Math.random()|0,c="x"==a?b:3&b|8;return c.toString(16)})}return{uuid4:a}}();var hcs=window.hcs||{};hcs.Dummy={Engine3D:function(a){var b=function(){return null};this.dummy=!0,this._components=[],this.removeComponent=b,this.searchComponent=b,this.initialize=b,this.update=b,this.draw=b,this.resize=b,this.setEnabled=b,this.canvas=document.createElement("canvas"),this.castShadows=b,this.uncastShadows=b;var c=this;this.engine={_caps:{},_gl:null,_renderingCanvas:c.canvas,getRenderingCanvas:function(){return c.canvas},createRenderTargetTexture:function(){},getLoadedTexturesCache:function(){return[]},createVertexBuffer:b,createIndexBuffer:b,createTexture:b,createCubeTexture:b,createDynamicVertexBuffer:b,createEffect:b,scenes:[]},this.addComponent=function(){return{}},this.scene={materials:[],textures:[],meshes:[],cameras:[],spriteManagers:[],getMeshByName:b,getRenderId:function(){return 0},getEngine:function(){return c.engine}},this.scenes=[this.scene],this.getContainer=function(){return a}}};var hcs=window.hcs||{};hcs.Assets={globalPath:"",metalTextures:{diffuse:"textures/metal/metal_DIFFUSE.png",normal:"textures/metal/metal_NORMAL.png",specular:"textures/metal/metal_SPECULAR.png"},woodTextures:{diffuse:"textures/bois/bois_DIFFUSE.png",normal:"textures/bois/bois_NORMAL.png",specular:"textures/bois/bois_SPECULAR.png"},plasticTextures:{diffuse:"textures/plastique/plastique_DIFFUSE.png",normal:"textures/plastique/plastique_NORMAL.png",specular:"textures/plastique/plastique_SPECULAR.png"},whiteTexture:"textures/misc/white.jpg",blackTexture:"textures/misc/black.jpg",transparentTexture:"textures/misc/transparent.png",shadowTexture:"textures/shadow/shadow.png",roomTextures:{diffuse:"textures/parquet/parquet_DIFFUSE.png",normal:"textures/parquet/parquet_NORMAL.png",specular:"textures/parquet/parquet_SPEC.png"},firePlaceFire:"textures/fireplace/fireplace_tex.png",firePlaceBrick:{diffuse:"textures/fireplace/fire_place_brick.png",normal:"textures/fireplace/fire_place_brick_normals.png",specular:"textures/fireplace/fire_place_brick_spec.png"},firePlaceBrick2:{diffuse:"textures/textureset/brick/brick05.jpg",normal:"textures/textureset/brick/brick05_NORM.jpg",specular:"textures/textureset/brick/brick05_SPEC.jpg"},firePlacePlate:{diffuse:"textures/fireplace/fireplace_plate_tex.png",normal:"textures/fireplace/fireplace_plate_tex_normals.png",specular:"textures/fireplace/fireplace_plate_tex_spec.png"},induction:{map:"textures/misc/induction.jpg"},dishwasher:{map:"textures/misc/lavevaisselle.jpg"},hood:{map:"textures/misc/hotte.png"},oven:{map:"textures/misc/oven.png"},microwave:{map:"textures/misc/microwave.png"},firePlaceWood:{diffuse:"textures/fireplace/fireplace_wood.png",normal:"textures/fireplace/fireplace_wood_normals.png",specular:"textures/fireplace/fireplace_wood_spec.png"},envMapTexture:"textures/environment/SwedishRoyalCastle/src",flatEnvMapTexture:"textures/environment/flatInterior/flat",skyEnvMapTexture:"textures/environment/sky.jpg",toolbarTextures:{infoTexture:"textures/toolbar/info.png",infoTextureGroup:"textures/toolbar/infoGroup.png",rotateTexture:"textures/toolbar/rotate.png",arrowTexture:"textures/toolbar/arrow.png"},mattTexture:"textures/misc/CNPflat_tex.png",darkWoodTextures:{diffuse:"textures/wood/dark-wood1.png",normal:"textures/wood/dark-wood1_NORM.png",specular:"textures/wood/dark-wood1_SPEC.png"},bedSheetsTextures:{diffuse:"textures/bed/sheets.png",normal:"textures/bed/sheets_NORM.png",specular:"textures/bed/sheets_SPEC.png"},cromwellTextures:{diffuse:"models/babylon/chair/cromwell/cromwell_diff.png",normal:"models/babylon/chair/cromwell/cromwell_normals.png",specular:"models/babylon/chair/cromwell/cromwell_specular.png"},cushionTexture:"textures/bed/cushion-test3.png",vasqueDAE:"models/babylon/bathroom/components/vasque_s",doucheDAE:"models/babylon/bathroom/shower1/shower1.babylon",robinetDAE:"models/babylon/robinet/robinet.babylon",spotLampDAE:"models/babylon/lamps/lamp2/spot.babylon",robinet3DAE:"models/babylon/robinet/robinet3.babylon",robinet4DAE:"models/babylon/robinet/robinet4.babylon",robinet5DAE:"models/babylon/robinet/tap.babylon",boconceptfeetDAE:"models/babylon/table/boconcept/bocpart.babylon",ovaletableDAE:"models/babylon/table/ovale/ovale.babylon",cromwellleftsideDAE:"models/babylon/chair/cromwell/cromwell_leftside.babylon",cromwelrightsideDAE:"models/babylon/chair/cromwell/cromwell_rightside.babylon",cromwellcenterDAE:"models/babylon/chair/cromwell/cromwell_center.babylon",DaePath:"models/babylon/",retrieveImageScriptPath:"php/retrieveImage.php",retrieveObjectScriptPath:"php/retrieveObject.php",remote:{man:"images/remote-controller/green_man.png",cam:"images/remote-controller/green_cam.png",bg:"images/remote-controller/bg.png"},mainUIColor:"#897364",complementaryUIColor:"#897364",groupColor:"#897364"};var hcs=window.hcs||{};hcs.AnimationHandler=function(){var a=function(){};a.LINEAR=0,a.SMOOTH=1;var b=-1,c=-1,d=[],e=0,f=function(b,c,d,f){this.running=!1,this.startTime=null,this.lastTime=null,this.endTime=null,this.duration=c||-1,this.speeds=null,this.target=b||null,this.properties=d||null,this.interpolationMethod=void 0!==f&&null!==f?f:a.LINEAR,this.id=e++,this.computeSpeeds()};return f.prototype.computeSpeeds=function(){if(this.properties){this.speeds={};for(var a in this.properties)this.speeds[a]=(this.properties[a].end-this.properties[a].start)/this.duration}},f.prototype.start=function(){this.running=!0,this.startTime=(new Date).getTime()},f.prototype.stop=function(){this.running=!1,this.endTime=(new Date).getTime(),this.startTime=null},a.Create=function(a,b,c,e){var g=new f(a,b,c,e);return d.push(g),g},a.GetAnimations=function(){return d},a.GetAnimation=function(a){for(var b=0,c=d.length;c>b;b++)if(d[b].id===a)return d[b];return Logger.warning("No animation found with this id"),null},a.Dispose=function(a){for(var b=0,c=d.length;c>b;b++)if(d[b].id===a)return void d.splice(b,1)},a.ClearAll=function(){d.length=0},a.Process=function(){b=(new Date).getTime();for(var c=0,e=d.length;e>c;c++)a.ProcessAnimation(d[c])},a.ProcessAnimation=function(a){if(a.running){c=b-(a.lastTime||a.startTime),a.lastTime=b;for(var d in a.properties)a.properties[d].callback?a.properties[d].callback((b-a.startTime)*a.speeds[d]+a.properties[d].start):a.target[d]+=c*a.speeds[d];b-a.startTime>=a.duration&&a.stop()}},a}();var hcs=window.hcs||{};hcs.Constants={VERSION:"1.2.0.0",BACK_URL:"",WNP_URL:"",MIGRATION_PATH:"migration/plan?json=",ENGINE_2D:1,ENGINE_3D:2,MODE_STANDALONE:0,MODE_CUSTOMER:1,LANG:"en",LOCAL_STORAGE_STRUCTURE_KEY:"wanadev.planner.structure",LC_REM_LOGIN_KEY:"wanadev.planner.remember",LC_REM_CRYPT_KEY:"wanadev",LC_LANG_KEY:"wanadev.planner.lang",LC_MAC_GL_CHECK:"wanadev.planner.macosx.check",PRODUCTS_PATH:"data/products/",TEMPLATE_PATH:"js/Core/UI/Templates/",PROGRAMMABLE_PATH:"js/Components/CoreComponents/Object/Programmable",GRAPHICS_FAST:0,GRAPHICS_GOOD:1,GRAPHICS_QUALITY:2,MAGNETISM:{NONE:0,WALL:1,OBJECT:2,VERTICAL:4},PRODUCTS_FILE:"data/products.json",PRODUCTS_PREVIEWS:"models/previews/"},hcs.Constants.MAGNETISM.DEFAULT=hcs.Constants.MAGNETISM.WALL|hcs.Constants.MAGNETISM.OBJECT|hcs.Constants.MAGNETISM.VERTICAL;var hcs=window.hcs||{};hcs.CameraFeatures=function(){var a=null,b=function(){this.camera=void 0,this.wallTransparency=!1,document.addEventListener("hcs.engine3D.camera.move",this.onCameraMove.bind(this),!1),document.addEventListener("hcs.engine3D.camera.zoom",this.onCameraZoom.bind(this),!1),document.addEventListener("hcs.engine3d.subslopeOverturesReady",this.onWallsReady.bind(this),!1),document.addEventListener("hcs.contextChanged",this.onContextChanged.bind(this),!1),document.addEventListener("hcs.engine3d.globaleFloorReady",this.onGlobaleFloorReady.bind(this),!1)};b.prototype.setCamera=function(a){this.camera=a},b.prototype.onCameraMove=function(){this.wallTransparency&&this.dynamicWallTransparency()},b.prototype.onCameraZoom=function(){this.wallTransparency&&this.dynamicWallTransparency()},b.prototype.onWallsReady=function(){hcsdesign.getSelectedEngine()===hcsdesign.ENGINE_3D&&this.wallTransparency&&this.dynamicWallTransparency()},b.prototype.stopTransparency=function(){a=a||hcsdesign.getComponentByName("WallComponent3D");for(var b,d=hcsdesign.getSelectedStructure(),e=a.get3DWallFrom2D(d),f=0,g=e.material.subMaterials.length;g>f;f++)if(b=e.material.subMaterials[f],b.opacitySwitched){if(e.objectInstances[f]&&("OvertureStructure"==e.objectInstances[f].name||"SubSlopeOvertureStructure"==e.objectInstances[f].name)&&e.objectInstances[f].programmableInstance)for(var h in e.objectInstances[f].programmableInstance.materials)e.objectInstances[f].programmableInstance.materials.hasOwnProperty(h)&&c(e.objectInstances[f].programmableInstance.materials[h]);c(b)}this.wallTransparency=!1},b.prototype.startTransparency=function(){this.dynamicWallTransparency(),this.wallTransparency=!0},b.prototype.buildPlaneFromBB=function(a){var b=a.center,c=-a.angle,d=new BABYLON.Vector3(Math.sin(c),0,-Math.cos(c));return BABYLON.Plane.FromPositionAndNormal(b,d)},b.prototype.fillByZIndex=function(a){var b,c,d,e={},f=this.camera.target.clone(),g=new BABYLON.Ray(this.camera.position,f.subtract(this.camera.position).normalize());new BABYLON.Vector3,e[0]=!0,e[1]=!0;for(var h in a.subMeshes)b=a.boundingBoxes[h],b?(c=this.buildPlaneFromBB(b),d=g.distanceToPlane(c),null!==d&&d<=f.distanceTo(this.camera.position)&&(e[h]=!0)):"top"==a.material.subMaterials[h].name?e[h]=!0:a.objectInstances[h]&&"SubSlopeOvertureStructure"==a.objectInstances[h].name&&(e[h]=!0);
return e};var c=function(a,b){var c=void 0!==a.alternativeOpacity?a.alternativeOpacity:b;a.alternativeOpacity=a.alpha,a.alpha=c,a.opacitySwitched=!a.opacitySwitched,a.transparent=1!=a.alpha};b.prototype.dynamicWallTransparency=function(){a=a||hcsdesign.getComponentByName("WallComponent3D");var b=hcsdesign.getSelectedStructure(),d=a.get3DWallFrom2D(b);if(d)for(var e,f=this.fillByZIndex(d),g=0,h=d.subMeshes.length;h>g;g++)if(e=d.material.subMaterials[d.subMeshes[g].materialIndex],e.opacitySwitched&&!f[d.subMeshes[g].materialIndex]||!e.opacitySwitched&&f[d.subMeshes[g].materialIndex])if(1==g)c(e,0);else{if(d.objectInstances[g]&&("OvertureStructure"==d.objectInstances[g].name||"SubSlopeOvertureStructure"==d.objectInstances[g].name)&&d.objectInstances[g].programmableInstance)for(var i in d.objectInstances[g].programmableInstance.materials)d.objectInstances[g].programmableInstance.materials.hasOwnProperty(i)&&c(d.objectInstances[g].programmableInstance.materials[i],.2);c(e,.2)}},b.prototype.makeWallsOpaque=function(b){if(this.wallTransparency){a=a||hcsdesign.getComponentByName("WallComponent3D");var d,b=b||hcsdesign.getSelectedStructure(),e=a.get3DWallFrom2D(b);if(!e)return;for(var f=0,g=e.subMeshes.length;g>f;f++)if(d=e.material.subMaterials[e.subMeshes[f].materialIndex],d.opacitySwitched){if(e.objectInstances[f]&&("OvertureStructure"==e.objectInstances[f].name||"SubSlopeOvertureStructure"==e.objectInstances[f].name)&&e.objectInstances[f].programmableInstance)for(var h in e.objectInstances[f].programmableInstance.materials)e.objectInstances[f].programmableInstance.materials.hasOwnProperty(h)&&c(e.objectInstances[f].programmableInstance.materials[h]);c(d)}}},b.prototype.onContextChanged=function(a){"3D"!==a.context&&this.makeWallsOpaque()},b.prototype.onGlobaleFloorReady=function(a){for(var b=0;b<hcsdesign.structure.getLength();b++){var c=hcsdesign.structure.getElement(b);b!==a.maxFloorId&&this.makeWallsOpaque(c)}},b.prototype.getBestFocusRadius=function(a,b,c){var d=a.getBoundingSphere(),e=(d.center.clone().add(a.position),c.getEngine().getAspectRatio(b)),f=Math.max(1,1/e)*d.radius,g=f/Math.sin(b.fov/2);return g},b.prototype.computeCameraStateLooking=function(a,b,c){c=c||new BABYLON.Viewport(0,0,1,1);var d=a.getScene();b=b||d.activeCamera;var e=a.getBoundingSphere(),f=new BABYLON.Vector3(0,.3,1.2);a.structure&&"undefined"!=typeof a.structure.preferredYAngle&&(f.x=Math.sin(a.structure.preferredYAngle),f.z=Math.cos(a.structure.preferredYAngle)),f.normalize();var g=e.center.clone(),h=a.getWorldMatrix().clone();g.x+=h.m[12],g.y+=h.m[13],g.z+=h.m[14],h.m[12]=h.m[13]=h.m[14]=0;var i=BABYLON.Vector3.TransformCoordinates(f,h);i.y<0&&(i.y=0,i.normalize());var j=i.toSpherical(),k=d.getEngine().getAspectRatio(b),l=1/c.height*e.radius,m=1/c.width/k*e.radius,n=Math.max(m,l)/Math.sin(b.fov/2),o=new BABYLON.Vector3(0,1,0),p=BABYLON.Vector3.Cross(o,f);(null==p||p.lengthSquared()<1e-5)&&(f=new BABYLON.Vector3(0,1,.001),p=BABYLON.Vector3.Cross(o,f)),p.normalize(),BABYLON.Vector3.CrossToRef(p,f,o);var q=BABYLON.Matrix.FromArray([p.x,p.y,p.z,0,o.x,o.y,o.z,0,f.x,f.y,f.z,0,0,0,0,1]);q.invert(),q=q.multiply(h),l=n*Math.sin(b.fov/2),m=l*k;var r=new BABYLON.Vector3(m*c.x,0,0),s=new BABYLON.Vector3(0,l*c.y,0);return BABYLON.Vector3.TransformCoordinatesToRef(r,q,r),BABYLON.Vector3.TransformCoordinatesToRef(s,q,s),g.addInPlace(r),g.addInPlace(s),{target:g,alpha:j.alpha,beta:j.beta,radius:n}};var d=function(a,b){this.animations=a,this.target=b,this.target._animationCancelor&&this.target._animationCancelor.cancel(),this.target._animationCancelor=this};d.prototype.cancel=function(){this.target._animationCancelor==this&&(this.target.getScene().stopAnimation(this.target),this._onAnimationEnd())},d.prototype._onAnimationEnd=function(){if(this.target._animationCancelor==this&&(this.target._animationCancelor=null,this._moreCleanUp&&this._moreCleanUp(),this._callBack&&this._callBack(),this.animations)){for(var a=this.animations.length;a--;)for(var b=this.target.animations.length;b--;)this.animations[a]==this.target.animations[b]&&this.target.animations.splice(b,1);this.animations=null}};var e=function(a,b,c,d,e,f){f=f||{x:null,y:null};var g=1-a;return f.x=3*a*g*g*b+3*a*a*g*d+a*a*a,f.y=3*a*g*g*c+3*a*a*g*e+a*a*a,f},f=function(a,b,c,d,f){for(var g,h=0,i=1,j={x:null,y:null};i-h>.001;)e(g=(h+i)/2,b,c,d,f,j).x>a?i=g:h=g;return(h+i)/2},g=function(a,b,c,d,g){return e(f(a,b,c,d,g),b,c,d,g).y},h={linear:function(a){return a},ease:function(a){return g(a,.5,0,.5,1)},easeOut:function(a){return g(a,.64,.47,.34,1)}};return b.prototype.computeAnimation=function(a,b,c,e){e=e||{};var f=Math.max(.01,e.duration||0),g=e.callback,i=("undefined"==typeof e.cleanAfterAnimation?!0:e.cleanAfterAnimation,e.name||"animation"),j=e.isACamera,k="function"==typeof e.smooth?e.smooth:h[e.smooth||"linear"],l=[];for(var m in b){for(var n,o,p=new BABYLON.Animation(i+"_"+m,m,60,b[m]instanceof BABYLON.Vector3?BABYLON.Animation.ANIMATIONTYPE_VECTOR3:BABYLON.Animation.ANIMATIONTYPE_FLOAT,BABYLON.Animation.ANIMATIONLOOPMODE_CONSTANT),q=[],r=(k==h.linear?2:Math.max(2,f/40))>>0,s=r;s--;){n=s/(r-1);var t=0===n?0:1===n?1:k(n);switch(p.dataType){case BABYLON.Animation.ANIMATIONTYPE_VECTOR3:o=p.vector3InterpolateFunction(b[m],c[m],t);break;case BABYLON.Animation.ANIMATIONTYPE_FLOAT:o=p.floatInterpolateFunction(b[m],c[m],t)}q.unshift({frame:100*n,value:o})}p.setKeys(q),l.push(p)}if(.1>f)return new d(l,a);a.animations=a.animations.concat(l);var u=new d(l,a);u._callBack=g;var v=100/60/(f/1e3);if(a.getScene().beginAnimation(a,0,100,!1,v,u._onAnimationEnd.bind(u)),j){var w=function(){ujs.notify("hcs.engine3D.camera.move")},x=a.getScene();x.registerBeforeRender(w),u._moreCleanUp=function(){x.unregisterBeforeRender(w),w=null}}return u},b}();var hcs=window.hcs||{};hcs.DragControls=function(a,b,c,d){function e(b){if(o.enabled){b.preventDefault();var c=a.createPickingRay(b.clientX,b.clientY);if(o.enabled&&h){var d,e=c.distanceToPlane(q);_xyz.length>1?(d=c.direction.scale(e),d.addInPlace(c.origin),d.subtractInPlace(i)):(d=c.direction.scale(h.distance),d.addInPlace(c.origin),d.subtractInPlace(i));var f=h.pickedMesh.parent?h.pickedMesh.parent.getWorldMatrix().clone():BABYLON.Matrix.Identity();f.invert(),d=BABYLON.Vector3.TransformCoordinates(d,f),j.copyFrom(h.pickedMesh.position),v&&(h.pickedMesh.position.x=d.x),w&&(h.pickedMesh.position.y=d.y),x&&(h.pickedMesh.position.z=d.z),h.pickedMesh.computeWorldMatrix(!0);var g=h.pickedMesh.getFloor();return g&&g.markAsDirty(),ujs.notify("hcs.engine3d.dragcontrols.start",{selected:h}),y("drag",h),void(l===!1?l=0:0===l&&(l=!0))}ujs.notify("hcs.engine3d.dragcontrols.move"),l=!1}}function f(d){if(o.enabled){if(d.preventDefault(),0===d.button){var e=a.createPickingRay(d.clientX,d.clientY),f=e.intersectMeshes(a.meshes,!0,!0);if(f&&-1==c.indexOf(f.pickedMesh.getTopLevelObject(n))&&(f=null),f&&f.hit){if(p&&-1===f.pickedMesh.name.indexOf("_girl"))return;console.warn("TODO : moveObject() de l'edition component pour avoir le magnetisme en event"),h=f,h.pickedMesh=h.pickedMesh.getTopLevelObject(n),q=new BABYLON.Plane(0,1,0,-h.pickedPoint.y);var g=h.pickedMesh.parent?h.pickedMesh.parent.getWorldMatrix().clone():BABYLON.Matrix.Identity(),j=g.clone();return j.invert(),i.copyFrom(BABYLON.Vector3.TransformCoordinates(h.pickedPoint,j)).subtractInPlace(h.pickedMesh.position),i.copyFrom(BABYLON.Vector3.TransformNormal(i,g)),b.style.cursor="move",y("dragstart",h),void y("mousedown",h)}}y("mousedown",{hit:!1})}}function g(a){if(o.enabled){a.preventDefault();var c=!1;ujs.notify("hcs.engine3d.dragcontrols.end",{selected:h}),h&&1==l?(l=!1,c=!0,y("dragend",h),h=null):h&&(h=null),b.style.cursor="auto",y("mouseup",{dragged:c})}}var h,c=c||[],i=new BABYLON.Vector3,j=new BABYLON.Vector3,k=(new BABYLON.Vector2,new BABYLON.Vector2),l=!1,m=1;this.GROUPS=0,this.OBJECTS=1;var n=this.GROUPS,o=this,d=d||{},p=!1,k=(d.offsets||{x:0,y:0},{width:d.width||b.width,height:d.height||b.height}),q=new BABYLON.Plane(0,1,0,0),r=!1,s=function(){r||(b.addEventListener("pointermove",e,!1),b.addEventListener("pointerdown",f,!1),b.addEventListener("pointerup",g,!1),r=!0)},t=function(){r&&(b.removeEventListener("pointermove",e),b.removeEventListener("pointerdown",f),b.removeEventListener("pointerup",g),r=!1)};this.enabled=!0;var u={};s(),this.setHardwareScaling=function(a){m=a},this.setDomElement=function(a){t(),b=a,s()},this.setDraggingMode=function(a){n=a},this.startEventsListening=function(){s()},this.stopEventListening=function(){t()},this.on=function(a,b){return u[a]||(u[a]=[]),u[a].push(b),o},this.off=function(a,b){var c=u[a];return c?(c.indexOf(b)>-1&&c.splice(b,1),o):o},this.lock=function(){p=!0},this.unlock=function(){p=!1};var v,w,x,y=function(a,b,c){var d=u[a];if(d&&!c)for(var e=0;e<d.length;e++)d[e](b)};v=w=x=!0,this.constrains=function(a){return void 0===a&&(a="xyz"),_xyz=a,v=w=x=!1,a.indexOf("x")>-1&&(v=!0),a.indexOf("y")>-1&&(w=!0),a.indexOf("z")>-1&&(x=!0),this},this.addDraggable=function(a){a.traverse(function(a){c.push(a)})},this.addUnremovableDraggable=function(a){a.traverse(function(a){a._unremovableDraggable=!0,c.push(a)})},this.removeDraggable=function(a){var b=-1;a.traverse(function(a){a._unremovableDraggable||(b=c.indexOf(a),c.splice(b,1))})},this.resetDraggable=function(){var a=this;c.forEach(function(b){a.removeDraggable(b)})},this.onDocumentResize=function(){k={width:window.innerWidth,height:window.innerHeight}},this.setScreenSize=function(a,b){k={width:a,height:b}},this.setSelectedObject=function(a){h.pickedMesh=a,i.copyFrom(h.pickedPoint).subtractInPlace(h.pickedMesh.position)},this.reset=function(){h=!1},this.refreshReferentPlane=function(){var a=0;h&&(a=-h.pickedPoint.y),q=new BABYLON.Plane(0,1,0,a)}};var hcs=window.hcs||{};hcs.Box3=function(){var a=function(){this.min=null,this.max=null,this.angle=0,this.customData={}};return a.prototype.center=function(){return BABYLON.Vector3.Lerp(this.min,this.max,.5)},a.prototype.serialize=function(){var a=ujs.serializeObject(this,!0);return a["class"]={name:"hcs.Box3"},a},a.prototype.deserialize=function(a){return this.min=new BABYLON.Vector3(a.min.x,a.min.y,a.min.z),this.max=new BABYLON.Vector3(a.max.x,a.max.y,a.max.z),this.angle=a.angle,this.customData=ujs.deserializeObject(a.customData),this},a.Deserialize=function(b){if(!b)return null;var c=new a;return ujs.deserializeObject(b,this),c},a}();var MaterialInfo=function(){var a=function(a){this.boundingBox=null,this.normal=null,this.center=null,this.material=a||null,this.customData=null};return a.prototype.serialize=function(){var a={};return a["class"]={name:"MaterialInfo"},ujs.serializeObject(this,a),a},a.prototype.deserialize=function(a){return ujs.deserializeObject(a,this),this},a.Deserialize=function(b){var c=new a;return c.deserialize(b)},a.MakeFromPane=function(b,c){var d=new a(c);return d.normal=b.normal(),d.center=b.center(),d},a.prototype.matchBestBoundingBox=function(a){if(!this.boundingBox)return null;for(var b,c=1/0,d=null,e=0,f=a.length;f>e;e++)b=this.boundingBox.match(a[e]),c>b&&(c=b,d=e);return d},a}(),hcs=window.hcs||{};hcs.UI=hcs.UI||{},hcs.UI.FormBuilder=function(){function a(a){a.target.parentNode.children[1].value=this.value}function b(a){var b=(a.target.parentNode.children[0],+this.min),c=+this.max;+this.value>c?this.value=c:+this.value<b&&(this.value=b),a.target.parentNode.children[0].value=this.value}var c=0,d=function(a){this.itemsContainer="string"==typeof a?document.getElementById(a):a};return d.prototype.updateProperties=function(a){this.itemsContainer.innerHTML="";for(var b in a){var c=null;switch(a[b].type){case"button":c=this.createButtonItem(a[b].label,a[b].value,a[b].eventParams,a[b].id);break;case"buttons":c=this.createButtonsItem(a[b].items,a[b].id);break;case"checkbox":c=this.createCheckboxItem(a[b].label,a[b].eventParams,a[b].value,a[b].unit,a[b].id);break;case"html":c=this.createHTMLItem(a[b].html);break;case"number":c=this.createSliderItem(a[b].label,a[b].eventParams,a[b].value,"number",a[b].unit,a[b].id);break;case"radio":c=this.createRadioItem(a[b].label,a[b].eventParams,a[b].groupName,a[b].isSelected,a[b].id);break;case"separator":c=this.createSeparatorItem(a[b].label);break;case"select":c=this.createSelectItem(a[b].label,a[b].eventParams,a[b].namesValues,a[b].selectedKey);break;case"slider":c=this.createSliderItem(a[b].label,a[b].eventParams,a[b].value,"range",a[b].unit,a[b].id);break;case"spacer":c=this.createSpacerItem();break;case"text":case"password":c=this.createInputTextItem(a[b].label,a[b].eventParams,a[b].value,a[b].unit,a[b].type,a[b].id)}if(null!==c){if(a[b]["class"])for(var d=a[b]["class"].split(" "),e=0;e<d.length;e++)c.classList.add(d[e]);c.setAttribute("id",a[b].id||"item-"+b),this.itemsContainer.appendChild(c)}}},d.prototype.onItemAction=function(){var a=JSON.parse(this.getAttribute("event-params")),b=this.getAttribute("rel");this instanceof HTMLInputElement?a.value="checkbox"==this.type?this.checked?!0:!1:"int"==a.cast?parseInt(this.value,10):"float"==a.cast?parseFloat(this.value):"bool"==a.cast||"boolean"==a.cast?this.value?!0:!1:this.value:this instanceof HTMLSelectElement&&(a.value="int"===a.cast?+this.value:"float"===a.cast?+this.value:this.value),ujs.notify(b,a)},d.prototype.createSelectItem=function(a,b,d,e){var f=document.createElement("li");f.setAttribute("class","param-item");var g=document.createElement("label");g.innerHTML=" "+a,f.appendChild(g);var h=document.createElement("span");h.setAttribute("class","field");var i=document.createElement("select");i.setAttribute("event-params",JSON.stringify(b)),i.setAttribute("rel",b.eventName);for(var j=null,k=0,l=d.length;l>k;k++)j=document.createElement("option"),j.setAttribute("value",d[k].value),j.innerHTML=d[k].text,i.appendChild(j),d[k].value===e&&j.setAttribute("selected","selected");return i.addEventListener("change",this.onItemAction,!1),h.appendChild(i),f.appendChild(h),c++,f},d.prototype.createSliderItem=function(c,d,e,f,g){var f=f||"range";e.step=e.step||1;var h=document.createElement("li");h.setAttribute("class","param-item");var i=document.createElement("label");i.innerHTML=c;var j=document.createElement("span");j.setAttribute("class","field");var k=document.createElement("input");k.setAttribute("type",f),k.setAttribute("min",e.min),k.setAttribute("max",e.max),k.setAttribute("value",e.value),k.setAttribute("step",e.step),k.setAttribute("event-params",JSON.stringify(d)),k.setAttribute("rel",d.eventName);var l="";if("range"==f&&(l+=" input-range"),g&&(l+=" unit"),""!=l&&k.setAttribute("class",l),"range"==f&&k.addEventListener("input",this.onItemAction,!1),k.addEventListener("change",this.onItemAction,!1),k.addEventListener("keydown",function(a){a.stopPropagation()},!1),j.appendChild(k),"range"==f){var m=document.createElement("input");m.setAttribute("type","number"),g&&m.setAttribute("class","unit"),m.setAttribute("min",e.min),m.setAttribute("max",e.max),m.setAttribute("value",e.value),m.setAttribute("step",e.step),m.setAttribute("event-params",JSON.stringify(d)),m.setAttribute("rel",d.eventName),m.addEventListener("change",this.onItemAction,!1),m.addEventListener("blur",b,!1),j.appendChild(m),k.addEventListener("input",a,!1),k.addEventListener("change",a,!1),m.addEventListener("keydown",function(a){a.stopPropagation()},!1)}var n=document.createElement("span");return g&&(n.innerHTML=g,n.setAttribute("class","unit")),j.appendChild(n),h.appendChild(i),h.appendChild(j),h},d.prototype.createInputTextItem=function(a,b,d,e,f,g){var h=document.createElement("li");h.setAttribute("class","param-item");var i=document.createElement("label");i.setAttribute("for",g||"formBuilderCB_"+c),i.innerHTML=a,h.appendChild(i);var j=document.createElement("span");j.setAttribute("class","field");var k=document.createElement("input");k.setAttribute("id",i.getAttribute("for"));var l="string"==typeof f?f:"text";k.setAttribute("type",l),k.setAttribute("value",d),"function"==typeof b?k.addEventListener("change",b,!1):b&&(k.setAttribute("event-params",JSON.stringify(b)),k.setAttribute("rel",b.eventName),k.addEventListener("change",this.onItemAction,!1)),k.addEventListener("keydown",function(a){a.stopPropagation()},!1),j.appendChild(k);var m=document.createElement("span");return e&&(m.innerHTML=e,m.setAttribute("class","unit")),j.appendChild(m),h.appendChild(j),c++,h},d.prototype.createCheckboxItem=function(a,b,d,e,f){var g=document.createElement("li");g.setAttribute("class","param-item");var h=document.createElement("label");h.setAttribute("for",f||"formBuilderCB_"+c),h.innerHTML=" "+a,g.appendChild(h);var i=document.createElement("span");i.setAttribute("class","field");var j=document.createElement("input");j.setAttribute("type","checkbox"),j.setAttribute("id",h.getAttribute("for")),j.setAttribute("class","cb-switch"),d&&j.setAttribute("checked","checked"),"function"==typeof b?j.addEventListener("click",b,!1):b&&(j.setAttribute("event-params",JSON.stringify(b)),j.setAttribute("rel",b.eventName),j.addEventListener("click",this.onItemAction,!1)),i.appendChild(j);var k=document.createElement("span");return e&&(k.innerHTML=e,k.setAttribute("class","unit")),i.appendChild(k),g.appendChild(i),c++,g},d.prototype.createButtonItem=function(a,b,d,e,f){var g=document.createElement("li");g.setAttribute("class","param-item");var h=document.createElement("label");h.setAttribute("for",f||"formBuilderBT_"+c),h.innerHTML=a,g.appendChild(h);var i=document.createElement("span");i.setAttribute("class","field");var j=document.createElement("button");j.innerHTML=b,j.setAttribute("id",h.getAttribute("for")),j.setAttribute("event-params",JSON.stringify(d)),j.setAttribute("rel",d.eventName),"function"==typeof d?j.addEventListener("click",d,!1):d&&j.addEventListener("click",this.onItemAction,!1),i.appendChild(j);var k=document.createElement("span");return e&&(k.innerHTML=e,k.setAttribute("class","unit")),i.appendChild(k),g.appendChild(i),c++,g},d.prototype.createButtonsItem=function(a){var b=document.createElement("li");b.setAttribute("class","param-item");var c=a.length,d=document.createElement("label");d.innerHTML=" "+labelParams,b.appendChild(d);var e=document.createElement("span");e.setAttribute("class","field");var f=document.createElement("div");f.setAttribute("class","stacked_"+c),e.appendChild(f);for(var g=0,h=c;h>g;g++){var i=document.createElement("button");i.innerHTML=a[g].value,i.setAttribute("event-params",JSON.stringify(a[g].eventParams)),i.setAttribute("rel",a[g].eventParams.eventName),i.addEventListener("click",this.onItemAction,!1),f.appendChild(i)}var j=document.createElement("span");return unit&&(j.innerHTML=unit,j.setAttribute("class","unit")),e.appendChild(j),b.appendChild(e),b},d.prototype.createSpacerItem=function(){var a=this.createHTMLItem("");return a.children[0].setAttribute("class","spacer"),a},d.prototype.createHTMLItem=function(a){var b=document.createElement("li");b.setAttribute("class","param-item");var c=document.createElement("div");return c.innerHTML=a,b.appendChild(c),b},d.prototype.createSeparatorItem=function(a){var b=document.createElement("li");b.setAttribute("class","separator");var c=document.createElement("label");c.innerHTML="undefined"!=typeof a?a:"",b.appendChild(c);var d=document.createElement("span");d.setAttribute("class","field"),b.appendChild(d);var e=document.createElement("hr");return d.appendChild(e),b},d.prototype.createRadioItem=function(a,b,d,e,f){var g=document.createElement("li");g.setAttribute("class","param-item");var h=document.createElement("label");h.setAttribute("for",f||"formBuilderRD_"+c),h.innerHTML=a,g.appendChild(h);var i=document.createElement("span");i.setAttribute("class","field");var j=document.createElement("input");return j.setAttribute("id",h.getAttribute("for")),j.setAttribute("name",d),j.setAttribute("type","radio"),e&&j.setAttribute("checked","checked"),"function"==typeof b?j.addEventListener("click",b,!1):b&&(j.addEventListener("click",this.onItemAction,!1),j.setAttribute("rel",b.eventName),j.setAttribute("event-params",JSON.stringify(b))),i.appendChild(j),g.appendChild(i),c++,g},d}();var hcs=window.hcs||{};hcs.UI=hcs.UI||{},hcs.UI.Frame=function(){function a(a){if(a.touches&&a.touches.length){a.preventDefault();var b=a.touches[0];a.x=b.x||b.screenX||b.pageX||b.clientx,a.y=b.y||b.screenY||b.pageY||b.clientY}return a}function b(a){var b=a.target.getAttribute("rel");""!=b&&ujs.notify(b)}function c(a,b,c){var d=document.createElement(a);return c&&d.setAttribute("id",c),b&&d.setAttribute("class",b),d}var d=function(a,b,c){this.activeTab=0,this.eventStarted=!1,this.config=a||{},this.content=b||{},this.parentNode=c||document.getElementById("modalWidgets")||document.body,this.domElement=null,this.mouseState={x:0,y:0,prevX:0,prevY:0,deltaX:0,deltaY:0,click:!1},this.windowPosition={x:0,y:0},this.menuDOM=document.getElementById("mainMenu"),this.windowSize={width:this.config.width||640,height:this.config.height||480,maxWidth:this.config.maxWidth||1980,maxHeight:this.config.maxHeight||1080,minWidth:this.config.minWidth||320,minHeight:this.config.minHeight||240},this.formBuilder=new hcs.UI.FormBuilder,this.initialized=!1};return d.prototype.initialize=function(){this.initialized||(this.buildHTML(),this.adapteSize(),this.initializeEvents(),this.parentNode.appendChild(this.domElement),this.initialized=!0)},d.prototype.resetSize=function(a){this.windowSize={width:a.width||640,height:a.height||480},a.autoSize?(this.domElement.style.removeProperty("width"),this.domElement.style.removeProperty("height")):(this.domElement.style.width=this.windowSize.width+"px",this.domElement.style.height=this.windowSize.height+"px")},d.prototype.adapteSize=function(){this.windowSize.width=Math.min(this.windowSize.width,this.windowSize.maxWidth),this.windowSize.height=Math.min(this.windowSize.height,this.windowSize.maxHeight),this.windowSize.width=Math.max(this.windowSize.width,this.windowSize.minWidth),this.windowSize.height=Math.max(this.windowSize.height,this.windowSize.minHeight),this.config.autoSize||(this.domElement.style.width=this.windowSize.width+"px",this.domElement.style.height=this.windowSize.height+"px")},d.prototype.buildHeaderTitle=function(a){if(this.headerTitle.innerHTML="",this.config.headerIcon){var b=c("img","window-title-icon");b.setAttribute("src",this.config.headerIcon),this.headerTitle.appendChild(b)}var d=c("span","window-title-text");d.innerHTML=a||"Title",this.headerTitle.appendChild(d)},d.prototype.buildHTML=function(){var a=this.config.layout||"horizontal";this.domElement=c("div","window"),this.header=c("header","window-title"),this.closeWindow=c("span","window-close"),this.config.showCloseButton===!1&&(this.closeWindow.style.display="none"),this.header.appendChild(this.closeWindow),this.headerTitle=c("h1"),this.buildHeaderTitle(this.content.title),this.header.appendChild(this.headerTitle),this.domElement.appendChild(this.header),this.mainContent=c("div","window-content"),this.domElement.appendChild(this.mainContent),this.tabsContainer=c("div","tabbed "+a),this.tabs=c("ul","tabbed-tabs"),this.tabsContainer.appendChild(this.tabs),this.tabContent=c("div","tabbed-tabcontent"),this.tabsContainer.appendChild(this.tabContent),this.mainContent.appendChild(this.tabsContainer),this.actionBar=c("div","window-action-bar"),this.domElement.appendChild(this.actionBar)},d.prototype.setTitle=function(a){this.headerTitle.innerHTML=a},d.prototype.setContent=function(a,b){var b="number"==typeof b?b:0;b=b>=this.tabs.children.length?this.tabs.children.length-1:b,a instanceof HTMLElement?(this.tabContent.children[b].innerHTML="",this.tabContent.children[b].appendChild(a)):this.tabContent.children[b].innerHTML=a},d.prototype.addTab=function(a,b,d){var e=c("li");e.addEventListener("click",this.onTabClick.bind(this),!1),e.setAttribute("rel","tab-"+this.tabs.children.length);var f=c("span","tab-text");if(f.innerHTML=a,e.appendChild(f),b){var g=c("span","tab-icon"),b=c("img","tab-icon");b.setAttribute("src",b),g.appendChild(b),e.appendChild(g)}this.tabs.appendChild(e);var h=c("section","tab-content-"+(this.tabs.children.length-1));d instanceof HTMLElement?h.appendChild(d):h.innerHTML=d,this.tabContent.appendChild(h)},d.prototype.setLayout=function(a){this.domElement.classList.remove("horizontal","vertical"),this.domElement.classList.add(a)},d.prototype.clear=function(a){var a=a||{tabs:!0,content:!0,actionBar:!0};a.tabs&&(this.tabs.innerHTML=""),a.content&&(this.tabContent.innerHTML=""),a.actionBar&&(this.actionBar.innerHTML="")},d.prototype.addForm=function(a,b,d){if(!this.tabContent.children.length||this.tabContent.children.length<=a){var d=d||"Tab "+this.tabContent.children.length;this.addTab(d,void 0,void 0,!0),a=this.tabs.children.length-1}var e=this.tabContent.children[a];e.innerHTML="";var f=c("ul");e.appendChild(f),this.formBuilder.itemsContainer=f,this.formBuilder.updateProperties(b)},d.prototype.setActionBar=function(a){if(this.actionBar.children.length)for(var d=this.actionBar.children.length-1;d>0;d--)this.actionBar.children[d].removeEventListener("click",b),this.actionBar.removeChild(this.actionBar.children[d]);if("string"==typeof element)this.actionBar.innerHTML=a;else for(var d=0,e=a.length;e>d;d++){var f=c("button");f.innerHTML=a[d].label,"function"!=typeof a[d].action?(f.setAttribute("rel",a[d].action),f.addEventListener("click",b,!1)):(f.setAttribute("rel",""),f.addEventListener("click",a[d].action,!1)),a[d].title&&f.setAttribute("title",a[d].title),a[d]["class"]&&f.setAttribute("class",a[d]["class"]),this.actionBar.appendChild(f)}this.domElement.classList.add("window-with-button")},d.prototype.showContent=function(a){this.tabs.children[this.activeTab]&&(this.tabs.children[this.activeTab].classList.remove("active"),this.tabContent.children[this.activeTab].classList.remove("active")),this.activeTab=a,this.activeTab=this.tabs.children[this.activeTab]?this.activeTab:0,this.tabs.children[this.activeTab].classList.add("active"),this.tabContent.children[this.activeTab].classList.add("active")},d.prototype.show=function(a,b){this.initialize(),this.domElement.style.display="block",this.tabs.children.length<2?this.tabsContainer.classList.add("notab"):this.tabsContainer.classList.remove("notab"),this.showContent(this.activeTab),"undefined"!=typeof a&&"undefined"!=typeof b?(a+this.domElement.offsetWidth>window.innerWidth&&(a=window.innerWidth-this.domElement.offsetWidth-5,0>a&&(a=0)),b+this.domElement.offsetHeight>window.innerHeight&&(b=window.innerHeight-this.domElement.offsetHeight-5,0>b&&(b=0)),this.setPosition(a,b)):this.centerWindow()},d.prototype.close=function(){ujs.notify("hcs.ui.frame.close"),this.domElement.style.display="none"},d.prototype.centerWindow=function(){this.windowPosition.x=(window.innerWidth-this.menuDOM.offsetWidth)/2-this.windowSize.width/2,this.windowPosition.y=window.innerHeight/2-this.windowSize.height/2,this.domElement.style.position="absolute",this.config.autoSize||(this.domElement.style.width=this.windowSize.width+"px",this.domElement.style.height=this.windowSize.height+"px"),this.domElement.style.top=this.windowPosition.y+"px",this.domElement.style.left=this.windowPosition.x+"px"},d.prototype.setPosition=function(a,b){this.windowPosition.x=a,this.windowPosition.y=b,this.domElement.style.top=this.windowPosition.y+"px",this.domElement.style.left=this.windowPosition.x+"px"},d.prototype.resetMouseState=function(){this.mouseState.click=!1,this.mouseState.prevX=0,this.mouseState.prevY=0,this.mouseState.x=0,this.mouseState.y=0,this.mouseState.deltaX=0,this.mouseState.deltaY=0},d.prototype.onHeaderMouseDown=function(b){a(b),this.mouseState.click=!0,this.mouseState.x=b.x||b.screenX,this.mouseState.y=b.y||b.screenY},d.prototype.onHeaderMouseUp=function(){this.resetMouseState()},d.prototype.onHeaderMouseMove=function(b){this.mouseState.click&&(a(b),this.mouseState.prevX=this.mouseState.x,this.mouseState.prevY=this.mouseState.y,this.mouseState.x=b.x||b.screenX||this.mouseState.prevX,this.mouseState.y=b.y||b.screenY||this.mouseState.prevY,this.mouseState.deltaX=this.mouseState.x-this.mouseState.prevX,this.mouseState.deltaY=this.mouseState.y-this.mouseState.prevY,this.windowPosition.x+=this.mouseState.deltaX,this.windowPosition.y+=this.mouseState.deltaY,this.domElement.style.top=this.windowPosition.y+"px",this.domElement.style.left=this.windowPosition.x+"px")},d.prototype.initializeEvents=function(){this.eventStated||(this.closeWindow.addEventListener("click",this.close.bind(this),!1),this.closeWindow.addEventListener("touchstart",this.close.bind(this),!1),this.header.addEventListener("mousedown",this.onHeaderMouseDown.bind(this),!1),document.body.addEventListener("mouseup",this.onHeaderMouseUp.bind(this),!1),document.body.addEventListener("mousemove",this.onHeaderMouseMove.bind(this),!1),this.header.addEventListener("touchstart",this.onHeaderMouseDown.bind(this),!1),document.body.addEventListener("touchmove",this.onHeaderMouseMove.bind(this),!1),document.body.addEventListener("touchend",this.onHeaderMouseUp.bind(this),!1),document.body.addEventListener("touchcancel",this.onHeaderMouseUp.bind(this),!1),document.addEventListener("hcs.request.closePopup",this.close.bind(this),!1),this.eventStated=!0)},d.prototype.onTabClick=function(a){var b=a.target.parentNode;a.target.classList.contains("counter")?b=a.target.parentNode.parentNode:"LI"==a.target.nodeName&&(b=a.target);var c=b.getAttribute("rel").split("-")[1];c!=this.activeTab&&this.showContent(c)},d.prototype.getDivNode=function(a){var b=a;return"DIV"!=b.nodeName&&(b=this.getDivNode(a.parentNode)),b},d}();var hcs=window.hcs||{};hcs.UI=hcs.UI||{},hcs.UI.ProductList=function(){function a(b){var c={};for(var d in b)c[d]=b[d]instanceof Object?a(b[d]):b[d];return c}var b=null,c=[],d=[],e=!1,f=function(a,c){hcs.UI.Frame.call(this,{layout:"vertical",headerIcon:"images/productIconTitle.png"},{title:_("物品列表")}),this.windowSize.maxWidth=window.innerWidth,this.windowSize.maxHeight=window.innerHeight,this.windowSize.width=(window.innerWidth-this.menuDOM.offsetWidth)/1.5,this.windowSize.height=window.innerHeight/1.5,_randomGET=c,this.core=a,null==b&&(b=this,b.initProductList(function(){e=!0}),b.initialize())};return f.prototype=new hcs.UI.Frame,f.prototype.initialize=function(){hcs.UI.Frame.prototype.initialize.call(this),this.domElement.setAttribute("id","productList")},f.prototype.initProductList=function(a){var a=a||function(){};xmlHttp=new XMLHttpRequest,xmlHttp.open("GET",hcs.Constants.PRODUCTS_FILE,!1),xmlHttp.send(null),c=JSON.parse(xmlHttp.responseText),a.call(b)},f.prototype.addProduct=function(a,b){var c=document.createElement("div");c.setAttribute("class","product-item"),c.setAttribute("rel",a.id);var d="models/previews/productsPlaceholder.png";a.preview&&(d=hcs.Constants.PRODUCTS_PREVIEWS+a.preview);var e=document.createElement("span");e.setAttribute("class","selected"),e.innerHTML=_("添加"),c.appendChild(e);var f=document.createElement("span");f.setAttribute("class","product-item-image");var g=document.createElement("img");g.setAttribute("src",d),f.addEventListener("click",this.onMenuItemButtonClick,!1),f.appendChild(g),c.appendChild(f);var h=document.createElement("span");h.setAttribute("class","product-item-description"),h.setAttribute("rel",[a.action,"_",a.id].join(""));var i=a.translations?_(a.title,a.translations):_(a.title);h.innerHTML=i,c.appendChild(h),b.appendChild(c)},f.prototype.loadProducts=function(a,f,g){if(e===!0){f.innerHTML="";for(var h in c)if(c[h].id==a){d=c[h].items;for(var i=0;i<d.length;i++)b.addProduct(d[i],f);b.getTabsForFilters(g)}}else b.initProductList(function(){e=!0,b.loadProducts(a,f,g),b.show()})},f.prototype.getTabsForFilter=function(a){var c=a.split(":")[1]?a.split(":")[1]:null,a=a.split(":")[0],e={};c&&(e[c]=document.createElement("div"));for(var f in d){var g=d[f],h=g.params?JSON.parse(g.params.params)||{}:{},i=ujs.getProperty(h,a);i&&-1==Object.keys(e).indexOf(i.toString())&&(e[i]=document.createElement("div")),i?b.addProduct(g,e[i]):b.addProduct(g,e[c])}for(var j in e)b.addTab(_(a)+" "+j,null,e[j],!0)},f.prototype.getTabsForFilters=function(a){if(a)for(var b=a.split(","),c=0;c<b.length;c++)this.getTabsForFilter(b[c])
},f.prototype.reinitContent=function(a){b.tabs.innerHTML="",b.tabContent.innerHTML="";var c=document.createElement("div");c.innerHTML=_("正在加载 ..."),b.addTab("",null,"",!0),b.addTab(_("全部"),null,c,!0),b.loadProducts(a.id,c,a.filter),b.showContent(1)},f.show=function(a,c,d){var d=d||{};null===b&&(b=new hcs.UI.ProductList(a,c)),b.reinitContent(d),b.buildHeaderTitle(b.content.title+" > "+d.name),b.show()},f.close=function(){null!==b&&b.close()},f.prototype.close=function(){ujs.notify("hcs.ui.frame.close"),this.domElement.style.display="none",ujs.notify("hcs.menu.main.deselect")},f.prototype.onMenuItemButtonClick=function(c){var e=b.getDivNode(c.target),f=e.getAttribute("rel"),g=d[0],h=e.children[0];h.classList.add("show");for(var i=setInterval(function(){h.classList.remove("show"),clearInterval(i)},1500),j=0;j<d.length;j++)f==d[j].id&&(g=a(d[j]));var k=g.action,l=g.type,m=g.params,n=f;""!=k&&"string"==typeof l&&ujs.notify(k,{objectId:n,objectType:l,objectParams:m},!0)},f}();var hcs=window.hcs||{};hcs.UI=hcs.UI||{},hcs.UI.ContextMenu=function(){var a=null,b=!1,c=null,d={x:!1,y:!1},e=function(b){var b=b||{};b.autoSize=b.autoSize===!1?!1:!0,hcs.UI.Frame.call(this,b),null==a&&(a=this)};return e.prototype=new hcs.UI.Frame,e.prototype.initialize=function(){hcs.UI.Frame.prototype.initialize.call(this),this.domElement.id="contextMenu"},e.prototype.show=function(a,c,d,e){hcs.UI.Frame.prototype.show.call(this,a,c),this.menuName=d,b=!0,ujs.notify("hcs.widget.contextMenu.opened"),ujs.notify("hcs.widget.contextMenu."+this.menuName+".opened",e)},e.prototype.close=function(){b&&(hcs.UI.Frame.prototype.close.call(this),b=!1,null!==c&&(clearInterval(c),c=null),d={x:this.windowPosition.x,y:this.windowPosition.y},ujs.notify("hcs.widget.contextMenu.closed"),ujs.notify("hcs.widget.contextMenu."+this.menuName+".closed"))},e.isOpen=function(){return b},e.show=function(e,f,g,h,i){var e=e||{};e.width=e.width||250,e.height=e.height||!1,e.x=e.x||d.x||window.innerWidth/2-e.width/2,e.y=e.y||d.y||window.innerHeight/2-e.height/2,e.title=e.title||"参数",e.layout=e.layout||"horizontal",e.autoSize=e.autoSize===!1?!1:!0;var j=e.menuName||e.title.replace(/ /g,"_");null==a&&(a=new hcs.UI.ContextMenu(e,{title:e.title}),a.initialize()),e.id&&a.domElement.setAttribute("id",e.id);var k=function(){a.clear(),a.setTitle(e.title);for(var b=0,c=f.length;c>b;b++)a.addForm(b,f[b].content,f[b].title);g&&a.setActionBar(g),e.showIndex>-1&&a.showContent(e.showIndex),a.setLayout(e.layout||"horizontal"),a.resetSize(e),a.show(e.x,e.y,j,i)};"number"==typeof h?c=setTimeout(function(){k(),clearTimeout(c),c=null},h):k(),b=!0},e.close=function(){null!==a&&(d={x:a.windowPosition.x,y:a.windowPosition.y},a.close(),b=!1)},e.setPosition=function(b,c){null!==a&&a.setPosition(b,c)},e.getPosition=function(){return null===a?null:{x:a.windowPosition.x,y:a.windowPosition.y}},e.update=function(b){if(null===a)return null;for(var c=b.length;c--;)for(var d=b[c].content.length;d--;){var e=b[c].content[d];if(e)switch(e.type){case"number":case"text":case"checkbox":case"slider":var f=a.domElement.querySelectorAll("li#"+e.id+".param-item");if(!f||1!=f.length)continue;f=f[0];for(var g=f.querySelectorAll("input"),h="object"==typeof e.value?e.value.value:e.value,i=g.length;i--;)g[i].value=h}}},e}();var hcs=window.hcs||{};hcs.UI=hcs.UI||{},hcs.UI.AboutWindow=function(){var a=function(){var a={minWidth:500};a.autoSize=a.autoSize===!1?!1:!0,hcs.UI.Frame.call(this,a),this.initialize(),this.domElement.setAttribute("id","aboutWindow"),this.setTitle(_("About Wanaplan")),this.close();var b='<div style="width: 432px; text-align: center;"><img src="./images/hcsdesign-logo.png" alt="Wanaplan" /></div>';b+='<div style="text-align: center; font-size: 16pt; font-weight: bold; margin-top: 15px; color: #333;">Wanaplan '+hcsdesign.version+"</div>",b+='<div style="text-align: center; margin-top: 30px; color: #555;">Copyright © 2012-2014 Wanadev, all rights reserved.</div>',b+='<div style="text-align: center; margin-top: 10px;"><a href="http://www.wanadev.fr/" target="_blank">www.wanadev.fr</a> / <a href="http://www.hcsdesign.com/" target="_blank">www.hcsdesign.com</a></div>',this.addTab(_("About"),null,b,!0),b='<div class="scrollable-content" style="width: 410px; max-height: 300px; min-height: 100px; font-size: 9pt;"><ul>',b+='<li><strong>"seamless" textures:</strong><dl><dt>Author:</dt><dd>~hhh316 Giles</dd><dt>License:</dt><dd>cc-by 3.0</dd><dt>Downloaded from:</dt><dd><a href="http://seamless-pixels.blogspot.fr/"> http://seamless-pixels.blogspot.fr/</a></dd></dl></li>',b+='<li><strong>Babylonjs engine:</strong><dl><dt>Authors:</dt><dd>David Catuhe & David Rousset</dd><dt>Licence:</dt><dd>Apache License 2.0</dd><dt>Homepage:</dt><dd><a href="http://www.babylonjs.com">http://www.babylonjs.com</a></dd></dl></li>',b+="</ul></div>",this.addTab(_("Credits"),null,b,!0),this.setActionBar([{label:_("Close"),action:function(){this.close()}.bind(this)}]),document.addEventListener("hcs.ui.showAboutWindow",function(){this.show(),ujs.notify("hcs.menu.top.deselect")}.bind(this),!1)};return a.prototype=new hcs.UI.Frame,a}();var hcs=window.hcs||{};hcs.UI=hcs.UI||{},hcs.UI.BackgroundPopup=function(){function a(a,b,c){var d=document.createElement(a);return c&&d.setAttribute("id",c),b&&d.setAttribute("class",b),d}function b(a){if(!a.hasOwnProperty("offsetX")){var b=curtop=0;if(a.currentTarget){var c=a.currentTarget;do b+=c.offsetLeft,curtop+=c.offsetTop;while(c=c.offsetParent)}a.offsetX=a.clientX-b,a.offsetY=a.clientY-curtop}return a}var c,d=null,e=100,f=!0,g=560,h=320,i=1,j=new BABYLON.Vector2(0,0),k=new BABYLON.Vector2(0,0),l=!1,m=1,n=[new BABYLON.Vector2(10,10),new BABYLON.Vector2(100,10)],o=function(a){var a=a||{};a.autoSize=a.autoSize===!1?!1:!0,a.width=600,a.height=540,hcs.UI.Frame.call(this,a)};return o.prototype=new hcs.UI.Frame,o.prototype.buildHTML=function(){this.config.layout||"horizontal",this.domElement=a("div","window","backgroundPopup"),this.header=a("header","window-title"),this.closeWindow=a("span","window-close"),this.config.showCloseButton===!1&&(this.closeWindow.style.display="none"),this.header.appendChild(this.closeWindow),this.headerTitle=a("h1");var b=a("span","window-title-text");b.innerHTML=this.content.title||_("Choose and set background"),this.headerTitle.appendChild(b),this.header.appendChild(this.headerTitle),this.domElement.appendChild(this.header),this.mainContent=a("div","window-content window-content-background"),this.domElement.appendChild(this.mainContent),d.setPosition((window.innerWidth-this.windowSize.width)/2,(window.innerHeight-this.windowSize.height)/2),this.domElement.style.width=this.windowSize.width+"px",this.domElement.style.height=this.windowSize.height+"px";var c=hcsdesign.structure.params.gridBackground||{};e=c.scale||e,c.translation&&BABYLON.Vector2.FromArrayToRef(c.translation,0,j),c.points&&(BABYLON.Vector2.FromArrayToRef(c.points[0],0,n[0]),BABYLON.Vector2.FromArrayToRef(c.points[1],0,n[1])),(!n[1]||BABYLON.Vector2.Distance(n[0],n[1])<90)&&(n[1]=n[0].add(new BABYLON.Vector2(100,0))),this.mainCanvas=a("canvas","window-canvas"),this.mainCanvas.style.background="white",this.mainCanvas.width=g,this.mainCanvas.style.width=g+"px",this.mainCanvas.height=h,this.mainCanvas.style.height=h+"px",this.mainCtx=this.mainCanvas.getContext("2d");var f=function(a,b){d.onMouseEvent(a,b)};this.pointerManager=new hcs.PointerManager(void 0,f,this.mainCanvas)},o.prototype.onMouseEvent=function(a,b){b.actions==b.ACTION_DRAGSTART?d.onCanvasMouseDown(a):b.actions==b.ACTION_DRAGGING?d.onCanvasDrag(a,b):b.actions==b.ACTION_SCROLLDOWN?(i-=.04,i=.6>i?.6:i):b.actions==b.ACTION_SCROLLUP&&(i+=.04,i=i>6?6:i),d.updateCtx()},o.prototype.onCanvasDrag=function(a,b){if(1===l||0===l){var c=b.posDelta.scaleInPlace(1/i),e=n[l].add(c);BABYLON.Vector2.Distance(e,n[0==l?1:0])>10&&(n[l]=e)}else 2===l?(n[0].addInPlace(b.posDelta.clone().scaleInPlace(1/i)),n[1].addInPlace(b.posDelta.clone().scaleInPlace(1/i))):j.addInPlace(b.posDelta);d.updateCtx(),d.updateGrid()},o.prototype.onCanvasMouseDown=function(a){b(a),k.x=a.offsetX,k.y=a.offsetY,k.subtractInPlace(j),k.scaleInPlace(1/i),l=BABYLON.Vector2.Distance(k,n[0])<10?0:BABYLON.Vector2.Distance(k,n[1])<10?1:BABYLON.Vector2.Distance(k,n[1].clone().lerp(n[0],.5))<10?2:3},o.prototype.updateGrid=function(){var a=+e,b=1/m*BABYLON.Vector2.Distance(n[0],n[1]),d=a/b;ujs.notify("hcs.engine2d.backgroundChange",{scale:d,measure:a,visibility:f,img:c,translation:j,points:n})},o.prototype.updateCtx=function(){var a=d.mainCtx;a.clearRect(0,0,g,h),a.save(),m=Math.min(g/c.realWidth,h/c.realHeight),a.scale(m*i,m*i),a.translate(j.x/(m*i),j.y/(m*i)),a.drawImage(c,0,0),Math.round(BABYLON.Vector2.Distance(n[0],n[1])),a.restore(),a.save(),a.scale(i,i),a.translate(j.x/i,j.y/i),hcsdesign.engine2D.symbols2D.drawMeasure(a,n[0],n[1],e+"cm","#6E910F"),a.restore()},o.close=function(){d&&d.close()},o.show=function(){if(null==d){d=new hcs.UI.BackgroundPopup({},{title:_("Choose Background")}),d.initialize();var b=a("input","","file");b.setAttribute("type","file");var f=a("input","","scale");f.setAttribute("style","width:100px"),cb=a("input"),cb.setAttribute("type","checkbox"),cb.setAttribute("checked","checked"),cb.addEventListener("click",d.handleVisibility,!1),f.addEventListener("change",d.handleScale,!1),f.setAttribute("value",e),b.addEventListener("change",d.handleFileSelect,!1);var i=a("div","warning");i.innerHTML=_("Note: your jpg/png won't be saved, and won't be reloaded after use");var j=a("div");j.innerHTML="<strong>"+_("Step")+" 1</strong>: "+_("Select your file (jpg, png)")+"  ",j.appendChild(b);var k=a("div");k.innerHTML="<strong>"+_("Step")+" 2</strong>: "+_("Drag the arrow and enter the corresponding measure (in cm)")+" ",k.appendChild(f);var l=a("div");l.innerHTML="<strong>"+_("Step")+" 3</strong>: "+_("Enable / Disable background"),l.appendChild(cb),d.mainContent.appendChild(i),d.mainContent.appendChild(j),d.mainContent.appendChild(k),c=new Image,c.src="data:image/gif;base64,R0lGODlhAQABAIAAAP7//wAAACH5BAAAAAAALAAAAAABAAEAAAICRAEAOw==",c.realWidth=g,c.realHeight=h,d.mainContent.appendChild(d.mainCanvas),d.mainContent.appendChild(l)}d.show()},o.prototype.updateImgSize=function(){var a=new Image;a.src=c.src,a.setAttribute("style","position:absolute;top:-1000000000px"),d.mainContent.appendChild(a),a.onload=function(){c.realWidth=a.width,c.realHeight=a.height,d.updateCtx(),d.updateGrid(),a.parentNode.removeChild(a),delete a}},o.prototype.handleVisibility=function(a){f=a.target.checked?!0:!1,d.updateGrid()},o.prototype.handleScale=function(a){e=a.target.value,d.updateGrid(),d.updateCtx()},o.prototype.handleFileSelect=function(a){var b=a.target.files,e=b[0],f=new FileReader;f.readAsDataURL(e),f.onloadend=function(){c.src=f.result,d.updateImgSize(),d.updateCtx()}},o.prototype.show=function(){this.initialize(),this.domElement.style.display="block"},o.prototype.close=function(){ujs.notify("hcs.ui.frame.close"),this.domElement.style.display="none",ujs.notify("hcs.menu.main.deselect")},o}();var hcs=window.hcs||{};hcs.UI=hcs.UI||{},hcs.UI.ColorPopup=function(){function a(a,b,c){var d=document.createElement(a);return c&&d.setAttribute("id",c),b&&d.setAttribute("class",b),d}var b=null,c={},d=0,e=function(){},f=function(a){var a=a||{};a.autoSize=a.autoSize===!1?!1:!0,a.width=215,a.height=200,hcs.UI.Frame.call(this,a)};return f.prototype=new hcs.UI.Frame,f.prototype.addColorItems=function(b){for(var c,e,f=0;f<b.length;f++)c=b[f].params.color,e=a("div","luxens"),f==d&&e.classList.add("selected"),e.setAttribute("rel",f),e.style.backgroundColor="rgb("+Math.round(255*c.r)+","+Math.round(255*c.g)+","+Math.round(255*c.b)+")",this.mainContent.appendChild(e),e.addEventListener("click",this.onItemClick,!1)},f.prototype.onItemClick=function(a){b.close(),d=a.target.getAttribute("rel"),e&&e.call(this,d,c[d].params.color),ujs.notify("hcs.core.colorSelected",{id:d,color:c[d].params.color})},f.prototype.buildHTML=function(){this.config.layout||"horizontal",this.domElement=a("div","window","colorPopup"),this.header=a("header","window-title"),this.closeWindow=a("span","window-close"),this.config.showCloseButton===!1&&(this.closeWindow.style.display="none"),this.header.appendChild(this.closeWindow),this.headerTitle=a("h1");var d=a("span","window-title-text");d.innerHTML=this.content.title||_("Colors"),this.headerTitle.appendChild(d),this.header.appendChild(this.headerTitle),this.domElement.appendChild(this.header),this.mainContent=a("div","window-content"),c=LuxensComponent3D.getLuxens(),this.addColorItems(c),this.domElement.appendChild(this.mainContent),b.setPosition(window.innerWidth-this.windowSize.width-260,0),this.domElement.style.width=this.windowSize.width+"px",this.domElement.style.height=window.innerHeight+"px"},f.show=function(a,f){null==b&&(b=new hcs.UI.ColorPopup({},{title:_("colors")}),b.initialize()),d=f||d,b.mainContent.innerHTML="",b.addColorItems(c),e=a||function(){},b.show()},f.prototype.show=function(){this.initialize(),this.domElement.style.display="block"},f}();var hcs=window.hcs||{};hcs.UI=hcs.UI||{},hcs.UI.HelpBubble=function(){var a=function(){this._isVisible=!1,this._e_bubble=document.getElementById("helpbubble"),this._e_image=document.getElementById("helpbubble-image"),this._e_content=document.getElementById("helpbubble-content"),this._image="",this._content="",document.getElementById("helpbubble-close").onclick=this.hide.bind(this)};return a.prototype.newBubble=function(a,b,c){a&&(this._image=a),b&&(this._content=b),c&&this.show()},a.prototype.show=function(){this._isVisible?(this.hide(),window.setTimeout(this.show.bind(this),600)):(this._isVisible=!0,this._e_image.src=this._image,this._e_content.innerHTML=this._content,this._e_bubble.setAttribute("class","visible"))},a.prototype.hide=function(){this._isVisible=!1,this._e_bubble.setAttribute("class","")},a}();var hcs=window.hcs||{};hcs.UI=hcs.UI||{},hcs.UI.HelpBubbleManager=function(){var a=function(a){this.helpBubble=new hcs.UI.HelpBubble,this._enabled="boolean"==typeof a?a:!0,this._bubbles={"hcs.2d.wall-basics":{image:"hcs.2d.wall-basics.gif",content:"<strong>"+_("Walls")+"</strong><ul><li>"+_("Move a wall with a drag &amp; drop.")+"</li><li>"+_("Cut a wall with a double-click.")+"</li></ul>",disp:!1},"hcs.2d.menu":{image:_("hcs.2d.menu-C.gif"),content:"",disp:!1},"hcs.2d.subslope":{image:"hcs.2d.subslope.gif",content:"<strong>"+_("Create Subslopes")+"</strong><ul><li>"+_("Pull the grips to create subslopes.")+"</li><li>"+_("Right-click on a grip to configure the subslope.")+"</li></ul>",disp:!1},"hcs.2d.draw-wall":{image:"hcs.2d.draw-wall.gif",content:"<strong>"+_("Draw Walls")+"</strong><ul><li>"+_("Click to add a point.")+"</li><li>"+_("Click again on your last point to terminate the wall.")+"</li></ul>",disp:!1},"hcs.2d.dup-overture":{image:"hcs.2d.dup-overture.gif",content:"<strong>"+_("Opening Duplication")+"</strong>"+_("Double-click on an opening to duplicate it."),disp:!1},"hcs.2d.draw-staires":{image:"hcs.2d.draw-staires.gif",content:"<strong>"+_("Draw Staireway")+"</strong><ul><li>"+_("Click to add a step.")+"</li><li>"+_("Double-click to terminate the stairway.")+"</li></ul>",disp:!1},"hcs.2d.properties":{image:"hcs.2d.properties.gif",content:"<strong>"+_("Items Settings")+"</strong><ul><li>"+_("You can configure any item of your plan (doors, windows, walls, etc.) by clicking on it.")+"</li><li>"+_("The setting window also allow you to remove any item from your plan.")+"</li></ul>",disp:!1},"hcs.2d.subslopeOverture-menu":{image:"hcs.2d.dormer.png",content:"<strong>"+_("Items Settings")+"</strong><ul><li>"+_("You can configure some parameters of your dormer (height, width, height of roof, etc.) by clicking on it.")+"</li><li>"+_("1: height, 2: height of roof, 3: length of the hole, 4: width")+"</li></ul>",disp:!1},"hcs.3d.paint":{image:"hcs.3d.paint.gif",content:"<strong>"+_("Decorate")+"</strong><ul><li>"+_("Click on a wall to paint it.")+"</li><li>"+_("You can paint objects too.")+"</li></ul>",disp:!1}},this._load()};return a.prototype.setActive=function(a){this._enabled=a},a.prototype.display=function(){},a.prototype.alreadyDisplayed=function(a){return this._bubbles[a].disp},a.prototype._save=function(){var a=[];for(var b in this._bubbles)this._bubbles[b].disp&&a.push(b);hcsLocalStorage["wanadev.planner.helpbubble"]=JSON.stringify(a)},a.prototype._load=function(){if(hcsLocalStorage["wanadev.planner.helpbubble"]){var a=JSON.parse(hcsLocalStorage["wanadev.planner.helpbubble"]);for(var b in a)this._bubbles[a[b]]&&(this._bubbles[a[b]].disp=!0)}},a}();var hcs=window.hcs||{};hcs.UI=hcs.UI||{},hcs.UI.RemoteController=function(){var a,b=document.getElementById("modalWidgets"),c=function(c,d){function e(){if(++i>a.repeat){if(i=0,null!=a.buttonState){var b=a.buttonState,c=b.target.getAttribute("class");null==c&&(c=b.target.parentNode.getAttribute("class"));var d=c.split(" ")[1];switch(d){case"up":a.setDirection(d);break;case"down":a.setDirection(d);break;case"left":a.setDirection(d);break;case"right":a.setDirection(d);break;case"zoomup":a.addZoom(-1);break;case"zoomdown":a.addZoom(1)}}requestAnimationFrame(e)}}b=document.getElementById("modalWidgets");var c=c||{},d=d||{};this.addedToDomElement=d.domElement||b,this.imagePath=d.imagePath||"../images/remote-controller/",this.domElement=this.buildHTML(),this.defaultDomStyle="top: "+(d.y||10)+"px;left: "+(d.x||10)+"px;",this.domElement.setAttribute("style",this.defaultDomStyle),this.addedToDomElement.appendChild(this.domElement),this.buttons=document.getElementsByClassName("remote-button"),this.slider=document.getElementById("remote-slider"),this.sliderContainer=document.getElementById("remote-slider-content"),this.globalSliderContainer=document.getElementById("remote-slider-bar"),this.globalSliderContainerHeight=this.globalSliderContainer.scrollHeight,this.buttonHeight=this.buttons;var f=35;this.zoom={min:21,max:129,reference:f,value:f,lastValue:f,setValue:function(a){this.lastValue=this.value,a>this.min&&a<this.max&&(this.value=a)},setRelativeValue:function(a){this.lastValue=this.value,a>=0&&1>=a&&(this.value=a*(this.max-this.min)+this.min)},addValue:function(a){this.setValue(this.value+a)},getValue:function(){return this.value},getRelativeValue:function(){return(this.value-this.min)/(this.max-this.min)},getRelativeDeltaValue:function(){return(this.value-this.lastValue)/(this.max-this.min)},getDelta:function(){return this.value-this.lastValue}},this.callbacks={zoom:c.zoomChanged||null,direction:c.directionChanged||null,camera:c.cameraChanged||null},a=this;for(var g=0,h=this.buttons.length;h>g;g++)this.buttons[g].addEventListener("mousedown",function(b){a.onButtonMouseDown(b,a)},!1),this.buttons[g].addEventListener("mouseup",function(b){a.onButtonMouseUp(b,a)},!1),this.buttons[g].addEventListener("click",function(b){a.onButtonClick(b,a)},!1);this.slider.addEventListener("mousedown",function(b){a.onSliderMouseDown(b,a)},!1),document.body.addEventListener("mousemove",function(b){a.onSliderMouseMove(b,a)},!1),document.body.addEventListener("mouseup",function(b){a.onMouseUp(b,a)},!1),document.addEventListener("hcs.keyboardManager.keyDown",a.onKeyDown,!0),this.sliderSelected=!1,this.updateSliderPos(),this.mouse={y:0,lastY:0,getDelta:function(){return this.y-this.lastY}},e(),this.buttonState=null,this.running=!0,this.repeat=3;var i=0;e()};return c.prototype.buildHTML=function(){var a=document.createElement("div");a.setAttribute("id","remote-controller");var b=document.createElement("div");b.setAttribute("id","remote-buttons");for(var c=["up","down","left","right"],d=0;4>d;d++){var e=document.createElement("a");e.setAttribute("href","javascript:void(0);"),e.setAttribute("class","remote-button "+c[d]);var f=document.createElement("img");f.setAttribute("src",this.imagePath+c[d]+".png"),e.appendChild(f),b.appendChild(e)}a.appendChild(b);var g=document.createElement("a");g.setAttribute("href","javascript:void(0);"),g.setAttribute("class","remote-button camera");var h=document.createElement("img");h.setAttribute("src",this.imagePath+"camera.png"),g.appendChild(h),a.appendChild(g);var i=document.createElement("div");i.setAttribute("id","remote-slider-bar");var j=document.createElement("a");j.setAttribute("href","javascript:void(0);"),j.setAttribute("class","remote-button zoomup");var k=document.createElement("img");k.setAttribute("src",this.imagePath+"zoom-up.png"),j.appendChild(k),i.appendChild(j);var l=document.createElement("div");l.setAttribute("id","remote-slider-content");var m=document.createElement("img");m.setAttribute("id","remote-slider"),m.setAttribute("src",this.imagePath+"zoom-cursor.png"),l.appendChild(m),i.appendChild(l);var n=document.createElement("a");n.setAttribute("href","javascript:void(0);"),n.setAttribute("class","remote-button zoomdown");var o=document.createElement("img");return o.setAttribute("src",this.imagePath+"zoom-down.png"),n.appendChild(o),i.appendChild(n),a.appendChild(i),a},c.prototype.onKeyDown=function(b){var c=b.keyCode;switch(c){case 37:a.setDirection("left");break;case 38:a.setDirection("up");break;case 39:a.setDirection("right");break;case 40:a.setDirection("down")}},c.prototype.updateDomPosition=function(a,b){this.defaultDomStyle="top: "+b+"px;left: "+a+"px;",this.domElement.setAttribute("style",this.defaultDomStyle)},c.prototype.kill=function(a){for(var a="undefined"!=typeof a?a:!0,b=this,c=0,d=this.buttons.length;d>c;c++)this.buttons[c].removeEventListener("mousedown",function(a){b.onButtonMouseDown(a,b)}),this.buttons[c].removeEventListener("mouseup",function(a){b.onButtonMouseUp(a,b)}),this.buttons[c].removeEventListener("click",function(a){b.onButtonClick(a,b)});this.slider.removeEventListener("mousedown",function(a){b.onSliderMouseDown(a,b)}),document.body.removeEventListener("mousemove",function(a){b.onSliderMouseMove(a,b)}),document.body.removeEventListener("mouseup",function(a){b.onMouseUp(a,b)}),this.running=!1,a&&null!==this.domElement.parentNode&&this.addedToDomElement.removeChild(this.domElement)},c.prototype.onButtonMouseDown=function(a,b){b.buttonState=a},c.prototype.onButtonMouseUp=function(a,b){b.buttonState=null},c.prototype.onButtonClick=function(a,b){var c=a.target.getAttribute("class");null==c&&(c=a.target.parentNode.getAttribute("class"));var d=c.split(" ")[1];switch(d){case"camera":b.changeCamera();break;case"up":b.setDirection(d);break;case"down":b.setDirection(d);break;case"left":b.setDirection(d);break;case"right":b.setDirection(d);break;case"zoomup":b.addZoom(-1);break;case"zoomdown":b.addZoom(1)}},c.prototype.show=function(){this.domElement.setAttribute("style",this.defaultDomStyle)},c.prototype.hide=function(){this.domElement.setAttribute("style","display:none;")},c.prototype.onSliderMouseDown=function(a,b){a.preventDefault(),b.sliderSelected=!0},c.prototype.onSliderMouseMove=function(a,b){b.mouse.lastY=b.mouse.y,b.mouse.y=void 0!==a.y?a.y:a.clientY,b.sliderSelected&&this.addZoom(b.mouse.getDelta())},c.prototype.onMouseUp=function(a,b){b.sliderSelected=!1},c.prototype.reset=function(){this.zoom.value=this.zoom.reference,this.updateSliderPos()},c.prototype.addZoom=function(a){this.zoom.addValue(a),this.updateSliderPos(),null!=this.callbacks.zoom&&this.callbacks.zoom(this.zoom.getRelativeDeltaValue())},c.prototype.setDirection=function(a){null!=this.callbacks.direction&&this.callbacks.direction(a)},c.prototype.changeCamera=function(){null!=this.callbacks.camera&&this.callbacks.camera()},c.prototype.updateZoom=function(a){this.zoom.setRelativeValue(a),this.updateSliderPos()},c.prototype.updateSliderPos=function(){this.slider.style.top=this.zoom.getValue()+"px"},c}();var hcs=window.hcs||{};hcs.UI=hcs.UI||{},hcs.UI.MessageBox=function(){var a=document.getElementById("modalWidgets"),b=!1,c=null,d=function(b){var b=b||{},d=this;a=document.getElementById("modalWidgets"),b.buttonAText=b.buttonAText||_("Ok"),b.buttonBText=b.buttonBText||_("Cancel"),b.buttonCText=b.buttonCText||_("Cancel"),b.inputType=b.inputType||"text",b.inputValue=b.inputValue||"",b.inputPlaceHolder=b.inputPlaceHolder||"",b.textAreaValue=b.textAreaValue||"",b.textAreaPlaceHolder=b.textAreaPlaceHolder||"",this.showButtonA="undefined"!=typeof b.buttonA?b.buttonA:!1,this.showButtonB="undefined"!=typeof b.buttonB?b.buttonB:!1,this.showButtonC="undefined"!=typeof b.buttonC?b.buttonC:!1,this.showInput="undefined"!=typeof b.input?b.input:!1,this.showTextArea="undefined"!=typeof b.textArea?b.textArea:!1,this.closeCallback=b.onClose||function(){},this.button1Callback=b.onClickA||function(){},this.button2Callback=b.onClickB||function(){},this.button3Callback=b.onClickC||function(){},this.destroyAfterClose="undefined"!=typeof b.destroyAfterClose?b.destroyAfterClose:!1,this.overlay="undefined"!=typeof b.overlay?b.overlay:!1,this.opacity=b.opacity||0,this.messageBox=document.createElement("div"),this.messageBox.setAttribute("id","messageBox"),this.messageBox.setAttribute("class","window"),this.header=document.createElement("header"),this.header.setAttribute("class","window-title"),this.closeHeader=document.createElement("span"),this.closeHeader.setAttribute("class","window-close"),this.closeHeader.addEventListener("click",function(){hcs.UI.MessageBox.close(),d.closeCallback.call(d)},!1),this.header.appendChild(this.closeHeader),this.headerContent=document.createElement("h1"),this.header.appendChild(this.headerContent),this.content=document.createElement("p"),this.content.setAttribute("class","mb-content window-content"),this.input=document.createElement("input"),this.input.setAttribute("class","mb-input"),this.input.setAttribute("type",b.inputText),this.input.setAttribute("value",b.inputValue),this.input.setAttribute("placeholder",b.inputPlaceHolder),this.input.addEventListener("click",this.onInputClick,!1),this.showInput||this.input.setAttribute("style","display:none;"),this.textArea=document.createElement("textarea"),this.textArea.setAttribute("class","mb-textarea"),this.textArea.setAttribute("placeholder",b.textAreaPlaceHolder),this.textArea.style.display="block",this.textArea.style.margin="5px auto",this.textArea.style.width="90%",this.textArea.style.height="60px",this.textArea.innerHTML=b.textAreaValue,this.showTextArea||(this.textArea.style.display="none"),this.buttonA=document.createElement("button"),this.buttonA.setAttribute("id","mb-button-a"),this.buttonA.addEventListener("click",function(a){d.onClick(a,d)},!1),this.buttonA.innerHTML=b.buttonAText,this.showButtonA||this.buttonA.setAttribute("style","display:none;"),this.buttonB=document.createElement("button"),this.buttonB.setAttribute("id","mb-button-b"),this.buttonB.addEventListener("click",function(a){d.onClick(a,d)},!1),this.buttonB.innerHTML=b.buttonBText,this.showButtonB||this.buttonB.setAttribute("style","display:none;"),this.buttonC=document.createElement("button"),this.buttonC.setAttribute("id","mb-button-c"),this.buttonC.addEventListener("click",function(a){d.onClick(a,d)},!1),this.buttonC.innerHTML=b.buttonCText,this.showButtonC||this.buttonC.setAttribute("style","display:none;"),this.buttonsContainer=document.createElement("div"),this.buttonsContainer.setAttribute("class","window-action-bar"),this.buttonsContainer.appendChild(this.buttonA),this.buttonsContainer.appendChild(this.buttonB),this.buttonsContainer.appendChild(this.buttonC),this.messageBox.appendChild(this.header),this.messageBox.appendChild(this.content),this.messageBox.appendChild(this.input),this.messageBox.appendChild(this.textArea),this.messageBox.appendChild(this.buttonsContainer),a.appendChild(this.messageBox),this.autoHideInterval=null,c=this;var d=this;document.addEventListener("hcs.request.closePopup",function(){c=c==this?null:c,d.destroy()},!1)};return d.prototype.destroy=function(){var c=this;this.buttonA.removeEventListener("click",function(a){c.onClick(a,c)}),this.buttonB.removeEventListener("click",function(a){c.onClick(a,c)}),this.buttonC.removeEventListener("click",function(a){c.onClick(a,c)}),this.headerContent.innerHTML="",this.content.innerHTML="",this.messageBox.setAttribute("style","display:none;"),b&&ujs.notify("hcs.ui.messagebox.closed"),b=!1,null!==this.messageBox.parentNode&&a.removeChild(this.messageBox)},d.prototype.onClick=function(a,b){if(b.messageBox.setAttribute("style","display:none;"),"undefined"!=typeof a.clearInterval&&a.clearInterval&&clearInterval(b.autoHideInterval),null!=b.closeCallback&&(params={textInput:b.input.value},b.closeCallback(params)),"undefined"!=typeof a.target){a.textInput=b.input.value,a.textAreaInput=b.textArea.value;var c=a.target.id;"mb-button-a"==c&&null!=b.button1Callback&&b.button1Callback(a),"mb-button-b"==c&&null!=b.button2Callback&&b.button2Callback(a),"mb-button-c"==c&&null!=b.button3Callback&&b.button3Callback(a)}b.destroyAfterClose&&b.destroy()},d.prototype.onInputClick=function(){this.value=""},d.prototype.open=function(a){var a=a||{},c="undefined"!=typeof a.force?a.force:!1;if(!b||c){b=!0;var d=a.autoHide||!1,e=a.hideTime||1500,f=a.width||250,g=a.height||!1,h=a.x||window.innerWidth/2-f/2,i=a.y||window.innerHeight/2-g/2,j=a.title||"",k=a.message||"";this.headerContent.innerHTML=j,k instanceof HTMLElement?(this.content.innerHTML="",this.content.appendChild(k)):this.content.innerHTML=k,this.showInput&&(g+=30),(this.showButtonA||this.showButtonB)&&(g+=30);var l="display:block;width:"+f+"px;top:"+i+"px;left:"+h+"px;";if(g&&(l+="width:"+f+"px;"),this.messageBox.setAttribute("style",l),!this.showInput&&"string"==typeof k&&GlobalHelper.isMobileDevice()){this.content.classList.add(/<form|<ul|<table/.test(k)?"message-incFontSize":"message-center");var m=this.content.getBoundingClientRect();this.content.style.top=Math.floor(window.innerHeight/2-m.height/2)+"px"}var n=this;d&&(this.autoHideInterval=setInterval(function(){n.onClick({clearInterval:!0},n)},e)),ujs.notify("hcs.ui.messagebox.opened")}},d.prototype.close=function(){var a="";this.defaultStyles&&this.defaultStyles.box&&(a=this.defaultStyles.box),this.messageBox.setAttribute("style",a+"display:none"),b=!1,ujs.notify("hcs.ui.messagebox.closed")},d.close=function(){null!=c&&(c.close(),c.destroy(),c=null)},d.show=function(a){var a=a||{},c="undefined"==typeof a.force?!1:a.force;if(!b||c){var a=a||{};a.autoHide=a.autoHide||!1,a.hideTime=a.hideTime||2500,a.width=a.width||null,a.height=a.height||null,a.x=a.x||null,a.y=a.y||null,a.title=a.title||"",a.message=a.message||"",a.inputValue=a.inputValue||"",a.openCallback=a.openCallback||function(){};var d={destroyAfterClose:!0,onClose:a.onClose||null,onClickA:a.onClickA||null,onClickB:a.onClickB||null,onClickC:a.onClickC||null,buttonA:"undefined"!=typeof a.buttonA?a.buttonA:!1,buttonAText:a.buttonAText||null,buttonB:"undefined"!=typeof a.buttonB?a.buttonB:!1,buttonBText:a.buttonBText||null,buttonC:"undefined"!=typeof a.buttonC?a.buttonC:!1,buttonCText:a.buttonCText||null,input:"undefined"!=typeof a.input?a.input:!1,inputValue:a.inputValue,inputPlaceHolder:a.inputPlaceHolder,textArea:"undefined"!=typeof a.textArea?a.textArea:!1,textAreaValue:a.textAreaValue,textAreaPlaceHolder:a.textAreaPlaceHolder,opacity:a.opacity||0,overlay:a.overlay||!1},e=new hcs.UI.MessageBox(d);e.open(a),a.openCallback()}},d}();var hcs=window.hcs||{};hcs.UI=hcs.UI||{},hcs.UI.Menu=function(){function a(a){var b=[];return b.push("background-color:rgb("),b.push(Math.floor(255*a.r)),b.push(", "),b.push(Math.floor(255*a.g)),b.push(", "),b.push(Math.floor(255*a.b)),b.push(")"),b.join("")}var b=0,c=function(a,b,c){this.json=a||[],this.domElement=document.getElementById(b),this.params=c||{},this.selected=this.params.selected||!1,this.inception=this.params.inception===!1?!1:!0,this.oneClick=this.params.oneClick===!0?!0:!1,this.initialize()};return c.prototype.initialize=function(){this.updateHtml()},c.prototype.getWidth=function(){return this.domElement.offsetWidth||0},c.prototype.updateHtml=function(a){if(a&&a.id){var b=this.domElement.querySelector("#"+a.id),c=this.buildItem(a,b.nodeName);b.parentNode.replaceChild(c,b)}else{this.domElement.innerHTML="";for(var c,d=0;d<this.json.length;d++)c=this.buildItem(this.json[d],"li"),this.domElement.appendChild(c)
}},c.prototype.buildItem=function(c,d){var e=document.createElement(d);if(c.id="undefined"!=typeof c.id?c.id:"item"+b++,e.id=c.id,c.noTitle=!1,1==c.texture){var f=document.createElement("span");f.setAttribute("class","menu-icon");var g=c.translations?_(c.title,c.translations):_(c.title);if(c.params.url){c.noTitle=!0;var h=document.createElement("img"),i=c.icon||c.params.url;h.setAttribute("src",i),h.setAttribute("title",g),f.appendChild(h),e.appendChild(f)}else c.params.color&&(c.noTitle=!0,f.setAttribute("style",a(c.params.color)),f.setAttribute("title",g),e.appendChild(f));if(c.colorable){var j=document.createElement("div");j.setAttribute("class","colorChooser");var k=a(c.params.addColor&&c.params.addColor.color?c.params.addColor.color:{r:137/255,g:115/255,b:100/255});j.setAttribute("style",k),f.appendChild(j),f.classList.add("colorable"),j.item=c,j.addEventListener("click",this.onColorChooserClick.bind(this),!1)}}else if(c.icon){var f=document.createElement("span");f.setAttribute("class","menu-icon"),f.innerHTML=-1==c.icon.indexOf(".")?"<i class='"+c.icon+"'></i>":"<img src='"+c.icon+"' />",e.appendChild(f)}if(c.title&&c.noTitle===!1){var g=c.translations?_(c.title,c.translations):_(c.title),l=document.createElement("span");l.setAttribute("class","menu-title"),l.innerHTML=g,e.appendChild(l)}if(e.classList.add("menu-item"),c.context&&e.classList.add("label-"+c.context),c==this.selected&&e.classList.add("selected"),c.addClass)for(var m=c.addClass.split(" "),n=0;n<m.length;n++)e.classList.add(m[n]);if(c.items&&c.items.length>0&&this.inception){var o,p=document.createElement("ul");p.classList.add(c.layout),e.classList.add("menu-subitem"),c==this.selected&&e.classList.add("opened");for(var q=0;q<c.items.length;q++)c.items[q]==this.selected&&e.classList.add("opened"),o=this.buildItem(c.items[q],"li"),p.appendChild(o);e.appendChild(p)}return e.addEventListener("click",function(a){"UL"!=a.target.tagName&&(this.selected==c||e.classList.contains("opened")?(this.deselect(),this.deselectElement(e)):(ujs.notify("hcs.menu.click",this.buildEventItem(c)),(this.oneClick===!1||c.selectionnable===!0)&&(this.selected=c,this.selectElement(e)),c.action&&ujs.notify(c.action,this.buildEventItem(c))),a.stopPropagation())}.bind(this),!1),e},c.prototype.selectElement=function(a){for(var b=this.domElement.querySelectorAll(".selected"),c=0;c<b.length;c++)b[c].classList.remove("selected");a.classList.add("selected"),a.classList.contains("menu-subitem")&&a.classList.add("opened")},c.prototype.deselectElement=function(a){a.classList.remove("selected"),a.classList.contains("menu-subitem")&&a.classList.remove("opened")},c.prototype.onColorChooserClick=function(a){var b=a.target,c=b.item,d=function(a,d){b.style.backgroundColor="rgb("+Math.round(255*d.r)+","+Math.round(255*d.g)+","+Math.round(255*d.b)+")";var e=c.params;e.addColor={color:d},c.colorId=a,this.selected=c,c.action&&ujs.notify(c.action,this.buildEventItem(c))};hcs.UI.ColorPopup.show(d.bind(this),c.colorId),a.stopPropagation()},c.prototype.buildEventItem=function(a){var b={};for(var c in a)b[c]=a[c];for(var c in a.params)b[c]=a.params[c];return delete b.items,b},c.prototype.deselect=function(a,b){var a=a||!1,b=b||!1;if(!this.selected||!b||this.selected.id===b){if(this.selected.cancelAction){var c=this.buildEventItem(this.selected);c.from="deselect",ujs.notify(this.selected.cancelAction,c)}this.getDomItemById(this.selected.id)&&this.deselectElement(this.getDomItemById(this.selected.id)),this.selected=a?!1:this.getParent(this.selected)}},c.prototype.getParent=function(a){for(var b=0;b<this.json.length;b++)for(var c in this.json[b].items)if(this.json[b].items[c]==a)return this.json[b];return!1},c.prototype.deleteMenuItem=function(a){var b=function(b,c){return b.id==a?c:!1},c=this.traverse(this.json,void 0,b);if(c){for(var d=this.json;c.length>1;)d=d[c.shift()].items;d.splice(c[0],1)}},c.prototype.replaceMenuItem=function(a,b,c){var d=this,c=c||!1,b=b||{},e=function(e,f){if(e.id==a){var g=b;c===!0&&(g=ujs.mergeObjects(e,b,!0)),e==this.selected&&(this.selected=g);var h=f.join(".items.");ujs.setProperty(d.json,h,g);for(var i in g)b[i]=g[i];return!0}return!1};this.traverse(this.json,e)},c.prototype.addMenuItem=function(a,b){if(b.items||(b.items=[]),"."!==a){a=this.cleanPath(a);var c=ujs.getProperty(this.json,a);if(c!==!1&&"undefined"!=typeof c){if(b instanceof Array)for(var d=0;d<b.length;d++)c.push(b[d]);else c.push(b);this.sortJson(c)}else ujs.setProperty(this.json,a,b)}else this.json.push(b),this.sortJson(this.json);this.updateHtml()},c.prototype.getDomItemById=function(a){if(a){a=a.id||a;for(var b=this.domElement.getElementsByClassName("menu-item"),c=b.length;c--;)if(b[c].id==a)return b[c]}},c.prototype.searchItem=function(a){var b=function(b){return b.id==a?b:!1},c=this.traverse(this.json,void 0,b);return c?c:!1},c.prototype.sortJson=function(a){a&&a.length>0&&a.sort(function(a,b){return a.index-b.index})},c.prototype.traverse=function(a,b,c,d){for(var b=b||function(){},c=c||function(){return!1},d=d||[],e=0;e<a.length;e++){if(b(a[e],d.concat(e)),c(a[e],d)!==!1)return d.push(e),c(a[e],d);if(a[e].items&&a[e].items.length>0){var f=ujs.cloneArray(d);f.push(e);var g=this.traverse(a[e].items,b,c,f);if(g)return g}}},c.prototype.getIdFromIdentifier=function(a){var b=function(b,c){return b.id==a?c[c.length-1]:!1},c=this.traverse(this.json,void 0,b);return c?c:0},c.prototype.cleanPath=function(a){for(var a=a||"",b=a.split("."),c=0;c<b.length;c++)isNaN(+b[c])&&(b[c]=this.getIdFromIdentifier(b[c]));return a=b.join(".items.")+".items"},c}();var hcs=window.hcs||{};hcs.UI=hcs.UI||{},hcs.UI.LanguageSelector=function(){var a=null,b="en",c="",d=[{id:"en",label:"English (English)"},{id:"es",label:"Spain (España)"},{id:"fr",label:"French (Français)"},{id:"pl",label:"Polish (Poland)"},{id:"jp",label:"Japanese (Japan)"}],e=function(){hcs.UI.Frame.call(this,{maxWidth:200,maxHeight:220},{title:_("Available languages")}),this.init=!1};return e.prototype=new hcs.UI.Frame,e.prototype.initialize=function(){if(hcs.UI.Frame.prototype.initialize.call(this),!this.init){var a=[{title:_("Ok"),action:this.close.bind(this),label:_("Ok")}];this.setActionBar(a),this.init=!0,this.domElement.setAttribute("id","languageSelector"),this.domElement.classList.add("language-selector");for(var c=document.getElementsByClassName("drawableSurface"),e=0,f=c.length;f>e;e++)c[e].addEventListener("click",this.close,!1);var g=document.createElement("ul");g.setAttribute("class","layout-list");var h=[];for(var e in d)h.push({label:d[e].label,groupName:"languages",isSelected:d[e].id==b?!0:!1,id:"lang_"+d[e].id,type:"radio",eventParams:this.onSelected});this.addForm(0,h,"Languages"),this.setLayout("vertical")}},e.prototype.onSelected=function(){c=this.id.split("_")[1]},e.show=function(){null==a&&(a=new hcs.UI.LanguageSelector,a.initialize()),a._selectedLang="",a.show()},e.setLocal=function(a){b="C"==a?"en":a},e.prototype.close=function(){a.domElement.style.display="none",""!==c&&(hcsLocalStorage.setItem(hcs.Constants.LC_LANG_KEY,c),window.location.reload())},e}();var hcs=window.hcs||{};hcs.UI=hcs.UI||{},hcs.UI.IFrame=function(){function a(){b.close(!0)}var b=null,c=function(a,c,d,e){this.domElement=document.createElement("div"),this.domElement.setAttribute("id","hcs-iframe"),this.domElement.style.width=window.innerWidth+"px",this.domElement.style.height=window.innerHeight+"px",this.iframeContainer=document.createElement("div"),this.iframeContainer.setAttribute("class","hcs-iframe-container"),this.iframe=document.createElement("iframe"),this.iframe.setAttribute("seamless","seamless"),this.iframe.setAttribute("sandbox","allow-same-origin allow-scripts allow-top-navigation allow-popups  allow-forms"),this.parentNode=a,this.added=!1,this.closeOnClick=d&&"undefined"!=typeof d.closeOnClick?d.closeOnClick:!1,this.closeCallback=e||function(){};for(var f in c)this.iframe[f]=c[f];this.closeButton=document.createElement("a"),this.closeButton.setAttribute("href","#"),this.closeButton.setAttribute("class","close-button");var g=document.createElement("img");g.setAttribute("src","images/close-icon.png"),this.closeButton.appendChild(g);var d=d||{};d.showClose&&this.iframeContainer.appendChild(this.closeButton),this.iframeContainer.appendChild(this.iframe),this.domElement.appendChild(this.iframeContainer),b=this,this.resize(c.width,c.height)};return c.prototype.open=function(){this.added||(this.iframeContainer.style.left=+(+window.innerWidth/2)-+parseInt(this.iframeContainer.style.width)/2+"px",this.iframeContainer.style.top=+(+window.innerHeight/2)-+parseInt(this.iframeContainer.style.height)/2+"px",this.parentNode.appendChild(this.domElement),this.closeButton.addEventListener("click",a,!0),this.closeOnClick&&this.parentNode.addEventListener("click",a,!1),this.added=!0)},c.prototype.close=function(c){this.added&&(this.parentNode.removeChild(b.domElement),this.closeButton.removeEventListener("click",a),this.closeOnClick&&this.parentNode.removeEventListener("click",a),this.added=!1,this.closeCallback()),"boolean"==typeof c&&delete this},c.show=function(a,c,d){hcs.UI.IFrame.close(),b=new hcs.UI.IFrame(a,c,d),b.open()},c.close=function(a){b&&(b.close(a),b=null)},c.prototype.resize=function(a,c){var a=a,c=c;a&&(a>hcsdesign.getWidth()-40&&(a=hcsdesign.getWidth()-40),b.iframeContainer.style.width=a+"px",b.iframe.setAttribute("width",a),b.iframeContainer.style.left=Math.round(+(+window.innerWidth/2)-+parseInt(b.iframeContainer.style.width)/2)+"px"),c&&(c>hcsdesign.getHeight()-40&&(c=hcsdesign.getHeight()-40),b.iframeContainer.style.height=c+"px",b.iframe.setAttribute("height",c),b.iframeContainer.style.top=Math.round(+(+window.innerHeight/2)-+parseInt(b.iframeContainer.style.height)/2)+"px")},c.resize=c.prototype.resize,c}();var hcs=window.hcs||{};hcs.Input=hcs.Input||{},hcs.Input.OrbitCamera=function(){var a=(BABYLON.Tools.GetPointerPrefix(),function(b,c,d,e,f,g){BABYLON.Camera.call(this,b,BABYLON.Vector3.Zero(),g),this.alpha=c,this.beta=d,this.radius=e,this.target=f,this.enabled=!0,this.cameraTranslationenabled=!0,this._keys=[],this.keysUp=[38],this.keysDown=[40],this.keysLeft=[37],this.keysRight=[39],this._viewMatrix=new BABYLON.Matrix,a.prototype._initCache.call(this),this.getViewMatrix()});a.prototype=Object.create(BABYLON.Camera.prototype);var b=BABYLON.Camera;a.prototype.inertialAlphaOffset=0,a.prototype.inertialBetaOffset=0,a.prototype.inertialRadiusOffset=0,a.prototype.lowerAlphaLimit=null,a.prototype.upperAlphaLimit=null,a.prototype.lowerBetaLimit=null,a.prototype.upperBetaLimit=null,a.prototype.lowerRadiusLimit=40,a.prototype.upperRadiusLimit=6e3,a.prototype.radiusSpeedFactor=.2,a.prototype.moveSpeedFactor=.5,a.prototype.angularSensibility=1e3;var c=function(a){return a.offsetX?a.offsetX:a.layerX?a.layerX:a.clientX},d=function(a){return a.offsetY?a.offsetY:a.layerY?a.layerY:a.clientY};return a.prototype._getTargetPosition=function(){return this.target.position||this.target},a.prototype._initCache=function(){b.prototype._initCache.call(this),this._cache.target=new BABYLON.Vector3(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE),this._cache.alpha=void 0,this._cache.beta=void 0,this._cache.radius=void 0},a.prototype._updateCache=function(a){a||b.prototype._updateCache.call(this),this._cache.target.copyFrom(this._getTargetPosition()),this._cache.alpha=this.alpha,this._cache.beta=this.beta,this._cache.radius=this.radius},a.prototype._isSynchronizedViewMatrix=function(){return b.prototype._isSynchronizedViewMatrix.call(this)?this._cache.target.equals(this._getTargetPosition())&&this._cache.alpha===this.alpha&&this._cache.beta===this.beta&&this._cache.radius===this.radius:!1},a.prototype.attachControl=function(a,b,c){1===hcsdesign.engine3D.pointerManager.mode?this.attachControlForMobile(a,b,c):this.attachControlForDesktop(a,b,c)},a.prototype.attachControlForMobile=function(a){var b,c=this._scene.getEngine(),d=.005,e=!0,f=[{x:0,y:0},{x:0,y:0}],g=0,h=0,i=this;this.angularSensibility=1,this._attachedCanvas=a,window.ejecta&&(this._attachedCanvas=document),document.addEventListener("hcs.engine3d.dragcontrols.start",function(){e=!1},!1),document.addEventListener("hcs.engine3d.dragcontrols.end",function(){e=!0},!1);var j=function(a){f[0].x=a.touches[0].clientX||a.touches[0].pageX,f[0].y=a.touches[0].clientY||a.touches[0].pageY,2===a.touches.length&&(f[1].x=a.touches[1].clientX||a.touches[1].pageX,f[1].y=a.touches[1].clientY||a.touches[1].pageY)},k=function(a,b){var c=a.x-b.x,d=a.y-b.y;return Math.sqrt(c*c+d*d)},l=function(a){e&&(a.preventDefault(),j(a),c.isPointerLock=!0,a.touches.length&&(b={x:a.touches[0].clientX*d,y:a.touches[0].clientY*d}))},m=function(a){if(e&&(a.preventDefault(),j(a),a.touches.length)){if(!b)return;var c=a.touches[0].clientX*d,l=a.touches[0].clientY*d,m=c-b.x,n=l-b.y;if(a.touches.length>2){var o=hcsdesign.engine3D.projectMouseOnGround(0|+(b.x/d),0|+(b.y/d)),p=hcsdesign.engine3D.projectMouseOnGround(0|+(c/d),0|+(l/d));null!==o&&null!==p&&(p.subtractInPlace(o),i._getTargetPosition().addInPlace(p.scaleInPlace(-1)),i._getTargetPosition().x=ujs.Math.clamp(i._getTargetPosition().x,hcsdesign.configuration.boundingSize.min.x,hcsdesign.configuration.boundingSize.max.x),i._getTargetPosition().z=ujs.Math.clamp(i._getTargetPosition().z,hcsdesign.configuration.boundingSize.min.z,hcsdesign.configuration.boundingSize.max.z))}else if(2==a.touches.length){h=g,g=k(f[0],f[1]);var q=+(g-h)>0?2.5:-2.5;q*=hcsdesign.loopTimer.getDeltaTime(),i.inertialRadiusOffset+=q}else i.inertialAlphaOffset-=m/i.angularSensibility,i.inertialBetaOffset-=n/i.angularSensibility;b={x:c,y:l}}},n=function(a){e&&(a.preventDefault(),c.isPointerLock=!1,b=null)};this._attachedCanvas.addEventListener("touchstart",l,!1),this._attachedCanvas.addEventListener("touchmove",m,!1),this._attachedCanvas.addEventListener("touchend",n,!1),this._attachedCanvas.addEventListener("touchcancel",n,!1)},a.prototype.attachControlForDesktop=function(a,b){var e,f,g=this,h=!1;if(!this._attachedCanvas){this._attachedCanvas=a;var i=this._scene.getEngine();void 0===this._onPointerDown&&(this._onPointerDown=function(a){return g.enabled?void(f||(f=a.pointerId,e={x:c(a),y:d(a)},b||a.preventDefault())):void(e=null)},this._onPointerUp=function(a){e=null,f=null,b||a.preventDefault()},this._onPointerMove=function(a){if(e&&!h&&f===a.pointerId){var i=c(a)-e.x,j=d(a)-e.y;if(g.enabled){var k=a.button;if(!a.button&&a.buttons?(k=a.buttons,k=1===a.buttons?0:k):-1===k&&(k=1===a.buttons?0:a.buttons),0===k)g.inertialAlphaOffset-=i/g.angularSensibility,g.inertialBetaOffset-=j/g.angularSensibility;else if(2===k){if(!g.cameraTranslationenabled)return;var l=hcsdesign.engine3D.projectMouseOnGround(e.x,e.y),m=hcsdesign.engine3D.projectMouseOnGround(c(a),d(a));if(null!==l&&null!==m){m.subtractInPlace(l);var n=m.length();n>125&&m.scaleInPlace(125/n),g._getTargetPosition().addInPlace(m.scaleInPlace(-1)),g._getTargetPosition().x=ujs.Math.clamp(g._getTargetPosition().x,hcsdesign.configuration.boundingSize.min.x,hcsdesign.configuration.boundingSize.max.x),g._getTargetPosition().z=ujs.Math.clamp(g._getTargetPosition().z,hcsdesign.configuration.boundingSize.min.z,hcsdesign.configuration.boundingSize.max.z)}}ujs.notify("hcs.engine3D.camera.move"),e={x:c(a),y:d(a)},b||a.preventDefault()}}},this._onMouseMove=function(a){if(g.enabled&&i.isPointerLock){var c=a.movementX||a.mozMovementX||a.webkitMovementX||a.msMovementX||0,d=a.movementY||a.mozMovementY||a.webkitMovementY||a.msMovementY||0;g.inertialAlphaOffset-=c/g.angularSensibility,g.inertialBetaOffset-=d/g.angularSensibility,b||a.preventDefault()}},this._wheel=function(a){if(g.enabled){var c=0;a.wheelDelta?c=a.wheelDelta/(120*g.radiusSpeedFactor):a.detail&&(c=-a.detail/(3*g.radiusSpeedFactor)),c&&(g.inertialRadiusOffset+=c),a.preventDefault&&(b||a.preventDefault())}},this._onKeyDown=function(a){if(g.enabled&&(-1!==g.keysUp.indexOf(a.keyCode)||-1!==g.keysDown.indexOf(a.keyCode)||-1!==g.keysLeft.indexOf(a.keyCode)||-1!==g.keysRight.indexOf(a.keyCode))){var c=g._keys.indexOf(a.keyCode);-1===c&&g._keys.push(a.keyCode),a.preventDefault&&(b||a.preventDefault())}},this._onKeyUp=function(a){if(g.enabled&&(-1!==g.keysUp.indexOf(a.keyCode)||-1!==g.keysDown.indexOf(a.keyCode)||-1!==g.keysLeft.indexOf(a.keyCode)||-1!==g.keysRight.indexOf(a.keyCode))){var c=g._keys.indexOf(a.keyCode);c>=0&&g._keys.splice(c,1),a.preventDefault&&(b||a.preventDefault())}},this._onLostFocus=function(){g.enabled&&(g._keys=[],f=null)},this._onGestureStart=function(b){g.enabled&&void 0!==window.MSGesture&&(g._MSGestureHandler||(g._MSGestureHandler=new MSGesture,g._MSGestureHandler.target=a),g._MSGestureHandler.addPointer(b.pointerId))},this._onGesture=function(a){g.enabled&&(1!==a.scale?(g.inertialRadiusOffset+=65*a.scale*(a.expansion>0?1:-1),h=!0):h=!1,a.preventDefault&&(b||(a.stopPropagation(),a.preventDefault())))},this._reset=function(){g._keys=[],g.inertialAlphaOffset=0,g.inertialBetaOffset=0,e=null,f=null});var j=window.PointerEvent?"pointer":"mouse";a.addEventListener(j+"down",this._onPointerDown,!1),a.addEventListener(j+"up",this._onPointerUp,!1),a.addEventListener(j+"out",this._onPointerUp,!1),a.addEventListener(j+"move",this._onPointerMove,!1),a.addEventListener("mousemove",this._onMouseMove,!1),a.addEventListener("MSPointerDown",this._onGestureStart,!1),a.addEventListener("MSGestureChange",this._onGesture,!1),window.addEventListener("keydown",this._onKeyDown,!1),window.addEventListener("keyup",this._onKeyUp,!1),a.addEventListener("mousewheel",this._wheel,!1),window.addEventListener("DOMMouseScroll",this._wheel,!1),window.addEventListener("blur",this._onLostFocus,!1)}},a.prototype.detachControl=function(a){if(this._attachedCanvas==a){var b=window.PointerEvent?"pointer":"mouse";a.removeEventListener(b+"down",this._onPointerDown,!1),a.removeEventListener(b+"up",this._onPointerUp,!1),a.removeEventListener(b+"out",this._onPointerUp,!1),a.removeEventListener(b+"move",this._onPointerMove,!1),a.removeEventListener("mousemove",this._onMouseMove,!1),a.removeEventListener("MSPointerDown",this._onGestureStart,!1),a.removeEventListener("MSGestureChange",this._onGesture,!1),window.removeEventListener("keydown",this._onKeyDown),window.removeEventListener("keyup",this._onKeyUp),a.removeEventListener("mousewheel",this._wheel),window.removeEventListener("DOMMouseScroll",this._wheel,!1),window.removeEventListener("blur",this._onLostFocus),this._MSGestureHandler=null,this._attachedCanvas=null,this._reset&&this._reset()}},a.prototype._update=function(){for(var a=0;a<this._keys.length;a++){var b=this._keys[a];ujs.notify("hcs.engine3D.camera.move"),-1!==this.keysLeft.indexOf(b)?this.inertialAlphaOffset-=.01:-1!==this.keysUp.indexOf(b)?this.inertialBetaOffset-=.01:-1!==this.keysRight.indexOf(b)?this.inertialAlphaOffset+=.01:-1!==this.keysDown.indexOf(b)&&(this.inertialBetaOffset+=.01)}(0!=this.inertialAlphaOffset||0!=this.inertialBetaOffset||0!=this.inertialRadiusOffset)&&(this.alpha+=this.inertialAlphaOffset,this.beta+=this.inertialBetaOffset,this.radius-=this.inertialRadiusOffset,this.inertialAlphaOffset*=this.inertia,this.inertialBetaOffset*=this.inertia,this.inertialRadiusOffset*=this.inertia,Math.abs(this.inertialAlphaOffset)<BABYLON.Engine.epsilon&&(this.inertialAlphaOffset=0),Math.abs(this.inertialBetaOffset)<BABYLON.Engine.epsilon&&(this.inertialBetaOffset=0),Math.abs(this.inertialRadiusOffset)<BABYLON.Engine.epsilon&&(this.inertialRadiusOffset=0)),this.lowerAlphaLimit&&this.alpha<this.lowerAlphaLimit&&(this.alpha=this.lowerAlphaLimit),this.upperAlphaLimit&&this.alpha>this.upperAlphaLimit&&(this.alpha=this.upperAlphaLimit),this.lowerBetaLimit&&this.beta<this.lowerBetaLimit&&(this.beta=this.lowerBetaLimit),this.upperBetaLimit&&this.beta>this.upperBetaLimit&&(this.beta=this.upperBetaLimit),this.lowerRadiusLimit&&this.radius<this.lowerRadiusLimit&&(this.radius=this.lowerRadiusLimit),this.upperRadiusLimit&&this.radius>this.upperRadiusLimit&&(this.radius=this.upperRadiusLimit),this._constraintToUpScene()},a.prototype.setPosition=function(a){var b=a.subtract(this._getTargetPosition());this.radius=b.length(),this.alpha=Math.atan(b.z/b.x),this.beta=Math.acos(b.y/this.radius)},a.prototype._getViewMatrix=function(){this.beta>Math.PI&&(this.beta=Math.PI),this.beta<=0&&(this.beta=.01);var a=Math.cos(this.alpha),b=Math.sin(this.alpha),c=Math.cos(this.beta),d=Math.sin(this.beta),e=this._getTargetPosition();return e.addToRef(new BABYLON.Vector3(this.radius*a*d,this.radius*c,this.radius*b*d),this.position),BABYLON.Matrix.LookAtLHToRef(this.position,e,this.upVector,this._viewMatrix),this._viewMatrix},a.prototype._constraintToUpScene=function(){var a=3,b=-(this.target.y-a)/this.radius;if(!(Math.abs(b)>1)){var c=Math.abs(Math.acos(b));this.beta=BABYLON.Math.NormalizeAngle(this.beta),this.beta=Math.min(this.beta,c),this.beta=Math.max(this.beta,-c)}},a}();var hcs=window.hcs||{};hcs.Input=hcs.Input||{},hcs.Input.FirstPersonCamera=function(){var a=!1,b=function(a,c,d){BABYLON.Camera.call(this,a,c,d),this.cameraDirection=new BABYLON.Vector3(0,0,0),this.cameraRotation=new BABYLON.Vector2(0,0),this.rotation=new BABYLON.Vector3(0,0,0),this.ellipsoid=new BABYLON.Vector3(.5,1,.5),this._keys=[],this.keysUp=[38,87],this.keysDown=[40,83],this.keysLeft=[37,81],this.keysRight=[39,69],this.keysStrafeLeft=[65],this.keysStrafeRight=[68],GlobalHelper.hasAzertyKeyboard&&(this.keysUp[1]=90,this.keysLeft[1]=65,this.keysStrafeLeft[0]=81),this._collider=new BABYLON.Collider,this._needMoveForGravity=!0,this._currentTarget=BABYLON.Vector3.Zero(),this._viewMatrix=BABYLON.Matrix.Zero(),this._camMatrix=BABYLON.Matrix.Zero(),this._cameraTransformMatrix=BABYLON.Matrix.Zero(),this._cameraRotationMatrix=BABYLON.Matrix.Zero(),this._referencePoint=BABYLON.Vector3.Zero(),this._transformedReferencePoint=BABYLON.Vector3.Zero(),this._oldPosition=BABYLON.Vector3.Zero(),this._diffPosition=BABYLON.Vector3.Zero(),this._newPosition=BABYLON.Vector3.Zero(),this._lookAtTemp=BABYLON.Matrix.Zero(),this._tempMatrix=BABYLON.Matrix.Zero(),b.prototype._initCache.call(this)};b.prototype=Object.create(BABYLON.Camera.prototype);var c=BABYLON.Camera;return b.prototype.speed=2,b.prototype.checkCollisions=!1,b.prototype.applyGravity=!1,b.prototype.noRotationConstraint=!1,b.prototype.angularSensibility=2e3,b.prototype.lockedTarget=null,b.prototype.onCollide=null,b.prototype._getLockedTargetPosition=function(){return this.lockedTarget?this.lockedTarget.position||this.lockedTarget:null},b.prototype._onMessageBoxOpened=function(){a=!0},b.prototype._onMessageBoxClosed=function(){a=!1},b.prototype._initCache=function(){c.prototype._initCache.call(this),this._cache.lockedTarget=new BABYLON.Vector3(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE),this._cache.rotation=new BABYLON.Vector3(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE)},b.prototype._updateCache=function(a){a||c.prototype._updateCache.call(this);var b=this._getLockedTargetPosition();b?this._cache.lockedTarget?this._cache.lockedTarget.copyFrom(b):this._cache.lockedTarget=b.clone():this._cache.lockedTarget=null,this._cache.rotation.copyFrom(this.rotation)},b.prototype._isSynchronizedViewMatrix=function(){if(!BABYLON.Camera.prototype._isSynchronizedViewMatrix.call(this))return!1;var a=this._getLockedTargetPosition();return(this._cache.lockedTarget?this._cache.lockedTarget.equals(a):!a)&&this._cache.rotation.equals(this.rotation)},b.prototype._computeLocalCameraSpeed=function(){return this.speed*(BABYLON.Tools.GetDeltaTime()/(10*BABYLON.Tools.GetFps()))},b.prototype.setTarget=function(a){this.upVector.normalize(),BABYLON.Matrix.LookAtLHToRef(this.position,a,this.upVector,this._camMatrix),this._camMatrix.invert(),this.rotation.x=Math.atan(this._camMatrix.m[6]/this._camMatrix.m[10]);var b=a.subtract(this.position);this.rotation.y=b.x>=0?-Math.atan(b.z/b.x)+Math.PI/2:-Math.atan(b.z/b.x)-Math.PI/2,this.rotation.z=-Math.acos(BABYLON.Vector3.Dot(new BABYLON.Vector3(0,1,0),this.upVector)),isNaN(this.rotation.x)&&(this.rotation.x=0),isNaN(this.rotation.y)&&(this.rotation.y=0),isNaN(this.rotation.z)&&(this.rotation.z=0)},b.prototype.lockUnrelatedActions=function(){var a=hcsdesign.getComponentByName("EditionComponent3D");return a&&(ujs.notify("hcs.request.configurator.cancel"),a.lock(this,14),a.deselectObject()),!0},b.prototype.unlockUnrelatedActions=function(){var a=hcsdesign.getComponentByName("EditionComponent3D");return a&&a.unlock(this,14),!0},b.prototype.attachControl=function(b,c){var d,e=this,f=this._scene.getEngine();if(!this._attachedCanvas){document.addEventListener("hcs.ui.messagebox.opened",this._onMessageBoxOpened,!1),document.addEventListener("hcs.ui.messagebox.closed",this._onMessageBoxClosed,!1),this.lockUnrelatedActions(),this._attachedCanvas=b,void 0===this._onMouseDown&&(this.onMouseDown=function(a){d=a.touches&&1==a.touches.length?{x:a.touches[0].pageX,y:a.touches[0].pageY}:{x:a.clientX,y:a.clientY},c||a.preventDefault()},this.onMouseUp=function(a){d=null,c||a.preventDefault()},this.onMouseOut=function(a){d=null,e._keys=[],c||a.preventDefault()},this.onMouseMove=function(a){if(d||f.isPointerLock){var b,g;a.touches&&1==a.touches.length?(b=a.touches[0].pageX-d.x,g=a.touches[0].pageY-d.y,d={x:a.touches[0].pageX,y:a.touches[0].pageY}):f.isPointerLock?(b=a.movementX||a.mozMovementX||a.webkitMovementX||a.msMovementX||0,g=a.movementY||a.mozMovementY||a.webkitMovementY||a.msMovementY||0):(b=a.clientX-d.x,g=a.clientY-d.y,d={x:a.clientX,y:a.clientY}),a.touches||(b*=-1,g*=-1),e.rotation.y-=b/e.angularSensibility,e.rotation.x-g/e.angularSensibility<Math.PI/2&&e.rotation.x-g/e.angularSensibility>-Math.PI/2&&(e.rotation.x-=g/e.angularSensibility),c||a.preventDefault()}},this.onWheel=function(a){var b=0;a.wheelDelta?b=a.wheelDelta/(120*e.radiusSpeedFactor):a.detail&&(b=-a.detail/(3*e.radiusSpeedFactor)),e.height+b<e.heightMax&&e.height+b>e.heightMin&&(e.height+=b,e.position.y=e.height),a.preventDefault&&(c||a.preventDefault())},this.onKeyDown=function(b){if(!a&&(-1!==e.keysUp.indexOf(b.keyCode)||-1!==e.keysDown.indexOf(b.keyCode)||-1!==e.keysLeft.indexOf(b.keyCode)||-1!==e.keysRight.indexOf(b.keyCode)||-1!==e.keysStrafeLeft.indexOf(b.keyCode)||-1!==e.keysStrafeRight.indexOf(b.keyCode))){var d=e._keys.indexOf(b.keyCode);-1===d&&e._keys.push(b.keyCode),c||b.preventDefault()}},this.onKeyUp=function(b){if(!a&&(-1!==e.keysUp.indexOf(b.keyCode)||-1!==e.keysDown.indexOf(b.keyCode)||-1!==e.keysLeft.indexOf(b.keyCode)||-1!==e.keysRight.indexOf(b.keyCode)||-1!==e.keysStrafeLeft.indexOf(b.keyCode)||-1!==e.keysStrafeRight.indexOf(b.keyCode))){var d=e._keys.indexOf(b.keyCode);d>=0&&e._keys.splice(d,1),c||b.preventDefault()}},this.onLostFocus=function(){e._keys=[]},this.reset=function(){e._keys=[],d=null,e.cameraDirection=new BABYLON.Vector3(0,0,0),e.cameraRotation=new BABYLON.Vector2(0,0)});var g=window.PointerEvent?"pointer":"mouse";b.addEventListener(g+"down",this.onMouseDown,!1),b.addEventListener(g+"up",this.onMouseUp,!1),b.addEventListener(g+"out",this.onMouseOut,!1),b.addEventListener(g+"move",this.onMouseMove,!1),b.addEventListener("mousewheel",this.onWheel,!1),window.addEventListener("keydown",this.onKeyDown,!1),window.addEventListener("keyup",this.onKeyUp,!1),window.addEventListener("blur",this.onLostFocus,!1),document.addEventListener("touchend",this.onMouseUp,!1),document.addEventListener("touchcancel",this.onMouseUp,!1),document.addEventListener("touchmove",this.onMouseMove,!1),document.addEventListener("touchstart",this.onMouseDown,!1)}},b.prototype.detachControl=function(a){if(this._attachedCanvas==a){this.unlockUnrelatedActions();var b=window.PointerEvent?"pointer":"mouse";a.removeEventListener(b+"down",this.onMouseDown),a.removeEventListener(b+"up",this.onMouseUp),a.removeEventListener(b+"out",this.onMouseOut),a.removeEventListener(b+"move",this.onMouseMove),a.removeEventListener("mousewheel",this.onWheel),window.removeEventListener("keydown",this.onKeyDown),window.removeEventListener("keyup",this.onKeyUp),window.removeEventListener("blur",this.onLostFocus),document.removeEventListener("touchend",this.onMouseUp),document.removeEventListener("touchcancel",this.onMouseUp),document.removeEventListener("touchmove",this.onMouseMove),document.removeEventListener("touchstart",this.onMouseDown),document.removeEventListener("hcs.ui.messagebox.opened",this._onMessageBoxOpened),document.removeEventListener("hcs.ui.messagebox.closed",this._onMessageBoxClosed),this._attachedCanvas=null,this._reset&&this._reset()}},b.prototype._collideWithWorld=function(a){this.position.subtractFromFloatsToRef(0,this.ellipsoid.y,0,this._oldPosition),this._collider.radius=this.ellipsoid,this._scene._getNewPosition(this._oldPosition,a,this._collider,3,this._newPosition),this._newPosition.subtractToRef(this._oldPosition,this._diffPosition),this._diffPosition.length()>BABYLON.Engine.collisionsEpsilon&&(this.position.addInPlace(this._diffPosition),this.onCollide&&this.onCollide(this._collider.collidedMesh))},b.prototype._checkInputs=function(){this._localDirection||(this._localDirection=BABYLON.Vector3.Zero(),this._transformedDirection=BABYLON.Vector3.Zero()),this._localRotation||(this._localRotation=BABYLON.Vector3.Zero(),this._transformedRotation=BABYLON.Vector3.Zero());for(var a=0;a<this._keys.length;a++){var b=this._keys[a],c=this._computeLocalCameraSpeed(),d=BABYLON.Tools.GetFps()/60;-1!==this.keysLeft.indexOf(b)?this._localRotation.copyFromFloats(0,-c/3*d,0):-1!==this.keysUp.indexOf(b)?this._localDirection.copyFromFloats(0,0,100*c*d):-1!==this.keysRight.indexOf(b)?this._localRotation.copyFromFloats(0,c/3*d,0):-1!==this.keysDown.indexOf(b)?this._localDirection.copyFromFloats(0,0,100*-c*d):-1!==this.keysStrafeLeft.indexOf(b)?this._localDirection.copyFromFloats(100*-c*d,0,0):-1!==this.keysStrafeRight.indexOf(b)&&this._localDirection.copyFromFloats(100*c*d,0,0),this.getViewMatrix().invertToRef(this._cameraTransformMatrix),-1!==this.keysUp.indexOf(b)||-1!==this.keysDown.indexOf(b)||-1!==this.keysStrafeLeft.indexOf(b)||-1!==this.keysStrafeRight.indexOf(b)?(BABYLON.Vector3.TransformNormalToRef(this._localDirection,this._cameraTransformMatrix,this._transformedDirection),this.position.addInPlace(this._transformedDirection)):(BABYLON.Vector3.TransformNormalToRef(this._localRotation,this._cameraTransformMatrix,this._transformedRotation),this.rotation.y+=this._transformedRotation.y),this.position.y=this.height}},b.prototype.moveLocal=function(a){BABYLON.Vector3.TransformNormalToRef(a,this._cameraTransformMatrix,this._transformedDirection),this.position.addInPlace(this._transformedDirection)},b.prototype.rotateLocal=function(a){this._transformedRotation=BABYLON.Vector3.Zero(),BABYLON.Vector3.TransformNormalToRef(a,this._cameraTransformMatrix,this._transformedRotation),this.rotation.x+=this._transformedRotation.x,this.rotation.x=ujs.Math.clamp(this.rotation.x,-Math.PI/2,Math.PI/2),this.rotation.y+=this._transformedRotation.y},b.prototype._update=function(){this._checkInputs();var a=this._needMoveForGravity||Math.abs(this.cameraDirection.x)>0||Math.abs(this.cameraDirection.y)>0||Math.abs(this.cameraDirection.z)>0,b=Math.abs(this.cameraRotation.x)>0||Math.abs(this.cameraRotation.y)>0;if(a)if(this.checkCollisions&&this._scene.collisionsEnabled){if(this._collideWithWorld(this.cameraDirection),this.applyGravity){var c=this.position;this._collideWithWorld(this._scene.gravity),this._needMoveForGravity=0!=BABYLON.Vector3.DistanceSquared(c,this.position)}}else this.position.addInPlace(this.cameraDirection);if(b&&(this.rotation.x+=this.cameraRotation.x,this.rotation.y+=this.cameraRotation.y,!this.noRotationConstraint)){var d=Math.PI/2*.95;this.rotation.x>d&&(this.rotation.x=d),this.rotation.x<-d&&(this.rotation.x=-d)}a&&(Math.abs(this.cameraDirection.x)<BABYLON.Engine.epsilon&&(this.cameraDirection.x=0),Math.abs(this.cameraDirection.y)<BABYLON.Engine.epsilon&&(this.cameraDirection.y=0),Math.abs(this.cameraDirection.z)<BABYLON.Engine.epsilon&&(this.cameraDirection.z=0),this.cameraDirection.scaleInPlace(this.inertia)),b&&(Math.abs(this.cameraRotation.x)<BABYLON.Engine.epsilon&&(this.cameraRotation.x=0),Math.abs(this.cameraRotation.y)<BABYLON.Engine.epsilon&&(this.cameraRotation.y=0),this.cameraRotation.scaleInPlace(this.inertia))
},b.prototype._getViewMatrix=function(){return BABYLON.Vector3.FromFloatsToRef(0,0,1,this._referencePoint),this.lockedTarget?this._currentTarget.copyFrom(this._getLockedTargetPosition()):(0!=this.upVector.x||1!=this.upVector.y||0!=this.upVector.z?(BABYLON.Matrix.LookAtLHToRef(BABYLON.Vector3.Zero(),this._referencePoint,this.upVector,this._lookAtTemp),BABYLON.Matrix.RotationYawPitchRollToRef(this.rotation.y,this.rotation.x,this.rotation.z,this._cameraRotationMatrix),this._lookAtTemp.multiplyToRef(this._cameraRotationMatrix,this._tempMatrix),this._lookAtTemp.invert(),this._tempMatrix.multiplyToRef(this._lookAtTemp,this._cameraRotationMatrix)):BABYLON.Matrix.RotationYawPitchRollToRef(this.rotation.y,this.rotation.x,this.rotation.z,this._cameraRotationMatrix),BABYLON.Vector3.TransformCoordinatesToRef(this._referencePoint,this._cameraRotationMatrix,this._transformedReferencePoint),this.position.addToRef(this._transformedReferencePoint,this._currentTarget)),BABYLON.Matrix.LookAtLHToRef(this.position,this._currentTarget,this.upVector,this._viewMatrix),this._viewMatrix},b}();var hcs=window.hcs||{};hcs.Input=hcs.Input||{},hcs.Input.TouchManager=function(a){var b=[{x:0,y:0},{x:0,y:0}],c=[{x:0,y:0},{x:0,y:0}],d={x:0,y:0,reset:function(){this.x=0,this.y=0},update:function(){this.x=b[0].x-c[0].x,this.y=b[0].y-c[0].y}},e={timer:0,duration:200},f={sx:0,sy:0,timer:null,duration:900,deadZone:5},g=!1,h=2,i=!1,j=0,k=0,l=0,m=!1,n={},o=null,p=-1;this.on=function(a,b){n[a]=b},this.off=function(a){delete n[a]},this.setDeadZone=function(a){h=a};var q=function(a,c){var d=document.createEvent("HTMLEvents");d.initEvent(a,!0,!1),d.pageX=b[0].x,d.pageY=b[0].y,d.clientX=b[0].x,d.clientY=b[0].y,d.detail=-j,d.distance=k,d.wheelDeltaY=o?j:+(k-l)>0?2.5:-2.5,d.button=0;for(var e in c)d[e]=c[e];return d},r=function(a,b){n[a]&&n[a](q(a,b))},s=function(a,b){var c=a.x-b.x,d=a.y-b.y;return Math.sqrt(c*c+d*d)},t=function(a,d,e){e||(c[d].x=b[d].x,c[d].y=b[d].y),window.PointerEvent&&a instanceof window.PointerEvent||window.MSPointerEvent&&a instanceof MSPointerEvent?(b[d].x=a.clientX||a.pageX,b[d].y=a.clientY||a.pageY):a.touches&&(b[d].x=a.touches[d].clientX||a.touches[d].pageX,b[d].y=a.touches[d].clientY||a.touches[d].pageY),e&&(c[d].x=b[d].x,c[d].y=b[d].y)},u=function(a,b){t(a,0,b),a.touches&&a.touches.length>1&&t(a,1,b)},v=function(a){if(a.preventDefault(),!("pointerdown"===a.type&&p>-1)){p=a.pointerId,g=!0,i=!1,u(a,!0);var c=0;a.touches&&a.touches.length>1&&(c=1),r("touchDown",{button:c}),a.touches&&1===a.touches.length||p?(r("tap"),e.timer?(clearTimeout(e.timer),e.timer=null,r("dblTap")):e.timer=setTimeout(function(){clearTimeout(e.timer),e.timer=null},e.duration),f.timer&&clearTimeout(f.timer),f.sx=b[0].x,f.sy=b[0].y,f.timer=setTimeout(function(){clearTimeout(f.timer),f.timer=null;var a=b[0].x-f.sx,c=b[0].y-f.sy;Math.abs(a)<f.deadZone&&Math.abs(c)<f.deadZone&&r("longPress")},f.duration)):a.touches&&a.touches.length>1&&r("touchUp")}},w=function(a){if(!(m||"pointerdown"===a.type&&a.pointerId!==p)&&(a.preventDefault(),u(a),d.update(),i||(i=Math.abs(d.x)>h||Math.abs(d.y)>h)))if(a.touches&&2==a.touches.length){r("touchUp");var e=b[0].x-c[0].x,f=b[1].y-c[1].y;l=k,k=s(b[0],b[1]),j=Math.abs(e)>Math.abs(f)?e:f,r("swipe"),r("rotate")}else g&&r("touchMove")},x=function(a){j=0,k=0,l=0,g=!1,i=!1,a.pointerId&&p===a.pointerId&&(p=-1),f.timer&&(clearTimeout(f.timer),f.timer=null),r("touchUp")},y=function(b){void 0!==window.MSGesture&&(o||(o=new MSGesture,o.target=a),o.addPointer(b.pointerId))},z=function(a){1!==a.scale?(j=50*a.scale*(a.expansion>0?1:-1),m=!0,r("touchUp"),r("swipe"),r("rotate"),a.stopPropagation(),a.preventDefault()):m=!1},A=GlobalHelper.getWrappedMouseEventNames();this.start=function(){a.addEventListener(A.down,v,!1),a.addEventListener(A.move,w,!1),a.addEventListener(A.up,x,!1),a.addEventListener(A.cancel,x,!1),A.out&&a.addEventListener(A.out,x,!1),a.addEventListener("MSPointerDown",y,!1),a.addEventListener("MSGestureChange",z,!1)},this.stop=function(){a.removeEventListener(A.down,v),a.removeEventListener(A.move,w),a.removeEventListener(A.up,x),a.removeEventListener(A.cancel,x),A.out&&a.removeEventListener(A.out,x),a.removeEventListener("MSPointerDown",y),a.removeEventListener("MSGestureChange",z)}};var hcs=window.hcs||{};hcs.PointerManager=function(){var a=function(a,b,c,d){var d=d||{};this.BUTTON_LEFT=1,this.BUTTON_MIDDLE=2,this.BUTTON_RIGHT=4,this.ACTION_CLICK=1,this.ACTION_DBLCLICK=2,this.ACTION_DRAGSTART=4,this.ACTION_DRAGGING=8,this.ACTION_DRAGEND=16,this.ACTION_SCROLLUP=32,this.ACTION_SCROLLDOWN=64,this.MODIFIER_ALT=1,this.MODIFIER_CTRL=2,this.MODIFIER_SHIFT=4,this.pos=new BABYLON.Vector2,this.posDelta=new BABYLON.Vector2,this.buttons=0,this.actions=0,this.modifiers=0,this._core=a||hcsdesign,this._callback=b||null,this._domElement=c||document.body,this._offsets=d.offsets||new BABYLON.Vector2,this._width=d.width||this._domElement.clientWidth,this._height=d.height||this._domElement.clientHeight,this._lastState=this.getStatus(),this._initialised=!1,this.touchManager=new hcs.Input.TouchManager(this._domElement),this.setDomElement(this._domElement),this.mode=0};return a.prototype.setDomElement=function(a){this._domElement=a,this.onMouseDown=this.onMouseDown.bind(this),this.onMouseMove=this.onMouseMove.bind(this),this.onMouseUp=this.onMouseUp.bind(this),this.onMouseDoubleClick=this.onMouseDoubleClick.bind(this),this.onMouseWheel=this.onMouseWheel.bind(this),this.addTouchSupport(),this.addMouseSupport()},a.prototype.addMouseSupport=function(){window.PointerEvent?(this._domElement.addEventListener("pointerdown",this.onMouseDown,!1),this._domElement.addEventListener("pointermove",this.onMouseMove,!1),this._domElement.addEventListener("pointerup",this.onMouseUp,!1),document.addEventListener("pointerup",this.onMouseUp,!1)):(this._domElement.addEventListener("mousedown",this.onMouseDown,!1),this._domElement.addEventListener("mousemove",this.onMouseMove,!1),this._domElement.addEventListener("mouseup",this.onMouseUp,!1),document.addEventListener("mouseup",this.onMouseUp,!1)),this._domElement.addEventListener("dblclick",this.onMouseDoubleClick,!1),this._domElement.addEventListener("mousewheel",this.onMouseWheel,!1),this._domElement.addEventListener("DOMMouseScroll",this.onMouseWheel,!1)},a.prototype.removeMouseSupport=function(){window.PointerEvent?(this._domElement.removeEventListener("pointerdown",this.onMouseDown),this._domElement.removeEventListener("pointermove",this.onMouseMove),this._domElement.removeEventListener("pointerup",this.onMouseUp),document.removeEventListener("pointerup",this.onMouseUp)):(this._domElement.removeEventListener("mousedown",this.onMouseDown),this._domElement.removeEventListener("mousemove",this.onMouseMove),this._domElement.removeEventListener("mouseup",this.onMouseUp),document.removeEventListener("mouseup",this.onMouseUp)),this._domElement.removeEventListener("dblclick",this.onMouseDoubleClick),this._domElement.removeEventListener("mousewheel",this.onMouseWheel),this._domElement.removeEventListener("DOMMouseScroll",this.onMouseWheel),this.mode=1},a.prototype.addTouchSupport=function(){this.touchManager.start(),this.touchManager.on("tap",this.onMouseDown),this.touchManager.on("touchMove",this.onMouseMove),this.touchManager.on("touchUp",this.onMouseUp),this.touchManager.on("longPress",this.onMouseDoubleClick),this.touchManager.on("swipe",this.onMouseWheel)},a.prototype.removeTouchSupport=function(){this.touchManager.stop(),this.touchManager.off("tap",this.onMouseDown),this.touchManager.off("touchMove",this.onMouseMove),this.touchManager.off("touchUp",this.onMouseUp),this.touchManager.off("longPress",this.onMouseDoubleClick),this.touchManager.off("swipe",this.onMouseWheel),this.mode=2},a.prototype.getStatus=function(){var a={};return a.BUTTON_LEFT=this.BUTTON_LEFT,a.BUTTON_MIDDLE=this.BUTTON_MIDDLE,a.BUTTON_RIGHT=this.BUTTON_RIGHT,a.ACTION_CLICK=this.ACTION_CLICK,a.ACTION_DBLCLICK=this.ACTION_DBLCLICK,a.ACTION_DRAGSTART=this.ACTION_DRAGSTART,a.ACTION_DRAGGING=this.ACTION_DRAGGING,a.ACTION_DRAGEND=this.ACTION_DRAGEND,a.ACTION_SCROLLUP=this.ACTION_SCROLLUP,a.ACTION_SCROLLDOWN=this.ACTION_SCROLLDOWN,a.MODIFIER_ALT=this.MODIFIER_ALT,a.MODIFIER_CTRL=this.MODIFIER_CTRL,a.MODIFIER_SHIFT=this.MODIFIER_SHIFT,a.pos=this.pos.clone(),a.posDelta=this.posDelta.clone(),a.buttons=this.buttons,a.prevButtons=this._lastState?this._lastState.buttons:0,a.actions=this.actions,a.modifiers=this.modifiers,a.planPos=this.pos.clone(),a.planPos.subtractInPlace(this._core.engine2D.getTranslation()),a.planPos.scaleInPlace(1/this._core.engine2D.getZoom()),a.plan3DPos=new BABYLON.Vector2(this.pos.x/this._core.getWidth()*2-1,2*-(this.pos.y/this._core.getHeight())+1),a},a.prototype.reset=function(){this.buttons=0,this.actions=0,this.posDelta=new BABYLON.Vector2(0,0)},a.prototype.resize=function(a,b){this._width=a||this._domElement.clientWidth||this._domElement.innerWidth,this._height=b||this._domElement.clientHeight||this._domElement.innerHeight},a.prototype._getX=function(a){var b=0;return a.pageX?b=a.pageX:a.clientX&&(b=a.clientX+(document.documentElement.scrollLeft?document.documentElement.scrollLeft:document.body.scrollLeft)),b},a.prototype._getY=function(a){var b=0;return a.pageY?b=a.pageY:a.clientY&&(b=a.clientY+(document.documentElement.scrollTop?document.documentElement.scrollTop:document.body.scrollTop)),b},a.prototype._getButton=function(a){if(a.touches&&a.touches.length>0)return this.BUTTON_LEFT;switch(a.button){case 0:return this.BUTTON_LEFT;case 1:return this.BUTTON_MIDDLE;case 2:return this.BUTTON_RIGHT}return 0},a.prototype._updateMouseState=function(a,b){var c=a;(GlobalHelper.isMobileDevice()||c.target&&"canvas"==c.target.tagName.toLowerCase()||this.preventDefault)&&c.preventDefault(),"undefined"!=typeof a.touches&&a.touches.length>0&&(c=a.touches[0]);var b=b||0,d=this._getX(c),e=this._getY(c);d+e>0&&this.pos.copyFromFloats(d,e),this._initialised||(this._initialised=!0,this._lastState.pos.copyFrom(this.pos)),this.posDelta=this.pos.subtract(this._lastState.pos),"tap"==c.type&&(this.posDelta=new BABYLON.Vector2(0,0)),this.actions=0,this.actions|=b,0==this.buttons&&this._lastState.buttons>0&&0==(this._lastState.actions&this.ACTION_DRAGGING)&&0==(this._lastState.actions&this.ACTION_DBLCLICK)?this.actions|=this.ACTION_CLICK:this.buttons>0&&0==this._lastState.actions&&(0!=this.posDelta.x||0!=this.posDelta.y)?(this.actions|=this.ACTION_DRAGSTART,this.pos.x=this._lastState.pos.x,this.pos.y=this._lastState.pos.y):this.buttons>0&&((this._lastState.actions&this.ACTION_DRAGSTART)>0||(this._lastState.actions&this.ACTION_DRAGGING)>0)?this.actions|=this.ACTION_DRAGGING:0==this.buttons&&((this._lastState.actions&this.ACTION_DRAGSTART)>0||(this._lastState.actions&this.ACTION_DRAGGING)>0)&&(this.actions|=this.ACTION_DRAGEND),this.modifiers=0,c.altKey&&(this.modifiers|=this.MODIFIER_ALT),c.ctrlKey&&(this.modifiers|=this.MODIFIER_CTRL),c.shiftKey&&(this.modifiers|=this.MODIFIER_SHIFT),this._notifyCb(c),this._lastState=this.getStatus()},a.prototype._notifyCb=function(a){null!=this._callback&&(this._callback(a,this.getStatus()),ujs.notify("hcs.input.pointerchanged",{inputStatus:this.getStatus()}))},a.prototype.onMouseDown=function(a){this.buttons|=this._getButton(a),this._updateMouseState(a)},a.prototype.onMouseMove=function(a){this._updateMouseState(a),a.preventDefault()},a.prototype.onMouseUp=function(a){this.buttons&=!this._getButton(a),this._updateMouseState(a)},a.prototype.onMouseDoubleClick=function(a){this._updateMouseState(a,this.ACTION_DBLCLICK)},a.prototype.onMouseWheel=function(a){var b=0;a.wheelDeltaY?b=a.wheelDeltaY:a.wheelDelta?b=a.wheelDelta:a.detail&&(b=-a.detail),0!=b&&(b>0?this._updateMouseState(a,this.ACTION_SCROLLUP):this._updateMouseState(a,this.ACTION_SCROLLDOWN),a.preventDefault())},a}();var Keys={up:38,down:40,left:37,right:39,space:32,escape:27,shift:16,ctrl:17,alt:18,tab:9,a:65,z:90,e:69,q:81,s:83,d:68,r:82,cmd:91},hcs=window.hcs||{};hcs.KeyboardManager=function(){function a(a){for(var b=0;110>b;b++)a[b]=!1}var b,c=[],d=function(){this.keys=[],this.preventDefault=!1,this.initialized=!1;for(var a=0;110>a;a++)this.keys[a]=!1;c=[8],b=this};return d.prototype.initialize=function(){a(this.keys),this.startEventsListening()},d.prototype.destroy=function(){a(this.keys),this.stopEventsListening()},d.prototype.startEventsListening=function(){this.initialized||(document.addEventListener("keydown",this.onKeyStateChange,!1),document.addEventListener("keyup",this.onKeyStateChange,!1),window.addEventListener("focus",this.onFocus,!1),this.initialized=!0)},d.prototype.stopEventsListening=function(){this.initialized&&(document.removeEventListener("keydown",this.onKeyStateChange),document.removeEventListener("keyup",this.onKeyStateChange),window.removeEventListener("focus",this.onFocus,!1),this.initialized=!1)},d.prototype.onFocus=function(){for(var a=0;a<b.keys.length;a++)b.keys[a]=!1},d.prototype.onKeyStateChange=function(a){var d="keydown"==a.type?!0:!1,e="keydown"==a.type?"hcs.keyboardManager.keyDown":"hcs.keyboardManager.keyUp";if(ujs.notify(e,a),"INPUT"==document.activeElement.nodeName||"TEXTAREA"==document.activeElement.nodeName);else if(b.preventDefault===!0)a.preventDefault();else for(var f=0,g=c.length;g>f;f++)a.keyCode==c[f]&&a.preventDefault();b.keys[a.keyCode]=d},d.prototype.isPressed=function(a){if(a instanceof Array){for(var b=!1,c=0,d=this.keys.length;d>c&&!b;)b=this.keys[a[c]],c++;return b}return this.keys[a]},d.prototype.isReleased=function(a){return!this.isPressed(a)},d}();var hcs=window.hcs||{};hcs.MaterialFactory=function(){var a=function(a){this.configuration=a};return a.prototype.mergeParams=function(a,b){var a=a||{},b=b||{},c=a;for(var d in b)c[d]=b[d];return c},a.RepeatTextureXY=function(a,b,c){return a.uScale=b,a.vScale=c,a},a.MakeBasicMaterial=function(a){a.ambientColor.copyFromFloats(.6,.6,.6),a.diffuseColor.copyFromFloats(0,0,0),a.specularColor.copyFromFloats(0,0,0),a.emissiveColor.copyFromFloats(.05,.05,.05)},a.MakeBasicColor=function(a,b){a.ambientColor.copyFromFloats(0,0,0),a.specularColor.copyFromFloats(0,0,0),a.diffuseColor.copyFromFloats(0,0,0),a.emissiveColor.copyFrom(b)},a.MakeDefaultMaterial=function(a){a.ambientColor.copyFromFloats(.2,.2,.2),a.diffuseColor.copyFromFloats(0,0,0),a.specularColor.copyFromFloats(.7,.7,.7),a.specularPower=10},a.ImportWNPMaterial=function(b){var c=b.materialType;if(b=b||{},b.url&&(b.diffuseTexture=b.url),b.maps)for(var d in b.maps)"normal"==d?b.bumpTexture=b.url.replace(".jpg",b.maps[d]+".jpg"):b[d+"Texture"]=b.url.replace(".jpg",b.maps[d]+".jpg");c=-1!==c.indexOf("hcs.")?c:"hcs."+(c.charAt("0").toUpperCase()+c.slice(1))+"Material";var e=ujs.getProperty(window,c);e?e=new e(b.name||"ImportedMaterial",hcsdesign.engine3D.scene):(e=new BABYLON.StandardMaterial(b.name||"ImportedMaterial",hcsdesign.engine3D.scene),this.MakeDefaultMaterial(e)),b.color&&(e.diffuseColor.copyFrom(b.color),e.params.baseColor=b.color);for(var f in b)void 0!==e[f]&&null!==e[f]?b[f]instanceof Array&&e[f].fromArray?e[f].fromArray(b[f]):b[f]instanceof Object&&e[f].copyFrom?e[f].copyFrom(b[f]):-1!==f.indexOf("Texture")?(e[f]=new BABYLON.Texture(b[f],hcsdesign.engine3D.scene),e[f].vScale=b.vScale||b.scale||1,e[f].uScale=b.uScale||b.scale||1,e[f].hasAlpha=b.hasAlpha||!1):e[f]=b[f]:-1!==f.indexOf("Texture")?(e[f]=new BABYLON.Texture(b[f],hcsdesign.engine3D.scene),e[f].vScale=b.vScale||b.scale||1,e[f].uScale=b.uScale||b.scale||1):e[f]=b[f];if((-1!=c.indexOf("Glass")||-1!=c.indexOf("Transparent")||-1!=c.indexOf("Metal"))&&b.addColor&&b.addColor.color)e.setBaseColor(b.addColor.color);else if(b.addColor&&b.addColor.color&&e.diffuseTexture){e.addColor=b.addColor,b.addColor.size=b.addColor.size||{width:512,height:512};var g=new Image,h=b.addColor.color;g.crossOrigin="Anonymous",g.src=e.diffuseTexture.url;var i=new BABYLON.DynamicTexture("canvas",b.addColor.size.width,hcsdesign.engine3D.scene,!0);i.url=e.diffuseTexture.url,e.diffuseTexture=i,e.diffuseColor=new BABYLON.Color3(h.r,h.g,h.b).scale(.2),g.onload=function(){var c=i.getContext();c.fillStyle=a.rgbToHex(h),c.clearRect(0,0,b.addColor.size.width,b.addColor.size.height),c.drawImage(g,0,0,b.addColor.size.width,b.addColor.size.height),c.globalCompositeOperation="soft-light",c.globalCompositeOperation="color-burn",c.globalCompositeOperation="multiply",c.fillRect(0,0,b.addColor.size.width,b.addColor.size.height),i.wrapU=BABYLON.Texture.WRAP_ADDRESSMODE,i.wrapV=BABYLON.Texture.WRAP_ADDRESSMODE,i.vScale=b.vScale||b.scale||1,i.uScale=b.uScale||b.scale||1,i.update()}}return e},a.rgbToHex=function(b,c){var d,e,f,c=c||!1,b=b||{r:1,g:1,b:1};return c?(d=b.r,e=b.g,f=b.b):(d=Math.round(255*b.r),e=Math.round(255*b.g),f=Math.round(255*b.b)),"#"+a.decToHex(d,2)+a.decToHex(e,2)+a.decToHex(f,2)},a.decToHex=function(a,b){for(var b=b||0,c=a.toString(16),d=c.length;b>d;d++)c="0"+c;return c},a}();var hcs=window.hcs||{};hcs.Structure=function(){function a(a){var b={};for(var c in a)b[c]=a[c].serialize();return b}function b(a,b){b.length=0;for(var c in a){var d=new window[a[c].name];d.deserialize(a[c]),d.updateReferences(d),b.push(d)}}var c=function(a){this.uuid=hcs.uuid.uuid4(),this.lastModified=(new Date).getTime(),this.name="planStructure",this.members=[],this.currentStructureIndex=0,this.version=a,this.lastMaterialsUsed=[],this.structureVersion=a,this.params={},this.customData={}};return c.prototype.clear=function(){this.members.length=0,this.currentStructureIndex=0,this.uuid=hcs.uuid.uuid4(),this.lastModified=(new Date).getTime(),this.params={}},c.prototype.getVersion=function(){return this.version},c.prototype.getLength=function(){return this.members.length},c.prototype.addElement=function(a){return-1==this.members.indexOf(a)?(a.id=this.members.push(a)-1,!0):!1},c.prototype.addToCurrentStructure=function(a){this.members[this.currentStructureIndex].add(a)},c.prototype.getElement=function(a){return a>-1&&a<this.members.length?this.members[a]:null},c.prototype.getElementByName=function(a){for(var b=this.members.length,c=0,d=null;b>c&&null===d;)d=this.members[c].name==a?this.members[c]:d,c++;return d},c.prototype.removeElement=function(a){var b=this.members.indexOf(a);return b>-1?(this.members.splice(b,1),this.reindexMembers(),!0):!1},c.prototype.getCurrentStructure=function(){return this.members[this.currentStructureIndex]},c.prototype.setCurrentStructureIndex=function(a){a>-1&&a<this.members.length&&(this.currentStructureIndex=a)},c.prototype.serialize=function(){function b(a){for(var c in a)"object"==typeof a[c]?b(a[c]):"number"==typeof a[c]&&(a[c]=Math.round(1e3*a[c])/1e3)}var c=this;c.lastModified=(new Date).getTime();var d={uuid:c.uuid,lastModified:c.lastModified,version:c.getVersion(),structureVersion:c.structureVersion,name:c.name,current:c.currentStructureIndex,members:a(c.members),lastMaterialsUsed:c.lastMaterialsUsed,params:c.params,customData:ujs.serializeObject(c.customData)};return b(d),JSON.stringify(d)},c.prototype.deserialize=function(a){var c=JSON.parse(a);return this.currentStructureIndex=0|+c.current,this.name=c.name,this.version=c.version,this.structureVersion=c.structureVersion,this.uuid=c.uuid||hcs.uuid.uuid4(),this.lastModified=c.lastModified||0,this.lastMaterialsUsed=c.lastMaterialsUsed||[],this.params=c.params||{},this.customData=ujs.deserializeObject(c.customData)||{},b(c.members,this.members),this.reindexMembers(),!0},c.prototype.addMemberAtIndex=function(a,b){this.members.splice(a,0,b),this.reindexMembers()},c.prototype.reindexMembers=function(){for(var a=0;a<this.members.length;a++)this.members[a].id=a},c.prototype.updateFloorElevations=function(){for(var a=0,b=0;b<this.members.length;b++){var c=this.getElement(b);c instanceof FloorStructure&&(c.elevation=a,a+=c.height)}},c}();var hcs=window.hcs||{};hcs.Configuration=function(){var a=null;LOCAL_STORAGE_CONFIGURATION_KEY="hcs.configuration";var b=function(){this.boundingSize={min:{x:-5e3,y:-5e3,z:-5e3},max:{x:5e3,y:5e3,z:5e3},getSize:function(){return{x:this.max.x-this.min.x,y:this.max.y-this.min.y,z:this.max.z-this.min.z}}},this.hardwareScalingLevel=1,this.hasMobileConfig=!1,this.maxTextureSize=1024,this.useAntialiasing=!0,this.useEnvMap=!0,this.useMultiLights=!0,this.useMultiTexturing=!0,this.useShadow=!0,this.useStats=!1,this.useAreaProcessing=!0,this.useRealtimeMeasure=!0,this.loadConfiguration(),a=this};return b.prototype.loadConfiguration=function(){var a=hcsLocalStorage.getItem(LOCAL_STORAGE_CONFIGURATION_KEY);if(null!=a){var b=JSON.parse(a);this.useAntialiasing=b.useAntialiasing,this.useAreaProcessing=b.useAreaProcessing,this.useRealtimeMeasure=b.useRealtimeMeasure,this.useShadow=b.useShadow,this.useEnvMap=b.useEnvMap,this.useMultiTexturing=b.useMultiTexturing,this.maxTextureSize=b.maxTextureSize,this.useMultiLights=b.useMultiLights,this.useStats=b.useStats,this.hasMobileConfig=b.hasMobileConfig,this.hardwareScalingLevel=b.hardwareScalingLevel?b.hardwareScalingLevel:1}return a?!0:!1},b.prototype.saveConfiguration=function(){var a=this.serialize();hcsLocalStorage.setItem(LOCAL_STORAGE_CONFIGURATION_KEY,a)},b.prototype.serialize=function(){var a={useAntialiasing:this.useAntialiasing,useAreaProcessing:this.useAreaProcessing,useRealtimeMeasure:this.useRealtimeMeasure,useShadow:this.useShadow,useEnvMap:this.useEnvMap,useMultiTexturing:this.useMultiTexturing,maxTextureSize:this.maxTextureSize,useMultiLights:this.useMultiLights,useStats:this.useStats,hasMobileConfig:this.hasMobileConfig,hardwareScalingLevel:this.hardwareScalingLevel};return JSON.stringify(a)},b.prototype.setQuality=function(a){a===hcs.Constants.GRAPHICS_FAST?(this.useAntialiasing=!1,this.useShadow=!1,this.useEnvMap=!1,this.useMultiTexturing=!1,this.useMultiLights=!1,this.hardwareScalingLevel=1.5):a===hcs.Constants.GRAPHICS_GOOD?(this.useAntialiasing=!0,this.useShadow=!1,this.useEnvMap=!1,this.useMultiTexturing=!0,this.useMultiLights=!0,this.hardwareScalingLevel=1):(this.useAntialiasing=!0,this.useShadow=!0,this.useEnvMap=!0,this.useMultiTexturing=!0,this.useMultiLights=!0,this.hardwareScalingLevel=1),this.saveConfiguration()},b}();var hcs=window.hcs||{};hcs.ComponentCollection=function(){var a=function(a){Array.call(this),this._core=a,this._componentsToRemove=[],this._initialized=!1,this._size=0};return a.prototype=Object.create(Array.prototype),a.prototype.addComponent=function(a){var b=new a(this._core);return this.addInstancedComponent(b)},a.prototype.addInstancedComponent=function(a){return a.dirty||this.getComponentByName(a.name)?null:(a.core||(a.core=this._core,a.structure=this._core.structure),this._initialized&&!a.initialized&&(a.initialize(),a.initialized=!0),this.push(a),this.sort(function(a,b){return b.priority-a.priority}),this._size++,a)},a.prototype.clear=function(){for(var a=0;a<this._size;a++)this[a].destroy();this._size=0,this.length=0},a.prototype.getComponent=function(a){return"string"==typeof a?this.getComponentByName(a):this[a]},a.prototype.removeComponent=function(a,b){var b="undefined"!=typeof b?b:!1,c=-1;if("number"==typeof a)c=a;else if("string"==typeof a){var d=this.getComponentByName(a);d&&(c=this.indexOf(d))}else c=this.indexOf(a);return 0>c||c>=this._size?null:b?(this[c].destroy(),this._size--,this.splice(c,1)):(this._componentsToRemove.push(this[c].name),null)},a.prototype.initialize=function(){if(!this._initialized){this._initialized=!0,this.checkDirtyComponents();for(var a=0;a<this._size;a++)this[a].initialize()}},a.prototype.update=function(a){for(var b=0;b<this._size;b++)this[b].update(a)},a.prototype.draw=function(a){for(var b=0;b<this._size;b++)this[b].draw(a)},a.prototype.checkDirtyComponents=function(){if(this._componentsToRemove.length){for(var a=0,b=this._componentsToRemove.length;b>a;a++)this.removeComponent(this._componentsToRemove[a],!0);this._componentsToRemove.length=0}},a.prototype.getComponentByName=function(a){for(var b=0;b<this._size;b++)if(this[b].name==a)return this[b];return null},a.prototype.size=function(){return this._size},a}();var hcs=window.hcs||{};hcs.Core=function(){function a(){var a=c.mode==c.MODE_EDITOR?f:0;c.setSize(window.innerWidth-a,window.innerHeight)}function b(a,b){return a.uuid||(a.uuid=hcs.uuid.uuid4()),a.lastModified||"hcsLocalStorage"==b?a.lastModified||(a.lastModified=0):a.lastModified=(new Date).getTime(),a}var c=null,d=640,e=480,f=260,g=260,h=1,i=null,j=null,k={},l=hcs.Constants.MODE_STANDALONE,m=null,n=null,o=null,p=null,q=!1,r=null,s=!1,t=null,u="2D",v=null,w=function(b,s,w){if(this.version=b,this.isFullyInitialized=!1,window.hcsdesign=this,this.ENGINE_2D=1,this.ENGINE_3D=2,this.MODE_EDITOR=1,this.MODE_VIEWER=2,this.LOCAL_STORAGE_STRUCTURE_KEY="wanadev.planner.structure",this.i18n=s,hcs.UI.LanguageSelector.setLocal(s.getLocale().split("_")[0]),i=document.getElementById("container2d"),j=document.getElementById("container3d"),h=this.ENGINE_2D,k={structure:[],limit:50,cursor:0,getLatest:function(){return this.structure[this.cursor]}},w.css&&HTMLHelper.addStylesheet(w.css),this.allow3D="undefined"!=typeof w.allow3D?w.allow3D:!0,this.api=w||{},n=this.api.saveUrl||null,o=this.api.newUrl||null,p=this.api.planUrl||null,r=this.api.screenshotUrl||null,q=this.api.publisher||!1,_origin=this.api.origin||!1,this.mode="true"===this.api.isViewer?this.MODE_VIEWER:this.MODE_EDITOR,this.api.params=this.api.params?JSON.parse(this.api.params):{},this.api.components&&(this.api.components=JSON.parse(this.api.components)),this.api.id>0){m=this.api.id,l=hcs.Constants.MODE_CUSTOMER,t=this.api.params,u=this.api.screenshotMode||"2D",v=this.api.title||null;var x=t.env||"";hcs.Constants.PRODUCTS_CATEGORY_FILE=[hcs.Constants.hcs_URL,"data/",m,"/categories"+x+".json"].join(""),hcs.Constants.TEXTURES_FILE=[hcs.Constants.hcs_URL,"data/",m,"/textures"+x+".json"].join(""),hcs.Constants.PRODUCTS_FILE=[hcs.Constants.hcs_URL,"data/",m,"/products"+x+".json"].join(""),hcs.Constants.PRODUCTS_PREVIEWS=[hcs.Constants.hcs_URL,"data/previews/"].join("")}d=window.innerWidth,e=window.innerHeight,this.needPageRefresh=!1,this.loopTimer=new hcs.LoopTimer,this.structure=new hcs.Structure(b),this.keyboardManager=new hcs.KeyboardManager,this.configuration=new hcs.Configuration,this.engine2D=new hcs.Engine2D(i,this),this.engine3D=null,this.engine3D=GlobalHelper.hasWebGL()?new hcs.Engine3D(j):new hcs.Dummy.Engine3D(j),this.aboutWindow=null;var y=this;c=this,window.addEventListener("resize",a,!1);var z=!1;if(document.addEventListener("keydown",function(a){y.getSelectedEngine()===y.ENGINE_2D&&((a.ctrlKey||z)&&90==a.keyCode?c.backFromHistory():(a.ctrlKey||c.pomme)&&89==a.keyCode&&c.nextFromHistory(),z=91==a.keyCode?!0:z)},!1),document.addEventListener("keyup",function(){z=!1},!1),document.addEventListener("contextmenu",function(a){a.preventDefault()},!1),window.addEventListener("message",function(a){var b=JSON.parse(a.data);switch(b.action){case"close-frame":hcs.UI.IFrame.close();break;case"resize-frame":hcs.UI.IFrame.resize(b.width,b.height);break;case"take-screenshot":this.takeScreenshot({})}}.bind(this)),GlobalHelper.isIE()<11){var A=document.getElementById("screenshot-flash");A&&(A.style.display="none")}this.setMenuWidth=function(a){f="number"==typeof a?a:g},this.getMenuWidth=function(){return f}};return w.prototype.initialize=function(a){this.mode==this.MODE_VIEWER?this.initializeViewer(a):this.initializeEditor(a),setTimeout(function(){this.engine2D.bestZoom()}.bind(this),50),this.engine2D.bestZoom(),window.setTimeout(function(){this.hideSplashScreen()}.bind(this),7e3),this.keyboardManager.startEventsListening(),GlobalHelper.hasWebGL()||HTMLHelper.hide3DMenus(),ujs.notify("hcs.core.initialized")},w.prototype.initializeViewer=function(a){var a=a||function(){},b=this,c=document.getElementById("toggleEngine");this.changeToggleEngineLabel=function(a){c.children[0].innerHTML=a},GlobalHelper.hasWebGL()?(c.setAttribute("title",_("Switch the view to 2D or 3D")),c.addEventListener("click",function(){b.switchEngine(),b.changeToggleEngineLabel("2D"==c.children[0].innerHTML?"3D":"2D")},!1)):c.style.display="none",this.changeToggleEngineLabel(+this.api.startOn2D?"3D":"2D"),this._createDefaultStructure(),this.menu={addMenuItem:function(){}},this.helpBubbleManager={alreadyDisplayed:function(){},display:function(){}},this.engine2D.isViewer=!0,this.engine3D.isViewer=!0,this.engine2D.initialize(),this.engine3D.initialize(),p?this._getStructureFromUrl(p,function(b){this._loadStructure(b),this.engine2D.bestZoom(),this.hideSplashScreen(),a.call(this),ujs.notify("hcs.structure.locale.loaded")}.bind(this)):this._localStructureExists()?this._loadStructure(this._getLocaleStorageStructure(),function(b){a(b),ujs.notify("hcs.structure.locale.loaded")}):a(this)},w.prototype.initializeEditor=function(){var a=this;this.helpBubbleManager=new hcs.UI.HelpBubbleManager(!GlobalHelper.isMobileDevice()),document.addEventListener("hcs.request.takeScreenshot",this.takeScreenshot,!1),document.addEventListener("hcs.request.saveStructrure",this.saveStructure.bind(this),!1),document.addEventListener("hcs.request.loadStructure",this.loadStructure.bind(this),!1),this.engine2D.getContainer().addEventListener("touchend",this.saveHistory.bind(this),!1),this.engine2D.getContainer().addEventListener("touchcancel",this.saveHistory.bind(this),!1),this.engine3D.getContainer().addEventListener("touchend",this.saveHistory.bind(this),!1),this.engine3D.getContainer().addEventListener("touchcancel",this.saveHistory.bind(this),!1);var b=window.PointerEvent?"pointerup":"mouseup";if(b=window.MSPointerEvent?"MSPointerUp":b,this.engine2D.getContainer().addEventListener(b,this.saveHistory.bind(this),!1),this.engine3D.getContainer().addEventListener(b,this.saveHistory.bind(this),!1),document.addEventListener("hcs.request.saveHistory",this.saveHistory.bind(this),!1),document.addEventListener("hcs.request.switchEngine",this.switchEngine.bind(this),!1),document.addEventListener("hcs.request.changeEngine",function(b){ujs.notify("hcs.request.closePopup"),"undefined"!=typeof b.engine&&setTimeout(function(){a.setSelectedEngine(b.engine)},10)},!1),document.addEventListener("hcs.request.changeLang",function(){ujs.notify("hcs.menu.top.deselect"),hcs.UI.LanguageSelector.show()},!1),this._createDefaultStructure(),this.engine2D.initialize(),this.engine3D.initialize(),s=!0,":new"==p){var c=!1;if(this._localStructureExists()){var d=this._getLocaleStorageStructure(),e=hcsLocalStorage.getItem("wanadev.planner.stack");e!=d.uuid&&confirm(_("An unsaved plan exists, would you like to load it ?"))&&(this._loadStructure(d),c=!0)}c===!1&&(this._clearLocaleStructure(),this._createDefaultStructure(),ujs.notify("hcs.core.structure.loaded")),this.engine2D.bestZoom(),this.hideSplashScreen()}else p?this._getStructureFromUrl(p,function(a){if(!a)return this._localStructureExists()&&this._loadStructure(this._getLocaleStorageStructure()),this.engine2D.bestZoom(),void this.hideSplashScreen();var b=this._getLocaleStorageStructure();this._loadStructure(b&&b.uuid==a.uuid&&b.lastModified>=a.lastModified?b:a),this.structure.setCurrentStructureIndex(0),this.engine2D.bestZoom(),this.hideSplashScreen()}.bind(this)):(this._localStructureExists()&&this._loadStructure(this._getLocaleStorageStructure()),this.structure.setCurrentStructureIndex(0),this.engine2D.bestZoom(),this.hideSplashScreen());window.addEventListener("focus",function(){this.saveLocalStructure(!1,!0)}.bind(this),!1),this.aboutWindow=new hcs.UI.AboutWindow,this.setSize(window.innerWidth-260,window.innerHeight)},w.prototype.update=function(){this.loopTimer.update(),this.keyboardManager.isPressed(82)&&(this.keyboardManager.isPressed(17)||this.keyboardManager.isPressed(91)||this.keyboardManager.isPressed(224))&&(this.needPageRefresh||(this.needPageRefresh=!0,location.href=location.href,this.needPageRefresh=!1)),this.engine2D.isEnabled()&&this.keyboardManager.isPressed(Keys.escape)&&(this.engine2D.setMode(this.engine2D.MODE_NORMAL),ujs.notify("hcs.menu.main.deselect"),this.engine2D.requestStaticDraw(),this.keyboardManager.keys[Keys.escape]=!1),this.engine2D.isEnabled()?this.engine2D.update(this.loopTimer.getDeltaTime()):this.engine3D.update(this.loopTimer.getDeltaTime())
},w.prototype.draw=function(){this.engine2D.isEnabled()?this.engine2D.draw(this.loopTimer.getDeltaTime()):this.engine3D.draw(this.loopTimer.getDeltaTime())},w.prototype.compareVersion=function(a,b){for(var c=a.split("."),d=b.split("."),e=0,f=c.length,g=null;null===g&&f>e;)void 0!==c[e]&&void 0!==d[e]&&(+c[e]<+d[e]?g=-1:+c[e]>+d[e]&&(g=1)),e++;return null!==g?g:0},w.prototype.setSize=function(a,b){d=a,e=b||a,c.engine2D.resize(),c.engine3D.resize()},w.prototype.getWidth=function(){return d},w.prototype.getHeight=function(){return e},w.prototype.getContainer2D=function(){return i},w.prototype.getContainer3D=function(){return j},w.prototype.getSelectedEngine=function(){return h},w.prototype.getPlanName=function(){return this.structure.uuid},w.prototype.getPlanURL=function(){return p},w.prototype.setSelectedEngine=function(a){if(!this.allow3D&&"2D"!==a&&a!==this.ENGINE_2D){var b=document.getElementById("toggleEngine");return void(b&&b.parentNode.removeChild(b))}var c=a==this.ENGINE_3D||"3D"==a,d=this.engine2D.isEnabled()?"2D":"3D",e=c?"3D":"2D";this.engine2D.setEnabled(!c),this.engine3D.setEnabled(c),h="3D"==a||a==this.ENGINE_3D?this.ENGINE_3D:this.ENGINE_2D,ujs.notify("hcs.contextChanged",{context:e,previousContext:d}),this.helpBubbleManager&&this.helpBubbleManager.helpBubble&&this.helpBubbleManager.helpBubble.hide()},w.prototype.getSelectedStructure=function(){return this.structure.getCurrentStructure()},w.prototype.getHistory=function(){return k},w.prototype.takeScreenshot=function(a,b,d){var e,f="undefined"!=typeof a.selectedEngine?a.selectedEngine:h,g="undefined"!=typeof a.sendBlob?a.sendBlob:!1,b=b||function(){},d=d||function(){};if(e=f==c.ENGINE_2D?i.children[0]:j.children[0],l==hcs.Constants.MODE_STANDALONE||null===r){if(b(),g)return e.toDataURL("image/png");f===c.ENGINE_2D?e.toBlob(function(a){saveAs(a,"plan.png")}):GlobalHelper.createScreenshot3D(c.engine3D.engine,void 0,function(a){a.toBlob(function(a){saveAs(a,"plan.png")})})}else{var k=[];if(t){var m=t;"object"==typeof m&&(m=JSON.stringify(m)),k.push("params="+m+"&")}var n=function(a){ujs.ajax({method:"POST",withCredentials:!0,url:r,params:a.join(""),error:d,success:function(a){var e=JSON.parse(a),f=_("An error occured. Please try later.");if("ok"===e.status)f=_("Your screenshot has been saved."),c.structure.planId=!0,hcs.UI.MessageBox.show({title:_("Screenshot"),message:f,buttonAText:_("Close"),buttonA:!0,autoHide:!0,force:!0}),e.params&&(t=e.params),hcs.UI.MessageBox.show(g),b();else{if(e.connectionUrl)c._loginIframe(e.connectionUrl,e.frameWidth||Math.round(window.innerWidth/2),e.frameHeight||Math.round(window.innerHeight/2));else{var g={title:_("Screenshot"),message:e.message||_("Error occured during save."),buttonA:!0,buttonAText:_("Ok"),onClickA:function(){hcs.UI.MessageBox.close()}};hcs.UI.MessageBox.show(g)}d()}}})};f===c.ENGINE_2D?(k.push("screenshot="+e.toDataURL("image/png")),n(k)):GlobalHelper.createScreenshot3D(c.engine3D.engine,void 0,function(a){k.push("screenshot="+a.toDataURL("image/png")),n(k)})}if(!GlobalHelper.isIE10()){var o=document.getElementById("screenshot-flash");o.style.opacity=1;var p=setTimeout(function(){clearTimeout(p),o.style.opacity=0},200)}},w.prototype.switchEngine=function(){this.setSelectedEngine(h==this.ENGINE_2D?this.ENGINE_3D:this.ENGINE_2D)},w.prototype.getComponentByName=function(a,b){var b=void 0!=typeof b?b:3;if(b==this.ENGINE_2D)return this.engine2D.searchComponent(a);if(b==this.ENGINE_3D)return this.engine3D.searchComponent(a);var c=this.engine2D.searchComponent(a);return c||(c=this.engine3D.searchComponent(a)),c},w.prototype.addStrutureElement=function(a){this.structure.addElement(a)},w.prototype.updateDeserialisation=function(a){this.engine2D.requestStaticDraw(),this.unlock(a),this.getComponentByName("RoomComponent2D",this.ENGINE_2D).needsUpdate=!0,this.engine2D.requestStaticDraw(),this.engine2D.requestCompute(),this.engine2D.update(),this.engine2D.draw()},w.prototype.checkLocalPlan=function(){var a=hcsLocalStorage.getItem(this.LOCAL_STORAGE_STRUCTURE_KEY);null!=a&&this.loadLocalStructure(!1)},w.prototype.saveLocalStructure=function(a,b){if(this.mode==this.MODE_VIEWER)return null;var a="undefined"!=typeof a?a:!1,d=c.structure.serialize(),e=hcsLocalStorage.getItem(c.LOCAL_STORAGE_STRUCTURE_KEY);return e!==d||b?(c.removeLocalStructure(!1),hcsLocalStorage.setItem(c.LOCAL_STORAGE_STRUCTURE_KEY,d),a&&hcs.UI.MessageBox.show({title:_("��������"),message:_("���������Ѿ������ɹ�."),buttonAText:_("�ر�"),button:!0}),d):null},w.prototype.loadLocalStructure=function(a){var a="undefined"!=typeof a?a:!1,b=hcsLocalStorage.getItem(this.LOCAL_STORAGE_STRUCTURE_KEY),c=this;if(null!=b){var d=c.lock();return c.structure.deserialize(b)?(c.structure.setCurrentStructureIndex(0),c.updateDeserialisation(d)):(this.removeLocalStructure(!1),a&&hcs.UI.MessageBox.show({title:_("Load a Plan"),message:_("Unable to load your plan: its version is too old."),buttonAText:_("Close"),buttonA:!0})),a&&hcs.UI.MessageBox.show({title:_("Load a Plan"),message:_("Your plan has been loaded."),buttonAText:_("Close"),buttonA:!0}),ujs.notify("hcs.structure.locale.loaded"),!0}return a&&hcs.UI.MessageBox.show({title:_("Load a Plan"),message:_("You have no saved plan."),buttonAText:_("Close"),buttonA:!0}),!1},w.prototype.removeLocalStructure=function(a){var a="undefined"!=typeof a?a:!1,b=hcsLocalStorage.getItem(this.LOCAL_STORAGE_STRUCTURE_KEY);return null!=b?(hcsLocalStorage.removeItem(this.LOCAL_STORAGE_STRUCTURE_KEY),a&&hcs.UI.MessageBox.show({title:_("Remove a Plan"),message:_("Your plan has been removed."),buttonAText:_("Close"),button:!0}),!0):!1},w.prototype.getPreviewImage=function(a,b){var d=null,e=null,f=c.engine2D.getZoom(),g=c.engine2D.getTranslation();c.setSize(a,b),this.getSelectedEngine()==this.ENGINE_2D?(c.engine2D.bestZoom(),c.engine2D.draw(),e=c.engine2D.canvas):(e=c.getContainer3D().getElementsByTagName("canvas")[0],c.engine3D.draw()),d=e.toDataURL("image/png");var h=c.mode==c.MODE_EDITOR?260:0;return c.setSize(window.innerWidth-h,window.innerHeight),this.getSelectedEngine()==this.ENGINE_2D&&(c.engine2D.setZoom(f),c.engine2D.setTranslation(g)),d},w.prototype.saveStackToLocal=function(){hcsLocalStorage.setItem("wanadev.planner.stack",c.structure.uuid)},w.prototype.saveStructure=function(){},w.prototype.loadStructure=function(a,b){var b=b||function(){},d=function(a){c.removeLocalStructure();var d=c.lock();c.structure.deserialize(a)&&c.updateDeserialisation(d),c.saveLocalStructure(!1),b(1)},e=function(a){ujs.ajax({url:hcs.Constants.BACK_URL+hcs.Constants.MIGRATION_PATH+a,withCredentials:!0,success:function(a){a?d(a):b(-1)}})};p?(ujs.ajax({url:p,withCredentials:!0,success:function(a){if(a){var c=JSON.parse(a);1==hcsdesign.compareVersion(hcs.Constants.VERSION,c.version)?d(a):(console.log("migration"),e(p))}else b(-1)}}),p=null):b(-2)},w.prototype.saveHistory=function(){var a=this.saveLocalStructure(!1),b=this.getHistory().structure.length;this.getHistory().getLatest(),null!=a&&(this.getHistory().cursor<b-1&&this.getHistory().structure.splice(this.getHistory().cursor+1,b-this.getHistory().cursor),b>this.getHistory().maxSize&&this.getHistory().structure.splice(0,1),this.getHistory().cursor=this.getHistory().structure.push(a)-1)},w.prototype.backFromHistory=function(){this.getHistory().cursor<=0?this.getHistory().cursor=0:this.getHistory().cursor--;var a=this.getHistory().structure[this.getHistory().cursor];if(null!=a){var b=this.lock();this.structure.deserialize(a)&&this.updateDeserialisation(b)}this.engine2D.requestCompute(),this.engine2D.requestStaticDraw(),this.engine2D.update()},w.prototype.lock=function(){var a={engine2D:c.engine2D.isEnabled(),engine3D:c.engine3D.enabled};return this.engine2D._enabled=!1,this.engine3D.enabled=!1,a},w.prototype.unlock=function(a){this.engine2D._enabled=a.engine2D,this.engine3D.enabled=a.engine3D},w.prototype.nextFromHistory=function(){this.getHistory().cursor<this.getHistory().structure.length&&this.getHistory().cursor++;var a=this.getHistory().structure[this.getHistory().cursor];null!=a&&this.structure.deserialize(a),this.engine2D.requestCompute()},w.prototype.hideSplashScreen=function(a){var a=a||800;document.getElementById("splash-bar-inner").style.webkitAnimationDuration="1s",document.getElementById("splash-bar-inner").style.animationDuration="1s",window.setTimeout(function(){document.getElementById("splashscreen").style.display="none",c.isFullyInitialized=!0},a)},w.prototype._localStructureExists=function(){return void 0!=hcsLocalStorage.getItem(this.LOCAL_STORAGE_STRUCTURE_KEY)?!0:!1},w.prototype._getLocaleStorageStructure=function(){return this._localStructureExists()?b(JSON.parse(hcsLocalStorage.getItem(this.LOCAL_STORAGE_STRUCTURE_KEY)),"hcsLocalStorage"):null},w.prototype.isPublisher=function(){return q},w.prototype.getOrigin=function(){return _origin},w.prototype._getStructureFromUrl=function(a,c){var d=function(d){if(d){var f=JSON.parse(d);1==hcsdesign.compareVersion(hcs.Constants.VERSION,f.version)?e(a,c):c(b(f))}else c(null)},e=function(a,b){var c=hcs.Constants.BACK_URL+hcs.Constants.MIGRATION_PATH+a;ujs.ajax({url:c,success:d,onerror:function(){f(c,b)}})},f=function(a){var b="/php/retrieveJson.php?json="+a;ujs.ajax({url:b,withCredentials:!0,success:d})};ujs.ajax({url:a,withCredentials:!0,success:d,onerror:function(){f(a,c)}})},w.prototype.coherenceControl=function(a){for(var b in a.members)this.engine2D.coherenceControl(a.members[b])},w.prototype._loadStructure=function(a,b){this.structure.deserialize("string"==typeof a?a:JSON.stringify(a)),ujs.notify("hcs.core.structure.loaded");var b=b||function(){};b.call(this),this.engine2D.requestCompute()},w.prototype._clearLocaleStructure=function(){var a=hcsLocalStorage.getItem(this.LOCAL_STORAGE_STRUCTURE_KEY);null!=a&&hcsLocalStorage.removeItem(this.LOCAL_STORAGE_STRUCTURE_KEY),this.structure.clear()},w.prototype._createDefaultStructure=function(){this.addStrutureElement(new FloorStructure);for(var a=this.structure.getCurrentStructure(),b=[new PolygonWall,new PolygonWall,new PolygonWall,new PolygonWall],c=[new BABYLON.Vector2(-515,0),new BABYLON.Vector2(0,415),new BABYLON.Vector2(515,0),new BABYLON.Vector2(0,-415)],d=0;d<b.length;d++){var e=(d+1)%b.length;b[d].setPoints(b[e].getPoints(0),1)}for(var d=0;d<b.length;d++)b[d].translate(c[d]),a.insertElement("walls",b[d]),a.insertElement("points",b[d].getPoints(1))},w.prototype._loginIframe=function(a,b,c){var b=b||window.innerWidth/2,c=c||window.innerHeight/2;hcs.UI.IFrame.show(document.body,{width:b,height:c,src:a},{showClose:!0})},w}();var hcs=window.hcs||{};hcs.Engine2D=function(){var a=function(a,b,c){this.MODE_NORMAL=1,this.MODE_DRAG=2,this.MODE_DRAW=4,this.MODE_CONTEXTMENU=8,this.MODE_SUBSLOPE=16,this._container=a,this.isViewer="undefined"!=typeof c?c:!1,this.getContainer=function(){return this._container},this.canvas=document.createElement("canvas"),this.canvas.id="canvas2d",this._container.appendChild(this.canvas),this.dynamicCanvas=document.createElement("canvas"),this.dynamicCanvas.id="dynamiccanvas2d",this._container.appendChild(this.dynamicCanvas),this.symbols2D=new hcs.Symbols2D,this._core=b,this._components=new hcs.ComponentCollection(hcsdesign),this._initialized=!1,this._enabled=!1,this._zoom=1,this._translation=new BABYLON.Vector2,this._cursorIconCb=null,this._pointerManager=null,this._mode=this.MODE_NORMAL,this._lastMode=this.MODE_NORMAL,this._enableAutoScroll=!1,this._eventsCb={click:[],"double-click":[],hover:[],leave:[],"mouse-move":[],"drag-start":[],dragging:[],"drag-end":[],"zoom-in":[],"zoom-out":[],"key-pressed":[],"key-released":[],"static-draw":[],"dynamic-draw":[],"draw-end":[],"subslope-end":[],"enter-draw-zone":[],"leave-draw-zone":[]},this._lastTargeted=null,this._isHover=!1,this._needStaticDraw=!0,this._needDynamicDraw=!0,this._menuIsVisible=!0,this._contextMenuCallback=null,this._contextMenuRmCallback=null,this._contextMenuTarget=null,document.addEventListener("hcs.engine2D.contextMenu.propertyChanged",this.onContextMenuPropertyChanged.bind(this),!1),document.addEventListener("hcs.engine2D.contextMenu.close",this.onContextMenuClose.bind(this),!1),document.addEventListener("hcs.ui.frame.close",this.onContextMenuClose.bind(this),!1),document.addEventListener("hcs.engine2D.contextMenu.remove",this.onContextMenuRemove.bind(this),!1),document.addEventListener("hcs.engine2D.contextMenu.debug",this.onContextMenuDebug.bind(this),!1)};return a.prototype.isEnabled=function(){return this._enabled},a.prototype.setEnabled=function(a){this._enabled=a;var b="none";a&&(b="block"),this.setMode(this.MODE_NORMAL),this._container.setAttribute("style","display:"+b),this.requestStaticDraw(),ujs.notify("hcs.core.hideLoader")},a.prototype.getZoom=function(){return this._zoom},a.prototype.setZoom=function(a){this._zoom=a,this._zoom=this._zoom<.1?.1:this._zoom,this._zoom=this._zoom>5?5:this._zoom,this.requestStaticDraw(),ujs.notify("hcs.request.zoomUpdated")},a.prototype.getTranslation=function(){return this._translation.clone()},a.prototype.setTranslation=function(a){if(a instanceof BABYLON.Vector2){var b=this._core.configuration.boundingSize,c=100,d=this._core.getWidth()/2+(this.getZoom()*Math.abs(b.min.x)-this._core.getWidth()/2)+c,e=this._core.getHeight()/2+(this.getZoom()*Math.abs(b.min.y)-this._core.getHeight()/2)+c,f=this._core.getWidth()/2-(this.getZoom()*Math.abs(b.max.x)-this._core.getWidth()/2)-c,g=this._core.getHeight()/2-(this.getZoom()*Math.abs(b.max.y)-this._core.getHeight()/2)-c;a.x>=d&&a.x<=f?a.x=(d+f)/2:a.x>d?a.x=d:a.x<f&&(a.x=f),a.y>=e&&a.y<=g?a.y=(e+g)/2:a.y>e?a.y=e:a.y<g&&(a.y=g),this._translation.copyFrom(a),this._translation.x=Math.round(this._translation.x),this._translation.y=Math.round(this._translation.y),this.requestStaticDraw()}},a.prototype.toRealCoord=function(a,b,c){var d=a.scale(c||this.getZoom());return d.addInPlace(b||this.getTranslation()),d},a.prototype.getMode=function(){return this._mode==this.MODE_DRAG||this._mode==this.MODE_CONTEXTMENU?this._mode|this._lastMode:this._mode},a.prototype.setMode=function(a){if(a!=this._mode){var b={mode:this._mode,lastMode:this._lastMode,newMode:a};this._lastMode=this._mode,this._mode=a,this._stateMachine(b)}},a.prototype.setEnableAutoScroll=function(a){this._enableAutoScroll=a},a.prototype.getTarget=function(a){if(!this.isViewer){for(var a=a||this._pointerManager.getStatus(),b=0;b<this._components.size();b++){var c=this._components[b].getTargeted(a.planPos);if(null!=c)return c}return null}},a.prototype.getMouseState=function(){return this._pointerManager.getStatus()},a.prototype.setCursorIcon=function(a){this._cursorIconCb=a,this.requestDynamicDraw()},a.prototype.initialize=function(){this._pointerManager=new hcs.PointerManager(this._core,this.onMouseEvent.bind(this),this.dynamicCanvas),this.dynamicCanvas.addEventListener("mouseout",function(a){this._callInOutDrawZoneCb("leave-draw-zone",a)}.bind(this),!1),this.dynamicCanvas.addEventListener("mousein",function(a){this._callInOutDrawZoneCb("enter-draw-zone",a)}.bind(this),!1),this.setTranslation(new BABYLON.Vector2((this._core.getWidth()-260)/2,this._core.getHeight()/2)),this.resize(),this.initializeComponents(),this._initialized=!0,document.addEventListener("hcs.engine2D.requestCompute",function(){this.requestCompute()}.bind(this),!1),window.setTimeout(function(){}.bind(this),2e3)},a.prototype.bestZoom=function(a,b){var c=this.getBestZoomAttributes(a,b);this.setZoom(c.zoom),this.setTranslation(c.translation),this.requestCompute()},a.prototype.getBestZoomAttributes=function(a,b){var c=a||this._core.getWidth(),d=b||this._core.getHeight(),e=this._core.getSelectedStructure().walls,f={min:{x:1/0,y:1/0},max:{x:-1/0,y:-1/0}};for(var g in e){var h=e[g].getBoundingBox();h.min.x<f.min.x&&(f.min.x=h.min.x),h.min.y<f.min.y&&(f.min.y=h.min.y),h.max.x>f.max.x&&(f.max.x=h.max.x),h.max.y>f.max.y&&(f.max.y=h.max.y)}var i=f.max.x-f.min.x+100,j=f.max.y-f.min.y+100,k=1;(i>c||j>d)&&(k=Math.min(d/j,c/i));var l=new BABYLON.Vector2(c/2,d/2);return l.x-=(f.max.x+f.min.x)/2*k,l.y-=(f.max.y+f.min.y)/2*k,{zoom:k,translation:l}},a.prototype.reinitialize=function(){this.setMode(this.MODE_NORMAL),this.setTranslation(new BABYLON.Vector2((this._core.getWidth()-this._core.getMenuWidth())/2,this._core.getHeight()/2)),this.resize(),this.requestCompute(),this.bestZoom()},a.prototype.initializeComponents=function(){this._components.initialize()},a.prototype.resize=function(a,b){this.canvas.width=a||this._core.getWidth(),this.canvas.height=b||this._core.getHeight(),this.dynamicCanvas.width=a||this._core.getWidth(),this.dynamicCanvas.height=b||this._core.getHeight(),this._pointerManager&&this._pointerManager.resize(),this.requestStaticDraw()},a.prototype.update=function(a){this._components.checkDirtyComponents();var a=a===!0?!0:!1;if(a)for(var b=0;b<this._components.size();b++)for(var c=0;c<hcsdesign.structure.members.length;c++){var d=hcsdesign.structure.members[c];this._components[b].update(d),d.tidy()}else this._components.update(),hcsdesign.getSelectedStructure().tidy();this._autoScroll()},a.prototype.draw=function(){this.update(),hcs.AnimationHandler.Process(),this._needStaticDraw&&(this._needStaticDraw=!1,this._callStaticDrawCb()),this._needDynamicDraw&&(this._needDynamicDraw=!1,this._callDynamicDrawCb())},a.prototype.registerEventCb=function(a,b,c,d,e,f,g){var g=g||null;this.unregisterEventCb(a),this._eventsCb[c].push({id:a,priority:b,mode:d,objType:e,callback:f,data:g}),this._eventsCb[c].sort("static-draw"!=c&&"dynamic-draw"!=c?function(a,b){return b.priority-a.priority}:function(a,b){return a.priority-b.priority})},a.prototype.unregisterEventCb=function(a){for(var b in this._eventsCb)if(this._eventsCb.hasOwnProperty(b))for(var c in this._eventsCb[b])this._eventsCb[b][c].id==a&&delete this._eventsCb[b][c]},a.prototype.addComponent=function(a){return this._components.addComponent(a)},a.prototype.addInstancedComponent=function(a){return this._components.addInstancedComponent(a)},a.prototype.getComponent=function(){return this._components.getComponent(name)},a.prototype.searchComponent=function(a){return this._components.getComponent(a)},a.prototype.removeComponent=function(a,b){return this._components.removeComponent(a,b)},a.prototype.removeComponentByName=function(a){return this._components.removeComponent(a)},a.prototype.clearComponents=function(){this._components.clear()},a.prototype.requestStaticDraw=function(){this._needStaticDraw=!0,this.requestDynamicDraw()},a.prototype.requestDynamicDraw=function(){this._needDynamicDraw=!0},a.prototype.requestCompute=function(){for(var a=0;a<this._components.size();a++)this._components[a].compute();this.requestStaticDraw()},a.prototype.setCursor=function(a){var a=a||"default";this.dynamicCanvas.style.cursor=a},a.prototype.displayContextMenu=function(a,b,c,d){var e=this._pointerManager.getStatus(),f=[];this._contextMenuCallback=c,this._contextMenuRmCallback=d,this._contextMenuTarget=b;for(var g in a){var h=a[g];h.eventParams={cast:h.cast||h.type,property:h.name,eventName:"hcs.engine2D.contextMenu.propertyChanged"},f.push(h)}var i=[{title:"Tab 1",content:f}],j=[];window.WNP_DEBUG&&j.push({label:"Debug",action:"hcs.engine2D.contextMenu.debug"}),null!=d&&j.push({label:_("删除"),action:"hcs.engine2D.contextMenu.remove","class":"remove"}),j.push({label:_("确定"),action:"hcs.engine2D.contextMenu.close"}),this._callMouseEventCb("leave",b,{},e),this.requestStaticDraw(),this.setMode(this.MODE_CONTEXTMENU);var k=(e.prevButtons&e.BUTTON_LEFT)>0?200:0,l=this._enabled?e.pos.x+2:this._core.getWidth()/2,m=this._enabled?e.pos.y+2:100;hcs.UI.ContextMenu.show({title:_("设置"),x:l,y:m},i,j,k)},a.prototype._stateMachine=function(a){var b=this._mode,c=this._lastMode,d=this._mode,e=null,f=null,g={},h=this._lastTargeted,i=this._lastTargeted;void 0!==a.mode&&(b=a.mode),void 0!==a.lastMode&&(c=a.lastMode),void 0!==a.newMode&&(d=a.newMode),e=void 0!==a.mstate?a.mstate:this._pointerManager.getStatus(),void 0!==a.evName&&(f=a.evName),void 0!==a.ev&&(g=a.ev),void 0!==a.target&&(h=a.target),void 0!==a.lastTarget&&(i=a.lastTarget);var j=!1;b!=d&&(j=!0);var k=!1;if(null!=f&&(k=!0),j)if((b&this.MODE_DRAW)>0&&0==(d&this.MODE_DRAG)?this._callDrawEndCb():(c&this.MODE_DRAW)>0&&(b&this.MODE_DRAG)>0&&0==(d&(this.MODE_DRAW|this.MODE_DRAG))&&this._callDrawEndCb(),(b&this.MODE_SUBSLOPE)>0&&0==(d&this.MODE_DRAG)?this._callSubslopeEndCb():(c&this.MODE_SUBSLOPE)>0&&(b&this.MODE_DRAG)>0&&0==(d&(this.MODE_SUBSLOPE|this.MODE_DRAG|this.MODE_CONTEXTMENU))&&this._callSubslopeEndCb(),(b&this.MODE_CONTEXTMENU)>0&&0==(d&this.MODE_CONTEXTMENU)?(hcs.UI.ContextMenu.close(),this.requestCompute(),this._core.keyboardManager.preventDefault=!0):(d&this.MODE_CONTEXTMENU)>0&&(this._core.keyboardManager.preventDefault=!1),(b&this.MODE_DRAG)>0&&0==(d&this.MODE_DRAG))(e.actions&e.ACTION_DRAGGING)>0&&(this._pointerManager.reset(),this._callMouseEventCb("drag-end",h,g,e,this.MODE_DRAG)),this._eventsCb.dragging.length=0,this._eventsCb["drag-end"].length=0;else if((b&this.MODE_DRAW)>0&&0==(d&(this.MODE_DRAG|this.MODE_DRAW)))for(var l in this._eventsCb)if(this._eventsCb.hasOwnProperty(l))for(var m in this._eventsCb[l])this._eventsCb[l][m].mode==this.MODE_DRAW&&delete this._eventsCb[l][m];if(j)switch(d){case this.MODE_DRAG:this.setCursor(b==this.MODE_DRAW?"crosshair":"move");break;case this.MODE_DRAW:this.setCursor("crosshair");break;default:this.setCursor("default")}if(k&&0==(b&this.MODE_CONTEXTMENU))switch(f){case"drag-start":this._callMouseEventCb("drag-start",h,g,e,b),d=this.MODE_DRAG,this.setMode(d);break;case"drag-end":this._callMouseEventCb("drag-end",h,g,e,b),this._mode==this.MODE_DRAG?(d=c,this.setMode(d)):d=this._mode,i=h,h=this.getTarget(e);break;case"double-click":this._callMouseEventCb("double-click",h,g,e,b),i=h,h=this.getTarget(e);break;case"mouse-move":(this.getMode()&this.MODE_DRAG)>0&&(a.evName="drag-end",this._stateMachine(a)),this._callMouseEventCb("mouse-move",h,g,e,b);break;default:this._callMouseEventCb(f,h,g,e,b)}(b&(this.MODE_NORMAL|this.MODE_CONTEXTMENU))>0&&this.setEnableAutoScroll(!1),k&&(b&this.MODE_CONTEXTMENU)>0&&("click"==f||"double-click"==f?(d=c,this.setMode(d)):"drag-start"==f&&(d=c,this.setMode(d),a.evName="drag-start",a.target=this.getTarget(e),this._stateMachine(a))),h!=i&&0==(b&this.MODE_CONTEXTMENU)?(null!=i&&this._callMouseEventCb("leave",i,g,e,b),null!=h&&this._callMouseEventCb("hover",h,g,e,d)):b!=d&&0==(b&this.MODE_CONTEXTMENU)?null!=h&&(this._callMouseEventCb("leave",h,g,e,b),this._callMouseEventCb("hover",h,g,e,d)):b!=d&&0==(d&this.MODE_CONTEXTMENU)&&null!=h&&(this._callMouseEventCb("leave",h,g,e,b),this._callMouseEventCb("hover",h,g,e,d)),b!=d&&0==(b&(this.MODE_DRAG|this.MODE_CONTEXTMENU))&&(d&this.MODE_SUBSLOPE)>1&&b!=d&&0==(b&(this.MODE_DRAG|this.MODE_CONTEXTMENU))&&(d&this.MODE_DRAW)>1||b!=d&&0==(b&(this.MODE_DRAG|this.MODE_CONTEXTMENU))&&0==(d&(this.MODE_DRAG|this.MODE_CONTEXTMENU))},a.prototype._callMouseEventCb=function(a,b,c,d,e){if(void 0!=a){var b=b;void 0==b&&(b=null);var c=c;void 0==c&&(c={});var d=d;void 0==d&&(d=this._pointerManager.getStatus());var e=e;void 0==e&&(e=this.getMode());for(var f in this._eventsCb[a])if((null==this._eventsCb[a][f].mode||(e&this._eventsCb[a][f].mode)>0)&&(null==this._eventsCb[a][f].objType||b instanceof this._eventsCb[a][f].objType)){var g=this._eventsCb[a][f].callback(c,b,d,this._eventsCb[a][f].data);if(g===!1)break}}},a.prototype._callStaticDrawCb=function(){var a=this.canvas.getContext("2d");a.clearRect(0,0,this._core.getWidth(),this._core.getHeight());for(var b in this._eventsCb["static-draw"])this._eventsCb["static-draw"][b]&&(null==this._eventsCb["static-draw"][b].mode||(this._eventsCb["static-draw"][b].mode&this.getMode())>0)&&(a.save(),this._eventsCb["static-draw"][b].callback(a,this.getTranslation(),this.getZoom(),this._eventsCb["static-draw"][b].data),a.restore())},a.prototype._callInOutDrawZoneCb=function(a,b){for(var c in this._eventsCb[a])this._eventsCb[a][c]&&(null==this._eventsCb[a][c].mode||(this._eventsCb[a][c].mode&this.getMode())>0)&&this._eventsCb[a][c].callback(b,this._eventsCb[a][c].data)},a.prototype._callDynamicDrawCb=function(){var a=this.dynamicCanvas.getContext("2d");a.clearRect(0,0,this._core.getWidth(),this._core.getHeight());for(var b in this._eventsCb["dynamic-draw"])this._eventsCb["dynamic-draw"][b]&&(null==this._eventsCb["dynamic-draw"][b].mode||(this._eventsCb["dynamic-draw"][b].mode&this.getMode())>0)&&(a.save(),this._eventsCb["dynamic-draw"][b].callback(a,this.getTranslation(),this.getZoom(),this._eventsCb["dynamic-draw"][b].data),a.restore());this._cursorIconCb&&(this._cursorIconCb(a,this.getMouseState().pos),this._cursorIconCb=null)},a.prototype._callDrawEndCb=function(){for(var a in this._eventsCb["draw-end"])this._eventsCb["draw-end"][a]&&this._eventsCb["draw-end"][a].callback(this._eventsCb["draw-end"][a].data)},a.prototype._callSubslopeEndCb=function(){for(var a in this._eventsCb["subslope-end"])this._eventsCb["subslope-end"][a]&&this._eventsCb["subslope-end"][a].callback(this._eventsCb["subslope-end"][a].data)},a.prototype._autoScroll=function(){if(this._enableAutoScroll||(this.getMode()&this.MODE_DRAG)>1&&this.getTarget()){var a=3,b=35,c=!1,d=this.getMouseState(),e=this.getTranslation();if(Math.abs(d.planPos.x)>=this._core.configuration.boundingSize.max.x||Math.abs(d.planPos.y)>=this._core.configuration.boundingSize.max.y)return;if(d.pos.y<b?(e.y+=a,d.posDelta.y=-a,c=!0):d.pos.y>this._core.getHeight()-b&&(e.y-=a,d.posDelta.y=a,c=!0),d.pos.x<b?(e.x+=a,d.posDelta.x=-a,c=!0):d.pos.x>this._core.getWidth()-b&&(e.x-=a,d.posDelta.x=a,c=!0),c){this.setTranslation(e);var f="mouse-move";(this.getMode()&this.MODE_DRAG)>0&&(f="dragging"),this._stateMachine({evName:f,ev:{},mstate:d})}}},a.prototype.onMouseEvent=function(a,b){if(this._enabled){var c=this.getTarget(b),d=null;b.actions>0?(b.actions&b.ACTION_CLICK)>0?d="click":(b.actions&b.ACTION_DBLCLICK)>0?d="double-click":(b.actions&b.ACTION_DRAGSTART)>0&&this._mode!=this.MODE_DRAG?d="drag-start":(b.actions&b.ACTION_DRAGGING)>0?d="dragging":(b.actions&b.ACTION_DRAGEND)>0?d="drag-end":(b.actions&b.ACTION_SCROLLUP)>0?d="zoom-in":(b.actions&b.ACTION_SCROLLDOWN)>0&&(d="zoom-out"):(0!=b.posDelta.x||0!=b.posDelta.y)&&(d="mouse-move"),null!=d&&(Math.abs(b.planPos.x)>this._core.configuration.boundingSize.max.x||Math.abs(b.planPos.y)>this._core.configuration.boundingSize.max.y||(this._stateMachine({mstate:b,evName:d,ev:a,target:c}),this._lastTargeted=c))}},a.prototype.onContextMenuPropertyChanged=function(a){this._contextMenuCallback(this._contextMenuTarget,a.property,a.value)},a.prototype.onContextMenuClose=function(){this._callMouseEventCb("leave",this._contextMenuTarget),(this.getMode()&this.MODE_CONTEXTMENU)>0&&this.setMode(this._lastMode)},a.prototype.onContextMenuRemove=function(){this._contextMenuRmCallback(this._contextMenuTarget),this.setMode(this._lastMode)},a.prototype.onContextMenuDebug=function(){console.debug(this._contextMenuTarget)},a}();var hcs=window.hcs||{};hcs.Engine3D=function(){var a,b=function(b,c,d){this._initialized=!1,this._components=new hcs.ComponentCollection(hcsdesign),this.hardwareScaling=1,this.contextLostCount=0,this.MAX_CONTEXT_LOST=5,this.MODE_NORMAL=1,this.MODE_DRAG=2,this.MODE_PAINT=4,this.MODE_CONTEXTMENU=8,this.mode=this.MODE_NORMAL,this.container=b,this.canvas=document.createElement("canvas"),b.appendChild(this.canvas),this.canvas.width=hcsdesign.getWidth(),this.canvas.height=hcsdesign.getHeight();var e=hcsdesign.configuration&&hcsdesign.configuration.useAntialiasing===!1?!1:!0;this.engine=new BABYLON.Engine(this.canvas,e),this.scene=new BABYLON.Scene(this.engine),this.scene.ambientColor=new BABYLON.Color3(1,1,1),this.scene.clearColor.copyFromFloats(.96,.96,.96),this.shadowGenerator=null,this.worldPlane=new BABYLON.Plane(0,1,0,0),this.enabled=!1,this.viewInitialized=!1,this.isViewer="undefined"!=typeof d?d:!1,this.canvas.addEventListener("webglcontextlost",this.onContextLost.bind(this),!1),this.canvas.addEventListener("webglcontextrestored",this.onContextRestored.bind(this),!1),this.canDraw=!0,a=this,c||(this.structure=hcsdesign.structure,this.materialFactory=new hcs.MaterialFactory(hcsdesign.configuration),this.cameraFeatures=new hcs.CameraFeatures,this.pointerManager=new hcs.PointerManager(hcsdesign,this.onMouseEvent.bind(this),this.canvas),this.pointerManager.touchManager.setDeadZone(1),this.keyboardManager=hcsdesign.keyboardManager,this.stats=new Stats,this.stats.domElement.style.position="absolute",this.stats.domElement.style.bottom="28px",this.stats.domElement.style.left="0px",this.stats.domElement.style.zIndex="99999",this.stats.domElement.style.display="none",hcsdesign.configuration.useStats&&(this.stats.active=!0),document.body.appendChild(this.stats.domElement),document.addEventListener("hcs.engine3D.stats.activeChanged",function(b){a.stats.active=b.value,a.stats.domElement.style.display=b.value?"block":"none",hcsdesign.configuration.useStats=b.value?!0:!1,hcsdesign.configuration.saveConfiguration()},!1),document.addEventListener("hcs.engine3D.refreshGL",function(){var a=location.hash.replace("#",""),b=atob(a),c=btoa(b.replace("&planUrl=:new","&planUrl"));location.hash=c,window.location.reload(!0)},!1),document.addEventListener("hcs.engine3D.showProducts",function(a){var b=a.translations?_(a.categoryName,a.translations):_(a.categoryName);hcs.UI.ProductList.show(hcsdesign,hcsdesign.version,{id:a.categoryId,filter:a.categoryFilter,name:b})},!1),this.isViewer||(document.addEventListener("hcs.engine3D.click",a.onClick,!1),document.addEventListener("hcs.engine3D.double-click",a.onDoubleClick,!1),document.addEventListener("pointerdown",a.onMouseDown,!1)),document.addEventListener("hcs.engine3d.wallsReady",this.onWallsReady,!1)),this.getContainer=function(){return this.container}};return b.prototype.collideWithMeshes=function(b,c,d){var e=a.scene.createPickingRay(b,c),f=e.intersectMeshes(d,!0,!0);return f},b.prototype.castShadows=function(a){var b=this.shadowGenerator?this.shadowGenerator.getShadowMap():null;if(b){b.renderList.push(a);var c=a.onDispose;a.onDispose=c?function(){c(),hcsdesign.engine3D.unCastShadows(a)}:function(){hcsdesign.engine3D.unCastShadows(a)}}},b.prototype.unCastShadows=function(a){this.shadowGenerator.getShadowMap().renderList.splice(this.shadowGenerator.getShadowMap().renderList.indexOf(a),1)},b.prototype.reinitializeEngine=function(){if(!GlobalHelper.isMobileDevice()||"Firefox"!==BrowserDetect.browser)if(this.contextLostCount<this.MAX_CONTEXT_LOST)this.contextLostCount++;else{var a=hcsdesign.engine2D.searchComponent("PedagoComponent"),b=GlobalHelper.isMobileDevice()?"mobile":"no-webgl";a?a.redirectToPage(b):window.location.href=["js/Components/PedagoComponent/pedago/pages/",b,".php"].join("")}},b.prototype.setEnabled=function(a){this.enabled=a;var b=this.enabled?"block":"none";this.container.setAttribute("style","display:"+b),this.isViewer||(this.stats.domElement.style.display=this.stats.active&&this.enabled?"block":"none")},b.prototype.setInitialView=function(){if(!this.viewInitialized){var a,b=this.scene.getMeshByName("WallMesh_0");a=b?this.cameraFeatures.getBestFocusRadius(b,hcsdesign.engine3D.camera,hcsdesign.engine3D.scene):500,hcsdesign.engine3D.camera.radius=a,hcsdesign.engine3D.camera.alpha=-120/180*Math.PI,hcsdesign.engine3D.camera.beta=60/180*Math.PI,this.viewInitialized=!0}},b.prototype.requestCompute=function(){for(var a=0;a<this._components.size();a++)this._components[a].compute()},b.prototype.addComponent=function(a){return this._components.addComponent(a)},b.prototype.addInstancedComponent=function(a){return this._components.addInstancedComponent(a)},b.prototype.getComponent=function(a){return this._components.getComponent(a)},b.prototype.searchComponent=function(a){return this._components.getComponent(a)},b.prototype.removeComponent=function(a,b){this._components.removeComponent(a,b)},b.prototype.removeComponentByName=function(a){return this._components.removeComponent(a,!0)},b.prototype.clearComponents=function(){this._components.clear()},b.prototype.collideWithScene=function(b,c){var d=a.scene.createPickingRay(b,c),e=d.intersectMeshes(a.scene.meshes,!0,!0);
return e},b.prototype.projectMouseOnGround=function(b,c){var d,e;if(void 0===b){var f=this.pointerManager.getStatus();d=f.pos.x,e=f.pos.y}else d=b,e=c;var g=a.scene.createPickingRay(d,e);return g.intersectPlane(this.worldPlane)},b.prototype.projectMouseOnPlane=function(b,c,d){var e=this.pointerManager.getStatus(),c=void 0!==c?c:e.pos.x,d=void 0!==d?d:e.pos.y,f=a.scene.createPickingRay(c,d);return f.intersectPlane(b)},b.prototype.onClick=function(b){b.collided=a.collideWithScene(b.mstate.pos.x,b.mstate.pos.y),ujs.notify("hcs.engine3D.click.collided",b)},b.prototype.onDoubleClick=function(b){b.collided=a.collideWithScene(b.mstate.pos.x,b.mstate.pos.y),ujs.notify("hcs.engine3D.dblclick.collided",b)},b.prototype.onMouseEvent=function(a,b){var c=!1;1!=this.hardwareScaling&&(b.pos.scaleInPlace(this.hardwareScaling),b.posDelta.scaleInPlace(this.hardwareScaling),b.planPos.scaleInPlace(this.hardwareScaling),b.plan3DPos.scaleInPlace(this.hardwareScaling)),b.actions>0?(b.actions&b.ACTION_CLICK)>0?c="click":(b.actions&b.ACTION_DBLCLICK)>0?c="double-click":(b.actions&b.ACTION_DRAGSTART)>0&&this._mode!=this.MODE_DRAG?c="drag-start":(b.actions&b.ACTION_DRAGGING)>0?c="dragging":(b.actions&b.ACTION_DRAGEND)>0?c="drag-end":(b.actions&b.ACTION_SCROLLUP)>0?c="zoom-in":(b.actions&b.ACTION_SCROLLDOWN)>0&&(c="zoom-out"):(0!=b.posDelta.x||0!=b.posDelta.y)&&(c="mouse-move"),c&&(a.mstate=b,ujs.notify("hcs.engine3D."+c,a))},b.prototype.resize=function(){this.canvas.width=hcsdesign.getWidth()*this.hardwareScaling,this.canvas.height=hcsdesign.getHeight()*this.hardwareScaling,this.engine.setViewport(this.camera.viewport,hcsdesign.getWidth(),hcsdesign.getHeight())},b.prototype.onContextLost=function(a){a.preventDefault(),hcsdesign.setSelectedEngine(hcsdesign.ENGINE_2D)},b.prototype.onContextRestored=function(a){a.preventDefault(),this.reinitializeEngine()},b.prototype.onWallsReady=function(){a.setInitialView()},b.prototype.initialize=function(){hcsdesign.configuration.useMultiTexturing||(BABYLON.StandardMaterial.SpecularTextureEnabled=!1,BABYLON.StandardMaterial.BumpTextureEnabled=!1,BABYLON.StandardMaterial.ReflectionTextureEnabled=!1),this._components.initialize(),this._initialized=!0},b.prototype.update=function(a){this._components.checkDirtyComponents(),this._components.checkDirtyComponents();for(var b=0;b<this._components.size();b++)this._components[b].enabled&&this._components[b].update(a);this.stats.active&&this.stats.update(),this.keyboardManager.isPressed("27")&&(this.mode=this.MODE_NORMAL)},b.prototype.draw=function(){this.canDraw&&(this.engine.beginFrame(),this.scene.render(),this.engine.endFrame())},b}();var __extends=this.__extends||function(a,b){function c(){this.constructor=a}for(var d in b)b.hasOwnProperty(d)&&(a[d]=b[d]);c.prototype=b.prototype,a.prototype=new c},hcs;!function(a){var b=function(a){function b(b,c){var d=this;a.call(this,b,c),this.category=-1,this.addColor=null,this.isDefault=!0,this._cachedDefines=null,this._renderTargets=new BABYLON.SmartArray(16),this._worldViewProjectionMatrix=BABYLON.Matrix.Zero(),this._lightMatrix=BABYLON.Matrix.Zero(),this._globalAmbientColor=new BABYLON.Color3(0,0,0),this._baseColor=new BABYLON.Color3,this._scaledDiffuse=new BABYLON.Color3,this._scaledSpecular=new BABYLON.Color3,this._scene=c,this._shaderName="",this._uniforms=["world","viewProjection","vEyePosition"],this._uniformsLocations={},this._samplers=[],this._attribs=[BABYLON.VertexBuffer.PositionKind],this._customDefines=null,this._hasColors=null,this._hasNormals=null,this._hasUvs=null,this._hasDiffuse=null,this._hasBump=null,this._hasEnv=null,this._hasLights=null,this.build(),this.getRenderTargetTextures=function(){return d._renderTargets.reset(),d.reflectionTexture&&d.reflectionTexture.isRenderTarget&&d._renderTargets.push(d.reflectionTexture),d._renderTargets}}__extends(b,a);var c=-1;return b.prototype.needAlphaBlending=function(){return this.alpha<1},b.prototype.needAlphaTesting=function(){return!1},b.prototype.setCustomDefines=function(a){this._customDefines=a},b.prototype.build=function(){},b.prototype.normal=function(){this._attribs.push(BABYLON.VertexBuffer.NormalKind),this._hasNormals=!0},b.prototype.uv=function(){this._attribs.push(BABYLON.VertexBuffer.UVKind),this._hasUvs=!0},b.prototype.diffuse=function(){this._uniforms.push("vDiffuseInfos","diffuseMatrix"),this._samplers.push("diffuseSampler"),this._hasDiffuse=!0},b.prototype.bump=function(){this._uniforms.push("vBumpInfos","bumpMatrix"),this._samplers.push("bumpSampler"),this._hasBump=!0},b.prototype.color=function(){this._uniforms.push("vDiffuseColor"),this._hasColor=!0},b.prototype.setAlpha=function(){this._uniforms.push("vAlpha")},b.prototype.env=function(){this._uniforms.push("vReflectionInfos","reflectionMatrix"),this._samplers.push("reflectionCubeSampler"),this._hasEnv=!0},b.prototype.light=function(){this._uniforms.push("vLightsType","vLightData0","vLightDiffuse0","vLightSpecular0","vLightDirection0","vLightGround0","lightMatrix0","vLightData1","vLightDiffuse1","vLightSpecular1","vLightDirection1","vLightGround1","lightMatrix1","vLightData2","vLightDiffuse2","vLightSpecular2","vLightDirection2","vLightGround2","lightMatrix2","vLightData3","vLightDiffuse3","vLightSpecular3","vLightDirection3","vLightGround3","lightMatrix3","darkness0","darkness1","darkness2","darkness3"),this._samplers.push("shadowSampler0","shadowSampler1","shadowSampler2","shadowSampler3"),this._hasLights=!0},b.prototype._isReady=function(a,b,c,d){return this._hasDiffuse&&!this.diffuseReadyChunk(a,b)?!1:this._hasBump&&!this.bumpReadyChunk(a,b)?!1:this._hasEnv&&!this.envReadyChunk(a,b)?!1:(this._hasLights&&this.lightReadyChunk(d,a,b),this._hasUvs&&this.uvReadyChunk(d,a),!0)},b.prototype.isReady=function(a){if(this._wasPreviouslyReady)return!0;GlobalHelper.isWindowsPhoneDevice()&&(this._shaderName="legacydefault");var b,c=this._scene.getEngine(),d=new Array;if(b=this._customDefines?this._customDefines.slice():[],!this._isReady(b,d,c,a))return!1;var e=b.join("\n");return this._cachedDefines!=e&&(this._cachedDefines=e,this._effect=this._scene.getEngine().createEffect(this._shaderName,this._attribs,this._uniforms,this._samplers,e,d,this.onCompiled,this.onError)),this._effect.isReady()?(this._renderId=this._scene.getRenderId(),this._wasPreviouslyReady=!0,this._uniformsLocations.vEyePosition=this._effect.getUniform("vEyePosition"),this._uniformsLocations.viewProjection=this._effect.getUniform("viewProjection"),this._uniformsLocations.lightMatrix=[],this._uniformsLocations.darkness=[],this._uniformsLocations.lightMatrix[0]=this._effect.getUniform("lightMatrix0"),this._uniformsLocations.darkness[0]=this._effect.getUniform("darkness0"),this._uniformsLocations.lightMatrix[1]=this._effect.getUniform("lightMatrix1"),this._uniformsLocations.darkness[1]=this._effect.getUniform("darkness1"),this._uniformsLocations.lightMatrix[2]=this._effect.getUniform("lightMatrix2"),this._uniformsLocations.darkness[2]=this._effect.getUniform("darkness2"),this._uniformsLocations.lightMatrix[3]=this._effect.getUniform("lightMatrix3"),this._uniformsLocations.darkness[3]=this._effect.getUniform("darkness3"),!0):!1},b.prototype.diffuseReadyChunk=function(a){if(this._scene.texturesEnabled&&this.diffuseTexture&&BABYLON.StandardMaterial.DiffuseTextureEnabled){if(!this.diffuseTexture.isReady())return!1;a.push("#define DIFFUSE")}return!0},b.prototype.bumpReadyChunk=function(a,b){if(this._scene.getEngine().getCaps().standardDerivatives&&this.bumpTexture&&BABYLON.StandardMaterial.BumpTextureEnabled){if(!this.bumpTexture.isReady())return!1;a.push("#define BUMP"),b.push(a[a.length-1])}return!0},b.prototype.envReadyChunk=function(a){if(this.reflectionTexture&&BABYLON.StandardMaterial.ReflectionTextureEnabled){if(!this.reflectionTexture.isReady())return!1;a.push("#define REFLECTION")}return!0},b.prototype.uvReadyChunk=function(a,b){a&&a.isVerticesDataPresent(BABYLON.VertexBuffer.UVKind)&&b.push("#define UV1")},b.prototype.lightReadyChunk=function(a,b,c){var d=!1,e=0;if(this._scene.lightsEnabled)for(var f=0;f<this._scene.lights.length;f++){var g=this._scene.lights[f];if(g.isEnabled()&&(!a||-1===g.excludedMeshes.indexOf(a))){b.push("#define LIGHT"+e),e>0&&c.push(b[b.length-1]);var h;h=g instanceof BABYLON.SpotLight?"#define SPOTLIGHT"+e:g instanceof BABYLON.HemisphericLight?"#define HEMILIGHT"+e:"#define POINTDIRLIGHT"+e,b.push(h),e>0&&c.push(b[b.length-1]);var i=g.getShadowGenerator();if(a&&a.receiveShadows&&i&&(b.push("#define SHADOW"+e),e>0&&c.push(b[b.length-1]),d||(b.push("#define SHADOWS"),d=!0),i.useVarianceShadowMap&&(b.push("#define SHADOWVSM"+e),e>0&&c.push(b[b.length-1])),i.usePoissonSampling&&(b.push("#define SHADOWPCF"+e),e>0&&c.push(b[b.length-1]))),e++,4==e)break}}},b.prototype.setBaseColor=function(){},b.prototype._batchedBind=function(){},b.prototype._mandatoryBind=function(){},b.prototype.bind=function(a,b){this._effect.setMatrix("world",a),this._mandatoryBind(a,b)},b.prototype.unbind=function(){this.reflectionTexture&&this.reflectionTexture.isRenderTarget&&this._effect.setTexture("reflection2DSampler",null)},b.prototype._preBind=function(){a.prototype._preBind.call(this);var b=-1!=this.category&&c===this.category;c=this.category,b||this._batchedBind()},b.prototype.bindView=function(){this._effect._engine.setFloat3(this._uniformsLocations.vEyePosition,this._scene.activeCamera.position.x,this._scene.activeCamera.position.y,this._scene.activeCamera.position.z),this._effect._engine.setMatrix(this._uniformsLocations.viewProjection,this._scene.getTransformMatrix())},b.prototype.bindColor=function(){this._effect.setColor4("vDiffuseColor",this.diffuseColor,this.alpha)},b.prototype.bindAlpha=function(){this._effect.setFloat("vAlpha",this.alpha)},b.prototype.bindDiffuse=function(){this.diffuseTexture&&BABYLON.StandardMaterial.DiffuseTextureEnabled&&(this._effect.setTexture("diffuseSampler",this.diffuseTexture),this._effect.setFloat2("vDiffuseInfos",this.diffuseTexture.coordinatesIndex,this.diffuseTexture.level),this._effect.setMatrix("diffuseMatrix",this.diffuseTexture.getTextureMatrix()))},b.prototype.bindBump=function(){this.bumpTexture&&this._scene.getEngine().getCaps().standardDerivatives&&BABYLON.StandardMaterial.BumpTextureEnabled&&(this._effect.setTexture("bumpSampler",this.bumpTexture),this._effect.setFloat2("vBumpInfos",this.bumpTexture.coordinatesIndex,this.bumpTexture.level),this._effect.setMatrix("bumpMatrix",this.bumpTexture.getTextureMatrix()))},b.prototype.bindEnv=function(){this.reflectionTexture&&BABYLON.StandardMaterial.ReflectionTextureEnabled&&(this._effect.setTexture("reflectionCubeSampler",this.reflectionTexture),this._effect.setMatrix("reflectionMatrix",this.reflectionTexture.getReflectionTextureMatrix()),this._effect.setFloat3("vReflectionInfos",this.reflectionTexture.coordinatesMode,this.reflectionTexture.level,this.reflectionTexture.isCube?1:0))},b.prototype.bindLights=function(){for(var a=0,b=0;b<this._scene.lights.length;b++){var c=this._scene.lights[b];c.isEnabled()&&(c instanceof BABYLON.PointLight?c.transferToEffect(this._effect,"vLightData"+a):c instanceof BABYLON.DirectionalLight?c.transferToEffect(this._effect,"vLightData"+a):c instanceof BABYLON.SpotLight?c.transferToEffect(this._effect,"vLightData"+a,"vLightDirection"+a):c instanceof BABYLON.HemisphericLight&&c.transferToEffect(this._effect,"vLightData"+a,"vLightGround"+a),c.diffuse.scaleToRef(c.intensity,this._scaledDiffuse),c.specular.scaleToRef(c.intensity,this._scaledSpecular),this._effect.setColor4("vLightDiffuse"+a,this._scaledDiffuse,c.range),this._effect.setColor3("vLightSpecular"+a,this._scaledSpecular))}},b.prototype.bindShadows=function(a,b){if(this._hasLights&&this._scene.lightsEnabled)for(var c=0,d=0;d<this._scene.lights.length;d++){var e=this._scene.lights[d];if(e.isEnabled()){var f=e.getShadowGenerator();if(b.receiveShadows&&f&&(a.multiplyToRef(f.getTransformMatrix(),this._lightMatrix),this._effect.setTexture("shadowSampler"+c,f.getShadowMap()),this._effect._engine.setMatrix(this._uniformsLocations.lightMatrix[d],this._lightMatrix),this._effect._engine.setFloat(this._uniformsLocations.darkness[d],f.getDarkness())),c++,4==c)break}}},b.prototype.dispose=function(b){this.diffuseTexture&&this.diffuseTexture.dispose(),this.bumpTexture&&this.bumpTexture.dispose(),this.reflectionTexture&&this.reflectionTexture.dispose(),a.prototype.dispose.call(this,b)},b.prototype.clone=function(a){var b=this.isDefault;this.isDefault=!1;var c=this.serialize();this.isDefault=b;var d=ujs.deserializeObject(c);return d.name=a,d.isDefault=this.isDefault,d},b}(BABYLON.Material);a.StandardMaterial=b}(hcs||(hcs={})),function(a){var b=function(a){function b(b,c,d){a.call(this,b,c),this.params=d||{},this.params.diffuseTexture&&(this.diffuseTexture=this.params.diffuseTexture instanceof BABYLON.Texture?this.params.diffuseTexture:new BABYLON.Texture(this.params.diffuseTexture,hcsdesign.engine3D.scene),this.bumpTexture=null),this.params.bumpTexture&&(this.bumpTexture=this.params.bumpTexture instanceof BABYLON.Texture?this.params.bumpTexture:new BABYLON.Texture(this.params.bumpTexture,hcsdesign.engine3D.scene)),this.category=-1,this._shaderName="textured"}return __extends(b,a),b.prototype.build=function(){this.uv(),this.normal(),this.diffuse(),this.light(),this.setAlpha()},b.prototype._batchedBind=function(){},b.prototype._mandatoryBind=function(a,b){this.bindView(),this.bindShadows(a,b),this.bindDiffuse(),this.bindAlpha(),this.bindLights()},b}(a.StandardMaterial);a.TexturedMaterial=b}(hcs||(hcs={})),function(a){var b=function(b){function c(c,d,e){b.call(this,c,d),this.category=2,this.params=e||{},this.params.brillance=this.params.brillance||.5,this.params.brillance=BABYLON.Math.clamp(this.params.brillance,0,1),this.params.baseColor=this.params.baseColor||new BABYLON.Color3(.6,.6,.6),this.diffuseColor=new BABYLON.Color3(this.params.brillance*this.params.baseColor.r,this.params.brillance*this.params.baseColor.g,this.params.brillance*this.params.baseColor.b),this.reflectionTexture=new BABYLON.CubeTexture(a.Assets.flatEnvMapTexture,d),this._shaderName="metal",this.setCustomDefines(["#define METAL"])}return __extends(c,b),c.prototype.setBaseColor=function(a){this.params.baseColor=a,this.diffuseColor.copyFromFloats(this.params.brillance*a.r,this.params.brillance*a.g,this.params.brillance*a.b)},c.prototype.build=function(){this.color(),this.normal(),this.env(),this.light()},c.prototype._batchedBind=function(){this.bindEnv(),this.bindLights()},c.prototype._mandatoryBind=function(a,b){this.bindView(),this.bindShadows(a,b),this.bindColor()},c}(a.StandardMaterial);a.MetalMaterial=b}(hcs||(hcs={})),function(a){var b=function(b){function c(c,d,e){b.call(this,c,d,e),this.category=3,this.alpha=this.params.opacity||this.params.alpha||.3,this.alpha=BABYLON.Math.clamp(this.alpha,0,1),this.reflectionTexture=new BABYLON.CubeTexture(a.Assets.envMapTexture,d),this.setCustomDefines(["#define GLASS"]),this.setBaseColor(this.params.baseColor||{r:.6,g:.6,b:.6})}return __extends(c,b),c}(a.MetalMaterial);a.GlassMaterial=b}(hcs||(hcs={})),function(a){var b=function(b){function c(c,d,e){b.call(this,c,d,e),this.params.diffuseTexture||(this.diffuseTexture=new BABYLON.Texture(a.Assets.woodTextures.diffuse,hcsdesign.engine3D.scene)),this.category=1,this.setCustomDefines(["#define WOOD"])}return __extends(c,b),c}(a.TexturedMaterial);a.WoodMaterial=b}(hcs||(hcs={})),function(a){var b=function(a){function b(b,c,d){a.call(this,b,c,d),this.category=4,this.setCustomDefines(["#define LEATHER"])}return __extends(b,a),b}(a.TexturedMaterial);a.LeatherMaterial=b}(hcs||(hcs={})),function(a){var b=function(a){function b(b,c,d){a.call(this,b,c),this.category=5,this.params=d||{},this.params.factor=this.params.factor||1,this.params.factor=BABYLON.Math.clamp(this.params.factor,0,1),this.diffuseColor=new BABYLON.Color3(this.params.factor,this.params.factor,this.params.factor),this._shaderName="white",this.setCustomDefines(["#define WHITE"])}return __extends(b,a),b.prototype.setBaseColor=function(a){this.params.factor=(a.r+a.g+a.b)/3,this.diffuseColor.copyFromFloats(this.params.factor,this.params.factor,this.params.factor)},b.prototype.build=function(){this.color(),this.normal(),this.light()},b.prototype._batchedBind=function(){},b.prototype._mandatoryBind=function(a,b){this.bindView(),this.bindShadows(a,b),this.bindColor(),this.bindLights()},b}(a.StandardMaterial);a.WhiteMaterial=b}(hcs||(hcs={})),function(a){var b=function(a){function b(b,c,d){this.params=d||{},a.call(this,b,c,this.params),this.category=6,this.diffuseColor=this.params.baseColor?new BABYLON.Color3(this.params.baseColor.r,this.params.baseColor.g,this.params.baseColor.b):new BABYLON.Color3(1,1,1),this.setCustomDefines(["#define PLASTIC"])}return __extends(b,a),b.prototype.setBaseColor=function(a){this.params.baseColor=a,this.diffuseColor.copyFrom(a)},b}(a.WhiteMaterial);a.PlasticMaterial=b}(hcs||(hcs={})),function(a){var b=function(a){function b(b,c,d){a.call(this,b,c,d),this.category=7,this.setCustomDefines(["#define TILE"])}return __extends(b,a),b}(a.TexturedMaterial);a.TileMaterial=b}(hcs||(hcs={})),function(a){var b=function(b){function c(c,d,e){b.call(this,c,d,e),this.params.diffuseTexture||(this.diffuseTexture=new BABYLON.Texture(a.Assets.firePlaceWood.diffuse,hcsdesign.engine3D.scene)),this.category=8,this.setCustomDefines(["#define MATT"])}return __extends(c,b),c}(a.TexturedMaterial);a.MattMaterial=b}(hcs||(hcs={}));var hcs=window.hcs||{};!function(){hcs.StandardMaterial.prototype.serialize=function(a){if(this.isDefault)return null;var a=a||{};return a["class"]={name:hcs.StandardMaterial.GetClassFromCategory(this.category)},ujs.serializeObject(this,a,["name","backFaceCulling","addColor","params"]),a},hcs.StandardMaterial.prototype.deserialize=function(b){return b?(ujs.deserializeObject(b,this,["name","backFaceCulling","addColor"]),this.isDefault=!1,a(this),b.centroid&&(this.centroid=b.centroid),b.side&&(this.side=b.side),b.ambientColor&&this.setBaseColor(ujs.deserializeObject(b.ambientColor)),b.emissiveColor&&this.setBaseColor(ujs.deserializeObject(b.emissiveColor)),this):null},hcs.StandardMaterial.Deserialize=function(a){var b={};ujs.deserializeObject(a.params,b);var c=ujs.stringToFunction(a["class"].name),d=new c(a.name,hcsdesign.engine3D.scene,b);return d.deserialize(a),d},hcs.StandardMaterial.GetClassFromCategory=function(a){switch(a){case-1:return"hcs.StandardMaterial";case 1:return"hcs.WoodMaterial";case 2:return"hcs.MetalMaterial";case 3:return"hcs.GlassMaterial";case 4:return"hcs.LeatherMaterial";case 5:return"hcs.WhiteMaterial";case 6:return"hcs.PlasticMaterial";case 7:return"hcs.TileMaterial";case 8:return"hcs.MattMaterial";default:return Logger.warning("Category Error (hcs.StandardMaterial)"),null}},hcs.WoodMaterial.Deserialize=hcs.StandardMaterial.Deserialize,hcs.MetalMaterial.Deserialize=hcs.StandardMaterial.Deserialize,hcs.GlassMaterial.Deserialize=hcs.StandardMaterial.Deserialize,hcs.LeatherMaterial.Deserialize=hcs.StandardMaterial.Deserialize,hcs.WhiteMaterial.Deserialize=hcs.StandardMaterial.Deserialize,hcs.PlasticMaterial.Deserialize=hcs.StandardMaterial.Deserialize,hcs.TileMaterial.Deserialize=hcs.StandardMaterial.Deserialize,hcs.MattMaterial.Deserialize=hcs.StandardMaterial.Deserialize,hcs.TexturedMaterial.prototype.serialize=function(){if(1==this.isDefault)return null;var a={};return hcs.StandardMaterial.prototype.serialize.call(this,a),ujs.serializeObject(this,a,["diffuseTexture","bumpTexture"]),a},hcs.TexturedMaterial.prototype.deserialize=function(a){return ujs.deserializeObject(a,this,["diffuseTexture","bumpTexture"]),hcs.StandardMaterial.prototype.deserialize.call(this,a),this},hcs.GlassMaterial.prototype.serialize=function(){if(1==this.isDefault)return null;var a={};return hcs.StandardMaterial.prototype.serialize.call(this,a),ujs.serializeObject(this,a,["alpha"]),a},hcs.GlassMaterial.prototype.deserialize=function(a){return ujs.deserializeObject(a,this,["alpha"]),hcs.StandardMaterial.prototype.deserialize.call(this,a),this},BABYLON.StandardMaterial.prototype.serialize=function(){var a=BABYLON.Material.prototype.serialize.call(this);return a["class"]={name:"BABYLON.StandardMaterial"},ujs.serializeObject(this,a,["diffuseTexture","ambientTexture","opacityTexture","reflectionTexture","emissiveTexture","specularTexture","bumpTexture","ambientColor","diffuseColor","specularColor","specularPower","emissiveColor","addColor"]),a},BABYLON.StandardMaterial.prototype.deserialize=function(b){return BABYLON.Material.prototype.deserialize.call(this,b),ujs.deserializeObject(b,this,["diffuseTexture","ambientTexture","opacityTexture","reflectionTexture","emissiveTexture","specularTexture","bumpTexture","ambientColor","diffuseColor","specularColor","specularPower","emissiveColor","addColor"]),a(this),this},hcs.BlackMaterial=hcs.WhiteMaterial,hcs.PolishedMaterial=hcs.WoodMaterial,hcs.LuxensMaterial=hcs.PlasticMaterial,hcs.TransparentMaterial=hcs.GlassMaterial;var a=function(a){if((a instanceof hcs.GlassMaterial||a instanceof hcs.MetalMaterial)&&a.addColor&&a.addColor.color)a.setBaseColor(a.addColor.color);else if(a.addColor&&a.addColor.color&&a.diffuseTexture&&a.diffuseTexture.url){a.addColor.size=a.addColor.size||{width:512,height:512};var b=new Image;b.crossOrigin="Anonymous";var c=a.addColor.color;b.src=a.diffuseTexture.url;var d=new BABYLON.DynamicTexture("canvas",a.addColor.size.width,hcsdesign.engine3D.scene,!0);d.url=a.diffuseTexture.url;var e={u:a.diffuseTexture.uScale,v:a.diffuseTexture.vScale};a.diffuseTexture=d,a.diffuseColor=new BABYLON.Color3(c.r,c.g,c.b).scale(.2),b.onload=function(){var f=d.getContext();f.fillStyle=hcs.MaterialFactory.rgbToHex(c),f.clearRect(0,0,a.addColor.size.width,a.addColor.size.height),f.drawImage(b,0,0,a.addColor.size.width,a.addColor.size.height),f.globalCompositeOperation="soft-light",f.globalCompositeOperation="color-burn",f.globalCompositeOperation="multiply",f.fillRect(0,0,a.addColor.size.width,a.addColor.size.height),d.wrapU=BABYLON.Texture.WRAP_ADDRESSMODE,d.wrapV=BABYLON.Texture.WRAP_ADDRESSMODE,d.uScale=e.u||1,d.vScale=e.v||1,d.update()}}}}();var BaseStructure=function(){var a=0,b=function(b){this.id=a++,this.name=b||"Structure_"+a};return b.prototype.add=function(a,b){if("undefined"==typeof this[a]&&(this[a]=[]),this[a]instanceof Array){var c=this[a].indexOf(b);if(-1==c)return!1;this[a].push(b)}else this[a]=b;return!0},b.prototype.initialize=function(){},b.prototype.update=function(){},b.prototype.serialize=function(){},b.Deserialize=function(){},b.prototype.updateReferences=function(){},b.prototype.updateFieldArray=function(a,b,c){c.length=0;for(var d=0,e=this.structureIds.length;e>d;d++)for(var f=0,g=b.length;g>f;f++)b[f].id==this.structureIds[d]&&c.push(b[f])},b.prototype.getElementByName=function(a,b){var c=function(a,b){for(var c=0,d=null,e=b.length;e>c&&null===b;)b[c].name==a&&(d=b[c]),c++;return d};if(this[b]instanceof Array)return c(a,this[b]);var d=null;for(var e in this)this[e]instanceof Array&&(d=c(a,this[e]));return d},b}(),BaseComponent2D=function(){var a=function(a,b){this.core=a,this.name=b||"Component2D",this.structure=null,this.keyboard=null,this.priority=42,this.enabled=!0;var c=this;"undefined"!=typeof a&&(this.structure=this.core.structure,this.keyboardManager=this.core.keyboardManager,document.addEventListener("hcs.contextChanged",function(a){c.enabled&&a.context!=a.previousContext&&c.onContextChanged(a.context)},!1))};return a.prototype.initialize=function(){this.startListening()},a.prototype.startListening=function(){},a.prototype.stopListening=function(){},a.prototype.onContextChanged=function(a){"2D"==a?this.startListening():this.stopListening()},a.prototype.disable=function(){this.enabled=!1,this.stopListening()},a.prototype.enable=function(){this.enabled=!0},a.prototype.getTargeted=function(){return null},a.prototype.update=function(){},a.prototype.compute=function(){},a.prototype.destroy=function(){},a}(),BaseComponent3D=function(){var a=function(a,b){if(this.core=a,this.engine3D=null,this.name=b||"Component3D",this.structure=null,this.keyboardManager=null,this.materialFactory=null,this.scene=null,this.draggableObjects=null,this.cameraController=null,this.cubeCameras=null,this.configuration=null,this.camera=null,this.enabled=!0,this.initialized=!1,"undefined"!=typeof a){this.name=b,this.engine3D=this.core.engine3D,this.structure=this.core.structure,this.keyboardManager=this.core.keyboardManager,this.configuration=this.core.configuration,this.scene=this.core.engine3D.scene,this.camera=this.core.engine3D.camera,this.cubeCameras=this.core.engine3D.cubeCameras,this.cameraController=this.core.engine3D.cameraController,this.materialFactory=this.core.engine3D.materialFactory;var c=this;document.addEventListener("hcs.contextChanged",function(a){c.enabled&&a.context!=a.previousContext&&c.onContextChanged(a.context)},!1),document.addEventListener("hcs.engine3D.forceReload",this.reloadConfiguration,!1)}};return a.prototype.initialize=function(){},a.prototype.startListening=function(){},a.prototype.stopListening=function(){},a.prototype.onContextChanged=function(a){"3D"==a?this.startListening():this.stopListening()},a.prototype.disable=function(){this.enabled=!1,this.stopListening()},a.prototype.enable=function(){this.enabled=!0},a.prototype.update=function(){},a.prototype.compute=function(){},a.prototype.reloadConfiguration=function(){},a.prototype.getFloor=function(a){var b=this.core.getComponentByName("FloorComponent3D"),a=a||hcsdesign.getSelectedStructure();return b.getFloor(a)},a.prototype.getObjectStructure=function(a){return Logger.warning("[BaseComponent3D] getObjectStructure - Fonction d��preci��e"),a.structure},a.prototype.getParentRelativeToScene=function(a){var b=a.parent;if("structure"!=b.name&&"undefined"!=typeof b.parent){for(;"undefined"!=typeof b.parent&&"structure"!=b.parent.name;)b=b.parent;a=b}return a},a.prototype.getParentRelativeToGroup=function(a){var b=a.parent;if("structure"!=b.name&&-1==b.name.indexOf("group_")&&"undefined"!=typeof b.parent){for(;"undefined"!=typeof b.parent&&-1==b.parent.name.indexOf("group_")&&"structure"!=b.parent.name;)b=b.parent;a=b}return a},a.prototype.getObjectByName=function(a,b){return this.core.getSelectedStructure().getElementByName(a,b)},a.prototype.destroy=function(){},a}(),BaseEditionComponent=function(){var a=function(a){this.name=a||"EditionComponent"};return a.prototype.initialize=function(){},a}(),MainMenuComponent=function(){var a=[{title:"房型设计",index:1,icon:"",action:"hcs.request.changeEngine",id:"draw2D",params:{engine:"2D"},layout:"layout-list",context:"2D",items:[]},{title:"家具设计",index:2,icon:"",action:"hcs.request.changeEngine",id:"furnishing3D",context:"3D",params:{engine:"3D"},layout:"layout-list",items:[]}],b=function(b){BaseComponent2D.call(this,b,"MainMenuComponent"),this.menu=new hcs.UI.Menu(a,"mainMenuTabs",{selected:a[0],inception:!1}),this.menu.initialize(),this.menuTitleDom=document.getElementById("mainMenuTitle"),this.menuTitleDom.innerHTML=_(this.menu.selected.title),this.submenu=new hcs.UI.Menu(a[0].items,"mainMenuContentList"),document.addEventListener("hcs.menu.main.add",this.addItem.bind(this),!1),document.addEventListener("hcs.menu.main.replace",this.replaceItem.bind(this),!1),document.addEventListener("hcs.menu.main.deselect",this.deselectItem.bind(this),!1),document.addEventListener("hcs.menu.main.remove",this.removeItem.bind(this),!1),document.addEventListener("hcs.request.changeEngine",this.onChangeEngine.bind(this),!1),document.addEventListener("hcs.menu.main.remove",this.removeItem.bind(this),!1)};return b.prototype=new BaseComponent2D,b.prototype.onChangeEngine=function(){this.menuTitleDom.innerHTML=_(this.menu.selected.title),this.updateSubMenu()},b.prototype.removeItem=function(a){this.menu.deleteMenuItem(a.item),this.menu.updateHtml(),this.submenu.updateHtml()},b.prototype.replaceItem=function(a){if(a.item){var b=a.item,c=a.merge||!1;this.menu.replaceMenuItem(b.id,b,c),this.submenu.updateHtml(b)}},b.prototype.deselectItem=function(a){var b=a.all||!1,c=a.itemId||!1;this.submenu.selected.items&&0!=this.submenu.selected.items.length&&this.submenu.selected.items!={}||this.submenu.deselect(b,c)},b.prototype.updateSubMenu=function(){this.menu.selected.items&&(this.submenu=new hcs.UI.Menu(this.menu.selected.items,"mainMenuContentList"),this.submenu.initialize())},b.prototype.addItem=function(a){if(a.item&&a.menuPath){var b=a.item,c=a.menuPath,d=a.position>-1?a.position:1e5;b.index=b.index>-1?b.index:d,this.menu.addMenuItem(c,b,d),this.submenu.updateHtml()}},b.prototype.removeItem=function(a){a.item&&(this.menu.deleteMenuItem(a.item),this.menu.updateHtml(),this.submenu.updateHtml())},b}(),TopMenuComponent=function(a){var b=[],c=[],d=function(){BaseComponent2D.call(this,a,"TopMenuComponent"),this.menu=new hcs.UI.Menu(b,"toolbarMenu",{oneClick:!0}),this.submenu=new hcs.UI.Menu(c,"subMenuList",{oneClick:!0}),document.addEventListener("hcs.menu.top.add",this.addItem.bind(this),!1),document.addEventListener("hcs.menu.top.delete",this.removeItem.bind(this),!1),document.addEventListener("hcs.menu.top.replace",this.replaceItem.bind(this),!1),document.addEventListener("hcs.menu.top.sub.add",this.addSubItem.bind(this),!1),document.addEventListener("hcs.menu.top.sub.delete",this.removeSubItem.bind(this),!1),document.addEventListener("hcs.menu.top.sub.replace",this.replaceSubItem.bind(this),!1),document.addEventListener("hcs.menu.top.deselect",this.deselectItem.bind(this),!1)};return d.prototype=Object.create(BaseComponent2D.prototype),d.prototype._addItem=function(a,b){if(b.item&&b.menuPath){var c=b.item,d=b.menuPath,e=b.position>-1?b.position:1e5;c.index=c.index>-1?c.index:e,a.addMenuItem(d,c,e),a.updateHtml()}},d.prototype._replaceItem=function(a,b){if(b.item){var c=b.item,d="undefined"!=typeof b.merge?b.merge:!1;a.replaceMenuItem(c.id,c,d),a.updateHtml()}},d.prototype._removeItem=function(a,b){b.id&&(a.deleteMenuItem(b.id),a.updateHtml())},d.prototype.deselectItem=function(){this.menu.deselect(!0)},d.prototype.addItem=function(a){this._addItem(this.menu,a)},d.prototype.replaceItem=function(a){this._replaceItem(this.menu,a)},d.prototype.removeItem=function(a){this._removeItem(this.menu,a)},d.prototype.addSubItem=function(a){this._addItem(this.submenu,a)},d.prototype.replaceSubItem=function(a){this._replaceItem(this.submenu,a)},d.prototype.removeSubItem=function(a){this._removeItem(this.submenu,a)},d}(),BaseTopMenuComponent2D=function(){var a=function(a,b){BaseComponent2D.call(this,a,b),this._topMenuComponent=null,this._item={},this.isMainMenuItem=!0};return a.prototype=Object.create(BaseComponent2D.prototype),a.prototype.initialize=function(){BaseComponent2D.prototype.initialize.call(this),ujs.notify(this.isMainMenuItem?"hcs.menu.top.add":"hcs.menu.top.sub.add",{item:this._item,menuPath:"."})},a.prototype.destroy=function(){BaseComponent2D.prototype.destroy.call(this),ujs.notify(this.isMainMenuItem?"hcs.menu.top.delete":"hcs.menu.top.sub.delete",{id:this._item.id,menuPath:"."})},a}(),SaveComponent=function(){var a,b=!1,c=function(b){BaseTopMenuComponent2D.call(this,b,"SaveComponent"),this._item={title:"Save",icon:"images/save_icon.png",action:"hcs.request.saveStructure",id:"toolbarSave",items:[],index:"2"},document.addEventListener("hcs.request.saveStructure",this.saveStructure.bind(this),!1),window.addEventListener("message",function(b){var c=JSON.parse(b.data);"save-plan"==c.action?a.saveStructure(b):"update-urls"==c.action&&(c.planUrl&&(a.core.api.planUrl=c.planUrl),c.newUrl&&(a.core.api.newUrl=c.newUrl),c.screenshotUrl&&(a.core.api.screenshotUrl=c.screenshotUrl),c.saveUrl&&(a.core.api.saveUrl=c.saveUrl))}),a=this};return c.prototype=Object.create(BaseTopMenuComponent2D.prototype),c.prototype.startProcess=function(){b=!0},c.prototype.endProcess=function(){b=!1},c.prototype.saveStructure=function(c,d,e){if(b!==!0){this.startProcess();var d=d||c.callback||function(){};if(c.callback=!1,"planStructure"!==this.structure.name)a.sendToServer(a.core.structure.name,void 0,d,e);
else{var f=new Date,g=this.core.api.title||[_("My plan")+" ",f.getDay(),"/",f.getMonth(),"/",f.getFullYear()," - ",Math.floor(100*Math.random())].join(""),h="",i=function(b){g=""!==b.textInput?b.textInput:g,h=""!==b.textAreaInput?b.textAreaInput:h,a.sendToServer(g,h,d,e)},j={title:_("Save a Plan"),message:_("Choose a name for your plan"),buttonBText:_("Save"),buttonAText:_("Cancel"),buttonA:!0,buttonB:!0,input:!0,inputValue:g,textArea:!0,textAreaPlaceHolder:_("Enter a description"),onClose:a.endProcess,onClickB:i,onClickA:function(){}};hcs.UI.MessageBox.close(),hcs.UI.MessageBox.show(j)}}},c.prototype.onError=function(){var b=a.core.saveLocalStructure(!1,!0),c={title:_("Save a Plan"),message:_("An error occured during save, please try later."),buttonA:!0,buttonAText:_("Download a backup"),onClose:a.endProcess,onClickA:function(){var c=a.core.getOrigin();parent.postMessage({type:"downloadFile",name:"plan",content:"data:text/html;base64,"+btoa(b)},c),hcs.UI.MessageBox.close(),a.endProcess()}};hcs.UI.MessageBox.show(c)},c.prototype.sendToServer=function(b,c,d,e){var f=this.core.getPreviewImage(320,240),g=this.core.engine2D.isEnabled()?"2D":"3D";a.core.structure.name=b;var h=a.core.saveLocalStructure(!1,!0),i=["title=",encodeURIComponent(b),"&plan=",encodeURIComponent(h),"&preview=",f,"&previewMode=",g];if(a.core.api.params){var j=a.core.api.params;"object"==typeof j&&(j=JSON.stringify(j)),"string"==typeof j&&i.push("&params="+j)}a.core.api.id&&i.push("&id="+a.core.api.id),a.core.api.apiKey&&i.push("&apikey="+a.core.api.apiKey),c&&i.push("&description="+encodeURIComponent(c)),ujs.ajax({method:"POST",url:a.core.api.saveUrl,withCredentials:!0,params:i.join(""),onerror:function(b){a.onError(b),e&&e()},success:function(b){var c=JSON.parse(b),f=_("An error occured during save, please try later.");if("ok"===c.status){a.core.saveStackToLocal(),f=_("Your plan has been saved."),a.core.structure.planId=!0;var g=function(){};if(c["refresh-url"]){var h=a.core.getOrigin();f+="<br />"+_("you will be redirected ..."),g=function(){parent.postMessage({type:"refresh",url:c["refresh-url"]},h)}}parent.postMessage({type:"planSaved"},a.core.getOrigin()),hcs.UI.MessageBox.show({title:_("Save a Plan"),message:f,buttonAText:_("Close"),buttonA:!0,autoHide:!0,onClose:g,force:!0}),c.params&&(a.core.api.params=c.params),d(!0)}else c.connectionUrl?a.core._loginIframe(c.connectionUrl,c.frameWidth||Math.round(window.innerWidth/2),c.frameHeight||Math.round(window.innerHeight/2)):a.onError(),e&&e();a.endProcess()}})},c}(),NewComponent=function(){var a,b=function(b){BaseTopMenuComponent2D.call(this,b,"NewComponent"),this._item={title:_("New"),icon:"fa fa-file",action:"hcs.request.newPlan",id:"toolbarNew",items:[],index:"0"},a=this,document.addEventListener("hcs.request.newPlan",function(){a.launchProcess(),a.core.engine2D.bestZoom()},!1)};return b.prototype=Object.create(BaseTopMenuComponent2D.prototype),b.prototype.createNewPlan=function(){ujs.notify("hcs.request.closePopup"),a.core.structure.clear(),a.core._createDefaultStructure(),a.core.engine2D.reinitialize(),a.core.setSelectedEngine(a.core.ENGINE_2D),a.core.saveLocalStructure(!1),a.core.structure.planId=-1,a.core.structure.name="planStructure",ujs.triggerEvent(document.getElementById("draw2D"),"click"),ujs.notify("hcs.request.newPlanReady"),a.core.engine2D.bestZoom()},b.prototype.launchProcess=function(){if(!a.core.api.newUrl||!a.core.api.saveUrl)return void a.createNewPlan();var b=[a.core.api.newUrl];if(a.core.api.params){var c=-1!==a.core.api.newUrl.indexOf("?")?"&":"?";b.push([c,"params=",JSON.stringify(a.core.api.params)].join(""))}var d=function(){ujs.ajax({method:"GET",url:b.join(""),withCredentials:!0,success:function(b){var c=JSON.parse(b);if("ok"===c.status)c.saveUrl&&(a.core.api.saveUrl=c.saveUrl),c.title&&(a.core.api.planTitle=c.title),c.params&&(a.core.api.params=JSON.parse(c.params)),a.createNewPlan();else if(c.connectionUrl)a.core._loginIframe(c.connectionUrl,c.frameWidth||Math.round(window.innerWidth/2),c.frameHeight||Math.round(window.innerHeight/2));else{var d={title:_("Save a Plan"),message:c.message||_("Error occured during save."),buttonA:!0,buttonAText:_("Ok"),onClickA:function(){hcs.UI.MessageBox.close()}};hcs.UI.MessageBox.show(d)}}})},e=function(){ujs.notify("hcs.request.saveStructure",{callback:d})};hcs.UI.MessageBox.show({title:_("New Plan"),message:_("Do you want to save your current plan?"),buttonCText:_("Yes"),buttonBText:_("No"),buttonAText:_("Cancel"),buttonA:!0,buttonB:!0,buttonC:!0,onClickC:e,onClickB:d,onClickA:function(){hcs.UI.MessageBox.close()}})},b}(),OptionsComponent=function(){var a=function(a){BaseTopMenuComponent2D.call(this,a,"OptionsComponent"),this._item={title:"Options",icon:"fa fa-cog",action:"optionMenu",id:"toolbarOption",selectionnable:!0,index:"3",items:[{title:"Change language",action:"hcs.request.changeLang",id:"toolbarChangeLanguage",index:100},{title:"<hr />",index:1e5},{title:"About Wanaplan",action:"hcs.ui.showAboutWindow",id:"toolbarAbout",index:100001}]}};return a.prototype=Object.create(BaseTopMenuComponent2D.prototype),a}(),ExitComponent=function(){var a,b=function(b){BaseTopMenuComponent2D.call(this,b,"ExitComponent"),this._item={title:"Exit",icon:"fa fa-sign-out",action:"hcs.request.exit",id:"toolbarExit",items:[]},a=this,document.addEventListener("hcs.request.exit",function(){a.exit()},!1)};return b.prototype=Object.create(BaseTopMenuComponent2D.prototype),b.prototype.doExit=function(){if(hcsdesign.api.params.exitUrl){var b=a.core.getOrigin();parent.postMessage({type:"refresh",url:hcsdesign.api.params.exitUrl},b)}parent.postMessage({type:"planExit"},a.core.getOrigin()),ujs.notify("hcs.request.exited")},b.prototype.exit=function(){var b={title:_("Exit"),message:_("Are you sure you want to leave this page"),buttonA:!0,buttonB:!0,buttonBText:_("Exit"),buttonAText:_("Cancel"),onClickB:function(b){return a.doExit(b),!0}};hcs.UI.MessageBox.show(b)},b}(),ScreenshotMenuComponent=function(){var a=function(a){BaseTopMenuComponent2D.call(this,a,"ScreenshotMenuComponent"),this.isMainMenuItem=!1,this._item={title:"Capture",icon:"fa fa-camera",action:"hcs.request.takeScreenshot",id:"toolbarScreenshot",items:[],index:500}};return a.prototype=Object.create(BaseTopMenuComponent2D.prototype),a}(),FullscreenComponent=function(){function a(a){a.requestFullScreen||(a.requestFullScreen=a.msRequestFullscreen||a.webkitRequestFullscreen||a.mozRequestFullScreen||function(){return!1}),document.cancelFullScreen||(document.cancelFullScreen=document.msExitFullscreen||document.webkitCancelFullScreen||document.mozCancelFullScreen||function(){return!1})}function b(){return document.fullscreen||document.msFullscreenElement||document.webkitIsFullScreen||document.mozFullScreen}var c=function(a){BaseTopMenuComponent2D.call(this,a,"FullscreenComponent"),this.isMainMenuItem=!1,this._item={title:"Full Screen",icon:"fa fa-arrows-alt",action:"hcs.request.toggleFullscreen",id:"fullscreen-btn",items:[],index:1001}};return c.prototype=Object.create(BaseTopMenuComponent2D.prototype),c.prototype.initialize=function(){if(BaseTopMenuComponent2D.prototype.initialize.call(this),document.addEventListener("hcs.request.toggleFullscreen",this.toggleFullscreen,!1),document.addEventListener("mozfullscreenchange",this.onFullScreenChange,!1),document.addEventListener("webkitfullscreenchange",this.onFullScreenChange,!1),document.addEventListener("MSFullscreenChange",this.onFullScreenChange,!1),document.addEventListener("fullscreenchange",this.onFullScreenChange,!1),hcsdesign.mode===hcsdesign.MODE_VIEWER){var b=document.getElementById("fullscreen-btn");b.setAttribute("title",_("Toggle to fullscreen mode")),b.addEventListener("click",toggleFullscreen,!1)}a(document.body)},c.prototype.destroy=function(){BaseTopMenuComponent2D.prototype.destroy.call(this),document.removeEventListener("hcs.request.toggleFullscreen",this.toggleFullscreen),document.removeEventListener("mozfullscreenchange",this.onFullScreenChange),document.removeEventListener("webkitfullscreenchange",this.onFullScreenChange),document.removeEventListener("MSFullscreenChange",this.onFullScreenChange),document.removeEventListener("fullscreenchange",this.onFullScreenChange)},c.prototype.toggleFullscreen=function(c){var d=document.body;c instanceof HTMLElement&&(d=c,a(d)),b()?document.cancelFullScreen():d.requestFullScreen()},c.prototype.onFullScreenChange=function(){var a=document.getElementById("fullscreen-btn").querySelector(".menu-icon > i");a.setAttribute("class",b()?"fa fa-expand":"fa fa-arrows-alt")},c}(),TransparencyComponent=function(){var a=0,b=a,c=function(a){BaseComponent3D.call(this,a,"TransparencyComponent"),this._item={title:_("Transparency"),id:"transparencyButton",icon:"images/icon-transparency.png",action:"hcs.request.switch-transparency",addClass:"hidden",index:12}};return c.prototype=Object.create(BaseComponent3D.prototype),c.prototype.initialize=function(){BaseComponent3D.prototype.initialize.call(this),ujs.notify("hcs.menu.top.sub.add",{item:this._item,menuPath:"."})},c.prototype.startListening=function(){if(this.switchTransparencyMode=this.switchTransparencyMode.bind(this),hcsdesign.mode===hcsdesign.MODE_VIEWER){var a=document.getElementById("switch-transparency-btn");a.setAttribute("title",_("Toggle transparency")),a.addEventListener("click",this.switchTransparencyMode,!1)}document.addEventListener("hcs.request.switch-transparency",this.switchTransparencyMode,!1),document.addEventListener("hcs.engine3d.wallTransparency.on",this.onWallTransparencyOn,!1),document.addEventListener("hcs.engine3d.wallTransparency.off",this.onWallTransparencyOff,!1)},c.prototype.stopListening=function(){document.removeEventListener("hcs.request.switch-transparency",this.switchTransparencyMode),document.removeEventListener("hcs.engine3d.wallTransparency.on",this.onWallTransparencyOn),document.removeEventListener("hcs.engine3d.wallTransparency.off",this.onWallTransparencyOff)},c.prototype.switchTransparencyMode=function(){var c=hcsdesign.getComponentByName("WallComponent3D"),d=hcsdesign.engine3D.cameraFeatures;if(d.setCamera(hcsdesign.engine3D.camera),b=(b+1)%2,b===a){d&&d.stopTransparency();for(var e in hcsdesign.structure.members)c.switchTransparentStatusByStructure(hcsdesign.structure.members[e]);ujs.notify("hcs.engine3d.wallTransparency.off")}else if("Camera"==d.camera.name){for(var e in hcsdesign.structure.members)c.switchTransparentStatusByStructure(hcsdesign.structure.members[e]);d&&d.startTransparency(),ujs.notify("hcs.engine3d.wallTransparency.on")}},c.prototype.setTransparencyMode=function(a){b!=a&&this.switchTransparencyMode()},c.prototype.onContextChanged=function(a){BaseComponent3D.prototype.onContextChanged.call(this,a),"3D"==a?ujs.notify("hcs.menu.top.sub.replace",{item:{id:"transparencyButton",addClass:""},merge:!0},!0):ujs.notify("hcs.menu.top.sub.replace",{item:{id:"transparencyButton",addClass:"hidden"},merge:!0},!0)},c.prototype.onWallTransparencyOn=function(){var a=hcsdesign.getComponentByName("TopMenuComponent");if(a){var b=a.submenu;b.replaceMenuItem("transparencyButton",{icon:"images/icon-opacity.png"},!0),b.updateHtml()}},c.prototype.onWallTransparencyOff=function(){var a=hcsdesign.getComponentByName("TopMenuComponent");if(a){var b=a.submenu;b.replaceMenuItem("transparencyButton",{icon:"images/icon-transparency.png"},!0),b.updateHtml()}},c.prototype.onEngineSwitched=function(){b!==a&&this.switchTransparencyMode()},c}(),CameraComponent=function(){var a,b=new BABYLON.Vector3(0,170,0),c=function(c){BaseComponent3D.call(this,c,"CameraComponent"),a=this,this.ORBITCAMERA=0,this.FPSCAMERA=1,this.scene=c.engine3D.scene,this.cameraActiveId=0,this.lookAt=null;var d=function(){this.bindLookAt(hcsdesign.getComponentByName("AvatarComponent3D").avatar),document.removeEventListener("hcs.engine3d.globaleFloorReady",d,!1)}.bind(this);document.addEventListener("hcs.engine3d.globaleFloorReady",d,!1),this.avatarPosition=b.clone(),this.camera=[new hcs.Input.OrbitCamera("Camera",-Math.PI/3,Math.PI/4,1500,b.clone(),c.engine3D.scene),new hcs.Input.FirstPersonCamera("FPS",this.avatarPosition,c.engine3D.scene)],this.camera[0].attachControl(c.engine3D.canvas),this.camera[0].inertia=0,this.camera[0].angularSensibility=300,this.camera[0].radiusSpeedFactor=.005,this.camera[0].moveSpeedFactor=5,this.camera[0].fov=.25*Math.PI,this.camera[0].minZ=15,this.camera[0].maxZ=4e4,this.camera[1].minZ=15,this.camera[1].maxZ=4e4,this.camera[1].heightMin=20,this.camera[1].heightMax=240,this.camera[1].radiusSpeedFactor=.2,this.camera[1].angularSensibility=400,this.camera[1].height=170,this.camera[1].fov=70/180*Math.PI,c.engine3D.scene.activeCamera=this.camera[this.cameraActiveId],c.engine3D.camera=c.engine3D.scene.activeCamera};return c.prototype=new BaseComponent3D,c.prototype.startListening=function(){this.onCameraChanged=this.onCameraChanged.bind(this),this.onFloorLevelChanged=this.onFloorLevelChanged.bind(this),this.onControleEnd=this.onControleEnd.bind(this),this.onControleMove=this.onControleMove.bind(this),this.onNewPlanReady=this.onNewPlanReady.bind(this),this.onGlobaleFloorReady=this.onGlobaleFloorReady.bind(this),document.addEventListener("hcs.request.cameraChanged",this.onCameraChanged,!1),document.addEventListener("hcs.request.floorSelected",this.onFloorLevelChanged,!1),document.addEventListener("mousemove",this.onMouseMove,!1),document.addEventListener("mousewheel",this.onMouseZoom,!1),document.addEventListener("hcs.engine3d.dragcontrols.end",this.onControleEnd,!1),document.addEventListener("hcs.engine3d.dragcontrols.move",this.onControleMove,!1),document.addEventListener("hcs.request.newPlanReady",this.onNewPlanReady,!1),document.addEventListener("hcs.engine3d.globaleFloorReady",this.onGlobaleFloorReady,!1),hcsdesign.engine3D.pointerManager.touchManager.on("swipe",this.onMouseZoom)},c.prototype.stopListening=function(){document.removeEventListener("hcs.request.cameraChanged",this.onCameraChanged,!1),document.removeEventListener("hcs.request.floorSelected",this.onFloorLevelChanged,!1),document.removeEventListener("hcs.request.newPlanReady",this.onNewPlanReady,!1),document.removeEventListener("mousemove",this.onMouseMove),document.removeEventListener("mousewheel",this.onMouseZoom),document.removeEventListener("hcs.engine3d.dragcontrols.end",this.onControleEnd),document.removeEventListener("hcs.engine3d.dragcontrols.move",this.onControleMove),document.removeEventListener("hcs.engine3d.globaleFloorReady",this.onGlobaleFloorReady),hcsdesign.engine3D.pointerManager.touchManager.off("swipe",this.onMouseZoom)},c.prototype.toggleFXAA=function(a){var b=hcsdesign.engine3D.scene.activeCamera;return"number"==typeof a&&(b=hcsdesign.engine3D.scene.cameras[a]),b.__fxaa__cookie?(b.__fxaa__cookie.dispose(),b.__fxaa__cookie=null):b.__fxaa__cookie=new BABYLON.FxaaPostProcess("fxaa",1,b),b.__fxaa__cookie?!0:!1},c.prototype.toggleFSAA=function(a,b){var b="number"==typeof b||BABYLON.Texture.BILINEAR_SAMPLINGMODE,c=hcsdesign.engine3D.scene.activeCamera;return"number"==typeof a&&(c=hcsdesign.engine3D.scene.cameras[a]),c.__fsaa__cookie?(c.__fsaa__cookie.dispose(),c.__fsaa__cookie=null):(c.__fsaa__cookie=new BABYLON.PassPostProcess("fsaa",2,c),c.__fsaa__cookie.renderTargetSamplingMode=b),c.__fsaa__cookie?!0:!1},c.prototype.disableAllPostProcess=function(){camera.__fsaa__cookie&&(camera.__fsaa__cookie.dispose(),camera.__fsaa__cookie=null),camera.__fxaa__cookie&&(camera.__fxaa__cookie.dispose(),camera.__fxaa__cookie=null)},c.prototype.onMouseMove=function(){},c.prototype.onMouseZoom=function(){ujs.notify("hcs.engine3D.camera.zoom")},c.prototype.onGlobaleFloorReady=function(){var a=this.core.structure.members[this.core.structure.currentStructureIndex].elevation;this.camera[0].target.y=a+170,this.camera[1].height=a+170,this.camera[1].heightMin=a+20,this.camera[1].heightMax=a+240,this.avatarPosition.y=a+170},c.prototype.onCameraChanged=function(){this.cameraActiveId=(this.cameraActiveId+1)%2,this.scene.activeCamera=this.camera[this.cameraActiveId],hcsdesign.engine3D.camera=this.camera[this.cameraActiveId];var a=hcsdesign.engine3D.searchComponent("AvatarComponent3D");this.cameraActiveId?(this.camera[1].rotation.copyFromFloats(0,-this.camera[0].alpha-Math.PI/2,0),this.camera[1].position.copyFromFloats(a.avatar.position.x,this.camera[1].height,a.avatar.position.z),this.camera[1].attachControl(hcsdesign.engine3D.canvas),this.camera[0].detachControl(hcsdesign.engine3D.canvas),a&&a.setVisibility(!1)):(this.lookAt&&(this.lookAt.position.x=this.camera[1].position.x,this.lookAt.position.z=this.camera[1].position.z),this.camera[0].target.x=this.camera[1].position.x,this.camera[0].target.z=this.camera[1].position.z,this.camera[0].alpha=-this.camera[1].rotation.y-Math.PI/2,this.camera[0].attachControl(hcsdesign.engine3D.canvas),this.camera[1].detachControl(hcsdesign.engine3D.canvas),a&&a.setVisibility(!0)),ujs.notify("hcs.engine3d.cameraChanged",{activeCameraId:this.cameraActiveId,activeCamera:this.cameraActiveId?"fpsCamera":"orbitCamera"})},c.prototype.onFloorLevelChanged=function(b){a.camera[0].target.y=b.structure.elevation+170,a.camera[1].height=b.structure.elevation+170,a.camera[1].position.y=b.structure.elevation+170,a.camera[1].heightMax=b.structure.elevation+240,a.camera[1].heightMin=b.structure.elevation+20},c.prototype.onControleEnd=function(b){b.selected&&this.lookAt&&b.selected.pickedMesh.id==this.lookAt.id&&(a.camera[0].target.x=this.lookAt.position.x,a.camera[0].target.z=this.lookAt.position.z)},c.prototype.onControleMove=function(b){!b.selected&&this.lookAt&&(this.lookAt.position.x=a.camera[0].target.x,this.lookAt.position.z=a.camera[0].target.z)},c.prototype.onNewPlanReady=function(){this.structure=this.core.getSelectedStructure(),"undefined"!=typeof this.structure.elevation&&(a.camera[0].target.y=this.structure.elevation+170)},c.prototype.getLookAt=function(){return this.lookAt},c.prototype.bindLookAt=function(a){this.lookAt=a},c.prototype.getActiveCameraId=function(){return this.cameraActiveId},c}(),GridStructure=function(){var a=function(){BaseStructure.call(this,"GridStructure"),this.materials={}};return a.prototype=new BaseStructure,a.prototype.serialize=function(){return this.materials},a.prototype.deserialize=function(a){for(var b in a)this.materials[b]=a[b]},a}(),GridComponent2D=function(){var a=function(a){BaseComponent2D.call(this,a,"GridComponent2D"),this.priority=1,this.displayGrid=!0};return a.prototype=new BaseComponent2D,a.prototype.startListening=function(){this.core.engine2D.registerEventCb("GridComponent2D.static-draw",this.priority,"static-draw",null,null,this.onStaticDraw.bind(this),null),this.core.engine2D.registerEventCb("GridComponent2D.drag-start",this.priority,"drag-start",255-this.core.engine2D.MODE_CONTEXTMENU,null,this.onDragStart.bind(this),null),this.core.engine2D.registerEventCb("GridComponent2D.zoom-in",this.priority,"zoom-in",255-this.core.engine2D.MODE_CONTEXTMENU,null,this.onZoomIn.bind(this),null),this.core.engine2D.registerEventCb("GridComponent2D.zoom-out",this.priority,"zoom-out",255-this.core.engine2D.MODE_CONTEXTMENU,null,this.onZoomOut.bind(this),null)},a.prototype.stopListening=function(){this.core.engine2D.unregisterEventCb("GridComponent2D.static-draw"),this.core.engine2D.unregisterEventCb("GridComponent2D.drag-start"),this.core.engine2D.unregisterEventCb("GridComponent2D.zoom-in"),this.core.engine2D.unregisterEventCb("GridComponent2D.zoom-out")},a.prototype.enableScrolling=function(a){a&&!this.scrollingEnabled?(this.core.engine2D.registerEventCb("GridComponent2D.drag-start",this.priority,"drag-start",255-this.core.engine2D.MODE_CONTEXTMENU,null,this.onDragStart.bind(this),null),this.core.engine2D.registerEventCb("GridComponent2D.zoom-in",this.priority,"zoom-in",255-this.core.engine2D.MODE_CONTEXTMENU,null,this.onZoomIn.bind(this),null),this.core.engine2D.registerEventCb("GridComponent2D.zoom-out",this.priority,"zoom-out",255-this.core.engine2D.MODE_CONTEXTMENU,null,this.onZoomOut.bind(this),null),this.scrollingEnabled=!0):(this.scrollingEnabled=!1,this.core.engine2D.unregisterEventCb("GridComponent2D.drag-start"),this.core.engine2D.unregisterEventCb("GridComponent2D.zoom-in"),this.core.engine2D.unregisterEventCb("GridComponent2D.zoom-out"))},a.prototype.onStaticDraw=function(a,b,c){if(this.displayGrid){var d=this.core.getWidth(),e=this.core.getHeight(),f=50*c,g=Math.floor(b.x%f),h=Math.floor(b.y%f),i=0,j=0,k=this.core.configuration.boundingSize,l=this.core.getWidth()/2+(this.core.engine2D.getZoom()*Math.abs(k.min.x)-this.core.getWidth()/2),m=this.core.getHeight()/2+(this.core.engine2D.getZoom()*Math.abs(k.min.y)-this.core.getHeight()/2),n=this.core.getWidth()/2-(this.core.engine2D.getZoom()*Math.abs(k.max.x)-this.core.getWidth()/2),o=this.core.getHeight()/2-(this.core.engine2D.getZoom()*Math.abs(k.max.y)-this.core.getHeight()/2);g=b.x>=l?b.x-l:g,i=b.x>=l?g:0,h=b.y>=m?b.y-m:h,j=b.y>=m?h:0,d=b.x<n?d+b.x-n:d,e=b.y<o?e+b.y-o:e,a.strokeStyle="#aaa",a.lineWidth=1,a.beginPath();for(var p=h;e>p;p+=f)a.moveTo(i,Math.floor(p)+.5),a.lineTo(d,Math.floor(p)+.5);for(var q=g;d>q;q+=f)a.moveTo(Math.floor(q)+.5,j),a.lineTo(Math.floor(q)+.5,e);a.stroke(),a.strokeStyle="#f0f0f0",a.lineWidth=3,a.beginPath(),b.x>=l&&(a.moveTo(Math.floor(g)+.5,j),a.lineTo(Math.floor(g)+.5,e)),b.x<=n&&(a.moveTo(Math.floor(d)+.5,j),a.lineTo(Math.floor(d)+.5,e)),b.y>=m&&(a.moveTo(i,Math.floor(h)+.5),a.lineTo(d,Math.floor(h)+.5)),b.y<=o&&(a.moveTo(i,Math.floor(e)+.5),a.lineTo(d,Math.floor(e)+.5)),a.stroke(),a.fillStyle="#770000",a.fillRect(b.x-5,b.y-5,11,11);var r=100,s="1m";c>2.5&&(r=50,s="0.5m"),a.strokeStyle="#999",a.beginPath(),a.lineWidth=3,a.moveTo(20,e-30.5),a.lineTo(Math.floor(20+r*c),e-30.5),a.stroke(),a.lineWidth=2,a.moveTo(20,e-29),a.lineTo(20,e-35),a.moveTo(Math.floor(20+r*c),e-29),a.lineTo(Math.floor(20+r*c),e-35),a.stroke(),a.fillStyle="#999",a.font="10px Verdana",a.textAlign="center",a.fillText(s,r/2*c+20,e-15)}},a.prototype.onDragStart=function(){this.core.engine2D.registerEventCb("GridComponent2D.dragging",this.priority,"dragging",this.core.engine2D.MODE_DRAG,null,this.onDragging.bind(this),null),this.core.engine2D.registerEventCb("GridComponent2D.drag-end",this.priority,"drag-end",this.core.engine2D.MODE_DRAG,null,this.onDragEnd.bind(this),null)},a.prototype.onDragging=function(a,b,c){var d=this.core.engine2D.getTranslation();d=d.add(new BABYLON.Vector2(c.posDelta.x,c.posDelta.y)),this.core.engine2D.setTranslation(d)},a.prototype.onDragEnd=function(){this.core.engine2D.unregisterEventCb("GridComponent2D.dragging"),this.core.engine2D.unregisterEventCb("GridComponent2D.drag-end")},a.prototype.onZoomIn=function(a,b,c){var d=this.core.engine2D.getZoom();if(this.core.engine2D.setZoom(1.05*d),this.core.engine2D.getZoom()!=d){var e=this.core.engine2D.getTranslation(),f=c.pos.clone().subtractInPlace(e);f.scaleInPlace(.05),this.core.engine2D.setTranslation(e.subtractInPlace(f))}},a.prototype.onZoomOut=function(a,b,c){var d=this.core.engine2D.getZoom();if(this.core.engine2D.setZoom(.95*d),d-this.core.engine2D.getZoom(),this.core.engine2D.getZoom()!=d){var e=this.core.engine2D.getTranslation(),f=c.pos.clone().subtractInPlace(e);f.scaleInPlace(.05),this.core.engine2D.setTranslation(e.add(f))}},a}(),GridBackgroundComponent2D=function(){var a=function(a){BaseComponent2D.call(this,a,"GridBackgroundComponent2D"),this.priority=1e3,this.background=!1,this.visibility=!0,this.scale=1,this.translation=new BABYLON.Vector3(0,0,0)};return a.prototype=new BaseComponent2D,a.prototype.startListening=function(){this.onBackgroundChange=this.onBackgroundChange.bind(this),this.onAddBackground=this.onAddBackground.bind(this),this.onEndBackground=this.onEndBackground.bind(this),document.addEventListener("hcs.engine2d.backgroundChange",this.onBackgroundChange),document.addEventListener("hcs.engine2d.onAddBackground",this.onAddBackground),document.addEventListener("hcs.engine2d.onEndBackground",this.onEndBackground),this.core.engine2D.registerEventCb("GridBackgroundComponent2D.static-draw",this.priority,"static-draw",null,null,this.onStaticDraw.bind(this),null)},a.prototype.stopListening=function(){document.removeEventListener("hcs.engine2d.backgroundChange",this.onBackgroundChange),document.removeEventListener("hcs.engine2d.onAddBackground",this.onAddBackground),document.removeEventListener("hcs.engine2d.onEndBackground",this.onEndBackground),this.core.engine2D.unregisterEventCb("GridBackgroundComponent2D.static-draw")},a.prototype.initialize=function(){var a={id:"gridBackgroundMenu",title:_("添加背景"),action:"hcs.engine2d.onAddBackground",cancelAction:"hcs.engine2d.onEndBackground"};ujs.notify("hcs.menu.main.add",{item:a,menuPath:"draw2D",position:0})},a.prototype.onStaticDraw=function(a,b,c){if(this.background&&this.visibility===!0){var d=this.background;a.save(),a.globalAlpha=.4,a.translate(b.x-this.background.realWidth*c*this.scale/2+this.translation.x*c,b.y-this.background.realHeight*c*this.scale/2+this.translation.y*c),a.scale(c*this.scale,c*this.scale),a.drawImage(d,0,0),a.restore}},a.prototype.onBackgroundChange=function(a){this.visibility=a.visibility,this.scale=a.scale,this.background=a.img,this.core.engine2D.requestStaticDraw(),this.translation=a.translation||new BABYLON.Vector3(0,0,0),this.core.engine2D.requestStaticDraw(),this.core.structure.params.gridBackground={scale:a.measure,translation:this.translation.asArray(),points:[a.points[0].asArray(),a.points[1].asArray()]},ujs.notify("hcs.request.saveHistory",{})},a.prototype.onEndBackground=function(){hcs.UI.BackgroundPopup.close(void 0,void 0,!0)},a.prototype.onAddBackground=function(){hcs.UI.BackgroundPopup.show()},a}(),GridComponent3D=function(){var a,b=function(b){BaseComponent3D.call(this,b,"GridComponent3D"),this.structure=new GridStructure,a=this,this.setupLights(),this.createGround(),this.createSky(),this.lights=[],document.addEventListener("hcs.core.structure.loaded",this.onStructureLoaded.bind(this),!1)};return b.prototype=new BaseComponent3D,b.prototype.initialize=function(){},b.prototype.onStructureLoaded=function(){var a={},b={};this.core.structure.params.grid&&(a=this.core.structure.params.grid,this.createGround(a)),this.core.structure.params.sky&&(b=this.core.structure.params.sky,this.createSky(b))},b.prototype.startListening=function(){document.addEventListener("hcs.engine3D.changeGround",this.onChangeGround,!1),document.addEventListener("hcs.engine3D.changeSky",this.onChangeSky,!1)},b.prototype.stopListening=function(){document.removeEventListener("hcs.engine3D.changeGround",this.onChangeGround,!1),document.removeEventListener("hcs.engine3D.changeSky",this.onChangeSky,!1)},b.prototype.createGround=function(b){var b=b||{},c=(b.name||"ground",b.url||hcs.Assets.globalPath+"js/Components/GridComponent/Images/grid2.jpg"),d=function(b){var c=hcsdesign.engine3D.scene.getMeshByName("ground");if(!c){var d=a.core.configuration.boundingSize.getSize();c=BABYLON.Mesh.CreateBloc("ground",d.x,1,d.z,hcsdesign.engine3D.scene),c.position.copyFromFloats(0,-1,0),(window.ejecta||GlobalHelper.isMobileDevice())&&(c.position.y=-10),c.isDecorable=!1,c.receiveShadows=!0}hcs.MaterialFactory.RepeatTextureXY(b,16,16),c.material=new BABYLON.StandardMaterial("ground",hcsdesign.engine3D.scene),c.material.diffuseTexture=b,c.material.ambientColor=new BABYLON.Color3(.9,.9,.9),c.material.diffuseColor=new BABYLON.Color3(1,1,1),c.material.specularColor=new BABYLON.Color3(.01,.01,.01),hcsdesign.engine3D.scene.lights.point.excludedMeshes.push(c)};d(new BABYLON.Texture(c,hcsdesign.engine3D.scene))},b.prototype.createSky=function(b){var b=b||{},c=b.url||hcs.Assets.globalPath+"js/Components/GridComponent/Images/background2.jpg",d=function(b){var c=a.scene.getMeshByName("skysphere");c||(c=BABYLON.Mesh.CreateSphere("skysphere",16,3e4,hcsdesign.engine3D.scene),c.scaling.x*=-1,c.isDecorable=!1),c.material=new BABYLON.StandardMaterial("skysphere",hcsdesign.engine3D.scene),c.material.ambientTexture=b,hcs.MaterialFactory.MakeBasicMaterial(c.material),c.material.ambientColor.copyFromFloats(1,1,1)};d(new BABYLON.Texture(c,hcsdesign.engine3D.scene))},b.prototype.setupLights=function(){hcsdesign.engine3D.scene.lights=[];var a=new BABYLON.DirectionalLight("Dir0",new BABYLON.Vector3(-1,-2,-1),hcsdesign.engine3D.scene);a.specular=new BABYLON.Color3(.15,.15,.15),a.diffuse=new BABYLON.Color3(.55,.55,.55),a.intensity=1,a.position=new BABYLON.Vector3(1e3,2e3,1e3);var b=new BABYLON.PointLight("Point0",hcsdesign.engine3D.camera.position,hcsdesign.engine3D.scene);b.diffuse=new BABYLON.Color3(.65,.65,.65),b.specular=new BABYLON.Color3(1,1,1),b.intensity=.45,hcsdesign.engine3D.scene.lights.point=b,hcsdesign.engine3D.shadowGenerator=new BABYLON.ShadowGenerator(2048,a),hcsdesign.configuration.useShadow?(hcsdesign.engine3D.shadowGenerator.useVarianceShadowMap=!1,hcsdesign.engine3D.shadowGenerator.usePoissonSampling=!0,hcsdesign.engine3D.shadowGenerator.setDarkness(.8),hcsdesign.engine3D.shadowGenerator.setTransparencyShadow(!0)):hcsdesign.engine3D.shadowGenerator.dispose()},b.prototype.reloadConfiguration=function(){},b.prototype.onChangeGround=function(b){a.createGround({name:b.name,url:b.url}),a.core.structure.params.grid={name:b.name,url:b.url},ujs.notify("hcs.request.saveHistory")},b.prototype.onChangeSky=function(b){a.createSky({name:b.name,url:b.url}),a.core.structure.params.sky={name:b.name,url:b.url},ujs.notify("hcs.request.saveHistory")},b}(),HistoryEditionComponent=function(){var a=function(a){BaseComponent3D.call(this,a,"HistoryEditionComponent"),this.historyComponent3D=null,this.isMainMenuItem=!1,this._items=[{title:_("Undo"),icon:"fa fa-reply",action:"hcs.request.undo",index:10},{title:_("Redo"),icon:"fa fa-share",action:"hcs.request.redo",index:11}],this.undo=this.undo.bind(this),this.redo=this.redo.bind(this)};return a.prototype=Object.create(BaseComponent3D.prototype),a.prototype.initialize=function(){BaseComponent3D.prototype.initialize.call(this),this.historyComponent3D=hcsdesign.getComponentByName("HistoryComponent");for(var a=0,b=this._items.length;b>a;a++)ujs.notify("hcs.menu.top.sub.add",{item:this._items[a],menuPath:"."});document.addEventListener("hcs.request.undo",this.undo,!1),document.addEventListener("hcs.request.redo",this.redo,!1)},a.prototype.destroy=function(){console.log("destroy");for(var a=0,b=this._items.length;b>a;a++)ujs.notify("hcs.menu.top.sub.delete",{id:this._items[a].id,menuPath:"."});document.removeEventListener("hcs.request.undo",this.undo),document.removeEventListener("hcs.request.redo",this.redo)},a.prototype.undo=function(){hcsdesign.getSelectedEngine()==hcsdesign.ENGINE_2D?hcsdesign.backFromHistory():this.historyComponent3D.controlZ()},a.prototype.redo=function(){hcsdesign.getSelectedEngine()==hcsdesign.ENGINE_2D?hcsdesign.nextFromHistory():this.historyComponent3D.controlY()},a}(),HistoryComponent=function(){var a,b=function(b){BaseComponent3D.call(this,b,"HistoryComponent"),a=this,this.componentList=[],this.history=[],this.currentHistoryIndex=-1,this.currentBalance=0,this.maxHistoryLength=50,this.callbackMap=[]};b.prototype=new BaseComponent3D,b.prototype.startListening=function(){document.addEventListener("hcs.keyboardManager.keyDown",this.onKeyDown,!0),document.addEventListener("hcs.request.historyAction",this.onRotatorAction,!0)},b.prototype.stopListening=function(){document.removeEventListener("hcs.keyboardManager.keyDown",this.onKeyDown,!0),document.removeEventListener("hcs.request.historyAction",this.onRotatorAction,!0)},b.prototype.onContextChanged=function(a){"3D"==a?this.startListening():(this.stopListening(),this.reset())};var c=function(){this.target=null,this.params=null,this.type=0,this.componentInstance=null};return c.prototype.set=function(a,b,c,d){this.target=a,this.params=b,this.type=c,this.componentInstance=d},b.prototype.reset=function(){this.history.length=0,this.currentHistoryIndex=-1,this.currentBalance=0},b.prototype.register=function(a){this.componentList.push(a),this.callbackMap.push([])},b.prototype.registerAction=function(a,b,c,d){-1==this.componentList.indexOf(d)&&this.register(d);
var e={};this.callbackMap[this.componentList.indexOf(d)][a]=e,e.undo=b,e.redo=c},b.prototype.actionDone=function(a,b,d,e){this.currentHistoryIndex=(this.currentHistoryIndex+1)%this.maxHistoryLength,this.currentBalance=0,this.history[this.currentHistoryIndex]||(this.history[this.currentHistoryIndex]=new c),this.history[this.currentHistoryIndex].set(a,b,d,e)},b.prototype.redo=function(a){var b=this.callbackMap[this.componentList.indexOf(a.componentInstance)][a.type].redo;b(a.target,a.params)},b.prototype.undo=function(a){var b=this.callbackMap[this.componentList.indexOf(a.componentInstance)][a.type].undo;b(a.target,a.params)},b.prototype.controlZ=function(){-1!=this.currentHistoryIndex&&null!=this.history[this.currentHistoryIndex]&&(-this.currentBalance>=this.maxHistoryLength||(this.undo(this.history[this.currentHistoryIndex]),this.currentHistoryIndex=(this.currentHistoryIndex+this.maxHistoryLength-1)%this.maxHistoryLength,this.currentBalance--))},b.prototype.controlY=function(){-1!=this.currentHistoryIndex&&(this.currentBalance>=0||(this.currentHistoryIndex=(this.currentHistoryIndex+1)%this.maxHistoryLength,this.redo(this.history[this.currentHistoryIndex]),this.currentBalance++))},b.prototype.onKeyDown=function(b){var c=a.core.engine3D.keyboardManager.isPressed([17,91,224]);c&&90==b.keyCode?a.controlZ():c&&89==b.keyCode&&a.controlY()},b.prototype.onRotatorAction=function(a){a.component.addHistory&&a.component.addHistory(a.object,a.params,a.action)},b}(),PrintComponent2D=function(){var a,b=function(b){BaseTopMenuComponent2D.call(this,b,"PrintComponent2D"),this.isMainMenuItem=!1,this._item={title:_("Print"),icon:"fa fa-print",action:"hcs.request.print",id:"print-icon-component",index:20},a=this};return b.prototype=Object.create(BaseTopMenuComponent2D.prototype),b.prototype.startListening=function(){document.addEventListener("hcs.request.print",this.onPrint,!1)},b.prototype.stopListening=function(){document.removeEventListener("hcs.request.print",this.onPrint,!1)},b.prototype.onPrint=function(){var b=842,c=596,d=document.createElement("canvas");d.width=b,d.height=c,d.style.width=b+"px",d.style.height=c+"px";var e=d.getContext("2d"),f=a.core.engine2D.getBestZoomAttributes(b,c),g=a.core.getComponentByName("WallComponent2D"),h=a.core.getComponentByName("RoomComponent2D"),i=a.core.getComponentByName("OvertureComponent2D"),j=a.core.getComponentByName("StairwayComponent2D"),k=a.core.getComponentByName("HopperComponent2D");h.onStaticDraw(e,f.translation,f.zoom,null),g.onStaticDraw(e,f.translation,f.zoom,null),i.onStaticDraw(e,f.translation,f.zoom,null),j.onStaticDraw(e,f.translation,f.zoom,null),k.onStaticDraw(e,f.translation,f.zoom,null);var l=a.core.getOrigin(),m=new Image,n=a.core.api.logoUrl||l+"/logo.png";m.src="php/retrieveImage.php?image="+n;var o=a.core.structure.name,p=e.measureText(o);e.fillText(o,55+p.width/2,20),m.onload=function(){e.drawImage(m,0,0,48,48)},setTimeout(function(){var a,e=d.toDataURL("image/png");try{a=window.open("","_blank","width="+b+",height="+c),a.document.write("<img src='"+e+"' />"),a.document.close(),a.focus(),a.print(),a.close()}catch(f){parent.postMessage({type:"printPopup",img:e,w:b,h:c,message:_("you must enable popup for this site")},l)}},1e3)},b}(),PrintComponent3D=function(){var a=function(a){BaseComponent3D.call(this,a,"PrintComponent3D")};return a.prototype=Object.create(BaseComponent3D.prototype),a.prototype.startListening=function(){document.addEventListener("hcs.request.print",this.onPrint,!1)},a.prototype.stopListening=function(){document.removeEventListener("hcs.request.print",this.onPrint,!1)},a.prototype.onPrint=function(){var a=842,b=596,c=hcsdesign.getOrigin();GlobalHelper.createScreenshot3D(hcsdesign.engine3D.engine,void 0,function(d){var e=d.toDataURL("image/png"),f=setTimeout(function(){clearTimeout(f);var d;try{d=window.open("","_blank","width="+a+",height="+b),d.document.write("<img src='"+e+"' />"),d.document.close(),d.focus(),d.print(),d.close()}catch(g){parent.postMessage({type:"printPopup",img:e,w:a,h:b,message:_("you must enable popup for this site")},c)}},1e3)})},a}(),PerformanceComponent3D=function(){var a,b=10,c=1e4,d=5e3,e="wanadev.planner.performanceCheck",f=[],g=[],h=function(b){BaseComponent3D.call(this,b,"PerformanceComponent3D"),this.waiter=document.getElementById("waiter"),this.waiter.innerHTML=_("正在计算中..."),this.waitSince=!1,this.stats=this.core.engine3D.stats,this.priority=0,this.hasBeenAlreadyNotified=hcsLocalStorage.getItem(e),this.targetMaxLowFPSTime=c,this.hasFocus=!0,document.addEventListener("hcs.engine2D.contextMenuPerformance.close",this.onContextMenuPerformanceClose,!1),document.addEventListener("hcs.request.changePerformancesProperty",this.onContextMenuPropertyChanged,!1),document.addEventListener("hcs.request.changePerformances",this.onChangePerformance,!1),document.addEventListener("hcs.request.changeEngine",this.onChangeEngine,!1),a=this;var h=null,i=function(b){null!==h&&(clearTimeout(h),h=null),"focus"===b.type?h=setTimeout(function(){clearTimeout(h),h=null,a.hasFocus=!0},d):a.hasFocus=!1};f=[{content:[{type:"html",html:"<div class='warning'>"+_("Disable some of these functionnalities")+"<br />"+_("to get better performances in 3D mode.")+"</div>"},{type:"checkbox",label:_("Antialiasing"),value:a.configuration.useAntialiasing,eventParams:{cast:"bool",property:"useAntialiasing",eventName:"hcs.request.changePerformancesProperty"}},{type:"checkbox",label:_("Shadows"),value:a.configuration.useShadow,eventParams:{cast:"bool",property:"useShadow",eventName:"hcs.request.changePerformancesProperty"}},{type:"checkbox",label:_("Enable detailled textures"),value:a.configuration.useMultiTexturing,eventParams:{cast:"bool",property:"useMultiTexturing",eventName:"hcs.request.changePerformancesProperty"}}]}],g=[{label:_("Apply and reload"),action:"hcs.engine2D.contextMenuPerformance.close"}],window.addEventListener("focus",i,!1),window.addEventListener("blur",i,!1)};return h.prototype=Object.create(BaseComponent3D.prototype),h.prototype.initialize=function(){var a={title:_("Increase performances"),action:"hcs.request.changePerformances",index:1};ujs.notify("hcs.menu.top.add",{item:a,menuPath:"toolbarOption"})},h.prototype.addItem=function(a){f[0].content.push(a)},h.prototype.removeItem=function(a){var b="number"==typeof item?a:f[0].content.indexOf(a);return b>-1&&f[0].content.splice(b,1),b>-1},h.prototype.onChangePerformance=function(){ujs.notify("hcs.menu.top.deselect");var a={id:"performancesWindow",title:_("Settings"),x:hcsdesign.getWidth()/2-100,y:100};hcs.UI.ContextMenu.show(a,f,g)},h.prototype.onContextMenuPerformanceClose=function(){ujs.notify("hcs.engine2D.contextMenu.close"),ujs.notify("hcs.engine3D.refreshGL")},h.prototype.onContextMenuPropertyChanged=function(b){var c=b.property,d=b.value;a.core.configuration.hasOwnProperty(c)&&(a.core.configuration[c]=d,a.core.configuration.saveConfiguration())},h.prototype.onChangeEngine=function(){a.waiter.classList.remove("hidden"),a.core.getSelectedEngine()==a.core.ENGINE_2D&&setTimeout(function(){a.waiter.classList.add("hidden")},1e3)},h.prototype.onContextChanged=function(a){"2D"===a&&this.waiter.classList.add("hidden")},h.prototype.update=function(){this.checkPerf()},h.prototype.checkPerf=function(){if(this.hasFocus){var a=BABYLON.Tools.GetFps();if(b>a){var d=(new Date).getTime();if(this.waitSince===!1)this.waitSince=d;else if(d-this.waitSince>c&&!this.hasBeenAlreadyNotified){var f=hcsdesign.engine2D.searchComponent("PedagoComponent");this.hasBeenAlreadyNotified=!0,hcsLocalStorage.setItem(e,!0),hcs.UI.IFrame.show(document.body,{width:720,height:240,src:f.getPageURL("graphics")})}this.waiter.classList.remove("hidden")}else this.waitSince=!1,this.waiter.classList.add("hidden")}},h}(),HardwareScalingComponent3D=function(){var a=function(a){BaseComponent3D.call(this,a,"HardwareScalingComponent3D"),this.hardwareScalingLevel=1,this.hardwareScaling=1,this._e3d=hcsdesign.engine3D,this._camComponent=null,this._edtComponent=null,this._perfComponent=null,this._performanceItem={},this._initialized=!1};return a.prototype=Object.create(BaseComponent3D.prototype),a.prototype.initialize=function(){this._initialized||(this._onResize=this._onResize.bind(this),this.hardwareScalingLevel=hcsdesign.configuration.hardwareScalingLevel||1,this.hardwareScaling=1/this.hardwareScalingLevel,this._camComponent=this._e3d.searchComponent("CameraComponent"),this._edtComponent=this._e3d.searchComponent("EditionComponent3D"),this._perfComponent=this._e3d.searchComponent("PerformanceComponent3D"),this.hardwareScalingLevel>1&&(window.addEventListener("resize",this._onResize,!1),this.setHardwareScalingLevel(this.hardwareScalingLevel)),this._perfComponent&&(this._performanceItem={type:"select",label:_("Quality"),namesValues:[{text:_("Low"),value:2},{text:_("Simple"),value:1.5},{text:_("Good"),value:1}],selectedKey:hcsdesign.configuration.hardwareScalingLevel,eventParams:{cast:"float",property:"hardwareScalingLevel",eventName:"hcs.request.changePerformancesProperty"}},this._perfComponent.addItem(this._performanceItem)),this._initialized=!0)},a.prototype.destroy=function(){this.setHardwareScalingLevel(1),hcsdesign.configuration.hardwareScalingLevel=1,hcsdesign.configuration.saveConfiguration(),this._perfComponent&&this._perfComponent.removeItem(this._performanceItem),this._camComponent&&this._camComponent.disableAllPostProcess(),this._edtComponent&&(this._edtComponent.dragControl.hardwareScaling=1),window.removeEventListener("resize",this._onResize)},a.prototype.setHardwareScalingLevel=function(a){this.hardwareScaling=1/a,this.hardwareScalingLevel=a,this._e3d.engine.setHardwareScalingLevel(a),this._e3d.hardwareScaling=this.hardwareScaling,this._e3d.canvas.width=hcsdesign.getWidth()*this.hardwareScaling,this._e3d.canvas.height=hcsdesign.getHeight()*this.hardwareScaling,this.hardwareScalingLevel>2&&this._camComponent&&this._camComponent.toggleFSAA(),this._edtComponent&&this._edtComponent.dragControl.setHardwareScaling(this.hardwareScaling)},a.prototype._onResize=function(){this.hardwareScalingLevel>1&&this.setHardwareScalingLevel(this.hardwareScalingLevel)},a}(),RemoteControlComponent3D=function(){var a,b,c,d=!1,e=!1,f=function(b){BaseComponent3D.call(this,b,"RemoteControlComponent3D"),a=this};return f.prototype=new BaseComponent3D,f.prototype.initialize=function(){this.createHTML(),document.addEventListener("mouseup",this.onMouseUp,!1),document.addEventListener("mousemove",this.onMouseMove,!1),window.addEventListener("mousewheel",this.onZoomUpdated,!1),document.addEventListener("touchend",this.onMouseUp,!1),document.addEventListener("touchcancel",this.onMouseUp,!1),document.addEventListener("touchmove",this.onMouseMove,!1),document.addEventListener("hcs.request.zoomUpdated",this.onZoomUpdated,!1),document.addEventListener("hcs.contextChanged",this.onZoomUpdated,!1),document.addEventListener("hcs.engine3d.cameraChanged",this.onCameraHasChanged.bind(this),!1),document.addEventListener("hcs.request.changeEngine",this.onCameraHasChanged.bind(this),!1)},f.prototype.listenJoystickEvents=function(){this.joystick.addEventListener("mousedown",this.onJoystickMouseDown,!1),this.joystick.addEventListener("touchstart",this.onJoystickMouseDown,!1)},f.prototype.listenCursorEvents=function(){this.cursor.addEventListener("mousedown",this.onCursorMouseDown,!1),this.cursor.addEventListener("touchstart",this.onCursorMouseDown,!1)},f.prototype.onZoomUpdated=function(){var b=c.height;if(hcsdesign.getSelectedEngine()==hcsdesign.ENGINE_2D){var d=hcsdesign.engine2D.getZoom(),e=b*(1-d);e=0>e?0:e}else{var f=hcsdesign.engine3D.camera;if("Camera"==f.name)var g=f.radius,e=b*(g-f.lowerRadiusLimit)/(f.upperRadiusLimit-f.lowerRadiusLimit);else var e=b*(f.heightMax-f.height)/(f.heightMax-f.heightMin)}a.cursor.style.marginTop=e+"px"},f.prototype.onMouseMove=function(b){if(d){var e=b.pageY||b.clientY;b.touches&&(b.preventDefault(),e=b.touches[0].pageY);var f=e-c.top,g=0;if(f>0&&f<c.height?g=f:f>0&&f>c.height?g=c.height:0>f&&(g=0),hcsdesign.getSelectedEngine()==hcsdesign.ENGINE_2D){var h=(c.height-g)/c.height;hcsdesign.engine2D.getZoom(),hcsdesign.engine2D.setZoom(h)}else{var h=g/c.height,i=hcsdesign.engine3D.camera;"Camera"==i.name?i.radius=i.lowerRadiusLimit+(i.upperRadiusLimit-i.lowerRadiusLimit)*h:(i.height=i.heightMax+(i.heightMin-i.heightMax)*h,i.position.y=i.height),a.cursor.style.marginTop=g+"px",ujs.notify("hcs.engine3D.camera.zoom")}}},f.prototype.onJoystickMouseDown=function(c){e=!0,c.touches&&c.preventDefault();var d=a.joystick.getBoundingClientRect(),f={x:(c.touches?c.touches[0].pageX:c.pageX||c.clientX)-d.left,y:(c.touches?c.touches[0].pageY:c.pageY||c.clientY)-d.top},g=Math.floor(f.x/d.width*3),h=Math.floor(f.y/d.height*3);1==g&&1==h&&ujs.notify("hcs.request.cameraChanged"),b=setInterval(function(){a.setTranslation(g,h)},1)},f.prototype.setTranslation=function(a,b){if(hcsdesign.getSelectedEngine()==hcsdesign.ENGINE_2D){var c=10,d=hcsdesign.engine2D.getTranslation();1>a&&(d.x-=c),a>1&&(d.x+=c),1>b&&(d.y-=c),b>1&&(d.y+=c),hcsdesign.engine2D.setTranslation(d)}else{var e=hcsdesign.engine3D.camera;if("Camera"==e.name){var c=Math.PI/300;1>a&&(e.alpha-=c),a>1&&(e.alpha+=c),1>b&&(e.beta-=c),b>1&&(e.beta+=c)}else{var c=e._computeLocalCameraSpeed();e._localDirection||(e._localDirection=BABYLON.Vector3.Zero(),e._transformedDirection=BABYLON.Vector3.Zero()),e._localRotation||(e._localRotation=BABYLON.Vector3.Zero(),e._transformedRotation=BABYLON.Vector3.Zero()),1>a?e._localRotation.copyFromFloats(0,-c/15,0):1>b?e._localDirection.copyFromFloats(0,0,50*c):a>1?e._localRotation.copyFromFloats(0,c/15,0):b>1&&e._localDirection.copyFromFloats(0,0,50*-c),e.getViewMatrix().invertToRef(e._cameraTransformMatrix),1>b||b>1?(BABYLON.Vector3.TransformNormalToRef(e._localDirection,e._cameraTransformMatrix,e._transformedDirection),e.position.addInPlace(e._transformedDirection)):(BABYLON.Vector3.TransformNormalToRef(e._localRotation,e._cameraTransformMatrix,e._transformedRotation),e.rotation.y+=e._transformedRotation.y),e.position.y=e.height}}},f.prototype.onCursorMouseDown=function(){d=!0},f.prototype.onMouseUp=function(){d=!1,e&&(clearInterval(b),e=!1)},f.prototype.createHTML=function(){var b=document.createElement("div");b.setAttribute("id","remoteController"),b.style.width="50px",b.style.height="210px",b.style.position="relative",b.style.backgroundImage="url('"+hcs.Assets.globalPath+hcs.Assets.remote.bg+"')",this.cursorContainer=document.createElement("div"),this.cursorContainer.setAttribute("style","width:20px;height:150px;position:absolute;top:57px;left:15px;"),this.cursor=document.createElement("div"),this.cursor.setAttribute("style","width:20px;height:7px;background:"+hcs.Assets.mainUIColor+";border-radius:2px;cursor:pointer;border:1px solid "+("#897364"==hcs.Assets.mainUIColor?"#897364":"#333")+";margin-top:50px;"),this.listenCursorEvents(),this.cursorContainer.appendChild(this.cursor),b.appendChild(this.cursorContainer),this.cameraButton=document.createElement("div"),this.cameraButton.id="camera-swap-btn",this.cameraButton.style.width="18px",this.cameraButton.style.height="18px",this.cameraButton.style.position="absolute",this.cameraButton.style.backgroundSize="cover",this.cameraButton.style.top="16px",this.cameraButton.style.left="16px",this.cameraButton.style.borderRadius="7px",b.appendChild(this.cameraButton),a._setCameraIcon(!1),this.joystick=document.createElement("div"),this.joystick.setAttribute("style","width:50px;height:50px;cursor:pointer;position:absolute;"),this.listenJoystickEvents(),b.appendChild(this.joystick);var d=document.getElementById("remote-controller");d||(d=document.createElement("div"),d.style.position="absolute",d.style.top="50px",d.style.left="10px",d.style.height="300px",d.style.width="50px",document.getElementById("modalWidgets").appendChild(d)),d.appendChild(b),c=this.cursorContainer.getBoundingClientRect()},f.prototype.destroy=function(){window.removeEventListener("mousewheel",this.onZoomUpdated),document.removeEventListener("mouseup",this.onMouseUp),document.removeEventListener("mousemove",this.onMouseMove),document.removeEventListener("touchend",this.onMouseUp),document.removeEventListener("touchcancel",this.onMouseUp),document.removeEventListener("touchmove",this.onMouseMove),document.removeEventListener("hcs.request.zoomUpdated",this.onZoomUpdated),document.removeEventListener("hcs.contextChanged",this.onZoomUpdated);var a=document.getElementById("remoteController");if(a){var b=a.parentNode;b.removeChild(a),b.parentNode.removeChild(b)}},f.prototype.onCameraHasChanged=function(a){this._setCameraIcon(a.engine&&"2D"==a.engine?!1:a.activeCamera)},f.prototype._setCameraIcon=function(a){this.cameraButton.style.display=a===!1?"none":"block";var b;switch(a){case"fpsCamera":b=hcs.Assets.remote.cam;break;case"orbitCamera":default:b=hcs.Assets.remote.man}this.cameraButton.style.backgroundImage="url('"+hcs.Assets.globalPath+b+"')"},f}(),MeasureStructure=function(){var a=function(a,b,c){BaseStructure.call(this,"MeasureStructure"),this.points=a||[],this.parent=b,this.offsetVector=c};return a.prototype=new BaseStructure,a.prototype.center=function(){return BABYLON.Vector2.Lerp(this.points[0],this.points[1],.5)},a.prototype.normal=function(){return this.offsetVector.clone().normalize()},a.prototype.tryMerge=function(a){var b=function(a,b,c){var d,e=Math.PI/80,f=3,g=b.subtract(a),h=c.subtract(b);return g.length()<f||h.length()<f?!1:(d=Math.abs(g.determinant(h)),e>d)},c=1,d=function(){var b=this.points.length-1,d=a.points.length-1;if(this.points[b].distanceTo(a.points[0])<c)a.points.shift(),this.points.pop(),this.points=this.points.concat(a.points);else if(this.points[0].distanceTo(a.points[0])<c)a.points.reverse(),a.points.pop(),this.points.shift(),this.points=a.points.concat(this.points);else if(this.points[b].distanceTo(a.points[d])<c)a.points.reverse(),a.points.shift(),this.points.pop(),this.points=this.points.concat(a.points);else{if(!(this.points[0].distanceTo(a.points[d])<c))return!1;a.points.pop(),this.points.shift(),this.points=a.points.concat(this.points)}return!0}.bind(this);return b(this.points[0],this.points[this.points.length-1],a.points[0])&&b(this.points[0],this.points[this.points.length-1],a.points[a.points.length-1])&&this.parent.height===a.parent.height?d():!1},a.prototype.mergeMeasures=function(a){for(var b,c=a.length,d=a.length-1;d>=0;d--){b=a[d];for(var e=0;c>e;e++)e!==d&&b.tryMerge(a[e])&&(a.splice(e,1),c--,d--,e=0)}},a}(),MeasureComponent=function(){var a=[],b=[],c=function(a){BaseComponent2D.call(this,a,"MeasureComponent")};return c.prototype=new BaseComponent2D,c.prototype.getTargeted=function(c){for(var d,e,f=a.concat(b),g=15,h=g,i=null,j=0;j<f.length;j++)for(var k=0;k<f[j].length;k++)e=f[j][k],d=c.distanceTo(e.center().add(e.offsetVector.scale(e.parent.measureDist))),h>d&&(h=d,i=e);return i},c.prototype.getInternalMeasures=function(){return a},c.prototype.getExternalMeasures=function(){return b},c.prototype.getAllMeasures=function(){return measures},c.prototype.buildFromRooms=function(c,d){c=c,d=d,a.length=0,b.length=0;for(var e=0,f=c.length;f>e;e++)c[e].panes?a.push(c[e].panes):(c.splice(e,1),e--);for(var e=0,f=d.length;f>e;e++)d[e].panes?b.push(d[e].panes):(d.splice(e,1),e--)},c.prototype.mergeMeasures=function(a){for(var b,c=a.length,d=a.length-1;d>=0;d--){b=a[d];for(var e=0;c>e;e++)e!==d&&b.tryMerge(a[e])&&(a.splice(e,1),c--,d--,e=0)}},c.prototype.drawTmpWallMesure=function(a,b,c){var d=hcsdesign.getComponentByName("WallComponent2D")._tmpWall;if(d){var e=new BABYLON.Vector2(d.points[1].position.y-d.points[0].position.y,d.points[0].position.x-d.points[1].position.x).normalize().scaleInPlace(40);this._drawMeasureSlice(a,b,c,d.points[0].position.add(e),d.points[1].position.add(e))}},c.prototype.draw=function(c,d,e){for(var f,g,h=hcsdesign.getComponentByName("OvertureComponent2D")&&hcsdesign.getComponentByName("OvertureComponent2D").overtureDragged,i=new BABYLON.Vector2,j=[],k=a.concat(b),l=0,m=k.length;m>l;l++){j.push([]);for(var n=0,o=k[l].length;o>n;n++)k[l][n].parent.measureDisplayed&&(f=[],i.copyFrom(k[l][n].offsetVector).normalize().scaleInPlace(k[l][n].parent.measureDist),f.push(k[l][n].points[0].clone(),k[l][n].points[1].clone()),h&&this._addOvertureIntersections(k[l][n].parent,f),g=new MeasureStructure(f,k[l][n].parent,i.clone()),j[l].push(g));this.mergeMeasures(j[l])}for(var l=0,m=j.length;m>l;l++)for(var n=0,o=j[l].length;o>n;n++)for(var p=0,q=j[l][n].points.length-1;q>p;p++)this._drawMeasureSlice(c,d,e,j[l][n].points[p].add(j[l][n].offsetVector),j[l][n].points[p+1].add(j[l][n].offsetVector))},c.prototype._drawMeasureSlice=function(a,b,c,d,e){var f=hcsdesign.engine2D.toRealCoord(d,b,c),g=hcsdesign.engine2D.toRealCoord(e,b,c),h=d.distanceTo(e),i=Math.round(h)/100;return hcsdesign.engine2D.symbols2D.drawMeasure(a,f,g,i+"m"),i},c.prototype._addOvertureIntersections=function(a,b){for(var c=function(a,c){return a.distanceToSquared(b[0])-c.distanceToSquared(b[0])},d=0,e=a.overtures.length;e>d;d++)for(var f=a.overtures[d].getPolygon(),g=0,h=f.length;h>g;g++)f[g].isOnSegment(b[0],b[b.length-1])&&ujs.insertSorted(f[g],c,b)},c}(),DebugComponent2D=function(a){BaseComponent2D.call(this,a,"DebugComponent2D")};DebugComponent2D.prototype=Object.create(BaseComponent2D.prototype),DebugComponent2D.prototype.dumpStructureToFile=function(){var a=hcsdesign.structure.serialize(),b=new Blob([a],{type:"text/plain;charset=utf-8"});saveAs(b,"structure.json")},DebugComponent2D.prototype.wallState=function(){Logger.message("ETAT DES MURS :");var a=this.structure.getCurrentStructure(),b=a.getElements("walls"),c=a.getElements("points");for(var d in b){Logger.message("Mur "+d+" :"),Logger.message("	"+b[d].points[0].position.x+","+b[d].points[0].position.y+" ->"+b[d].points[1].position.x+","+b[d].points[1].position.y),Logger.message("	Points rattach��s : ");for(var e in b[d].attachedPoints)Logger.message("		Point "+c.indexOf(b[d].attachedPoints[e])+" : "+b[d].attachedPoints[e].position.x+","+b[d].attachedPoints[e].position.y)}},DebugComponent2D.prototype.pointState=function(){Logger.message("ETAT DES POINTS :");var a=this.structure.getCurrentStructure(),b=a.getElements("points"),c=a.getElements("walls");for(var d in b)Logger.message("Point "+d+" :"),Logger.message("	"+b[d].position.x+","+b[d].position.y),Logger.message("	Murs parents : ",c.indexOf(b[d].parents[0]),c.indexOf(b[d].parents[1]))},DebugComponent2D.prototype.roomState=function(a){Logger.message("ETAT DES PIECES :");for(var b in a.rooms)Logger.message("Pi��ce "+b+" :"),Logger.message("	Aire : "+a.rooms[b].area),a.rooms[b].path.debug()},DebugComponent2D.prototype.ints=function(a){Logger.message("Intersections :");var b=this.structure.getCurrentStructure(),c=(b.getElements("points"),b.getElements("walls"));for(var d in c){Logger.message("Mur "+d+" :");for(var e=a._extractWallIntersections(c[d]),f=0;f<e.a.length;f++)Logger.message("	a :"+e.a[f].x+","+e.a[f].y);for(var f=0;f<e.b.length;f++)Logger.message("	b :"+e.b[f].x+","+e.b[f].y)}};var DEBUG=DEBUG||!0,wallState=wallState||function(){if(DEBUG){var a=PLANNER_DEBUGGER.getComponentByName("DebugComponent2D",1);a.wallState()}else Logger.message("debug is disabled !")},pointState=pointState||function(){if(DEBUG){var a=PLANNER_DEBUGGER.getComponentByName("DebugComponent2D",1);a.pointState()}else Logger.message("debug is disabled !")},roomState=roomState||function(){if(DEBUG){var a=PLANNER_DEBUGGER.getComponentByName("DebugComponent2D",1),b=PLANNER_DEBUGGER.getComponentByName("RoomComponent2D");a.roomState(b)}else Logger.message("debug is disabled !")},ints=ints||function(){if(DEBUG){var a=PLANNER_DEBUGGER.getComponentByName("DebugComponent2D",1),b=PLANNER_DEBUGGER.getComponentByName("WallComponent2D",1);a.ints(b)}else Logger.message("debug is disabled !")},getWalls=getWalls||function(){return DEBUG?PLANNER_DEBUGGER.getSelectedStructure().getElements("walls"):void Logger.message("debug is disabled !")},getPoints=getPoints||function(){return DEBUG?PLANNER_DEBUGGER.getSelectedStructure().getElements("points"):void Logger.message("debug is disabled !")},getRooms=getRooms||function(){return DEBUG?PLANNER_DEBUGGER.getSelectedStructure().getElements("rooms"):void Logger.message("debug is disabled !")},compareRooms=compareRooms||function(){if(DEBUG){for(var a=[],b=0,c=PLANNER_DEBUGGER.structure.getLength();c>b;b++){var d=PLANNER_DEBUGGER.structure.getElement(b);if(d instanceof FloorStructure&&(a.push(d.getElements("rooms")),2==a.length))break}var e=PLANNER_DEBUGGER.getComponentByName("RoomComponent2D",1);Logger.message(e.identifyRooms(a[0],a[1]))}else Logger.message("debug is disabled !")},DebugComponent3D=function(a){BaseComponent3D.call(this,a,"DebugComponent3D")};DebugComponent3D.prototype=Object.create(BaseComponent3D.prototype),DebugComponent3D.prototype.dumpSceneToFile=function(){var a=BABYLON.SceneSerializer.Serialize(hcsdesign.engine3D.scene),b=JSON.stringify(a),c=new Blob([b],{type:"text/plain;charset=utf-8"});saveAs(c,"scene.babylon")},DebugComponent3D.prototype.marks=[],DebugComponent3D.prototype.mark=function(a,b,c,d,e){var d=d||16755200;Logger.message("%c Point marked with this color","color:"+d);var f=new THREE.SphereGeometry(e||5),g=new THREE.MeshBasicMaterial({color:d}),h=new THREE.Mesh(f,g);return this.scene.add(h),this.marks.push(h),h.position.set(a,b,c),hcsdesign.engine3D.refreshRenderer(),this.marks.length-1},DebugComponent3D.prototype.marklights=function(){Logger.message(this);for(var a=0;a<this.scene.__lights.length;a++){var b=this.scene.__lights[a].position;this.mark(b.x,b.y,b.z,16776960)}return hcsdesign.engine3D.refreshRenderer(),this.scene.__lights},DebugComponent3D.prototype.removemark=function(a){return this.scene.remove(this.marks[a]),this.marks.splice(a,1),a},DebugComponent3D.prototype.removemarks=function(){for(var a=0;a<this.marks.length;a++)this.scene.remove(this.marks[a]);return this.marks=[],"done"};var DEBUG=DEBUG||!0;DebugComponent3D.prototype.concatGeom=function(a){var b=function(a){var b=-1/0;for(var c in a.faces)b=Math.max(b,a.faces[c].materialIndex);return b},c=new THREE.Geometry,d=[],e=new THREE.MeshFaceMaterial(d),f=0,g=function(){for(var g=a.children.length-1;g>=0;g--)if("structure"==a.children[g].type)for(var h in a.children[g].children)if(a.children[g].children[h]instanceof THREE.Mesh&&a.children[g].children[h].structure instanceof WallStructure){var i=b(a.children[g].children[h].geometry)+1;THREE.GeometryUtils.merge(c,a.children[g].children[h],f),d=d.concat(a.children[g].children[h].material.materials),f+=i,a.remove(a.children[g].children[h])}Logger.message(d),e.materials=d;var j=new THREE.Mesh(c,e);Logger.message(j.material),a.add(j),Logger.message(hcsdesign.engine3D.renderer.autoUpdateObjects),hcsdesign.engine3D.renderer.autoUpdateObjects=!1};g()};var updateRenderer=function(){hcsdesign.engine3D.renderer.initWebGLObjects(hcsdesign.engine3D.scene)},concatgeom=concatgeom||function(){var a=hcsdesign.getComponentByName("DebugComponent3D");return DEBUG?a.concatGeom(hcsdesign.engine3D.scene):(Logger.warning("debug is disabled !"),!1)},mark=mark||function(a,b,c,d,e){var f=hcsdesign.getComponentByName("DebugComponent3D");return DEBUG?f.mark(a,b,c,d,e):(Logger.warning("debug is disabled !"),!1)},marklights=marklights||function(){var a=hcsdesign.getComponentByName("DebugComponent3D");return DEBUG?a.marklights():(Logger.warning("debug is disabled !"),!1)},removemark=removemark||function(a){var b=hcsdesign.getComponentByName("DebugComponent3D");return DEBUG?b.removemark(a):(Logger.warning("debug is disabled !"),!1)},removemarks=removemarks||function(){var a=hcsdesign.getComponentByName("DebugComponent3D");return DEBUG?a.removemarks():(Logger.warning("debug is disabled !"),!1)},drawWalls=drawWalls||function(){var a=hcsdesign.getComponentByName("WallComponent3D");return DEBUG?a.drawWalls():(Logger.warning("debug is disabled !"),!1)},debugCSG=debugCSG||function(){var a=hcsdesign.getComponentByName("WallComponent3D");return DEBUG?a.debugCSG():(Logger.warning("debug is disabled !"),!1)},debugSS=debugSS||function(){var a=hcsdesign.getComponentByName("SubSlopeComponent3D");return DEBUG?a.debug():(Logger.warning("debug is disabled !"),!1)},AnalyticsComponent=function(){var a,b={"hcs.contextChanged":{action:"contextChanged",label:"fromContext",value:"{previousContext}"},"hcs.request.toggleFullscreen":{action:"toggleFullscreen"},"hcs.request.print":{action:"requestPrint"},"hcs.engine2d.onAddBackground":{action:"addBackgroundClick"},"hcs.component.lock":{action:"onLockObject"},"hcs.request.undo":{action:"history",label:"undo"},"hcs.request.redo":{action:"history",label:"redo"},"hcs.request.switch-transparency":{action:"switchTransparency"},"hcs.engine3D.addObject":{action:"addObject"},"hcs.engine3D.addProgrammable":{action:"addObject"},"hcs.engine3D.addGroup":{action:"addObject"},"hcs.request.object.remove":{action:"removeObject"},"hcs.engine3D.info":{action:"infoObject"},"hcs.contextMenu.propertyChanged":{action:"objectParamsModified",label:"{property}",value:"{value}"},"hcs.engine3D.decorate":{action:"decorate"}},c=function(b){BaseComponent2D.call(this,b,"AnalyticsComponent"),a=this};return c.prototype=Object.create(BaseComponent2D.prototype),c.prototype.initialize=function(){ga("send","pageview",{dimension1:hcsdesign.api.apiKey,dimension2:hcsdesign.mode});for(var d in b)!function(b,d){var e=b.split(".").join("_");c.prototype[e]=function(b){var c=hcsdesign.getSelectedEngine()==hcsdesign.ENGINE_2D?"2D":"3D",e=a.cleanValue(d.action,b),f=a.cleanValue(d.label,b),g=a.cleanValue(d.value,b);ga("send","event",{eventCategory:c,eventAction:e,eventLabel:f,eventValue:g,hitCallback:function(){},hitCallbackFail:function(){}})},document.addEventListener(b,c.prototype[e])}(d,b[d])},c.prototype.cleanValue=function(a,b){if(!a)return null;var b=b||{};if(-1==a.toString().indexOf("{"))return a;var c=a.replace("{","").replace("}",""),a=ujs.getProperty(b,c);return a?a:null},c}(),GroupConfiguratorModComponent3D=function(){var a=function(a){BaseComponent3D.call(this,a,"GroupConfiguratorModComponent3D"),this.edcmp=hcsdesign.getComponentByName("EditionComponent3D")};return a.prototype=new BaseComponent3D,a.prototype.initialize=function(){this._state="idle",this._currentObject=null},a.prototype.getState=function(){return this._state},a.prototype.getCurrentObject=function(){return this._currentObject},a.prototype.lockUnrelatedActions=function(){this.edcmp.lock(this,14);for(var a=this.edcmp.widgets.length;a--;)this.edcmp.widgets[a].removeInfo&&this.edcmp.widgets[a].removeInfo();return!0},a.prototype.unlockUnrelatedActions=function(){if(this.edcmp.unlock(this,14),this.edcmp.getSelectedObject())for(var a=this.edcmp.widgets.length;a--;)this.edcmp.widgets[a].addInfo&&this.edcmp.widgets[a].addInfo();return!0},a.prototype.requestStart=function(){return"ready"==this.getState()?!1:this.getCurrentObject()?(this.lockUnrelatedActions(),this._state="ready",void ujs.notify("hcs.engine3d.groupConfigurator.start")):!1},a.prototype.requestStop=function(){return"idle"==this.getState()?!1:(this._state="idle",ujs.notify("hcs.engine3d.groupConfigurator.stop"),void this.unlockUnrelatedActions())},a.prototype.startListening=function(){this.initBindForThisInstance(),this.stopListening(),document.addEventListener("hcs.request.groupConfigurator.start",this.myBind.onRequestStart),document.addEventListener("hcs.request.groupConfigurator.stop",this.myBind.onRequestStop),document.addEventListener("hcs.request.groupConfigurator.cancel",this.myBind.onRequestCancel),document.addEventListener("hcs.engine3D.object.remove",this.myBind.onDisposeObject,!1),document.addEventListener("hcs.engine3D.object.dispose",this.myBind.onDisposeObject,!1),document.addEventListener("hcs.engine3d.globaleFloorReady",this.myBind.onFloorChanged,!1),document.addEventListener("hcs.contextChanged ",this.myBind.onSwapEngine)},a.prototype.stopListening=function(){this.initBindForThisInstance(),document.removeEventListener("hcs.request.groupConfigurator.start",this.myBind.onRequestStart),document.removeEventListener("hcs.request.groupConfigurator.stop",this.myBind.onRequestStop),document.removeEventListener("hcs.request.groupConfigurator.cancel",this.myBind.onRequestCancel),document.removeEventListener("hcs.engine3D.object.remove",this.myBind.onDisposeObject,!1),document.removeEventListener("hcs.engine3D.object.dispose",this.myBind.onDisposeObject,!1),document.removeEventListener("hcs.engine3d.globaleFloorReady",this.myBind.onFloorChanged,!1),document.removeEventListener("hcs.contextChanged ",this.myBind.onSwapEngine)
},a.prototype.initBindForThisInstance=function(){if(this.myBind)return this;var a=this;this.myBind={};for(var b in this.handlers)(function(){var c=a.handlers[b];a.myBind[b]=function(b){c.call(a,b)}})();return this},a.prototype.handlers={onRequestStart:function(a){this._currentObject=a.object||a.furniture||this.edcmp.getSelectedObject(),this.edcmp.isGroup(this._currentObject)||(this._currentObject=null),this.requestStart()},onRequestStop:function(){this.requestStop()},onRequestCancel:function(){this.cancel()},onSwapEngine:function(a){"2D"==a.engine&&ujs.notify("hcs.request.groupConfigurator.cancel")},onFloorChanged:function(){},onDisposeObject:function(){}},a}(),GroupConfiguratorPanelComponent3D=function(){var a=function(a){BaseComponent3D.call(this,a,"GroupConfiguratorPanelComponent3D"),this.confm=hcsdesign.getComponentByName("ConfiguratorModComponent3D"),this.hec=hcsdesign.getComponentByName("HistoryEditionComponent"),this.edcmp=hcsdesign.getComponentByName("EditionComponent3D"),this.camF=hcsdesign.engine3D.cameraFeatures};a.prototype=new BaseComponent3D,a.prototype.initialize=function(){this._options||this.setOptions()};var b={};return a.prototype.setOptions=function(a){this._options=this._options||{},a=a||{};for(var c in b)this._options[c]="undefined"==typeof a[c]?b[c]:a[c];return this},a.prototype.stopListening=function(){this.initBindForThisInstance(),document.removeEventListener("hcs.engine3d.groupConfigurator.start",this.myBind.onEditionStart,!1),document.removeEventListener("hcs.engine3d.groupConfigurator.stop",this.myBind.onEditionStop,!1),document.removeEventListener("hcs.widget.contextMenu.FurnitureEditorForGroup.closed",this.myBind.onEditBoxClosed,!1)},a.prototype.startListening=function(){this.stopListening(),document.addEventListener("hcs.engine3d.groupConfigurator.start",this.myBind.onEditionStart,!1),document.addEventListener("hcs.engine3d.groupConfigurator.stop",this.myBind.onEditionStop,!1),document.addEventListener("hcs.widget.contextMenu.FurnitureEditorForGroup.closed",this.myBind.onEditBoxClosed,!1)},a.prototype.initBindForThisInstance=function(){if(this.myBind)return this;var a=this;this.myBind={};for(var b in this.handlers)(function(){var c=a.handlers[b];a.myBind[b]=function(b){c.call(a,b)}})();return this},a.prototype.closeEditBox=function(){hcs.UI.ContextMenu.close()},a.prototype.openEditBox=function(a){if(a){this._enabled=!0;var b=[{label:_("Remove"),action:"hcs.request.object.remove","class":"remove"},{label:_("Duplicate"),action:"hcs.request.object.clone"},{label:_("Submit"),action:"hcs.widget.contextMenu.FurnitureEditorForGroup.closed"}];hcsdesign.isPublisher()&&b.push({label:_("Add to products"),action:"hcs.request.object.addToProducts"});var c=[{content:[{label:_("Group"),type:"checkbox",value:-1==a.name.indexOf("group_virtual")?!0:!1,eventParams:{eventName:"hcs.engine3D.contextMenu.group"}}]}];hcs.UI.ContextMenu.show({menuName:"FurnitureEditorForGroup",title:_("Group info"),width:450,maxHeight:200,height:200,autoSize:!1},c,b,!1,{furniture:a})}},a.prototype.handlers={onEditionStart:function(){this.openEditBox(this.edcmp.getSelectedObject())},onEditionStop:function(){this.closeEditBox()},onEditBoxClosed:function(){this._enabled=!1,ujs.notify("hcs.request.groupConfigurator.stop")}},a}(),ConfiguratorModComponent3D=function(){var a=function(a){BaseComponent3D.call(this,a,"ConfiguratorModComponent3D"),this.edcmp=hcsdesign.getComponentByName("EditionComponent3D")};return a.prototype=new BaseComponent3D,a.prototype.startListening=function(){this.initBindForThisInstance(),this.stopListening(),document.addEventListener("hcs.request.configurator.start",this.myBind.onRequestStart),document.addEventListener("hcs.request.configurator.stop",this.myBind.onRequestStop),document.addEventListener("hcs.request.configurator.cancel",this.myBind.onRequestCancel),document.addEventListener("hcs.engine3d.configurator.animationIn.end",this.myBind.onAnimationInEnd),document.addEventListener("hcs.engine3d.configurator.animationOut.end",this.myBind.onAnimationOutEnd),document.addEventListener("hcs.engine3d.configurator.animationIn.begin",this.myBind.onAnimationInStart),document.addEventListener("hcs.engine3d.configurator.animationOut.begin",this.myBind.onAnimationOutStart),document.addEventListener("hcs.engine3D.object.remove",this.myBind.onDisposeObject,!1),document.addEventListener("hcs.engine3D.object.dispose",this.myBind.onDisposeObject,!1),document.addEventListener("hcs.engine3D.object.refresh",this.myBind.onRefreshObject,!1),document.addEventListener("hcs.engine3d.globaleFloorReady",this.myBind.onFloorChanged,!1),document.addEventListener("hcs.contextChanged ",this.myBind.onSwapEngine)},a.prototype.stopListening=function(){this.initBindForThisInstance(),document.removeEventListener("hcs.request.configurator.start",this.myBind.onRequestStart),document.removeEventListener("hcs.request.configurator.stop",this.myBind.onRequestStop),document.removeEventListener("hcs.request.configurator.cancel",this.myBind.onRequestCancel),document.removeEventListener("hcs.engine3d.configurator.animationIn.end",this.myBind.onAnimationInEnd),document.removeEventListener("hcs.engine3d.configurator.animationOut.end",this.myBind.onAnimationOutEnd),document.removeEventListener("hcs.engine3d.configurator.animationIn.begin",this.myBind.onAnimationInStart),document.removeEventListener("hcs.engine3d.configurator.animationOut.begin",this.myBind.onAnimationOutStart),document.removeEventListener("hcs.engine3D.object.remove",this.myBind.onDisposeObject,!1),document.removeEventListener("hcs.engine3D.object.dispose",this.myBind.onDisposeObject,!1),document.removeEventListener("hcs.engine3D.object.refresh",this.myBind.onRefreshObject,!1),document.removeEventListener("hcs.engine3d.globaleFloorReady",this.myBind.onFloorChanged,!1),document.removeEventListener("hcs.contextChanged ",this.myBind.onSwapEngine)},a.prototype.initBindForThisInstance=function(){if(this.myBind)return this;var a=this;this.myBind={};for(var b in this.handlers)(function(){var c=a.handlers[b];a.myBind[b]=function(b){c.call(a,b)}})();return this},a.prototype.initialize=function(){this._state="idle",this._currentObject=null},a.prototype.getCurrentObject=function(){return this._currentObject},a.prototype.getState=function(){return this._state},a.prototype.requestStart=function(){return"idle"!=this.getState()?!1:this.getCurrentObject()?void(this._animateInandOut()?ujs.notify("hcs.request.configurator.animationIn.start"):(ujs.notify("hcs.engine3d.configurator.animationIn.begin"),ujs.notify("hcs.engine3d.configurator.animationIn.end"))):!1},a.prototype.requestStop=function(){return"ready"!=this.getState()?!1:void(this._animateInandOut()?ujs.notify("hcs.request.configurator.animationOut.start"):(ujs.notify("hcs.engine3d.configurator.animationOut.begin"),ujs.notify("hcs.engine3d.configurator.animationOut.end")))},a.prototype.cancel=function(){switch(this._canceling=!0,this._state){case"animationIn":ujs.notify(this._animateInandOut()?"hcs.request.configurator.animation.cancel":"hcs.engine3d.configurator.animationIn.end"),this._state="animationOut",ujs.notify("hcs.engine3d.configurator.animationOut.begin"),ujs.notify("hcs.engine3d.configurator.animationOut.end");break;case"animationOut":ujs.notify(this._animateInandOut()?"hcs.request.configurator.animation.cancel":"hcs.engine3d.configurator.animationOut.end");break;case"ready":this._state="animationOut",ujs.notify("hcs.engine3d.configurator.animationOut.begin"),ujs.notify("hcs.engine3d.configurator.animationOut.end");break;case"idle":}this._canceling=!1,this._state="idle"},a.prototype._lockUnrelatedActions=function(){return this.edcmp.lock(this,14),this.edcmp.disableWidget(),!0},a.prototype._unlockUnrelatedActions=function(){return this.edcmp.unlock(this,14),this.edcmp.enableWidget(),this.getCurrentObject()&&this.getCurrentObject().parent&&this.edcmp.isGroup(this.getCurrentObject().parent)&&this.edcmp.selectObject(this.getCurrentObject().parent),!0},a.prototype._animateInandOut=function(){return!!hcsdesign.getComponentByName("ConfiguratorInOutAnimationComponent3D")},a.prototype.handlers={onAnimationInStart:function(){this._lockUnrelatedActions(),this._state="animationIn"},onAnimationInEnd:function(){this._state="ready",this._canceling||ujs.notify("hcs.engine3d.configurator.start",{furniture:this.getCurrentObject()})},onAnimationOutStart:function(){this._state="animationOut",this._unlockUnrelatedActions(),ujs.notify("hcs.engine3d.configurator.stop")},onAnimationOutEnd:function(){this._state="idle",this._unlockUnrelatedActions()},onRequestStart:function(a){this._currentObject=a.object||a.furniture||this.edcmp.getSelectedObject(),this.edcmp.isGroup(this._currentObject)&&(this._currentObject=null),this.requestStart()},onRequestStop:function(){this.requestStop()},onRequestCancel:function(){this.cancel()},onSwapEngine:function(a){"2D"==a.engine&&ujs.notify("hcs.request.configurator.cancel")},onFloorChanged:function(){},onDisposeObject:function(a){"idle"!=this.getState()&&a.object==this._currentObject&&ujs.notify("hcs.request.configurator.cancel")},onRefreshObject:function(){"idle"!=this.getState()&&this.getCurrentObject()==event.object&&this._lockUnrelatedActions()}},a}(),ConfiguratorPanelComponent3D=function(){var a=function(a){BaseComponent3D.call(this,a,"ConfiguratorPanelComponent3D"),this.confm=hcsdesign.getComponentByName("ConfiguratorModComponent3D"),this.hec=hcsdesign.getComponentByName("HistoryEditionComponent"),this.edcmp=hcsdesign.getComponentByName("EditionComponent3D"),this.camF=hcsdesign.engine3D.cameraFeatures};a.prototype=new BaseComponent3D,a.prototype.initialize=function(){this._options||this.setOptions()};var b={};a.prototype.setOptions=function(a){this._options=this._options||{},a=a||{};for(var c in b)this._options[c]="undefined"==typeof a[c]?b[c]:a[c];return this},a.prototype.stopListening=function(){this.initBindForThisInstance(),document.removeEventListener("hcs.engine3d.configurator.start",this.myBind.onEditionStart,!1),document.removeEventListener("hcs.engine3d.configurator.stop",this.myBind.onEditionStop,!1),document.removeEventListener("hcs.engine3D.object.refresh",this.myBind.onRefresh,!1),document.removeEventListener("hcs.engine3D.object.rotate",this.myBind.onRefresh,!1),document.removeEventListener("hcs.engine3D.object.translate",this.myBind.onRefresh,!1),document.removeEventListener("hcs.contextMenu.transformChanged",this.myBind.onTransformPropertyChanged,!1),document.removeEventListener("hcs.contextMenu.propertyChanged",this.myBind.onParamPropertyChanged,!1),document.removeEventListener("hcs.widget.contextMenu.FurnitureEditor.closed",this.myBind.onEditBoxClosed,!1)},a.prototype.startListening=function(){this.stopListening(),document.addEventListener("hcs.engine3d.configurator.start",this.myBind.onEditionStart,!1),document.addEventListener("hcs.engine3d.configurator.stop",this.myBind.onEditionStop,!1),document.addEventListener("hcs.contextMenu.transformChanged",this.myBind.onTransformPropertyChanged,!1),document.addEventListener("hcs.contextMenu.propertyChanged",this.myBind.onParamPropertyChanged,!1),document.addEventListener("hcs.widget.contextMenu.FurnitureEditor.closed",this.myBind.onEditBoxClosed,!1)},a.prototype.initBindForThisInstance=function(){if(this.myBind)return this;var a=this;this.myBind={};for(var b in this.handlers)(function(){var c=a.handlers[b];a.myBind[b]=function(b){c.call(a,b)}})();return this},a.prototype.closeEditBox=function(){hcs.UI.ContextMenu.close(),document.removeEventListener("hcs.engine3D.object.refresh",this.myBind.onRefresh,!1),document.removeEventListener("hcs.engine3D.object.rotate",this.myBind.onRefresh,!1),document.removeEventListener("hcs.engine3D.object.translate",this.myBind.onRefresh,!1)},a.prototype.openEditBox=function(a){if(a){this._enabled=!0;var b=[{label:_("删除"),action:"hcs.request.object.remove","class":"remove"},{label:_("复制"),action:"hcs.request.object.clone"},{label:_("确定"),action:"hcs.widget.contextMenu.FurnitureEditor.closed"}];hcsdesign.isPublisher()&&b.push({label:_("增加到物品列表"),action:"hcs.request.object.addToProducts"});var c=a.structure,d=c.getAvailableProperties(),e=[{title:_("设置"),content:d},{title:_("位置 和 旋转"),content:this._getPositionAndRotationMenu(c)}];hcs.UI.ContextMenu.show({menuName:"FurnitureEditor",title:_("物品属性"),width:500,maxHeight:window.innerHeight-140,height:window.innerHeight-140,autoSize:!1,x:window.innerWidth-400,id:"configuratorWindow"},e,b,!1,{furniture:a}),document.addEventListener("hcs.engine3D.object.refresh",this.myBind.onRefresh,!1),document.addEventListener("hcs.engine3D.object.rotate",this.myBind.onRefresh,!1),document.addEventListener("hcs.engine3D.object.translate",this.myBind.onRefresh,!1)}},a.prototype.refreshEditBox=function(a){if(a&&this._enabled){var b=a.structure,c=b.getAvailableProperties(),d=[{title:_("设置"),content:c},{title:_("位置 和 旋转"),content:this._getPositionAndRotationMenu(b)}];hcs.UI.ContextMenu.update(d)}},a.prototype._setTransformProperty=function(a,b,c){if(!a)return!1;var d=b.indexOf("rotation")>=0;d&&(c=c/180*Math.PI);var e=a.rotation.clone(),f=a.position.clone();ujs.setProperty(a,b,+c),ujs.notify("hcs.request.historyAction",{component:this.edcmp,object:a,params:{oldPosition:f,newPosition:a.position.clone(),oldRotation:e,newRotation:a.rotation.clone()},action:d?this.edcmp.ROTATEACTION:this.edcmp.MOVEACTION}),a.computeWorldMatrix(!0),a.parent.markAsDirty(),ujs.notify(d?"hcs.engine3D.object.translate":"hcs.engine3D.object.rotate",{object:a})},a.prototype._setParamProperty=function(a,b,c){if(!a)return!1;var d=a.structure.programmableInstance;c=d.validateParam(b,c),("undefined"==typeof c||null===c)&&(c=ujs.getProperty(d,b));var e={};e["programmableInstance."+b]={newValue:c,exValue:ujs.getProperty(d,b)},ujs.setProperty(d,b,c),this.edcmp.refreshObject(a,{modifiedProperties:e}),ujs.notify("hcs.request.saveHistory")},a.prototype._saveFrameState=function(){for(var a=hcs.UI.ContextMenu.getPosition()||{x:100,y:100},b=document.querySelectorAll(".advancedParams"),c=!(!b.length||b[0].classList.contains("hidden")),e=document.querySelectorAll(".window .tabbed-tabcontent"),f=[],g=e.length;g--;)f[g]=d(e[g]);this._frameSavedState={advancedVisible:c,x:a.x,y:a.y,scroll:f}},a.prototype._restoreFrameState=function(){if(this._frameSavedState){this._frameSavedState.advancedVisible&&hcs.Programmable.toggleVisible(),hcs.UI.ContextMenu.setPosition(this._frameSavedState.x,this._frameSavedState.y);for(var a=document.querySelectorAll(".window .tabbed-tabcontent"),b=a.length;b--;)c(a[b],this._frameSavedState.scroll[b].x,this._frameSavedState.scroll[b].y)}},a.prototype._getPositionAndRotationMenu=function(a){var b=[],c=function(a){var b=2*Math.PI;return Math.round((a%b+b)%b/Math.PI*180)};return b.push({type:"separator",label:_("旋转")}),b.push({label:_("x 轴"),type:"slider",unit:"°",value:{step:1,min:0,max:360,value:c(a.rotation.x)},eventParams:{eventName:"hcs.contextMenu.transformChanged",property:"rotation.x"},id:"rotation-x"}),b.push({label:_("y 轴"),type:"slider",unit:"°",value:{step:1,min:0,max:360,value:c(a.rotation.y)},eventParams:{eventName:"hcs.contextMenu.transformChanged",property:"rotation.y"},id:"rotation-y"}),b.push({label:_("z 轴"),type:"slider",unit:"°",value:{step:1,min:0,max:360,value:c(a.rotation.z)},eventParams:{eventName:"hcs.contextMenu.transformChanged",property:"rotation.z"},id:"rotation-z"}),b.push({type:"separator",label:_("位置")}),b.push({label:_("x 轴"),type:"number",unit:"cm",value:{step:10,min:-1e4,max:1e4,value:Math.round(a.position.x)},eventParams:{eventName:"hcs.contextMenu.transformChanged",property:"position.x"},id:"position-x"}),b.push({label:_("y 轴"),type:"number",unit:"cm",value:{step:10,min:-1e4,max:1e4,value:Math.round(a.position.y)},eventParams:{eventName:"hcs.contextMenu.transformChanged",property:"position.y"},id:"position-y"}),b.push({label:_("z 轴"),type:"number",unit:"cm",value:{step:10,min:-1e4,max:1e4,value:Math.round(a.position.z)},eventParams:{eventName:"hcs.contextMenu.transformChanged",property:"position.z"},id:"position-z"}),b},a.prototype.handlers={onEditionStart:function(){this.openEditBox(this.confm.getCurrentObject())},onEditionStop:function(){this.closeEditBox()},onRefresh:function(a){"ready"==this.confm.getState()&&a.object==this.confm.getCurrentObject()&&this.refreshEditBox(this.confm.getCurrentObject())},onParamPropertyChanged:function(a){this._setParamProperty(this.confm.getCurrentObject(),a.property,a.value)},onTransformPropertyChanged:function(a){this._setTransformProperty(this.confm.getCurrentObject(),a.property,a.value)},onEditBoxClosed:function(){this._enabled=!1,ujs.notify("hcs.request.configurator.stop")}};var c=function(a,b,c){if(a.scrollTo)return void a.scrollTo(b,c);if(null!=a.scrollLeft&&null!=a.scrollTop)return a.scrollLeft=b,void(a.scrollTop=c);if(null!=a.scrollX&&null!=a.scrollY)return a.scrollX=b,void(a.scrollY=c);throw"unable to scroll"},d=function(a){if(null!=a.scrollLeft&&null!=a.scrollTop)return{x:a.scrollLeft,y:a.scrollTop};if(null!=a.scrollX&&null!=a.scrollY)return{x:a.scrollX,y:a.scrollY};throw"unable to scroll"};return a}(),ConfiguratorInOutAnimationComponent3D=function(){var a=function(a){BaseComponent3D.call(this,a,"ConfiguratorInOutAnimationComponent3D"),this.confm=hcsdesign.getComponentByName("ConfiguratorModComponent3D"),this.camComp=hcsdesign.getComponentByName("CameraComponent"),this.avatarComp=hcsdesign.getComponentByName("AvatarComponent3D"),this.camF=hcsdesign.engine3D.cameraFeatures,this.setOptions({alpha:!1,beta:!0,goBack:!0,velocity:2})};a.prototype=Object.create(BaseComponent3D.prototype),a.prototype.initialize=function(){this._previous={cameraState:null,wallTransparency:null,lookAtObject:null,lookAtY:null,controlLock:null},this._options||this.setOptions()};var b={duration:250,velocity:!1,smooth:"ease",alpha:!0,beta:!0,radius:!0,goBack:!0};a.prototype.setOptions=function(a){this._options=this._options||{},a=a||{};for(var c in b)this._options[c]="undefined"==typeof a[c]?b[c]:a[c];return this},a.prototype.replaceCameraTarget=function(a){var b=hcsdesign.engine3D.scene.activeCamera,c=this.camF,d=c.computeCameraStateLooking(a,b);d={target:d.target};var e={target:b.target.clone()},f=this._options.velocity?this._coputeDelta(e,d)/(.1*this._options.velocity):.5*this._options.duration;return c.computeAnimation(b,e,d,{duration:f,name:"cameraAnimation",isACamera:!0,smooth:"ease"})},a.prototype.focusObject=function(a){var b=hcsdesign.engine3D.camera,c=this.camF;if("In"!=this._currentAnimation&&!this._focus){this._previous.cameraState={target:b.target.clone(),alpha:b.alpha,beta:b.beta,radius:b.radius};var d={target:b.target.clone(),alpha:b.alpha,beta:b.beta,radius:b.radius},e=c.computeCameraStateLooking(a,b);e.alpha=BABYLON.Math.ClosestAngle(e.alpha,d.alpha),e.beta=BABYLON.Math.ClosestAngle(e.beta,d.beta),this.stopCurrentAnimation(),d=this._filterCameraState(d),e=this._filterCameraState(e);var f=this._options.velocity?this._coputeDelta(d,e)/this._options.velocity:this._options.duration;this._cancelor=c.computeAnimation(b,d,e,{duration:f,callback:this.myBind.afterAnimation,name:"cameraFocusOn_"+a.name,isACamera:!0,smooth:"ease"}),this._currentAnimation="In",ujs.notify("hcs.engine3d.configurator.animationIn.begin")}},a.prototype.stopCurrentAnimation=function(){if(this._cancelor){this._cancelor.cancel(),this._listenBreakEvent(!1);var a=this._currentAnimation;switch(this._cancelor=null,this._currentAnimation=null,a){case"In":case"Out":ujs.notify("hcs.engine3d.configurator.animation"+a+".end")}}},a.prototype.cancel=function(){this.stopCurrentAnimation()},a.prototype.restoreCameraState=function(){var a=hcsdesign.engine3D.camera,b=this.camF;if("Out"!=this._currentAnimation&&this._focus){var c={target:a.target.clone(),alpha:a.alpha,beta:a.beta,radius:a.radius},d=this._previous.cameraState;d.alpha=BABYLON.Math.ClosestAngle(d.alpha,c.alpha),d.beta=BABYLON.Math.ClosestAngle(d.beta,c.beta),this.stopCurrentAnimation(),c=this._filterCameraState(c),d=this._filterCameraState(d);var e=this._options.velocity?this._coputeDelta(c,d)/this._options.velocity:this._options.duration;this._cancelor=b.computeAnimation(a,c,d,{duration:e,callback:this.myBind.afterAnimation,name:"cameraFocusOff",isACamera:!0,smooth:"ease"}),this._currentAnimation="Out",this._previous.cameraState=!1,ujs.notify("hcs.engine3d.configurator.animationOut.begin"),this._listenBreakEvent(!0)}},a.prototype.startListening=function(){this.stopListening(),document.addEventListener("hcs.request.configurator.animation.cancel",this.myBind.onRequestCancel),document.addEventListener("hcs.request.configurator.animationIn.start",this.myBind.onRequestAnimationIn),document.addEventListener("hcs.request.configurator.animationOut.start",this.myBind.onRequestAnimationOut),document.addEventListener("hcs.engine3d.configurator.animationIn.begin",this.myBind.onAnimationInStart),document.addEventListener("hcs.engine3d.configurator.animationIn.end",this.myBind.onAnimationInEnd),document.addEventListener("hcs.engine3d.configurator.animationOut.begin",this.myBind.onAnimationOutStart),document.addEventListener("hcs.engine3d.configurator.animationOut.end",this.myBind.onAnimationOutEnd),document.addEventListener("hcs.engine3D.object.refresh",this.myBind.onRefresh),document.addEventListener("hcs.engine3D.object.translate",this.myBind.onRefresh),document.addEventListener("hcs.engine3D.object.rotate",this.myBind.onRefresh),this._listening=!0},a.prototype.stopListening=function(){this.initBindForThisInstance(),document.removeEventListener("hcs.request.configurator.animation.cancel",this.myBind.onRequestCancel),document.removeEventListener("hcs.request.configurator.animationIn.start",this.myBind.onRequestAnimationIn),document.removeEventListener("hcs.request.configurator.animationOut.start",this.myBind.onRequestAnimationOut),document.removeEventListener("hcs.engine3d.configurator.animationIn.begin",this.myBind.onAnimationInStart),document.removeEventListener("hcs.engine3d.configurator.animationIn.end",this.myBind.onAnimationInEnd),document.removeEventListener("hcs.engine3d.configurator.animationOut.begin",this.myBind.onAnimationOutStart),document.removeEventListener("hcs.engine3d.configurator.animationOut.end",this.myBind.onAnimationOutEnd),document.removeEventListener("hcs.engine3D.object.refresh",this.myBind.onRefresh),document.removeEventListener("hcs.engine3D.object.translate",this.myBind.onRefresh),document.removeEventListener("hcs.engine3D.object.rotate",this.myBind.onRefresh),this._listening=!1},a.prototype.initBindForThisInstance=function(){if(this.myBind)return this;var a=this;this.myBind={};for(var b in this.handlers)(function(){var c=a.handlers[b];a.myBind[b]=function(b){c.call(a,b)}})();return this},a.prototype.avatarUnbind=function(){var a=this.camComp,b=hcsdesign.engine3D.camera;this._previous.lookAtObject=a.lookAt,this._previous.lookAtY=b.target.y,a.bindLookAt(null)},a.prototype.avatarRebind=function(){var a=this.camComp,b=hcsdesign.engine3D.camera;a.cameraActiveId?a.camera[0].target.y=this.avatarComp.avatar.position.y+170:(b.target.y=this._previous.lookAtY,b.target.y=this.avatarComp.avatar.position.y+170,a.bindLookAt(this._previous.lookAtObject))},a.prototype._listenBreakEvent=function(a){for(var b=c.length;b--;)document.removeEventListener(c[b],this.myBind.onRequestCancel,!1);if(a)for(var b=c.length;b--;)document.addEventListener(c[b],this.myBind.onRequestCancel,!1)},a.prototype._filterCameraState=function(a){var b={target:a.target};for(var c in a)switch(c){case"beta":case"alpha":case"radius":this._options[c]&&(b[c]=a[c])}return b},a.prototype._coputeDelta=function(a,b){var c,d=0;for(var e in a){switch(e){case"beta":case"alpha":c=Math.abs(b[e]-a[e])/Math.PI*800;break;case"radius":c=.6*Math.abs(b[e]-a[e]);break;case"target":c=1.6*BABYLON.Vector3.Distance(a[e],b[e])}c>d&&(d=c)}return d},a.prototype.handlers={afterAnimation:function(){this.stopCurrentAnimation()},onAnimationInStart:function(){this.avatarUnbind()},onAnimationInEnd:function(){this._focus=!0},onAnimationOutStart:function(){this._focus=!1},onAnimationOutEnd:function(){this.avatarRebind()},onRequestAnimationOut:function(){this._options.goBack?this.restoreCameraState():(ujs.notify("hcs.engine3d.configurator.animationOut.begin"),ujs.notify("hcs.engine3d.configurator.animationOut.end"))},onRequestAnimationIn:function(){this.confm.getCurrentObject()&&this.focusObject(this.confm.getCurrentObject())},onRequestCancel:function(){this.cancel()},onRefresh:function(a){(this._focus||this._currentAnimation)&&a.object==this.confm.getCurrentObject()&&this.replaceCameraTarget(a.object)}};var c=["hcs.engine3D.dragging","hcs.engine3D.camera.zoom","hcs.engine3D.click"];return a}(),ConfiguratorXrayComponent3D=function(){var a=function(a){BaseComponent3D.call(this,a,"ConfiguratorXrayComponent3D"),this.confm=hcsdesign.getComponentByName("ConfiguratorModComponent3D"),this.hec=hcsdesign.getComponentByName("TransparencyComponent"),this.camF=hcsdesign.engine3D.cameraFeatures};a.prototype=new BaseComponent3D,a.prototype.initialize=function(){this._options||this.setOptions(),this._savedMaterials={},this._clonedMaterials={},b=new BABYLON.StandardMaterial("xrayTransparentDefaultMaterial",this.scene)};var b,c=function(a,c){a.getTotalVertices()&&(a.material||(a.material=b),"undefined"==typeof a.material.alternativeOpacity&&(a.material.alternativeOpacity="undefined"!=typeof a.material.alpha?a.material.alpha:1),a.material.alpha=c,a.material.transparent=1!=a.material.alpha)},d=function(a){c(a,0)},e=function(a){c(a,.1)},f=function(a){a.getTotalVertices()&&(a.material.alpha="undefined"==typeof a.material.alternativeOpacity?1:a.material.alternativeOpacity,a.material.transparent=1!=a.material.alpha,a.material==b&&(a.material=null))},g={wallTransparency:!0,hideAll:!0,partialTransparency:!0};return a.prototype.setOptions=function(a){this._options=this._options||{},a=a||{};for(var b in g)this._options[b]="undefined"==typeof a[b]?g[b]:a[b];return this._setHideStrategy(),this},a.prototype.stopListening=function(){this.initBindForThisInstance(),document.removeEventListener("hcs.engine3d.configurator.animationIn.begin",this.myBind.onAnimationInStart,!1),document.removeEventListener("hcs.engine3d.configurator.animationOut.end",this.myBind.onAnimationOutEnd,!1),document.removeEventListener("hcs.engine3D.camera.move",this.myBind.onCameraMove,!1)},a.prototype.startListening=function(){this.stopListening(),document.addEventListener("hcs.engine3d.configurator.animationIn.begin",this.myBind.onAnimationInStart,!1),document.addEventListener("hcs.engine3d.configurator.animationOut.end",this.myBind.onAnimationOutEnd,!1)},a.prototype.initBindForThisInstance=function(){if(this.myBind)return this;var a=this;this.myBind={};for(var b in this.handlers)(function(){var c=a.handlers[b];a.myBind[b]=function(b){c.call(a,b)}})();return this},a.prototype.start=function(){document.removeEventListener("hcs.engine3D.camera.move",this.myBind.onCameraMove,!1),this._stopSharingMaterial(this.confm.getCurrentObject()),this._flagMeshes(),this._changeOnCameraMove&&document.addEventListener("hcs.engine3D.camera.move",this.myBind.onCameraMove,!1),this._options.wallTransparency&&this._startWallTransparency()},a.prototype.stop=function(){if(document.removeEventListener("hcs.engine3D.camera.move",this.myBind.onCameraMove,!1),this._continueSharingMaterial(this.confm.getCurrentObject()),this._restoreMeshes(),this._options.wallTransparency)try{this._stopWallTransparency()}catch(a){console.warn("TODO  fix wallTransparency when floor have changed")}},a.prototype._stopSharingMaterial=function(a){var b,c=this._savedMaterials,d=this._clonedMaterials;a.traverse(function(e){e.material&&!c[b=a.name+":"+e.material.id+":"+e.name]&&e.material.clone&&(c[b]=e.material,d[b]=e.material=e.material.clone())})},a.prototype._continueSharingMaterial=function(a){var b,c=this._savedMaterials,d=this._clonedMaterials;a.traverse(function(e){e.material&&c[b=a.name+":"+e.material.id+":"+e.name]&&(d[b]!=e.material||(e.material=c[b],e.material.dispose()),d[b]=null,c[b]=null,delete d[b],delete c[b])})},a.prototype._flagMeshes=function(){var a=this.camera,b=this.confm.getCurrentObject(),c=this._options.partialTransparency?e:d;this._hideStrategyInit||this._hideStrategyInit(b,a);for(var g,h=hcsdesign.engine3D.scene.meshes,i=h.length;i--;)g=h[i],g.name&&"Object"==g.name.substr(0,6)&&g!=b&&g.traverse(this._hideStrategyAccept(g,b,a)?c:f)},a.prototype._restoreMeshes=function(){for(var a,b=this.confm.getCurrentObject(),c=hcsdesign.engine3D.scene.meshes,d=c.length;d--;)a=c[d],a.name&&"Object"==a.name.substr(0,6)&&a!=b&&a.traverse(f)},a.prototype._startWallTransparency=function(){var a=this.hec,b=this.camF;this._previousWallTransparency=b.wallTransparency,a.setTransparencyMode(!0)},a.prototype._stopWallTransparency=function(){var a=this.hec;this.camF,a.setTransparencyMode(this._previousWallTransparency)},a.prototype._setHideStrategy=function(a){switch("undefined"==typeof a&&(a="do not hide",this._options.hideAll&&(a="hide all")),a){case"hide all":this._hideStrategyInit=function(){},this._hideStrategyAccept=function(){return!0},this._changeOnCameraMove=!1;break;case"do not hide":default:this._hideStrategyInit=function(){},this._hideStrategyAccept=function(){return!1},this._changeOnCameraMove=!1}},a.prototype.handlers={onAnimationInStart:function(){this.start()},onAnimationOutEnd:function(){this.stop()},onCameraMove:function(){this._flagMeshes()}},a}(),MasterReshaperComponent3D=function(){var a=function(a){BaseComponent3D.call(this,a,"MasterReshaperComponent3D"),this.edcmp=hcsdesign.getComponentByName("EditionComponent3D"),this.confm=hcsdesign.getComponentByName("ConfiguratorModComponent3D"),this._listeners=[]};return a.prototype=new BaseComponent3D,a.prototype.initialize=function(){},a.prototype.startListening=function(){this.stopListening(),document.addEventListener("hcs.engine3d.configurator.cancel",this.myBind.onConfiguratorCancel,!1),document.addEventListener("hcs.engine3d.configurator.start",this.myBind.onConfiguratorStart,!1),document.addEventListener("hcs.engine3d.configurator.stop",this.myBind.onConfiguratorStop,!1)},a.prototype.stopListening=function(){this.initBindForThisInstance(),document.removeEventListener("hcs.engine3d.configurator.cancel",this.myBind.onConfiguratorCancel,!1),document.removeEventListener("hcs.engine3d.configurator.start",this.myBind.onConfiguratorStart,!1),document.removeEventListener("hcs.engine3d.configurator.stop",this.myBind.onConfiguratorStop,!1),document.removeEventListener("hcs.engine3D.drag-start",this.myBind.onDragStart,!1),document.removeEventListener("hcs.engine3D.drag-end",this.myBind.onDragEnd,!1),document.removeEventListener("hcs.engine3D.dragging",this.myBind.onDragging,!1),document.removeEventListener("hcs.engine3D.mouse-move",this.myBind.onMouseMove,!1),document.removeEventListener("hcs.engine3D.object.refresh",this.myBind.onRefresh,!1),document.removeEventListener("hcs.engine3D.object.translate",this.myBind.onRefresh,!1),document.removeEventListener("hcs.engine3D.object.rotate",this.myBind.onRefresh,!1)},a.prototype.initBindForThisInstance=function(){if(this.myBind)return this;var a=this;this.myBind={};for(var b in this.handlers)(function(){var c=a.handlers[b];a.myBind[b]=function(b){c.call(a,b)}})();return this},a.prototype.notify=function(a,b){var c=this._listeners[a];if(c)for(var d=0;d<c.length;d++)c[d](b)},a.prototype.on=function(a,b){return this._listeners[a]||(this._listeners[a]=[]),this._listeners[a].push(b),this},a.prototype.off=function(a,b){var c=this._listeners[a];return c?(c.indexOf(b)>-1&&c.splice(b,1),this):this},a.prototype.requireHand=function(a){return this._currentConfigurator==a?!0:(this._currentConfigurator&&this._currentConfigurator.cancelHand(),this._currentConfigurator=a,!0)},a.prototype.releaseHand=function(a){this._currentConfigurator==a&&(this._currentConfigurator=null,a.cancelHand());var b=this.edcmp,c=b.getLocker();b.unlock(c,1),b.lock(c,2)},a.prototype.start=function(a){this.furniture=a.furniture,this.notify("editionStart",a),document.removeEventListener("hcs.engine3D.drag-start",this.myBind.onDragStart,!1),document.removeEventListener("hcs.engine3D.mouse-move",this.myBind.onMouseMove,!1),document.removeEventListener("hcs.engine3D.object.refresh",this.myBind.onRefresh,!1),document.removeEventListener("hcs.engine3D.object.translate",this.myBind.onDragStart,!1),document.removeEventListener("hcs.engine3D.object.rotate",this.myBind.onMouseMove,!1),document.addEventListener("hcs.engine3D.drag-start",this.myBind.onDragStart,!1),document.addEventListener("hcs.engine3D.mouse-move",this.myBind.onMouseMove,!1),document.addEventListener("hcs.engine3D.object.refresh",this.myBind.onRefresh,!1),document.addEventListener("hcs.engine3D.object.translate",this.myBind.onRefresh,!1),document.addEventListener("hcs.engine3D.object.rotate",this.myBind.onRefresh,!1)
},a.prototype.cancel=a.prototype.stop=function(a){this.notify("editionEnd",a),document.removeEventListener("hcs.engine3D.drag-start",this.myBind.onDragStart,!1),document.removeEventListener("hcs.engine3D.drag-end",this.myBind.onDragEnd,!1),document.removeEventListener("hcs.engine3D.dragging",this.myBind.nDragging,!1),document.removeEventListener("hcs.engine3D.mouse-move",this.myBind.onMouseMove,!1),document.removeEventListener("hcs.engine3D.object.refresh",this.myBind.onRefresh,!1),document.removeEventListener("hcs.engine3D.object.translate",this.myBind.onRefresh,!1),document.removeEventListener("hcs.engine3D.object.rotate",this.myBind.onRefresh,!1)},a.prototype.handlers={onConfiguratorStart:function(a){this.start(a)},onConfiguratorStop:function(a){this.stop(a)},onConfiguratorCancel:function(a){this.cancel(a)},onDragStart:function(a){a.furniture=this.furniture;var b=this.furniture;if(a.collided=this.scene.pick(a.mstate.pos.x,a.mstate.pos.y,function(a){return a.getTopLevelObject(!0)==b}),this.notify("dragStart",a),document.removeEventListener("hcs.engine3D.drag-end",this.myBind.onDragEnd,!1),document.removeEventListener("hcs.engine3D.dragging",this.myBind.onDragging,!1),this.dragging=!1,document.addEventListener("hcs.engine3D.drag-end",this.myBind.onDragEnd,!1),document.addEventListener("hcs.engine3D.dragging",this.myBind.onDragging,!1),this._currentConfigurator){this.dragging=!0;var c=this.edcmp;c.lock(c.getLocker(),1)}},onDragging:function(a){if(this.notify("dragging",a),this._currentConfigurator){this.dragging=!0;var b=this.edcmp;b.lock(b.getLocker(),1)}},onDragEnd:function(a){if(this.notify("dragEnd",a),this.dragging=!1,this._currentConfigurator){var b=this.edcmp,c=b.getLocker();b.unlock(c,1),b.lock(c,2),document.removeEventListener("hcs.engine3D.drag-end",this.myBind.onDragEnd,!1),document.removeEventListener("hcs.engine3D.dragging",this.myBind.nDragging,!1)}},onMouseMove:function(a){if(!this.dragging&&(this._listeners.leave&&this._listeners.leave.length||this._listeners.hover&&this._listeners.hover.length)){a.furniture=this.furniture;var b=this.furniture;a.collided=this.scene.pick(a.mstate.pos.x,a.mstate.pos.y,function(a){return a.getTopLevelObject(!0)==b});var c=a.collided&&a.collided.pickedMesh;!c&&this._hover&&this.notify("leave",a),c&&this.notify("hover",a),this._hover=c}},onRefresh:function(a){a.object==this.furniture&&this.notify("refresh",a)}},a}(),DimensionReshaperComponent3D=function(){var a=function(a){BaseComponent3D.call(this,a,"DimensionReshaperComponent3D"),this._listeners=[],this._options||this.setOptions(),this.setOptions({roundDimension:.25,displayHandleOnResize:!0,keepAnimateHandleOnResize:!0})};a.prototype=Object.create(BaseComponent3D.prototype),a.prototype.initBindForThisInstance=function(){if(this.myBind)return this;var a=this;this.myBind={};for(var b in this.handlers)(function(){var c=a.handlers[b];a.myBind[b]=function(b){c.call(a,b)}})();return this},a.prototype.initialize=function(){var a=hcsdesign.getComponentByName("MasterReshaperComponent3D");if(!a)return console.warn("MasterReshaperComponent3D not found, the configurator "+this.name+" components will be disabled.");this.master=a,this._options||this.setOptions();var b=hcsdesign.getComponentByName("HandlesDisplayerForDimensionReshaperFactoryComponent3D"),c=hcsdesign.getComponentByName("BoundingLimitDisplayerForDimensionReshaperFactoryComponent3D"),d=hcsdesign.getComponentByName("MesureDisplayerForDimensionReshaperFactoryComponent3D");this.displayer={},c&&(this.displayer.boundingLimit=c.create(this.camera,this.scene,"green")),c&&this._options.displayNewBoundingLimit&&(this.displayer.boundingLimitNew=c.create(this.camera,this.scene,"yellow")),b&&(this.displayer.handles=b.create(this.camera,this.scene)),d&&(this.displayer.mesure=d.create(this.camera,this.scene)),this.initBindForThisInstance(),a.on("editionStart",this.myBind.onEditionStart),a.on("editionEnd",this.myBind.onEditionEnd),a.on("dragStart",this.myBind.onDragStart),a.on("dragging",this.myBind.onDragging),a.on("dragEnd",this.myBind.onDragEnd),a.on("refresh",this.myBind.onAfterRefresh),this.displayer.boundingLimit&&this._options.displayBoundingLimitOnHover&&(a.on("hover",this.myBind.onHover),a.on("leave",this.myBind.onLeave))};var b={displayHandleOnResize:!0,keepAnimateHandleOnResize:!1,animateHandleOnHover:!0,displayNewBoundingLimit:!0,displayBoundingLimitOnHover:!0,displayBoundingLimitOnDrag:!0,roundDimension:1,debug:!1};return a.prototype.setOptions=function(a){this._options=this._options||{},a=a||{};for(var c in b)this._options[c]="undefined"==typeof a[c]?b[c]:a[c];return this},a.prototype.askStartResize=function(a,b,c,d){return this._asker&&d==this.displayer.handles?!1:a&&!this._getPropertyName(a,b)?!1:this.master.requireHand(this)?(this._direction=b,this._pickedPoint=c,this._asker=d||this,this.myBind.onDragging(event),!0):!1},a.prototype.cancelHand=function(){this._touchedFace=null,this._direction=null,this._pickedPoint=null,this._asker=null,this.master.releaseHand(this)},a.prototype.computeDimension=function(a,b,c){var d=a.getBoundingBox(),e=d.maximum.subtract(d.minimum);e.multiplyInPlace(a.scaling,e);var f=d.center.clone(),g=a.getWorldMatrix();BABYLON.Vector3.TransformCoordinatesToRef(f,g,f);var h=this.rotationToWorld(a),i=new BABYLON.Matrix;if(h.toRotationMatrix(i),!b)return{position:f,dimension:e,rotationMatrix:i,rotationQuat:h};var j=b.scale(.5*c);BABYLON.Vector3.TransformCoordinatesToRef(j,i,j),j.addInPlace(f);var k=b.multiply(b);return k.scaleInPlace(c),k.addInPlace(e),{position:f,dimension:e,newPosition:j,newDimension:k,rotationMatrix:i,rotationQuat:h}},a.prototype.rotationToWorld=function(a){for(var b=a.getTopLevelObject(),c=new BABYLON.Quaternion(0,0,0,1),d=new BABYLON.Quaternion;a&&(BABYLON.Quaternion.RotationYawPitchRollToRef(a.rotation.y,a.rotation.x,a.rotation.z,d),c=d.multiply(c),a!=b);)a=a.parent;return c},a.prototype.getbestAxis=function(a,b,c){c=c||this._direction,b=b||this._pickedPoint||a.position;var d=hcsdesign.engine3D,e=d.scene.activeCamera,f=e.position.subtract(b),g=this.computeDimension(a).rotationMatrix.clone();g.invert(),BABYLON.Vector3.TransformCoordinatesToRef(f,g,f);for(var h=f.multiply(f).asArray(),i=c.asArray(),j=null,k=3;k--;)(null===j||h[k]>h[j])&&Math.abs(i[k])<.7&&(j=k);var l=[0,0,0];return l[j]=f.asArray()[j]<0?1:-1,BABYLON.Vector3.FromArray(l)},a.prototype._getCollider=function(){if(this._collider)return this._collider;this._objectPool=this._objectPool||{};var a=this.scene;return this._collider=BABYLON.Mesh.CreateBox("boundingboxConfigurator.collider",1,a)},a.prototype._getTouchedFace=function(a,b){var c=this._getCollider();c.isVisible=!0;var d=a.pickedMesh,e=d.getTopLevelObject(!0),f=this.computeDimension(e);c.position=f.position,c.scaling=f.dimension,c.rotationQuaternion=f.rotationQuat;var g=hcsdesign.engine3D,h=g.scene.createPickingRay(b.mstate.pos.x,b.mstate.pos.y),i=h.intersectMeshes([c],!0,!0);if(this._options.debug||(c.isVisible=!1),!i||!i.hit)return null;var j=c.getIndices(),k=c.getVerticesData(BABYLON.VertexBuffer.NormalKind),l=BABYLON.Vector3.FromArray(k,3*j[3*i.faceId]),m=g.scene.activeCamera,n=m.position.subtract(m.target);n.normalize();var o=BABYLON.Vector3.TransformNormal(l,c.getWorldMatrix());if(o.normalize(),BABYLON.Vector3.Dot(n,o)>.6)return null;var j=d.getIndices(),k=d.getVerticesData(BABYLON.VertexBuffer.NormalKind),p=BABYLON.Vector3.FromArray(k,3*j[3*a.faceId]),q=BABYLON.Vector3.TransformNormal(p,d.getWorldMatrix());return q.normalize(),BABYLON.Vector3.Dot(o,q)<.35?null:l},a.prototype._computeL=function(a,b,c,d){var e=this._getCollider();e.isVisible=!0;var f=this.computeDimension(a);e.position=c.clone(),e.rotationQuaternion=f.rotationQuat,e.scaling.x=e.scaling.y=e.scaling.z=1;var g=9e3,h=this.getbestAxis(a,c,b);h.multiplyInPlace(h),h.scaleInPlace(-g+.1);var i=new BABYLON.Vector3(g,g,g);i.addInPlace(h),e.scaling=i,e.markAsDirty();var j=hcsdesign.engine3D,k=j.scene.createPickingRay(d.mstate.pos.x,d.mstate.pos.y),l=k.intersectMeshes([e],!0,!0);if(this._options.debug||(e.isVisible=!1),!l||!l.pickedPoint)return 0;var m=f.rotationMatrix.clone();m.invert();var n=l.pickedPoint.subtract(c);BABYLON.Vector3.TransformCoordinatesToRef(n,m,n);var o=BABYLON.Vector3.Dot(n,b);return o},a.prototype._getPropertyName=function(a,b){var c=a.structure.programmableInstance.objectName,d=a.structure.programmableInstance.params;if(Math.abs(b.x)>.9)switch(c){case"Bed":return"mattress.width";case"Bath":case"GlassConsole":case"BabylonImporter":case"Light":return null;case"Tv":return"screen.width";case"PhotoFrame":case"photoFrame":return"structure.width";case"BenchIkea":return"global.width";case"spotMultiple":return"tube.width";default:return"undefined"!=typeof d.width?"width":null}if(Math.abs(b.y)>.9)switch(c){case"spotMultiple":case"Sofa":case"BabylonImporter":case"Bed":return null;case"BenchIkea":return"feet.height";case"PhotoFrame":case"photoFrame":return"structure.height";case"Tv":return"screen.height";case"Shower":return a.structure.programmableInstance.nbWall?"height":null;case"GlassConsole":return d.bar&&"undefined"!=typeof d.bar.height?"bar.height":null;case"Basic":if("undefined"!=typeof a.structure.programmableInstance.horizontal&&!a.structure.programmableInstance.horizontal)return null;default:return"undefined"!=typeof d.height?"height":null}if(Math.abs(b.z)>.9)switch(c){case"Bed":return"mattress.length";case"PhotoFrame":case"photoFrame":return"structure.depth";case"BenchIkea":return"plank.depth";case"Bath":case"BabylonImporter":case"GlassConsole":case"spotMultiple":case"Curtains":case"Tv":case"TowelDry":case"Light":return null;case"Basic":if("undefined"!=typeof a.structure.programmableInstance.horizontal)return a.structure.programmableInstance.horizontal?null:"height";default:return"undefined"!=typeof d.depth?"depth":null}},a.prototype._computePropertyValue=function(a,b,c){var d=a.structure,e=this.computeDimension(a,b,c),f=Math.abs(BABYLON.Vector3.Dot(e.dimension,b)),g=Math.abs(BABYLON.Vector3.Dot(e.newDimension,b)),h=ujs.setProperty(d.programmableInstance.params,this._getPropertyName(a,b))||0,i=g-(f-h);return i=Math.abs(b.y)>.9?Math.max(1,i):Math.abs(i)},a.prototype._roundL=function(a){return Math.round(a/this._options.roundDimension)*this._options.roundDimension},a.prototype._enlargeYourObject=function(a,b,c){if(!(Math.abs(c)<1e-4)){var d=a.structure,e=hcsdesign.getComponentByName("EditionComponent3D"),f={},g=this._getPropertyName(a,b),h=this._roundL(this._computePropertyValue(a,b,c));f["programmableInstance.params."+g]={newValue:h,exValue:ujs.getProperty(d.programmableInstance.params,g)},ujs.setProperty(d.programmableInstance.params,g,h);var i=BABYLON.Matrix.RotationYawPitchRoll(a.rotation.y,a.rotation.x,a.rotation.z),j=new BABYLON.Vector3(.5*c*b.x,0,.5*c*b.z);BABYLON.Vector3.TransformCoordinatesToRef(j,i,j),j.addInPlace(a.position),f.position={newValue:j.clone(),exValue:a.position.clone()},a.position.copyFrom(j),e.refreshObject(a,{modifiedProperties:f}),ujs.notify("hcs.request.saveHistory")}},a.prototype.handlers={onDragStart:function(a){a.collided&&a.collided.pickedMesh&&(this._touchedFace=this._getTouchedFace(a.collided,a),this._touchedFace&&(this.displayer.handles&&!this._options.keepAnimateHandleOnResize&&this.displayer.handles.stopAnimeHandle(),this.displayer.handles&&!this._options.displayHandleOnResize&&this.displayer.handles.dispose(),this.askStartResize(this.object,this._touchedFace,a.collided.pickedPoint)))},onDragEnd:function(a){if(this._direction){this.myBind.onDragging(a);var b=this._roundL(this._l);this._enlargeYourObject(this.object,this._direction,b),this.displayer.boundingLimit&&this.displayer.boundingLimit.hide(),this.displayer.boundingLimitNew&&this.displayer.boundingLimitNew.hide(),this.displayer.mesure&&this.displayer.mesure.hide(),this.displayer.handles&&this.displayer.handles.dispose(),this._direction=null,this.master.releaseHand(this)}},onDragging:function(a){if(this._direction){this._l=this._computeL(this.object,this._direction,this._pickedPoint,a);var b=this._roundL(this._l);this.displayer.boundingLimit&&this._options.displayBoundingLimitOnDrag&&this.displayer.boundingLimit.display(this.object,this._direction,0),this.displayer.boundingLimitNew&&this._options.displayBoundingLimitOnDrag&&this.displayer.boundingLimitNew.display(this.object,this._direction,b),this.displayer.handles&&this._options.displayHandleOnResize&&this.displayer.handles.placeHandleOnObject(this.object,this._direction,b),this.displayer.mesure&&this.displayer.mesure.display(this.object,this._direction,this._pickedPoint,b)}},onHover:function(a){return this._touchedFace=this._getTouchedFace(a.collided,a),this._touchedFace&&this._getPropertyName(this.object,this._touchedFace)&&this.master.requireHand(this)?(this.displayer.boundingLimit&&this._options.displayBoundingLimitOnHover&&this.displayer.boundingLimit.display(this.object,this._touchedFace),this.displayer.handles&&this._options.animateHandleOnHover&&(this._previousHoverFace&&BABYLON.Vector3.Dot(this._previousHoverFace,this._touchedFace)<.9&&this.displayer.handles.stopAnimeHandle(),this.displayer.handles.startAnimeHandle(this._touchedFace)),void(this._previousHoverFace=this._touchedFace)):this.myBind.onLeave(a)},onLeave:function(){this.displayer.boundingLimit.hide(),this.displayer.handles&&this.displayer.handles.stopAnimeHandle(),this._previousHoverFace=this._touchedFace=null,this.master.releaseHand(this)},onAfterRefresh:function(){this.displayer.handles&&this.displayer.handles.start(this.object)},onEditionStart:function(a){this.object=a.furniture,this.displayer.handles&&this.displayer.handles.start(this.object)},onEditionEnd:function(){this.displayer.handles&&this.displayer.handles.stop(),this.displayer.boundingLimit&&this.displayer.boundingLimit.hide(),this.displayer.boundingLimitNew&&this.displayer.boundingLimitNew.hide(),this.displayer.mesure&&this.displayer.mesure.hide(),this._direction=null,this.master.releaseHand(this),this.object=null}},a}(),HandlesDisplayerForDimensionReshaperFactoryComponent3D=function(){var a=function(a){BaseComponent3D.call(this,a,"HandlesDisplayerForDimensionReshaperFactoryComponent3D")};a.prototype=new BaseComponent3D,a.prototype.create=function(a,c){var d=new b;return d.initialize(a,c),d};var b=function(){};return b.prototype.initialize=function(a,b){this.scene=b,this.camera=a,this.dimensionConfigurator=hcsdesign.getComponentByName("DimensionReshaperComponent3D"),this._spriteManager=new BABYLON.SpriteManager("handleMgr",hcs.Assets.toolbarTextures.arrowTexture,6,128,this.scene),this._sprite={},this._animated={},this._availableHandles={},this.initBindForThisInstance()},b.prototype.initBindForThisInstance=function(){if(this.myBind)return this;var a=this;this.myBind={};for(var b in this.handlers)(function(){var c=a.handlers[b];a.myBind[b]=function(b){c.call(a,b)}})();return this},b.prototype.start=function(a){this.stop(),this.object=a,this._computeAvailableHandles(a),document.addEventListener("hcs.engine3D.camera.move",this.myBind.onCameraMove),document.addEventListener("hcs.engine3D.drag-start",this.myBind.onMouseDown),this.myBind.onCameraMove()},b.prototype.stop=function(){document.removeEventListener("hcs.engine3D.camera.move",this.myBind.onCameraMove),document.removeEventListener("hcs.engine3D.drag-start",this.myBind.onMouseDown),this.dispose()},b.prototype.startAnimeHandle=function(a){var b=2*Math.abs(a.y)+4*Math.abs(a.z)+(a.x+a.z+a.y<0?0:1);if(!this._animated[b]){var c=this.scene;c.beginAnimation(this._getHandle(b),0,100,!0,3),this._animated[b]=!0}},b.prototype.stopAnimeHandle=function(a){if(a){var b;if(b="string"==typeof a?a:2*Math.abs(a.y)+4*Math.abs(a.z)+(a.x+a.z+a.y<0?0:1),this._sprite[b]&&this._animated[b]){var c=this.scene;c.stopAnimation(this._sprite[b]),this._animated[b]=!1,this._sprite[b].animations&&this._sprite[b].animations.length&&this._sprite[b].position.copyFrom(this._sprite[b].animations[0]._keys[0].value)}}else for(var d in this._sprite)this.stopAnimeHandle(d+"")},b.prototype.placeHandleOnObject=function(a,b,c){var d=this.dimensionConfigurator.computeDimension(a,b||new BABYLON.Vector3(0,0,0),c||0);return this.placeHandles(d.newPosition,d.newDimension,d.rotationMatrix)},b.prototype.placeHandles=function(a,b,c){var d=this.camera,e=new BABYLON.Vector3,f=new BABYLON.Vector3,g=new BABYLON.Vector3,h=d.getViewMatrix().clone();h.m[12]=h.m[13]=h.m[14]=0;for(var i=d.position.subtract(d.target).normalize(),j=15,k=0;6>k;k++)if(2!=k&&this._availableHandles[k]){var l=[0,0,0];if(l[k>>1]=k%2?1:-1,BABYLON.Vector3.FromArrayToRef(l,0,e),BABYLON.Vector3.TransformCoordinatesToRef(e,c,g),Math.abs(BABYLON.Vector3.Dot(g,i))<.6){f.x=e.x*(.5*b.x+j),f.y=e.y*(.5*b.y+j),f.z=e.z*(.5*b.z+j),BABYLON.Vector3.TransformCoordinatesToRef(f,c,f),f.addInPlace(a);var m=this._getHandle(k+"",f,g);m.position.copyFrom(f),BABYLON.Vector3.TransformCoordinatesToRef(g,h,e),m.angle=Math.atan2(e.y,e.x)}else this._disposeHandle(k+"")}},b.prototype.dispose=function(){this._disposeHandle()},b.prototype._disposeHandle=function(a){if("undefined"!=typeof a)this._sprite[a]&&(this.stopAnimeHandle(a),this._sprite[a].dispose(),this._sprite[a]=null);else for(var b in this._sprite)this._disposeHandle(b)},b.prototype._getHandle=function(a,b,c){if(this._sprite[a])return this._sprite[a];if(this.scene,this._sprite[a]=new BABYLON.Sprite("handle_"+a,this._spriteManager),this._sprite[a].size=20,b&&c){var d=new BABYLON.Animation("jump_handle_animation","position",60,BABYLON.Animation.ANIMATIONTYPE_VECTOR3,BABYLON.Animation.ANIMATIONLOOPMODE_CYCLE),e=b.clone(),f=c.scale(10);f.addInPlace(e),d.setKeys([{frame:0,value:e},{frame:50,value:f},{frame:100,value:e}]),this._sprite[a].animations=this._sprite[a].animations||[],this._sprite[a].animations.push(d)}return this._sprite[a]},b.prototype._computeAvailableHandles=function(a){this._availableHandles={};for(var b=new BABYLON.Vector3,c=0;6>c;c++)if(2!=c){var d=[0,0,0];d[c>>1]=c%2?1:-1,BABYLON.Vector3.FromArrayToRef(d,0,b),this._availableHandles[c]=!!this.dimensionConfigurator._getPropertyName(a,b)}},b.prototype.handlers={onCameraMove:function(){var a=this.object;this.placeHandleOnObject(a)},onMouseDown:function(a){var b=[];for(var c in this._sprite||{})this._sprite[c]&&b.push(this._sprite[c]._colliderMesh);var d=hcsdesign.engine3D,e=d.scene.createPickingRay(a.mstate.pos.x,a.mstate.pos.y),f=e.intersectMeshes(b,!0,!0);if(f&&f.pickedMesh){var c=parseInt(f.pickedMesh.name.match(/[0-9]*$/)[0]),g=[0,0,0];g[c>>1]=c%2?1:-1,this.dimensionConfigurator.askStartResize(this.object,BABYLON.Vector3.FromArray(g),f.pickedMesh.position.clone(),this)}}},a}(),BoundingLimitDisplayerForDimensionReshaperFactoryComponent3D=function(){var a=function(a){BaseComponent3D.call(this,a,"BoundingLimitDisplayerForDimensionReshaperFactoryComponent3D")};a.prototype=new BaseComponent3D,a.prototype.create=function(a,c,d){var e=new b;return e.initialize(a,c,d),e};var b=function(){};return b.prototype.initialize=function(a,b,c){if(this.scene=b,this.camera=a,this.dimensionConfigurator=hcsdesign.getComponentByName("DimensionReshaperComponent3D"),"undefined"==typeof c&&(c="green"),"string"==typeof c){var d,e=new BABYLON.StandardMaterial("texture_dimension_configurator_placeholder",b);switch(c){case"yellow":d=(new BABYLON.Color3).fromHex(hcs.Assets.complementaryUIColor);break;default:d=(new BABYLON.Color3).fromHex(hcs.Assets.mainUIColor)}hcs.MaterialFactory.MakeBasicColor(e,d),e.backFaceCulling=!1,e.alpha=.6,c=e}return this.mat=c,this},b.prototype._getBoundingLimitGhost=function(){if(this._boundingLimitGhost)return this._boundingLimitGhost;var a=this.scene;return this._boundingLimitGhost=BABYLON.Mesh.CreateBox("boundingboxConfigurator.boundingLimitGhost",1,a),this._boundingLimitGhost.material=this.mat,this._boundingLimitGhost},b.prototype.display=function(a,b,c){c=c||0;var d=this._getBoundingLimitGhost();d.isVisible=!0;var e=this.dimensionConfigurator.computeDimension(a);e.dimension.scaleInPlace(1.01),d.position=e.position,d.rotationQuaternion=e.rotationQuat,d.scaling=e.dimension;var f=.5,g=new BABYLON.Vector3(.5*f+.5*e.dimension.x+c,.5*f+.5*e.dimension.y+c,.5*f+.5*e.dimension.z+c);g.multiplyInPlace(b),BABYLON.Vector3.TransformCoordinatesToRef(g,e.rotationMatrix,g),d.position.addInPlace(g);var h=new BABYLON.Vector3(f-e.dimension.x,f-e.dimension.y,f-e.dimension.z);h.multiplyInPlace(b),h.multiplyInPlace(b),d.scaling.addInPlace(h),d.markAsDirty()},b.prototype.hide=function(){var a=this._getBoundingLimitGhost();a.isVisible=!1},b.prototype.dispose=function(){this._boundingLimitGhost.remove(),this._boundingLimitGhost=null},a}(),MesureDisplayerForDimensionReshaperFactoryComponent3D=function(){var a=function(a){BaseComponent3D.call(this,a,"MesureDisplayerForDimensionReshaperFactoryComponent3D")};a.prototype=new BaseComponent3D,a.prototype.create=function(a,c){var d=new b;return d.initialize(a,c),d};var b=function(){};return b.prototype.initialize=function(a,b){return this.camera=a,this.scene=b,this.dimensionConfigurator=hcsdesign.getComponentByName("DimensionReshaperComponent3D"),this},b.prototype.hide=function(){this._cote&&(this._cote.plan.isVisible=!1)},b.prototype.dispose=function(){this._cote.plan.dispose(),this._cote.texture.dispose(),this._cote=null},b.prototype.display=function(a,b,c,d){var e=this._getCote();e.plan.isVisible=!0;var f=this.dimensionConfigurator.computeDimension(a,b,d),g=this.dimensionConfigurator.getbestAxis(a,c,b),h=b.clone(),i=BABYLON.Vector3.Cross(g,h),j=hcsdesign.engine3D,k=j.scene.activeCamera,l=k.target.subtract(k.position),m=BABYLON.Vector3.TransformCoordinates(i,f.rotationMatrix);BABYLON.Vector3.Dot(m,l)>0&&i.scaleInPlace(-1),m=BABYLON.Vector3.TransformCoordinates(i,f.rotationMatrix);var n=(BABYLON.Vector3.TransformCoordinates(h,f.rotationMatrix),BABYLON.Quaternion.RotationFromXtoX_2(new BABYLON.Vector3(0,1,0),i,new BABYLON.Vector3(0,0,1),g)),o=f.rotationQuat,p=o.multiply(n);e.plan.rotationQuaternion=p;var q=k.getViewMatrix().clone();q.m[12]=q.m[13]=q.m[14]=0;var r=BABYLON.Vector3.TransformCoordinates(m,q);Math.abs(r.x)>Math.abs(r.y)?r.y=0:r.x=0;var s=(Math.floor(Math.atan2(r.y,r.x)/(Math.PI/2))+3)%4,t=Math.abs(f.newDimension.dot(h));t=this.dimensionConfigurator._roundL(t),this._writeCote(t,s,l.length()),e.plan.position=f.newPosition.clone();var u=new BABYLON.Vector3(.5*f.newDimension.x+.5*e.plan.scaling.y,.5*f.newDimension.y+.5*e.plan.scaling.y,.5*f.newDimension.z+.5*e.plan.scaling.y).multiply(i);BABYLON.Vector3.TransformCoordinatesToRef(u,f.rotationMatrix,u),e.plan.position.addInPlace(u);var v=f.rotationMatrix.clone();v.invert();var w=c.subtract(f.newPosition);BABYLON.Vector3.TransformCoordinatesToRef(w,v,w),w=w.multiply(g).multiply(g),BABYLON.Vector3.TransformCoordinatesToRef(w,f.rotationMatrix,w),e.plan.position.addInPlace(w)},b.prototype._resizeAndComputeRatio=function(a,b){var c=this._getCote(),d=c.texture.getSize(),e=Math.min(d.width/a,d.height/b);return c.plan.scaling.x=d.width/e,c.plan.scaling.y=c.plan.scaling.x*d.height/d.width,e},b.prototype._getCote=function(){if(this._cote)return this._cote;var a=this.scene,b=BABYLON.Mesh.CreatePlane("cote_plan",1,a);b.scaling.x=1e3,b.scaling.y=1e3;var c=new BABYLON.StandardMaterial("cote_texture",a);hcsdesign.engine3D.scene.getEngine().getCaps().maxAnisotropy=128;var d=new BABYLON.DynamicTexture("cote_texture",{width:512,height:256},a,!0);return d.hasAlpha=!0,c.diffuseTexture=d,c.useAlphaFromDiffuseTexture=!0,b.material=c,this._cote={texture:d,plan:b}},b.prototype._writeCote=function(a,b,c){var d=this._getCote(),e=d.texture.getContext();e.save();var f=.5,g=.08,h=1.65,i=.3,j=4*(2+c/300),k=!1,l=d.texture.getSize(),m=(Math.round(a)+" cm").replace(/\d/g,"0");e.font="normal "+1e3*f+"pt calibri";var n=e.measureText(m).width/1e3;e.font="normal "+700*f+"pt calibri",n+=e.measureText(".00").width/1e3,k=(b%2==0?n:2*f)*j>a-2*i*j;var o=j*((k?1.5*f:0)+(b%2==1?n+h:h+2*f)),p=this._resizeAndComputeRatio(a,o);2*i*j>.6*a&&(i*=.6*a/(2*i*j)),e.save(),e.clearRect(0,0,l.width,l.height),e.lineWidth=g*j*p,e.strokeStyle="#000000",e.fillStyle="#000000",e.font="normal "+f*j*p+"pt calibri",n*=p*j;var q=b%2==1?f*j*p*1.4:1.01*n,r=l.height-h*j*p-f*p*j,s=.5*l.width-.5*a*p+g*j*p,t=.5*l.width+.5*a*p-g*j*p;k?(e.beginPath(),e.moveTo(s,r),e.lineTo(t,r),e.stroke()):(e.beginPath(),e.moveTo(s,r),e.lineTo((s+t)/2-q/2,r),e.stroke(),e.beginPath(),e.moveTo(t,r),e.lineTo((s+t)/2+q/2,r),e.stroke()),e.beginPath(),e.moveTo(s+i*p*j,r+i*p*j),e.lineTo(s,r),e.lineTo(s+i*p*j,r-i*p*j),e.stroke(),e.beginPath(),e.moveTo(t-i*p*j,r+i*p*j),e.lineTo(t,r),e.lineTo(t-i*p*j,r-i*p*j),e.stroke(),e.globalAlpha=.7,e.lineWidth=.5*g*j*p,e.beginPath(),e.moveTo(s-.5*g*j*p,r+.1*(l.height-r)),e.lineTo(s-.5*g*j*p,r+.9*(l.height-r)),e.stroke(),e.lineWidth=.5*g*j*p,e.beginPath(),e.moveTo(t+.5*g*j*p,r+.1*(l.height-r)),e.lineTo(t+.5*g*j*p,r+.9*(l.height-r)),e.stroke(),e.globalAlpha=1;var u=b*Math.PI/2;e.translate((s+t)/2,r-(k?f*j*p*1.5:0)),e.rotate(u),1==b&&e.translate(f*j*p-n/2,0),3==b&&e.translate(-f*j*p+n/2,0),e.translate(-n/2,f*j*p*.5);var v=(a>>0)+"";e.fillText(v,0,0),e.translate(e.measureText(v).width,0);var v="."+Math.floor(a%1*100);v=2==v.length?v+"0":v,e.font="normal "+f*j*p*.7+"pt calibri",e.fillText(v,0,0),e.translate(e.measureText(v).width,0);var v=" cm";e.font="normal "+f*j*p+"pt calibri",e.fillText(v,0,0),e.restore(),d.texture.update()},a}(),MagnetismComponent2D=function(){var a=function(a){BaseComponent2D.call(this,a,"MagnetismComponent2D"),this.priority=100,this._precision=10,this._draggedWall=null,this._magnetism=[],this._wallCandidates=[],this._wallFirstPoint=null,this._virtualPoints={},this.core.engine2D.registerEventCb("MagnetismComponent2D.dynamic-draw",0,"dynamic-draw",255-this.core.engine2D.MODE_CONTEXTMENU-this.core.engine2D.MODE_NORMAL,null,this.onDynamicDraw.bind(this),null),this.core.engine2D.registerEventCb("MagnetismComponent2D.point-mag.mouse-move",this.priority,"mouse-move",null,null,this.onPointMagMove.bind(this),null),this.core.engine2D.registerEventCb("MagnetismComponent2D.point-mag.drag-start",this.priority,"drag-start",null,null,this.onPointMagDragStart.bind(this),null),this.core.engine2D.registerEventCb("MagnetismComponent2D.point-mag.click",this.priority,"click",null,null,this.onPointMagClick.bind(this),null),this.core.engine2D.registerEventCb("MagnetismComponent2D.wall-mag.drag-start",this.priority,"drag-start",null,null,this.onWallMagDragStart.bind(this),null)};return a.prototype=new BaseComponent2D,a.prototype.addVirtualPoint=function(a,b){if(this._virtualPoints[a]||(this._virtualPoints[a]=[]),b instanceof PointStructure)return this._virtualPoints[a].push(b),this._virtualPoints[a].length-1;if(b instanceof BABYLON.Vector2){var c=new PointStructure;return c.position=b,this._virtualPoints[a].push(c),this._virtualPoints[a].length-1}Logger.error("Error: MagnetismComponent2D.addVirtualPoint: `point` is neither a `PointStructure` neither a `BABYLON.Vector3`.")},a.prototype.removeVirtualPoint=function(a,b){this._virtualPoints[a]&&(null==b?this._virtualPoints[a].length=0:delete this._virtualPoints[a][b])},a.prototype.applyPointMag=function(a){this._magFromPoint(a)},a.prototype._shortCircuitMagnetism=function(a){return(a.modifiers&a.MODIFIER_CTRL)>1?!0:!1},a.prototype._magFromPoint=function(a,b){if(!this._shortCircuitMagnetism(a)){var c=(this.core.engine2D.getTranslation(),this.core.engine2D.getZoom()),d=this._precision/Math.sqrt(c),e=this.structure.getCurrentStructure().getElements("points").slice(0);for(var f in this._virtualPoints)if(this._virtualPoints[f].constructor===Array)for(var g in this._virtualPoints[f])e.push(this._virtualPoints[f][g]);var h=!1,i=!1;for(var g in e){if(b instanceof PointStructure){if(e[g]==b)continue;var j=!1;for(var k in b.parents)if(!j&&b.parents[k]instanceof WallStructure&&b.parents[k].attachedPoints)for(var l in b.parents[k].attachedPoints)if(b.parents[k].attachedPoints[l]==e[g]){j=!0;break}if(j)continue}if((!h&&Math.abs(e[g].position.x-a.planPos.x)<=d||h&&Math.abs(e[g].position.x-a.planPos.x)<1)&&(a.planPos.x=e[g].position.x,this._magnetism.push([e[g].position,a.planPos]),h=!0),(!i&&Math.abs(e[g].position.y-a.planPos.y)<=d||i&&Math.abs(e[g].position.y-a.planPos.y)<1)&&(a.planPos.y=e[g].position.y,this._magnetism.push([e[g].position,a.planPos]),i=!0),h&&i)break}this.core.engine2D.requestDynamicDraw()}},a.prototype._globalWallMag=function(a,b){var c,d,e=Math.PI/150,f=30,g=this.structure.getCurrentStructure().getElements("walls"),h=new BABYLON.Vector2,i=a.getWallVector().normalize(),j=b.planPos.clone();j.subtractInPlace(a.getPoints(0).position);for(var k=j.clone().projectOnVector(i),l=j.subtractInPlace(k),m=a.getPoints(0).position.add(l),n=(a.getPoints(1).position.add(l),function(a,b){return b?h.copyFrom(a).addInPlace(b).subtractInPlace(m).normalize():h.copyFrom(a).subtractInPlace(m).normalize(),c=h.determinant(i),Math.abs(c)<e}),o=function(a,b){var c=Math.PI/100,d=a.getWallVector(),e=b.getWallVector(),f=Math.atan(d.y,d.x)-Math.atan(e.y,e.x);return Math.abs(f)<c||Math.abs(f+Math.PI)<c||Math.abs(f-Math.PI)<c||Math.abs(f+2*Math.PI)<c||Math.abs(f-2*Math.PI)<c},p=function(c,d){var e=c.getWallVector(),g=a.getNormalVector(),h=d?a.getPoints(0).position.add(d):a.getPoints(0).position.clone(),i=(e.determinant(c.getPoints(0).position)-e.determinant(h))/e.determinant(g);return g.scaleInPlace(i),Math.abs(i)<f?(b.forcePosition=d?g.add(h).addInPlace(d):g.add(h),!0):!1}.bind(this),q=0,r=g.length;r>q;q++)if(g[q]!=a&&o(g[q],a)){if((n(g[q].getPoints(0).position)||n(g[q].getPoints(1).position))&&p(g[q]))return;if(g[q].thickness>a.thickness){if(d=g[q].getNormalVector((g[q].thickness-a.thickness)/2),(n(g[q].getPoints(0).position,d)||n(g[q].getPoints(1).position,d))&&p(g[q],d))return;if(d.scaleInPlace(-1),(n(g[q].getPoints(0).position,d)||n(g[q].getPoints(1).position,d))&&p(g[q],d))return}}},a.prototype._magFromWalls=function(a,b){var c=Math.PI/18;if(!this._shortCircuitMagnetism(a)&&this._wallFirstPoint){for(var d,e=(this.core.engine2D.getTranslation(),this.core.engine2D.getZoom()),f=(this._precision/Math.sqrt(e),b||this.structure.getCurrentStructure().getElements("walls"),a.planPos.x-this._wallFirstPoint.x),g=a.planPos.y-this._wallFirstPoint.y,h=Math.atan2(g,f),i=0,j=this._wallCandidates.length;j>i;i++)if(d=Math.abs(this._wallCandidates[i].angle-h)%(Math.PI/2),c>d||Math.PI/2-d<c){var k;d=Math.abs((this._wallCandidates[i].angle-h)%Math.PI),k=d<Math.PI/4||d>3*Math.PI/4?0:Math.PI/2,k+=this._wallCandidates[i].angle;var l=Math.cos(k),m=Math.sin(k),n=new BABYLON.Vector2(l,m),o=new BABYLON.Vector2(f,g),p=o.clone().projectOnVector(n);a.planPos.copyFrom(p).addInPlace(this._wallFirstPoint);break}this.core.engine2D.requestDynamicDraw()}},a.prototype.onDynamicDraw=function(a,b,c){a.lineWidth=2,a.strokeStyle="#009900";for(var d in this._magnetism){var e=this._magnetism[d][0].scale(c).addInPlace(b),f=this._magnetism[d][1].scale(c).addInPlace(b);a.beginPath(),a.moveTo(Math.round(e.x),Math.round(e.y)),a.lineTo(Math.round(f.x),Math.round(f.y)),a.stroke(),a.closePath()}this._magnetism=[]},a.prototype.onPointMagMove=function(a,b,c){this.core.engine2D.getMode()==this.core.engine2D.MODE_DRAW&&(this._magFromPoint(c),this._magFromWalls(c))},a.prototype.onPointMagDragStart=function(a,b,c,d){(b instanceof PointStructure||this.core.engine2D.getMode()==this.core.engine2D.MODE_DRAW)&&(this.onPointMagClick(a,b,c,d),this.core.engine2D.registerEventCb("MagnetismComponent2D.point-mag.draging",this.priority,"dragging",this.core.engine2D.MODE_DRAG,null,this.onPointMagDragging.bind(this),b),this.core.engine2D.registerEventCb("MagnetismComponent2D.point-mag.drag-end",this.priority,"drag-end",this.core.engine2D.MODE_DRAG,null,this.onPointMagClick.bind(this),b))},a.prototype.onPointMagDragging=function(a,b,c,d){this._magFromPoint(c,d),this._magFromWalls(c,d)},a.prototype.onPointMagClick=function(a,b,c){if(b instanceof PointStructure)this._magFromPoint(c,b),this._magFromWalls(c);else{if(b instanceof WallStructure&&this.core.engine2D.getMode()==this.core.engine2D.MODE_NORMAL)return;this._magFromPoint(c),this._magFromWalls(c)}},a.prototype.onWallMagDragStart=function(a,b){return b instanceof WallStructure?(this.core.engine2D.registerEventCb("MagnetismComponent2D.wall-mag.dragging",this.priority,"dragging",null,null,this.onWallMagDragging.bind(this),null),void(this._draggedWall=b)):void(this._draggedWall=null)
},a.prototype.onWallMagDragging=function(a,b,c){this._draggedWall&&this._globalWallMag(this._draggedWall,c)},a.prototype.onWallDrawStart=function(a){var b=this.structure.getCurrentStructure().getElements("walls"),c=15;this._wallCandidates.length=0,this._wallFirstPoint=a.position;for(var d=0,e=b.length;e>d;d++)if(b[d].distanceFrom(this._wallFirstPoint)<c){var f=b[d].getWallVector();this._wallCandidates.push({wall:b[d],angle:Math.atan2(f.y,f.x)})}},a.prototype.onWallDrawEnd=function(){this._wallFirstPoint=null},a}(),MagnetismComponent3D=function(){var a,b,c=!1,d=function(c){BaseComponent3D.call(this,c,"MagnetismComponent3D"),this._lastPosition=new BABYLON.Vector3,this._lastFictivePosition=new BABYLON.Vector3,this._speedVector=new BABYLON.Vector3,this._physicSpeedVector=new BABYLON.Vector3,this._correctedSpeedVector=new BABYLON.Vector3,this._tmpVector=new BABYLON.Vector3,b=hcsdesign.engine3D.searchComponent("EditionComponent3D"),a=this,this.collisionList=[],this.currentCollisionBox=null},e=.1,f=function(a,b){if(b)a.getWorldMatrix(),this.box=new BABYLON.BoundingBox(b.minimum,b.maximum),this.box.angle=b.angle;else{var c=a.getBoundingBox(!0);this.box=new BABYLON.BoundingBox(c.minimum,c.maximum)}this.object=a,a.structure&&(this.object.magnetismCollider=a.structure.magnetismCollider),this.corner=[new BABYLON.Vector3,new BABYLON.Vector3,new BABYLON.Vector3,new BABYLON.Vector3],this.axis=[new BABYLON.Vector3,new BABYLON.Vector3],this.origin=[0,0],this.yRange=[0,0],this.object.structure&&this.object.structure.easeMagnetism&&this.correctSmallBoxes(),this.update()},g=[];f.prototype.showBox=function(){if(!this._debugCube){var a=hcsdesign.engine3D.scene;this._debugCube=BABYLON.Mesh.CreateBox("boundingboxConfigurator.boundingLimitGhost",1,a),this._debugCube.material=new BABYLON.StandardMaterial("BB_debug",a),this._debugCube.material.wireframe=!0,this._debugCube.material.alpha=.29,g.push(this._debugCube)}for(var b=this._debugCube,c=new BABYLON.Vector3(0,0,0),d=4;d--;)c.addInPlace(this.corner[d]);c.scaleInPlace(.25),c.y=(this.yRange[1]+this.yRange[0])/2;var e=this.corner[0].subtract(this.corner[1]),f=this.corner[2].subtract(this.corner[1]);b.position.copyFrom(c),b.scaling.x=e.length(),b.scaling.z=f.length(),b.scaling.y=this.yRange[1]-this.yRange[0],b.rotation.y=-Math.atan2(e.z,e.x)},f.prototype.correctSmallBoxes=function(){var a=this.object.structure.preferredYAngle||0,b=new BABYLON.Vector3(0,0,1);b=BABYLON.Vector3.TransformCoordinates(b,BABYLON.Matrix.RotationAxis(new BABYLON.Vector3(0,1,0),a)),b.scaleInPlace(80),this.corner[0].copyFromFloats(this.box.minimum.x,this.box.minimum.y,this.box.minimum.z),this.corner[1].copyFromFloats(this.box.maximum.x,this.box.minimum.y,this.box.minimum.z),this.corner[2].copyFromFloats(this.box.maximum.x,this.box.minimum.y,this.box.maximum.z),this.corner[3].copyFromFloats(this.box.minimum.x,this.box.minimum.y,this.box.maximum.z);for(var c=0;4>c;c++)this.corner[c].addInPlace(b),BABYLON.BoundingBox.ExpandFromPoint(this.corner[c],this.box.minimum,this.box.maximum)},f.prototype.update=function(){if(this.object.computeWorldMatrix(!0),BABYLON.Vector3.TransformCoordinatesFromFloatsToRef(this.box.minimum.x,this.box.minimum.y,this.box.minimum.z,this.object.getWorldMatrix(),this.corner[0]),BABYLON.Vector3.TransformCoordinatesFromFloatsToRef(this.box.maximum.x,this.box.minimum.y,this.box.minimum.z,this.object.getWorldMatrix(),this.corner[1]),BABYLON.Vector3.TransformCoordinatesFromFloatsToRef(this.box.maximum.x,this.box.minimum.y,this.box.maximum.z,this.object.getWorldMatrix(),this.corner[2]),BABYLON.Vector3.TransformCoordinatesFromFloatsToRef(this.box.minimum.x,this.box.minimum.y,this.box.maximum.z,this.object.getWorldMatrix(),this.corner[3]),this.box.angle){var a=-this.box.angle,b=this.box.center;b.y=0;for(var d=BABYLON.Matrix.FromValues(Math.cos(a),0,Math.sin(a),0,0,1,0,0,-Math.sin(a),0,Math.cos(a),0,0,0,0,1),e=0;4>e;e++)this.corner[e].subtractInPlace(b),BABYLON.Vector3.TransformCoordinatesToRef(this.corner[e],d,this.corner[e]),this.corner[e].addInPlace(b)}this.axis[0].copyFrom(this.corner[1]),this.axis[0].subtractInPlace(this.corner[0]),this.axis[1].copyFrom(this.corner[3]),this.axis[1].subtractInPlace(this.corner[0]);for(var e=0;2>e;e++)0==this.axis[e].lengthSquared()&&(this.axis[e].copyFrom(this.axis[(e+1)%2].cross(new BABYLON.Vector3(0,1,0))),this.axis[e].normalize().scaleInPlace(.1));for(var f,e=0;2>e;e++)f=this.axis[e].lengthSquared(),0!=f?this.axis[e].scaleInPlace(1/f):this.axis[e]=new BABYLON.Vector3(0,0,0),this.origin[e]=this.corner[0].dot(this.axis[e]);this.yRange=[BABYLON.Vector3.TransformCoordinates(this.box.minimum,this.object.getWorldMatrix()).y,BABYLON.Vector3.TransformCoordinates(this.box.maximum,this.object.getWorldMatrix()).y],c&&this.showBox()},f.prototype.overlaps1Way=function(a,b,c){for(var d,f,g,h=1/0,i=0,j=null,k=0;2>k;k++){c&&(g=c.dot(this.axis[k]));for(var l=a.corner[0].dot(this.axis[k]),m=1/this.axis[k].length(),n=l,o=l,p=1;4>p;p++)l=a.corner[p].dot(this.axis[k]),n>l?n=l:l>o&&(o=l);if(n>1+this.origin[k]||o<this.origin[k])return!1;d=(this.origin[k]+1-n)*m,f=(o-this.origin[k])*m,i=c&&Math.abs(g)>e?g>0?d:-f:d>f?-f:d,Math.abs(i)<Math.abs(h)&&(j=this.axis[k],h=i)}return b&&(b.overlapAxis=j,b.overlapValue=h),!0},f.prototype.overlaps=function(a){return this.overlaps1Way(a)&&a.overlaps1Way(this)},f.prototype.worstOverlap=function(a,b){var c={},d={},e=this.overlaps1Way(a,c,b),f=a.overlaps1Way(this,d,b?b.clone().scaleInPlace(-1):null);return e||f?Math.abs(c.overlapValue)<Math.abs(d.overlapValue)?c:(d.overlapValue=-d.overlapValue,d):null};var h=function(a,b){var c=9999;this.box={minimum:new BABYLON.Vector3(-c,a,-c),maximum:new BABYLON.Vector3(c,b,c),angle:0,center:new BABYLON.Vector3(0,(a+b)/2,0)},this.object={getWorldMatrix:function(){return BABYLON.Matrix.Identity()},computeWorldMatrix:function(){},name:""},this.corner=[];for(var d=4;d--;)this.corner.push(new BABYLON.Vector3);this.axis=[];for(var d=2;d--;)this.axis.push(new BABYLON.Vector3);this.origin=[];for(var d=2;d--;)this.origin.push(new BABYLON.Vector3);this.update()};return h.prototype.overlaps1Way=f.prototype.overlaps1Way,h.prototype.worstOverlap=f.prototype.worstOverlap,h.prototype.overlaps=f.prototype.overlaps,h.prototype.showBox=f.prototype.showBox,h.prototype.update=f.prototype.update,d.prototype=Object.create(BaseComponent3D.prototype),d.prototype.initialize=function(){b||(b=hcsdesign.engine3D.searchComponent("EditionComponent3D"))},d.prototype.buildCollisionList=function(b){var d=a.getFloor();if(c)for(;g.length;)g.shift().dispose();this.collisionList.length=0;for(var e=function(a){if(a.structure&&(a.magnetismCollider=a.structure.magnetismCollider),a.magnetismCollider&(hcs.Constants.MAGNETISM.OBJECT|hcs.Constants.MAGNETISM.VERTICAL))a.getBoundingBox(!0),this.collisionList.push(new f(a));else if(-1!=a.name.indexOf("WallMesh_")&&b.magnetismCollider&hcs.Constants.MAGNETISM.WALL)for(var c in a.boundingBoxes)"OvertureStructure"!==a.objectInstances[c].name&&"SubSlopeStructure"!==a.objectInstances[c].name&&this.collisionList.push(new f(a,a.boundingBoxes[c]))}.bind(this),i=d.getChildren(),j=0,k=i.length;k>j;j++)if(-1!=i[j].name.indexOf("group_")){if(i[j].name!=b.name)for(var l=i[j].getChildren(),m=0,n=l.length;n>m;m++)e(l[m])}else e(i[j]);var o=a.getFloor().structure;this.collisionList.push(new h(o.elevation-20,o.elevation+5)),this.collisionList.push(new h(o.elevation+o.height,o.elevation+o.height+20))},d.prototype.updateCollisionList=function(a){for(var b=0,c=this.collisionList.length;c>b;b++)(!a||a&&a==this.collisionList[b])&&this.collisionList[b].update()},d.prototype.onContextChanged=function(a){"3D"==a?this.initialized||(b.on("selectObject",this.onDragStart.bind(this)),b.on("dragstart",this.onDragStart.bind(this)),b.on("dragging",this.onDragging.bind(this)),b.on("objectMoves",this.onDragging.bind(this))):this.initialized&&(b.off("selectObject",this.onDragStart.bind(this)),b.off("dragstart",this.onDragStart.bind(this)),b.off("dragging",this.onDragging.bind(this)),b.off("objectMoves",this.onDragging.bind(this)))},d.prototype.onDragStart=function(b){var c=-1!=b.object.name.indexOf("group_");if(c&&(b.object.magnetismCollider=hcs.Constants.MAGNETISM.WALL),b.object.structure&&(b.object.magnetismCollider=b.object.structure.magnetismCollider),b.object.magnetismCollider){if(a.buildCollisionList(b.object),!c&&b.object.magnetismCollider&(hcs.Constants.MAGNETISM.OBJECT|hcs.Constants.MAGNETISM.VERTICAL)){a.currentCollisionBox=null;for(var d=0;!a.currentCollisionBox&&d<a.collisionList.length;)a.collisionList[d].object==b.object&&(a.currentCollisionBox=a.collisionList[d]),d++;a.collisionList.splice(d-1,1)}else a.currentCollisionBox=new f(b.object);a._lastPosition.copyFrom(b.object.position),a._lastFictivePosition.copyFrom(b.object.position)}},d.prototype.lateralCollisionCandidate=function(b){return a.currentCollisionBox.object.magnetismCollider&hcs.Constants.MAGNETISM.OBJECT&&-1==b.object.name.indexOf("WallMesh_")&&b.object.magnetismCollider&hcs.Constants.MAGNETISM.OBJECT||a.currentCollisionBox.object.magnetismCollider&hcs.Constants.MAGNETISM.WALL&&-1!=b.object.name.indexOf("WallMesh_")},d.prototype.onDragging=function(c){if(c.object.magnetismCollider){var d=1,e=10;if(!a.currentCollisionBox)return void Logger.warning("L'��v��nement DragStart n'a pas ��t�� correctement trait�� par le magn��tisme 3D");a.currentCollisionBox.update();var f=-1,g=!1,h=0;a._speedVector.copyFrom(a.currentCollisionBox.object.position).subtractInPlace(a._lastFictivePosition);for(var i=Math.abs(a._speedVector.y)>.1;(0>f||f>d)&&e>h;){f=0;for(var j=0,k=a.collisionList.length;k>j;j++)if(!(a.collisionList[j].yRange[1]<=a.currentCollisionBox.yRange[0]||a.collisionList[j].yRange[0]>=a.currentCollisionBox.yRange[1])&&a.collisionList[j].overlaps(a.currentCollisionBox)){if(i&&(a.currentCollisionBox.object.magnetismCollider&hcs.Constants.MAGNETISM.VERTICAL||"room"==a.collisionList[j].object.name)){if(a._lastFictivePosition.copyFrom(a.currentCollisionBox.object.position),a.solveCollision(a.collisionList[j],!0)<5)continue;a._speedVector.y=Math.abs(a.currentCollisionBox.yRange[1]-a.collisionList[j].yRange[0])<=Math.abs(a.currentCollisionBox.yRange[0]-a.collisionList[j].yRange[1])?a.collisionList[j].yRange[0]-a.currentCollisionBox.yRange[1]:a.collisionList[j].yRange[1]-a.currentCollisionBox.yRange[0],a.currentCollisionBox.object.position.addInPlace(a._speedVector);break}if("room"==a.collisionList[j].object.name)continue;if(a.lateralCollisionCandidate(a.collisionList[j])&&b.getSelectedObject()!==c.object){if(!g){var l=a.currentCollisionBox.object.rotation.y;a.collisionList[j].object.name.indexOf("WallMesh_")>=0&&a.angleMagnetism(a.currentCollisionBox,a.collisionList[j]);for(var m=0,n=a.collisionList.length;n>m;m++)if(j!=m&&a.lateralCollisionCandidate(a.collisionList[m])&&"room"!=a.collisionList[m].object.name&&a.collisionList[m].overlaps(a.currentCollisionBox)&&a.solveCollision(a.collisionList[m],!0)>5){a.currentCollisionBox.object.rotation.y=l,a.currentCollisionBox.object.computeWorldMatrix(!0),a.currentCollisionBox.update();break}g=!0}a._physicSpeedVector.copyFrom(a.currentCollisionBox.object.position).subtractInPlace(a._lastPosition),f=Math.max(a.solveCollision(a.collisionList[j],!1,a._physicSpeedVector),f)}}h++}0>=f&&a._lastFictivePosition.copyFrom(a.currentCollisionBox.object.position),h==e&&a.currentCollisionBox.object.position.copyFrom(a._lastPosition),a._lastPosition.copyFrom(a.currentCollisionBox.object.position)}},d.prototype.angleMagnetism=function(b,c){for(var d=Math.PI/1e3,e=2*Math.PI,f=b.object.structure&&void 0!==b.object.structure.preferredYAngle?b.object.structure.preferredYAngle:0,g=b.object.getChildren(),h=g.length-1;h>=0;h--)if("selector"===g[h].name)return;var i=void 0!==c.box.angle?c.box.angle:c.object.rotation.y+Math.PI;i+=Math.PI;var j=b.object.rotation.y,k=(a.core.engine3D.keyboardManager.isPressed([17,91]),i%e),l=j%e;Math.abs(k-(l-f))>e/2&&(l>k?k+=e:l+=e);var m=k-(l-f);Math.abs(m)>d&&-1==b.object.name.indexOf("group_")&&(b.object.rotation.y+=m,b.object.computeWorldMatrix(!0),b.update())},d.prototype.solveCollision=function(b,c,d){a._lastFictivePosition.copyFrom(a.currentCollisionBox.object.position);var e=a.currentCollisionBox.worstOverlap(b,d);if(e&&e.overlapAxis){var f=e.overlapAxis.clone().normalize().scaleInPlace(-e.overlapValue);return c||a.currentCollisionBox.object.position.addInPlace(f),a.currentCollisionBox.update(),f.length()}return 0},d}(),AvatarComponent3D=function(){var a,b=function(b){BaseComponent3D.call(this,b,"AvatarComponent3D"),this.avatar=null,this.structure=this.core.getSelectedStructure(),this._avatarEnabled=!0,hcsdesign.api.params.avatarEnabled===!1&&(this._avatarEnabled=!1),a=this,BABYLON.SceneLoader.ImportMesh("",hcs.Assets.globalPath+"js/Components/AvatarComponent/avatar/","girl.babylon",b.engine3D.scene,function(c){a.avatar=new BABYLON.Mesh("avatar",b.engine3D.scene),a.avatar.isVisible=!1;for(var d=0,e=c.length;e>d;d++)c[d].parent=a.avatar,a._avatarEnabled?(c[d].material.backFaceCulling=!1,c[d].receiveShadows=!0,b.engine3D.castShadows(c[d])):c[d].isVisible=!1;a.avatar.position.y+=5;var f=hcsdesign.getComponentByName("EditionComponent3D");f&&f.addUnremovableDraggable(a.avatar)}),this.globalBoundingBox=this.core.configuration.boundingSize,this.onNewPlanReady=this.onNewPlanReady.bind(this),document.addEventListener("hcs.request.newPlanReady",this.onNewPlanReady,!1)};return b.prototype=Object.create(BaseComponent3D.prototype),b.prototype.onFloorSelected=function(a){var b=a.structure;this.structure=b,"undefined"!=typeof b.elevation&&(this.avatar.position.y=b.elevation+5)},b.prototype.startListening=function(){this.onFloorSelected=this.onFloorSelected.bind(this),document.addEventListener("hcs.request.floorSelected",this.onFloorSelected,!1)},b.prototype.stopListening=function(){document.removeEventListener("hcs.request.floorSelected",this.onFloorSelected,!1)},b.prototype.onNewPlanReady=function(){this.structure=this.core.getSelectedStructure(),"undefined"!=typeof this.structure.elevation&&(this.avatar.position.y=this.structure.elevation+5)},b.prototype.setVisibility=function(a){this._avatarEnabled&&this.avatar.traverse(function(b){b.isVisible=a})},b.prototype.update=function(){this.avatar&&(null==this.avatar||this.avatar.visible||(this.avatar.position.y=this.core.getSelectedStructure().elevation+5),this.avatar.position.x=this.avatar.position.x<this.globalBoundingBox.min.x?this.globalBoundingBox.min.x:this.avatar.position.x,this.avatar.position.z=this.avatar.position.z<this.globalBoundingBox.min.z?this.globalBoundingBox.min.z:this.avatar.position.z,this.avatar.position.x=this.avatar.position.x>this.globalBoundingBox.max.x?this.globalBoundingBox.max.x:this.avatar.position.x,this.avatar.position.z=this.avatar.position.z>this.globalBoundingBox.max.z?this.globalBoundingBox.max.z:this.avatar.position.z)},b}();FloorStructure=function(){var a=function(){BaseStructure.call(this,"FloorStructure"),this.label="",this.points=[],this.walls=[],this.overtures=[],this.internalRooms=[],this.externalRooms=[],this.objects=[],this.stairways=[],this.hoppers=[],this.subslopes=[],this.SubSlopeOverture=[],this.elevation=0,this.height=250,this.needsUpdate=!0,this.dirtyGeometry=!0};return a.prototype=new BaseStructure,a.prototype.dirty=function(){this.dirtyGeometry=!0},a.prototype.tidy=function(){this.dirtyGeometry=!1},a.prototype.isDirty=function(){return this.dirtyGeometry},a.prototype.serialize=function(){var a={"class":{name:"FloorStructure"}};return ujs.serializeObject(this,a,["id","name","label","elevation","height","internalRooms","externalRooms","points","walls","overtures","objects","stairways","hoppers"]),a},a.prototype.deserialize=function(a){return ujs.deserializeObject(a,this,["id","name","label","elevation","height","internalRooms","externalRooms","points","walls","overtures","objects","stairways","hoppers"]),this},a.prototype.updateReferences=function(){for(var a=this,b=[this.points,this.walls,this.overtures,this.internalRooms,this.externalRooms,this.objects],c=function(b){for(var c=0,d=b.length;d>c;c++)b[c].updateReferences(a)},d=function(b){for(var c=b.length-1;c>=0;c--)b[c].checkCoherence&&b[c].checkCoherence(a)},e=0,f=b.length;f>e;e++)c(b[e]),d(b[e]);for(var e=0,f=this.walls.length;f>e;e++)this.walls[e].getPolygon(this),this.walls[e].update(this)},a.prototype.insertElement=function(a,b){this[a]||(this[a]=[]);var c=!1;for(var d in this[a])if(this[a][d]==b){c=!0;break}c||(b.id=this[a].length,this[a].push(b))},a.prototype.getElements=function(a){return this[a]?this[a]:[]},a.prototype.getElementByIdentifier=function(a,b,c){for(var d=this.getElements(b),c=c||"id",e=0;e<d.length;e++)if(d[e][c]==a)return d[e];return null},a.prototype.removeElement=function(a,b){if(this[a]){var c=0;for(var d in this[a])if(this[a][d]==b){this[a].splice(d,1),c=d;break}this.reindexElements(this[a],c)}},a.prototype.replaceElements=function(a,b){this[a]=[].concat(b),this.reindexElements(this[a],0)},a.prototype.clone=function(){var b=this.serialize(),c=new a;return c.deserialize(b),c.label="",c},a.prototype.reindexElements=function(a,b){for(var b=b||0,c=b;c<a.length;c++)a[c].id=c},a}();var FloorComponent3D=function(){var a=null,b=function(b){BaseComponent3D.call(this,b,"FloorComponent3D"),this._floors=[],this.priority=1,this._current=0,a=this,this.onNewPlanReady=this.onNewPlanReady.bind(this),document.addEventListener("hcs.request.newPlanReady",this.onNewPlanReady)};return b.prototype=new BaseComponent3D,b.prototype.compute=function(){},b.prototype.startListening=function(){this.onSelectFloor=this.onSelectFloor.bind(this),this.onDeleteFloor=this.onDeleteFloor.bind(this),document.addEventListener("hcs.request.floorSelected",this.onSelectFloor),document.addEventListener("hcs.request.floorDeleted",this.onDeleteFloor)},b.prototype.stopListening=function(){document.removeEventListener("hcs.request.floorSelected",this.onSelectFloor),document.removeEventListener("hcs.request.floorDeleted",this.onDeleteFloor)},b.prototype.onContextChanged=function(a){"3D"==a?(this.startListening(),this.createFloor()):this.stopListening()},b.prototype.onSelectFloor=function(a){var b=a.id;this.createFloor(+b>+this._current?this._current:b),this._current=b},b.prototype.onDeleteFloor=function(a){this.deleteFloor({id:a.id})},b.prototype.onNewPlanReady=function(){for(var a=hcsdesign.engine3D.scene.meshes.slice(0),b=a.length-1;b>=0;b--)"structure"==a[b].type&&a[b].dispose();return!0},b.prototype.deleteFloor=function(a){for(var b=hcsdesign.engine3D.scene.meshes.slice(0),c=b.length-1;c>=0;c--)b[c].name&&-1!=b[c].name.indexOf("FloorMesh")&&b[c].structureId>=a.id&&b[c].dispose()},b.prototype.getFloor=function(a){for(var a=a||hcsdesign.getSelectedStructure(),b="FloorMesh_"+a.id,c=0;c<hcsdesign.engine3D.scene.meshes.length;c++)if(hcsdesign.engine3D.scene.meshes[c].name==b)return hcsdesign.engine3D.scene.meshes[c];return null},b.prototype.createFloor=function(a){var b,a=a||0,c=+hcsdesign.getSelectedStructure().id||0;this._current=c;for(var d=c+1;d<this.structure.getLength();d++)b=this.structure.getElement(d),this.deleteFloor(b);for(var e=a;c>=e;e++)if(b=this.structure.getElement(e),this.deleteFloor(b),b instanceof FloorStructure){var f=this.createFloorMesh(b);f.position.y=b.elevation,f.computeWorldMatrix(),ujs.notify("hcs.engine3d.floorReady",{floor:f,structure:b})}ujs.notify("hcs.engine3d.globaleFloorReady",{maxFloorId:c}),this.initialized=!0},b.prototype.createFloorMesh=function(a){var b=new BABYLON.Mesh("FloorMesh_"+a.id,hcsdesign.engine3D.scene);return b.isVisible=!1,b.structureId=a.id,b.structure=a,b.id=a.id,b.type="structure",b},b}(),FloorController=function(){var a=null,b=function(b){BaseComponent2D.call(this,b,"FloorController"),this._dragging=!1,this.core=b,a=this};return b.prototype=Object.create(BaseComponent2D.prototype),b.prototype.update=function(){hcsdesign.getSelectedStructure().isDirty()&&this.updateHTML()},b.prototype.onContextChanged=function(){},b.prototype.initialize=function(){this.updateHTML(),this.startListening(),{context:"2D",values:[{type:"checkbox",label:_("Display the lower floor"),eventParams:{eventName:"hcs.request.object.seeBottomFloor",cast:"int"}}]}},b.prototype.startListening=function(){document.addEventListener("hcs.structure.locale.loaded",this.updateHTML)},b.prototype.stopListening=function(){document.removeEventListener("hcs.structure.locale.loaded",this.updateHTML)},b.prototype.updateHTML=function(){a.removeHTML();var b=a.buildHTML();document.getElementById("modalWidgets").appendChild(b)},b.prototype.removeHTML=function(){(fcElement=document.getElementById("floor-controller"))&&document.getElementById("modalWidgets").removeChild(fcElement)},b.prototype.buildHTML=function(){var b=document.createElement("div");b.setAttribute("id","floor-controller"),b.setAttribute("style","top: 10px;left: 10px;position:absolute;");for(var c=this.core.structure.getCurrentStructure()?this.core.structure.getCurrentStructure().id:0,d=0;d<this.core.structure.getLength();d++){var e=this.structure.getElement(d);if(e instanceof FloorStructure){var f=document.createElement("a");if(f.setAttribute("rel",d),f.setAttribute("draggable",!0),f.setAttribute("class","floor-item"),d==c&&ujs.addClass(f,"selected"),f.innerHTML=e.label?e.label:0==d?_("GND"):_("Floor")+" "+d,f.setAttribute("title",f.innerHTML),f.addEventListener("click",this.onItemClick,!1),f.addEventListener("dragstart",function(b){b.dataTransfer.setData("Text",this.id),a._dragging=this.getAttribute("rel")},!0),f.addEventListener("dragover",function(a){this.classList.add("dragover"),a.preventDefault()}),f.addEventListener("dragleave",function(){this.classList.remove("dragover")}),f.addEventListener("drop",function(b){var c=this.getAttribute("rel");this.classList.remove("dragover"),a.insertFloorBefore(a._dragging,c),a.updateHTML(),b.preventDefault()}),b.appendChild(f),!this.core.engine3D.isViewer){var g=document.createElement("div");g.setAttribute("class","settings"),g.setAttribute("title",_("Change settings")),g.setAttribute("rel",d),g.innerHTML="i",g.addEventListener("click",this.onItemContextMenu,!0),f.appendChild(g);var h=document.createElement("div");h.setAttribute("class","delete"),h.setAttribute("title",_("Remove this floor")),h.setAttribute("rel",d),h.innerHTML="x",h.addEventListener("click",this.onItemDelete,!1),f.appendChild(h)}}}if(!this.core.engine3D.isViewer){var i=document.createElement("div");i.setAttribute("class","floor-item"),i.innerHTML=_("+ add"),i.addEventListener("click",this.onAddItemClick),b.appendChild(i)}return b},b.prototype.insertFloorBefore=function(b,c){var d=this.structure.getElement(b);this.structure.removeElement(d),this.structure.addMemberAtIndex(c,d);for(var e=0,f=0;f<hcsdesign.structure.getLength();f++){var d=a.structure.getElement(f);d instanceof FloorStructure&&(d.elevation=e,e+=d.height)}this.selectFloor(c)},b.prototype.onItemClick=function(){(id=this.getAttribute("rel"))&&a.selectFloor(id)},b.prototype.onItemContextMenu=function(b){if(id=this.getAttribute("rel")){var c=hcsdesign.structure.getElement(id),d=[{name:"label",label:_("Name"),type:"text",cast:"string",value:c.label},{name:"height",label:_("Height"),type:"number",cast:"int",unit:"cm",value:{min:5,max:500,step:1,value:c.height}}];hcsdesign.engine2D.displayContextMenu(d,c,a.onContextMenuPropertyChanged.bind(a))}b.stopPropagation()},b.prototype.onContextMenuPropertyChanged=function(a,b,c){if(a.hasOwnProperty(b)){var d=a[b];if(a[b]=c,"height"==b){for(var e=0;e<a.walls.length;e++)(a.walls[e].height>a.height||a.walls[e].height==d)&&(a.walls[e].height=a.height);this.core.structure.updateFloorElevations(),ujs.notify("hcs.request.floorSelected",{id:this.core.getSelectedStructure().id,structure:this.core.getSelectedStructure()})}}this.updateHTML(),this.core.engine2D.requestStaticDraw()},b.prototype.onItemDelete=function(b){if(confirm(_("confirm the deletion"))&&!(hcsdesign.structure.getLength()<=1)){if(id=this.getAttribute("rel")){var c=hcsdesign.structure.getElement(id);hcsdesign.structure.removeElement(c);for(var d=0,e=0;e<hcsdesign.structure.getLength();e++){var f=a.structure.getElement(e);f instanceof FloorStructure&&(f.elevation=d,d+=f.height)}ujs.notify("hcs.request.floorDeleted",{id:id},!0),a.selectFloor(0==id?id:id-1)}b.stopPropagation()}},b.prototype.onAddItemClick=function(){var b='<form id="addFloorOptions">'+_("The following items will be duplicated")+'<table style="width:100%;">';b+="<tr>",b+='<td><input type="checkbox" name="duplicateOptions[]" value="walls" checked="checked" /></td>',b+="<td>"+_("墙")+"</td>",b+="</tr>",b+="<tr>",b+='<td><input type="checkbox" name="duplicateOptions[]" value="overtures" checked="checked" /></td>',b+="<td>"+_("门")+"和"+_("窗")+"</td>",b+="</tr>",b+="<tr>",b+='<td><input type="checkbox" name="duplicateOptions[]" value="cloisons" /></td>',b+="<td>"+_("隔板")+"</td>",b+="</tr>",b+="<tr>",b+='<td><input type="checkbox" name="duplicateOptions[]" value="stairways" /></td>',b+="<td>"+_("Stairways")+"</td>",b+="</tr>",b+="<tr>",b+='<td><input type="checkbox" name="duplicateOptions[]" value="objects" /></td>',b+="<td>"+_("Objects")+"</td>",b+="</tr>",b+="</table></form>";var c={title:_("Create a new floor"),message:b,y:30,x:10,buttonA:!0,buttonB:!0,buttonBText:_("Create"),buttonAText:_("Cancel"),onClickB:function(b){for(var c=document.getElementsByName("duplicateOptions[]"),d=[],e=0;e<c.length;e++)c[e].checked&&d.push(c[e].value);return a.onAddItemConfirm(b,d),!0}};hcs.UI.MessageBox.show(c)},b.prototype.onAddItemConfirm=function(b,c){var d=a.duplicateForFloor(c);if(d.id>0){var e=hcsdesign.structure.getElement(d.id-1);d.elevation=e.elevation+e.height}var f=function(){a.selectFloor(d.id)};ujs.notify("hcs.request.floorAdded",{id:d.id,callback:f},!0)},b.prototype.duplicateForFloor=function(a){var a=a||[],b=hcsdesign.structure.getCurrentStructure(),c=b.clone();hcsdesign.structure.addElement(c),c.updateReferences(hcsdesign.structure),c.hoppers=[];for(var d=0,e=c.walls.length;e>d;d++)c.walls[d].materials={},c.walls[d].subSlopes=[];for(var f=c.internalRooms.concat(c.externalRooms),d=0,e=f.length;e>d;d++)f[d].panesMaterials={},f[d].materials={};if(c.subslopes=[],-1==a.indexOf("objects")&&(c.objects=[]),-1==a.indexOf("stairways")&&(c.stairways=[]),-1==a.indexOf("walls")){for(var d=c.walls.length-1;d>=0;d--){var g=c.walls[d];g.remove(c)}c.externalRooms.length=0,c.internalRooms.length=0}else if(-1==a.indexOf("cloisons"))for(var d=c.walls.length-1;d>=0;d--){var g=c.walls[d];(g.type!=g.TYPE_NORMAL||g.thickness<15)&&g.remove(c)}if(-1==a.indexOf("overtures")){c.overtures=[];for(var d=c.walls.length-1;d>=0;d--){var g=c.walls[d];g.overtures.length=0}}else for(var d=c.overtures.length-1;d>=0;d--)c.overtures[d];return c},b.prototype.onSelectFloor=function(b){b.id>-1&&a.selectFloor(b.id)},b.prototype.selectFloor=function(b){hcsdesign.structure.setCurrentStructureIndex(b),hcsdesign.structure.members[b].dirty(),hcsdesign.engine2D.update(!0),hcsdesign.engine2D.requestStaticDraw(),a.updateHTML();var c=hcsdesign.getComponentByName("HistoryComponent");c&&c.reset(),ujs.notify("hcs.request.floorSelected",{id:b,structure:hcsdesign.structure.getCurrentStructure()},!0)},b}(),PointStructure=function(){var a=function(){BaseStructure.call(this,"PointStructure"),this.position=new BABYLON.Vector2(0,0),this.attachedTo=null,this.needsUpdate=!0,this.parents=[],this._parentIds=null};return a.prototype=new BaseStructure,a.prototype.serialize=function(){this.position.x=Math.round(10*this.position.x)/10,this.position.y=Math.round(10*this.position.y)/10;for(var a={"class":{name:"PointStructure"},_parentIds:[]},b=0,c=this.parents.length;c>b;b++)a._parentIds.push(this.parents[b].id);return ujs.serializeObject(this,a,["name","id","position"]),a},a.prototype.deserialize=function(a){ujs.deserializeObject(a,this,["name","id","position"]),this._parentIds=a._parentIds},a.prototype.checkCoherence=function(){},a.prototype.updateReferences=function(a){this.parents.length=0;for(var b=0,c=this._parentIds.length;c>b;b++)for(var d=0,e=a.walls.length;e>d;d++)a.walls[d].id==this._parentIds[b]&&this.parents.push(a.walls[d]);delete this._parentIds},a.Deserialize=function(b){var c=new a;return c.deserialize(b),c},a.prototype.update=function(a){this.tryMerge(a).tryAttach(a)},a.prototype.translate=function(a){this.position.addInPlace(a)},a.prototype.remove=function(a){this.unAttach(),void 0!=a&&a.removeElement("points",this)},a.prototype.replaceParent=function(a,b){var c=this.parents.indexOf(a);-1!=c&&this.parents.splice(c,1),void 0!==b&&this.parents.push(b)},a.prototype.tryMerge=function(a){if(!this.parents[0])return this;if(this.parents[0]&&this.parents[1])return this;for(var b=15,c=a.getElements("points"),d=0,e=c.length;e>d;d++)if(c[d]!==this&&!(this.position.distanceTo(c[d].position)>b||c[d].parents[0]&&c[d].parents[1])){var f,g;if(f=this.wallAttached(a),g=c[d].wallAttached(a),!f&&!g||f==c[d].parents[0]&&g==this.parents[0]){c[d].parents.push(this.parents[0]);var h=this.parents[0].points.indexOf(this);this.parents[0].points[h]=c[d],c[d].unAttach(),this.unAttach();var i=c[d];return this.remove(a),i.parents[0].update(a),i}}return this},a.prototype.forceMerge=function(a,b){if(this.parents[0]){var c=a.parents[0];c&&(this.parents.push(c),c.points[c.points.indexOf(a)]=this),this.unAttach(b),a.unAttach(b),a.remove(b),a.parents.length=0,this.parents[0].needsUpdate=!0,this.parents[1]&&(this.parents[1].needsUpdate=!0)}else a.position.lerp(this.position,.5),a.unAttach(b),a.needsUpdate=!0},a.prototype.tryAttach=function(a,b){if(!this.parents[0])return!1;if(this.parents[0]&&this.parents[1])return!1;if(this.isAttached(a))return!1;for(var c,d=5,e=a.getElements("walls"),f=[],g=null,h=0,i=e.length;i>h;h++)if((void 0===b||b!==e[h])&&e[h]!=this.parents[0]&&e[h]!=this.parents[1]&&this.parents[0]&&(c=this.parents[0].points[(this.parents[0].points.indexOf(this)+1)%2],e[h]!=c.wallAttached(a)&&e[h].points[0].wallAttached(a)!==this.parents[0]&&e[h].points[1].wallAttached(a)!==this.parents[0])){var j=e[h].distanceFromRect(this.position,0,a);if(!(j>d+e[h].thickness)){var k=e[h].getNearestPointOnRect(this.position,0,a),l=e[h].getPoints(0).position.subtract(k),m=e[h].getPoints(1).position.subtract(k),n=l.lengthSquared()>m.lengthSquared()?l:m;f.push({wall:e[h],vector:n.normalize()})}}if(c){for(var o=-1,p=c.position.subtract(this.position).normalize(),h=0,i=f.length;i>h;h++){var q=p.dot(f[h].vector);q>=o&&(g=f[h].wall,o=q)}return g?(g.attachedPoints.push(this),this.attachedTo=g,this.position=g.getNearestPointOnPolygon(this.position),g.needsUpdate=!0,this.parents[0].needsUpdate=!0,!0):!1}},a.prototype.isAttached=function(){return null!=this.attachedTo},a.prototype.wallAttached=function(){return this.attachedTo},a.prototype.unAttach=function(){return this.attachedTo?(this.attachedTo.attachedPoints.splice(this.attachedTo.attachedPoints.indexOf(this),1),this.attachedTo=null,!0):!1},a}(),PointComponent2D=function(){var a=function(a){BaseComponent2D.call(this,a,"PointComponent2D"),this._SIZE=13,this._ANGLERADIUS=55,this.anglePointList=[],this.dragging=!1,hcsdesign.engine2D.registerEventCb("PointComponent2D.double-click",this.priority,"double-click",hcsdesign.engine2D.MODE_NORMAL,PointStructure,this.onDoubleClick.bind(this),null),hcsdesign.engine2D.registerEventCb("PointComponent2D.hover",this.priority,"hover",hcsdesign.engine2D.MODE_NORMAL|hcsdesign.engine2D.MODE_DRAW,PointStructure,this.onHover.bind(this),null),hcsdesign.engine2D.registerEventCb("PointComponent2D.leave",this.priority,"leave",hcsdesign.engine2D.MODE_NORMAL|hcsdesign.engine2D.MODE_DRAW,PointStructure,this.onLeave.bind(this),null),hcsdesign.engine2D.registerEventCb("PointComponent2D.dragstart",this.priority,"drag-start",hcsdesign.engine2D.MODE_NORMAL,PointStructure,this.onDragStart.bind(this),null),this.priority=90};return a.prototype=new BaseComponent2D,BaseComponent2D.prototype.getTargeted=function(a){var b=this.structure.getCurrentStructure(),c=b.getElements("points"),d=null;for(var e in c)c[e].position.distanceTo(a)<this._SIZE+5&&(null==d?d=c[e]:!d.isAttached(b)&&c[e].isAttached(b)&&(d=c[e]));
return d},a.prototype.update=function(){this.tryMergeAttachAll()},a.prototype.tryMergeAttachAll=function(a){for(var b=this.structure.getCurrentStructure(),c=b.getElements("points"),d=c.length-1;d>=0;d--)(c[d].needsUpdate||a)&&(c[d].needsUpdate=!1,c[d].update(b),b.dirty())},a.prototype.drawAngle=function(a,b,c,d){var e,f,g,h;if(2===d.parents.length)e=d.parents[0],f=d.parents[1],g=0===e.points.indexOf(d)?e.getWallVector():e.getWallVector().scaleInPlace(-1),h=0===f.points.indexOf(d)?f.getWallVector():f.getWallVector().scaleInPlace(-1);else{if(1!==d.parents.length||null==d.attachedTo)return;e=d.parents[0],f=d.attachedTo,g=0===e.points.indexOf(d)?e.getWallVector():e.getWallVector().scaleInPlace(-1),h=f.getWallVector(),g.dot(h)<0&&h.scaleInPlace(-1)}var i=g.dot(h)/(g.length()*h.length()),j=g.determinant(h)/(g.length()*h.length()),k=Math.acos(BABYLON.Math.clamp(i,-1,1))*(j>0?1:-1),l=BABYLON.Math.NormalizeAngle(Math.atan2(g.y,g.x),!0);hcsdesign.engine2D.symbols2D.drawAngle(a,{x:b.x+c*d.position.x,y:b.y+c*d.position.y},c,this._ANGLERADIUS,l,l+k,0>j)},a.prototype.onDynamicDraw=function(a,b,c,d){var e={x:b.x+d.position.x*c,y:b.y+d.position.y*c};hcsdesign.engine2D.symbols2D.drawPointHover(a,e,c);for(var f=0,g=this.anglePointList.length;g>f;f++)this.drawAngle(a,b,c,this.anglePointList[f])},a.prototype.onDragStart=function(a,b){if(b){b.unAttach(this.structure.getCurrentStructure()),this.anglePointList.push(b);for(var c=0,d=b.parents.length;d>c;c++)for(var e=0,f=b.parents[c].points.length;f>e;e++)b.parents[c].points[e]!==b&&this.anglePointList.push(b.parents[c].points[e])}return this.dragging=!0,hcsdesign.engine2D.registerEventCb("PointComponent2D.dragging",this.priority,"dragging",hcsdesign.engine2D.MODE_DRAG,null,this.onDragging.bind(this),b),hcsdesign.engine2D.registerEventCb("PointComponent2D.drag-end",this.priority,"drag-end",hcsdesign.engine2D.MODE_DRAG,null,this.onDragEnd.bind(this),b),hcsdesign.engine2D.registerEventCb("PointComponent2D.drag.hover",this.priority,"hover",hcsdesign.engine2D.MODE_DRAG,PointStructure,this.onHover.bind(this),b),hcsdesign.engine2D.registerEventCb("PointComponent2D.drag.leave",this.priority,"leave",hcsdesign.engine2D.MODE_DRAG,PointStructure,this.onLeave.bind(this),b),!1},a.prototype.onDragging=function(a,b,c,d){0==d.parents.length&&this.onDragEnd(),d.position.copyFrom(c.planPos);for(var e=0,f=d.parents.length;f>e;e++)d.parents[e]&&(d.parents[e].needsUpdate=!0);hcsdesign.engine2D.requestStaticDraw()},a.prototype.onDragEnd=function(a,b,c,d){if(this.anglePointList.length=0,this.dragging=!1,d){var e=this.structure.getCurrentStructure();d.unAttach(e);var f=d.tryMerge(e);f===d&&d.tryAttach(e);var g=[f.parents[0],f.parents[1]],h=e.getElements("walls");g[0]&&-1!=h.indexOf(g[0])&&(g[0]=g[0].tryMerge(e)),g[1]&&-1!=h.indexOf(g[1])&&(g[1]=g[1].tryMerge(e)),g[0]&&-1!=h.indexOf(g[0])&&g[0].splitAtIntersections(e),g[1]&&-1!=h.indexOf(g[1])&&g[1].splitAtIntersections(e),hcsdesign.getComponentByName("WallComponent2D").update(),hcsdesign.getComponentByName("WallComponent2D").simplifyWalls(),this.update(),e.dirty(),hcsdesign.engine2D.requestStaticDraw(),hcsdesign.engine2D.unregisterEventCb("PointComponent2D.drag.hover"),hcsdesign.engine2D.unregisterEventCb("PointComponent2D.drag.leave"),hcsdesign.getComponentByName("WallComponent2D").update()}},a.prototype.onHover=function(a,b,c,d){var b=d||b;return this.dragging||this.anglePointList.push(b),hcsdesign.engine2D.registerEventCb("PointComponent2D.dynamic-draw",this.priority,"dynamic-draw",null,null,this.onDynamicDraw.bind(this),b),hcsdesign.engine2D.requestDynamicDraw(),!1},a.prototype.onLeave=function(){this.dragging||(this.anglePointList.length=0,hcsdesign.engine2D.unregisterEventCb("PointComponent2D.dynamic-draw")),hcsdesign.engine2D.requestDynamicDraw()},a.prototype.onDoubleClick=function(a,b,c){var d=hcsdesign.getSelectedStructure(),e=hcsdesign.getComponentByName("WallComponent2D",hcsdesign.ENGINE_2D);if(b.isAttached(d)){var f=b.wallAttached(d);c.planPos=b.position.clone(),e.onDoubleClick(a,f,c,null)}else{if(c.modifiers!=c.MODIFIER_SHIFT)return;var f=null;for(var g in b.parents)b.parents[g]instanceof WallStructure&&(f=b.parents[g]);e.onAddWall({wallType:f.type,thickness:f.thickness,putPoint:!0})}d.dirty()},a}(),Graph=function(){var a=function(a){this.position=a,this.neighbors=[],this.parents=[],this.parentWallSide=[],this.visited=!1};a.prototype.connect=function(a,b){a&&(this.neighbors.push(a),this.parents[0]==a.parents[0]||b||(this.parents.push(a.parents[0]),this.parentWallSide.push(a.parentWallSide[0])))};var b=function(){this.nodes=[]};return b.prototype.mergeNodes=function(){for(var a=function(a,b,c){for(var d=c.length-1;d>=0;d--)for(var e=0;2>e;e++)c[d].neighbors[e]==a&&(c[d].neighbors[e]=b)},b=.01,c=this.nodes.length-1;c>=0;c--)for(var d=0;c>d;d++)if(!(this.nodes[c].position.distanceTo(this.nodes[d].position)>b)){if(!(this.nodes[c].neighbors.length>1||this.nodes[d].neighbors.length>1)){if(2==this.nodes[c].parents[0].type||2==this.nodes[d].parents[0].type){var e=new BABYLON.Vector3;e.subVectors(this.nodes[c].neighbors[0].position,this.nodes[c].position).normalize();var f=new BABYLON.Vector3;f.subVectors(this.nodes[d].neighbors[0].position,this.nodes[d].position).normalize();var g=e.add(f).add(this.nodes[c].position),h=this.nodes[c].parents[0].vectorTo(g),i=this.nodes[d].parents[0].vectorTo(g);if(Math.sign(h.dot(this.nodes[c].parentWallSide[0]))!=Math.sign(i.dot(this.nodes[d].parentWallSide[0])))continue}var j=this.nodes.splice(c,1);this.nodes[d].connect(j[0].neighbors[0],!0),this.nodes[d].parents.push(j[0].parents[0]),this.nodes[d].parentWallSide.push(j[0].parentWallSide[0]),a(j[0],this.nodes[d],this.nodes);break}Logger.warning("Tentative de fusion de 3 points")}},b.prototype.processMissingConnections=function(){for(var a=50,b=this.nodes.length-1;b>=0;b--)if(!(this.nodes[b].neighbors.length>1))for(var c=0;b>c;c++)if(!(this.nodes[b].position.distanceTo(this.nodes[c].position)>a||this.nodes[c].neighbors.length>1)){this.nodes[b].connect(this.nodes[c]),this.nodes[c].connect(this.nodes[b]);break}},b.prototype.createFromWalls=function(b,c){c=c||b;for(var d,e,f,g,h,i,j,k,l=b.getElements("walls"),m=function(b,c,f){if(b.length<2)return Logger.warning("Erreur de structure des intersections"),null;for(var g,h,i=[],j=0,k=b.length;k>j;j++)i.push(new a(b[j]));for(var j=0,k=i.length;k>j;j++)g=i[j],i[j+1]&&(i[j].position.entersWall||-.5)<(i[j+1].position.entersWall||.5)&&(h=i[j+1],g.neighbors.push(h),h.neighbors.push(g),g.parents.push(c),h.parents.push(c),g.parentWallSide.push(f),h.parentWallSide.push(f),this.nodes.push(g),this.nodes.push(h)),0==j&&(d=g),j==k-1&&(e=g);return{f:d,l:e}},n=0,o=l.length;o>n;n++)f=l[n].getIntersections(b),k=m.call(this,f.a,l[n],l[n].getNormalVector(1)),g=k.f,i=k.l,k=m.call(this,f.b,l[n],l[n].getNormalVector(-1)),h=k.f,j=k.l,1!=l[n].points[0].parents.length||l[n].points[0].wallAttached(b)||g&&(g.connect(h),h.connect(g)),1!=l[n].points[1].parents.length||l[n].points[1].wallAttached(b)||i&&(i.connect(j),j.connect(i));this.mergeNodes(),this.processMissingConnections()},b.prototype.createCycles=function(){for(var a=[],b=function(a){var b=[];b.push(a),a.visited=!0;for(var c,d=a.neighbors[0],e=a,f=0;d.position!=b[0].position;){if(b.push(d),d.visited=!0,c=d.neighbors.indexOf(e),-1==c)return Logger.warning("Erreur dans la structure du graphe"),null;if(e=d,d=d.neighbors[(c+1)%2],f++,f>250||null==d)return null}return b},c=0,d=this.nodes.length;d>c;c++)if(!this.nodes[c].visited){var e=b(this.nodes[c]);e&&a.push(e)}return a},b}();WallStructure=function(){var a=function(){BaseStructure.call(this,"WallStructure"),this.points=[new PointStructure,new PointStructure],this._edgePolygons=[[],[]],this.attachedPoints=[],this.overtures=[],this.height=250,this.thickness=30,this.measureDist=15,this.measureDisplayed=!0,this.materials={},this.subSlopes=[],this.needsUpdate=!0,this.instance="virtual",this.TYPE_NORMAL=1,this.TYPE_SEPARATOR=2,this.type=this.TYPE_NORMAL,this._pointsIds=[],this._attachedPointsIds=[],this._overturesIds=[]};return a.prototype=new BaseStructure,a.prototype.serialize=function(){for(var a={"class":{name:"WallStructure"},_pointsIds:[],_attachedPointsIds:[],_overturesIds:[]},b=0,c=this.points.length;c>b;b++)a._pointsIds.push(this.points[b].id);for(var b=0,c=this.attachedPoints.length;c>b;b++)a._attachedPointsIds.push(this.attachedPoints[b].id);for(var b=0,c=this.overtures.length;c>b;b++)a._overturesIds.push(this.overtures[b].id);return ujs.serializeObject(this,a,["id","type","name","instance","height","thickness","measureDist","measureDisplayed","subSlopes"]),a},a.prototype.deserialize=function(a){ujs.deserializeObject(a,this,["id","type","name","instance","height","thickness","measureDist","materials","measureDisplayed","subSlopes","_overturesIds","_pointsIds","_attachedPointsIds"]),this.thickness=Math.max(.1,this.thickness)},a.prototype.checkCoherence=function(a){if(this.points.length<2)this.remove(a);else if(this.getLength()<5)this.remove(a);else{var b=this.points[0],c=this.points[1];(Math.abs(b.position.x)>5e3||Math.abs(b.position.y)>5e3)&&(Math.abs(c.position.x)>5e3||Math.abs(c.position.y)>5e3)&&this.remove(a)}},a.prototype.computeDefault=function(a){var b=this.getNormalVector(this.thickness/2),c=this.getPoints(a).position,d=c.add(b),e=(c.clone(),c.subtract(b));this._edgePolygons[a]=0==a?[d,e]:[e,d]},a.prototype.computeWeak=function(a){this.computeDefault(a);var b=0==a?-1:1;this._edgePolygons[a][1].addInPlace(this.getWallVector().normalize().scaleInPlace(b*this.getPoints(a).attachedTo.thickness/4))},a.prototype.computeStrong=function(a){var b=Math.PI/16,c=function(a,c,d,e){return BABYLON.Vector2.Intersect(a,c,d,e,b)},d=this.getAxis(a),e=d[0],f=d[1],g=this.getPoints(a),h=g.parents.indexOf(this),i=g.parents[(h+1)%2],j=i.points.indexOf(g);if(!i)return void Logger.warning("Point avec un seul parent ne devrait pas ��tre appel�� par computeStrong");d=i.getAxis(j);var k,l,m,n,o=d[0],p=d[1];return j==a?(k=c.call(this,e[0],e[1],p[0],p[1]),l=g.position.clone(),m=c.call(this,f[0],f[1],o[0],o[1])):(k=c.call(this,e[0],e[1],o[0],o[1]),l=g.position.clone(),m=c.call(this,f[0],f[1],p[0],p[1])),k||(k=e[a]),m||(m=f[a]),n=[k,l,m],1==a&&n.reverse(),this._edgePolygons[a]=n,n},a.prototype.updateReferences=function(a){var b=function(a,b,c){c.length=0;for(var d=0,e=a.length;e>d;d++)for(var f=0,g=b.length;g>f;f++)b[f].id==a[d]&&c.push(b[f])};b(this._pointsIds,a.points,this.points),b(this._attachedPointsIds,a.points,this.attachedPoints),b(this._overturesIds,a.overtures,this.overtures);for(var c=0,d=this.subSlopes.length;d>c;c++)this.subSlopes[c].wall=this;for(var c=0,d=this.overtures.length;d>c;c++)this.overtures[c].parentWall=this;for(var c=0;c<this.attachedPoints.length;c++)this.attachedPoints[c].attachedTo=this;delete this._pointsIds,delete this._attachedPointsIds,delete this._overturesIds},a.Deserialize=function(a){return Logger.warning("Deserialize is virtual"),console.warn("Impossible de deserialiser un mur virtuel, l'instance par d��faut choisie est polygonWall"),PolygonWall.Deserialize(a)},a.prototype.getPoints=function(a){return 0!=a&&1!=a?[this.points[0],this.points[1]]:this.points[a]},a.prototype.isTargeted=function(a){var b=this.getPoints(),c=this.getWallVector(),d=new BABYLON.Vector2,e=new BABYLON.Vector2;if(d=a.subtract(b[0].position),e.copyFrom(d),d.projectOnVector(c),e.subtractInPlace(d),e.length()<=this.thickness/2+WallComponent2D.WALL_OFFSET){var f=d.dot(c);if(f>0&&f<c.lengthSquared())return!0}return!1},a.prototype.setPoints=function(a,b){for(var c in this.points)for(var d=this.points[c].parents.length-1;d>=0;d--)this.points[c].parents[d]==this&&this.points[c].parents.splice(d,1);if(a instanceof Array)2==a.length&&(this.points[0]=a[0],this.points[1]=a[1]);else{if(!(a instanceof PointStructure)||0!=b&&1!=b)throw{name:"Argument Error",level:"Show Stopper",message:"Bad Arguments for WallStructure.setPoints"};this.points[b]=a}for(var c in this.points)this.points[c].parents.push(this)},a.prototype.getPolygon=function(){return 0==this._edgePolygons[0].length&&this.computeDefault(0),0==this._edgePolygons[1].length&&this.computeDefault(1),this._edgePolygons[0].concat(this._edgePolygons[1])},a.prototype.getWallVector=function(){return this.points[1].position.subtract(this.points[0].position)},a.prototype.getLength=function(){return this.getWallVector().length()},a.prototype.draw=function(a){var b=this.getPolygon();a.beginPath(),a.moveTo(b[0].x,b[0].y);for(var c=1;c<b.length;c++)a.lineTo(b[c].x,b[c].y);a.fill(),this.type===this.TYPE_SEPARATOR&&(a.lineWidth=4,a.stroke())},a.prototype.update=function(a){this.updateAttachedPoints(a)},a.prototype.translate=function(){Logger.warning("translate is virtual")},a.prototype.getIntersections=function(a){var b,c,d,e=a.getElements("walls"),f=5,g=f*f,h=[];for(var i in e)if(e[i]!==this&&(c=this,d=e[i],b=BABYLON.Vector2.Intersect(c.points[0].position,c.points[1].position,d.points[0].position,d.points[1].position),void 0!==b&&!(c.distanceFrom(b)>BABYLON.Vector2.Precision||d.distanceFrom(b)>BABYLON.Vector2.Precision))){var j=[c.points[0].position,c.points[1].position,d.points[0].position,d.points[1].position],k=!1;for(var l in j)k=k||b.distanceToSquared(j[l])<g;if(!k){var m=new PointStructure;m.parents=[c,d],m.position.copyFrom(b),h.push(m)}}return h.sort(function(a,b){return a.position.distanceToSquared(a.parents[0].points[0].position)-b.position.distanceToSquared(a.parents[0].points[0].position)}),h},a.prototype.splitAtIntersections=function(){Logger.warning("splitAtIntersections is virtual")},a.prototype.reorganizeOnSplit=function(a,b){if(!(b.length<=1)){for(var c=[],d=[],e=0,f=b.length;f>e;e++)c=c.concat(b[e].overtures),d=d.concat(b[e].attachedPoints),b[e].attachedPoints=[],b[e].subSlopes.forEach(function(a){a.remove()});for(var e=0,f=c.length;f>e;e++){var g=c[e].parentWall.getWallVector();g.normalize(),g.scaleInPlace(c[e].position.x);for(var h=g.add(c[e].parentWall.getPoints(0).position),i=0;b[i]&&!b[i].isPointOn(h);)i++;b[i]?(c[e].computePositionOnWallChange(b[i]),c[e].setParentWall(b[i])):Logger.warning("Erreur d'attachage !")}for(var e=0,f=d.length;f>e;e++){for(var i=0;b[i]&&!b[i].isPointInPolygon(d[e].position);)i++;b[i]?(b[i].attachedPoints.push(d[e]),d[e].attachedTo=b[i]):Logger.warning("Erreur d'attachage !")}}},a.prototype.weakToStrong=function(a,b){if(a.attachedTo!=this)return Logger.warning("weakToStrong doit ��tre appel�� sur un point attach�� du mur"),!1;var c=this.getPoints(a.position.distanceTo(this.getPoints(0).position)<a.position.distanceTo(this.getPoints(1).position)?0:1);return c.attachedTo?(c.unAttach(),a.unAttach(),a.forceMerge(c,b)):(a.unAttach(),this.points[this.points.indexOf(c)]=a,a.parents.push(this),c.attachedTo=this,this.attachedPoints.push(c),c.parents.splice(c.parents.indexOf(this),1),0==c.parents.length?c.remove(b):c.parents[0].needsUpdate=!0),a.parents[0].needsUpdate=!0,a.parents[1].needsUpdate=!0,!0},a.prototype.tryMerge=function(){Logger.warning("tryMerge is virtual")},a.prototype.updateAttachedPoints=function(){Logger.warning("updateAttachedPoints is virtual")},a.prototype.updateOvertures=function(a){for(var b=0,c=this.overtures.length;c>b;b++)this.overtures[b]&&(this.overtures[b].projectOnWall(),this.overtures[b].clampSize(!0,a))},a.prototype.getNearestPoint=function(a,b){var c,b=b||0,d=this.getWallVector(),e=d.length(),f=a.subtract(this.getPoints(0).position);return f.projectOnVector(d),c=f.dot(d),-b*e>=c?this.getPoints(0).position.subtract(d.normalize().scaleInPlace(b)):c>=d.lengthSquared()+e*b?this.getPoints(1).position.add(d.normalize().scaleInPlace(b)):this.getPoints(0).position.add(f)},a.prototype.getNearestPointOnAxe=function(a){var b,c=this.getWallVector(),d=a.subtract(this.points[0].position);return d.projectOnVector(c),b=d.dot(c),this.points[0].position.add(d)},a.prototype.getNearestPointOnRect=function(){Logger.warning("getNearestPointOnRect is virtual")},a.prototype.isPointInPolygon=function(a){var b=this.getPolygon();return b[0]&&a.isPointInPolygon(b)?!0:!1},a.prototype.getNearestPointOnPolygon=function(a){if(this.isPointInPolygon(a))return a.clone();var b=this.getPolygon();if(!b[0])return Logger.warning("getNearestPointOnPolygon a ��t�� appel�� sur un mur au polygone vide"),null;for(var c,d,e=1/0,f=null,g=0,h=b.length;h>g;g++)d=a.projectOnSegment(b[g],b[(g+1)%h]),c=d.distanceTo(a),e>c&&(f=d,e=c);return f},a.prototype.getBoundingBox=function(){for(var a=1/0,b=-1/0,c=1/0,d=-1/0,e=this.getPolygon(),f=0,g=e.length;g>f;f++)e[f].x<a&&(a=e[f].x),e[f].x>b&&(b=e[f].x),e[f].y<c&&(c=e[f].y),e[f].y>d&&(d=e[f].y);return{min:new BABYLON.Vector2(a,c),max:new BABYLON.Vector2(b,d)}},a.prototype.getNearestWall=function(a,b){for(var c,d=b.getElements("walls"),e=null,f=1/0,g=0,h=d.length;h>g;g++)c=d[g].distanceFrom(a),f>c&&(e=d[g],f=c);return e},a.prototype.distanceFrom=function(a){var b=this.getNearestPoint(a),c=new BABYLON.Vector2;return c=a.subtract(b),c.length()},a.prototype.distanceFromRect=function(a,b,c){var d=this.getNearestPointOnRect(a,b,c),e=new BABYLON.Vector2;return e=a.subtract(d),e.length()},a.prototype.vectorTo=function(a){var b=this.getNearestPoint(a),c=new BABYLON.Vector2;return c=a.subtract(b)},a.prototype.isPointOn=function(a,b){var b=b||1e-5,c=this.distanceFrom(a);return b>=c},a.prototype.getNormalVector=function(a){var a=void 0===a?1:a,b=new BABYLON.Vector2(this.points[0].position.y-this.points[1].position.y,this.points[1].position.x-this.points[0].position.x);return b.normalize(),b.scaleInPlace(a),b},a.prototype.sortAttached=function(){var a=this;a.attachedPoints.sort(function(b,c){return b.position.distanceToSquared(a.points[0].position)-c.position.distanceToSquared(a.points[0].position)})},a.prototype.getAllPoints=function(a){var b=[this.getPoints(0)];return this.sortAttached(),b=b.concat(this.attachedPoints),b.push(this.getPoints(1)),-1==a&&b.reverse(),b},a.prototype.remove=function(a){for(var b=0,c=this.points.length;c>b;b++)for(var d=this.points[b].parents.length-1;d>=0;d--)this.points[b].parents[d]==this&&this.points[b].parents.splice(d,1);for(var e,b=this.attachedPoints.length-1;b>=0;b--)e=this.attachedPoints[b],e.unAttach(),e.needsUpdate=!0,e.parents[0]&&(e.parents[0].needsUpdate=!0);if(void 0!=a){for(var b=0,c=this.points.length;c>b;b++)e=this.points[b],0==e.parents.length?(e.unAttach(a),e.remove(a)):e.needsUpdate=!0;for(var b=this.overtures.length-1;b>=0;b--)this.overtures[b].remove(a);a.removeElement("walls",this)}},a.prototype.addToStructure=function(a){for(var b in this.points)a.insertElement("points",this.points[b]);a.insertElement("walls",this)},a.prototype.paralleleTo=function(a){return void 0===BABYLON.Vector2.Intersect(this.getPoints(0).position,this.getPoints(1).position,a.getPoints(0).position,a.getPoints(1).position)},a.prototype.addMaterial=function(){return Logger.warning("WallStructure.addMaterial is deprecated"),null},a}();var WallPane3D=function(){var a=function(a,b,c){MeasureStructure.call(this,a,b,c),this.materialInfo=null,this.room=null,this.materialIndex=-1};return a.prototype=new MeasureStructure,a.prototype.setRoom=function(a){this.room=a},a.prototype.nearestPane=function(a){for(var b,c=this.center(),d=null,e=1/0,f=0,g=a.length;g>f;f++)a[f]!==this&&(b=a[f].center().distanceTo(c),e>b&&(e=b,d=a[f]));return d},a.prototype.nearestMaterial=function(a){for(var b,c=this.center(),d=null,e=1/0,f=0,g=a.length;g>f;f++)b=a[f].center.distanceTo(c),e>b&&(e=b,d=f);return d},a.prototype.addMaterial=function(a){this.materialInfo||(this.materialInfo=MaterialInfo.MakeFromPane(this));var b=this.materialInfo.material?this.materialInfo.material.clone(this.materialInfo.material.name):null;return this.materialInfo.material=a,this.room.panesMaterials[this.room.panes.indexOf(this)]=this.materialInfo,b},a.prototype.serialize=function(){return this.materialInfo?this.materialInfo.serialize():null},a.Deserialize=function(a){var b=new MaterialInfo;return b.deserialize(a),b},a}();PolygonWall=function(){var a=function(){WallStructure.call(this,"PolygonWall"),this.polygonPoints=[],this.instance="polygon"};return a.prototype=new WallStructure,a.prototype.serialize=function(){var a=WallStructure.prototype.serialize.call(this);return a["class"].name="PolygonWall",a},a.prototype.deserialize=function(a){WallStructure.prototype.deserialize.call(this,a)},a.Deserialize=function(b){var c=new a;return c.deserialize(b),c},a.prototype.getAxis=function(){var a=(this.getWallVector(),this.getNormalVector(this.thickness/2)),b=this.getPoints(0).position,c=this.getPoints(1).position;return[[b.add(a),c.add(a)],[b.subtract(a),c.subtract(a)]]},a.prototype.translate=function(b,c){for(var d=function(b,d,e){var f=new a,g=new PointStructure;g.position.copyFrom(b.position),g.parents=[f,d],b.parents=[e,f],f.points=[b,g],f.thickness=Math.min(d.thickness,e.thickness),f.height=e.height,f.type=d.type;var h=d.points[0]==b?0:1;d.points[h]=g,c.insertElement("walls",f),c.insertElement("points",g)},e=Math.PI/8,f=this.points[0].position.add(b),g=this.points[1].position.add(b),h=null,i=null,j=0,k=this.points[0].parents.length;k>j;j++)this.points[0].parents[j]!=this&&(h=this.points[0].parents[j],h.needsUpdate=!0);for(var j=0,k=this.points[1].parents.length;k>j;j++)this.points[1].parents[j]!=this&&(i=this.points[1].parents[j],i.needsUpdate=!0);var l,m=.01,n=function(a,h,i){if(null!==a){var j=a.getPoints(0).position,k=a.getPoints(1).position;if(a.getLength()<m&&(k=j.add(b)),l=BABYLON.Vector2.GetAbsoluteSine(f,g,j,k),e>l&&void 0!==c)a.getLength()>0&&d(this.points[h],a,this);else{var n=BABYLON.Vector2.Intersect(f,g,j,k);n&&i.copyFromFloats(n.x,n.y)}}}.bind(this);n(h,0,f),n(i,1,g),this.getPoints(0).position.clone(),this.getPoints(1).position.clone(),this.getPoints(0).position.x=f.x,this.getPoints(0).position.y=f.y,this.getPoints(1).position.x=g.x,this.getPoints(1).position.y=g.y;var o,p=function(a){var b=this.getPoints(0).position,d=this.getPoints(1).position,e=a.parents[0];return o=BABYLON.Vector2.Intersect(b,d,e.getPoints(0).position,e.getPoints(1).position),void 0===o?(a.unAttach(c),!1):(o=new BABYLON.Vector2(o.x,o.y),this.distanceFromRect(o,0,c)>BABYLON.Vector2.Precision?!0:!1)};if(void 0!==c){h&&h.updateOvertures(c),i&&i.updateOvertures(c),this.updateAttachedPoints(c);for(var q,j=0;2>j;j++)q=this.getPoints(j).attachedTo,q&&(p.call(q,this.getPoints(j))?(o&&this.getPoints(j).position.copyFrom(o),q.weakToStrong(this.getPoints(j),c)):this.getPoints(j).position.copyFrom(o))}},a.prototype.getIntersections=function(a){var b,c,d,e=a.getElements("walls"),f=5,g=f*f,h=[];for(var i in e)if(e[i]!==this&&(c=this,d=e[i],b=BABYLON.Vector2.Intersect(c.points[0].position,c.points[1].position,d.points[0].position,d.points[1].position),void 0!==b&&!(c.distanceFrom(b)>BABYLON.Vector2.Precision||d.distanceFrom(b)>BABYLON.Vector2.Precision))){var j=[c.points[0].position,c.points[1].position,d.points[0].position,d.points[1].position],k=!1;for(var l in j)k=k||b.distanceToSquared(j[l])<g;if(!k){var m=new PointStructure;m.parents=[c,d],m.position.copyFrom(b),h.push(m)}}return h.sort(function(a,b){return a.position.distanceToSquared(a.parents[0].points[0].position)-b.position.distanceToSquared(a.parents[0].points[0].position)}),h},a.prototype.splitAtIntersections=function(b){var c=this.getIntersections(b),d=[this];for(var e in c){var f=new a,g=new PointStructure;g.position.copyFrom(c[e].position),g.parents=[f],f.points=[this.getPoints(0),g],f.getPoints(0).replaceParent(this,f),f.thickness=this.thickness,f.type=this.type,f.height=this.height,c[e].parents[1].attachedPoints.push(g),g.attachedTo=c[e].parents[1],c[e].parents[1].attachedPoints.push(c[e]),c[e].attachedTo=c[e].parents[1],this.points[0]=c[e],this.points[0].parents=[this],b.insertElement("walls",f),b.insertElement("points",c[e]),b.insertElement("points",g),d.push(f),f.needsUpdate=!0}this.needsUpdate=!0,a.prototype.reorganizeOnSplit(b,d)},a.prototype.tryMerge=function(b){for(var c=b.getElements("walls"),d=(b.getElements("points"),function(a,b,c,d){return-1!=d.indexOf(a)&&d.splice(d.indexOf(a),1),-1!=d.indexOf(b)&&d.splice(d.indexOf(b),1),void 0!==c&&d.push(c),d}),e=15,f=Math.PI/18,g=0,h=c.length;h>g;g++)if(c[g]!=this){var i,j,k,l,m=this,n=c[g],o=m.getPoints(),p=n.getPoints();if(i=m.distanceFrom(p[0].position),j=m.distanceFrom(p[1].position),k=n.distanceFrom(o[0].position),l=n.distanceFrom(o[1].position),!(i>e&&j>e&&k>e&&l>e)&&m.thickness==n.thickness&&m.type==n.type&&m.height==n.height){var q,r=m.getWallVector(),s=n.getWallVector(),t=new BABYLON.Vector2(r.x,r.y).normalize(),u=new BABYLON.Vector2(s.x,s.y).normalize();if(q=Math.abs(t.determinant(u)),!(q>f)){for(var v,w,x,y,z,A=-1/0,B=[o[0],o[1],p[0],p[1]],C=0;4>C;C++)for(var D=0;4>D;D++)if(C!=D&&(z=B[C].position.subtract(B[D].position).length(),z>A)){v=B[C],w=B[D];for(var E=-1,F=-1,G=0;4>G;G++)G!=C&&G!=D&&(-1!=E?-1==F&&(F=G):E=G);x=B[E],y=B[F],A=z}var H,I;if(H=x.wallAttached(b),I=y.wallAttached(b),!H||H!==I){var J=new a;J.points[0]=v,J.points[1]=w,J.attachedPoints=m.attachedPoints.concat(n.attachedPoints);for(var K=0;K<J.attachedPoints.length;K++)J.attachedPoints[K].attachedTo=J;J.thickness=m.thickness,J.type=m.type,J.height=m.height;for(var C=m.overtures.length-1;C>=0;C--)m.overtures[C].computePositionOnWallChange(J),m.overtures[C].setParentWall(J);for(var C=n.overtures.length-1;C>=0;C--)n.overtures[C].computePositionOnWallChange(J),n.overtures[C].setParentWall(J);b.insertElement("walls",J),v.parents=d(m,n,J,v.parents),w.parents=d(m,n,J,w.parents),v.unAttach(b),w.unAttach(b),v.position=n.getLength()>5?n.getNearestPointOnAxe(v.position):m.getNearestPointOnAxe(v.position),w.position=n.getLength()>5?n.getNearestPointOnAxe(w.position):m.getNearestPointOnAxe(w.position);for(var C=0,h=J.attachedPoints.length;h>C;C++)J.attachedPoints[C].position=J.getNearestPoint(J.attachedPoints[C].position);for(var L=[x,y],C=0;2>C;C++)if(L[C]!==v&&L[C]!==w)if(void 0!=L[C].parents[0]&&void 0!=L[C].parents[1]){if(L[C].parents[0]==m&&L[C].parents[1]==n||L[C].parents[0]==n&&L[C].parents[1]==m)L[C].unAttach(b),L[C].remove(b);else if(L[C].parents=d(m,n,void 0,L[C].parents),L[C].position=J.getNearestPoint(L[C].position),L[C].parents[0]!==J){var M=L[C].tryMerge(b);M===L[C]&&(J.attachedPoints.push(L[C]),L[C].attachedTo=J,L[C].position=J.getNearestPoint(L[C].position))}}else L[C].unAttach(b),L[C].remove(b);return m.remove(b),n.remove(b),v.needsUpdate=!0,w.needsUpdate=!0,J.tryMerge(b)}}}}return this},a.prototype.updateAttachedPoints=function(a){for(var b=this.attachedPoints.length-1;b>=0;b--){var c=this.attachedPoints[b].parents[0],d=this.getPoints(0).position,e=this.getPoints(1).position;if(c){var f=BABYLON.Vector2.Intersect(d,e,c.getPoints(0).position,c.getPoints(1).position,Math.PI/18),g=this.attachedPoints[b];if(void 0!==f){if(this.distanceFrom(f)>BABYLON.Vector2.Precision){this.attachedPoints[b].position.copyFrom(f);var g=this.attachedPoints[b];this.weakToStrong(this.attachedPoints[b],a)}else this.attachedPoints[b].position.copyFrom(f);c.needsUpdate=!0,c.updateOvertures(a)}else g.unAttach(a),g.needsUpdate=!0}else Logger.warning("Un point attach�� n'a plus de parent !"),Logger.warning(this)}},a.prototype.getNearestPointOnRect=function(a,b){for(var b=b||0,c=this.getPolygon(),d=[],e=this.getWallVector().normalize(),f=0,g=c.length;g>f;f++)d.push(this.getNearestPointOnAxe(c[f]));for(var h,i=1/0,j=-1/0,k=new BABYLON.Vector2,l=this.getPoints(0).position,f=0,g=d.length;g>f;f++)h=k.copyFrom(d[f]).subtractInPlace(l).dot(e),i>h&&(i=h),h>j&&(j=h);var h,m=e.scale(i).addInPlace(l),n=e.scale(j).addInPlace(l),o=n.subtract(m),p=o.length(),q=a.subtract(m);return q.projectOnVector(o),h=q.dot(o),-b*p>=h?m.subtract(o.normalize().scaleInPlace(b)):h>=o.lengthSquared()+p*b?n.add(o.normalize().scaleInPlace(b)):m.add(q)},a}(),CurvedWall=function(){var a=function(){PolygonWall.call(this,"CurvedWall"),this.TYPE_NORMAL=1,this.TYPE_SEPARATOR=2,this.type=this.TYPE_NORMAL,this.polygonPoints=[],this.instance="curved",this.cp=null};return a.prototype=new PolygonWall,a.prototype.serialize=function(){var a=PolygonWall.prototype.serialize.call(this);return a.type=this.type,a.cp={x:this.cp.x,y:this.cp.y,z:this.cp.z},a},a.prototype.isTargeted=function(a){var b=document.createElement("canvas"),c=b.getContext("2d");if(this.draw(c),c.isPointInPath(a.x,a.y))return delete b,!0;var d=this.getCp();return a.distanceTo(d)<10?(delete b,d):(c.beginPath(),c.moveTo(this.getPoints(0).position.x,this.getPoints(0).position.y),c.quadraticCurveTo(d.x,d.y,this.getPoints(1).position.x,this.getPoints(1).position.y),c.lineTo(d.x,d.y),c.closePath(),c.isPointInPath(a.x,a.y)?(delete b,!0):(delete b,!1))},a.prototype.computeDefault=function(a){this.computeCp();var b=this.getCp(),c=this.getPoints(a).position.clone().subtractInPlace(b).normalize().scaleInPlace(this.thickness/2),d=new BABYLON.Vector3(c.y,-c.x,0),e=this.getPoints(a).position,f=e.clone().subtractInPlace(d),g=e.clone(),h=e.clone().add(d);this._edgePolygons[a]=[h,g,f]},a.prototype.translate=function(a,b){PolygonWall.prototype.translate.call(this,a,b),this.getCp().add(a)},a.prototype.computeCp=function(a){var a=a||!1;if(this.cp&&!a)var b=this.cp;else{var b=this.getPoints(0).position.clone().lerp(this.getPoints(1).position,.5);b.add(this.getNormalVector(this.getLength()/2))}var c=this.getNormalVector(this.thickness/2),d=b.clone().subtractInPlace(c),e=b.clone().add(c);this.cp=b,this._edgePolygons[2]=[d,e]},a.prototype.deserialize=function(a){PolygonWall.prototype.deserialize.call(this,a),this.type=a.type,this.cp=new BABYLON.Vector3(a.cp.x,a.cp.y,a.cp.z)},a.prototype.getAxis=function(a){var b=this.getCp(),c=this.getPoints(a).position.clone().subtractInPlace(b).normalize().scaleInPlace(this.thickness/2),d=new BABYLON.Vector3(c.y,-c.x,0),e=this.getPoints(a).position,f=b,g=e.clone().add(d),h=f.clone().add(d),i=e.clone().subtractInPlace(d),j=f.clone().subtractInPlace(d);return 1==a?[[j,i],[h,g]]:[[g,h],[i,j]]},a.prototype.getCp=function(){return this.cp||this.computeCp(),this.cp},a.prototype.draw=function(a){var b=this._edgePolygons[0],c=this._edgePolygons[1];"undefined"==typeof this._edgePolygons[2]&&this.computeCp();var d=this._edgePolygons[2];a.beginPath(),a.moveTo(b[2].x,b[2].y),a.quadraticCurveTo(d[0].x,d[0].y,c[0].x,c[0].y),a.lineTo(c[1].x,c[1].y),a.lineTo(c[2].x,c[2].y),a.quadraticCurveTo(d[1].x,d[1].y,b[0].x,b[0].y),a.lineTo(b[1].x,b[1].y),a.fill()},a}();var WallComponent2D=function(){var a=function(a){BaseComponent2D.call(this,a,"WallComponent2D"),this.TYPE_NORMAL=1,this.TYPE_SEPARATOR=2,this._COLORS=["#333333","#616161","#BEBEBE","#EEEEEE"],this._PATTERNS=[null,null,null,null],this._PATTERN_IMGS=[new Image,new Image,null,null],this._PATTERN_IMGS[0].addEventListener("load",function(){this._PATTERNS[0]=hcsdesign.engine2D.canvas.getContext("2d").createPattern(this._PATTERN_IMGS[0],"repeat"),hcsdesign.engine2D.requestStaticDraw()}.bind(this),!1),this._PATTERN_IMGS[1].addEventListener("load",function(){this._PATTERNS[1]=hcsdesign.engine2D.canvas.getContext("2d").createPattern(this._PATTERN_IMGS[1],"repeat"),hcsdesign.engine2D.requestStaticDraw()}.bind(this),!1),this._PATTERN_IMGS[0].src=hcs.Assets.globalPath+"js/Components/CoreComponents/Wall/Images/pattern.png",this._PATTERN_IMGS[1].src=hcs.Assets.globalPath+"js/Components/CoreComponents/Wall/Images/pattern_tmp.png",this.priority=10,this._tmpWall=null,this._tmpThickness=20,this._tmpType=this.TYPE_NORMAL,this._tmpDragStartPt=null,this._lastPlanPos=new BABYLON.Vector3,this._updateList=[],this._applyHeightToAll=!1,this._minWallLengthRatio=.01,this._draggingMinWallLengthRatio=.5,this.displayMesure=!0};return a.prototype=new BaseComponent2D,a.WALL_OFFSET=10,a.prototype.startListening=function(){this.onAddWall=this.onAddWall.bind(this),this.onAddWallEnd=this.onAddWallEnd.bind(this),document.addEventListener("hcs.engine2d.onAddWall",this.onAddWall,!1),document.addEventListener("hcs.engine2d.onAddWallEnd",this.onAddWallEnd,!1),this.core.engine2D.registerEventCb("WallComponent2D.static-draw",this.priority,"static-draw",null,null,this.onStaticDraw.bind(this),null),this.core.engine2D.registerEventCb("WallComponent2D.hover",this.priority,"hover",this.core.engine2D.MODE_NORMAL|this.core.engine2D.MODE_DRAW|this.core.engine2D.MODE_CONTEXTMENU,WallStructure,this.onHover.bind(this),null),this.core.engine2D.registerEventCb("WallComponent2D.leave",this.priority,"leave",this.core.engine2D.MODE_NORMAL|this.core.engine2D.MODE_DRAW|this.core.engine2D.MODE_CONTEXTMENU,WallStructure,this.onLeave.bind(this),null),this.core.engine2D.registerEventCb("WallComponent2D.double-click",this.priority,"double-click",this.core.engine2D.MODE_NORMAL,WallStructure,this.onDoubleClick.bind(this),null),this.core.engine2D.registerEventCb("WallComponent2D.context-menu",this.priority,"click",this.core.engine2D.MODE_NORMAL,WallStructure,this.onContextMenu.bind(this),null),GlobalHelper.isMobileDevice()&&hcsdesign.engine2D.registerEventCb("WallComponent2D.mobile-drag-start",this.priority,"drag-start",hcsdesign.engine2D.MODE_NORMAL,null,this.onMobileDragStart.bind(this),null)
},a.prototype.stopListening=function(){document.removeEventListener("hcs.engine2d.onAddWall",this.onAddWall,!1),document.removeEventListener("hcs.engine2d.onAddWallEnd",this.onAddWallEnd,!1),this.core.engine2D.unregisterEventCb("WallComponent2D.static-draw"),this.core.engine2D.unregisterEventCb("WallComponent2D.hover"),this.core.engine2D.unregisterEventCb("WallComponent2D.leave"),this.core.engine2D.unregisterEventCb("WallComponent2D.double-click"),this.core.engine2D.unregisterEventCb("WallComponent2D.context-menu"),GlobalHelper.isMobileDevice()&&hcsdesign.engine2D.unregisterEventCb("WallComponent2D.drag-start")},a.prototype.initialize=function(){this.startListening();var a={title:_("房间和墙"),id:"rooms_walls",items:[{title:_("承重墙"),action:"hcs.engine2d.onAddWall",cancelAction:"hcs.engine2d.onAddWallEnd",params:{wallType:this.TYPE_NORMAL,thickness:30,putPoint:!1}},{title:_("墙"),action:"hcs.engine2d.onAddWall",cancelAction:"hcs.engine2d.onAddWallEnd",params:{wallType:this.TYPE_NORMAL,thickness:7,putPoint:!1}}]};ujs.notify("hcs.menu.main.add",{item:a,menuPath:"draw2D",position:.5})},a.prototype.update=function(a){var b,c=a||this.structure.getCurrentStructure(),d=c.getElements("walls");this._updateList.length=0;for(var e=d.length-1;e>=0;e--)d[e].needsUpdate&&(this._updateList.push(d[e]),d[e].needsUpdate=!1);for(var e=this._updateList.length-1;e>=0;e--){for(var f=0;2>f;f++)1==this._updateList[e].getPoints(f).parents.length&&this._updateList[e].computeDefault(f);this._updateList[e].computeCp&&this._updateList[e].computeCp()}for(var e=this._updateList.length-1;e>=0;e--)for(var f=0;2>f;f++)if(2==this._updateList[e].getPoints(f).parents.length)for(var g=0;2>g;g++)b=this._updateList[e].getPoints(f).parents[g].getPoints().indexOf(this._updateList[e].getPoints(f)),this._updateList[e].getPoints(f).parents[g].computeStrong(b);for(var e=this._updateList.length-1;e>=0;e--){for(var f=0;2>f;f++)this._updateList[e].getPoints(f).attachedTo&&this._updateList[e].computeWeak(f);this._updateList[e].needsUpdate=!1,this._updateList[e].update(c)}this._updateList.length&&c.dirty()},a.prototype.getTargeted=function(a){var b=this.structure.getCurrentStructure().getElements("walls");for(var c in b)if(b[c].isTargeted(a))return b[c];return null},a.prototype.simplifyWalls=function(){for(var a=this.structure.getCurrentStructure(),b=a.getElements("walls"),c=a.getElements("points"),d=b.length-1;d>=0;d--){var e,f;b[d].getLength()<this._minWallLengthRatio*b[d].thickness&&(e=b[d].points[0],f=b[d].points[1],b[d].remove(a),-1!=c.indexOf(e)&&e.forceMerge(f,a))}},a.prototype._drawWall=function(a,b,c,d,e){var e=e||{},f=(e.measureDisplayed===!1?!1:!0,e.styleId||0);a.fillStyle=this._PATTERNS[f]||this._COLORS[f],a.strokeStyle=this._COLORS[f],a.save(),a.translate(b.x,b.y),a.scale(c,c),d.draw(a),a.restore()},a.prototype._drawMeasures=function(a,b,c){hcsdesign.getComponentByName("MeasureComponent").draw(a,b,c)},a.prototype._addWallFirstPoint=function(a,b){var c=hcsdesign.getComponentByName("MagnetismComponent2D",hcsdesign.ENGINE_2D),d=(hcsdesign.getComponentByName("PointComponent2D",hcsdesign.ENGINE_2D),hcsdesign.getSelectedStructure());this._tmpWall=new PolygonWall,this._tmpWall.height=d.height,this._tmpWall.thickness=this._tmpThickness,this._tmpWall.type=this._tmpType||this._tmpWall.TYPE_NORMAL;var e=b||new PointStructure,f=new PointStructure;b||(e.position=a.planPos.clone()),f.position=a.planPos.clone(),b||(c&&c.addVirtualPoint(this.name,e),hcsdesign.engine2D.setEnableAutoScroll(!0)),c&&c.onWallDrawStart(e),this._tmpWall.setPoints([e,f]),hcsdesign.engine2D.requestStaticDraw()},a.prototype._addWallNewPoint=function(a){var b=hcsdesign.getSelectedStructure(),c=hcsdesign.getComponentByName("MagnetismComponent2D",hcsdesign.ENGINE_2D);hcsdesign.getComponentByName("PointComponent2D",hcsdesign.ENGINE_2D),c.removeVirtualPoint(this.name,null),this._tmpWall.getPoints(1).position=a.planPos.clone(),this._tmpWall.addToStructure(b);var d=!1,e=this._tmpWall.tryMerge(b);for(var f in this._tmpWall.points){var g=e.points[f],h=e.points[f].tryMerge(b);g!=h&&(h.parents[0].update(b),h.parents[1].update(b),1==f&&(d=!0))}return e.splitAtIntersections(b),d},a.prototype._addWallUpdate=function(a){var b=this._tmpWall.getPoints(1);b.position=a.planPos.clone(),this._tmpWall.setPoints(b,1),this._tmpWall.needsUpdate=!0,hcsdesign.engine2D.requestDynamicDraw()},a.prototype.onStaticDraw=function(a,b,c){var d=!1;if(d=this.structure.getElement(+this.structure.getCurrentStructure().id-1))for(var e=d.getElements("walls"),f=0;f<e.length;f++)if(e[f].thickness>=15){var g={measureDisplayed:!1,styleId:3};this._drawWall(a,b,c,e[f],g)}var h=this.structure.getCurrentStructure().getElements("walls");for(var f in h){var g={styleId:h[f].type==h[f].TYPE_SEPARATOR?2:0};this._drawWall(a,b,c,h[f],g)}this.displayMesure&&(hcsdesign.getComponentByName("MeasureComponent").buildFromRooms(hcsdesign.getSelectedStructure().internalRooms,hcsdesign.getSelectedStructure().externalRooms),this._drawMeasures(a,b,c))},a.prototype.onDragStart=function(a,b,c){return b.targeted=b&&b.isTargeted(c.planPos)instanceof BABYLON.Vector3?b.cp:!1,this._lastPlanPos.copyFrom(c.planPos),hcsdesign.engine2D.registerEventCb("WallComponent2D.dragging",this.priority,"dragging",hcsdesign.engine2D.MODE_DRAG,null,this.onDragging.bind(this),b),hcsdesign.engine2D.registerEventCb("WallComponent2D.drag-end",this.priority,"drag-end",hcsdesign.engine2D.MODE_DRAG,null,this.onDragEnd.bind(this),b),hcsdesign.engine2D.registerEventCb("WallComponent2D.dynamic-draw",this.priority,"dynamic-draw",hcsdesign.engine2D.MODE_DRAG,null,this.onSelectionDynamicDraw.bind(this),b),hcsdesign.engine2D.registerEventCb("WallComponent2D.drag.hover",this.priority,"hover",hcsdesign.engine2D.MODE_DRAG,WallStructure,this.onHover.bind(this),b),hcsdesign.engine2D.registerEventCb("WallComponent2D.drag.leave",this.priority,"leave",hcsdesign.engine2D.MODE_DRAG,WallStructure,this.onLeave.bind(this),b),!1},a.prototype.onDragging=function(a,b,c,d){var e;if(e=c.forcePosition?c.forcePosition.clone().subtractInPlace(d.getPoints(0).position):c.planPos.clone().subtractInPlace(this._lastPlanPos),this._lastPlanPos.copyFrom(c.planPos),d.needsUpdate=!0,d.targeted)return d.cp.addInPlace(mouseVector),hcsdesign.engine2D.requestStaticDraw(),!1;var f=e.clone().projectOnVector(d.getWallVector()),g=e.subtractInPlace(f);return d.translate(g,this.structure.getCurrentStructure()),d.getLength()<this._draggingMinWallLengthRatio*d.thickness&&(d.remove(this.structure.getCurrentStructure()),hcsdesign.engine2D.setMode(hcsdesign.engine2D.MODE_NORMAL),this.simplifyWalls(),hcsdesign.getSelectedStructure().dirty(),hcsdesign.engine2D.requestStaticDraw(),hcsdesign.engine2D.unregisterEventCb("WallComponent2D.dynamic-draw")),hcsdesign.engine2D.requestStaticDraw(),!1},a.prototype.onDragEnd=function(a,b,c,d){var e=this.structure.getCurrentStructure(),f=e.getElements("walls");PolygonMerger.merge(f);var g=d.tryMerge(e),h=g.points[0],i=g.points[1];h.needsUpdate=!0,i.needsUpdate=!0;var j=h.parents[(h.parents.indexOf(g)+1)%2],k=i.parents[(i.parents.indexOf(g)+1)%2];j&&j.splitAtIntersections(e),k&&k.splitAtIntersections(e),g.splitAtIntersections(e);for(var l=0,m=g.attachedPoints.length;m>l;l++)g.attachedPoints[l].parents[0]&&g.attachedPoints[l].parents[0].splitAtIntersections(e);j&&j.tryMerge(e),k&&k.tryMerge(e);for(var l=0,m=g.attachedPoints.length;m>l;l++)g.attachedPoints[l].parents[0]&&g.attachedPoints[l].parents[0].tryMerge(e);this.update(),this.simplifyWalls(),hcsdesign.getComponentByName("PointComponent2D").update(),hcsdesign.getSelectedStructure().dirty(),hcsdesign.engine2D.requestStaticDraw(),hcsdesign.engine2D.unregisterEventCb("WallComponent2D.dynamic-draw"),hcsdesign.engine2D.unregisterEventCb("WallComponent2D.drag.hover"),hcsdesign.engine2D.unregisterEventCb("WallComponent2D.drag.leave"),this.update()},a.prototype.onHover=function(a,b,c,d){var b=d||b;return hcsdesign.engine2D.registerEventCb("WallComponent2D.dynamic-draw",this.priority,"dynamic-draw",null,null,this.onSelectionDynamicDraw.bind(this),b),hcsdesign.engine2D.registerEventCb("WallComponent2D.drag-start",this.priority,"drag-start",hcsdesign.engine2D.MODE_NORMAL,WallStructure,this.onDragStart.bind(this),null),hcsdesign.engine2D.requestDynamicDraw(),!1},a.prototype.onLeave=function(){hcsdesign.engine2D.unregisterEventCb("WallComponent2D.dynamic-draw"),hcsdesign.engine2D.unregisterEventCb("WallComponent2D.drag-start"),hcsdesign.engine2D.requestDynamicDraw()},a.prototype.onMobileDragStart=function(a,b,c,d){return b?this.onDragStart(a,b,c,d):void 0},a.prototype.onSelectionDynamicDraw=function(a,b,c,d){var e=d.getPoints(),f={x:e[0].position.x*c+b.x,y:e[0].position.y*c+b.y},g={x:e[1].position.x*c+b.x,y:e[1].position.y*c+b.y};if("curved"==d.instance){var h=d.getCp(),i={x:h.x*c+b.x,y:h.y*c+b.y};hcsdesign.engine2D.symbols2D.drawPoint(a,i),hcsdesign.engine2D.symbols2D.drawMeasure(a,f,i),hcsdesign.engine2D.symbols2D.drawMeasure(a,g,i),hcsdesign.engine2D.symbols2D.drawArc(a,f,i,g)}else hcsdesign.engine2D.symbols2D.drawSegment(a,f,g)},a.prototype.onDoubleClick=function(a,b,c){var d=hcsdesign.getSelectedStructure(),e=new PointStructure;e.position=b.getNearestPoint(c.planPos);var f=new PolygonWall;f.height=b.height,f.type=b.type,f.thickness=b.thickness,f.points=[e,b.getPoints(1)],b.points[1]=e,e.parents=[f,b],f.getPoints(1).parents.splice(f.getPoints(1).parents.indexOf(b),1),f.getPoints(1).parents.push(f),f.reorganizeOnSplit(d,[f,b]),d.insertElement("points",e),d.insertElement("walls",f),hcsdesign.engine2D.requestStaticDraw()},a.prototype.onAddWall=function(a){if(this._tmpThickness=a.thickness,this._tmpType=a.wallType,this._tmpRounded=a.rounded||!1,hcsdesign.engine2D.setMode(hcsdesign.engine2D.MODE_DRAW),hcsdesign.engine2D.registerEventCb("WallComponent2D.add-wall.dynamic-draw",this.priority,"dynamic-draw",hcsdesign.engine2D.MODE_DRAW,null,this.onAddWallDynamicDraw.bind(this),null),hcsdesign.engine2D.registerEventCb("WallComponent2D.add-wall.click",this.priority,"click",hcsdesign.engine2D.MODE_DRAW,null,this.onAddWallClick.bind(this),null),hcsdesign.engine2D.registerEventCb("WallComponent2D.add-wall.drag-start",this.priority,"drag-start",hcsdesign.engine2D.MODE_DRAW,null,this.onAddWallDragStart.bind(this),null),hcsdesign.engine2D.registerEventCb("WallComponent2D.add-wall.mouse-move",this.priority,"mouse-move",hcsdesign.engine2D.MODE_DRAW,null,this.onAddWallMouseMove.bind(this),null),hcsdesign.engine2D.registerEventCb("WallComponent2D.add-wall.draw-end",this.priority,"draw-end",hcsdesign.engine2D.MODE_DRAW,null,this.onAddWallDrawEnd.bind(this),null),1==a.putPoint){var b=hcsdesign.engine2D.getMouseState(),c=hcsdesign.getComponentByName("MagnetismComponent2D",hcsdesign.ENGINE_2D);c.applyPointMag(b),this.onAddWallClick(a,null,b,null)}},a.prototype.onAddWallEnd=function(){hcsdesign.engine2D.setMode(hcsdesign.engine2D.MODE_NORMAL)},a.prototype.onAddWallClick=function(a,b,c,d){var e=hcsdesign.getComponentByName("MagnetismComponent2D");if("touchUp"==a.type&&null!=this._tmpWall&&this.onAddWallMouseMove(a,b,c,d),hcsdesign.getSelectedStructure().dirty(),!d&&null!=this._tmpWall&&this._tmpWall.getLength()<=10)return hcsdesign.getComponentByName("PointComponent2D").update(),hcsdesign.engine2D.setMode(hcsdesign.engine2D.MODE_NORMAL),ujs.notify("hcs.menu.main.deselect"),e&&e.onWallDrawEnd(),void hcsdesign.engine2D.requestStaticDraw();var f=!1;if(!d&&null!=this._tmpWall&&(b instanceof WallStructure||b instanceof PointStructure)&&(f=!0),null==this._tmpWall)this._addWallFirstPoint(c);else{var g=this._addWallNewPoint(c);f||g?(this._tmpWall=null,hcsdesign.getComponentByName("PointComponent2D").update(),hcsdesign.getSelectedStructure().update(),hcsdesign.engine2D.setMode(hcsdesign.engine2D.MODE_NORMAL),ujs.notify("hcs.menu.main.deselect"),e&&e.onWallDrawEnd(),hcsdesign.engine2D.requestStaticDraw()):this._addWallFirstPoint(c,this._tmpWall.getPoints(1))}},a.prototype.onAddWallDragStart=function(a,b,c){return 0==(c.buttons&c.BUTTON_LEFT)?!0:(this._tmpDragStartPt=c.planPos.clone(),hcsdesign.engine2D.registerEventCb("WallComponent2D.add-wall.drag-end",this.priority,"drag-end",hcsdesign.engine2D.MODE_DRAG,null,this.onAddWallDragEnd.bind(this),null),hcsdesign.engine2D.registerEventCb("WallComponent2D.add-wall.dragging",this.priority,"dragging",hcsdesign.engine2D.MODE_DRAG,null,this.onAddWallMouseMove.bind(this),null),!1)},a.prototype.onAddWallDragEnd=function(a,b,c,d){hcsdesign.getSelectedStructure().dirty();var e=hcsdesign.getComponentByName("MagnetismComponent2D");if(!d&&null!=this._tmpWall&&this._tmpWall.getLength()<=10)return hcsdesign.getComponentByName("PointComponent2D").update(),hcsdesign.engine2D.setMode(hcsdesign.engine2D.MODE_NORMAL),ujs.notify("hcs.menu.main.deselect"),void(e&&e.onWallDrawEnd());var f=!1;if(null!=this._tmpWall&&(b instanceof WallStructure||b instanceof PointStructure)&&(f=!0),null==this._tmpWall)this._addWallFirstPoint(c);else{var g=this._addWallNewPoint(c);f||g?(this._tmpWall=null,hcsdesign.getComponentByName("PointComponent2D").update(),hcsdesign.getSelectedStructure().dirty(),hcsdesign.engine2D.setMode(hcsdesign.engine2D.MODE_NORMAL),ujs.notify("hcs.menu.main.deselect"),e&&e.onWallDrawEnd()):this._addWallFirstPoint(c,this._tmpWall.getPoints(1))}},a.prototype.onAddWallMouseMove=function(a,b,c){if(null!=this._tmpWall&&null==this._tmpDragStartPt)this._tmpWall.needsUpdate=!0,this._addWallUpdate(c);else if(null!=this._tmpDragStartPt&&this._tmpDragStartPt.distanceTo(c.planPos)>10){var c=c;c.planPos=this._tmpDragStartPt,this._tmpDragStartPt=null,this.onAddWallClick(a,b,c,!0)}},a.prototype.onAddWallDynamicDraw=function(a,b,c){if(null!=this._tmpWall){this._tmpWall.getLength()>5&&(this._tmpWall.computeCp&&this._tmpWall.computeCp(!0),this._tmpWall.computeDefault(0),this._tmpWall.computeDefault(1),this._drawWall(a,b,c,this._tmpWall,{styleId:1}),this.displayMesure&&hcsdesign.getComponentByName("MeasureComponent").drawTmpWallMesure(a,b,c));var d={x:this._tmpWall.points[0].position.x,y:this._tmpWall.points[0].position.y};d.x=d.x*c+b.x,d.y=d.y*c+b.y,1==this._tmpWall.points[0].parents.length?hcsdesign.engine2D.symbols2D.drawCancelGrip(a,d,[!1,!1,!1,!1],0):hcsdesign.engine2D.symbols2D.drawCheckGrip(a,d,[!1,!1,!1,!1],0);var e=hcsdesign.engine2D.getTarget();(e instanceof WallStructure||e instanceof PointStructure)&&hcsdesign.engine2D.setCursorIcon(hcsdesign.engine2D.symbols2D.drawCursorCheck.bind(hcsdesign.engine2D.symbols2D))}},a.prototype.onAddWallDrawEnd=function(){null!=this._tmpWall&&this._tmpWall.remove(),this._tmpWall=null,this._tmpDragStartPt=null;var a=hcsdesign.getComponentByName("MagnetismComponent2D",hcsdesign.ENGINE_2D);a.removeVirtualPoint(this.name,null),hcsdesign.engine2D.requestStaticDraw()},a.prototype.onContextMenu=function(a,b){var c=[];b.type!=b.TYPE_SEPARATOR&&(c.push({name:"thickness",label:_("厚度"),type:"slider",cast:"int",unit:"cm",value:{min:3,max:100,step:1,value:b.thickness}}),c.push({name:"height",label:_("高度"),type:"slider",cast:"int",unit:"cm",value:{min:20,max:1e3,step:10,value:b.height}}),c.push({name:"_applyHeightToAll",label:_("将高度应用到所有的墙"),type:"checkbox",cast:"bool",value:this._applyHeightToAll})),c.push({name:"measureDist",label:_("度量信息离目标物体的距离"),type:"slider",cast:"int",unit:"cm",value:{min:5,max:50,step:1,value:b.measureDist}}),c.push({name:"measureDisplayed",label:_("显示度量信息"),type:"checkbox",cast:"bool",value:b.measureDisplayed}),hcsdesign.engine2D.displayContextMenu(c,b,this.onContextMenuPropertyChanged.bind(this),this.onContextMenuRemove.bind(this))},a.prototype.onContextMenuPropertyChanged=function(a,b,c){"_applyHeightToAll"==b?this._applyHeightToAll=c:a[b]=c;var d=hcsdesign.getSelectedStructure(),e=d.getElements("walls");if("height"!=b&&"_applyHeightToAll"!=b||!this._applyHeightToAll){for(var f=0,g=1;g<e.length;g++)e[f].height<e[g].height&&(f=g);d.height=e[f].height}else{for(var g=0;g<e.length;g++)e[g].height=a.height;d.height=a.height}hcsdesign.structure.updateFloorElevations(),a.needsUpdate=!0,hcsdesign.engine2D.requestStaticDraw()},a.prototype.onContextMenuRemove=function(a){var b=hcsdesign.getSelectedStructure();a.remove(b)},a}(),WallComponent3D=function(){var a,b=function(b){BaseComponent3D.call(this,b,"WallComponent3D"),this.walls=[],this.initialized=!1,this.defaultWallTexture=null,this.priority=10,a=this,this._defaultMaterial=new hcs.WhiteMaterial("defaultWall",hcsdesign.engine3D.scene,{factor:1})};b.prototype=new BaseComponent3D,b.prototype.onRoomsReady=function(b){var c=b.floor||a.getFloor(),d=b.structure||a.core.getSelectedStructure();a.walls.length=0;var e=a.draw(d);ujs.notify("hcs.engine3d.wallsReady",{floor:c,structure:d,walls:e})},b.prototype.startListening=function(){document.addEventListener("hcs.engine3d.roomsReady",this.onRoomsReady,!1)},b.prototype.stopListening=function(){document.addEventListener("hcs.engine3d.roomsReady",this.onRoomsReady,!1)},b.prototype.get3DWallFrom2D=function(a){return hcsdesign.engine3D.scene.getMeshByName("WallMesh_"+a.id)},b.prototype.replaceWall=function(a,b){-1!=hcsdesign.engine3D.scene.meshes.indexOf(a)&&(b.name=a.name,b.id=a.id,b.boundingBoxes=a.boundingBoxes,b.objectInstances=a.objectInstances,b.decorate=a.decorate,b.receiveShadows=a.receiveShadows,a.dispose())};var c=function(a,b){for(var c,d,e,f=0,g=this.subMeshes.length;g>f;f++)3*b.faceId>=this.subMeshes[f].indexStart&&3*b.faceId<this.subMeshes[f].indexStart+this.subMeshes[f].indexCount&&(c=this.objectInstances[f],c&&(d=this.material.subMaterials[f].name,this.material.subMaterials[f]=a,c.materialInfo?e=c.addMaterial(a):"OvertureStructure"==c.name?(e=c.material.clone(c.material.name),c.material=a):(e=c.materials[d].clone(d),c.materials[d]=a,c.materials[d].name=d)));return e};return b.prototype.draw=function(a){a=a||hcsdesign.getSelectedStructure();var b=hcsdesign.getComponentByName("RoomComponent2D").getInternalRooms(),d=hcsdesign.getComponentByName("RoomComponent2D").getExternalRooms(),e=hcsdesign.getComponentByName("MeasureComponent"),f=e.getInternalMeasures(),g=(e.getExternalMeasures(),a.getElements("walls")),h=hcsdesign.getComponentByName("FloorComponent3D").getFloor(a),i=new BABYLON.Mesh("WallMesh_"+a.id,hcsdesign.engine3D.scene),j=[],k=[],l=[],m=[],n={};i.objectInstances=[],i.material=new BABYLON.MultiMaterial("wall_material",hcsdesign.engine3D.scene),i.material.subMaterials.push(new hcs.WhiteMaterial("white",hcsdesign.engine3D.scene),new hcs.WhiteMaterial("white",hcsdesign.engine3D.scene));var o,p,q,r,s,t,u,v,w,x={},y=0,z=0,A=1;i.boundingBoxes=[];var B,C=[],D=new BABYLON.Vector3,E=new BABYLON.Vector3,F=function(a,b,c,d,e,f){var f=f||0;C.length=0,j.push(a.x,f,-a.y,b.x,f,-b.y),C.push(a.x,f,-a.y,b.x,f,-b.y),j.push(a.x,c,-a.y,b.x,c,-b.y),C.push(a.x,c,-a.y,b.x,c,-b.y),D.copyFromFloats(b.x-a.x,f,-b.y+a.y),E.copyFromFloats(0,c,0),B=BABYLON.Tools.PlaneUVProjection(C,D,E,512);for(var g=0,h=B.length;h>g;g++)l.push(B[g]);e?(v=!0,m.push(z+3,z+1,z),m.push(z,z+2,z+3)):(m.push(z,z+1,z+3),m.push(z+3,z+2,z),v=!1)},G=function(a){for(var b,c,d=0,e=a.length;e>d;d++){o=a[d].parent,p=new BABYLON.Vector3(a[d].offsetVector.x,0,-a[d].offsetVector.y),F(a[d].points[0],a[d].points[1],o.height,b,p),c=a[d].materialInfo&&a[d].materialInfo.material?a[d].materialInfo.material:this._defaultMaterial.clone("defaultWall"),a[d].addMaterial(c),a[d].materialIndex=A+1,i.material.subMaterials.push(c),q=new BABYLON.Vector3(j[3*m[3*y+1]],j[3*m[3*y+1]+1],j[3*m[3*y+1]+2]),r=new BABYLON.Vector3(j[3*m[3*y+2]],j[3*m[3*y+2]+1],j[3*m[3*y+2]+2]),w=q.clone().lerp(r,.5),u=-Math.atan2(r.z-q.z,r.x-q.x),t=r.distanceTo(q);var f=new BABYLON.Vector3(-t/2,0,0).add(w),g=new BABYLON.Vector3(t/2,o.height,0).add(w);s=new BABYLON.BoundingBox(new BABYLON.Vector3(Math.min(f.x,g.x),Math.min(f.y,g.y),Math.min(f.z,g.z)),new BABYLON.Vector3(Math.max(f.x,g.x),Math.max(f.y,g.y),Math.max(f.z,g.z))),s.angle=u,x[A]={indexStart:3*y,indexCount:6,objectInstance:a[d],boundingBox:s},A++,z+=4,y+=2,"undefined"==typeof n[o.id]&&(n[o.id]=[]),n[o.id].push([a[d].points[0],a[d].points[1]])}}.bind(this),H=hcsdesign.structure.version;"1.2.0.1"==H&&this.migrateMaterials(a.walls,f);for(var I=0,J=b.length;J>I;I++)b[I].dispatchMaterials(),currentPanes=b[I].panes,G(currentPanes);for(var I=0,J=d.length;J>I;I++)d[I].dispatchMaterials(),currentPanes=d[I].panes,G(currentPanes,!0);x[0]={indexStart:3*y,indexCount:0};for(var K=PolygonMerger.getCachedDeletedEdges(),I=0,J=K.length;J>I;I++){var L=!0;K[I].parent.type!=K[I].parent.TYPE_SEPARATOR&&(F(K[I].points[0].position,K[I].points[1].position,K[I].parent.height,0,L,0),x[0].indexCount+=6,z+=4,y+=2)}for(var M,N,O,P,Q=[],I=0,J=g.length;J>I;I++)g[I].type!==g[I].TYPE_SEPARATOR&&(M=g[I].getPolygon(),M&&(N=BABYLON.Mesh.TriangulateNewMesh("wallTop",M,null,hcsdesign.engine3D.scene),N&&(O=N.duplicate(),O.invertFaces(),N.position.y=g[I].height,Q.push(N),Q.push(O))));P=BABYLON.Mesh.mergeMeshes("wallTop",Q,hcsdesign.engine3D.scene),BABYLON.Mesh.ComputeFlatNormal(j,k,m),i.setVerticesData(BABYLON.VertexBuffer.PositionKind,j),i.setVerticesData(BABYLON.VertexBuffer.NormalKind,k),i.setVerticesData(BABYLON.VertexBuffer.UVKind,l),i.setIndices(m),i.subMeshes=[];for(var I in x){var R=BABYLON.SubMesh.CreateFromIndices(+I,x[I].indexStart,x[I].indexCount,i);R.boundingBox=x[I].boundingBox,R.objectInstance=x[I].objectInstance}var S=BABYLON.Mesh.mergeMeshes("WallMesh_"+a.id,[P,i],hcsdesign.engine3D.scene,!0);return S.material=i.material,S.isDecorable=!0,hcsdesign.engine3D.castShadows(S),S.receiveShadows=!0,S.parent=h,S.decorate=c,this._mesh=S,S},b.prototype.migrateMaterials=function(a,b){for(var c,d,e,f,g=0,h=a.length;h>g;g++)if(a[g].materials){Logger.message("Conversion des materiaux du mur "+g);for(var i in a[g].materials)if(f=1/0,c=a[g].materials[i].centroid,d=a[g].materials[i].side,c.y=c.z,d.y=d.z,c.z=0,d.z=0,c){for(var j=null,k=0,l=b.length;l>k;k++)for(var m=0,n=b[k].length;n>m;m++)e=b[k][m].center().distanceTo(c),b[k][m].center().distanceTo(c)<f&&b[k][m].offsetVector.dot(d)>0&&void 0!==a[g].materials[i].params.baseColor&&(f=e,j=b[k][m]);j?(j.addMaterial(a[g].materials[i]),Logger.message("Material "+i+" : succ��s.")):Logger.message("Echec non critique pour le material "+i+" : mat��riau par d��faut.")}}Logger.message("Conversion termin��e");var o=hcsdesign.structure.version.split(".");o[1]=+o[1]+1,hcsdesign.structure.version=o.join(".")},b.prototype.switchTransparentStatusByStructure=function(a){var b=(hcsdesign.getComponentByName("FloorComponent3D").getFloor(a),this.get3DWallFrom2D(a));if(b)for(var c,d,e=0,f=b.subMeshes.length;f>e;e++)c=b.subMeshes[e],d=c.getMaterial(),void 0!==d.alternativeMaterialIndex&&switchMaterialIndex(d)},b.prototype.createInstances=function(a){if(a){for(var b=[],c=[],d=[],e=!0,f=[],g=0,h=0,i=a.subMeshes.length;i>h;h++){var j=a.subMeshes[h];if(j.objectInstance){b[g]=j.objectInstance;var k;j.objectInstance.materialInfo?k=j.objectInstance.materialInfo.material:"OvertureStructure"==j.objectInstance.name||"SubSlopeOvertureStructure"==j.objectInstance.name?k=j.objectInstance.material:"SubSlopeStructure"==j.objectInstance.name&&(k=e?j.objectInstance.materials.bottom:j.objectInstance.materials.top,e=!e),j.materialIndex=g,d[g]=k,j.boundingBox&&(c[g]=j.boundingBox),g++}else 0==h||1==h?(d[g]=new hcs.WhiteMaterial("white",hcsdesign.engine3D.scene,{factor:0}),j.materialIndex=0,g++):f.push(h)}for(var l=f.length-1;l>=0;l--)a.subMeshes.splice(f[l],1);a.objectInstances=b,a.boundingBoxes=c,a.material.subMaterials=d}},b}(),RoomStructure=function(){var a=0,b=function(){BaseStructure.call(this,"roomStructure"),this.points=[],this.holes=[],this.walls=[],this.parentWallSides=[],this.panes=null,this.cycle=null,this.name="room_"+a++,this.label=_("房间"),this.color="#FFFFFF",this.area=0,this.areaPosition=new BABYLON.Vector2,this.textWidth=0,this.textHeight=12,this.materials={},this.panesMaterials=[],this.elevation=0,this.height=0,this.thickness=5,this.ceiling=2};b.prototype=new BaseStructure,b.Deserialize=function(a){var b=new RoomStructure;if(a.color){var c=a.color.indexOf("0x");-1!=c&&(a.color="#"+a.color.slice(2))}return b.deserialize(a),b},b.prototype.serialize=function(){var a={"class":{name:"RoomStructure"}};return ujs.serializeObject(this,a,["id","label","color","isExternal","elevation","thickness","area","points","materials","panes","ceiling"]),a},b.prototype.deserialize=function(a){return ujs.deserializeObject(a,this,["id","label","color","isExternal","elevation","thickness","area","points","materials","panes","ceiling"]),this.panesMaterials=this.panes,this.panes=[],this.processRoomArea(),this},b.prototype.getCenter=function(){return this.areaPosition.clone()},b.prototype.setColor=function(a){this.color=a},b.prototype.getWallPanes=function(){return this.panes},b.prototype.updatePaneMaterial=function(a,b){a.addMaterial(b),a.materialInfo.center=a.center(),a.materialInfo.normal=a.offsetVector},b.prototype.copy=function(a){this.materials=a.materials,this.panesMaterials=a.panesMaterials,this.elevation=a.elevation,this.thickness=a.thickness,this.color=a.color,this.label=a.label,(2!=a.ceiling||this.ceiling)&&(this.ceiling=a.ceiling)};var c=function(a){for(var b=0;2>b;b++)for(var c=3;c>=2;c--)if(a[b]==a[c])return a[b];return Logger.warning("Parenting problem in cycle"),null};return b.prototype.createFromCycle=function(a){if(a.length<3)return null;for(var c=new b,d=a[a.length-1].position,e=0,f=a.length;f>e;e++)if(!d.distanceTo(a[e].position<.001)&&a[e].parents[0]&&a[e].parents[1]){c.points.push(a[e].position),c.walls.push(a[e].parents[1]),c.parentWallSides.push(a[e].parentWallSide[1]),c.height=c.walls[0].height;for(var g=0,h=1,i=c.walls.length;i>h;h++)c.walls[h]&&c.walls[h].type===c.walls[h].TYPE_SEPARATOR&&g++,g/c.walls.length>.25&&(c.ceiling=!1),c.walls[h]&&c.walls[h].height&&c.height!==c.walls[h].height&&(c.ceiling=!1,c.height=Math.max(c.walls[h].height,c.height))}else a.splice(e,1),e--,f--;return c.cycle=a,c.createWallPanes(),c.addFloorOnOvertures(a),c},b.prototype.createWallPanes=function(){for(var a,b=[],c=0,d=this.points.length;d>c;c++)this.walls[c]&&this.walls[c].type!==this.walls[c].TYPE_SEPARATOR&&(a=new WallPane3D([this.points[c],this.points[(c+1)%d]],this.walls[c],this.parentWallSides[c]),a.setRoom(this),b.push(a));return this.panes=b,b},b.prototype.dispatchMaterials=function(){var a,b=[],c=this.panes.slice(0);if(0!==c.length){for(var d in this.panesMaterials)if(this.panesMaterials[d]&&this.panesMaterials[d].center&&this.panesMaterials[d].normal){a=null;for(var e,f,g,h=1/0,i=0,j=c.length;j>i;i++)f=c[i].center(),g=c[i].normal(),e=this.panesMaterials[d].center.distanceTo(f),h>e&&this.panesMaterials[d].normal.clone().normalize().dot(g)>=0&&(h=e,a=i);if(null!==a&&(b.push(this.panesMaterials[d]),this.panesMaterials[d].normal=c[a].normal(),this.panesMaterials[d].center=c[a].center(),c[a].materialInfo=this.panesMaterials[d],c.splice(a,1),0===c.length))break}this.panesMaterials=b}},b.prototype.addFloorOnOvertures=function(){for(var a=function(a,b){for(var c=0,d=0;d<b.length;d++)if(b[d]!=a&&a.width<=b[d].width&&(c=b[d].position.subtract(a.position).length(),c-(b[d].width+a.width)/2<0))return!0;return!1},b=this.cycle,d=this.points,e=0,f=function(a,b){return a.position.x-b.position.x},g=function(a,b){return b.position.x-a.position.x},h=0,i=b.length;i>h;h++){var j=b[h],k=b[(h+1)%b.length],l=[j.parents[0],j.parents[1],k.parents[0],k.parents[1]],m=c(l);if(m&&m.overtures.length>0){var n=m.getNearestPoint(j.position),o=m.getNearestPoint(k.position),p=n.subtract(m.getPoints(0).position).length(),q=o.subtract(m.getPoints(0).position).length();m.overtures.sort(o.subtract(n).dot(m.getWallVector())>0?f:g);for(var r=0,s=m.overtures.length;s>r;r++)if(m.overtures[r].parentWall&&m.overtures[r].elevation==this.elevation&&a(m.overtures[r],m.overtures)!==!0&&(m.overtures[r].position.x>=p&&m.overtures[r].position.x<=q||m.overtures[r].position.x>=q&&m.overtures[r].position.x<=p)){var t,u=j.parents.indexOf(m),v=k.parents.indexOf(m);t=j.parentWallSide[u].equals(k.parentWallSide[v])?j.parentWallSide[u].clone():j.parentWallSide[(u+1)%2].equals(k.parentWallSide[v])?j.parentWallSide[(u+1)%2].clone():k.parentWallSide[(v+1)%2].clone(),t.scaleInPlace(m.thickness/2);var w=m.overtures[r].getAbsolutePos(),x=w.position.subtract(w.vector.scale(m.overtures[r].width/2)),y=w.position.add(w.vector.scale(m.overtures[r].width/2)),z=[x.add(t),x.add(t.clone().normalize().scale(.01)),y.add(t.clone().normalize().scale(.01)),y.add(t)];o.subtract(n).dot(x.subtract(y))>0&&z.reverse(),z[0].isOverture=!0,z[1].isOverture=!0,z[2].isOverture=!0,z[3].isOverture=!0,d[h+e]&&z[0].distanceTo(d[h+e])<.01?d.splice(h+e,1,z[0],z[1],z[2],z[3]):d[h+e+1]&&z[3].distanceTo(d[h+e+1])<.01?d.splice(h+e+1,1,z[0],z[1],z[2],z[3]):d.splice(h+1+e,0,z[0],z[1],z[2],z[3]),e+=4}}}},b.prototype.eql=function(a){for(var b=0;b<this.points.length;b++)if(this.points[b].isInArray(a.points,!1)===!1)return!1;return!0},b.prototype.isPointIn=function(a){return this.points?a.isPointInPolygon(this.points)?!0:!1:void 0},b.prototype.getRoomArea=function(a){return this.area>0&&!a?this.area:this.processRoomArea()},b.prototype.processRoomArea=function(){var a=this.points,b=a[0],c=0,d=0,e=0;for(var f in a)c+=(b.x+a[f].x)*(b.x*a[f].y-a[f].x*b.y),d+=(b.y+a[f].y)*(b.x*a[f].y-a[f].x*b.y),e+=b.x*a[f].y-a[f].x*b.y,b=a[f];e+=b.x*a[0].y-a[0].x*b.y,c+=(b.x+a[0].x)*(b.x*a[0].y-a[0].x*b.y),d+=(b.y+a[0].y)*(b.x*a[0].y-a[0].x*b.y);var g=.5*e;return this.area=Math.abs(g),this.areaPosition.x=1*c/(6*g),this.areaPosition.y=1*d/(6*g),Math.abs(g)},b.prototype.orientedArea=function(){for(var a=this.points.length,b=0,c=a-1,d=0;a>d;c=d++)b+=this.points[c].x*this.points[d].y-this.points[d].x*this.points[c].y;return.5*b},b.prototype.reversePath=function(){this.points.reverse()},b.prototype.toVec2Array=function(){for(var a=[],b=0,c=this.points.length;c>b;b++)a.push(new BABYLON.Vector2(this.points[b].x,this.points[b].y));return a},b.prototype.getOverlappingRectArea=function(a){var b=this.getBoundingBox(),c=a.getBoundingBox();b.intersect(c);var d=b.maximum.x-b.minimum.x,e=b.maximum.y-b.minimum.y,f=d*e;return f=0>d||0>e?0:f},b.prototype.getLikelihood=function(a){var b=0,c=0,d=1,e=this.getRoomArea(),f=a.getRoomArea(),g=this.areaPosition.clone(),h=a.areaPosition.clone(),i=1-Math.abs(e-f)/Math.max(e,f),j=this.getOverlappingRectArea(a)/Math.min(e,f),k=1/(1+g.distanceTo(h));return b*j+c*i+d*k},b.prototype.getBoundingBox=function(){return BABYLON.BoundingBox.CreateFromPoints(this.points)},b.prototype.getAvailableProperties=function(){return[]},b.prototype.remove=function(){},b}(),RoomHierarchy=function(){var a=function(){this.room=null,this.center=null,this.parent=null,this.children=[]};a.prototype.contains=function(a){return a.center?this.room.isPointIn(a.center):!1},a.prototype.insert=function(a){if(this.contains(a)){for(var b=0,c=this.children.length;c>b;b++)if(this.children[b].insert(a))return!0;for(var b=this.children.length-1;b>=0;b--)a.insert(this.children[b])&&this.children.splice(b,1);return this.children.push(a),a.parent=this,!0}return!1},a.fromRoom=function(b){if(b.points.length<3)return null;var c=new a;return c.room=b,c.center=b.points[0].clone().lerp(b.points[1],.5),c};var b=function(){a.call(this)};b.prototype=new a,b.prototype.contains=function(){return!0};var c=function(c){this.tree=new b;for(var d=0,e=c.length;e>d;d++)this.tree.insert(a.fromRoom(c[d]))};return c.prototype.discrimineRooms=function(a,b){for(var c=function(d,e){e?b.push(d.room):a.push(d.room);for(var f=0,g=d.children.length;g>f;f++)c(d.children[f],!e)},d=0,e=this.tree.children.length;e>d;d++)c(this.tree.children[d],!0)},c.prototype.adjustRooms=function(){for(var a=null,b=function(c,d){c.room.isExternal=d;for(var e=0,f=c.children.length;f>e;e++)d||(a=c.children[e],c.room.area-=a.room.area,c.room.holes.push(a.room.points.slice(0))),b(c.children[e],!d)},c=0,d=this.tree.children.length;d>c;c++)b(this.tree.children[c],!0)},c}(),RoomComponent2D=function(){var a=function(a){BaseComponent2D.call(this,a,"RoomComponent2D"),this.priority=9,this.rooms=[],this._remainings=0,this.internalRooms=[],this.externalRooms=[],this.useCache=!1,this.displayRoomName=!0,this.core.engine2D.registerEventCb("RoomComponent2D.static-draw",this.priority,"static-draw",null,null,this.onStaticDraw.bind(this),null),this.core.engine2D.registerEventCb("RoomComponent2D.room.click",this.priority,"click",this.core.engine2D.MODE_NORMAL,RoomStructure,this.onContextMenu.bind(this),{})
};return a.prototype=new BaseComponent2D,a.prototype.update=function(a){return!a&&!hcsdesign.getSelectedStructure().isDirty()||hcsdesign.engine2D.getMode()&hcsdesign.engine2D.MODE_CONTEXTMENU?void 0:(a=a||hcsdesign.getSelectedStructure(),this.useCache?(this.useCache=!1,this.computeRooms(a,PolygonMerger.getCachedCycles())):this.computeRooms(a))},a.prototype.removeBiggestArea=function(){for(var a,b=0,c=0,d=this.rooms.length;d>c;c++)this.rooms[c].getRoomArea()>b&&(a=c,b=this.rooms[c].getRoomArea());return this.internalRooms.splice(a,1),this.rooms.splice(a,1)},a.prototype.getExternalWalls=function(){return Logger.warning("getExternalWalls is deprecated"),null},a.prototype.getAllSubSlopes=function(a){var a=a||hcsdesign.getSelectedStructure(),b=a.getElements("internalRooms");0!=b.length&&b[0].cycle||(this.update(a),b=a.getElements("internalRooms"));for(var c=[],d=function(a,b){var c=1e-4;return a.subtract(b).lengthSquared()<c},e=function(a,b){for(var e=0,f=c.length;f>e;e++)if(a==c[e].wall&&d(b,c[e].side[0]))return c[e];return null},f=function(a,b){if(a.parents[b]){var d=e(a.parents[b],a.parentWallSide[b]);d||(d=c[c.push(new SubSlopeStructure)-1],d.wall=a.parents[b]),d.points.push(a.position),d.side.push(a.parentWallSide[b]),d.neighbors.push(a.parents[(b+1)%2])}},g=0;g<b.length;g++)if(!b[g].isExternal)for(var h=0;h<b[g].cycle.length;h++)f(b[g].cycle[h],0),f(b[g].cycle[h],1);return c},a.prototype.getInternalRooms=function(){return this.internalRooms},a.prototype.getExternalRooms=function(){return this.externalRooms},a.prototype.identifyRooms=function(a,b){var c,d,e=function(a,b){return b.area-a.area},f=[];a.length<=b.length?(c=a,d=b.slice(0)):(c=b,d=a.slice(0)),c.sort(e),d.sort(e);for(var g=0,h=c.length;h>g;g++){for(var i=d[0],j=c[g].getLikelihood(d[0]),k=0;k<d.length;k++){var l=c[g].getLikelihood(d[k]);l>j&&(i=d[k],j=l)}d.splice(d.indexOf(i),1),f.push(i)}return f},a.prototype.dispatchRooms=function(a,b){var c=b.getElements(a),d=this.identifyRooms(this[a],c);if(c.length>0)if(this[a].length<=c.length)for(var e=0;e<d.length;e++)this[a][e].copy(d[e]);else for(var e=0;e<d.length;e++)d[e].copy(c[e])},a.prototype.computeRooms=function(a,b){var c,d=a||this.structure.getCurrentStructure(),e=[];if(this.internalRooms.length=0,this.externalRooms.length=0,c=b||PolygonMerger.merge(d.getElements("walls"))){for(var f=0,g=c.length;g>f;f++){var h=RoomStructure.prototype.createFromCycle(c[f]);h.points.length<3||(h.processRoomArea(),e.push(h))}this.rooms=e;var i=new RoomHierarchy(e);if(window.ejecta&&e.length){this.internalRooms=[];for(var f=0,g=e.length-1;g>f;f++)this.internalRooms.push(e[f])}i.discrimineRooms(this.internalRooms,this.externalRooms),i.adjustRooms(),this.dispatchRooms("internalRooms",d),this.dispatchRooms("externalRooms",d),this.internalRooms.forEach(function(a){a.dispatchMaterials()}),this.externalRooms.forEach(function(a){a.dispatchMaterials()}),d.replaceElements("internalRooms",this.internalRooms),d.replaceElements("externalRooms",this.externalRooms)}},a.prototype.getTargeted=function(a){for(var b=this.structure.getCurrentStructure().getElements("internalRooms"),c=this.core.engine2D.getZoom(),d=0,e=b.length;e>d;d++){var f=b[d].areaPosition;if(!b[d].textWidth){var g=hcsdesign.engine2D.canvas.getContext("2d");b[d].textWidth=g.measureText(b[d].label).width}var h=f.x-b[d].textWidth/2/c,i=f.x+b[d].textWidth/2/c,j=f.y-b[d].textHeight/c,k=f.y+b[d].textHeight/c;if(a.x<=i&&a.x>=h&&a.y<=k&&a.y>=j)return b[d]}return null},a.prototype.onContextMenu=function(a,b){var c=[];c.push({name:"label",label:_("房间名"),type:"text",cast:"string",value:b.label}),c.push({name:"elevation",label:_("地面高度"),type:"slider",cast:"int",unit:"cm",value:{min:0,max:80,step:1,value:b.elevation}})},a.prototype.onContextMenuPropertyChanged=function(a,b,c){a[b]=c},a.prototype.onStaticDraw=function(a,b,c){this.drawRooms(a,b,c)},a.prototype.drawRooms=function(a,b,c){var d=hcsdesign.getSelectedStructure();for(var e in d.internalRooms)d.internalRooms[e].area>250&&this.drawRoom(d.internalRooms[e],a,b,c)},a.prototype.isPointInRooms=function(a){for(var b=0;b<this.rooms.length;b++){var c=this.rooms[b];if(c.isPointIn(a))return c}return!1},a.prototype.drawRoom=function(a,b,c,d){if(a&&0!=a.draw){var b=b||this.ctx;b.fillStyle=a.color||"#ffffff",b.beginPath();for(var e=0;e<a.points.length;e++){var f=a.points[e].scale(d).addInPlace(c);0==e?b.moveTo(f.x,f.y):b.lineTo(f.x,f.y)}b.fill(),this.displayRoomName}},a}(),RoomComponent3D=function(){var a,b=function(b){BaseComponent3D.call(this,b,"RoomComponent3D"),this._defaultRoomTextures={diffuseTexture:new BABYLON.Texture(hcs.Assets.roomTextures.diffuse,hcsdesign.engine3D.scene),specularTexture:new BABYLON.Texture(hcs.Assets.roomTextures.specular,hcsdesign.engine3D.scene),bumpTexture:new BABYLON.Texture(hcs.Assets.roomTextures.normal,hcsdesign.engine3D.scene)},this._defaultMaterial=new hcs.WoodMaterial("floor",hcsdesign.engine3D.scene),this._defaultMaterial.diffuseTexture=this._defaultRoomTextures.diffuseTexture,this._defaultMaterial.bumpTexture=this._defaultRoomTextures.bumpTexture,this._defaultCeiling=new hcs.WhiteMaterial("CeilingBasic",hcsdesign.engine3D.scene),this._commonMaterials=[new hcs.WhiteMaterial("FloorSide_common",hcsdesign.engine3D.scene),new hcs.WhiteMaterial("Ceiling_common",hcsdesign.engine3D.scene)],this._materialOffset=0,a=this};b.prototype=new BaseComponent3D,b.prototype.getSideMaterial=function(){return this._defaultMaterial},b.prototype.setSideMaterial=function(a){this._defaultMaterial=a},b.prototype.getCeilingMaterial=function(){return this._defaultCeiling},b.prototype.setCeilingMaterial=function(a){this._defaultCeiling=a},b.prototype.onContextChanged=function(a){"3D"==a?this.initialized||(document.addEventListener("hcs.engine3d.floorReady",this.onFloorReady,!1),this.initialized=!0):this.initialized&&(document.removeEventListener("hcs.engine3d.floorReady",this.onFloorReady,!1),this.initialized=!1)},b.prototype.onFloorReady=function(b){var c=b.floor||a.getFloor(),d=b.structure||a.core.getSelectedStructure();hcsdesign.getComponentByName("RoomComponent2D").update(d);var e=d.getElements("hoppers"),f=hcsdesign.structure.getElement(d.id+1),g=d.getElements("internalRooms");if(f)var h=a.build(g,e,c,f.hoppers);else var h=a.build(g,e,c,[]);a.mesh=h,ujs.notify("hcs.engine3d.roomsReady",{floor:c,structure:d})};var c=function(a,b){for(var c,d,e=0,f=this.subMeshes.length;f>e;e++)3*b.faceId>=this.subMeshes[e].indexStart&&3*b.faceId<this.subMeshes[e].indexStart+this.subMeshes[e].indexCount&&(c=this.objectInstances[this.subMeshes[e].materialIndex],c&&(d=this.material.subMaterials[this.subMeshes[e].materialIndex].clone(this.material.subMaterials[this.subMeshes[e].materialIndex].name),a.name=d.name,c.materials[d.name]=a,this.material.subMaterials[this.subMeshes[e].materialIndex]=a));return d};return b.prototype.build=function(a,b,d,e){for(var f=[],g=0,h=0,i=a.length;i>h;h++){var j=this.createRoom(a[h],0,a[h].height);g<a[h].height&&(g=a[h].elevation),j&&(f.push(j.floor),f.push(j.ceiling))}var k=BABYLON.Mesh.mergeMeshes("RoomMesh_"+d.structure.id,f,hcsdesign.engine3D.scene,!0);if(k.material=new BABYLON.MultiMaterial("RoomMaterial",hcsdesign.engine3D.scene),k.isDecorable=!0,k.decorate=c,k.parent=d,d.roomMesh=k,k.receiveShadows=!0,hcsdesign.engine3D.scene.lights.point.excludedMeshes.push(k),HopperComponent3D){for(var l=0;l<b.length;l++)k=HopperComponent3D.Build(k,b[l],0,g+5);for(var l=0;l<e.length;l++)k=HopperComponent3D.Build(k,e[l],d.structure.height-10)}return k},b.prototype.normalizePolygon=function(a){for(var b=[],c=0,d=a.length;d>c;c++)a[c].isOverture||b.push(a[c]);return b},b.prototype.createRoom=function(a,b,c){var d,e=(this.core.getComponentByName("HopperComponent3D",this.core.ENGINE_3D),a.points);if(e.length<3)return!1;if(d=BABYLON.Mesh.ExtrudeNewMesh("room",e,null,{amount:5+a.elevation},hcsdesign.engine3D.scene))var f=BABYLON.Mesh.TriangulateNewMesh("ceiling",e,[],hcsdesign.engine3D.scene,c-.1);else{var g=this.normalizePolygon(a.points);d=BABYLON.Mesh.ExtrudeNewMesh("room",g,null,{amount:5+a.elevation},hcsdesign.engine3D.scene);var f=BABYLON.Mesh.TriangulateNewMesh("ceiling",g,[],hcsdesign.engine3D.scene,c-.1);if(!d)return null}f.invertFaces(),f.invertNormales(),a.materials.floor=a.materials.floor||this._defaultMaterial.clone("floor"),a.materials.ceiling=a.materials.ceiling||this._defaultCeiling.clone("ceiling"),a.ceiling?a.materials.ceiling.oldAlpha&&(a.materials.ceiling.alpha=a.materials.ceiling.oldAlpha):(a.materials.ceiling.oldAlpha=a.materials.ceiling.alpha,a.materials.ceiling.alpha=0);var h=d.getBoundingBox();h.ceil=!1;var i=f.getBoundingBox();i.ceil=!0,d.receiveShadows=!0;for(var j=0,k=a.holes.length;k>j;j++)d=this.carveHole(d,a.holes[j],a.elevation+c),f=this.carveHole(f,a.holes[j],a.elevation+c);return d.subMeshes[0].objectInstance=a,d.subMeshes[0].boundingBox=h,f.subMeshes[0].objectInstance=a,f.subMeshes[0].boundingBox=i,{floor:d,ceiling:f}},b.prototype.carveHole=function(a,b,c){var d=BABYLON.CSG.FromMesh(a),e=BABYLON.Mesh.ExtrudeNewMesh("hopper_temp",b,null,{amount:c},hcsdesign.engine3D.scene);if(!e)return a;e.parent=a.parent,e.material=this._commonMaterials[0];var f=BABYLON.CSG.FromMesh(e),g=d.subtract(f),h=g.toMesh("room_global",a.material,hcsdesign.engine3D.scene,!1);return h.parent=a.parent,e.dispose(),this.replaceRoom(a,h),h},b.prototype.replaceRoom=function(a,b){-1!=hcsdesign.engine3D.scene.meshes.indexOf(a)&&(b.name=a.name,b.id=a.id,b.parent=a.parent,b.boundingBoxes=a.boundingBoxes,b.objectInstances=a.objectInstances,b.decorate=a.decorate,b.receiveShadows=a.receiveShadows,hcsdesign.engine3D.scene.lights.point.excludedMeshes.push(b),a.dispose(),this.mesh=b)},b.prototype.createInstances=function(a){if(a){for(var b,c=[],d=[],e=[],f=0,g=0,h=a.subMeshes.length;h>g;g++){var i=a.subMeshes[g];if(i.objectInstance){if(c[g]=i.objectInstance,i.boundingBox)if(i.boundingBox.ceil)var j=i.objectInstance.materials.ceiling;else var j=i.objectInstance.materials.floor;else var j=i.objectInstance.material;e[g]=j}else b||(b=g),f++;i.materialIndex=g,i.boundingBox&&(d[g]=i.boundingBox)}b&&a.subMeshes.splice(b,f),a.objectInstances=c,a.boundingBoxes=d,a.material.subMaterials=e}},b}();OvertureStructure=function(){var a=function(){BaseStructure.call(this,"OvertureStructure"),this.type="Door",this.position=new BABYLON.Vector2,this.width=73,this.height=200,this.thickness=7,this.elevation=0,this.hinge=0,this.side=-1,this.nbCasement=1,this.parentWall=null,this.minsize=15,this.sliding=!1,this.galandage=!1,this.batiThickness=5,this.programmableInstance=null,this.plinte=1};return a.prototype=new BaseStructure,a.prototype.serialize=function(){var a={"class":{name:"OvertureStructure"}};return ujs.serializeObject(this,a,null,["parentWall"]),a},a.Deserialize=function(a){var b=new OvertureStructure;return ujs.deserializeObject(a,b),b},a.prototype.checkCoherence=function(a){this.getParentWall()?(this.width=Math.min(this.width,this.parentWall.getWallVector().length()-24),this.width<0&&this.remove(a)):this.remove(a)},a.prototype.getParentWall=function(){return this.parentWall},a.prototype.setParentWall=function(a){if(a!=this.parentWall){null!=this.parentWall&&this.parentWall.overtures.splice(this.parentWall.overtures.indexOf(this),1),this.parentWall=a;for(var b=0;b<this.parentWall.overtures.length;b++){var c=this.parentWall.overtures[b];if(this.id==c.id)return}this.parentWall.overtures.push(this)}},a.prototype.computePositionOnWallChange=function(a){var b=this.parentWall,c=this.position.x,d=b.getWallVector().normalize().scaleInPlace(c),e=a.getPoints(0).position.subtract(b.getPoints(0).position),f=d.subtract(e),g=f.length();return this.position.x=g,this.side*=Math.sign(b.getWallVector().dot(a.getWallVector())),g},a.prototype.projectOnWall=function(){if(this.parentWall){var a,b=this.parentWall,c=b.getLength();a=c<this.width?.5*this.width:ujs.Math.clamp(Math.abs(this.position.x),.5*this.width,b.getLength()-.5*this.width),this.position.x=a*Math.sign(this.position.x)}},a.prototype.getAbsolutePos=function(){var a=this.parentWall.getWallVector().normalize(),b=a.scale(this.position.x).addInPlace(this.parentWall.getPoints(0).position);return{position:b,vector:a}},a.prototype.getAngle=function(){var a=this.parentWall.getWallVector().normalize();return Math.atan2(a.y,a.x)},a.prototype.getPolygon=function(){var a=new BABYLON.Vector2,b=new BABYLON.Vector2,c=this.getAbsolutePos(),d=this.parentWall.getNormalVector(this.parentWall.thickness/2);return a=c.position.subtract(c.vector.scale(this.width/2)),b=c.position.add(c.vector.scale(this.width/2)),[a.add(d),b.add(d),b.subtract(d),a.subtract(d)]},a.prototype.clampSize=function(a,b){var a=a||!1;if(!this.parentWall||this.parentWall.getLength()<this.minsize&&a)return void this.remove(b);var c=this.getAbsolutePos();this.width=BABYLON.Math.clamp(this.width,this.minsize,Math.min(2*c.position.distanceTo(this.parentWall.getPoints(0).position),2*c.position.distanceTo(this.parentWall.getPoints(1).position)))},a.prototype.remove=function(a){this.parentWall&&this.parentWall.overtures.splice(this.parentWall.overtures.indexOf(this),1),this.parentWall=null,void 0!=a&&a.removeElement("overtures",this)},a}();var OvertureComponent2D=function(){var a=function(a){BaseComponent2D.call(this,a,"OvertureComponent2D"),this.COLOR="#888",this.MINSIZE=30,this.priority=60,this.overtureDragged=!1,this._applyToAll=!1};return a.prototype=new BaseComponent2D,a.prototype.startListening=function(){this.onAddOverture=this.onAddOverture.bind(this),this.onAddOvertureEnd=this.onAddOvertureEnd.bind(this),this.onStaticDraw=this.onStaticDraw.bind(this),this.onHover=this.onHover.bind(this),this.onLeave=this.onLeave.bind(this),this.onContextMenu=this.onContextMenu.bind(this),this.onDoubleClick=this.onDoubleClick.bind(this),document.addEventListener("hcs.engine2d.onAddOverture",this.onAddOverture,!1),document.addEventListener("hcs.engine2d.onAddOvertureEnd",this.onAddOvertureEnd,!1),hcsdesign.engine2D.registerEventCb("OvertureComponent2D.static-draw",this.priority,"static-draw",null,null,this.onStaticDraw,null),hcsdesign.engine2D.registerEventCb("OvertureComponent2D.drag-start",this.priority,"drag-start",hcsdesign.engine2D.MODE_NORMAL,OvertureStructure,this.onDragStart.bind(this),null),hcsdesign.engine2D.registerEventCb("OvertureComponent2D.hover",this.priority,"hover",hcsdesign.engine2D.MODE_NORMAL|hcsdesign.engine2D.MODE_DRAG|hcsdesign.engine2D.MODE_CONTEXTMENU,OvertureStructure,this.onHover,null),hcsdesign.engine2D.registerEventCb("OvertureComponent2D.leave",this.priority,"leave",hcsdesign.engine2D.MODE_NORMAL|hcsdesign.engine2D.MODE_CONTEXTMENU,OvertureStructure,this.onLeave,null),hcsdesign.engine2D.registerEventCb("OvertureComponent2D.context-menu",this.priority,"click",hcsdesign.engine2D.MODE_NORMAL,OvertureStructure,this.onContextMenu,null),hcsdesign.engine2D.registerEventCb("OvertureComponent2D.double-click",this.priority,"double-click",hcsdesign.engine2D.MODE_NORMAL,OvertureStructure,this.onDoubleClick,null)},a.prototype.stopListening=function(){document.removeEventListener("hcs.engine2d.onAddOverture",this.onAddOverture,!1),document.removeEventListener("hcs.engine2d.onAddOvertureEnd",this.onAddOvertureEnd,!1),hcsdesign.engine2D.unregisterEventCb("OvertureComponent2D.static-draw"),hcsdesign.engine2D.unregisterEventCb("OvertureComponent2D.drag-start"),hcsdesign.engine2D.unregisterEventCb("OvertureComponent2D.hover"),hcsdesign.engine2D.unregisterEventCb("OvertureComponent2D.leave"),hcsdesign.engine2D.unregisterEventCb("OvertureComponent2D.context-menu"),hcsdesign.engine2D.unregisterEventCb("OvertureComponent2D.double-click")},a.prototype.initialize=function(){var a,b=[["doors",_("门洞"),"Door",0,90,204,0,!1,!1],["doors",_("房门"),"Door",0,73,204,1,!1,!1],["windows",_("窗户"),"Window",90,80,125,0,!1,!1],["windows",_("单面推窗"),"Window",90,80,125,1,!1,!1],["windows",_("滑动窗"),"Window",90,100,125,2,!0,!1]];a={title:_("门"),id:"doors",items:[]},ujs.notify("hcs.menu.main.add",{item:a,menuPath:"draw2D",position:1}),a={title:_("窗"),id:"windows",items:[]},ujs.notify("hcs.menu.main.add",{item:a,menuPath:"draw2D",position:2});for(var c in b)a={title:b[c][1],action:"hcs.engine2d.onAddOverture",cancelAction:"hcs.engine2d.onAddOvertureEnd",params:{overtureType:b[c][2],elevation:b[c][3],width:b[c][4],height:b[c][5],nbCasement:b[c][6],sliding:b[c][7],galandage:b[c][8]}},"Door"===b[c][2]&&(a.params.stretched_texture=!0),ujs.notify("hcs.menu.main.add",{item:a,menuPath:"draw2D."+b[c][0],position:c})},a.prototype.getTargeted=function(a){var b,c,d=this.structure.getCurrentStructure(),e=d.getElements("walls"),f=new BABYLON.Vector2,g=new BABYLON.Vector2,h=0,i=0,j=0,k=null,l=null;for(i=0,j=e.length;j>i;i++)if(f=a.subtract(e[i].getPoints(0).position),g.copyFrom(f),c=e[i].getWallVector(),f.projectOnVector(c),g.subtractInPlace(f),g.length()<=e[i].thickness/2+5)for(h=e[i].overtures.length-1;h>=0;h--)if(k=e[i].overtures[h].position.x-e[i].overtures[h].width/2-13,l=e[i].overtures[h].position.x+e[i].overtures[h].width/2+13,b=f.length()*Math.sign(f.dot(c)),b>k&&l>b)return e[i].overtures[h];return null},a.prototype._drawOverture=function(a,b,c,d){if(d.getParentWall()||d.remove(hcsdesign.getSelectedStructure()),a.save(),a.strokeStyle=this.COLOR,a.translate(Math.round(d.getParentWall().getPoints(0).position.x*c)+b.x,Math.round(d.getParentWall().getPoints(0).position.y*c)+b.y),a.rotate(Math.atan2(-d.getParentWall().getWallVector().x,d.getParentWall().getWallVector().y)+Math.PI/2),a.translate(Math.round(d.position.x*c),0),a.fillStyle="#fff",a.fillRect(Math.round(-d.width/2*c),Math.round(-d.getParentWall().thickness/2*c)-1,Math.round(d.width*c),Math.round(d.getParentWall().thickness*c)+2),a.fillStyle=this.COLOR,a.fillRect(Math.round(-d.width/2*c),Math.round(-d.getParentWall().thickness/2*c),Math.round(d.width*c),Math.round(d.getParentWall().thickness*c)),d.sliding){a.strokeStyle="rgba(255, 255, 255, .8)",a.fillStyle="rgba(255, 255, 255, .4)",a.beginPath();var e=Math.round((d.getParentWall().thickness/2-4)*c)+.5,f=Math.round(d.width/2*c);if(1==d.nbCasement)a.rect(-f+.5,Math.round(-e/2)-.5,Math.round(d.width*c)-1,Math.round(e));else{var g=d.width/d.nbCasement*c;a.moveTo(f-.5,-.5),a.lineTo(-f+.5,-.5);for(var h=0,i=-f+.5,j=e;h<=d.nbCasement;h++,i+=g,j=-j)i>f-g/2&&f+g/2>i&&(i=f-.5),h>0&&a.lineTo(Math.round(i)-.5,-j),h<d.nbCasement&&a.lineTo(Math.round(i)-.5,j);a.closePath()}a.fill(),a.stroke()}else"Garage"==d.type?(-1==d.side&&a.rotate(Math.PI),a.strokeRect(Math.round(-d.width/2*c)+.5,Math.round(-d.getParentWall().thickness/2*c)+.5,Math.round(d.width*c),Math.round(d.height*c)),a.beginPath(),a.moveTo(Math.round(-d.width/2*c),Math.round(+d.getParentWall().thickness/2*c)),a.lineTo(0,Math.round((d.height-d.getParentWall().thickness/2)*c)),a.lineTo(Math.round(d.width/2*c),Math.round(+d.getParentWall().thickness/2*c)),a.stroke()):1==d.nbCasement?(-1==d.side&&a.rotate(Math.PI),a.beginPath(),0==d.hinge?(a.arc(Math.round(-d.width/2*c)+.5,Math.round(d.getParentWall().thickness/2*c)+.5,Math.round(d.width*c),0,Math.PI/2,!1),a.lineTo(Math.round(-d.width/2*c)+.5,Math.round(d.getParentWall().thickness/2*c)+.5)):(a.arc(Math.round(d.width/2*c)+.5,Math.round(d.getParentWall().thickness/2*c)+.5,Math.round(d.width*c),Math.PI,Math.PI/2,!0),a.lineTo(Math.round(d.width/2*c)+.5,Math.round(d.getParentWall().thickness/2*c)+.5)),a.stroke()):2==d.nbCasement&&(-1==d.side&&a.rotate(Math.PI),a.beginPath(),a.arc(Math.round(-d.width/2*c)+.5,Math.round(d.getParentWall().thickness/2*c)+.5,Math.round(d.width/2*c),0,Math.PI/2,!1),a.lineTo(Math.round(-d.width/2*c)+.5,Math.round(d.getParentWall().thickness/2*c)+.5),a.stroke(),a.beginPath(),a.arc(Math.round(d.width/2*c)+.5,Math.round(d.getParentWall().thickness/2*c)+.5,Math.round(d.width/2*c),Math.PI,Math.PI/2,!0),a.lineTo(Math.round(d.width/2*c)+.5,Math.round(d.getParentWall().thickness/2*c)+.5),a.stroke());a.restore()},a.prototype.compute=function(){for(var a=this.structure.getCurrentStructure(),b=a.getElements("walls"),c=0;c<b.length;c++)for(var d=b[c].overtures.length-1;d>=0;d--)b[c].overtures[d].parentWall&&b[c].overtures[d].parentWall.id!=b[c].id&&b[c].overtures.splice(d,1)},a.prototype.onStaticDraw=function(a,b,c){var d=this.structure.getCurrentStructure().getElements("overtures");for(var e in d)this._drawOverture(a,b,c,d[e])},a.prototype.onDragStart=function(a,b,c){var d=b.getAbsolutePos(),e=d.position.subtract(d.vector.clone().scaleInPlace(b.width/2)),f=d.position.add(d.vector.clone().scaleInPlace(b.width/2));return hcsdesign.engine2D.registerEventCb("overtureComponent2D.drag-end",this.priority,"drag-end",hcsdesign.engine2D.MODE_DRAG,null,this.onDragEnd.bind(this),b),hcsdesign.engine2D.registerEventCb("overtureComponent2D.dynamic-draw",this.priority,"dynamic-draw",hcsdesign.engine2D.MODE_DRAG,null,this.onSelectionDynamicDraw.bind(this),b),c.planPos.distanceTo(e)<=13||c.planPos.distanceTo(f)<=13?hcsdesign.engine2D.registerEventCb("overtureComponent2D.dragging",this.priority,"dragging",hcsdesign.engine2D.MODE_DRAG,null,this.onDraggingResize.bind(this),b):hcsdesign.engine2D.registerEventCb("overtureComponent2D.dragging",this.priority,"dragging",hcsdesign.engine2D.MODE_DRAG,null,this.onDraggingMove.bind(this),b),this.overtureDragged=!0,!1},a.prototype.onDraggingMove=function(a,b,c,d){var e=this.structure.getCurrentStructure(),f=c.planPos.clone(),g=WallStructure.prototype.getNearestWall(f,e),h=g.getNearestPoint(f),i=h.distanceTo(g.getPoints(0).position);return d.position.x=i,d.setParentWall(g),d.projectOnWall(),hcsdesign.engine2D.requestStaticDraw(),!1},a.prototype.onDraggingResize=function(a,b,c,d){var e=c.planPos.clone(),f=d.parentWall.getNearestPoint(e),g=d.getAbsolutePos();return d.width=2*f.distanceTo(g.position)+10,d.clampSize(),hcsdesign.engine2D.requestStaticDraw(),!1},a.prototype.onDragEnd=function(a,b,c,d){hcsdesign.engine2D.unregisterEventCb("overtureComponent2D.dynamic-draw"),this.overtureDragged=!1,d.width=Math.round(d.width),hcsdesign.getSelectedStructure().dirty(),hcsdesign.engine2D.requestStaticDraw()},a.prototype.onHover=function(a,b){return hcsdesign.engine2D.registerEventCb("overtureComponent2D.dynamic-draw",this.priority,"dynamic-draw",hcsdesign.engine2D.MODE_NORMAL,null,this.onSelectionDynamicDraw.bind(this),b),hcsdesign.engine2D.requestDynamicDraw(),!1},a.prototype.onLeave=function(){hcsdesign.engine2D.unregisterEventCb("overtureComponent2D.dynamic-draw"),hcsdesign.engine2D.requestDynamicDraw()},a.prototype.onSelectionDynamicDraw=function(a,b,c,d){if(!d.parentWall)return!1;var e=d.parentWall.getPoints(0).position,f=d.parentWall.getWallVector().normalize(),g=e.add(f.clone().scaleInPlace(d.position.x-d.width/2)),h=e.add(f.clone().scaleInPlace(d.position.x+d.width/2)),i={x:g.x*c+b.x,y:g.y*c+b.y},j={x:h.x*c+b.x,y:h.y*c+b.y};hcsdesign.engine2D.symbols2D.drawGripSegment(a,i,j,[!1,!1,!1,!0],[!1,!0,!1,!1],d.getAngle())},a.prototype.onAddOverture=function(a){overture=new OvertureStructure,overture.type=a.overtureType,overture.elevation=a.elevation,overture.width=a.width,overture.height=a.height,overture.nbCasement=a.nbCasement,overture.sliding=a.sliding,overture.galandage=a.galandage,void 0!=a.hinge&&(overture.hinge=a.hinge),void 0!=a.side&&(overture.side=a.side),void 0!=a.batiThickness&&(overture.batiThickness=a.batiThickness),void 0!=a.stretched_texture&&(overture.stretched_texture=a.stretched_texture),hcsdesign.engine2D.registerEventCb("OvertureComponent2D.addOverture.wall.hover",this.priority,"hover",hcsdesign.engine2D.MODE_DRAW,WallStructure,this.onAddOvertureUpdate.bind(this),overture),hcsdesign.engine2D.registerEventCb("OvertureComponent2D.addOverture.all.move",this.priority,"mouse-move",hcsdesign.engine2D.MODE_DRAW,null,this.onAddOvertureUpdate.bind(this),overture),hcsdesign.engine2D.registerEventCb("OvertureComponent2D.addOverture.all.click",this.priority,"click",hcsdesign.engine2D.MODE_DRAW,null,this.onAddOvertureEnd.bind(this),overture),hcsdesign.engine2D.registerEventCb("OvertureComponent2D.addOverture.all.drag-start",this.priority,"drag-start",hcsdesign.engine2D.MODE_DRAW,null,this.onAddOvertureDragStart.bind(this),overture),this.core.engine2D.registerEventCb("OvertureComponent2D.addOverture.all.leave-draw-zone",this.priority,"leave-draw-zone",this.core.engine2D.MODE_DRAW,null,this.onAddOvertureLeaveZone.bind(this),overture),hcsdesign.engine2D.setMode(hcsdesign.engine2D.MODE_DRAW)},a.prototype.onAddOvertureDragStart=function(a,b,c,d){return 0!=(c.buttons&c.BUTTON_LEFT)?(hcsdesign.engine2D.registerEventCb("OvertureComponent2D.addOverture.all.dragging",this.priority,"dragging",hcsdesign.engine2D.MODE_DRAG,null,this.onAddOvertureUpdate.bind(this),d),hcsdesign.engine2D.registerEventCb("OvertureComponent2D.addOverture.all.drag-end",this.priority,"drag-end",hcsdesign.engine2D.MODE_DRAG,null,this.onAddOvertureEnd.bind(this),d),!1):void 0},a.prototype.onAddOvertureUpdate=function(a,b,c,d){hcsdesign.engine2D.setCursorIcon(hcsdesign.engine2D.symbols2D.drawCursorCheck.bind(hcsdesign.engine2D.symbols2D));var e=this.structure.getCurrentStructure();return b instanceof WallStructure&&d.setParentWall(b),e.insertElement("overtures",d),this.onDraggingMove(a,b,c,d),hcsdesign.engine2D.requestStaticDraw(),!1},a.prototype.onAddOvertureEnd=function(a,b,c,d){return"deselect"!=a.from&&ujs.notify("hcs.menu.main.deselect"),"touchUp"==a.type&&this.onAddOvertureUpdate(a,b,c,d),hcsdesign.engine2D.setMode(hcsdesign.engine2D.MODE_NORMAL),hcsdesign.getSelectedStructure().dirty(),hcsdesign.engine2D.requestStaticDraw(),!1},a.prototype.onAddOvertureLeaveZone=function(a,b){this.core.engine2D.unregisterEventCb("OvertureComponent2D.addOverture.wall.hover"),this.core.engine2D.unregisterEventCb("OvertureComponent2D.addOverture.all.click"),this.core.engine2D.unregisterEventCb("OvertureComponent2D.addOverture.all.move"),this.core.engine2D.unregisterEventCb("OvertureComponent2D.addOverture.all.drag-start"),this.core.engine2D.unregisterEventCb("OvertureComponent2D.addOverture.all.leave-draw-zone");var c=this.core.getSelectedStructure();return b.remove(c),this.core.engine2D.setMode(this.core.engine2D.MODE_NORMAL),hcsdesign.getSelectedStructure().dirty(),hcsdesign.engine2D.requestStaticDraw(),!1},a.prototype.onContextMenu=function(a,b){var c=[];if(c.push({name:"width",label:_("宽度"),type:"slider",cast:"int",unit:"cm",value:{min:20,max:b.parentWall.getLength(),step:1,value:b.width}}),c.push({name:"height",label:_("高度"),type:"slider",cast:"int",unit:"cm",value:{min:20,max:b.parentWall.height,step:1,value:b.height}}),c.push({name:"elevation",label:_("离地面的高度"),type:"slider",cast:"int",unit:"cm",value:{min:0,max:b.parentWall.height,step:1,value:b.elevation}}),"Garage"==b.type&&c.push({name:"nbCasement",label:_("Number of casements"),type:"slider",cast:"int",value:{min:1,max:6,step:1,value:b.nbCasement}}),"Garage"!=b.type){var d=_("Door"==b.type?"门":"Window"==b.type?"窗":"");c.push({name:"_applyToAll",label:_("将宽度、高度、离地面高度应用到所有的{typetarget}").replace("{typetarget}",d),type:"checkbox",cast:"bool",value:this._applyToAll})}(b.sliding||"Window"==b.type)&&c.push({name:"nbCasement",label:_("窗的个数"),type:"slider",cast:"int",value:{min:1,max:5,step:1,value:b.nbCasement}}),b.nbCasement%2!=1||b.sliding||"Garage"==b.type||c.push({name:"hinge",label:_("开窗方向"),type:"button",cast:"int",value:_("切换")}),b.nbCasement>0&&!b.sliding&&c.push({name:"side",label:_("内外方向"),type:"button",cast:"int",value:_("切换")}),hcsdesign.engine2D.displayContextMenu(c,b,this.onContextMenuPropertyChanged.bind(this),this.onContextMenuRemove.bind(this))},a.prototype.onContextMenuPropertyChanged=function(a,b,c){switch(b){case"hinge":a.hinge=(a.hinge+1)%2;break;case"side":a.side=-a.side;break;case"_applyToAll":this._applyToAll=c;break;default:a[b]=c}if(this._applyToAll&&("elevation"==b||"height"==b||"width"==b))for(var d=hcsdesign.getSelectedStructure(),e=d.getElements("overtures"),f=0;f<e.length;f++)e[f].type==a.type&&(e[f][b]=c);hcsdesign.engine2D.requestStaticDraw()},a.prototype.onContextMenuRemove=function(a){var b=hcsdesign.getSelectedStructure();a.remove(b)},a.prototype.onDoubleClick=function(a,b){return this.onAddOverture({overtureType:b.type,elevation:b.elevation,width:b.width,height:b.height,nbCasement:b.nbCasement,sliding:b.sliding,hinge:b.hinge,side:b.side,batiThickness:b.batiThickness}),!0},a}(),OvertureComponent3D=function(){var a,b=0,c=function(b){BaseComponent3D.call(this,b,"OvertureComponent3D"),this.priority=11,a=this,this._defaultMaterial=new hcs.WhiteMaterial("bati",hcsdesign.engine3D.scene,{factor:1})};return c.prototype=new BaseComponent3D,c.prototype.startListening=function(){document.addEventListener("hcs.engine3d.wallsReady",this.onWallsReady,!1),document.addEventListener("hcs.engine3d.subslopesReady",this.onSubslopesReady,!1)},c.prototype.stopListening=function(){document.removeEventListener("hcs.engine3d.wallsReady",this.onWallsReady,!1),document.removeEventListener("hcs.engine3d.subslopesReady",this.onSubslopesReady,!1)},c.prototype.onWallsReady=function(b){for(var c=b.floor||a.getFloor(),d=b.structure||a.core.getSelectedStructure(),e=b.walls||[],f=hcsdesign.getComponentByName("WallComponent3D").get3DWallFrom2D(d),g=new BABYLON.CSG.FromMesh(f),h=d.getElements("overtures"),i=new BABYLON.CSG,j=0;j<h.length;j++)i.unionInPlace(a.overtureBox(h[j],d,c));a.carveWithOvertureMeshes(i,g,f,c);for(var j=0;j<h.length;j++)a.createOverture(h[j],d,c);ujs.notify("hcs.engine3d.overturesReady",{floor:c,structure:d,walls:e})},c.prototype.onSubslopesReady=function(b){for(var c=b.floor||a.getFloor(),d=b.structure||a.core.getSelectedStructure(),e=b.walls||[],f=d.getElements("subslopes"),g=0;g<f.length;g++)for(var h=0;h<f[g].overtures.length;h++)e=a.carveSubslopeOverture(f[g],f[g].overtures[h],d,c),a.createOverture(f[g].overtures[h],d,c);var i=hcsdesign.engine3D.searchComponent("WallComponent3D");i&&i.createInstances(e);var j=hcsdesign.engine3D.searchComponent("RoomComponent3D");j&&j.createInstances(j.mesh),c.roomMesh=e,ujs.notify("hcs.engine3d.subslopeOverturesReady",{floor:c,structure:d,walls:e})},c.prototype.createOverture=function(a,c,d){function e(a){a.traverse(function(a){"vitre"!==a.name&&(hcsdesign.engine3D.castShadows(a),a.receiveShadows=!0)})}function f(a,b){var c=void 0!==a.alternativeOpacity?a.alternativeOpacity:b;a.alternativeOpacity=a.alpha,a.alpha=c,a.opacitySwitched=!a.opacitySwitched,a.transparent=1!=a.alpha}var g,d=d||this.core.getComponentByName("FloorComponent3D").getFloor(c),h=function(c){var g=c.getObject3D(hcsdesign.engine3D.scene);g.structure=a,g.animate=c.animate.bind(c),g.decorate=c.decorate.bind(g),e(g),g.structure.programmableInstance=c,a.programmableInstance=c,g.isDecorable=!0,g.parent=d,g.name="Overture_"+b++;var h=a.programmableInstance.materials;if(a.programmableInstance.getDefaultMaterials&&(h=ujs.mergeObjects(a.programmableInstance.getDefaultMaterials(hcsdesign.engine3D.scene),h)),a.programmableInstance.materials=h,g.initMaterials(h),a.material.opacitySwitched)for(var i in c.materials)c.materials.hasOwnProperty(i)&&!c.materials[i].opacitySwitched&&f(c.materials[i],.2)}.bind(this);switch(a.type){case"Door":g="Aperture.Door.js";break;case"Window":g="Aperture.Window.js";break;case"Garage":g="Aperture.Garage.js";break;case"Velux":g="Aperture.Velux.js";break;case"Dormer":g="Aperture.Dormer.js";break;default:g="Aperture.js"}var i=a.programmableInstance?a.programmableInstance.materials:null,j={type:a.type,width:a.width,height:a.height,thickness:a.thickness,elevation:a.elevation,angle:-a.angle||0,angleX:-a.angleX||0,hinge:a.hinge,side:a.side,nbCasement:a.nbCasement,minsize:a.minsize,sliding:a.sliding,galandage:a.galandage,batiThickness:a.batiThickness,wallThickness:a.wallThickness,dormerRoof:a.dormerRoof||{},plinte:a.plinte,stretched_texture:a.stretched_texture};return hcs.Programmable.createInstance(g,j,i,a,h,!1,this.engine3D),!0},c.prototype.overtureBox=function(a,b,c){var b=b||this.core.getSelectedStructure(),c=c||this.core.getComponentByName("FloorComponent3D").getFloor(b),d=a.getAbsolutePos().position;d.z=-d.y,d.y=a.elevation+a.height/2;var e=5,f=a.parentWall.getWallVector(),g=Math.atan2(-f.y,f.x);
a.parentWall.thickness+e,hcsdesign.getComponentByName("WallComponent3D").get3DWallFrom2D(b),a.material=a.material||this._defaultMaterial.clone("DefaultMaterial");var h=new BABYLON.Mesh.CreateBloc("CSGtemp",a.width,a.height,a.parentWall.thickness+10,hcsdesign.engine3D.scene),i=h.getBoundingBox();i.angle=g,i.center=d,h.subMeshes[0].objectInstance=a,h.subMeshes[0].boundingBox=i,h.position=d,h.rotation.y=-g,h.parent=c;var j=new BABYLON.CSG.FromMesh(h);return h.dispose(),j},c.prototype.carveWithOvertureMeshes=function(a,b,c,d){var e=e||this.core.getSelectedStructure(),d=d||this.core.getComponentByName("FloorComponent3D").getFloor(e);b.subtractInPlace(a);var f=b.toMesh(c.name,c.material,hcsdesign.engine3D.scene,!0);return f.isDecorable=!0,f.parent=d,hcsdesign.getComponentByName("WallComponent3D").replaceWall(c,f),hcsdesign.engine3D.castShadows(f),f},c.prototype.carveSubslopeOverture=function(a,b,c,d){var c=c||this.core.getSelectedStructure(),d=d||this.core.getComponentByName("FloorComponent3D").getFloor(c),e=a.polygonPoints[2].dot(b.wallOrtho),f=a.polygonPoints[0].dot(b.wallOrtho),g=Math.atan2(e-f,-(a.hiHeight-a.lowHeight)),h=a.wall.thickness,i=-h/Math.tan(g),j=new BABYLON.Vector3(b.center.x,0,-b.center.y);j.y=b.offset/a.offset*(-i+a.hiHeight-a.lowHeight)+a.lowHeight+i/2;var k=a.wall.getWallVector(),l=new BABYLON.Vector2(k.y,-k.x),m=new BABYLON.Vector2(a.polygonPoints[2].x-a.polygonPoints[0].x,a.polygonPoints[2].y-a.polygonPoints[0].y);m.projectOnVector(l);var n=m.x*l.x+m.y*l.y;0>n&&(k.x=-k.x,k.y=-k.y,l.x=-l.x,l.y=-l.y);var o=Math.atan2(-k.y,k.x);b.elevation=j.y,b.angle=o,b.angleX=g;var p=hcsdesign.getComponentByName("WallComponent3D").get3DWallFrom2D(c),q=new BABYLON.Mesh.CreateBloc("CSGtemp",b.width,b.height,20,hcsdesign.engine3D.scene),r=q.getBoundingBox();r.angle=o,r.center=j,q.material=new BABYLON.StandardMaterial("CSGtemp",hcsdesign.engine3D.scene),q.subMeshes[0].objectInstance=b,q.position=j,q.rotation.y=-o+Math.PI,q.rotation.x=g,q.parent=d;var s=new BABYLON.CSG.FromMesh(p),t=new BABYLON.CSG.FromMesh(q),u=s.subtract(t);b.material=b.material||new BABYLON.StandardMaterial("bati",hcsdesign.engine3D.scene);var v=u.toMesh(p.name,p.material,hcsdesign.engine3D.scene,!0);return q.dispose(),v.isDecorable=!0,v.parent=d,hcsdesign.getComponentByName("WallComponent3D").replaceWall(p,v),hcsdesign.engine3D.castShadows(v),v},c}();SubSlopeStructure=function(){var a=function(){BaseStructure.call(this,"SubSlopeStructure"),this.points=[],this.side=[],this.wall=null,this.neighbors=[],this.overtures=[],this.offset=0,this.materials={},this.lowHeight=80,this.hiHeight=250,this.polygonPoints=[new BABYLON.Vector2,new BABYLON.Vector2,new BABYLON.Vector2,new BABYLON.Vector2],this.needsUpdate=!0};return a.prototype=new BaseStructure,a.prototype.serialize=function(){var a={"class":{name:"SubSlopeStructure"}};return ujs.serializeObject(this,a,["offset","lowHeight","hiHeight","overtures","materials"]),a},a.Deserialize=function(a){var b=new SubSlopeStructure;ujs.deserializeObject(a,b,["offset","lowHeight","_overturesIds","hiHeight","overtures","materials"]);for(var c in b.overtures)b.overtures[c].parent=b;return b.checkCoherence(),b},a.prototype.checkCoherence=function(){var a;this.lowHeight>this.hiHeight&&(a=this.hiHeight,this.hiHeight=this.lowHeight,this.lowHeight=a),0===this.lowHeight&&(this.lowHeight=1),0==this.materials.length&&(this.materials={}),this.offset>4e3&&(this.offset=4e3)},a.prototype.indexClosest=function(a){return this.wall.distanceFrom(a[0])<this.wall.distanceFrom(a[1])?0:1},a.prototype.isSameSide=function(a){var b=this.wall.distanceFrom(a[0])<this.wall.distanceFrom(a[1])?0:1,c=a[(b+1)%2].subtract(a[b]);return c.dot(this.side[0])>=0},a.prototype.getVector=function(){return this.points[1].subtract(this.points[0])},a.prototype.distanceFrom=function(a){var b=a.points[1].subtract(a.points[0]),c=b.lengthSquared(),d=this.points[1].subtract(a.points[0]),e=this.points[0].subtract(a.points[0]),f=d.projectOnVector(b),g=e.projectOnVector(b);f.dot(b)<0&&f.copyFromFloats(0,0,0),g.dot(b)<0&&g.copyFromFloats(0,0,0),f.dot(b)>c&&f.copyFrom(b),g.dot(b)>c&&g.copyFrom(b);var h=a.points[0].add(f),i=a.points[0].add(g);return Math.min(h.distanceTo(this.points[1]),i.distanceTo(this.points[0]))},a.prototype.getPolygonPoints=function(){this.polygonPoints[1].x=this.wall.points[0].position.x+this.wall.thickness/2,this.polygonPoints[1].y=this.wall.points[0].position.y+this.wall.thickness/2,this.polygonPoints[0].x=this.wall.points[1].position.x+this.wall.thickness/2,this.polygonPoints[0].y=this.wall.points[1].position.y-this.wall.thickness/2,this.polygonPoints[3].x=this.wall.points[0].position.x-this.offset-this.wall.thickness/2,this.polygonPoints[3].y=this.wall.points[0].position.y+this.wall.thickness/2,this.polygonPoints[2].x=this.wall.points[1].position.x-this.offset-this.wall.thickness/2,this.polygonPoints[2].y=this.wall.points[1].position.y-this.wall.thickness/2},a.prototype.computePolygonPoints=function(a){if((a||this.needsUpdate)&&0!=this.side.length){var b=this.side[0].scale(this.offset),c=function(a,c){if(c>=2){if(a.offset<=0)return void(this.polygonPoints[c]=this.polygonPoints[c-2].add(b.clone().normalize().scaleInPlace(this.offset+this.wall.thickness)));var d=a.side[0].scale(a.offset),e=this.points[0].add(b),f=this.points[1].add(b),g=a.points[0].add(d),h=a.points[1].add(d),i=BABYLON.Vector2.Intersect(e,f,g,h,Math.PI/50);if(!i)return Logger.warning("No intersect"),void(this.polygonPoints[c]=this.polygonPoints[c-2].add(b));this.polygonPoints[c].copyFrom(i)}else{var e=this.polygonPoints[0],f=this.polygonPoints[1],g=a.points[0].subtract(a.side[0].scale(a.wall.thickness)),h=a.points[1].subtract(a.side[0].scale(a.wall.thickness)),i=BABYLON.Vector2.Intersect(e,f,g,h,Math.PI/50);if(!i)return;this.polygonPoints[c].copyFrom(i)}};if(this.needsUpdate=!1,this.polygonPoints[0].copyFrom(this.points[0]),this.polygonPoints[1].copyFrom(this.points[1]),this.offset>0){var d=this.wall.thickness;this.polygonPoints[0].subtractInPlace(this.side[0].scale(d)),this.polygonPoints[1].subtractInPlace(this.side[0].scale(d))}var e=function(a){var d=.001;if(this.neighbors[a]){for(var e=0;e<this.neighbors[a].subSlopes.length&&this.distanceFrom(this.neighbors[a].subSlopes[e])>d;)e++;var f=this.neighbors[a].subSlopes[e];f&&f.wall!=this.wall?(c.call(this,f,a),c.call(this,f,a+2)):this.polygonPoints[a+2]=this.polygonPoints[a].add(b.clone().normalize().scaleInPlace(this.offset+this.wall.thickness))}else this.polygonPoints[a+2]=this.polygonPoints[a].add(b.clone().normalize().scaleInPlace(this.offset+this.wall.thickness))};e.call(this,0),e.call(this,1)}},a.prototype.isPointIn=function(a){var b=[this.polygonPoints[0],this.polygonPoints[1],this.polygonPoints[3],this.polygonPoints[2]];return a.isPointInPolygon(b)},a.prototype.plane=function(){if(this.offset<=0)return null;var a=[new BABYLON.Vector3(this.polygonPoints[0].x,this.lowHeight,-this.polygonPoints[0].y),new BABYLON.Vector3(this.polygonPoints[1].x,this.lowHeight,-this.polygonPoints[1].y),new BABYLON.Vector3(this.polygonPoints[3].x,this.hiHeight,-this.polygonPoints[3].y),new BABYLON.Vector3(this.polygonPoints[2].x,this.hiHeight,-this.polygonPoints[2].y)],b=a[2].subtract(a[1]),c=a[0].subtract(a[1]);if(b.cross(c),b.y<0){var d=a[0];a[0]=a[1],a[1]=d,d=a[2],a[2]=a[3],a[3]=d}return a},a.prototype.remove=function(){this.offset=0,this.lowHeight=80,this.hiHeight=250,this.needsUpdate=!0,this.overtures.length=0},a.prototype.getNearestSubSlope=function(a,b){for(var c,d=b.getElements("SubSlopeStructure"),e=null,f=1/0,g=0,h=d.length;h>g;g++)c=d[g].distanceFrom(a),f>c&&(e=d[g],f=c);return e},a.prototype.addMaterial=function(a,b,c){c.colorOnly?this.materials[c.materialIndex]?(this.materials[c.materialIndex].color.r=c.color.r,this.materials[c.materialIndex].color.g=c.color.g,this.materials[c.materialIndex].color.b=c.color.b):(this.materials[c.materialIndex]=c,c.colorOnly=!1):this.materials[c.materialIndex]=c},a}(),SubSlopeOvertureStructure=function(){var a=function(){BaseStructure.call(this,"SubSlopeOvertureStructure"),this.type="Velux",this.width=100,this.height=150,this.thickness=5,this.nbCasement=1,this.sliding=0,this.dormerRoof={},this.wallThickness=10,this.parent=null,this.position=new BABYLON.Vector2,this.polygon=[]};return a.prototype=new BaseStructure,a.prototype.serialize=function(){var a={"class":{name:"SubSlopeOvertureStructure"}};return ujs.serializeObject(this,a,null,["parent","wall"]),a},a.Deserialize=function(a){var b=new SubSlopeOvertureStructure;return ujs.deserializeObject(a,b),b},a.prototype.getParent=function(){return this.parent},a.prototype.setParent=function(a){if(a!=this.parent){null!=this.parent&&this.parent.overtures.splice(this.parent.overtures.indexOf(this),1),this.parent=a;for(var b=0;b<this.parent.overtures.length;b++){var c=this.parent.overtures[b];if(this.id==c.id)return}this.parent.overtures.push(this)}},a.prototype.isTargeted=function(a){return a.isPointInPolygon(this.polygon)},a.prototype.remove=function(){this.parent.overtures.splice(this.parent.overtures.indexOf(this),1)},a.prototype.remove=function(){this.parent.overtures.splice(this.parent.overtures.indexOf(this),1)},a.prototype.getAbsolutePosition=function(){var a=new BABYLON.Vector2;return a=this.parent.wall.points[0].position.clone().lerp(this.parent.wall.points[1].position,.5).add(this.position),{position:a,vector:null}},a.prototype.to3D=function(){},a}(),SubSlopeComponent2D=function(){var a=function(a){BaseComponent2D.call(this,a,"SubSlopeComponent2D"),this.priority=100,this.subSlopes=[],this.needsUpdate=!0,this._applyHeightToAll=!1,this._HANDLERADIUS=10,this._HANDLESTATICSTYLE="rgba(137,115,100,0.8)",this._HANDLESTYLE=this._HANDLESTATICSTYLE};return a.prototype=new BaseComponent2D,a.prototype.startListening=function(){this.onEditSubSlope=this.onEditSubSlope.bind(this),this.onModeSubSlopeEnd=this.onModeSubSlopeEnd.bind(this),document.addEventListener("hcs.engine2d.onEditSubSlope",this.onEditSubSlope,!1),document.addEventListener("hcs.engine2d.onModeSubSlopeEnd",this.onModeSubSlopeEnd,!1),hcsdesign.engine2D.registerEventCb("SubSlopeComponent2D.static-draw",this.priority,"static-draw",hcsdesign.engine2D.MODE_SUBSLOPE|hcsdesign.engine2D.MODE_DRAG,null,this.onStaticDraw.bind(this),null),hcsdesign.engine2D.registerEventCb("SubSlopeComponent2D.hover",this.priority,"hover",hcsdesign.engine2D.MODE_SUBSLOPE,SubSlopeStructure,this.onHover.bind(this),null),hcsdesign.engine2D.registerEventCb("SubSlopeComponent2D.leave",this.priority,"leave",hcsdesign.engine2D.MODE_SUBSLOPE,SubSlopeStructure,this.onLeave.bind(this),null),hcsdesign.engine2D.registerEventCb("SubSlopeComponent2D.dragstart",this.priority,"drag-start",hcsdesign.engine2D.MODE_SUBSLOPE,SubSlopeStructure,this.onDragStart.bind(this),null),hcsdesign.engine2D.registerEventCb("SubSlopeComponent2D.subslope-end",this.priority,"subslope-end",null,null,this.onSubSlopeEnd.bind(this),null),hcsdesign.engine2D.registerEventCb("SubSlopeComponent2D.context-menu",this.priority,"click",hcsdesign.engine2D.MODE_SUBSLOPE,SubSlopeStructure,this.onContextMenu.bind(this),null)},a.prototype.stopListening=function(){document.removeEventListener("hcs.engine2d.onEditSubSlope",this.onEditSubSlope,!1),document.removeEventListener("hcs.engine2d.onModeSubSlopeEnd",this.onModeSubSlopeEnd,!1),hcsdesign.engine2D.unregisterEventCb("SubSlopeComponent2D.static-draw"),hcsdesign.engine2D.unregisterEventCb("SubSlopeComponent2D.hover"),hcsdesign.engine2D.unregisterEventCb("SubSlopeComponent2D.leave"),hcsdesign.engine2D.unregisterEventCb("SubSlopeComponent2D.dragstart"),hcsdesign.engine2D.unregisterEventCb("SubSlopeComponent2D.subslope-end"),hcsdesign.engine2D.unregisterEventCb("SubSlopeComponent2D.context-menu")},a.prototype.initialize=function(){this.startListening()},a.prototype.onEditSubSlope=function(){this.needsUpdate=!0,hcsdesign.engine2D.setMode(hcsdesign.engine2D.MODE_SUBSLOPE),hcsdesign.engine2D.requestStaticDraw()},a.prototype.onModeSubSlopeEnd=function(){hcsdesign.engine2D.setMode(hcsdesign.engine2D.MODE_NORMAL)},a.prototype.onSubSlopeEnd=function(){hcsdesign.engine2D.requestStaticDraw()},a.prototype.onStaticDraw=function(a,b,c){0!=(hcsdesign.engine2D.getMode()&hcsdesign.engine2D.MODE_SUBSLOPE)&&(this.getSubSlopes(),this.update(),this.draw(a,b,c))},a.prototype.onHover=function(a,b){return this._HANDLESTYLE="rgba(137,115,100,0.8)",hcsdesign.engine2D.registerEventCb("SubSlopeComponent2D.dynamic-draw",this.priority,"dynamic-draw",null,null,this.onDynamicDraw.bind(this),b),hcsdesign.engine2D.requestDynamicDraw(),!1},a.prototype.onLeave=function(){this._HANDLESTYLE="rgba(137,115,100,0.8)",hcsdesign.engine2D.unregisterEventCb("SubSlopeComponent2D.dynamic-draw"),hcsdesign.engine2D.requestDynamicDraw()},a.prototype.onDragStart=function(a,b){return hcsdesign.engine2D.registerEventCb("SubSlopeComponent2D.dragging",this.priority,"dragging",hcsdesign.engine2D.MODE_DRAG,null,this.onDragging.bind(this),b),hcsdesign.engine2D.registerEventCb("SubSlopeComponent2D.drag-end",this.priority,"drag-end",hcsdesign.engine2D.MODE_DRAG,null,this.onDragEnd.bind(this),b),!1},a.prototype.onDragging=function(a,b,c,d){var e=hcsdesign.getSelectedStructure(),f=c.posDelta.scaleInPlace(1/hcsdesign.engine2D.getZoom()),g=f.clone().projectOnVector(d.polygonPoints[3].subtract(d.polygonPoints[2])),h=f.subtractInPlace(g),i=[];i[0]=d.polygonPoints[0],i[1]=d.polygonPoints[1],i[2]=d.polygonPoints[3],i[3]=d.polygonPoints[2];for(var j=d.overtures.length,k=0;j>k;k++)if(void 0!=d.overtures[k])for(var l=0;l<d.overtures[k].polygon.length;l++)if(!d.overtures[k].polygon[l].isPointInPolygon(i)&&h.dot(d.side[0])<0&&(d.overtures[k].position.x+=f.x,d.overtures[k].position.y+=f.y,1==l||2==l)){d.overtures[k].remove(d.overtures[k]);break}var m=d.wall.getWallVector(),n=new BABYLON.Vector2;n.x=m.y,n.y=m.x;for(var o=0;o<d.neighbors.length;o++){var m=d.neighbors[o].getWallVector(),p=new BABYLON.Vector2(f.x,f.y);p.projectOnVector(m);var q=[];q[0]=d.neighbors[o].subSlopes[0].polygonPoints[0],q[1]=d.neighbors[o].subSlopes[0].polygonPoints[1],q[2]=d.neighbors[o].subSlopes[0].polygonPoints[3],q[3]=d.neighbors[o].subSlopes[0].polygonPoints[2];for(var r=0;r<d.neighbors[o].subSlopes[0].overtures.length;r++)for(var s=0;4>s;s++)!d.neighbors[o].subSlopes[0].overtures[r].polygon[s].isPointInPolygon(q)&&h.dot(d.side[0])>0&&(d.neighbors[o].subSlopes[0].overtures[r].position.x+=p.x,d.neighbors[o].subSlopes[0].overtures[r].position.y+=p.y)}d.offset+=h.dot(d.side[0]),d.offset<0&&(d.offset=0);var t=function(a,b){for(var c=0;c<a.subSlopes.length;c++){var d=a.subSlopes[c].neighbors.indexOf(b.wall);if(-1!=d)return d}return-1},u=function(a,b){for(var c=0;c<a.subSlopes.length;c++){var d=a.subSlopes[c].points[1].subtract(a.subSlopes[c].points[0]),e=b.subtract(a.subSlopes[c].points[0]),f=d.lengthSquared(),g=d.dot(e);if(g>=0&&f>=g)return a.subSlopes[c]}return null};if(d.offset>=0&&d.neighbors[0]&&d.neighbors[1]){var v,w,x;d.neighbors[0].subSlopes[0]&&(v=t(d.neighbors[0],d),w=d.neighbors[0].subSlopes[0].indexClosest(d.points),-1==v&&(x=u(d.neighbors[0],d.points[w]),this.splitSubSlope(x,d))),d.neighbors[1].subSlopes[0]&&(v=t(d.neighbors[1],d),w=d.neighbors[1].subSlopes[0].indexClosest(d.points),-1==v&&(x=u(d.neighbors[1],d.points[w]),this.splitSubSlope(x,d)))}for(var y=e.getElements("subslopes"),k=0;k<y.length;k++)-1!=y[k].neighbors.indexOf(d.wall)&&(y[k].needsUpdate=!0);d.needsUpdate=!0,hcsdesign.engine2D.requestStaticDraw()},a.prototype.onDragEnd=function(){hcsdesign.engine2D.requestDynamicDraw(),ujs.notify("hcs.subslope.drag-end")},a.prototype.onDynamicDraw=function(a,b,c,d){if(0!=(hcsdesign.engine2D.getMode()&hcsdesign.engine2D.MODE_SUBSLOPE)){var e=BABYLON.Vector2.Lerp(d.polygonPoints[3],d.polygonPoints[2],.5);e.scaleInPlace(c),e.addInPlace(b)}},a.prototype.update=function(a){if((a||hcsdesign.getSelectedStructure().isDirty())&&this.getSubSlopes(!0,a),0!=(hcsdesign.engine2D.getMode()&hcsdesign.engine2D.MODE_SUBSLOPE))for(var a=hcsdesign.getSelectedStructure(),b=a.getElements("subslopes"),c=0,d=b.length;d>c;c++)b[c].computePolygonPoints()},a.prototype.getTargeted=function(a){if(0!=(hcsdesign.engine2D.getMode()&hcsdesign.engine2D.MODE_SUBSLOPE)){for(var b=hcsdesign.getSelectedStructure(),c=b.getElements("subslopes"),d=0;d<c.length;d++){var e=BABYLON.Vector2.Lerp(c[d].polygonPoints[3],c[d].polygonPoints[2],.5);if(a.distanceTo(e)<this._HANDLERADIUS/hcsdesign.engine2D.getZoom())return c[d]}return null}},a.prototype.getSubSlopes=function(a,b){var b=b||hcsdesign.getSelectedStructure(),c=b.getElements("subslopes");if(!this.needsUpdate&&!a)return c;for(var d=function(a){if(!(a.points.length<=2)){for(var b,c=a.points[0],d=a.points[1].subtract(c).normalize(),e=0,f=a.points[1].subtract(c).dot(d),g=0,h=1,i=1,j=a.points.length;j>i;i++)b=a.points[i].subtract(c).dot(d),e>b?(g=i,e=b):b>f&&(h=i,f=b);a.points=[a.points[g],a.points[h]],a.side=[a.side[g],a.side[h]],a.neighbors=[a.neighbors[g],a.neighbors[h]]}},e=hcsdesign.getComponentByName("RoomComponent2D").getAllSubSlopes(b),f=b.getElements("walls"),g=[],h=[],i=0;i<f.length;i++){for(var j=[],k=0;k<f[i].subSlopes.length;k++)j.push({offset:f[i].subSlopes[k].offset,lowHeight:f[i].subSlopes[k].lowHeight,hiHeight:f[i].subSlopes[k].hiHeight,materials:f[i].subSlopes[k].materials,overtures:f[i].subSlopes[k].overtures});f[i].subSlopes.length=0,g.push(j),h.push(f[i])}for(var i=e.length-1;i>=0;i--)if(e[i].wall.thickness<20)e.splice(i,1);else if(e[i].points.length<2)e.splice(i,1);else if(e[i].points[1].distanceTo(e[i].points[0])<10)e.splice(i,1);else{d(e[i]),e[i].wall.subSlopes.push(e[i]),e[i].offset=0;var l=g[h.indexOf(e[i].wall)];if(l&&l.length>0&&l[e[i].wall.subSlopes.length-1]){var m=l[e[i].wall.subSlopes.length-1].offset;e[i].offset=void 0!==m?m:0;var n=l[e[i].wall.subSlopes.length-1].lowHeight;e[i].lowHeight=void 0!==n?n:0;var o=l[e[i].wall.subSlopes.length-1].hiHeight;e[i].hiHeight=void 0!==o?o:0;var p=l[e[i].wall.subSlopes.length-1].materials;e[i].materials=void 0!==p?p:{};var q=l[e[i].wall.subSlopes.length-1].overtures;e[i].overtures=void 0!==q?q:[];for(var r=e[i].overtures.slice(),k=0;k<r.length;k++)r[k].setParent(e[i])}}this.subSlopes=e;for(var i=e.length-1;i>=0;i--)e[i].computePolygonPoints();return b.replaceElements("subslopes",e),this.needsUpdate=!1,e},a.prototype.splitSubSlope=function(a,b){var c=hcsdesign.getSelectedStructure(),d=c.getElements("subslopes"),e=a.indexClosest(b.points),f=new SubSlopeStructure,g=function(){for(var c=10+a.wall.thickness/2,d=0;d<b.wall.subSlopes.length;d++)if(!(b.wall.subSlopes[d].side[0].subtract(b.side[0]).lengthSquared()<1e-4)){if(b.wall.subSlopes[d].distanceFrom(a)<c)return{ss:b.wall.subSlopes[d],index:a.indexClosest(b.wall.subSlopes[d].points)};Logger.message("Probl®®me : sous-pente adjacente non-trouv®¶e")}},h=g();if(h){var i=h.ss.side[0].dot(a.getVector())>0?1:0;f.points=[h.ss.points[h.index],a.points[i]],a.points[i]=b.points[e],f.neighbors=[b.wall,a.neighbors[i]],a.neighbors[i]=b.wall,f.side[0]=f.side[1]=a.side[0],d.push(f),a.wall.subSlopes.push(f),f.wall=a.wall,a.needsUpdate=!0}},a.prototype.draw=function(a,b,c){for(var d=this.getSubSlopes(),e=0,f=d.length;f>e;e++)this.drawOnWall(a,b,c,d[e])},a.prototype.drawOnWall=function(a,b,c,d){a.fillStyle=hcsdesign.engine2D.symbols2D.COLOR_ACTIVE_FILL,a.strokeStyle=hcsdesign.engine2D.symbols2D.COLOR_ACTIVE_STROKE,a.lineWidth=2,a.beginPath();for(var e=[d.polygonPoints[0].clone(),d.polygonPoints[1].clone(),d.polygonPoints[3].clone(),d.polygonPoints[2].clone()],f=new BABYLON.Vector2,g=0,h=d.polygonPoints.length;h>g;g++)f=e[g],f.scaleInPlace(c),f.addInPlace(b),f.x=Math.round(f.x),f.y=Math.round(f.y),0==g?a.moveTo(f.x,f.y):a.lineTo(f.x,f.y);a.fill(),d.offset>0&&(a.closePath(),a.stroke());var i=e[2].lerp(e[3],.5),j=Math.atan2(d.side[0].y,d.side[0].x);hcsdesign.engine2D.symbols2D.drawGrip(a,i,[!1,!1,!1,!1],0),hcsdesign.engine2D.symbols2D.drawArrows(a,i,[!1,!0,!1,!1],12,j,!0)},a.prototype.onContextMenu=function(a,b){var c=[];c.push({name:"lowHeight",label:_("相对低的高度"),type:"slider",cast:"int",unit:"cm",value:{min:1,max:500,step:1,value:b.lowHeight}}),c.push({name:"hiHeight",label:_("相对高的高度"),type:"slider",cast:"int",unit:"cm",value:{min:1,max:500,step:1,value:b.hiHeight}}),c.push({name:"offset",label:_("长度"),type:"slider",cast:"int",unit:"cm",value:{step:1,min:0,max:5e3,value:Math.round(b.offset)}}),c.push({name:"Length",label:_("角度"),type:"html",html:"<label>"+_("角度")+'</label><span class="field">'+Math.round(180*Math.atan2(b.hiHeight-b.lowHeight,b.offset)/Math.PI)+"°</span>"}),c.push({name:"_applyHeightToAll",label:_("将高度应用到所有的斜顶"),type:"checkbox",cast:"bool",value:this._applyHeightToAll}),hcsdesign.engine2D.displayContextMenu(c,b,this.onContextMenuPropertyChanged.bind(this),this.onContextMenuRemove.bind(this))},a.prototype.onContextMenuPropertyChanged=function(a,b,c){if(!("lowHeight"==b&&c>a.hiHeight||"hiHeight"==b&&c<a.lowHeight)){a[b]=c;var d=hcsdesign.getSelectedStructure(),e=d.getElements("walls");if(("hiHeight"==b||"lowHeight"==b||"_applyHeightToAll"==b)&&a._applyHeightToAll){for(var f=0;f<e.length;f++)for(var g=0;g<e[f].subSlopes.length;g++)e[f].subSlopes[g].lowHeight=a.lowHeight,e[f].subSlopes[g].hiHeight=a.hiHeight;d.height=a.height}hcsdesign.engine2D.requestStaticDraw()}},a.prototype.onContextMenuRemove=function(a){var b=hcsdesign.getSelectedStructure();a.remove(b)},a}(),SubSlopeOvertureComponent2D=function(){var a=function(a){BaseComponent2D.call(this,a,"SubSlopeOvertureComponent2D"),this.priority=99,this._tmpOverture=null,this._addState=0,this._targetedAt=null,this._targetedAtSide=null,this._overture1Magnetism=null,this._overture2Magnetism=null};return a.prototype=new BaseComponent2D,a.prototype.getTargeted=function(a){if(0!=(hcsdesign.engine2D.getMode()&hcsdesign.engine2D.MODE_SUBSLOPE)){var b=this.structure.getCurrentStructure(),c=b.getElements("walls");if(!(hcsdesign.engine2D.getMode()&hcsdesign.engine2D.MODE_DRAG))for(var d=0,e=c.length;e>d;d++)for(var f=0,g=c[d].subSlopes.length;g>f;f++)for(var h=0,i=c[d].subSlopes[f].overtures.length;i>h;h++)for(var j=0;j<c[d].subSlopes[f].overtures[h].polygon.length;j++){var k=this.isPointInOvertureSide(a,c[d].subSlopes[f].overtures[h]);if(ov=c[d].subSlopes[f].overtures[h],k!==!1)return this._targetedAtSide=k,hcsdesign.engine2D.requestDynamicDraw(),c[d].subSlopes[f].overtures[h];if(this._targetedAtSide=null,ov.isTargeted(a))return ov}return!1}},a.prototype.initialize=function(){},a.prototype.startListening=function(){this.onAddSubSlopeOverture=this.onAddSubSlopeOverture.bind(this),this.onDragEndSubSlope=this.onDragEndSubSlope.bind(this),this.onDoubleClick=this.onDoubleClick.bind(this),document.addEventListener("hcs.engine2d.onAddSubSlopeOverture",this.onAddSubSlopeOverture,!1),document.addEventListener("hcs.subslope.drag-end",this.onDragEndSubSlope,!1),hcsdesign.engine2D.registerEventCb("SubSlopeOvertureComponent2D.static-draw",this.priority,"static-draw",null,null,this.onStaticDraw.bind(this),null),hcsdesign.engine2D.registerEventCb("SubSlopeOvertureComponent2D.hover",this.priority,"hover",null,SubSlopeOvertureStructure,this.onHover.bind(this),null),hcsdesign.engine2D.registerEventCb("SubSlopeOvertureComponent2D.leave",this.priority,"leave",null,SubSlopeOvertureStructure,this.onLeave.bind(this),null),hcsdesign.engine2D.registerEventCb("SubSlopeOvertureComponent2D.drag-start",this.priority,"drag-start",hcsdesign.engine2D.MODE_SUBSLOPE,SubSlopeOvertureStructure,this.onDragStart.bind(this),null),hcsdesign.engine2D.registerEventCb("SubSlopeOvertureComponent2D.context-menu",this.priority,"click",hcsdesign.engine2D.MODE_SUBSLOPE,SubSlopeOvertureStructure,this.onContextMenu.bind(this),null),hcsdesign.engine2D.registerEventCb("SubSlopeOvertureComponent2D.drag.dynamic-draw",this.priority,"dynamic-draw",hcsdesign.engine2D.MODE_DRAG,SubSlopeOvertureStructure,this.onDragDynamicDraw.bind(this),{}),this.core.engine2D.registerEventCb("SubSlopeOvertureComponent2D.double-click",this.priority,"double-click",hcsdesign.engine2D.MODE_SUBSLOPE,SubSlopeOvertureStructure,this.onDoubleClick,null)},a.prototype.stopListening=function(){document.removeEventListener("hcs.engine2d.onAddSubSlopeOverture",this.onAddSubSlopeOverture,!1),document.removeEventListener("hcs.subslope.drag-end",this.onDragEndSubSlope,!1),hcsdesign.engine2D.unregisterEventCb("SubSlopeOvertureComponent2D.static-draw"),hcsdesign.engine2D.unregisterEventCb("SubSlopeOvertureComponent2D.hover"),hcsdesign.engine2D.unregisterEventCb("SubSlopeOvertureComponent2D.leave"),this.core.engine2D.unregisterEventCb("SubSlopeOvertureComponent2D.double-click")},a.prototype.onHover=function(a,b){return hcsdesign.engine2D.registerEventCb("SubSlopeOvertureComponent2D.hopper.drag-start",this.priority,"drag-start",hcsdesign.engine2D.MODE_NORMAL,SubSlopeOvertureStructure,this.onDragStart.bind(this),{}),hcsdesign.engine2D.registerEventCb("SubSlopeOvertureComponent2D.dynamic-draw",this.priority,"dynamic-draw",hcsdesign.engine2D.MODE_SUBSLOPE,null,this.onSelectionDynamicDraw.bind(this),b),hcsdesign.engine2D.registerEventCb("SubSlopeOvertureComponent2D.hopper-hover.dynamic-draw",this.priority,"dynamic-draw",null,SubSlopeOvertureStructure,this.onHoverSubSlopeOverture.bind(this),b),hcsdesign.engine2D.requestDynamicDraw(),!1},a.prototype.onHoverSubSlopeOverture=function(a,b,c,d){this.drawTarget(d,a,c)},a.prototype.onDragEndSubSlope=function(){for(var a=this.structure.getCurrentStructure(),b=a.getElements("subslopes"),c=0;c<b.length;c++){var d=[];d[0]=b[c].polygonPoints[0],d[1]=b[c].polygonPoints[1],d[2]=b[c].polygonPoints[3],d[3]=b[c].polygonPoints[2];for(var e=0;e<b[c].overtures.length;e++)for(var f=0;4>f;f++)if(!b[c].overtures[e].polygon[f].isPointInPolygon(d)){b[c].overtures[e].remove(),hcsdesign.engine2D.requestStaticDraw();break}}},a.prototype.onLeave=function(){hcsdesign.engine2D.unregisterEventCb("SubSlopeOvertureComponent2D.dynamic-draw"),hcsdesign.engine2D.requestDynamicDraw()},a.prototype.onDragDynamicDraw=function(a,b,c){if(hcsdesign.engine2D.getMode()&hcsdesign.engine2D.MODE_SUBSLOPE)for(var d=this.structure.getCurrentStructure(),e=d.getElements("subslopes"),f=0;f<e.length;f++){var g=new Array,h=e[f].wall,i=h.getWallVector().normalize(),j=new BABYLON.Vector2(i.y,-i.x),k=e[f].overtures.length;this.reorganizeSubslopes(e[f].overtures,e[f],i);for(var l=0;k-1>l;l++)g[l]=this.calculateDistance(e[f].overtures[l],e[f].overtures[l+1],i,1),this.drawCotes(e[f].overtures[l],e[f].overtures[l+1],a,b,c,g[l]);for(var m=0;k>m;m++)if(e[f].overtures[m]){var n=this.getIntersectPoint(e[f].overtures[m],e[f],j,2);this.drawCotesSS(e[f].overtures[m],e[f],a,b,c,n,j)}if(e[f].overtures[0]){var o=[],p=this.getIntersectPoint(e[f].overtures[0],e[f],i,0),q=this.getIntersectPoint(e[f].overtures[k-1],e[f],i,1),r=this.getIntersectPoint(e[f].overtures[0],e[f],i,1),s=this.getIntersectPoint(e[f].overtures[k-1],e[f],i,0),t=new BABYLON.Vector2(e[f].overtures[0].getAbsolutePosition().position.x-e[f].polygonPoints[0].x,e[f].overtures[0].getAbsolutePosition().position.y-e[f].polygonPoints[0].y);t.projectOnVector(i);var u=new BABYLON.Vector2(e[f].polygonPoints[0].x+t.x,e[f].polygonPoints[0].y+t.y);o[1]=Math.sqrt((u.x-e[f].polygonPoints[0].x)*(u.x-e[f].polygonPoints[0].x)+(u.y-e[f].polygonPoints[0].y)*(u.y-e[f].polygonPoints[0].y));var v=new BABYLON.Vector2(e[f].overtures[k-1].getAbsolutePosition().position.x-e[f].polygonPoints[0].x,e[f].overtures[k-1].getAbsolutePosition().position.y-e[f].polygonPoints[0].y);v.projectOnVector(i);var w=new BABYLON.Vector2(e[f].polygonPoints[0].x+v.x,e[f].polygonPoints[0].y+v.y);o[2]=Math.sqrt((w.x-e[f].polygonPoints[0].x)*(w.x-e[f].polygonPoints[0].x)+(w.y-e[f].polygonPoints[0].y)*(w.y-e[f].polygonPoints[0].y));var x=new BABYLON.Vector2(e[f].overtures[0].getAbsolutePosition().position.x-e[f].polygonPoints[1].x,e[f].overtures[0].getAbsolutePosition().position.y-e[f].polygonPoints[1].y);x.projectOnVector(i);var y=new BABYLON.Vector2(e[f].polygonPoints[1].x+x.x,e[f].polygonPoints[1].y+x.y);o[3]=Math.sqrt((y.x-e[f].polygonPoints[1].x)*(y.x-e[f].polygonPoints[1].x)+(y.y-e[f].polygonPoints[1].y)*(y.y-e[f].polygonPoints[1].y));var z=new BABYLON.Vector2(e[f].overtures[k-1].getAbsolutePosition().position.x-e[f].polygonPoints[1].x,e[f].overtures[k-1].getAbsolutePosition().position.y-e[f].polygonPoints[1].y);z.projectOnVector(i);var A=new BABYLON.Vector2(e[f].polygonPoints[1].x+z.x,e[f].polygonPoints[1].y+z.y);o[4]=Math.sqrt((A.x-e[f].polygonPoints[1].x)*(A.x-e[f].polygonPoints[1].x)+(A.y-e[f].polygonPoints[1].y)*(A.y-e[f].polygonPoints[1].y));for(var B=1/0,C=1;4>=C;C++)o[C]<B&&(B=o[C]);Math.abs(B-o[1])<.1||Math.abs(B-o[4])<.1?(this.drawCotesSS(e[f].overtures[0],e[f],a,b,c,p,i),this.drawCotesSS(e[f].overtures[k-1],e[f],a,b,c,q,i)):(this.drawCotesSS(e[f].overtures[0],e[f],a,b,c,r,i),this.drawCotesSS(e[f].overtures[k-1],e[f],a,b,c,s,i))}}},a.prototype.calculateDistance=function(a,b,c,d){var e,f=new BABYLON.Vector2(b.position.x-a.position.x,b.position.y-a.position.y);return f.projectOnVector(c),e=Math.sqrt(f.x*f.x+f.y*f.y),e-=0===d?a.height/2+a.height/2:a.width/2+a.width/2},a.prototype.getIntersectPoint=function(a,b,c,d){var e=new BABYLON.Vector2;if(2!=d)var f=b.polygonPoints[0+d].x,g=b.polygonPoints[0+d].y,h=b.polygonPoints[2+d].x,i=b.polygonPoints[2+d].y;else var f=b.polygonPoints[0].x,g=b.polygonPoints[0].y,h=b.polygonPoints[1].x,i=b.polygonPoints[1].y;var j=a.getAbsolutePosition().position.x,k=a.getAbsolutePosition().position.y,l=a.getAbsolutePosition().position.x+c.x,m=a.getAbsolutePosition().position.y+c.y;if(Math.abs(h-f)>.1&&Math.abs(l-j)>.1){var n=(i-g)/(h-f),o=(g*(h-f)-f*(i-g))/(h-f),p=(m-k)/(l-j),q=(k*(l-j)-j*(m-k))/(l-j);e.x=(q-o)/(n-p),e.y=n*((q-o)/(n-p))+o}else if(Math.abs(h-f)<.1)e.x=f,e.y=k;else{e.x=j;var n=(i-g)/(h-f),o=(g*(h-f)-f*(i-g))/(h-f);e.y=n*j+o}return e},a.prototype.onSelectionDynamicDraw=function(a,b,c,d){var e=d.parent.wall,f=e.points[0].position.clone().lerp(e.points[1].position,.5).add(d.position),g={x:f.x*c+b.x,y:f.y*c+b.y};hcsdesign.engine2D.symbols2D.drawGrip(a,g,[!0,!0,!0,!0],0)},a.prototype.changeAddStateVelux=function(){this._addState=1,hcsdesign.engine2D.registerEventCb("component.add-hopper.click",this.priority,"click",hcsdesign.engine2D.MODE_SUBSLOPE,null,this.onAddVeluxClick.bind(this),{}),hcsdesign.engine2D.registerEventCb("component.dynamic-component.mouse-move",this.priority,"mouse-move",hcsdesign.engine2D.MODE_SUBSLOPE,null,this.onMouseMove.bind(this),{}),hcsdesign.engine2D.registerEventCb("component.dynamic-component.dynamic-draw",this.priority,"dynamic-draw",hcsdesign.engine2D.MODE_SUBSLOPE,null,this.onDynamicDraw.bind(this),{}),hcsdesign.engine2D.requestStaticDraw()},a.prototype.changeAddStateSubSlopeOverture=function(){this._addState=1,hcsdesign.engine2D.registerEventCb("component.add-hopper.click",this.priority,"click",hcsdesign.engine2D.MODE_SUBSLOPE,null,this.onAddSubSlopeOvertureClick.bind(this),{}),hcsdesign.engine2D.registerEventCb("component.dynamic-component.mouse-move",this.priority,"mouse-move",hcsdesign.engine2D.MODE_SUBSLOPE,null,this.onMouseMove.bind(this),{}),hcsdesign.engine2D.registerEventCb("component.dynamic-component.dynamic-draw",this.priority,"dynamic-draw",hcsdesign.engine2D.MODE_SUBSLOPE,null,this.onDynamicDraw.bind(this),{}),hcsdesign.engine2D.requestStaticDraw()},a.prototype.onAddVelux=function(){this._tmpOverture=new SubSlopeOvertureStructure,this._tmpOverture.type="Velux",this.changeAddStateVelux()},a.prototype.onAddSubSlopeOverture=function(a){this._tmpOverture=new SubSlopeOvertureStructure,this._tmpOverture.type=a.id,a.width&&(this._tmpOverture.width=a.width),a.height&&(this._tmpOverture.height=a.height),this.changeAddStateSubSlopeOverture()},a.prototype.onAddSubSlopeOvertureClick=function(){hcsdesign.helpBubbleManager.display("hcs.2d.subslopeOverture-menu"),1==this._addState&&(this._tmpOverture.parent.overtures.push(this._tmpOverture),hcsdesign.engine2D.requestStaticDraw(),ujs.notify("hcs.menu.main.deselect"),this._addState=0,this._tmpOverture=null,hcsdesign.engine2D.requestDynamicDraw())},a.prototype.onMouseMove=function(a,b,c){if(this._tmpOverture){this._tmpOverture._tmpPos=c.planPos;
for(var d=hcsdesign.getSelectedStructure(),e=d.getElements("walls"),f=0;f<e.length;f++)for(var g=0;g<e[f].subSlopes.length;g++)if(e[f].subSlopes[g].isPointIn(c.planPos)){this._tmpOverture.parent=e[f].subSlopes[g];var h=e[f].subSlopes[g].wall,i=h.getWallVector().normalize(),j=new BABYLON.Vector2(i.y,-i.x);return this._tmpOverture.position.copyFrom(this._tmpOverture._tmpPos).subtractInPlace(h.points[0].position.clone().lerp(h.points[1].position,.5)),this.appliedMagnetism(this._tmpOverture,e[f].subSlopes[g],j,i),void hcsdesign.engine2D.requestStaticDraw()}}},a.prototype.onContextMenu=function(a,b){var c,d=[],e=Math.atan((b.parent.hiHeight-b.parent.lowHeight)/b.parent.offset);c="Dormer"==b.type?2*b.wallThickness:0,"Dormer"!=b.type&&d.push({name:"height",label:_("高度"),type:"slider",cast:"int",unit:"cm",value:{min:20,max:500,step:1,value:b.height}}),d.push({name:"width",label:_("宽度"),type:"slider",cast:"int",unit:"cm",value:{min:20,max:500,step:1,value:Math.round(b.width)+c}}),"Dormer"==b.type&&(d.push({name:"dormerRoofHeight",label:_("屋顶高度"),type:"slider",cast:"int",value:{min:0,max:b.width,step:1,value:Math.round(b.dormerRoof.height>-1?b.dormerRoof.height:b.width/2)}}),d.push({name:"nbCasement",label:_("窗的个数"),type:"slider",cast:"int",value:{min:1,max:6,step:1,value:b.nbCasement}}),d.push({name:"height",label:_("高度"),type:"slider",cast:"int",unit:"cm",value:{min:20,max:500,step:1,value:Math.round(b.height*Math.sin(e))}}),d.push({name:"depth",label:_("深度"),type:"html",html:"<label>"+_("深度")+'</label><span class="field">'+Math.round(b.height*Math.cos(e))+" cm</span>"})),hcsdesign.engine2D.displayContextMenu(d,b,this.onContextMenuPropertyChanged.bind(this),this.onContextMenuRemove.bind(this))},a.prototype.onContextMenuPropertyChanged=function(a,b,c){var d=Math.atan((a.parent.hiHeight-a.parent.lowHeight)/a.parent.offset);if(-1!=b.indexOf("sticks_")){var e=b.split("_");a.sticks[e[1]]=c}else if("cut"==b){var f=a.points[this._targetedAtSide],g=a.points[this._targetedAtSide+1],h=f.clone().lerp(g,.5);a.insertPointAt(this._targetedAtSide+1,h)}else if("enable_sticks"==b)for(var i=0;i<a.points.length;i++)a.sticks[i]=!0;else if("disable_sticks"==b)for(var i=0;i<a.points.length;i++)a.sticks[i]=!1;else"dormerRoofHeight"==b?a.dormerRoof.height=c:a[b]="height"==b?c/Math.sin(d):"width"==b&&"Dormer"==a.type?c-2*a.wallThickness:c;hcsdesign.engine2D.requestStaticDraw()},a.prototype.onContextMenuRemove=function(a){var b=hcsdesign.getSelectedStructure();a.remove(b),hcsdesign.engine2D.requestDynamicDraw()},a.prototype.onStaticDraw=function(a,b,c){if(0!=(hcsdesign.engine2D.getMode()&hcsdesign.engine2D.MODE_SUBSLOPE))for(var d=hcsdesign.getSelectedStructure(),e=d.getElements("walls"),f=0;f<e.length;f++)for(var g=0;g<e[f].subSlopes.length;g++)for(var h=0;h<e[f].subSlopes[g].overtures.length;h++)this.draw(e[f].subSlopes[g].overtures[h],a,b,c)},a.prototype.onDynamicDraw=function(a,b,c){1==this._addState&&(hcsdesign.engine2D.setCursorIcon(hcsdesign.engine2D.symbols2D.drawCursorCheck.bind(hcsdesign.engine2D.symbols2D)),this.draw(this._tmpOverture,a,b,c,!1)),this.drawMagnetism(this._overture1Magnetism,this._overture2Magnetism,a,b,c)},a.prototype.onDragStart=function(a,b){return hcsdesign.engine2D.registerEventCb("SubSlopeOvertureComponent2D.drag-end",this.priority,"drag-end",hcsdesign.engine2D.MODE_DRAG,null,this.onDragEnd.bind(this),b),hcsdesign.engine2D.registerEventCb("SubSlopeOvertureComponent2D.dynamic-draw",this.priority,"dynamic-draw",hcsdesign.engine2D.MODE_DRAG,null,this.onSelectionDynamicDraw.bind(this),b),hcsdesign.engine2D.registerEventCb("component.dynamic-component.dynamic-draw",this.priority,"dynamic-draw",hcsdesign.engine2D.MODE_SUBSLOPE,null,this.onDynamicDraw.bind(this),{}),hcsdesign.engine2D.registerEventCb("SubSlopeOvertureComponent2D.dragging",this.priority,"dragging",hcsdesign.engine2D.MODE_DRAG,null,this.onDraggingMove.bind(this),b),!1},a.prototype.onDraggingMove=function(a,b,c,d){for(var e=d.parent.wall,f=e.getWallVector().normalize(),g=new BABYLON.Vector2(f.y,-f.x),h=this.structure.getCurrentStructure(),i=h.getElements("subslopes"),j=0;j<i.length;j++)i[j].isPointIn(c.planPos)&&(d.wall=i[j].wall);var e=d.wall,k=(e.getWallVector().normalize(),e.points[0].position.clone().lerp(e.points[1].position,.5),c.posDelta.scale(1/hcsdesign.engine2D.getZoom())),l=new BABYLON.Vector2(k.x,k.y),m=new BABYLON.Vector2(k.x,k.y);if(l.projectOnVector(f),m.projectOnVector(g),null===this._targetedAtSide){var n=c.planPos.subtract(d.parent.wall.points[0].position.clone().lerp(d.parent.wall.points[1].position,.5)),o=(new BABYLON.Vector2((k.x*f.x+k.x*g.x)/(f.x*f.x+f.y*f.y),(k.x*f.y-k.x*g.y)/(f.x*f.x+f.y*f.y)),[]);o[0]=c.planPos.add(f.scale(d.width/2)).add(g.scale(d.height/2)),o[1]=c.planPos.subtract(f.scale(d.width/2)).add(g.scale(d.height/2)),o[2]=c.planPos.add(f.scale(d.width/2)).subtract(g.scale(d.height/2)),o[3]=c.planPos.subtract(f.scale(d.width/2)).subtract(g.scale(d.height/2)),d.parent.computePolygonPoints(),this.isInSubSlope(d.parent.polygonPoints,o,d.width,d.height)&&(d.position=n,this.appliedMagnetism(d,d.parent,g,f))}else{var p=Math.atan((d.parent.hiHeight-d.parent.lowHeight)/d.parent.offset),q=Math.cos(p),r=new BABYLON.Vector2(d.parent.polygonPoints[2].x-d.parent.polygonPoints[0].x,d.parent.polygonPoints[2].y-d.parent.polygonPoints[0].y);r.projectOnVector(g);var s=r.x*g.x+r.y*g.y;0>s&&(f.x=-f.x,f.y=-f.y,g.x=-g.x,g.y=-g.y);var t=d.polygon[this._targetedAtSide],u=this._targetedAtSide+1<d.polygon.length?this._targetedAtSide+1:0,v=d.polygon[u],o=(new BABYLON.Vector2(t.y-v.y,v.x-t.x),[]);if(o[0]=d.polygon[0],o[1]=d.polygon[1],o[2]=d.polygon[2],o[3]=d.polygon[3],this._targetedAtSide%2===0){d.position.addInPlace(l.scale(.5));var w=f.dot(l)>0?1:-1,x=0===this._targetedAtSide?1:-1;d.width+=x*w*l.length(),this.appliedMagnetism(d,d.parent,g,f)}else{d.position.addInPlace(m.scale(.5));var w=g.dot(m)>0?1:-1,x=1===this._targetedAtSide?-1:1;d.height+=1/q*x*w*m.length()}}return d.modified=!0,hcsdesign.engine2D.requestStaticDraw(),!1},a.prototype.onDoubleClick=function(a,b){return this.core.helpBubbleManager.display("hcs.2d.dup-overture"),this.onAddSubSlopeOverture({id:b.type,width:b.width,height:b.height}),!0},a.prototype.isInSubSlope=function(a,b){var c=[];return c[0]=a[0],c[1]=a[1],c[2]=a[3],c[3]=a[2],b[0].isPointInPolygon(c)&&b[1].isPointInPolygon(c)&&b[2].isPointInPolygon(c)&&b[3].isPointInPolygon(c)?!0:!1},a.prototype.appliedMagnetism=function(a,b,c){var d=[];d.push(a);for(var e,f=0;f<b.overtures.length;f++)if(b.overtures[f].id!=a.id&&(e=c.x*(b.overtures[f].position.x-a.position.x)+c.y*(b.overtures[f].position.y-a.position.y),Math.abs(e)<6)){d.push(b.overtures[f]);var g=new BABYLON.Vector2;g.x=b.overtures[f].position.x-a.position.x,g.y=b.overtures[f].position.y-a.position.y,g.projectOnVector(c),a.position.addInPlace(g.scale(1)),this._overture1Magnetism=a,this._overture2Magnetism=b.overtures[f]}},a.prototype.appliedSideMagnetism=function(a,b,c,d,e){if(3==e)for(var f=0;f<b.overtures.length;f++){var g=c.length(),h=a.height/(2*g),i=b.overtures[f].height/(2*g),j=new BABYLON.Vector2(a.position.x+c.x*h,a.position.y+c.y*h),k=new BABYLON.Vector2(b.overtures[f].position.x+c.x*i,b.overtures[f].position.y+c.y*i),l=new BABYLON.Vector2(j.x-k.x,j.y-k.y);if(b.overtures[f].id!=a.id&&Math.abs(l.x*c.x+l.y*c.y)<7){l.projectOnVector(c);var m=c.dot(l)>0?-1:1;a.height+=m*l.length(),a.position.x-=.5*l.x,a.position.y-=.5*l.y}}else for(var f=0;f<b.overtures.length;f++){var g=c.length(),h=-a.height/(2*g),i=-b.overtures[f].height/(2*g),j=new BABYLON.Vector2(a.position.x+c.x*h,a.position.y+c.y*h),k=new BABYLON.Vector2(b.overtures[f].position.x+c.x*i,b.overtures[f].position.y+c.y*i),l=new BABYLON.Vector2(j.x-k.x,j.y-k.y);if(b.overtures[f].id!=a.id&&Math.abs(l.x*c.x+l.y*c.y)<7){l.projectOnVector(c);var m=c.dot(l)>0?1:-1;a.height+=m*l.length(),a.position.x-=.5*l.x,a.position.y-=.5*l.y}}},a.prototype.reorganizeSubslopes=function(a,b,c){for(var d=c,e=(new BABYLON.Vector2(d.y,-d.x),[]),f=(d.x*(b.polygonPoints[0].x-b.polygonPoints[1].x)+d.y*(b.polygonPoints[0].y-b.polygonPoints[1].y),0);f<a.length;f++){var g=new BABYLON.Vector2(a[f].position.x-b.polygonPoints[0].x,a[f].position.y-b.polygonPoints[0].y);g.projectOnVector(d);var h=new BABYLON.Vector2(b.polygonPoints[0].x+g.x,b.polygonPoints[0].y+g.y),i=Math.sqrt((h.x-b.polygonPoints[0].x)*(h.x-b.polygonPoints[0].x)+(h.y-b.polygonPoints[0].y)*(h.y-b.polygonPoints[0].y));e.push(i)}for(var j=1;j<e.length;j++){for(var k=e[j],l=a[j],m=j;m>0&&e[m-1]>k;)e[m]=e[m-1],a[m]=a[m-1],m--;e[m]=k,a[m]=l}},a.prototype.onDragEnd=function(a,b,c,d){hcsdesign.engine2D.unregisterEventCb("SubSlopeOvertureComponent2D.dynamic-draw"),hcsdesign.engine2D.requestStaticDraw(),this.checkCoherence(d),this._overture1Magnetism=null,this._overture2Magnetism=null},a.prototype.checkCoherence=function(a){a.width<0&&(a.width=-a.width),a.height<0&&(a.height=-a.height)},a.prototype.isPointInOvertureSide=function(a,b){for(var c=0;c<b.polygon.length;c++){var d=b.polygon[c].clone(),e=c+1<b.polygon.length?b.polygon[c+1]:b.polygon[0],f=Math.abs(d.distanceTo(a)+e.distanceTo(a)-d.distanceTo(e));if(1>f)return c}return!1},a.prototype.drawTarget=function(a,b,c){if(null!==this._targetedAt){var d=hcsdesign.engine2D.toRealCoord(a.polygon[this._targetedAt]);hcsdesign.engine2D.symbols2D.drawPointHover(b,d,c)}else if(null!==this._targetedAtSide){var e=hcsdesign.engine2D.toRealCoord(a.polygon[this._targetedAtSide]),f=hcsdesign.engine2D.toRealCoord(this._targetedAtSide+1<a.polygon.length?a.polygon[this._targetedAtSide+1]:a.polygon[0]);hcsdesign.engine2D.symbols2D.drawSegment(b,e,f)}},a.prototype.draw=function(a,b,c,d,e){if(b.save(),b.beginPath(),e?(b.fillStyle=hcsdesign.engine2D.symbols2D.COLOR_ACTIVE_FILL,b.strokeStyle=hcsdesign.engine2D.symbols2D.COLOR_ACTIVE_STROKE_DARKER):(b.fillStyle=hcsdesign.engine2D.symbols2D.COLOR_INACTIVE_FILL,b.strokeStyle=hcsdesign.engine2D.symbols2D.COLOR_INACTIVE_STROKE),null!==a.position&&null!==a.parent){var f=a.parent.wall,g=f.getWallVector().normalize(),h=new BABYLON.Vector2(g.y,-g.x),i=new BABYLON.Vector2(f.subSlopes[0].polygonPoints[2].x-f.subSlopes[0].polygonPoints[0].x,f.subSlopes[0].polygonPoints[2].y-f.subSlopes[0].polygonPoints[0].y);i.projectOnVector(h);var j=i.x*h.x+i.y*h.y;0>j&&(g.x=-g.x,g.y=-g.y,h.x=-h.x,h.y=-h.y);var k=f.points[0].position.clone().lerp(f.points[1].position,.5).add(a.position),l=40*a.parent.offset/(a.parent.hiHeight-a.parent.lowHeight);a.offset=a.position.dot(h),a.wallOrtho=h,a.center=k;var m=Math.atan((a.parent.hiHeight-a.parent.lowHeight)/a.parent.offset),n=Math.cos(m);"Dormer"==a.type?(a.polygon[0]=k.add(g.scale(a.width/2)).add(h.scale(a.height/(2/n))).add(g.scale(a.wallThickness)),a.polygon[1]=k.add(g.scale(a.width/2)).subtract(h.scale(a.height/(2/n))).subtract(h.scale(a.wallThickness)).add(g.scale(a.wallThickness)),a.polygon[2]=k.subtract(g.scale(a.width/2)).subtract(h.scale(a.height/(2/n))).subtract(h.scale(a.wallThickness)).subtract(g.scale(a.wallThickness)),a.polygon[3]=k.subtract(g.scale(a.width/2)).add(h.scale(a.height/(2/n))).subtract(g.scale(a.wallThickness))):(a.polygon[0]=k.add(g.scale(a.width/2)).add(h.scale(a.height/(2/n))),a.polygon[1]=k.add(g.scale(a.width/2)).subtract(h.scale(a.height/(2/n))),a.polygon[2]=k.subtract(g.scale(a.width/2)).subtract(h.scale(a.height/(2/n))),a.polygon[3]=k.subtract(g.scale(a.width/2)).add(h.scale(a.height/(2/n))));var o=k.add(h.scale(a.height/(2/n)+l)),p=k.subtract(h.scale(a.height/(2/n))),q=hcsdesign.engine2D.toRealCoord(a.polygon[0],c,d),r=hcsdesign.engine2D.toRealCoord(a.polygon[1],c,d),s=hcsdesign.engine2D.toRealCoord(a.polygon[2],c,d),t=hcsdesign.engine2D.toRealCoord(a.polygon[3],c,d),u=hcsdesign.engine2D.toRealCoord(o,c,d),v=hcsdesign.engine2D.toRealCoord(p,c,d);"Velux"==a.type?(b.moveTo(Math.round(q.x)+.5,Math.round(q.y)+.5),b.lineTo(Math.round(r.x)+.5,Math.round(r.y)+.5),b.lineTo(Math.round(s.x)+.5,Math.round(s.y)+.5),b.lineTo(Math.round(t.x)+.5,Math.round(t.y)+.5)):(b.moveTo(Math.round(u.x)+.5,Math.round(u.y)+.5),b.lineTo(Math.round(t.x)+.5,Math.round(t.y)+.5),b.lineTo(Math.round(s.x)+.5,Math.round(s.y)+.5),b.lineTo(Math.round(r.x)+.5,Math.round(r.y)+.5),b.lineTo(Math.round(q.x)+.5,Math.round(q.y)+.5),b.lineTo(Math.round(u.x)+.5,Math.round(u.y)+.5),b.lineTo(Math.round(v.x)+.5,Math.round(v.y)+.5)),b.closePath(),b.fill(),b.stroke(),b.restore()}},a.prototype.drawMagnetism=function(a,b,c,d,e){if(c.save(),c.beginPath(),c.fillStyle=hcsdesign.engine2D.symbols2D.COLOR_ACTIVE_FILL,c.strokeStyle=hcsdesign.engine2D.symbols2D.COLOR_ACTIVE_STROKE,null!==a){var f=a.getAbsolutePosition().position,g=b.getAbsolutePosition().position,h=hcsdesign.engine2D.toRealCoord(f,d,e),i=hcsdesign.engine2D.toRealCoord(g,d,e),j=a.parent.wall,k=j.getWallVector().normalize(),l=Math.abs(k.x*(f.y-g.y)),m=Math.abs(k.y*(f.x-g.x));Math.abs(l-m)<.01&&(c.moveTo(h.x,h.y),c.lineTo(i.x,i.y))}c.closePath(),c.fill(),c.stroke(),c.restore()},a.prototype.drawCotes=function(a,b,c,d,e,f){c.fillStyle=hcsdesign.engine2D.symbols2D.COLOR_INACTIVE_FILL,c.strokeStyle=hcsdesign.engine2D.symbols2D.COLOR_INACTIVE_STROKE;var g=a.parent.wall,h=g.getWallVector().normalize(),i=new BABYLON.Vector2(h.y,-h.x),j=a.getAbsolutePosition().position,k=b.getAbsolutePosition().position,l=j.add(k).scaleInPlace(.5),m=h,n=i,o=j.dot(m),p=k.dot(m);if(o>p){var q=p;p=o,o=q,o+=b.width/2+("Dormer"==b.type?b.wallThickness:0),p-=a.width/2+("Dormer"==a.type?a.wallThickness:0)}else o+=a.width/2+("Dormer"==a.type?a.wallThickness:0),p-=b.width/2+("Dormer"==b.type?b.wallThickness:0);var r=l.dot(n),s=new BABYLON.Vector2(m.x*o+n.x*r,m.y*o+n.y*r),t=new BABYLON.Vector2(m.x*p+n.x*r,m.y*p+n.y*r),u=hcsdesign.engine2D.toRealCoord(s,d,e),v=hcsdesign.engine2D.toRealCoord(t,d,e),w=Math.round(f)/100;hcsdesign.engine2D.symbols2D.drawMeasure(c,u,v,w+"m"),c.closePath(),c.fill(),c.stroke(),c.restore()},a.prototype.drawCotesSS=function(a,b,c,d,e,f,g){c.fillStyle=hcsdesign.engine2D.symbols2D.COLOR_INACTIVE_FILL,c.strokeStyle=hcsdesign.engine2D.symbols2D.COLOR_INACTIVE_STROKE;var h=a.parent.wall,i=h.getWallVector().normalize(),j=new BABYLON.Vector2(i.y,-i.x),k=a.getAbsolutePosition().position,l=f,m=Math.atan((b.hiHeight-b.lowHeight)/b.offset),n=Math.cos(m),o=new BABYLON.Vector2(k.x-l.x,k.y-l.y);if(Math.abs(g.x*j.x+g.y*j.y)<.1)if("Dormer"==a.type){k=k.subtract(o.normalize().scale(a.width/2+a.wallThickness));var p=0}else{k=k.subtract(o.normalize().scale(a.width/2));var p=0}else if("Dormer"==a.type){k=k.subtract(o.normalize().scale(n*a.height/2)).subtract(j.scale(a.wallThickness));var p=Math.atan((b.hiHeight-b.lowHeight)/b.offset)}else{k=k.subtract(o.normalize().scale(n*a.height/2));var p=Math.atan((b.hiHeight-b.lowHeight)/b.offset)}var q=Math.sqrt((f.x-k.x)*(f.x-k.x)+(f.y-k.y)*(f.y-k.y))/Math.cos(p);q=Math.round(q)/100;var r=hcsdesign.engine2D.toRealCoord(k,d,e),s=hcsdesign.engine2D.toRealCoord(l,d,e);hcsdesign.engine2D.symbols2D.drawMeasure(c,r,s,q+"m"),c.closePath(),c.fill(),c.stroke(),c.restore()},a}(),SubSlopeComponent3D=function(){var a,b=function(b){BaseComponent3D.call(this,b,"SubSlopeComponent3D"),this.currentID=0,a=this};return b.prototype=new BaseComponent3D,b.prototype.startListening=function(){document.addEventListener("hcs.engine3d.wallsReady",this.onWallsReady,!1)},b.prototype.stopListening=function(){document.removeEventListener("hcs.engine3d.wallsReady",this.onWallsReady,!1)},b.prototype.onWallsReady=function(b){var c=b.floor||a.getFloor(),d=b.structure||a.core.getSelectedStructure();a.core.getComponentByName("SubSlopeComponent2D").getSubSlopes(!0),a.drawSSForStructure(d,c,hcsdesign.engine3D.scene)},b.prototype.buildCSG=function(a,b,c,d){var e,f,g=g||!1;c=c||this.core.getComponentByName("FloorComponent3D").getFloor(b);var h=a[0].subtract(a[1]),i=a[3].subtract(a[2]),j=[],k=[],l=[],m=[];if(h.dot(i)>0){for(f=0;f<a.length;f++)j.push(a[f].x,a[f].y,a[f].z);j.push(a[0].x,a[2].y,a[0].z),j.push(a[1].x,a[3].y,a[1].z),k.push(0,2,3),k.push(2,0,1),k.push(5,3,2),k.push(3,5,4),k.push(4,1,0),k.push(1,4,5),k.push(5,2,1),k.push(3,4,0)}else{var n=a[0].subtract(a[3]),o=a[3].subtract(a[2]).length(),p=a[1].subtract(a[0]).length(),q=o/p+1,r=n.scale(1/q).subtract(a[0]).scale(-1),s=[a[0],a[1],r];for(f=0;f<s.length;f++)j.push(s[f].x,s[f].y,s[f].z);j.push(s[2].x,a[2].y,s[2].z),j.push(a[0].x,a[2].y,a[0].z),j.push(a[1].x,a[2].y,a[1].z),k.push(0,1,2),k.push(2,3,0),k.push(3,4,0),k.push(1,5,2),k.push(3,2,5),k.push(4,3,5),k.push(1,0,4),k.push(1,4,5)}l=BABYLON.Tools.PlaneUVProjection(j,new BABYLON.Vector3(1,0,0),new BABYLON.Vector3(0,0,1)),BABYLON.Mesh.ComputeFlatNormal(j,m,k);var t=new BABYLON.Mesh("carveMesh",d);return t.setVerticesData(BABYLON.VertexBuffer.PositionKind,j,g),t.setVerticesData(BABYLON.VertexBuffer.NormalKind,m,g),t.setVerticesData(BABYLON.VertexBuffer.UVKind,l,g),t.setIndices(k),t.parent=c,e=BABYLON.CSG.FromMesh(t),t.dispose(),e},b.prototype.addSubSlope=function(a,b,c,d,e,f){var g,h,i,j,k,l,m,n=n||!1,o=[],p=[],q=[],r=[];e=e||this.core.getComponentByName("FloorComponent3D").getFloor(d);var s=new hcs.WhiteMaterial("bottom",hcsdesign.engine3D.scene,{factor:1}),t=c.materials.bottom||s;c.materials.bottom||(c.materials.bottom=t),t.name="bottom";var u=c.materials.top||s.clone("top");c.materials.top||(c.materials.top=u),u.name="top";var v=b[0].subtract(b[1]),w=b[3].subtract(b[2]);if(v.dot(w)>0){for(p.push(0,2,3),p.push(2,0,1),p.push(7,5,4),p.push(5,7,6),g=0;g<b.length;g++)o.push(b[g].x,b[g].y,b[g].z);for(g=0;g<b.length;g++)o.push(b[g].x,b[g].y+.1,b[g].z);i=new BABYLON.Vector3(b[1].x-b[0].x,b[1].y-b[0].y,b[1].z-b[0].z),i.normalize(),j=new BABYLON.Vector3(b[2].x-b[1].x,b[2].y-b[1].y,b[2].z-b[1].z),j.normalize(),l=BABYLON.Vector3.Cross(i,j),k=BABYLON.Vector3.Cross(l,i),q=BABYLON.Tools.PlaneUVProjection(o,i,k,512),BABYLON.Mesh.ComputeFlatNormal(o,r,p),h=new BABYLON.Mesh("subslope_"+this.currentID++,f),h.setVerticesData(BABYLON.VertexBuffer.PositionKind,o,n),h.setVerticesData(BABYLON.VertexBuffer.NormalKind,r,n),h.setVerticesData(BABYLON.VertexBuffer.UVKind,q,n),h.setIndices(p),h.subMeshes.shift(),m=BABYLON.SubMesh.CreateFromIndices(0,0,6,h),m.objectInstance=c,m=BABYLON.SubMesh.CreateFromIndices(1,6,6,h),m.objectInstance=c}else{var x=b[0].subtract(b[3]),y=b[3].subtract(b[2]).length(),z=b[1].subtract(b[0]).length(),A=y/z+1,B=x.scale(1/A).subtract(b[0]).scale(-1),C=[b[0],b[1],B];for(g=0;g<C.length;g++)o.push(C[g].x,C[g].y,C[g].z);for(g=0;g<C.length;g++)o.push(C[g].x,C[g].y+.1,C[g].z);p.push(0,1,2),p.push(5,4,3),i=new BABYLON.Vector3(b[1].x-b[0].x,b[1].y-b[0].y,b[1].z-b[0].z),i.normalize(),j=new BABYLON.Vector3(b[2].x-b[1].x,b[2].y-b[1].y,b[2].z-b[1].z),j.normalize(),l=BABYLON.Vector3.Cross(i,j),k=BABYLON.Vector3.Cross(l,i),q=BABYLON.Tools.PlaneUVProjection(o,i,k,512),BABYLON.Mesh.ComputeFlatNormal(o,r,p),h=new BABYLON.Mesh("subslope_"+this.currentID++,f),h.setVerticesData(BABYLON.VertexBuffer.PositionKind,o,n),h.setVerticesData(BABYLON.VertexBuffer.NormalKind,r,n),h.setVerticesData(BABYLON.VertexBuffer.UVKind,q,n),h.setIndices(p),h.subMeshes.shift(),m=BABYLON.SubMesh.CreateFromIndices(0,0,3,h),m.objectInstance=c,m=BABYLON.SubMesh.CreateFromIndices(1,3,3,h),m.objectInstance=c}h.position.y=.2;var D=a,E=BABYLON.Mesh.mergeMeshes("mat",[D,h],f,!0);E.name=D.name,E.id=D.id,E.decorate=D.decorate,E.receiveShadows=D.receiveShadows,E.material=D.material,E.isDecorable=!0,hcsdesign.engine3D.castShadows(E)},b.prototype.buildFromCSG=function(a,b,c,d,e,f){var g=a,h=b,i=d.clone();h.subtractInPlace(d);var j=h.toMesh("mat",g.material,f,!0);this.core.getComponentByName("WallComponent3D").replaceWall(g,j),j.material=g.material,j.isDecorable=!0,hcsdesign.engine3D.castShadows(j);var k=c;k.subtractInPlace(i);var l=k.toMesh("mat",e.roomMesh.material,f,!0);return l.isDecorable=!0,this.core.getComponentByName("RoomComponent3D").replaceRoom(e.roomMesh,l),l.parent=e,e.roomMesh=l,j},b.prototype.drawSSForStructure=function(a,b,c){var d,e,f,g=[],h=a.getElements("subslopes"),i=0,j=this.core.getComponentByName("WallComponent3D").get3DWallFrom2D(a),k=BABYLON.CSG.FromMesh(j),l=BABYLON.CSG.FromMesh(b.roomMesh),m=new BABYLON.CSG;for(e=0,f=h.length;f>e;e++)if(d=h[e].plane(),d&&(i++,g.push(d)),d){var n=this.buildCSG(d,h[e],b,c);n?m.unionInPlace(n):i--}for(j=this.core.getComponentByName("WallComponent3D").get3DWallFrom2D(a),this.buildFromCSG(j,k,l,m,b,c),e=0,f=h.length;f>e;e++)d=h[e].plane(),j=this.core.getComponentByName("WallComponent3D").get3DWallFrom2D(a),d&&this.addSubSlope(j,d,h[e],a,b,c);j=this.core.getComponentByName("WallComponent3D").get3DWallFrom2D(a),j.parent=b,ujs.notify("hcs.engine3d.subslopesReady",{floor:b,structure:a,walls:j})},b}(),StairwayStructure=function(){var a=function(){BaseStructure.call(this,"StairwayStructure"),this.points=[],this.type="straight",this.width=90,this.height=250,this.stair_height=20,this.stair_thickness=3,this.stair_width=25,this.rail_a=!0,this.rail_b=!0,this.limon=-1,this.stick_spacement=20,this.have_contremarche=!0,this.elevation=0,this.diameter=6,this.bearing=!0,this.stair_offset=3,this.materials=void 0,this.room=null,this.orientation=!0};return a.prototype=new BaseStructure,a.prototype.isTargeted=function(){return!1},a.prototype.draw=function(){return!1},a.prototype.isValid=function(){return!0},a.serialize=function(a){for(var b=[],c=0,d=a.length;d>c;c++)b.push(a[c].serialize());return b},a.deserialize=function(a){for(var b=[],c=0,d=a.length;d>c;c++){if("spiral"==a[c].type)var e=new SpiralStairwayStructure;else var e=new StraightStairwayStructure;e.deserialize(a[c]),e.isValid()!==!1&&b.push(e)}return b},a.prototype.serialize=function(){var a={"class":{name:"StraightStairwayStructure"}};return ujs.serializeObject(this,a,["id","type","name","width","height","stair_offset","stair_thickness","is_closed","rail_b","rail_a","have_contremarche","elevation","z","area","points","bearing","diameter","limon","orientation","materials"]),a},a.prototype.deserialize=function(a){this.id=a.id,this.type=a.type||"straight",this.name=a.name,this.width=a.width||90,this.height=a.height||250,this.z=a.z||0,this.is_closed=a.is_closed,this.area=a.area,this.points.length=0,this.have_contremarche=a.have_contremarche,this.elevation=a.elevation,this.rail_a=a.rail_a,this.rail_b=a.rail_b,this.stair_offset="undefined"!=typeof a.stair_offset?a.stair_offset:3,this.materials=a.materials||{},this.bearing="undefined"==typeof a.bearing?!0:a.bearing,this.diameter="undefined"==typeof a.diameter?6:a.diameter,this.stair_thickness="undefined"==typeof a.stair_thickness?3:a.stair_thickness,this.limon="undefined"==typeof a.limon?10:a.limon,this.orientation="undefined"==typeof a.orientation?!0:a.orientation;for(var b=0,c=a.points.length;c>b;b++)this.points.push(new BABYLON.Vector3(a.points[b].x,a.points[b].y,a.points[b].z))},a.prototype.getHopperPoints=function(){for(var a=-1/0,b=-1/0,c=1/0,d=1/0,e=[],f=0;f<this.points.length-1;f++)e=e.concat(this.getStepBoundPoints(f));for(var f=0;f<e.length;f++){var g=e[f];g.x>a&&(a=g.x),g.x<c&&(c=g.x),g.y>b&&(b=g.y),g.y<d&&(d=g.y)}return[new BABYLON.Vector2(a,b),new BABYLON.Vector2(c,b),new BABYLON.Vector2(c,d),new BABYLON.Vector2(a,d)]},a.prototype.getStepBoundPoints=function(a){var b=this.points[a],c=this.points[a+1];a+2<this.points.length&&(c=c.clone().add(c.clone().subtractInPlace(b.clone()).normalize().scaleInPlace(this.width/2))),a>0&&(b=b.clone().add(c.clone().subtractInPlace(b.clone()).normalize().scaleInPlace(this.width/2)));var d=new BABYLON.Vector3(b.y-c.y,c.x-b.x,0).normalize(),e=b.clone().add(d.clone().scaleInPlace(this.width/2)),f=b.clone().subtractInPlace(d.clone().scaleInPlace(this.width/2)),g=c.clone().subtractInPlace(d.clone().scaleInPlace(this.width/2)),h=c.clone().add(d.clone().scaleInPlace(this.width/2));return[e,f,g,h]},a.prototype.getNormalAtPoint=function(a){var b=this.points[a-1].clone(),c=this.points[a].clone(),d=new BABYLON.Vector3(b.y-c.y,c.x-b.x,0);return d.normalize(),d},a.prototype.remove=function(a){a.removeElement("stairways",this)},a.prototype.addMaterial=function(a,b,c){this.materials[b.name]=c,a.traverse(function(a){a.name==b.name&&a!=b&&(a.material=b.material.clone())})},a.prototype.getAvailableProperties=function(){var a=[];return a.push({name:"width",label:_("Width"),type:"number",cast:"int",unit:"cm",value:{min:3,max:100,step:1,value:this.width}}),a.push({name:"rail_a",label:_("Right guard-rail"),type:"checkbox",value:this.rail_a}),a.push({name:"rail_b",label:_("Left guard-rail"),type:"checkbox",value:this.rail_b}),a.push({name:"have_contremarche",label:_("riser"),type:"checkbox",value:this.have_contremarche}),a},a}(),StraightStairwayStructure=function(){var a=function(){StairwayStructure.call(this),this.type="straight",this._steps=[]};return a.prototype=new StairwayStructure,a.prototype.isValid=function(){return this.points.length<=1?!1:!0},a.prototype.isTargeted=function(a){for(var b,c=!1,d=!1,e=!1,f=0;f<this.points.length;f++)b=this.getBoundPoints(f),this.isInPoly(a,b)&&(c=f,e=!0),this.points[f].distanceTo(a)<10&&(d=f,e=!0);return e?{point:d,step:c}:!1},a.prototype.draw=function(a,b){b&&this.points.push(b),this.computeSteps(),b&&this.points.pop(b);for(var c=0;c<this._steps.length;c++)this.drawStep(a,this._steps[c])},a.prototype.serialize=function(){var a={"class":{name:"StraightStairwayStructure"}};return ujs.serializeObject(this,a,["id","type","name","width","height","stair_offset","stair_thickness","is_closed","rail_b","rail_a","have_contremarche","elevation","z","area","points","bearing","diameter","limon","orientation","materials"]),a},a.Deserialize=function(a){var b=new StraightStairwayStructure;return ujs.deserializeObject(a,b,["id","type","name","width","height","stair_offset","stair_thickness","is_closed","rail_b","rail_a","have_contremarche","elevation","z","area","points","bearing","diameter","limon","orientation","materials"]),b.computeSteps(),b},a.prototype.computeSteps=function(){this._steps.length=0;for(var a,b,c,d,e=0;e<this.points.length-1;e++){b=this.getBoundPoints(e-1),c=this.getBoundPoints(e),d=this.getBoundPoints(e+1);var f=c[0].clone(),g=c[1].clone(),h=c[2].clone(),i=c[3].clone(),j=this.points[e].clone(),k=this.points[e+1].clone(),l=null,m=null,n=null,o=null,p=null,q=null;d&&(ia1=BABYLON.Vector2.Intersect(c[0],c[3],d[0],d[3]),"undefined"!=typeof ia1&&(i.x=ia1.x,i.y=ia1.y),ib1=BABYLON.Vector2.Intersect(c[1],c[2],d[1],d[2]),"undefined"!=typeof ib1&&(h.x=ib1.x,h.y=ib1.y),j.distanceTo(i)>j.distanceTo(h)?(k=j.add(h.subtract(j).projectOnVector(k.subtract(j))),o=h.clone(),m=k.add(k.subtract(h)),p=i.clone()):(k=j.add(i.subtract(j).projectOnVector(k.subtract(j))),o=i.clone(),m=k.add(k.subtract(i)),p=h.clone())),b&&(ia0=BABYLON.Vector2.Intersect(c[0],c[3],b[0],b[3]),"undefined"!=typeof ia0&&(f.x=ia0.x,f.y=ia0.y),ib0=BABYLON.Vector2.Intersect(c[1],c[2],b[1],b[2]),"undefined"!=typeof ib0&&(g.x=ib0.x,g.y=ib0.y),k.distanceTo(f)>k.distanceTo(g)?(j=k.add(g.subtract(k).projectOnVector(j.subtract(k))),n=g.clone(),l=j.add(j.subtract(g)),q=f.clone()):(j=k.add(f.subtract(k).projectOnVector(j.subtract(k))),n=f.clone(),l=j.add(j.subtract(f)),q=g.clone())),a={id:e,boundPolygon:c,areaPolygon:[f,g,h,i],stairsSegment:[j,k],bearingPolygon0:[n,l,q],bearingPolygon1:[o,m,p]},this._steps.push(a)}},a.prototype.getBoundPoints=function(a){if(this.points[a]&&this.points[a+1]){var b=this.points[a+1].subtract(this.points[a]).normalize(),c=new BABYLON.Vector3(b.y,-b.x,0).scaleInPlace(this.width/2),d=this.points[a].add(c),e=this.points[a+1].add(c),f=this.points[a+1].subtract(c),g=this.points[a].subtract(c);return[d,g,f,e]}return!1},a.prototype.drawStepBearing=function(a,b,c){var c=c||0;if(!this.bearing&&b[0]){var d,e=b[1].distanceTo(b[2]),f=25,g=Math.floor(e/f);a.beginPath();for(var h=1;g-c>=h;h++)d=b[1].clone().lerp(b[2],1/g*h),a.moveTo(b[0].x,b[0].y),a.lineTo(d.x,d.y);a.stroke()}},a.prototype.drawStep=function(a,b){var c=b.areaPolygon,d=c[3].subtract(c[0]).normalize(),e=new BABYLON.Vector3(d.y,-d.x,0).scaleInPlace(10),f=c[0].add(e),g=c[3].add(e),h=Math.round(f.distanceTo(g))/100;if(h>.5&&hcsdesign.engine2D.symbols2D.drawMeasure(a,f,g,h+"m","#cccccc"),this.points.length>2){var i=c[1].subtract(e),j=c[2].subtract(e),k=Math.round(i.distanceTo(j))/100;k>.5&&hcsdesign.engine2D.symbols2D.drawMeasure(a,i,j,k+"m","#cccccc")}a.beginPath(),a.moveTo(c[0].x,c[0].y),a.lineTo(c[3].x,c[3].y),a.moveTo(c[1].x,c[1].y),a.lineTo(c[2].x,c[2].y),a.stroke(),this.drawStepStairs(a,b.stairsSegment),this.drawStepBearing(a,b.bearingPolygon0,1),this.drawStepBearing(a,b.bearingPolygon1)},a.prototype.drawStepStairs=function(a,b){var c=b[0].clone(),d=b[1],e=d.subtract(c).normalize(),f=new BABYLON.Vector3(e.y,-e.x,0).scaleInPlace(this.width/2),g=c.distanceTo(d),h=20,i=Math.floor(g/h),j=g/i,k=Math.atan2(e.y,e.x);hcsdesign.engine2D.symbols2D.drawArrows(a,c,[0,1,0,0],0,k,!1,{size:10}),hcsdesign.engine2D.symbols2D.drawArrows(a,d,[0,1,0,0],-10,k,!1,{size:10});var l=e.scale(j);a.beginPath();for(var m,n,o=0;i>=o;o++)m=c.add(f),n=c.subtract(f),a.moveTo(m.x,m.y),a.lineTo(n.x,n.y),c.addInPlace(l);a.stroke()},a.prototype.isInPoly=function(a,b){var c,d,e=0;for(c=0,d=b.length-1;c<b.length;d=c++)b[c].y>a.y!=b[d].y>a.y&&a.x<(b[d].x-b[c].x)*(a.y-b[c].y)/(b[d].y-b[c].y)+b[c].x&&(e=!e);return e},a}(),SpiralStairwayStructure=function(){var a=function(){StairwayStructure.call(this),this.type="spiral"};return a.prototype=new StairwayStructure,a.prototype.serialize=function(){var a={"class":{name:"SpiralStairwayStructure"}};return ujs.serializeObject(this,a,["id","type","name","width","height","stair_offset","stair_thickness","is_closed","rail_b","rail_a","have_contremarche","z","area","points","bearing","diameter","limon","orientation","materials"]),a},a.Deserialize=function(a){var b=new SpiralStairwayStructure;return ujs.deserializeObject(a,b,["id","type","name","width","height","stair_offset","stair_thickness","is_closed","rail_b","rail_a","have_contremarche","z","area","points","bearing","diameter","limon","orientation","materials"]),b},a.prototype.computeSpiralPoints=function(){var a=0,b=-Math.PI/2,c=this.points[0],d=new BABYLON.Vector3(this.width*Math.cos(a),this.width*Math.sin(a),0),e=new BABYLON.Vector3(this.width*Math.cos(b),this.width*Math.sin(b),0);this.points[1]=c.clone().add(d),this.points[2]=c.clone().add(e)},a.prototype.isTargeted=function(a){var b=!1,c=0;if(a.distanceTo(this.points[0])<this.width&&(b=!0),this.points[1]&&this.points[0]){var d=a.distanceTo(this.points[1]),e=a.distanceTo(this.points[2]);10>d?(c=1,b=!0):10>e&&(b=!0,c=2)}return b?{point:c}:!1},a.prototype.getHopperPoints=function(){var a=this.points[0].clone(),b=a.clone();b.y-=this.width;var c=b.clone();c.x-=this.width;var d=c.clone();d.y+=2*this.width;var e=d.clone();e.x+=2*this.width;var f=e.clone();return f.y-=this.width,[a,b,c,d,e,f]},a.prototype.draw=function(a,b){var c=this.points[0]||b,d=this.points[1]||b.clone().add(new BABYLON.Vector3(this.width,0,0)),e=this.points[2]||d.clone(),f=this.width,g=Math.atan2(d.y-c.y,d.x-c.x),h=Math.atan2(e.y-c.y,e.x-c.x);g==h&&(h=2*Math.PI),a.beginPath(),this.orientation?1:-1,this.orientation?a.arc(c.x,c.y,f,g,h,!1):a.arc(c.x,c.y,f,h,g,!1),a.moveTo(c.x,c.y),a.lineTo(d.x,d.y),a.moveTo(c.x,c.y),a.lineTo(e.x,e.y),a.stroke();var i=[0,0,1,0];this.orientation||(i=[1,0,0,0]),hcsdesign.engine2D.symbols2D.drawArrows(a,c.clone().lerp(d,.5),i,0,g,!1,{size:10}),hcsdesign.engine2D.symbols2D.drawArrows(a,c.clone().lerp(e,.5),i,-10,h,!1,{size:10}),a.save(),a.beginPath(),this.orientation?a.arc(c.x,c.y,f,h,g,!1):a.arc(c.x,c.y,f,g,h,!1),a.strokeStyle="#eeeeee";for(var j,k=0;10>=k;k++)j=15*k/80*Math.PI,a.moveTo(c.x,c.y),p2x=c.x+Math.cos(j)*f,p2y=c.y+Math.sin(j)*f,a.lineTo(p2x,p2y);a.stroke(),a.restore(),a.save(),a.fillStyle="#ffffff",a.beginPath(),a.arc(c.x,c.y,this.diameter,0,2*Math.PI,!1),a.stroke(),a.fill(),a.restore()},a}(),StairwayComponent2D=function(){var a=null,b=function(b){BaseComponent2D.call(this,b,"StairwayComponent2D"),this.priority=50,this._tmpStairway=!1,this._tmpPoint=null,this._targetedAt=null,this._targetedAtPoint=null,this._SIZE=13,a=this,this.onFloorAdded=this.onFloorAdded.bind(this),document.addEventListener("hcs.request.floorAdded",this.onFloorAdded),document.addEventListener("hcs.core.structure.loaded",this.onStructureLoaded.bind(this))
};return b.prototype=new BaseComponent2D,b.prototype.startListening=function(){this.onAddStairway=this.onAddStairway.bind(this),document.addEventListener("hcs.engine2d.onAddStairway",this.onAddStairway,!1),this.core.engine2D.registerEventCb("StairwayComponent2D.stair.static-draw",this.priority,"static-draw",null,null,this.onStaticDraw.bind(this),{}),this.core.engine2D.registerEventCb("StairwayComponent2D.stair.hover",this.priority,"hover",this.core.engine2D.MODE_NORMAL|this.core.engine2D.MODE_DRAG|this.core.engine2D.MODE_CONTEXTMENU,StairwayStructure,this.onHover.bind(this),{}),this.core.engine2D.registerEventCb("StairwayComponent2D.stair.leave",this.priority,"leave",this.core.engine2D.MODE_NORMAL|this.core.engine2D.MODE_CONTEXTMENU,StairwayStructure,this.onLeave.bind(this),{}),this.core.engine2D.registerEventCb("StairwayComponent2D.stair.click",this.priority,"click",this.core.engine2D.MODE_NORMAL,StairwayStructure,this.onContextMenu.bind(this),{}),this.core.engine2D.registerEventCb("StairwayComponent2D.stair.dblclick",this.priority,"double-click",this.core.engine2D.MODE_NORMAL,StairwayStructure,this.onDoubleClick.bind(this),{})},b.prototype.stopListening=function(){document.removeEventListener("hcs.engine2d.onAddStairway",this.onAddStairway,!1),this.core.engine2D.unregisterEventCb("StairwayComponent2D.stair.static-draw"),this.core.engine2D.unregisterEventCb("StairwayComponent2D.stair.hover"),this.core.engine2D.unregisterEventCb("StairwayComponent2D.stair.leave"),this.core.engine2D.unregisterEventCb("StairwayComponent2D.stair.click"),this.core.engine2D.unregisterEventCb("StairwayComponent2D.stair.dblclick")},b.prototype.onStructureLoaded=function(){for(var a,b=0;b<this.structure.members.length;b++){a=this.structure.members[b];for(var c=a.stairways.length-1;c>=0;c--)a.stairways[c]instanceof StairwayStructure||a.stairways.splice(c,1)}},b.prototype.onFloorAdded=function(a){var b=a.id,c=this.structure.getElement(+b),d=this.structure.getElement(+b-1),e=a.callback||function(){};if(d)for(var f=d.getElements("stairways"),g=0;g<f.length;g++){var h=new HopperStructure;h.points=f[g].getHopperPoints(),h.stairwayId=f[g].id,c.insertElement("hoppers",h)}e.call(this)},b.prototype.onLeave=function(){this.core.engine2D.unregisterEventCb("StairwayComponent2D.stair-hover.dynamic-draw"),this.core.engine2D.unregisterEventCb("StairwayComponent2D.stair.drag-start"),this.core.engine2D.requestDynamicDraw()},b.prototype.onHoverStair=function(a,b,c,d){a.strokeStyle=this.core.engine2D.symbols2D.COLOR_ACTIVE_STROKE_DARKER,this.draw(d,a,b,c),this.drawTarget(d,a,b,c)},b.prototype.onHoverStairMouseMove=function(a,b,c){var d=b.isTargeted(c.planPos);b.targeted=d,this.core.engine2D.requestDynamicDraw()},b.prototype.onHover=function(a,b){return(this.core.engine2D.getMode()&(this.core.engine2D.MODE_DRAW|this.core.engine2D.MODE_SUBSLOPE))>0?!1:(this.core.engine2D.registerEventCb("StairwayComponent2D.stair-hover.mouse-move",this.priority,"mouse-move",null,StairwayStructure,this.onHoverStairMouseMove.bind(this),b),this.core.engine2D.registerEventCb("StairwayComponent2D.stair-hover.dynamic-draw",this.priority,"dynamic-draw",null,StairwayStructure,this.onHoverStair.bind(this),b),this.core.engine2D.registerEventCb("StairwayComponent2D.stair.drag-start",this.priority,"drag-start",this.core.engine2D.MODE_NORMAL,StairwayStructure,this.onDragStart.bind(this),{}),this.core.engine2D.requestDynamicDraw(),!1)},b.prototype.onDragEnd=function(a,b,c,d){this._targetedAtPoint=!1,this._targetedAt=!1;for(var e=0;e<d.points.length-1;e++)"spiral"!=d.type&&d.points[e].distanceTo(d.points[e+1])<d.width/2&&(d.points.splice(e+1,d.points.length),this.core.engine2D.requestStaticDraw(),this.core.engine2D.requestDynamicDraw());var f=this.core.getSelectedStructure();if(topStructure=this.structure.getElement(+f.id+1)){var g=null;if(g=topStructure.getElementByIdentifier(d.id,"hoppers","stairwayId"))0==g.modified&&(g.points=d.getHopperPoints());else{var g=new HopperStructure;g.points=d.getHopperPoints(),g.stairwayId=d.id,topStructure.insertElement("hoppers",g)}}},b.prototype.onDrawDragging=function(a,b,c,d){return this.onMouseMove(a,b,c,d),!1},b.prototype.onDrawDragStart=function(a,b,c,d){0==this._tmpStairway.points.length&&this.onAddStairwayClick(a,b,c,d),this.core.engine2D.registerEventCb("StairwayComponent2D.stair-draw.drag",this.priority,"dragging",null,null,this.onDrawDragging.bind(this),b),this.core.engine2D.registerEventCb("StairwayComponent2D.stair-draw.drag-end",this.priority,"drag-end",null,null,this.onAddStairwayClick.bind(this),b)},b.prototype.onDragStart=function(a,b){this.core.engine2D.registerEventCb("StairwayComponent2D.stair-hover.drag",this.priority,"dragging",null,null,this.onDragStair.bind(this),b),this.core.engine2D.registerEventCb("StairwayComponent2D.stair-hover.drag-end",this.priority,"drag-end",null,null,this.onDragEnd.bind(this),b)},b.prototype.onDragStairSpiral=function(a,b,c,d){var e=c.posDelta.clone().scaleInPlace(1/this.core.engine2D.getZoom());if(d.targeted.point>0){var f=c.planPos.clone(),g=d.points[0],h=g.clone().add(new BABYLON.Vector3(d.width,0,0)),i=g.clone().add(new BABYLON.Vector3(-d.width,0,0)),j=g.clone().add(new BABYLON.Vector3(0,d.width,0)),k=g.clone().add(new BABYLON.Vector3(0,-d.width,0)),l=g.clone().add(f.clone().subtractInPlace(g).normalize().scaleInPlace(d.width));d.points[d.targeted.point]=l.distanceTo(h)<20?h:l.distanceTo(i)<20?i:l.distanceTo(j)<20?j:l.distanceTo(k)<20?k:l}else for(var m=0;m<d.points.length;m++)d.points[m].addInPlace(e);return this.core.engine2D.requestStaticDraw(),!1},b.prototype.onDragStair=function(a,b,c,d){if("spiral"==d.type)return this.onDragStairSpiral(a,b,c,d),!1;var e=d.targeted.step,f=d.points[e],g=d.points[e+1],h=c.posDelta.clone().scaleInPlace(1/this.core.engine2D.getZoom());if(this.core.getComponentByName("RoomComponent2D"),d.targeted.point!==!1&&-1===[0,d.points.length-1].indexOf(+d.targeted.point))for(var i=0;i<d.points.length;i++)d.points[i].addInPlace(h);else if(d.targeted.point!==!1&&-1!==[0,d.points.length-1].indexOf(+d.targeted.point))d.points[d.targeted.point].addInPlace(h);else if(e!==!1)if(d.points.length>2){var j=new BABYLON.Vector3(f.y-g.y,g.x-f.x,0).normalize();h.projectOnVector(j),f.addInPlace(h),g.addInPlace(h)}else for(var i=0;i<d.points.length;i++)d.points[i].addInPlace(h);return this.core.engine2D.requestStaticDraw(),!1},b.prototype.getTargeted=function(a){for(var b=this.core.getSelectedStructure(),c=b.getElements("stairways"),d=0;d<c.length;d++){var e=c[d];if(!(this.core.engine2D.getMode()&this.core.engine2D.MODE_DRAG)&&e.isTargeted(a))return e}return null},b.prototype.initialize=function(){_item={title:_("楼梯"),id:"stairways",items:[{title:_("一般式楼梯"),action:"hcs.engine2d.onAddStairway",params:{stairwayType:"straight",bearing:!1}},{title:_("楼梯平台"),action:"hcs.engine2d.onAddStairway",params:{stairwayType:"straight",bearing:!0}},{title:_("悬式楼梯"),action:"hcs.engine2d.onAddStairway",params:{stairwayType:"straight",bearing:!1,have_contremarche:!1,limon:0,rail_a:!1,rail_b:0,stair_offset:0}},{title:_("螺旋梯"),action:"hcs.engine2d.onAddStairway",params:{stairwayType:"spiral"}}]},ujs.notify("hcs.menu.main.add",{item:_item,menuPath:"draw2D",position:5})},b.prototype.onAddStairway=function(a){this._tmpStairway="spiral"==a.stairwayType?new SpiralStairwayStructure:new StraightStairwayStructure,this._tmpStairway.height=this.core.getSelectedStructure().height;for(var b in this._tmpStairway)this._tmpStairway.hasOwnProperty(b)&&"undefined"!=typeof a[b]&&"type"!=b&&(this._tmpStairway[b]=a[b]);this._tmpPoint=null,this.core.helpBubbleManager.display("hcs.2d.draw-staires"),this.core.engine2D.setMode(hcsdesign.engine2D.MODE_DRAW),this.core.engine2D.registerEventCb("StairwayComponent2D.add-stair.click",this.priority,"click",this.core.engine2D.MODE_DRAW,null,this.onAddStairwayClick.bind(this),{}),this.core.engine2D.registerEventCb("StairwayComponent2D.dynamic-stair.mouse-move",this.priority,"mouse-move",this.core.engine2D.MODE_DRAW,null,this.onMouseMove.bind(this),{}),this.core.engine2D.registerEventCb("StairwayComponent2D.dynamic-stair.dynamic-draw",this.priority,"dynamic-draw",this.core.engine2D.MODE_DRAW,null,this.onDynamicDraw.bind(this),{}),this.core.engine2D.registerEventCb("StairwayComponent2D.stair.drag-start-draw",this.priority,"drag-start",this.core.engine2D.MODE_DRAW,null,this.onDrawDragStart.bind(this),{})},b.prototype.onDoubleClick=function(a,b){b.targeted&&b.targeted.point==b.points.length-1&&(this.onAddStairway({}),this._tmpStairway=b,this.core.engine2D.setMode(this.core.engine2D.MODE_DRAW))},b.prototype.finalizeTmpStairway=function(){var a=this.core.getSelectedStructure();if(this._tmpStairway.isValid()){a.insertElement("stairways",this._tmpStairway);var b=!1;if(b=this.structure.getElement(+a.id+1)){var c=new HopperStructure;c.points=this._tmpStairway.getHopperPoints(),c.stairwayId=this._tmpStairway.id,b.insertElement("hoppers",c)}}this._tmpStairway=new StairwayStructure,this._tmpPoint=null,this.core.engine2D.requestStaticDraw(),this.core.engine2D.setMode(this.core.engine2D.MODE_NORMAL),ujs.notify("hcs.menu.main.deselect")},b.prototype.onAddStairwayClick=function(a,b,c,d){if("touchUp"==a.type&&this.onDrawDragging(a,b,c,d),0==this._tmpStairway.points.length||this._tmpPoint){if(this._tmpPoint=this._tmpPoint||c.planPos,this._tmpPoint=this._tmpPoint||c.planPos,this._tmpStairway.points.push(this._tmpPoint.clone()),1==this._tmpStairway.points.length){var e=this.core.getComponentByName("RoomComponent2D");this._tmpStairway.room=e.isPointInRooms(this._tmpPoint)}"spiral"==this._tmpStairway.type&&(this._tmpStairway.computeSpiralPoints(),this.finalizeTmpStairway()),this._tmpPoint=!1}else this.finalizeTmpStairway()},b.prototype.onMouseMove=function(a,b,c){if(0!=!this._tmpStairway.points.length||this._tmpPoint||this.core.engine2D.setCursorIcon(this.core.engine2D.symbols2D.drawCursorCheck.bind(this.core.engine2D.symbols2D)),this._tmpStairway.points.length<2)this._tmpPoint=c.planPos.clone();else{var d=this._tmpStairway.points;if(d[d.length-1].distanceTo(c.planPos)<this._tmpStairway.width/2)return void(this._tmpPoint=null);var e=new BABYLON.Ray(d[d.length-1],this._tmpStairway.getNormalAtPoint(d.length-1)),f=e.closestPointToPoint(c.planPos);this._tmpPoint=f.distanceTo(c.planPos)>20?c.planPos.clone():f}},b.prototype._getMagneticRays=function(a,b){var c=[];if(b.room){for(var d=0;d<b.room.points.length-1;d++){var e=b.room.points[d],f=b.room.points[d+1];c.push(new BABYLON.Ray(a,e.clone().subtractInPlace(f.clone()).normalize()))}var e=b.room.points[d],f=b.room.points[0];c.push(new BABYLON.Ray(a,e.clone().subtractInPlace(f.clone()).normalize()))}else c.push(new BABYLON.Ray(a,new BABYLON.Vector3(0,1,0))),c.push(new BABYLON.Ray(a,new BABYLON.Vector3(1,0,0)));return c},b.prototype.onStaticDraw=function(a,b,c){for(var d=this.core.getSelectedStructure(),e=d.getElements("stairways"),f=0;f<e.length;f++)this.draw(e[f],a,b,c);var g=!1;if(g=this.structure.getElement(+d.id-1))for(var h=g.getElements("stairways"),f=0;f<h.length;f++)a.save(),a.strokeStyle="#eeeeee",this.draw(h[f],a,b,c),a.restore()},b.prototype.onDynamicDraw=function(a,b,c){this.draw(this._tmpStairway,a,b,c,this._tmpPoint),a.save(),a.fillStyle="rgba(60,82,129,0.8)";var d=this._tmpStairway;if(1==d.points.length){var e=this.core.engine2D.toRealCoord(d.points[0],b,c);if(this._tmpPoint){var f=Math.atan2(this._tmpPoint.y-d.points[0].y,this._tmpPoint.x-d.points[0].x);this.core.engine2D.symbols2D.drawGrip(a,e,[!1,!0,!1,!1],f)}else this.core.engine2D.symbols2D.drawGrip(a,e,[!0,!0,!0,!0])}else if(d.points.length>1){var g=d.points[d.points.length-1],h=d.points[d.points.length-2],f=Math.atan2(g.y-h.y,g.x-h.x),e=this.core.engine2D.toRealCoord(g,b,c);this.core.engine2D.symbols2D.drawCheckGrip(a,e,[!0,!1,!0,!1],f)}a.restore()},b.prototype.onContextMenu=function(a,b){var c=[];c.push({name:"width",label:_("Width"),type:"slider",cast:"int",unit:"cm",value:{min:40,max:300,step:1,value:b.width}}),c.push({name:"height",label:_("Height"),type:"slider",cast:"int",unit:"cm",value:{min:20,max:500,step:1,value:b.height}}),c.push({name:"elevation",label:_("Elevation"),type:"slider",cast:"int",unit:"cm",value:{min:0,max:250,step:1,value:b.elevation}}),c.push({name:"stair_offset",label:_("Stair Offset"),type:"slider",cast:"int",unit:"cm",value:{min:0,max:10,step:1,value:b.stair_offset}}),c.push({name:"stair_thickness",label:_("Stair thickness"),type:"slider",cast:"int",unit:"cm",value:{min:0,max:50,step:1,value:b.stair_thickness}}),c.push({name:"have_contremarche",label:_("riser"),type:"checkbox",value:b.have_contremarche}),"straight"==b.type?(c.push({name:"bearing",label:_("bearing"),type:"checkbox",value:b.bearing}),c.push({name:"rail_a",label:_("Right guard-rail"),type:"checkbox",value:b.rail_a}),c.push({name:"rail_b",label:_("Left guard-rail"),type:"checkbox",value:b.rail_b}),c.push({name:"limon",label:_("Limon (-1 => default)"),type:"text",value:b.limon})):"spiral"==b.type&&(c.push({name:"rail_a",label:_("Guard-rail"),type:"checkbox",value:b.rail_a}),c.push({name:"diameter",label:_("Core diameter"),type:"slider",cast:"int",unit:"cm",value:{min:1,max:40,step:1,value:b.diameter}}),c.push({name:"orientation",label:_("Orientation (clockwise)"),type:"checkbox",value:b.orientation})),this.core.engine2D.displayContextMenu(c,b,this.onContextMenuPropertyChanged.bind(this),this.onContextMenuRemove.bind(this))},b.prototype.onContextMenuPropertyChanged=function(a,b,c){a[b]=c,this.core.engine2D.requestStaticDraw()},b.prototype.onContextMenuRemove=function(a){var b=this.core.getSelectedStructure();if(topStructure=this.structure.getElement(+b.id+1)){var c=topStructure.getElementByIdentifier(a.id,"hoppers","stairwayId");c&&c.remove(topStructure)}a.remove(b)},b.prototype.draw=function(a,b,c,d,e){b.save(),b.translate(c.x,c.y),b.scale(d,d),a.draw(b,e),b.restore()},b.prototype.drawTargetSpiral=function(a,b){if(a.targeted&&a.targeted.point>0)this.core.engine2D.symbols2D.drawPointHover(b,this.core.engine2D.toRealCoord(a.points[a.targeted.point]));else{var c=this.core.engine2D.toRealCoord(a.points[0]);c.x=Math.round(c.x)+.5,c.y=Math.round(c.y)+.5,this.core.engine2D.symbols2D.drawGrip(b,c,[!0,!0,!0,!0]);for(var d=1;d<a.points.length;d++)this.core.engine2D.symbols2D.drawPoint(b,this.core.engine2D.toRealCoord(a.points[d]))}},b.prototype.drawTarget=function(a,b,c,d){if(a){if("spiral"==a.type)return void this.drawTargetSpiral(a,b,c,d);if(a.targeted&&a.targeted.point!==!1){var e=this.core.engine2D.toRealCoord(a.points[a.targeted.point]);this.core.engine2D.symbols2D.drawGrip(b,e,[!0,!0,!0,!0])}else if(a.targeted&&a.targeted.step!==!1){var e=this.core.engine2D.toRealCoord(a.points[a.targeted.step]),f=this.core.engine2D.toRealCoord(a.points[a.targeted.step+1]);Math.atan2(f.y-e.y,f.x-e.x),this.core.engine2D.symbols2D.drawSegment(b,e,f)}}},b}();var StairwayComponent3D=function(){function a(a){a.traverse(function(a){hcsdesign.engine3D.castShadows(a),a.receiveShadows=!0})}var b,c=function(a){BaseComponent3D.call(this,a,"StairwayComponent3D"),this._scenes=[],this.priority=1,b=this};return c.prototype=new BaseComponent3D,c.prototype.compute=function(){},c.prototype.startListening=function(){document.addEventListener("hcs.engine3d.floorReady",this.onFloorReady,!1)},c.prototype.stopListening=function(){document.removeEventListener("hcs.engine3d.floorReady",this.onFloorReady,!1)},c.prototype.onFloorReady=function(a){for(var c=a.floor||b.getFloor(),d=a.structure||b.core.getSelectedStructure(),e=0;e<d.stairways.length;e++)b.createStairway(d.stairways[e],c,hcsdesign.engine3D.scene)},c.prototype.createScene=function(){for(var a=this.core.getComponentByName("FloorComponent3D"),b=0;b<this.structure.getLength();b++){var c=this.structure.getElement(b);if(c instanceof FloorStructure)for(var d=a.getFloor(c),e=0;e<c.stairways.length;e++)this.createStairway(c.stairways[e],d,hcsdesign.engine3D.scene)}},c.prototype.initMaterials=function(a,b){for(var c in b)a.traverse(function(a){a.name===c&&(a.material=b[c])})},c.prototype.createStairway=function(b,c,d){var e=(this.core.getComponentByName("ObjectComponent3D",this.core.ENGINE_3D),function(e){var f=e.getObject3D(d);a(f),f.structure=b,f.structure.programmableInstance=e,f.name="Stairway_"+b.id,f.isDecorable=!0,f.decorate=e.decorate,f.parent=c;var g=e.materials;e.getDefaultMaterials&&(g=ujs.mergeObjects(e.getDefaultMaterials(hcsdesign.engine3D.scene),g)),this.initMaterials(f,g),b.materials=g,e.materials=g}.bind(this)),f=b.programmableInstance?b.programmableInstance.materials:b.materials;return"spiral"==b.type?hcs.Programmable.createInstance("Stairs.Spiral.js",b,f,b,e):hcs.Programmable.createInstance("Stairs.js",b,f,b,e),!0},c}();HopperStructure=function(){var a=function(a){BaseStructure.call(this,"HopperStructure"),this.points=a||[new BABYLON.Vector2(0,0),new BABYLON.Vector2(100,0),new BABYLON.Vector2(100,100),new BABYLON.Vector2(0,100)],this.materials={},this.sticks={},this.stairwayId=null,this.modified=!1};return a.prototype=new BaseStructure,a.prototype.serialize=function(){var a={"class":{name:"HopperStructure"}};return ujs.serializeObject(this,a,["points","materials","sticks","stairwayId"]),a},a.Deserialize=function(b){var c=new a;return ujs.deserializeObject(b,c,["points","materials","sticks","stairwayId"]),c.isValid()?c:null},a.prototype.isValid=function(){if(this.points.length<2)return Logger.warning("Invalid Hopper"),!1;for(var a,b=0,c=this.points.length;c>b;b++)if(a=this.points[b].distanceTo(this.points[(b+1)%c]),1/0==a||isNaN(a)||0===a)return Logger.warning("Invalid Hopper"),!1;return!0},a.prototype.remove=function(a){a.removeElement("hoppers",this)},a.prototype.insertPointAt=function(a,b){this.points.splice(a,0,b)},a.prototype.move=function(a){for(var b=0;b<this.points.length;b++)this.points[b].addInPlace(a)},a}(),HopperComponent2D=function(){var a=null,b=function(b){BaseComponent2D.call(this,b,"HopperComponent2D"),this.priority=80,this._tmpHopper=new HopperStructure,this._targetedAt=null,this._targetedAtSide=null,a=this};return b.prototype=new BaseComponent2D,b.prototype.startListening=function(){this.onAddHopper=this.onAddHopper.bind(this),document.addEventListener("hcs.engine2d.onAddHopper",this.onAddHopper,!1),hcsdesign.engine2D.registerEventCb("HopperComponent2D.hopper.static-draw",this.priority,"static-draw",null,null,this.onStaticDraw.bind(this),{}),hcsdesign.engine2D.registerEventCb("HopperComponent2D.hopper.hover",this.priority,"hover",hcsdesign.engine2D.MODE_NORMAL|hcsdesign.engine2D.MODE_DRAG|hcsdesign.engine2D.MODE_CONTEXTMENU,HopperStructure,this.onHover.bind(this),{}),hcsdesign.engine2D.registerEventCb("HopperComponent2D.hopper.leave",this.priority,"leave",hcsdesign.engine2D.MODE_NORMAL|hcsdesign.engine2D.MODE_CONTEXTMENU,HopperStructure,this.onLeave.bind(this),{}),hcsdesign.engine2D.registerEventCb("HopperComponent2D.hopper.click",this.priority,"click",hcsdesign.engine2D.MODE_NORMAL,HopperStructure,this.onContextMenu.bind(this),{}),hcsdesign.engine2D.registerEventCb("HopperComponent2D.hopper.dblclick",this.priority,"double-click",hcsdesign.engine2D.MODE_NORMAL,HopperStructure,this.onDblClick.bind(this),{})},b.prototype.stopListening=function(){document.removeEventListener("hcs.engine2d.onAddHopper",this.onAddHopper,!1),hcsdesign.engine2D.unregisterEventCb("HopperComponent2D.hopper.static-draw"),hcsdesign.engine2D.unregisterEventCb("HopperComponent2D.hopper.hover"),hcsdesign.engine2D.unregisterEventCb("HopperComponent2D.hopper.leave"),hcsdesign.engine2D.unregisterEventCb("HopperComponent2D.hopper.click"),hcsdesign.engine2D.unregisterEventCb("HopperComponent2D.hopper.dblclick")},b.prototype.getTargeted=function(a){for(var b=hcsdesign.getSelectedStructure(),c=b.getElements("hoppers"),d=(hcsdesign.engine2D.getZoom(),0);d<c.length;d++){if(!(hcsdesign.engine2D.getMode()&hcsdesign.engine2D.MODE_DRAG))for(var e=0;e<c[d].points.length;e++){if(c[d].points[e].distanceTo(a)<13)return this._targetedAt=e,this._targetedAtSide=null,hcsdesign.engine2D.requestDynamicDraw(),c[d];var f=this.isPointInHopperSide(a,c[d]);if(f!==!1)return this._targetedAtSide=f,this._targetedAt=null,hcsdesign.engine2D.requestDynamicDraw(),c[d]}if(this.isPointInHopper(a,c[d]))return hcsdesign.engine2D.getMode()&hcsdesign.engine2D.MODE_DRAG||(this._targetedAt=null,this._targetedAtSide=null,hcsdesign.engine2D.requestDynamicDraw()),c[d]}},b.prototype.onLeave=function(){hcsdesign.engine2D.unregisterEventCb("HopperComponent2D.hopper-hover.dynamic-draw"),hcsdesign.engine2D.unregisterEventCb("HopperComponent2D.hopper.drag-start"),hcsdesign.engine2D.requestDynamicDraw()},b.prototype.onHover=function(a,b){return hcsdesign.engine2D.registerEventCb("HopperComponent2D.hopper-hover.dynamic-draw",this.priority,"dynamic-draw",null,HopperStructure,this.onHoverHopper.bind(this),b),hcsdesign.engine2D.registerEventCb("HopperComponent2D.hopper.drag-start",this.priority,"drag-start",hcsdesign.engine2D.MODE_NORMAL,HopperStructure,this.onDragStart.bind(this),{}),hcsdesign.engine2D.requestDynamicDraw(),!1},b.prototype.onHoverHopper=function(a,b,c,d){this.draw(d,a,b,c,!0),this.drawTarget(d,a,c)},b.prototype.onDblClick=function(a,b,c){if(b instanceof HopperStructure){var d=this.isPointInHopperSide(c.planPos,b);if(d!==!1){var e=b.points[d],f=d+1<b.points.length?b.points[d+1]:b.points[0],g=c.planPos.projectOnSegment(e,f);b.insertPointAt(d+1,g),this._targetedAtSide=null,this._targetedAt=d+1,hcsdesign.engine2D.requestDynamicDraw()}}},b.prototype.onDrag=function(a,b,c,d){if(null!==this._targetedAt){for(var e=c.planPos.clone(),f=0;f<d.points.length;f++)f!=this._targetedAt&&(Math.abs(e.x-d.points[f].x)<10&&(e.x=d.points[f].x),Math.abs(e.y-d.points[f].y)<10&&(e.y=d.points[f].y));this.getRoom(d).isPointIn(e)&&(d.points[this._targetedAt]=e)}else if(null!==this._targetedAtSide){var g=c.posDelta.scale(1/hcsdesign.engine2D.getZoom()),h=d.points[this._targetedAtSide],i=this._targetedAtSide+1<d.points.length?this._targetedAtSide+1:0,j=d.points[i],k=new BABYLON.Vector2(h.y-j.y,j.x-h.x);g.projectOnVector(k),this.getRoom(d).isPointIn(d.points[this._targetedAtSide].add(g))&&this.getRoom(d).isPointIn(d.points[i].add(g))&&(d.points[this._targetedAtSide].addInPlace(g),d.points[i].addInPlace(g))}else{var g=c.posDelta.scale(1/hcsdesign.engine2D.getZoom());d.move(g)}return d.modified=!0,hcsdesign.engine2D.requestStaticDraw(),!1},b.prototype.compute=function(){for(var a=hcsdesign.getSelectedStructure(),b=0;b<a.getElements("hoppers").length;b++)this.computeHopper(a.getElements("hoppers")[b])},b.prototype.computeHopper=function(a){for(var b=a.points.length-1;b>=0;b--){var c=b-1>=0?b-1:a.points.length-1;a.points[b].distanceTo(a.points[c])<2&&a.points.splice(b,1)}a.points.length<3&&(a.remove(hcsdesign.getSelectedStructure()),hcsdesign.engine2D.requestStaticDraw(),hcsdesign.engine2D.requestDynamicDraw(),this._targetedAt=null,this._targetedAtSide=null)},b.prototype.onDragEnd=function(a,b,c,d){this.computeHopper(d)},b.prototype.onDragStart=function(a,b){this.getRoom(b,!0),hcsdesign.engine2D.registerEventCb("hopperComponent2D.hopper.drag",this.priority,"dragging",null,null,this.onDrag.bind(this),b),hcsdesign.engine2D.registerEventCb("hopperComponent2D.stair-hover.drag-end",this.priority,"drag-end",null,null,this.onDragEnd.bind(this),b)},b.prototype.onAddHopper=function(){hcsdesign.engine2D.setMode(hcsdesign.engine2D.MODE_DRAW),hcsdesign.engine2D.registerEventCb("hopperComponent2D.add-hopper.click",this.priority,"click",hcsdesign.engine2D.MODE_DRAW,null,this.onAddHopperClick.bind(this),{}),hcsdesign.engine2D.registerEventCb("hopperComponent2D.dynamic-stair.mouse-move",this.priority,"mouse-move",hcsdesign.engine2D.MODE_DRAW,null,this.onMouseMove.bind(this),{}),hcsdesign.engine2D.registerEventCb("hopperComponent2D.dynamic-stair.dynamic-draw",this.priority,"dynamic-draw",hcsdesign.engine2D.MODE_DRAW,null,this.onDynamicDraw.bind(this),{})},b.prototype.onAddHopperClick=function(){var a=hcsdesign.getSelectedStructure();a.insertElement("hoppers",this._tmpHopper),this._tmpHopper=new HopperStructure,hcsdesign.engine2D.requestStaticDraw(),hcsdesign.engine2D.setMode(hcsdesign.engine2D.MODE_NORMAL),ujs.notify("hcs.menu.main.deselect")},b.prototype.onMouseMove=function(a,b,c){var d=c.planPos.subtract(this._tmpHopper.points[0].clone());d.x-=50,d.y-=50,this._tmpHopper.move(d)},b.prototype.onContextMenu=function(a,b){var c=[];null!==this._targetedAtSide?(c.push({name:"sticks_"+this._targetedAtSide,label:_("Enable the guard-rail on this side"),type:"checkbox",cast:"int",value:b.sticks[this._targetedAtSide]}),c.push({name:"cut",label:_("Add point"),type:"button",value:_("Add")})):(c.push({name:"enable_sticks",label:_("四周有护栏"),type:"button",value:_("选择")}),c.push({name:"disable_sticks",label:_("四周没有护栏"),type:"button",value:_("选择")})),hcsdesign.engine2D.displayContextMenu(c,b,this.onContextMenuPropertyChanged.bind(this),this.onContextMenuRemove.bind(this))},b.prototype.onContextMenuPropertyChanged=function(a,b,c){if(-1!=b.indexOf("sticks_")){var d=b.split("_");a.sticks[d[1]]=c}else if("cut"==b){var e=a.points[this._targetedAtSide],f=a.points[this._targetedAtSide+1],g=e.clone().lerp(f,.5);a.insertPointAt(this._targetedAtSide+1,g)}else if("enable_sticks"==b)for(var h=0;h<a.points.length;h++)a.sticks[h]=!0;else if("disable_sticks"==b)for(var h=0;h<a.points.length;h++)a.sticks[h]=!1;else a[b]=c;hcsdesign.engine2D.requestStaticDraw()},b.prototype.onContextMenuRemove=function(a){var b=hcsdesign.getSelectedStructure();a.remove(b)},b.prototype.onStaticDraw=function(a,b,c){for(var d=hcsdesign.getSelectedStructure(),e=d.getElements("hoppers"),f=0;f<e.length;f++)this.draw(e[f],a,b,c)},b.prototype.onDynamicDraw=function(a,b,c){hcsdesign.engine2D.setCursorIcon(hcsdesign.engine2D.symbols2D.drawCursorCheck.bind(hcsdesign.engine2D.symbols2D)),this.draw(this._tmpHopper,a,b,c)},b.prototype.initialize=function(){var a={title:_("储料仓"),index:80,action:"hcs.engine2d.onAddHopper"};ujs.notify("hcs.menu.main.add",{item:a,menuPath:"draw2D",position:80})},b.prototype.drawTarget=function(a,b,c){if(null!==this._targetedAt){var d=hcsdesign.engine2D.toRealCoord(a.points[this._targetedAt]);hcsdesign.engine2D.symbols2D.drawPointHover(b,d,c)}else if(null!==this._targetedAtSide){var e=hcsdesign.engine2D.toRealCoord(a.points[this._targetedAtSide]),f=hcsdesign.engine2D.toRealCoord(this._targetedAtSide+1<a.points.length?a.points[this._targetedAtSide+1]:a.points[0]);hcsdesign.engine2D.symbols2D.drawSegment(b,e,f)}},b.prototype.draw=function(a,b,c,d,e){b.save(),b.beginPath(),e?(b.fillStyle=hcsdesign.engine2D.symbols2D.COLOR_ACTIVE_FILL,b.strokeStyle=hcsdesign.engine2D.symbols2D.COLOR_ACTIVE_STROKE_DARKER):(b.fillStyle=hcsdesign.engine2D.symbols2D.COLOR_INACTIVE_FILL,b.strokeStyle=hcsdesign.engine2D.symbols2D.COLOR_INACTIVE_STROKE);for(var f=0;f<a.points.length;f++){var g=hcsdesign.engine2D.toRealCoord(a.points[f],c,d);0==f?b.moveTo(Math.round(g.x)+.5,Math.round(g.y)+.5):b.lineTo(Math.round(g.x)+.5,Math.round(g.y)+.5)}b.closePath(),b.fill(),b.stroke(),b.beginPath();for(var f=0;f<a.points.length;f++)if(a.sticks[f]){var h=hcsdesign.engine2D.toRealCoord(a.points[f],c,d),i=f+1<a.points.length?f+1:0,j=hcsdesign.engine2D.toRealCoord(a.points[i],c,d);b.lineWidth=4,b.beginPath(),b.moveTo(Math.round(h.x),Math.round(h.y)),b.lineTo(Math.round(j.x),Math.round(j.y)),b.stroke()}b.restore()},b.prototype.getRoom=function(a,b){var b=b||!1;if(a.room&&b===!1)return a.room;var c=hcsdesign.getComponentByName("RoomComponent2D"),d=c.isPointInRooms(a.points[0]);return d!==!1?(a.room=d,a.room):!1},b.prototype.isPointInHopperSide=function(a,b){for(var c=0;c<b.points.length;c++){var d=b.points[c].clone(),e=c+1<b.points.length?b.points[c+1]:b.points[0],f=Math.abs(d.distanceTo(a)+e.distanceTo(a)-d.distanceTo(e));if(1>f)return c}return!1},b.prototype.isPointInHopper=function(a,b){return a.isPointInPolygon(b.points)?!0:!1},b}();var HopperComponent3D=function(){var a,b=function(b){BaseComponent3D.call(this,b,"HopperComponent3D"),a=this;var c=hcsdesign.getComponentByName("RoomComponent3D");this._commonHopperMaterial=c.getSideMaterial()};return b.prototype=new BaseComponent3D,b.prototype.startListening=function(){document.addEventListener("hcs.engine3d.floorReady",this.onFloorReady,!1)},b.prototype.stopListening=function(){document.removeEventListener("hcs.engine3d.floorReady",this.onFloorReady,!1)},b.prototype.onFloorReady=function(b){for(var c=b.floor||a.getFloor(),d=b.structure||hcsdesign.getSelectedStructure(),e=0;e<d.hoppers.length;e++)a.createHopperSticks(d.hoppers[e],c)},b.prototype.decorate=function(a,b){var c=b.pickedMesh.material;return this.traverse(function(c){c.name===b.pickedMesh.name&&(c.material=a)}),this.structure.materials[b.pickedMesh.name]=a,c},b.prototype.createScene=function(){for(var a=this.core.getComponentByName("FloorComponent3D"),b=0;b<this.structure.getLength();b++){var c=this.structure.getElement(b);if(c instanceof FloorStructure)for(var d=a.getFloor(c),e=0;e<c.hoppers.length;e++)this.createHopperSticks(c.hoppers[e],d)}},b.prototype.mergeGeometries=function(a,b,c){var d=[],e=[],f=[];if(a.computeWorldMatrix(!0),a.traverse(function(a){a.computeWorldMatrix(!0),a.isVisible&&("rail_stick"==a.name?d.push(a):"rails"==a.name?e.push(a):"bas"==a.name&&f.push(a))}),d.length){var g=BABYLON.Mesh.mergeMeshes("rail_stick",d,c);g.parent=a}if(e.length){var h=BABYLON.Mesh.mergeMeshes("rails",e,c);h.parent=a}if(f.length){var i=BABYLON.Mesh.mergeMeshes("bas",f,c);i.parent=a}},b.prototype.createHopperSticks=function(a,b){if(Object.keys(a.sticks).length){var c=a.materials;c=ujs.mergeObjects(this.getDefaultMaterials(hcsdesign.engine3D.scene),c);var d=new BABYLON.Mesh("sticks",hcsdesign.engine3D.scene);d.isVisible=!1;for(var e in a.sticks){var f=a.sticks[e]?e:!1;if(f!==!1){var g=new BABYLON.Mesh("rails",hcsdesign.engine3D.scene);g.isVisible=!1;var h=a.points[+f],i=a.points[+f+1>=a.points.length?0:+f+1],j=h.clone().lerp(i.clone(),.5),k=Math.atan2(i.y-h.y,i.x-h.x),l=h.distanceTo(i),m=BABYLON.Mesh.CreateBloc("bas",l,10,5,hcsdesign.engine3D.scene);m.parent=g,m.position.y=5,m.name="bas",m.isDecorable=!0;var n=BABYLON.Mesh.CreateBloc("rails",l,3,5,hcsdesign.engine3D.scene);n.position.y=90,n.name="rails",n.isDecorable=!0,n.parent=g;var o=20,p=Math.round(l/o),o=l/p,q=new BABYLON.Mesh("stick",hcsdesign.engine3D.scene);q.isVisible=!1;for(var r=BABYLON.Mesh.CreateCylinder("rail_stick",90,2,2,6,1,!0,hcsdesign.engine3D.scene),s=0;p>s;s++){var t=r.clone();t.position.x=3+s*o,t.position.z=0,t.position.y=45,t.parent=q}r.dispose(),q=BABYLON.Mesh.mergeMeshesRec("rail_stick",[q],hcsdesign.engine3D.scene),q.position.x-=l/2,q.isDecorable=!0,q.parent=g,g.rotation.y=k,g.position.x=j.x,g.position.z=-j.y,g.parent=d}}this.mergeGeometries(d,c,hcsdesign.engine3D.scene),d.isDecorable=!0,d.decorate=this.decorate,d.structure=a,d.parent=b,this.initMaterials(d,c),a.materials=c}return!1},b.prototype.getDefaultMaterials=function(a){var b={};return b.rails=new hcs.WhiteMaterial("rails",a,{factor:.8}),b.rail_stick=new hcs.MetalMaterial("rail_stick",a,{brillance:.2}),b.bas=new hcs.WhiteMaterial("bas",a,{factor:.8}),b},b.prototype.prepareMaterials=function(a,b){var c=a||{};for(var d in b.materials)this.materialFactory.copyFromParams(c[d],b.materials[d]);return c},b.prototype.initMaterials=function(a,b){for(var c in b)a.traverse(function(a){a.name===c&&(a.material=b[c])})},b.Build=function(b,c,d,e){if(b&&0!==b.getTotalVertices()){var f=BABYLON.CSG.FromMesh(b),d=d||0,g=b.parent.structure.height<100?b.parent.structure.height-1:100,g=100>e?e+1:100,h=BABYLON.Mesh.ExtrudeNewMesh("hopper_temp",c.points,null,{amount:g},hcsdesign.engine3D.scene);if(!h)return b;h.position.y+=d,h.parent=b.parent,c.material=c.material||a._commonHopperMaterial,h.subMeshes[0].objectInstance=c;var i=BABYLON.CSG.FromMesh(h);f.subtractInPlace(i);var j=f.toMesh("room_global",b.material,hcsdesign.engine3D.scene,!0);return j.parent=b.parent,hcsdesign.getComponentByName("RoomComponent3D").replaceRoom(b,j),0!=d&&j.subMeshes.splice(j.subMeshes.length-1,1),j.isDecorable=!0,j.parent.roomMesh=j,h.dispose(),j}},b.Debug=function(){var a=BABYLON.Mesh.CreateSphere("sphere",1,40,hcsdesign.engine3D.scene),b=BABYLON.Mesh.CreateBox("box",40,hcsdesign.engine3D.scene);
a.position.y+=51,b.position.y+=25;var c=BABYLON.CSG.FromMesh(a),d=BABYLON.CSG.FromMesh(b),e=new BABYLON.MultiMaterial("multiMat",hcsdesign.engine3D.scene),f=new BABYLON.StandardMaterial("mat0",hcsdesign.engine3D.scene),g=new BABYLON.StandardMaterial("mat1",hcsdesign.engine3D.scene);f.diffuseColor.copyFromFloats(.8,.2,.2),f.backFaceCulling=!1,g.diffuseColor.copyFromFloats(.2,.8,.2),g.backFaceCulling=!1,e.subMaterials.push(f,g);var h=d.subtract(c),i=h.toMesh("csg",e,hcsdesign.engine3D.scene,!0);i.position=new BABYLON.Vector3(-100,0,0),h=c.subtract(d),i=h.toMesh("csg2",e,hcsdesign.engine3D.scene,!0),i.position=new BABYLON.Vector3(100,0,0),h=c.intersect(d),i=h.toMesh("csg3",e,hcsdesign.engine3D.scene,!0),i.position=new BABYLON.Vector3(0,0,100)},b}(),GeneralOptionComponent2D=function(){var a=function(a){BaseComponent2D.call(this,a,"GeneralOptionComponent2D")};return a.prototype=Object.create(BaseComponent2D.prototype),a.prototype.initialize=function(){this.priority=0,this.startListening(),this.gridComp=hcsdesign.getComponentByName("GridComponent2D"),this.roomComp=hcsdesign.getComponentByName("RoomComponent2D"),this.wallComp=hcsdesign.getComponentByName("WallComponent2D")},a.prototype.startListening=function(){this.stopListening(),document.addEventListener("hcs.engine2D.contextMenu.generalOption.propertyChange",this.myBind.onPropertyChange,!1),document.addEventListener("hcs.request.2Doptions",this.myBind.onRequestPanel,!1),document.addEventListener("hcs.contextChanged",this.myBind.onContextChange,!1),this._listening=!0,this._injectMenu()},a.prototype.stopListening=function(){this.initBindForThisInstance(),document.removeEventListener("hcs.engine2D.contextMenu.generalOption.propertyChange",this.myBind.onPropertyChange,!1),document.removeEventListener("hcs.request.2Doptions",this.myBind.onRequestPanel,!1),document.removeEventListener("hcs.contextChanged",this.myBind.onContextChange,!1),this._listening=!1,this._removeMenu()},a.prototype.initBindForThisInstance=function(){if(this.myBind)return this;var a=this;this.myBind={};for(var b in this.handlers)(function(){var c=a.handlers[b];a.myBind[b]=function(b){c.call(a,b)}})();return this},a.prototype.openGeneralOptionPanel=function(){var a=hcsdesign.engine2D;a.setMode(a.MODE_CONTEXTMENU),hcs.UI.ContextMenu.show({title:_("General Settings")},[{title:"Tab 1",content:this._getPanelParam()}],[{label:_("Ok"),action:"hcs.engine2D.contextMenu.close"}],0)},a.prototype._getPanelParam=function(){var a=[];return this.gridComp&&a.push({label:_("display grid"),type:"checkbox",value:this.gridComp.displayGrid,eventParams:{cast:"boolean",property:"displayGrid",eventName:"hcs.engine2D.contextMenu.generalOption.propertyChange"}}),this.roomComp&&a.push({label:_("display room name"),type:"checkbox",value:this.roomComp.displayRoomName,eventParams:{cast:"boolean",property:"displayRoomName",eventName:"hcs.engine2D.contextMenu.generalOption.propertyChange"}}),this.wallComp&&a.push({label:_("display mesure"),type:"checkbox",value:this.wallComp.displayMesure,eventParams:{cast:"boolean",property:"displayMesure",eventName:"hcs.engine2D.contextMenu.generalOption.propertyChange"}}),a},a.prototype._injectMenu=function(){hcsdesign.getComponentByName("TopMenuComponent")&&hcsdesign.getComponentByName("TopMenuComponent").menu.json.length&&(this._removeMenu(),setTimeout(function(){ujs.notify("hcs.menu.top.add",{item:{id:"2D-options",title:_("2D options"),action:"hcs.request.2Doptions",index:2},menuPath:"toolbarOption"})},0))},a.prototype._removeMenu=function(){ujs.notify("hcs.menu.top.delete",{id:"2D-options"})},a.prototype.handlers={onRequestPanel:function(){ujs.notify("hcs.menu.top.deselect"),this.openGeneralOptionPanel()},onPropertyChange:function(a){var b=a.property,c=a.value;switch(b){case"displayMesure":this.wallComp&&(this.wallComp.displayMesure=c);break;case"displayRoomName":this.roomComp&&(this.roomComp.displayRoomName=c);break;case"displayGrid":this.gridComp&&(this.gridComp.displayGrid=c)}hcsdesign.engine2D.requestStaticDraw()}},a}();ObjectStructure=function(){var a=0,b=function(b,c){BaseStructure.call(this,"Object_"+a++),Logger.warning("TODO : retravailler constructeur de objectStructure");var c=c||{};this.objectId=b||0,this.position=c.position||new BABYLON.Vector3(0,0,0),this.rotation=c.rotation||new BABYLON.Vector3(0,0,0),this.scaling=c.scaling||new BABYLON.Vector3(1,1,1),this.modelRotation=c.modelRotation||new BABYLON.Vector3(0,0,0),this.preferredYAngle=c.preferredYAngle,this.objectInstance=null,this.programmableInstance=null,this.filename=null,this.builderId=null,this.customData={}};return b.prototype=new BaseStructure,b.prototype.serialize=function(){if(!this.isDeleted){var a,b={"class":{name:"ObjectStructure"}};return this.objectInstance&&(a=this.objectInstance.parent,this.objectInstance.changeFrame(this.objectInstance.getFloor())),ujs.serializeObject(this,b,["objectId","customData","builderId","filename","baseUrl","position","rotation","scaling","programmableInstance"],["group"]),a&&(this.objectInstance.changeFrame(a),this.objectInstance.getFloor().markAsDirty()),b}},b.prototype.deserialize=function(a){return ujs.deserializeObject(a,this,["objectId","customData","builderId","filename","baseUrl","position","rotation","scaling","programmableInstance"]),this},b.Deserialize=function(a){var c=new b;return c.deserialize(a),c},b.prototype.checkCoherence=function(a){(Math.abs(this.position.x)>5e3||Math.abs(this.position.z)>5e3)&&a.removeElement("objects",this),this.programmableInstance||a.removeElement("objects",this)},b.prototype.clone=function(){var a=this.serialize();return b.Deserialize(a)},b.prototype.getAvailableProperties=function(){var a=[];return null!==this.programmableInstance&&(a=this.programmableInstance.getAvailableProperties(this)),a},b.prototype.getMagnetismCollider=function(){return void 0!==this.magnetismCollider?this.magnetismCollider:void 0!==this.params.magnetismCollider?this.params.magnetismCollider:hcs.Constants.MAGNETISM.DEFAULT},b.prototype.animate=function(a,b){null!==this.programmableInstance&&this.programmableInstance.animate&&this.programmableInstance.animate(a,b)},b.prototype.getProperty=function(a){if(this.programmableInstance){var b="get"+a+"Param";if(this.programmableInstance[b]){var c=this.programmableInstance[b].call(this);if(c)return ujs.getProperty(this.programmableInstance,c)}}return 0},b.prototype.changeProperty=function(a,b){if(this.programmableInstance){var c="get"+a+"Param";if(this.programmableInstance[c]){var d=this.programmableInstance[c].call(this);d&&(ujs.setProperty(this,d,b),ujs.setProperty(this.programmableInstance,d,b))}}},b}();var hcs=window.hcs||{};hcs.Programmable=function(){var a,b=function(b,c,d){this.params={},this.mergeParams(d),this.materials=null,this.structure=c,c&&(this.magnetismCollider=this.structure.magnetismCollider),this.id=0,this.async=!1,this.objectName="Programmable",a=this};return b.prototype.getDefaultMaterials=function(){return{}},b.prototype.decorate=function(a,b){var c=b.pickedMesh.material;return this.traverse(function(c){c.name===b.pickedMesh.name&&(a.backFaceCulling=c.material.backFaceCulling,c.material=a)}),this.structure.programmableInstance.materials[b.pickedMesh.name]=a,c},b.prototype.animate=function(){Logger.message("No animation here :(")},b.prototype.importDAE=function(){return console.warn("Can't use DAE with BABYLON"),null},b.prototype.importBabylon=function(a,b){var c=a.split("/"),d=c[c.length-1],e=d.split(".")[0];delete c[c.length-1],c=c.join("/"),-1===c.indexOf("http://")&&-1==c.indexOf("https://")&&(c=hcs.Assets.globalPath+c);var f=new BABYLON.Mesh(e,hcsdesign.engine3D.scene);return f.isVisible=!1,BABYLON.SceneLoader.ImportMesh("",c,d,hcsdesign.engine3D.scene,function(a){for(var c=0,d=a.length;d>c;c++)a[c].parent=f,a[c].receiveShadows=!0,hcsdesign.engine3D.castShadows(a[c]);b&&b(f)}),f},b.prototype.importOBJ=function(){return console.warn("Can't load OBJ file with BABYLON"),null},b.prototype.mergeParams=function(a){var a=a||{};this.params=this.getDefaultParams(),this.params=ujs.mergeObjects(this.params,a,!0)},b.prototype.getDefaultParams=function(){return{}},b.prototype.getParamType=function(a){var b=a.split(".").slice(-1)[0];switch(b){case"stretched_texture":case"rounded":case"active":return"boolean"}var c=this.getDefaultParams(),d=typeof ujs.getProperty(c,a);switch(d){case"boolean":case"string":case"number":return d;case"undefined":default:return console.warn('enable to determine the type of the param "'+a+'" in the programmable '+this.objectName),"number"}},b.prototype.validateParam=function(){var a=function(a,b){if(b=b||{},a=a.replace(/\s/g,""),!/^-?\d*\.?\d*]*$/.exec(a)||!/\d/.exec(a)){if(!(a=/-?\d+\.?\d*]*/.exec(a)))return b["default"]||null;a=a[0]}var c=+a;if(b.round){var d=b.round===!0?1:b.round;c=Math.round(c*d)/d}return"number"==typeof b.max&&(c=Math.min(c,b.max)),"number"==typeof b.min&&(c=Math.max(c,b.min)),c},b=function(a){return!!+a<<0},c=function(b,c){if(c=c||{},c.intList=c.intList||c.intListSeparator||c.inListOptions,c.intList){for(var d=c.intListSeparator||",",e=(""+b).split(d),f=e.length;f--;)if("undefined"==typeof(e[f]=a(e[f],c.inListOptions))||null==e[f])return null;b=e.join(d)}return b};return function(d,e){var f=null,g=null;switch("params"==d.split(".")[0]&&(d=d.split(".").slice(1).join(".")),f=this.getParamType(d),"string"!=typeof f&&(g=f,f=f.type),f){case"boolean":return b(e,g);case"string":return c(e,g);default:case"number":return a(e,g)}}}(),b.prototype.prepareMaterials=function(a){return this.materials=a,a},b.prototype.applyShadow=function(){console.warn("Not used in BABYLON")},b.createInstance=function(a,b,c,d,e,f,g){var h=a.split(".");h.length=h.length-1;var b=b||{},i=function(){var a=ujs.getProperty(hcs.Programmable,h.join(".")),f=b.params||b,i=new a(g,d,f);i.materials=c||i.getDefaultMaterials(hcsdesign.engine3D.scene),b.id,e(i)},j=h.length,k=function(a,b,c){if(a>=j)return void i();var d=c||hcs.Constants.PROGRAMMABLE_PATH;HTMLHelper.addScript([d,"/",b,".js"].join(""),void 0,function(){var d=b+"/"+h[a+1];k(a+1,d,c)})};k(0,h[0],f)},b.prototype.serialize=function(){var a={"class":{name:"hcs.Programmable"}};return ujs.serializeObject(this,a,["objectName","id","params","materials"]),a},b.prototype.deserialize=function(a){return ujs.deserializeObject(a,this,["objectName","id","params","materials"]),this},b.Deserialize=function(a){var c=new b(hcsdesign.engine3D,null,a.params);return c.deserialize(a),c},b.prototype.getAvailableProperties=function(){var a=this.generateFormForObject("params",this);if(this.localizeAndSortParams)for(var b=this.localizeAndSortParams(),c=a.length-1;c>=0;c--){var d=a[c].name?a[c].name.replace("params.",""):void 0,e=d.split(".")[0];b.invisible&&(b.invisible.hasOwnProperty(d)||b.invisible.hasOwnProperty(e))?delete a[c]:b.basic&&b.basic.hasOwnProperty(d)?a[c].label=a[c].label?b.basic[d]:"":b.advanced&&b.advanced.hasOwnProperty(d)?(a[c].label=a[c].label?b.advanced[d]:"",a[c]["class"]="hidden advancedParams"):delete a[c]}return a},b.prototype.generateFormForObject=function(a,b,c,d,e){var c=c||[],f=null,d=d||"",e=e||0;if(b[a]instanceof Object){d=d?d+"."+a:a,"params"!=a&&(f={name:d,label:a,type:"separator",html:a},c.push(f)),e++;for(var g in b[a])this.generateFormForObject(g,b[a],c,d,e);c.push({type:"separator",name:d})}else{var h=d?d+"."+a:a,i=this.getParamType(h.split(".").slice(1).join("."));i=i.type?i:{type:i};var j,k;switch(i.type){case"boolean":j="checkbox",k=!!b[a];break;case"number":j="number",k={value:+b[a]},"undefined"!=typeof i.max&&(k.max=i.max),"undefined"!=typeof i.min&&(k.min=i.min),"undefined"!=typeof i.round&&(k.step=i.round);break;default:j="text",k=b[a]}f={name:h,label:new Array(2*e).join("&nbsp")+a,type:j,value:k,eventParams:{eventName:"hcs.contextMenu.propertyChanged",property:h},id:h.split(".").join("-")},c.push(f)}return c},b.prototype.createPoignee=function(){return console.warn("Can't use it with BABYLON"),null},b.prototype.getWidthParam=function(){return this.params.width?"params.width":!1},b.prototype.getHeightParam=function(){return this.params.height?"params.height":!1},b.prototype.getDepthParam=function(){return this.params.depth?"params.depth":!1},b.prototype.generateMissingFacesUvs=function(){return console.warn("Can't use it with BABYLON"),null},b}(),hcs.Programmable.toggleVisible=function(){for(var a=document.querySelectorAll(".advancedParams"),b=0;b<a.length;b++)a[b].classList.toggle("hidden")};var DecorationComponent3D=function(){function a(a){"object"==typeof a&&("keydown"==a.type&&27!=a.keyCode||"mousedown"==a.type&&0==a.button)||(c=null,ujs.notify("hcs.menu.main.deselect"),hcsdesign.engine3D.mode=hcsdesign.engine3D.MODE_NORMAL,hcsdesign.engine3D.canvas.classList.remove("brush"))}var b,c=null,d=0,e=function(a){BaseComponent3D.call(this,a,"DecorationComponent3D"),this.tabs=[],window.ejecta||(this.tabs=document.getElementsByClassName("menu-tab")),b=this,this.historycmp=null,this.PAINTACTION=0,this.setupHistory(),this.standardMaps=["map","bumpMap","normalMap","specularMap"],document.addEventListener("hcs.core.structure.loaded",this.initializeLastColor.bind(this),!1)};return e.prototype=new BaseComponent3D,e.prototype.initializeLastColor=function(){var a=this.core.structure.lastMaterialsUsed.length>0?"":" hidden",b=this.core.structure.lastMaterialsUsed.length>0?this.cleanJson(this.core.structure.lastMaterialsUsed):[],c={id:"last_colors",title:_("最近使用颜色"),index:5,addClass:"last-color-item"+a,layout:"layout-table-60",items:b};ujs.notify("hcs.menu.main.add",{item:c,menuPath:"furnishing3D",position:0})},e.prototype.destroy=function(){ujs.notify("hcs.menu.main.remove",{item:"furnishing3D"}),ujs.notify("hcs.menu.main.remove",{item:"decorate3D"})},e.prototype.cleanJson=function(a){for(var b in a)a.hasOwnProperty(b)&&(a[b]instanceof Object?a[b]=this.cleanJson(a[b]):"string"==typeof a[b]&&-1!==a[b].indexOf("http://")&&(a[b]=GlobalHelper.stripDomainUrl(a[b],"hcsdesign.")));return a},e.prototype.initialize=function(){var a=this,b="http://v2.hcsdesign.fr/data/menu.content.compiled.json";window.ejecta&&(b="Wanaplan/"+b);var c=function(){ujs.ajax({url:b,method:"GET",params:["t=",Math.round(100*Math.random())].join(""),success:function(b){var c=JSON.parse(b);c=a.cleanJson(c),ujs.notify("hcs.menu.main.add",{item:c,menuPath:"decorate3D",position:0})}})};ujs.ajax({url:hcs.Constants.TEXTURES_FILE,method:"GET",params:["t=",Math.round(100*Math.random())].join(""),success:function(b){try{var d=JSON.parse(b);d=a.cleanJson(d),ujs.notify("hcs.menu.main.add",{item:d,menuPath:"decorate3D",position:0})}catch(e){Logger.message("BAD JSON FILE"),c()}},onerror:c})},e.prototype.startListening=function(){document.addEventListener("hcs.request.changeEngine",this.onChangeEngine,!1),document.addEventListener("hcs.engine3D.paint",this.onPaintHandler,!1),document.addEventListener("hcs.engine3D.click.collided",this.onClick,!1),document.addEventListener("keydown",a,!1)},e.prototype.stopListening=function(){document.removeEventListener("hcs.request.changeEngine",this.onChangeEngine,!1),document.removeEventListener("hcs.engine3D.paint",this.onPaintHandler),document.removeEventListener("hcs.engine3D.click.collided",this.onClick,!1),document.removeEventListener("keydown",a)},e.prototype.onContextChanged=function(b){if("3D"==b){if(!this.initialized){this.startListening();for(var c=0,d=this.tabs.length;d>c;c++)this.tabs[c].addEventListener("click",a,!1);this.initialized=!0}}else if(this.initialized){for(var c=0,d=this.tabs.length;d>c;c++)this.tabs[c].removeEventListener("click",a,!1);this.initialized=!1}},e.prototype.onPaintHandler=function(a){b.core.helpBubbleManager.display("hcs.3d.paint");var d=a.params||{};c={title:a.title,action:"hcs.engine3D.paint",params:d,texture:!0},hcsdesign.engine3D.mode=b.engine3D.MODE_PAINT,hcsdesign.engine3D.canvas.classList.add("brush"),ujs.notify("hcs.engine3D.brushReady")},e.prototype.updateLastItemMenu=function(a){for(var b=!1,c=0;c<hcsdesign.structure.lastMaterialsUsed.length;c++)a.title==hcsdesign.structure.lastMaterialsUsed[c].title&&(b=!0);b===!1&&(hcsdesign.structure.lastMaterialsUsed.push(ujs.cloneObject(a)),ujs.notify("hcs.menu.main.replace",{item:{id:"last_colors",addClass:"last-color-item",items:hcsdesign.structure.lastMaterialsUsed},merge:!0},!0)),this.core.structure.lastMaterialsUsed.length>21&&this.core.structure.lastMaterialsUsed.splice(0,this.core.structure.lastMaterialsUsed.length-21)},e.prototype.onClick=function(e){if(null!=c){var f=hcs.MaterialFactory.ImportWNPMaterial(c.params);f.isDefault=!1;var g=e.collided.pickedMesh.getTopLevelObject();if(g.isDecorable){if(g.decorate)var h=g.decorate(f,e.collided);else var h=b.decorate(e.collided.pickedMesh,f,e.collided);f.backFaceCulling=h?h.backFaceCulling:!1}b.updateLastItemMenu(c),ujs.notify("hcs.request.historyAction",{component:b,object:g,params:{oldMaterial:h,newMaterial:f,collided:e.collided},action:b.PAINTACTION}),c&&b.updateLastItemMenu(c),ujs.notify("hcs.engine3D.decorate",{material:f}),1>=d&&a()}},e.prototype.decorate=function(a,b){a.material=b},e.prototype.applyMaterial=function(a,c,d){a.decorate?a.decorate(c,d):b.decorate(d.pickedMesh,c,d)},e.prototype.getMaterial=function(){return material},e.prototype.addHistory=function(a,b,c){this.historycmp&&this.historycmp.actionDone(a,b,c,this)},e.prototype.undoPaint=function(a,c){b.historyPaint(a,c,c.oldMaterial)},e.prototype.redoPaint=function(a,c){b.historyPaint(a,c,c.newMaterial)},e.prototype.historyPaint=function(a,c,d){b.applyMaterial(a,d,c.collided),ujs.notify("hcs.request.saveHistory")},e.prototype.setupHistory=function(){this.historycmp=this.core.getComponentByName("HistoryComponent"),this.historycmp&&this.historycmp.registerAction(this.PAINTACTION,this.undoPaint,this.redoPaint,this)},e}(),LuxensComponent3D=function(){var a=function(a){BaseComponent3D.call(this,a,"LuxensComponent3D")};a.prototype=new BaseComponent3D,a.prototype.initialize=function(){_item={title:_("家具颜色"),id:"luxens",items:b,layout:"layout-table-26"},ujs.notify("hcs.menu.main.add",{item:_item,menuPath:"furnishing3D",position:10})},a.getLuxens=function(){return b};var b=[{texture:!0,title:"Blanc 1",icon:"",action:"hcs.engine3D.paint",items:[],params:{materialType:"hcs.WhiteMaterial",color:{r:1,g:1,b:1}}},{texture:!0,title:"Blanc 2",icon:"",action:"hcs.engine3D.paint",items:[],params:{materialType:"hcs.WhiteMaterial",color:{r:.96,g:.96,b:.96}}},{texture:!0,title:"Blanc3",icon:"",action:"hcs.engine3D.paint",items:[],params:{materialType:"hcs.WhiteMaterial",color:{r:.9,g:.9,b:.9}}},{texture:!0,title:"Noir 1",icon:"",action:"hcs.engine3D.paint",items:[],params:{materialType:"luxens",color:{r:0,g:0,b:0}}},{texture:!0,title:"Noir 2",icon:"",action:"hcs.engine3D.paint",items:[],params:{materialType:"luxens",color:{r:.05,g:.05,b:.05}}},{texture:!0,title:"Noir 3",icon:"",action:"hcs.engine3D.paint",items:[],params:{materialType:"luxens",color:{r:.07,g:.07,b:.07}}},{texture:!0,title:"Blanc calcaire 1",icon:"",action:"hcs.engine3D.paint",items:[],params:{materialType:"luxens",color:{r:.85,g:.85,b:.82}}},{texture:!0,title:"Blanc calcaire 2",icon:"",action:"hcs.engine3D.paint",items:[],params:{materialType:"luxens",color:{r:.91,g:.9,b:.82}}},{texture:!0,title:"Blanc calcaire 3",icon:"",action:"hcs.engine3D.paint",items:[],params:{materialType:"luxens",color:{r:.92,g:.93,b:.89}}},{texture:!0,title:"Blanc calcaire 4",icon:"",action:"hcs.engine3D.paint",items:[],params:{materialType:"luxens",color:{r:.92,g:.93,b:.89}}},{texture:!0,title:"Blanc calcaire 5",icon:"",action:"hcs.engine3D.paint",items:[],params:{materialType:"luxens",color:{r:.88,g:.89,b:.86}}},{texture:!0,title:"Blanc calcaire 6",icon:"",action:"hcs.engine3D.paint",items:[],params:{materialType:"luxens",color:{r:.91,g:.88,b:.84}}},{texture:!0,title:"Blanc ivoire 1",icon:"",action:"hcs.engine3D.paint",items:[],params:{materialType:"luxens",color:{r:.85,g:.8,b:.71}}},{texture:!0,title:"Blanc ivoire 2",icon:"",action:"hcs.engine3D.paint",items:[],params:{materialType:"luxens",color:{r:.93,g:.87,b:.77}}},{texture:!0,title:"Blanc ivoire 3",icon:"",action:"hcs.engine3D.paint",items:[],params:{materialType:"luxens",color:{r:.91,g:.87,b:.76}}},{texture:!0,title:"Blanc ivoire 4",icon:"",action:"hcs.engine3D.paint",items:[],params:{materialType:"luxens",color:{r:.94,g:.91,b:.83}}},{texture:!0,title:"Blanc ivoire 5",icon:"",action:"hcs.engine3D.paint",items:[],params:{materialType:"luxens",color:{r:.91,g:.89,b:.84}}},{texture:!0,title:"Blanc ivoire 6",icon:"",action:"hcs.engine3D.paint",items:[],params:{materialType:"luxens",color:{r:.93,g:.89,b:.76}}},{texture:!0,title:"Blanc coquille 1",icon:"",action:"hcs.engine3D.paint",items:[],params:{materialType:"luxens",color:{r:.84,g:.78,b:.73}}},{texture:!0,title:"Blanc coquille 2",icon:"",action:"hcs.engine3D.paint",items:[],params:{materialType:"luxens",color:{r:.86,g:.83,b:.77}}},{texture:!0,title:"Blanc coquille 3",icon:"",action:"hcs.engine3D.paint",items:[],params:{materialType:"luxens",color:{r:.91,g:.86,b:.78}}},{texture:!0,title:"Blanc coquille 4",icon:"",action:"hcs.engine3D.paint",items:[],params:{materialType:"luxens",color:{r:.9,g:.86,b:.81}}},{texture:!0,title:"Blanc coquille 5",icon:"",action:"hcs.engine3D.paint",items:[],params:{materialType:"luxens",color:{r:.93,g:.89,b:.84}}},{texture:!0,title:"Blanc coquille 6",icon:"",action:"hcs.engine3D.paint",items:[],params:{materialType:"luxens",color:{r:.96,g:.88,b:.75}}},{texture:!0,title:"Gris galet 1",icon:"",action:"hcs.engine3D.paint",items:[],params:{materialType:"luxens",color:{r:.31,g:.32,b:.35}}},{texture:!0,title:"Gris galet 2",icon:"",action:"hcs.engine3D.paint",items:[],params:{materialType:"luxens",color:{r:.39,g:.38,b:.41}}},{texture:!0,title:"Gris galet 3",icon:"",action:"hcs.engine3D.paint",items:[],params:{materialType:"luxens",color:{r:.49,g:.49,b:.5}}},{texture:!0,title:"Gris galet 4",icon:"",action:"hcs.engine3D.paint",items:[],params:{materialType:"luxens",color:{r:.58,g:.62,b:.63}}},{texture:!0,title:"Gris galet 5",icon:"",action:"hcs.engine3D.paint",items:[],params:{materialType:"luxens",color:{r:.7,g:.71,b:.72}}},{texture:!0,title:"Gris galet 6",icon:"",action:"hcs.engine3D.paint",items:[],params:{materialType:"luxens",color:{r:.78,g:.79,b:.8}}},{texture:!0,title:"Gris zingué 1",icon:"",action:"hcs.engine3D.paint",items:[],params:{materialType:"luxens",color:{r:.2,g:.22,b:.23}}},{texture:!0,title:"Gris zingué 2",icon:"",action:"hcs.engine3D.paint",items:[],params:{materialType:"luxens",color:{r:.29,g:.33,b:.36}}},{texture:!0,title:"Gris zingué 3",icon:"",action:"hcs.engine3D.paint",items:[],params:{materialType:"luxens",color:{r:.29,g:.36,b:.43}}},{texture:!0,title:"Gris zingué 4",icon:"",action:"hcs.engine3D.paint",items:[],params:{materialType:"luxens",color:{r:.47,g:.51,b:.54}}},{texture:!0,title:"Gris zingué 5",icon:"",action:"hcs.engine3D.paint",items:[],params:{materialType:"luxens",color:{r:.6,g:.65,b:.69}}},{texture:!0,title:"Gris zingué 6",icon:"",action:"hcs.engine3D.paint",items:[],params:{materialType:"luxens",color:{r:.69,g:.73,b:.78}}},{texture:!0,title:"Gris smoke 1",icon:"",action:"hcs.engine3D.paint",items:[],params:{materialType:"luxens",color:{r:.26,g:.27,b:.27}}},{texture:!0,title:"Gris smoke 2",icon:"",action:"hcs.engine3D.paint",items:[],params:{materialType:"luxens",color:{r:.36,g:.37,b:.33}}},{texture:!0,title:"Gris smoke 3",icon:"",action:"hcs.engine3D.paint",items:[],params:{materialType:"luxens",color:{r:.4,g:.42,b:.36}}},{texture:!0,title:"Gris smoke 4",icon:"",action:"hcs.engine3D.paint",items:[],params:{materialType:"luxens",color:{r:.47,g:.51,b:.45}}},{texture:!0,title:"Gris smoke 5",icon:"",action:"hcs.engine3D.paint",items:[],params:{materialType:"luxens",color:{r:.58,g:.62,b:.59}}},{texture:!0,title:"Gris smoke 6",icon:"",action:"hcs.engine3D.paint",items:[],params:{materialType:"luxens",color:{r:.73,g:.75,b:.74}}},{texture:!0,title:"Gris gris 1",icon:"",action:"hcs.engine3D.paint",items:[],params:{materialType:"luxens",color:{r:.08,g:.08,b:.08}}},{texture:!0,title:"Gris gris 2",icon:"",action:"hcs.engine3D.paint",items:[],params:{materialType:"luxens",color:{r:.4,g:.41,b:.39}}},{texture:!0,title:"Gris gris 3",icon:"",action:"hcs.engine3D.paint",items:[],params:{materialType:"luxens",color:{r:.52,g:.52,b:.5}}},{texture:!0,title:"Gris gris 4",icon:"",action:"hcs.engine3D.paint",items:[],params:{materialType:"luxens",color:{r:.59,g:.56,b:.51}}},{texture:!0,title:"Gris gris 5",icon:"",action:"hcs.engine3D.paint",items:[],params:{materialType:"luxens",color:{r:.65,g:.64,b:.57}}},{texture:!0,title:"Gris gris 6",icon:"",action:"hcs.engine3D.paint",items:[],params:{materialType:"luxens",color:{r:.79,g:.81,b:.77}}},{texture:!0,title:"Gris poivré 1",icon:"",action:"hcs.engine3D.paint",items:[],params:{materialType:"luxens",color:{r:.12,g:.11,b:.1}}},{texture:!0,title:"Gris poivré 2",icon:"",action:"hcs.engine3D.paint",items:[],params:{materialType:"luxens",color:{r:.3,g:.27,b:.26}}},{texture:!0,title:"Gris poivré 3",icon:"",action:"hcs.engine3D.paint",items:[],params:{materialType:"luxens",color:{r:.41,g:.4,b:.37}}},{texture:!0,title:"Gris poivré 4",icon:"",action:"hcs.engine3D.paint",items:[],params:{materialType:"luxens",color:{r:.57,g:.53,b:.54}}},{texture:!0,title:"Gris poivré 5",icon:"",action:"hcs.engine3D.paint",items:[],params:{materialType:"luxens",color:{r:.69,g:.67,b:.67}}},{texture:!0,title:"Gris poivré 6",icon:"",action:"hcs.engine3D.paint",items:[],params:{materialType:"luxens",color:{r:.82,g:.78,b:.75}}},{texture:!0,title:"Gris doré 1",icon:"",action:"hcs.engine3D.paint",items:[],params:{materialType:"luxens",color:{r:.38,g:.33,b:.27}}},{texture:!0,title:"Gris doré 2",icon:"",action:"hcs.engine3D.paint",items:[],params:{materialType:"luxens",color:{r:.41,g:.38,b:.31}}},{texture:!0,title:"Gris doré 3",icon:"",action:"hcs.engine3D.paint",items:[],params:{materialType:"luxens",color:{r:.53,g:.45,b:.36}}},{texture:!0,title:"Gris doré 4",icon:"",action:"hcs.engine3D.paint",items:[],params:{materialType:"luxens",color:{r:.56,g:.52,b:.46}}},{texture:!0,title:"Gris doré 5",icon:"",action:"hcs.engine3D.paint",items:[],params:{materialType:"luxens",color:{r:.64,g:.58,b:.48}}},{texture:!0,title:"Gris doré 6",icon:"",action:"hcs.engine3D.paint",items:[],params:{materialType:"luxens",color:{r:.8,g:.77,b:.72}}},{texture:!0,title:"Brun taupe 1",icon:"",action:"hcs.engine3D.paint",items:[],params:{materialType:"luxens",color:{r:.27,g:.24,b:.23}}},{texture:!0,title:"Brun taupe 2",icon:"",action:"hcs.engine3D.paint",items:[],params:{materialType:"luxens",color:{r:.35,g:.29,b:.27}}},{texture:!0,title:"Brun taupe 3",icon:"",action:"hcs.engine3D.paint",items:[],params:{materialType:"luxens",color:{r:.46,g:.41,b:.37}}},{texture:!0,title:"Brun taupe 4",icon:"",action:"hcs.engine3D.paint",items:[],params:{materialType:"luxens",color:{r:.53,g:.47,b:.46}}},{texture:!0,title:"Brun taupe 5",icon:"",action:"hcs.engine3D.paint",items:[],params:{materialType:"luxens",color:{r:.67,g:.57,b:.56}}},{texture:!0,title:"Brun taupe 6",icon:"",action:"hcs.engine3D.paint",items:[],params:{materialType:"luxens",color:{r:.81,g:.75,b:.75}}},{texture:!0,title:"Brun gatsby 1",icon:"",action:"hcs.engine3D.paint",items:[],params:{materialType:"luxens",color:{r:.25,g:.18,b:.19}}},{texture:!0,title:"Brun gatsby 2",icon:"",action:"hcs.engine3D.paint",items:[],params:{materialType:"luxens",color:{r:.3,g:.22,b:.22}}},{texture:!0,title:"Brun gatsby 3",icon:"",action:"hcs.engine3D.paint",items:[],params:{materialType:"luxens",color:{r:.43,g:.31,b:.27}}},{texture:!0,title:"Brun gatsby 4",icon:"",action:"hcs.engine3D.paint",items:[],params:{materialType:"luxens",color:{r:.61,g:.5,b:.43}}},{texture:!0,title:"Brun gatsby 5",icon:"",action:"hcs.engine3D.paint",items:[],params:{materialType:"luxens",color:{r:.73,g:.63,b:.54}}},{texture:!0,title:"Brun gatsby 6",icon:"",action:"hcs.engine3D.paint",items:[],params:{materialType:"luxens",color:{r:.85,g:.78,b:.68}}},{texture:!0,title:"Brun brun 1",icon:"",action:"hcs.engine3D.paint",items:[],params:{materialType:"luxens",color:{r:.27,g:.22,b:.18}}},{texture:!0,title:"Brun brun 2",icon:"",action:"hcs.engine3D.paint",items:[],params:{materialType:"luxens",color:{r:.42,g:.31,b:.22}}},{texture:!0,title:"Brun brun 3",icon:"",action:"hcs.engine3D.paint",items:[],params:{materialType:"luxens",color:{r:.47,g:.39,b:.31}}},{texture:!0,title:"Brun brun 4",icon:"",action:"hcs.engine3D.paint",items:[],params:{materialType:"luxens",color:{r:.67,g:.57,b:.42}}},{texture:!0,title:"Brun brun 5",icon:"",action:"hcs.engine3D.paint",items:[],params:{materialType:"luxens",color:{r:.81,g:.69,b:.52}}},{texture:!0,title:"Brun brun 6",icon:"",action:"hcs.engine3D.paint",items:[],params:{materialType:"luxens",color:{r:.83,g:.75,b:.62}}},{texture:!0,title:"Brun argileux 1",icon:"",action:"hcs.engine3D.paint",items:[],params:{materialType:"luxens",color:{r:.27,g:.25,b:.24}}},{texture:!0,title:"Brun argileux 2",icon:"",action:"hcs.engine3D.paint",items:[],params:{materialType:"luxens",color:{r:.31,g:.29,b:.2}}},{texture:!0,title:"Brun argileux 3",icon:"",action:"hcs.engine3D.paint",items:[],params:{materialType:"luxens",color:{r:.53,g:.42,b:.23}}},{texture:!0,title:"Brun argileux 4",icon:"",action:"hcs.engine3D.paint",items:[],params:{materialType:"luxens",color:{r:.57,g:.51,b:.36}}},{texture:!0,title:"Brun argileux 5",icon:"",action:"hcs.engine3D.paint",items:[],params:{materialType:"luxens",color:{r:.71,g:.68,b:.58}}},{texture:!0,title:"Brun argileux 6",icon:"",action:"hcs.engine3D.paint",items:[],params:{materialType:"luxens",color:{r:.81,g:.79,b:.69}}},{texture:!0,title:"Brun chocolat 1",icon:"",action:"hcs.engine3D.paint",items:[],params:{materialType:"luxens",color:{r:.22,g:.17,b:.14}}},{texture:!0,title:"Brun chocolat 2",icon:"",action:"hcs.engine3D.paint",items:[],params:{materialType:"luxens",color:{r:.32,g:.21,b:.16}}},{texture:!0,title:"Brun chocolat 3",icon:"",action:"hcs.engine3D.paint",items:[],params:{materialType:"luxens",color:{r:.36,g:.21,b:.15}}},{texture:!0,title:"Brun chocolat 4",icon:"",action:"hcs.engine3D.paint",items:[],params:{materialType:"luxens",color:{r:.5,g:.35,b:.25}}},{texture:!0,title:"Brun chocolat 5",icon:"",action:"hcs.engine3D.paint",items:[],params:{materialType:"luxens",color:{r:.8,g:.66,b:.49}}},{texture:!0,title:"Brun chocolat 6",icon:"",action:"hcs.engine3D.paint",items:[],params:{materialType:"luxens",color:{r:.91,g:.81,b:.71}}},{texture:!0,title:"Brun havane 1",icon:"",action:"hcs.engine3D.paint",items:[],params:{materialType:"luxens",color:{r:.16,g:.12,b:.12}}},{texture:!0,title:"Brun havane 2",icon:"",action:"hcs.engine3D.paint",items:[],params:{materialType:"luxens",color:{r:.25,g:.14,b:.14}}},{texture:!0,title:"Brun havane 3",icon:"",action:"hcs.engine3D.paint",items:[],params:{materialType:"luxens",color:{r:.5,g:.28,b:.24}}},{texture:!0,title:"Brun havane 4",icon:"",action:"hcs.engine3D.paint",items:[],params:{materialType:"luxens",color:{r:.62,g:.39,b:.29}}},{texture:!0,title:"Brun havane 5",icon:"",action:"hcs.engine3D.paint",items:[],params:{materialType:"luxens",color:{r:.77,g:.5,b:.39}}},{texture:!0,title:"Brun havane 6",icon:"",action:"hcs.engine3D.paint",items:[],params:{materialType:"luxens",color:{r:.88,g:.73,b:.63}}},{texture:!0,title:"Rouge velours 1",icon:"",action:"hcs.engine3D.paint",items:[],params:{materialType:"luxens",color:{r:.27,g:.12,b:.12}}},{texture:!0,title:"Rouge velours 2",icon:"",action:"hcs.engine3D.paint",items:[],params:{materialType:"luxens",color:{r:.43,g:.12,b:.16}}},{texture:!0,title:"Rouge velours 3",icon:"",action:"hcs.engine3D.paint",items:[],params:{materialType:"luxens",color:{r:.48,g:.13,b:.18}}},{texture:!0,title:"Rouge velours 4",icon:"",action:"hcs.engine3D.paint",items:[],params:{materialType:"luxens",color:{r:.58,g:.22,b:.22}}},{texture:!0,title:"Rouge velours 5",icon:"",action:"hcs.engine3D.paint",items:[],params:{materialType:"luxens",color:{r:.81,g:.32,b:.31}}},{texture:!0,title:"Rouge velours 6",icon:"",action:"hcs.engine3D.paint",items:[],params:{materialType:"luxens",color:{r:.85,g:.45,b:.43}}},{texture:!0,title:"Rouge rubis 1",icon:"",action:"hcs.engine3D.paint",items:[],params:{materialType:"luxens",color:{r:.25,g:.11,b:.11}}},{texture:!0,title:"Rouge rubis 2",icon:"",action:"hcs.engine3D.paint",items:[],params:{materialType:"luxens",color:{r:.4,g:.08,b:.14}}},{texture:!0,title:"Rouge rubis 3",icon:"",action:"hcs.engine3D.paint",items:[],params:{materialType:"luxens",color:{r:.6,g:.07,b:.24}}},{texture:!0,title:"Rouge rubis 4",icon:"",action:"hcs.engine3D.paint",items:[],params:{materialType:"luxens",color:{r:.64,g:.14,b:.27}}},{texture:!0,title:"Rouge rubis 5",icon:"",action:"hcs.engine3D.paint",items:[],params:{materialType:"luxens",color:{r:.75,g:.33,b:.43}}},{texture:!0,title:"Rouge rubis 6",icon:"",action:"hcs.engine3D.paint",items:[],params:{materialType:"luxens",color:{r:.89,g:.61,b:.63}}},{texture:!0,title:"Rouge gourmand 1",icon:"",action:"hcs.engine3D.paint",items:[],params:{materialType:"luxens",color:{r:.27,g:.05,b:.09}}},{texture:!0,title:"Rouge gourmand 2",icon:"",action:"hcs.engine3D.paint",items:[],params:{materialType:"luxens",color:{r:.54,g:.02,b:.15}}},{texture:!0,title:"Rouge gourmand 3",icon:"",action:"hcs.engine3D.paint",items:[],params:{materialType:"luxens",color:{r:.65,g:0,b:.18}}},{texture:!0,title:"Rouge gourmand 4",icon:"",action:"hcs.engine3D.paint",items:[],params:{materialType:"luxens",color:{r:.84,g:.07,b:.2}}},{texture:!0,title:"Rouge gourmand 5",icon:"",action:"hcs.engine3D.paint",items:[],params:{materialType:"luxens",color:{r:.87,g:.15,b:.28}}},{texture:!0,title:"Rouge gourmand 6",icon:"",action:"hcs.engine3D.paint",items:[],params:{materialType:"luxens",color:{r:.99,g:.76,b:.76}}},{texture:!0,title:"Rouge-rouge 1",icon:"",action:"hcs.engine3D.paint",items:[],params:{materialType:"luxens",color:{r:.4,g:.12,b:.12}}},{texture:!0,title:"Rouge-rouge 2",icon:"",action:"hcs.engine3D.paint",items:[],params:{materialType:"luxens",color:{r:.59,g:.06,b:.14}}},{texture:!0,title:"Rouge-rouge 3",icon:"",action:"hcs.engine3D.paint",items:[],params:{materialType:"luxens",color:{r:.65,g:0,b:.11}}},{texture:!0,title:"Rouge-rouge 4",icon:"",action:"hcs.engine3D.paint",items:[],params:{materialType:"luxens",color:{r:.85,g:.07,b:.09}}},{texture:!0,title:"Rouge-rouge 5",icon:"",action:"hcs.engine3D.paint",items:[],params:{materialType:"luxens",color:{r:.91,g:.16,b:.19}}},{texture:!0,title:"Rouge-rouge 6",icon:"",action:"hcs.engine3D.paint",items:[],params:{materialType:"luxens",color:{r:.99,g:.88,b:.84}}},{texture:!0,title:"Rouge corail 1",icon:"",action:"hcs.engine3D.paint",items:[],params:{materialType:"luxens",color:{r:.55,g:.12,b:.13}}},{texture:!0,title:"Rouge corail 2",icon:"",action:"hcs.engine3D.paint",items:[],params:{materialType:"luxens",color:{r:.69,g:.16,b:.21}}},{texture:!0,title:"Rouge corail 3",icon:"",action:"hcs.engine3D.paint",items:[],params:{materialType:"luxens",color:{r:.74,g:.15,b:.16}}},{texture:!0,title:"Rouge corail 4",icon:"",action:"hcs.engine3D.paint",items:[],params:{materialType:"luxens",color:{r:.87,g:.24,b:.25}}},{texture:!0,title:"Rouge corail 5",icon:"",action:"hcs.engine3D.paint",items:[],params:{materialType:"luxens",color:{r:.92,g:.26,b:.19}}},{texture:!0,title:"Rouge corail 6",icon:"",action:"hcs.engine3D.paint",items:[],params:{materialType:"luxens",color:{r:1,g:.54,b:.45}}},{texture:!0,title:"Orange vitaminé 1",icon:"",action:"hcs.engine3D.paint",items:[],params:{materialType:"luxens",color:{r:.69,g:.21,b:.13}}},{texture:!0,title:"Orange vitaminé 2",icon:"",action:"hcs.engine3D.paint",items:[],params:{materialType:"luxens",color:{r:.82,g:.18,b:.09}}},{texture:!0,title:"Orange vitaminé 3",icon:"",action:"hcs.engine3D.paint",items:[],params:{materialType:"luxens",color:{r:1,g:.23,b:.11}}},{texture:!0,title:"Orange vitaminé 4",icon:"",action:"hcs.engine3D.paint",items:[],params:{materialType:"luxens",color:{r:1,g:.31,b:.16}}},{texture:!0,title:"Orange vitaminé 5",icon:"",action:"hcs.engine3D.paint",items:[],params:{materialType:"luxens",color:{r:1,g:.38,b:.29}}},{texture:!0,title:"Orange vitaminé 6",icon:"",action:"hcs.engine3D.paint",items:[],params:{materialType:"luxens",color:{r:1,g:.81,b:.69}}},{texture:!0,title:"Orange fusion 1",icon:"",action:"hcs.engine3D.paint",items:[],params:{materialType:"luxens",color:{r:.95,g:.24,b:.07}}},{texture:!0,title:"Orange fusion 2",icon:"",action:"hcs.engine3D.paint",items:[],params:{materialType:"luxens",color:{r:.81,g:.43,b:.29}}},{texture:!0,title:"Orange fusion 3",icon:"",action:"hcs.engine3D.paint",items:[],params:{materialType:"luxens",color:{r:.97,g:.37,b:.11}}},{texture:!0,title:"Orange fusion 4",icon:"",action:"hcs.engine3D.paint",items:[],params:{materialType:"luxens",color:{r:1,g:.39,b:.15}}},{texture:!0,title:"Orange fusion 5",icon:"",action:"hcs.engine3D.paint",items:[],params:{materialType:"luxens",color:{r:1,g:.55,b:.28}}},{texture:!0,title:"Orange fusion 6",icon:"",action:"hcs.engine3D.paint",items:[],params:{materialType:"luxens",color:{r:1,g:.65,b:.42}}},{texture:!0,title:"Orange-orange 1",icon:"",action:"hcs.engine3D.paint",items:[],params:{materialType:"luxens",color:{r:.62,g:.29,b:.11}}},{texture:!0,title:"Orange-orange 2",icon:"",action:"hcs.engine3D.paint",items:[],params:{materialType:"luxens",color:{r:.76,g:.29,b:.07}}},{texture:!0,title:"Orange-orange 3",icon:"",action:"hcs.engine3D.paint",items:[],params:{materialType:"luxens",color:{r:.87,g:.38,b:.09}}},{texture:!0,title:"Orange-orange 4",icon:"",action:"hcs.engine3D.paint",items:[],params:{materialType:"luxens",color:{r:1,g:.45,b:.04}}},{texture:!0,title:"Orange-orange 5",icon:"",action:"hcs.engine3D.paint",items:[],params:{materialType:"luxens",color:{r:1,g:.56,b:.12}}},{texture:!0,title:"Orange-orange 6",icon:"",action:"hcs.engine3D.paint",items:[],params:{materialType:"luxens",color:{r:1,g:.74,b:.41}}},{texture:!0,title:"Orange doré 1",icon:"",action:"hcs.engine3D.paint",items:[],params:{materialType:"luxens",color:{r:.73,g:.33,b:.06}}},{texture:!0,title:"Orange doré 2",icon:"",action:"hcs.engine3D.paint",items:[],params:{materialType:"luxens",color:{r:.84,g:.45,b:0}}},{texture:!0,title:"Orange doré 3",icon:"",action:"hcs.engine3D.paint",items:[],params:{materialType:"luxens",color:{r:.99,g:.48,b:.07}}},{texture:!0,title:"Orange doré 4",icon:"",action:"hcs.engine3D.paint",items:[],params:{materialType:"luxens",color:{r:1,g:.56,b:.15}}},{texture:!0,title:"Orange doré 5",icon:"",action:"hcs.engine3D.paint",items:[],params:{materialType:"luxens",color:{r:1,g:.56,b:0}}},{texture:!0,title:"Orange doré 6",icon:"",action:"hcs.engine3D.paint",items:[],params:{materialType:"luxens",color:{r:1,g:.82,b:.51}}},{texture:!0,title:"Jaune solaire 1",icon:"",action:"hcs.engine3D.paint",items:[],params:{materialType:"luxens",color:{r:.96,g:.52,b:.21}}},{texture:!0,title:"Jaune solaire 2",icon:"",action:"hcs.engine3D.paint",items:[],params:{materialType:"luxens",color:{r:.8,g:.54,b:.16}}},{texture:!0,title:"Jaune solaire 3",icon:"",action:"hcs.engine3D.paint",items:[],params:{materialType:"luxens",color:{r:1,g:.63,b:0}}},{texture:!0,title:"Jaune solaire 4",icon:"",action:"hcs.engine3D.paint",items:[],params:{materialType:"luxens",color:{r:1,g:.66,b:.22}}},{texture:!0,title:"Jaune solaire 5",icon:"",action:"hcs.engine3D.paint",items:[],params:{materialType:"luxens",color:{r:1,g:.74,b:.29}}},{texture:!0,title:"Jaune solaire 6",icon:"",action:"hcs.engine3D.paint",items:[],params:{materialType:"luxens",color:{r:1,g:.89,b:.61}}},{texture:!0,title:"Jaune pépite 1",icon:"",action:"hcs.engine3D.paint",items:[],params:{materialType:"luxens",color:{r:.67,g:.46,b:.19}}},{texture:!0,title:"Jaune pépite 2",icon:"",action:"hcs.engine3D.paint",items:[],params:{materialType:"luxens",color:{r:.77,g:.6,b:.34}}},{texture:!0,title:"Jaune pépite 3",icon:"",action:"hcs.engine3D.paint",items:[],params:{materialType:"luxens",color:{r:.92,g:.62,b:0}}},{texture:!0,title:"Jaune pépite 4",icon:"",action:"hcs.engine3D.paint",items:[],params:{materialType:"luxens",color:{r:1,g:.73,b:.2}}},{texture:!0,title:"Jaune pépite 5",icon:"",action:"hcs.engine3D.paint",items:[],params:{materialType:"luxens",color:{r:1,g:.78,b:.38}}},{texture:!0,title:"Jaune pépite 6",icon:"",action:"hcs.engine3D.paint",items:[],params:{materialType:"luxens",color:{r:.95,g:.88,b:.69}}},{texture:!0,title:"Jaune louxor 1",icon:"",action:"hcs.engine3D.paint",items:[],params:{materialType:"luxens",color:{r:.77,g:.55,b:.08}}},{texture:!0,title:"Jaune louxor 2",icon:"",action:"hcs.engine3D.paint",items:[],params:{materialType:"luxens",color:{r:1,g:.72,b:0}}},{texture:!0,title:"Jaune louxor 3",icon:"",action:"hcs.engine3D.paint",items:[],params:{materialType:"luxens",color:{r:.94,g:.72,b:0}}},{texture:!0,title:"Jaune louxor 4",icon:"",action:"hcs.engine3D.paint",items:[],params:{materialType:"luxens",color:{r:1,g:.8,b:.19}}},{texture:!0,title:"Jaune louxor 5",icon:"",action:"hcs.engine3D.paint",items:[],params:{materialType:"luxens",color:{r:1,g:.9,b:.4}}},{texture:!0,title:"Jaune louxor 6",icon:"",action:"hcs.engine3D.paint",items:[],params:{materialType:"luxens",color:{r:.98,g:.86,b:.48}}},{texture:!0,title:"Jaune-jaune 1",icon:"",action:"hcs.engine3D.paint",items:[],params:{materialType:"luxens",color:{r:.56,g:.4,b:.12}}},{texture:!0,title:"Jaune-jaune 2",icon:"",action:"hcs.engine3D.paint",items:[],params:{materialType:"luxens",color:{r:.83,g:.68,b:0}}},{texture:!0,title:"Jaune-jaune 3",icon:"",action:"hcs.engine3D.paint",items:[],params:{materialType:"luxens",color:{r:.93,g:.69,b:0}}},{texture:!0,title:"Jaune-jaune 4",icon:"",action:"hcs.engine3D.paint",items:[],params:{materialType:"luxens",color:{r:.94,g:.73,b:0}}},{texture:!0,title:"Jaune-jaune 5",icon:"",action:"hcs.engine3D.paint",items:[],params:{materialType:"luxens",color:{r:.96,g:.87,b:.32}}},{texture:!0,title:"Jaune-jaune 6",icon:"",action:"hcs.engine3D.paint",items:[],params:{materialType:"luxens",color:{r:.94,g:.91,b:.64}}},{texture:!0,title:"Jaune anis 1",icon:"",action:"hcs.engine3D.paint",items:[],params:{materialType:"luxens",color:{r:.55,g:.47,b:.14}}},{texture:!0,title:"Jaune anis 2",icon:"",action:"hcs.engine3D.paint",items:[],params:{materialType:"luxens",color:{r:.71,g:.62,b:.07}}},{texture:!0,title:"Jaune anis 3",icon:"",action:"hcs.engine3D.paint",items:[],params:{materialType:"luxens",color:{r:.76,g:.81,b:0}}},{texture:!0,title:"Jaune anis 4",icon:"",action:"hcs.engine3D.paint",items:[],params:{materialType:"luxens",color:{r:.82,g:.78,b:0}}},{texture:!0,title:"Jaune anis 5",icon:"",action:"hcs.engine3D.paint",items:[],params:{materialType:"luxens",color:{r:.91,g:.79,b:.09}}},{texture:!0,title:"Jaune anis 6",icon:"",action:"hcs.engine3D.paint",items:[],params:{materialType:"luxens",color:{r:.93,g:.91,b:.4}}},{texture:!0,title:"Vert botanique 1",icon:"",action:"hcs.engine3D.paint",items:[],params:{materialType:"luxens",color:{r:.4,g:.35,b:.23}}},{texture:!0,title:"Vert botanique 2",icon:"",action:"hcs.engine3D.paint",items:[],params:{materialType:"luxens",color:{r:.48,g:.49,b:.11}}},{texture:!0,title:"Vert botanique 3",icon:"",action:"hcs.engine3D.paint",items:[],params:{materialType:"luxens",color:{r:.6,g:.58,b:0}}},{texture:!0,title:"Vert botanique 4",icon:"",action:"hcs.engine3D.paint",items:[],params:{materialType:"luxens",color:{r:.64,g:.65,b:.21}}},{texture:!0,title:"Vert botanique 5",icon:"",action:"hcs.engine3D.paint",items:[],params:{materialType:"luxens",color:{r:.71,g:.7,b:.32}}},{texture:!0,title:"Vert botanique 6",icon:"",action:"hcs.engine3D.paint",items:[],params:{materialType:"luxens",color:{r:.82,g:.78,b:.44}}},{texture:!0,title:"Vert kaki 1",icon:"",action:"hcs.engine3D.paint",items:[],params:{materialType:"luxens",color:{r:.34,g:.38,b:.25}}},{texture:!0,title:"Vert kaki 2",icon:"",action:"hcs.engine3D.paint",items:[],params:{materialType:"luxens",color:{r:.45,g:.47,b:.31}}},{texture:!0,title:"Vert kaki 3",icon:"",action:"hcs.engine3D.paint",items:[],params:{materialType:"luxens",color:{r:.58,g:.58,b:.36}}},{texture:!0,title:"Vert kaki 4",icon:"",action:"hcs.engine3D.paint",items:[],params:{materialType:"luxens",color:{r:.58,g:.59,b:.31}}},{texture:!0,title:"Vert kaki 5",icon:"",action:"hcs.engine3D.paint",items:[],params:{materialType:"luxens",color:{r:.67,g:.72,b:.4}}},{texture:!0,title:"Vert kaki 6",icon:"",action:"hcs.engine3D.paint",items:[],params:{materialType:"luxens",color:{r:.75,g:.78,b:.46}}},{texture:!0,title:"Vert pistache 1",icon:"",action:"hcs.engine3D.paint",items:[],params:{materialType:"luxens",color:{r:.21,g:.35,b:.19}}},{texture:!0,title:"Vert pistache 2",icon:"",action:"hcs.engine3D.paint",items:[],params:{materialType:"luxens",color:{r:.32,g:.39,b:.21}}},{texture:!0,title:"Vert pistache 3",icon:"",action:"hcs.engine3D.paint",items:[],params:{materialType:"luxens",color:{r:.43,g:.62,b:0}}},{texture:!0,title:"Vert pistache 4",icon:"",action:"hcs.engine3D.paint",items:[],params:{materialType:"luxens",color:{r:.59,g:.67,b:.13}}},{texture:!0,title:"Vert pistache 5",icon:"",action:"hcs.engine3D.paint",items:[],params:{materialType:"luxens",color:{r:.72,g:.81,b:.36}}},{texture:!0,title:"Vert pistache 6",icon:"",action:"hcs.engine3D.paint",items:[],params:{materialType:"luxens",color:{r:.81,g:.89,b:.35}}},{texture:!0,title:"Vert-vert 1",icon:"",action:"hcs.engine3D.paint",items:[],params:{materialType:"luxens",color:{r:.15,g:.23,b:.17}}},{texture:!0,title:"Vert-vert 2",icon:"",action:"hcs.engine3D.paint",items:[],params:{materialType:"luxens",color:{r:.33,g:.46,b:.18}}},{texture:!0,title:"Vert-vert 3",icon:"",action:"hcs.engine3D.paint",items:[],params:{materialType:"luxens",color:{r:.33,g:.62,b:.21}}},{texture:!0,title:"Vert-vert 4",icon:"",action:"hcs.engine3D.paint",items:[],params:{materialType:"luxens",color:{r:.34,g:.69,b:.13}}},{texture:!0,title:"Vert-vert 5",icon:"",action:"hcs.engine3D.paint",items:[],params:{materialType:"luxens",color:{r:.56,g:.78,b:.25}}},{texture:!0,title:"Vert-vert 6",icon:"",action:"hcs.engine3D.paint",items:[],params:{materialType:"luxens",color:{r:.78,g:.84,b:.61}}},{texture:!0,title:"Vert lagon 1",icon:"",action:"hcs.engine3D.paint",items:[],params:{materialType:"luxens",color:{r:0,g:.29,b:.24}}},{texture:!0,title:"Vert lagon 2",icon:"",action:"hcs.engine3D.paint",items:[],params:{materialType:"luxens",color:{r:.13,g:.44,b:.33}}},{texture:!0,title:"Vert lagon 3",icon:"",action:"hcs.engine3D.paint",items:[],params:{materialType:"luxens",color:{r:0,g:.58,b:.45}}},{texture:!0,title:"Vert lagon 4",icon:"",action:"hcs.engine3D.paint",items:[],params:{materialType:"luxens",color:{r:0,g:.63,b:.55}}},{texture:!0,title:"Vert lagon 5",icon:"",action:"hcs.engine3D.paint",items:[],params:{materialType:"luxens",color:{r:.22,g:.69,b:.64}}},{texture:!0,title:"Vert lagon 6",icon:"",action:"hcs.engine3D.paint",items:[],params:{materialType:"luxens",color:{r:.52,g:.83,b:.81}}},{texture:!0,title:"Vert cèdre 1",icon:"",action:"hcs.engine3D.paint",items:[],params:{materialType:"luxens",color:{r:0,g:.13,b:.12}}},{texture:!0,title:"Vert cèdre 2",icon:"",action:"hcs.engine3D.paint",items:[],params:{materialType:"luxens",color:{r:.23,g:.33,b:.3}}},{texture:!0,title:"Vert cèdre 3",icon:"",action:"hcs.engine3D.paint",items:[],params:{materialType:"luxens",color:{r:.3,g:.47,b:.36}}},{texture:!0,title:"Vert cèdre 4",icon:"",action:"hcs.engine3D.paint",items:[],params:{materialType:"luxens",color:{r:.42,g:.55,b:.47}}},{texture:!0,title:"Vert cèdre 5",icon:"",action:"hcs.engine3D.paint",items:[],params:{materialType:"luxens",color:{r:.56,g:.71,b:.69}}},{texture:!0,title:"Vert cèdre 6",icon:"",action:"hcs.engine3D.paint",items:[],params:{materialType:"luxens",color:{r:.71,g:.82,b:.73}}},{texture:!0,title:"Bleu baltique 1",icon:"",action:"hcs.engine3D.paint",items:[],params:{materialType:"luxens",color:{r:.18,g:.33,b:.41}}},{texture:!0,title:"Bleu baltique 2",icon:"",action:"hcs.engine3D.paint",items:[],params:{materialType:"luxens",color:{r:.25,g:.46,b:.54}}},{texture:!0,title:"Bleu baltique 3",icon:"",action:"hcs.engine3D.paint",items:[],params:{materialType:"luxens",color:{r:.36,g:.56,b:.65}}},{texture:!0,title:"Bleu baltique 4",icon:"",action:"hcs.engine3D.paint",items:[],params:{materialType:"luxens",color:{r:.33,g:.64,b:.66}}},{texture:!0,title:"Bleu baltique 5",icon:"",action:"hcs.engine3D.paint",items:[],params:{materialType:"luxens",color:{r:.49,g:.64,b:.64}}},{texture:!0,title:"Bleu baltique 6",icon:"",action:"hcs.engine3D.paint",items:[],params:{materialType:"luxens",color:{r:.7,g:.78,b:.78}}},{texture:!0,title:"Bleu atoll 1",icon:"",action:"hcs.engine3D.paint",items:[],params:{materialType:"luxens",color:{r:0,g:.31,b:.38}}},{texture:!0,title:"Bleu atoll 2",icon:"",action:"hcs.engine3D.paint",items:[],params:{materialType:"luxens",color:{r:0,g:.46,b:.5}}},{texture:!0,title:"Bleu atoll 3",icon:"",action:"hcs.engine3D.paint",items:[],params:{materialType:"luxens",color:{r:.13,g:.55,b:.6}}},{texture:!0,title:"Bleu atoll 4",icon:"",action:"hcs.engine3D.paint",items:[],params:{materialType:"luxens",color:{r:0,g:.62,b:.71}}},{texture:!0,title:"Bleu atoll 5",icon:"",action:"hcs.engine3D.paint",items:[],params:{materialType:"luxens",color:{r:.19,g:.76,b:.78}}},{texture:!0,title:"Bleu atoll 6",icon:"",action:"hcs.engine3D.paint",items:[],params:{materialType:"luxens",color:{r:.51,g:.73,b:.74}}},{texture:!0,title:"Bleu turquoise 1",icon:"",action:"hcs.engine3D.paint",items:[],params:{materialType:"luxens",color:{r:0,g:.2,b:.3}}},{texture:!0,title:"Bleu turquoise 2",icon:"",action:"hcs.engine3D.paint",items:[],params:{materialType:"luxens",color:{r:0,g:.38,b:.53}}},{texture:!0,title:"Bleu turquoise 3",icon:"",action:"hcs.engine3D.paint",items:[],params:{materialType:"luxens",color:{r:0,g:.48,b:.63}}},{texture:!0,title:"Bleu turquoise 4",icon:"",action:"hcs.engine3D.paint",items:[],params:{materialType:"luxens",color:{r:.13,g:.62,b:.71}}},{texture:!0,title:"Bleu turquoise 5",icon:"",action:"hcs.engine3D.paint",items:[],params:{materialType:"luxens",color:{r:.34,g:.65,b:.71}}},{texture:!0,title:"Bleu turquoise 6",icon:"",action:"hcs.engine3D.paint",items:[],params:{materialType:"luxens",color:{r:.56,g:.81,b:.84}}},{texture:!0,title:"Bleu cyclades 1",icon:"",action:"hcs.engine3D.paint",items:[],params:{materialType:"luxens",color:{r:0,g:.33,b:.53}}},{texture:!0,title:"Bleu cyclades 2",icon:"",action:"hcs.engine3D.paint",items:[],params:{materialType:"luxens",color:{r:0,g:.32,b:.57}}},{texture:!0,title:"Bleu cyclades 3",icon:"",action:"hcs.engine3D.paint",items:[],params:{materialType:"luxens",color:{r:0,g:.49,b:.75}}},{texture:!0,title:"Bleu cyclades 4",icon:"",action:"hcs.engine3D.paint",items:[],params:{materialType:"luxens",color:{r:.18,g:.5,b:.7}}},{texture:!0,title:"Bleu cyclades 5",icon:"",action:"hcs.engine3D.paint",items:[],params:{materialType:"luxens",color:{r:.29,g:.6,b:.78}}},{texture:!0,title:"Bleu cyclades 6",icon:"",action:"hcs.engine3D.paint",items:[],params:{materialType:"luxens",color:{r:.48,g:.76,b:.89}}},{texture:!0,title:"Bleu-bleu 1",icon:"",action:"hcs.engine3D.paint",items:[],params:{materialType:"luxens",color:{r:0,g:.14,b:.36}}},{texture:!0,title:"Bleu-bleu 2",icon:"",action:"hcs.engine3D.paint",items:[],params:{materialType:"luxens",color:{r:0,g:.21,b:.5}}},{texture:!0,title:"Bleu-bleu 3",icon:"",action:"hcs.engine3D.paint",items:[],params:{materialType:"luxens",color:{r:.14,g:.38,b:.66}}},{texture:!0,title:"Bleu-bleu 4",icon:"",action:"hcs.engine3D.paint",items:[],params:{materialType:"luxens",color:{r:.29,g:.52,b:.78}}},{texture:!0,title:"Bleu-bleu 5",icon:"",action:"hcs.engine3D.paint",items:[],params:{materialType:"luxens",color:{r:.4,g:.57,b:.76}}},{texture:!0,title:"Bleu-bleu 6",icon:"",action:"hcs.engine3D.paint",items:[],params:{materialType:"luxens",color:{r:.53,g:.72,b:.87}}},{texture:!0,title:"Bleu orageux 1",icon:"",action:"hcs.engine3D.paint",items:[],params:{materialType:"luxens",color:{r:.06,g:.11,b:.25}}},{texture:!0,title:"Bleu orageux 2",icon:"",action:"hcs.engine3D.paint",items:[],params:{materialType:"luxens",color:{r:.24,g:.27,b:.36}}},{texture:!0,title:"Bleu orageux 3",icon:"",action:"hcs.engine3D.paint",items:[],params:{materialType:"luxens",color:{r:.19,g:.25,b:.56}}},{texture:!0,title:"Bleu orageux 4",icon:"",action:"hcs.engine3D.paint",items:[],params:{materialType:"luxens",color:{r:.25,g:.31,b:.57}}},{texture:!0,title:"Bleu orageux 5",icon:"",action:"hcs.engine3D.paint",items:[],params:{materialType:"luxens",color:{r:.53,g:.63,b:.78}}},{texture:!0,title:"Bleu orageux 6",icon:"",action:"hcs.engine3D.paint",items:[],params:{materialType:"luxens",color:{r:.62,g:.69,b:.8}}},{texture:!0,title:"Violet-violet 1",icon:"",action:"hcs.engine3D.paint",items:[],params:{materialType:"luxens",color:{r:.22,g:.19,b:.28}}},{texture:!0,title:"Violet-violet 2",icon:"",action:"hcs.engine3D.paint",items:[],params:{materialType:"luxens",color:{r:.29,g:.22,b:.36}}},{texture:!0,title:"Violet-violet 3",icon:"",action:"hcs.engine3D.paint",items:[],params:{materialType:"luxens",color:{r:.4,g:.18,b:.44}}},{texture:!0,title:"Violet-violet 4",icon:"",action:"hcs.engine3D.paint",items:[],params:{materialType:"luxens",color:{r:.5,g:.32,b:.57}}},{texture:!0,title:"Violet-violet 5",icon:"",action:"hcs.engine3D.paint",items:[],params:{materialType:"luxens",color:{r:.69,g:.49,b:.73}}},{texture:!0,title:"Violet-violet 6",icon:"",action:"hcs.engine3D.paint",items:[],params:{materialType:"luxens",color:{r:.77,g:.71,b:.85}}},{texture:!0,title:"Violet tulipe 1",icon:"",action:"hcs.engine3D.paint",items:[],params:{materialType:"luxens",color:{r:.24,g:.17,b:.25}}},{texture:!0,title:"Violet tulipe 2",icon:"",action:"hcs.engine3D.paint",items:[],params:{materialType:"luxens",color:{r:.37,g:.25,b:.36}}},{texture:!0,title:"Violet tulipe 3",icon:"",action:"hcs.engine3D.paint",items:[],params:{materialType:"luxens",color:{r:.48,g:.18,b:.41}}},{texture:!0,title:"Violet tulipe 4",icon:"",action:"hcs.engine3D.paint",items:[],params:{materialType:"luxens",color:{r:.62,g:.29,b:.59}}},{texture:!0,title:"Violet tulipe 5",icon:"",action:"hcs.engine3D.paint",items:[],params:{materialType:"luxens",color:{r:.73,g:.47,b:.68}}},{texture:!0,title:"Violet tulipe 6",icon:"",action:"hcs.engine3D.paint",items:[],params:{materialType:"luxens",color:{r:.81,g:.7,b:.82}}},{texture:!0,title:"Violet aubergine 1",icon:"",action:"hcs.engine3D.paint",items:[],params:{materialType:"luxens",color:{r:.22,g:.11,b:.16}}},{texture:!0,title:"Violet aubergine 2",icon:"",action:"hcs.engine3D.paint",items:[],params:{materialType:"luxens",color:{r:.37,g:.2,b:.33}}},{texture:!0,title:"Violet aubergine 3",icon:"",action:"hcs.engine3D.paint",items:[],params:{materialType:"luxens",color:{r:.48,g:.35,b:.4}}},{texture:!0,title:"Violet aubergine 4",icon:"",action:"hcs.engine3D.paint",items:[],params:{materialType:"luxens",color:{r:.55,g:.43,b:.49}}},{texture:!0,title:"Violet aubergine 5",icon:"",action:"hcs.engine3D.paint",items:[],params:{materialType:"luxens",color:{r:.69,g:.58,b:.64}}},{texture:!0,title:"Violet aubergine 6",icon:"",action:"hcs.engine3D.paint",items:[],params:{materialType:"luxens",color:{r:.72,g:.65,b:.71}}},{texture:!0,title:"Violet figue 1",icon:"",action:"hcs.engine3D.paint",items:[],params:{materialType:"luxens",color:{r:.35,g:.14,b:.22}}},{texture:!0,title:"Violet figue 2",icon:"",action:"hcs.engine3D.paint",items:[],params:{materialType:"luxens",color:{r:.46,g:.18,b:.33}}},{texture:!0,title:"Violet figue 3",icon:"",action:"hcs.engine3D.paint",items:[],params:{materialType:"luxens",color:{r:.47,g:.13,b:.31}}},{texture:!0,title:"Violet figue 4",icon:"",action:"hcs.engine3D.paint",items:[],params:{materialType:"luxens",color:{r:.52,g:.3,b:.39}}},{texture:!0,title:"Violet figue 5",icon:"",action:"hcs.engine3D.paint",items:[],params:{materialType:"luxens",color:{r:.62,g:.4,b:.49}}},{texture:!0,title:"Violet figue 6",icon:"",action:"hcs.engine3D.paint",items:[],params:{materialType:"luxens",color:{r:.86,g:.62,b:.77}}},{texture:!0,title:"Rose antique 1",icon:"",action:"hcs.engine3D.paint",items:[],params:{materialType:"luxens",color:{r:.29,g:.13,b:.16}}},{texture:!0,title:"Rose antique 2",icon:"",action:"hcs.engine3D.paint",items:[],params:{materialType:"luxens",color:{r:.42,g:.15,b:.22}}},{texture:!0,title:"Rose antique 3",icon:"",action:"hcs.engine3D.paint",items:[],params:{materialType:"luxens",color:{r:.59,g:.21,b:.36}}},{texture:!0,title:"Rose antique 4",icon:"",action:"hcs.engine3D.paint",items:[],params:{materialType:"luxens",color:{r:.74,g:.45,b:.55}}},{texture:!0,title:"Rose antique 5",icon:"",action:"hcs.engine3D.paint",items:[],params:{materialType:"luxens",color:{r:.82,g:.64,b:.64}}},{texture:!0,title:"Rose antique 6",icon:"",action:"hcs.engine3D.paint",items:[],params:{materialType:"luxens",color:{r:.95,g:.84,b:.84}}},{texture:!0,title:"Rose-rose 1",icon:"",action:"hcs.engine3D.paint",items:[],params:{materialType:"luxens",color:{r:.49,g:.09,b:.31}}},{texture:!0,title:"Rose-rose 2",icon:"",action:"hcs.engine3D.paint",items:[],params:{materialType:"luxens",color:{r:.67,g:.11,b:.38}}},{texture:!0,title:"Rose-rose 3",icon:"",action:"hcs.engine3D.paint",items:[],params:{materialType:"luxens",color:{r:.69,g:.28,b:.51}}},{texture:!0,title:"Rose-rose 4",icon:"",action:"hcs.engine3D.paint",items:[],params:{materialType:"luxens",color:{r:.82,g:.3,b:.6}}},{texture:!0,title:"Rose-rose 5",icon:"",action:"hcs.engine3D.paint",items:[],params:{materialType:"luxens",color:{r:.92,g:.44,b:.69}}},{texture:!0,title:"Rose-rose 6",icon:"",action:"hcs.engine3D.paint",items:[],params:{materialType:"luxens",color:{r:.95,g:.69,b:.8}}},{texture:!0,title:"Rose shocking 1",icon:"",action:"hcs.engine3D.paint",items:[],params:{materialType:"luxens",color:{r:.46,g:.07,b:.2}}},{texture:!0,title:"Rose shocking 2",icon:"",action:"hcs.engine3D.paint",items:[],params:{materialType:"luxens",color:{r:.75,g:.18,b:.37}}},{texture:!0,title:"Rose shocking 3",icon:"",action:"hcs.engine3D.paint",items:[],params:{materialType:"luxens",color:{r:.75,g:.12,b:.36}}},{texture:!0,title:"Rose shocking 4",icon:"",action:"hcs.engine3D.paint",items:[],params:{materialType:"luxens",color:{r:.89,g:.25,b:.42}}},{texture:!0,title:"Rose shocking 5",icon:"",action:"hcs.engine3D.paint",items:[],params:{materialType:"luxens",color:{r:.97,g:.53,b:.71}}},{texture:!0,title:"Rose shocking 6",icon:"",action:"hcs.engine3D.paint",items:[],params:{materialType:"luxens",color:{r:.95,g:.71,b:.76}}}];
return a}(),OutsideComponent3D=function(){var a=function(a){BaseComponent3D.call(this,a,"OutsideComponent3D")};a.prototype=new BaseComponent3D,a.prototype.initialize=function(){var a={title:_("地面"),id:"ground",items:b,layout:"layout-table-60"},d={title:_("天空"),id:"sky",items:c,layout:"layout-table-60"},e={title:_("外界环境"),id:"outside",items:[a,d],layout:"layout-list"};ujs.notify("hcs.menu.main.add",{item:e,menuPath:"furnishing3D",position:1e3})};var b=[{title:"Grid (default)",texture:!0,icon:"",action:"hcs.engine3D.changeGround",id:"0",items:[],params:{materialType:"hcs.MattMaterial",url:"textures/textureset/ground/ground01.jpg",id:"0"}},{title:"Macadam",texture:!0,icon:"",action:"hcs.engine3D.changeGround",id:"1",items:[],params:{materialType:"hcs.MattMaterial",url:"textures/textureset/ground/ground02.jpg",id:"1"}},{title:"Soil",texture:!0,icon:"",action:"hcs.engine3D.changeGround",id:"2",items:[],params:{materialType:"hcs.MattMaterial",url:"textures/textureset/ground/ground03.jpg",id:"2"}},{title:"Grass",texture:!0,icon:"",action:"hcs.engine3D.changeGround",id:"3",items:[],params:{materialType:"hcs.MattMaterial",url:"textures/textureset/ground/ground04.jpg",id:"3"}},{title:"Grass 2",texture:!0,icon:"",action:"hcs.engine3D.changeGround",id:"4",items:[],params:{materialType:"hcs.MattMaterial",url:"textures/textureset/ground/ground05.jpg",id:"4"}},{title:"Grass 3",texture:!0,icon:"",action:"hcs.engine3D.changeGround",id:"5",items:[],params:{materialType:"hcs.MattMaterial",url:"textures/textureset/ground/ground06.jpg"}},{title:"Grass 4",texture:!0,icon:"",action:"hcs.engine3D.changeGround",id:"6",items:[],params:{materialType:"hcs.MattMaterial",url:"textures/textureset/ground/ground07.jpg"}},{title:"Grass 5",texture:!0,icon:"",action:"hcs.engine3D.changeGround",id:"7",items:[],params:{materialType:"hcs.MattMaterial",url:"textures/textureset/ground/ground08.jpg"}},{title:"Grass 6",texture:!0,icon:"",action:"hcs.engine3D.changeGround",id:"8",items:[],params:{materialType:"hcs.MattMaterial",url:"textures/textureset/ground/ground09.jpg"}},{title:"Soil",texture:!0,icon:"",action:"hcs.engine3D.changeGround",id:"9",items:[],params:{materialType:"hcs.MattMaterial",url:"textures/textureset/ground/ground10.jpg"}},{title:"Gray gravel",texture:!0,icon:"",action:"hcs.engine3D.changeGround",id:"10",items:[],params:{materialType:"hcs.MattMaterial",url:"textures/textureset/ground/ground11.jpg"}},{title:"Brick",texture:!0,icon:"",action:"hcs.engine3D.changeGround",id:"11",items:[],params:{materialType:"hcs.MattMaterial",url:"textures/textureset/ground/ground12.jpg"}},{title:"Brick 2",texture:!0,icon:"",action:"hcs.engine3D.changeGround",id:"12",items:[],params:{materialType:"hcs.MattMaterial",url:"textures/textureset/ground/ground13.jpg"}},{title:"Brick 3",texture:!0,icon:"",action:"hcs.engine3D.changeGround",id:"13",items:[],params:{materialType:"hcs.MattMaterial",url:"textures/textureset/ground/ground14.jpg"}},{title:"Brick 4",texture:!0,icon:"",action:"hcs.engine3D.changeGround",id:"14",items:[],params:{materialType:"hcs.MattMaterial",url:"textures/textureset/ground/ground15.jpg"}}],c=[{title:"Default sky",texture:!0,icon:"",action:"hcs.engine3D.changeSky",id:"0",items:[],params:{materialType:"lambert",url:"textures/textureset/sky/sky01.jpg"}},{title:"Sky 1",texture:!0,icon:"",action:"hcs.engine3D.changeSky",id:"1",items:[],params:{materialType:"lambert",url:"textures/textureset/sky/sky02.jpg"}},{title:"Sky 2",texture:!0,icon:"",action:"hcs.engine3D.changeSky",id:"2",items:[],params:{materialType:"lambert",url:"textures/textureset/sky/sky03.jpg"}},{title:"Sky 3",texture:!0,icon:"",action:"hcs.engine3D.changeSky",id:"3",items:[],params:{materialType:"lambert",url:"textures/textureset/sky/sky04.jpg"}}];return a}(),ObjectComponent3D=function(){function a(a){a.traverse(function(a){hcsdesign.engine3D.castShadows(a),a.receiveShadows=!0})}var b,c=(new BABYLON.Vector3(50,50,50),new BABYLON.Vector3(0,0,0),"js/Components/CoreComponents/Object/Programmable/"),d=null,e=-1,f=(ujs.getById("container3d"),function(a){BaseComponent3D.call(this,a,"ObjectComponent3D"),d=a.version,b=this});return f.prototype=new BaseComponent3D,f.prototype.initialize=function(){xmlHttp=new XMLHttpRequest,xmlHttp.open("GET","data/1/categories.json",!1),xmlHttp.send(null),productsMenu=JSON.parse(xmlHttp.responseText),ujs.notify("hcs.menu.main.add",{item:productsMenu,menuPath:"1",position:0})},f.prototype.onFloorReady=function(a){for(var c=a.floor||b.getFloor(),d=a.structure||hcsdesign.getSelectedStructure(),e=d.getElements("objects"),f=0;f<e.length;f++)e[f].isRecentlyAdded=!1,b.buildObject(e[f],e[f].programmableInstance,c)},f.prototype.loadProgrammableFile=function(a,b,e){var f=b||a+".js";"undefined"==typeof hcs.Programmable[a]?HTMLHelper.addScript(c+f+"?t="+d,void 0,e):e(void 0)},f.prototype.startListening=function(){document.addEventListener("hcs.request.floorSelected",this.onFloorChanged,!1),document.addEventListener("hcs.engine3d.floorReady",this.onFloorReady,!1),document.addEventListener("hcs.engine3D.addObject",this.onAddObject,!1),document.addEventListener("hcs.engine3D.addGroup",this.onAddGroup,!1),document.addEventListener("hcs.engine3D.addProgrammable",this.onAddObject,!1),document.addEventListener("hcs.engine3D.object.remove",this.onRemoveObject,!1)},f.prototype.stopListening=function(){document.removeEventListener("hcs.request.floorSelected",this.onFloorChanged,!1),document.removeEventListener("hcs.engine3d.floorReady",this.onFloorReady,!1),document.removeEventListener("hcs.engine3D.addObject",this.onAddObject),document.removeEventListener("hcs.engine3D.addGroup",this.onAddGroup),document.removeEventListener("hcs.engine3D.addProgrammable",this.onAddObject,!1),document.removeEventListener("hcs.engine3D.object.remove",this.onRemoveObject,!1)},f.prototype.onAddGroup=function(a){var c=a.objectParams,d=JSON.parse(c.params),e=JSON.parse(c.materials),f=(new Date).getTime(),g=b.getFloor(),h=hcsdesign.getComponentByName("AvatarComponent3D",this.engine3D),i=h.avatar.position.clone();i.y-=5+ +g.position.y;for(var j in d)a.objectType=d[j].type||"programmable",d[j].position.z*=-1,a.position=i.add(d[j].position),a.rotation=d[j].rotation,a.objectParams={params:d[j].params,builder_id:d[j].builder_id,path:d[j].filename,materials:JSON.stringify(e[j]),customData:{groupId:f}},b.onAddObject(a)},f.prototype.onAddObject=function(a){var c=hcsdesign.getSelectedStructure(),d=b.getFloor(),e=a.objectParams,f=new ObjectStructure;if(f.builderId=e.builder_id,"string"==typeof e.params&&""!==e.params&&(e.params=JSON.parse(e.params)),"string"==typeof e.materials&&""!==e.materials&&(e.materials="[]"===e.materials?{}:ujs.deserializeObject(JSON.parse(e.materials))),e.customData&&(f.customData=e.customData),f.filename=e.path,f.baseUrl=e.baseUrl||null,a.position)f.position.x=a.position.x,f.position.y=a.position.y,f.position.z=a.position.z;else{var g=hcsdesign.getComponentByName("AvatarComponent3D",this.engine3D);avatarPosition=g.avatar.position,f.position.x=avatarPosition.x,f.position.z=avatarPosition.z,f.position.y+=5}a.rotation&&(f.rotation.x=a.rotation.x,f.rotation.y=a.rotation.y,f.rotation.z=a.rotation.z),c.insertElement("objects",f),f.isRecentlyAdded=!0,b.buildObject(f,e,d)},f.prototype.onRemoveObject=function(a){for(var b,c=0;c<hcsdesign.structure.getLength();c++)b=hcsdesign.structure.getElement(c),b.removeElement("objects",a.structure)},f.prototype.refreshObject=function(a,b){for(var c=a.structure.programmableInstance,d=(a.getFloor(),a.getChildren()),e=d.length;e--;)d[e].dispose();this.buildObject(a.structure,c,a.parent,function(c){a.position=c.position,a.rotation=c.rotation,a.parent=c.parent;for(var d=c.getVerticesDataKinds(),e=d.length;e--;)a.setVerticesData(d[e],c.getVerticesData(d[e]).slice());if(a.setIndices(c.getIndices().slice()),c._vertexBuffers){var f=BABYLON.Tools.ExtractMinAndMax(c.getVerticesData(BABYLON.VertexBuffer.PositionKind),0,c.getTotalVertices());a._boundingInfo=new BABYLON.BoundingInfo(f.minimum,f.maximum)}a.material=c.material;for(var g=c.getChildren(),e=g.length;e--;)g[e].parent=a;a.computeWorldMatrix(!0),a.getBoundingBox(!0),c.silentDispose=!0,c.dispose(),c.silentDispose=!1,ujs.notify("hcs.engine3D.object.refresh",{object:a}),b&&b(a)},!0)},f.prototype.buildObject=function(a,c,d,e,f){var g,e=e||function(){},d=d||b.getFloor();a.programmableInstance?g=a.programmableInstance.materials:c.materials&&(g=c.materials);var h,i=function(c){return c?(a.programmableInstance=h,a.objectInstance=c,void b.addObjectToScene(c,a,d,e,f)):(Logger.warning("[ObjectComponent3D] onObject3dLoaded : unable to build the following object : "),void Logger.warning(h))},j=a.baseUrl||null;a.filename&&hcs.Programmable.createInstance(a.filename,c,g,a,function(a){if(h=a,h.async)h.getObject3D(hcsdesign.engine3D.scene,i);else{var b=h.getObject3D(hcsdesign.engine3D.scene);i(b)}},j,b.engine3D)},f.prototype.addObjectToScene=function(a,c,d,e,f){var e=e||function(){};return b.prepareObject3D(a,c,d),e(a),f||ujs.notify("hcs.engine3D.object.create",{object:a,objectStructure:c}),a},f.prototype.prepareObject3D=function(c,d,f){c.structure=d,c.name="Object_"+ ++e,d.id=e,c.parent=f,c.position.copyFrom(d.position),c.rotation.copyFrom(d.rotation),c.scaling.copyFrom(d.scaling),d.position=c.position,d.rotation=c.rotation,d.scaling=c.scaling,d.position.x=+d.position.x,d.position.y=+d.position.y,d.position.z=+d.position.z,d.rotationQuaternion&&(c.rotationQuaternion=d.rotationQuaternion),c.structure.group&&(c.parent=c.structure.group,c.changeFrame(f)),c.computeWorldMatrix(!0),f.markAsDirty(),c.isDecorable=!0,c.decorate=d.programmableInstance.decorate.bind(c),c.animate=d.programmableInstance.animate.bind(d.programmableInstance);var g=d.programmableInstance.materials;if(d.programmableInstance.getDefaultMaterials){var h=d.programmableInstance.getDefaultMaterials(hcsdesign.engine3D.scene);g=ujs.mergeObjects(h,d.programmableInstance.materials)}c.initMaterials(g),c.onDispose=function(){c.silentDispose||ujs.notify("hcs.engine3D.object.dispose",{object:c})},a(c);var i=hcsdesign.getComponentByName("EditionComponent3D");return i&&b.getFloor().structureId==f.structureId&&i.addDraggable(c),c},f}(),EditionComponent3D=function(){var a=null,b=!1,c=-1,d=null,e=!1,f=1,g=2,h=4,i=8,j=[],k=function(b){BaseComponent3D.call(this,b,"EditionComponent3D"),a=this,this.scene=hcsdesign.engine3D.scene,this.camera=hcsdesign.engine3D.camera,this.rotatorWidget=new hcs.Widget.Rotator(this),this.infoWidget=new hcs.Widget.Info(this),this.infoWidget.setClickCallback(this.onIAction.bind(this)),this.elevationWidget=new hcs.Widget.Elevation(this),this.cloneWidget=new hcs.Widget.Clone(this),this.groupWidget=new hcs.Widget.Group(this),this.removeWidget=new hcs.Widget.Remove(this),this.widgets=[],this.widgets.push(this.rotatorWidget),this.widgets.push(this.infoWidget),this.widgets.push(this.elevationWidget),this.widgets.push(this.cloneWidget),this.widgets.push(this.removeWidget),this.widgets.push(this.groupWidget),this.dragControl=new hcs.DragControls(this.scene,hcsdesign.engine3D.canvas),this.dragControl.constrains("xz"),this.addUnremovableDraggable=this.dragControl.addUnremovableDraggable,this.addDraggable=this.dragControl.addDraggable,this.removeDraggable=this.dragControl.removeDraggable,this.resetDraggable=this.dragControl.resetDraggable};k.prototype=new BaseComponent3D,k.prototype.addWidget=function(a){return this.widgets.push(a),a},k.prototype.on=function(b,c){return j[b]||(j[b]=[]),j[b].push(c),a},k.prototype.off=function(b,c){var d=j[b];return d?(d.indexOf(c)>-1&&d.splice(c,1),a):a};var l=function(a,b){var c=j[a];if(c)for(var d=0;d<c.length;d++)c[d](b)};k.prototype.initialize=function(){this.ephemeralInfos=document.getElementById("ephemeralInfos"),this.historycmp=null,this.MOVEACTION=0,this.ROTATEACTION=1,this.GROUPACTION=3,this.DELETEACTION=4,this.ADDACTION=5,this.isViewer||(this.dragControl.on("mousedown",function(b){b.hit&&(a.camera.enabled=!1,ujs.notify("hcs.engine3D.editorComponent.hideEditBox"))},!1),this.dragControl.on("mouseup",function(){a.camera.enabled=!0},!1)),this.setupHistory()},k.prototype.startListening=function(){this.onMouseDown=this.onMouseDown.bind(this),this.onMouseMove=this.onMouseMove.bind(this),this.onMouseUp=this.onMouseUp.bind(this),this.onClick=this.onClick.bind(this),this.onDoubleClick=this.onDoubleClick.bind(this),this.onGroup=this.onGroup.bind(this),this.onKeyDown=this.onKeyDown.bind(this),this.onCloneObject=this.onCloneObject.bind(this),this.onAddToProducts=this.onAddToProducts.bind(this),this.onRemoveObject=this.onRemoveObject.bind(this),this.onCreateObject=this.onCreateObject.bind(this),this.onDisposeObject=this.onDisposeObject.bind(this),this.onFloorChanged=this.onFloorChanged.bind(this),this.onNewPlan=this.onNewPlan.bind(this),this.onDragEnd=this.onDragEnd.bind(this),this.onDragging=this.onDragging.bind(this),this.onDragStart=this.onDragStart.bind(this),hcsdesign.engine3D.canvas.addEventListener("pointerdown",this.onMouseDown,!1),hcsdesign.engine3D.canvas.addEventListener("pointermove",this.onMouseMove,!1),hcsdesign.engine3D.canvas.addEventListener("pointerup",this.onMouseUp,!1),this.dragControl.on("dragstart",this.onDragStart),this.dragControl.on("drag",this.onDragging),this.dragControl.on("dragend",this.onDragEnd),document.addEventListener("hcs.engine3D.click.collided",this.onClick,!1),document.addEventListener("hcs.engine3D.dblclick.collided",this.onDoubleClick,!1),document.addEventListener("hcs.engine3D.contextMenu.group",this.onGroup,!1),document.addEventListener("hcs.keyboardManager.keyDown",this.onKeyDown,!0),document.addEventListener("hcs.request.object.clone",this.onCloneObject,!1),document.addEventListener("hcs.request.object.addToProducts",this.onAddToProducts,!1),document.addEventListener("hcs.request.object.remove",this.onRemoveObject,!1),document.addEventListener("hcs.engine3D.object.create",this.onCreateObject,!1),document.addEventListener("hcs.engine3D.object.refresh",this.onRefreshObject,!1),document.addEventListener("hcs.engine3D.object.dispose",this.onDisposeObject,!1),document.addEventListener("hcs.engine3d.globaleFloorReady",this.onFloorChanged,!1),document.addEventListener("hcs.request.newPlanReady",this.onNewPlan,!1)},k.prototype.stopListening=function(){hcsdesign.engine3D.canvas.removeEventListener("pointerdown",this.onMouseDown),hcsdesign.engine3D.canvas.removeEventListener("pointermove",this.onMouseMove,!1),hcsdesign.engine3D.canvas.removeEventListener("pointerup",this.onMouseUp,!1),this.dragControl.off("dragstart",this.onDragStart),this.dragControl.off("drag",this.onDragging),this.dragControl.off("dragend",this.onDragEnd),document.removeEventListener("hcs.engine3D.click.collided",this.onClick,!1),document.removeEventListener("hcs.engine3D.dblclick.collided",this.onDoubleClick,!1),document.removeEventListener("hcs.engine3D.contextMenu.group",this.onGroup,!1),document.removeEventListener("hcs.keyboardManager.keyDown",this.onKeyDown,!0),document.removeEventListener("hcs.request.object.clone",this.onCloneObject,!1),document.removeEventListener("hcs.request.object.addToProducts",this.onAddToProducts,!1),document.removeEventListener("hcs.request.object.remove",this.onRemoveObject,!1),document.removeEventListener("hcs.engine3D.object.create",this.onCreateObject,!1),document.removeEventListener("hcs.engine3D.object.dispose",this.onDisposeObject,!1),document.removeEventListener("hcs.engine3d.globaleFloorReady",this.onFloorChanged,!1),document.removeEventListener("hcs.request.newPlan",this.onNewPlan,!1),this.disableWidget()},k.prototype.onIAction=function(){var a=this.getSelectedObject();ujs.notify(this.isGroup(a)?"hcs.request.groupConfigurator.start":"hcs.request.configurator.start")},k.prototype.onMouseDown=function(a){a.collided=hcsdesign.engine3D.collideWithScene(a.clientX,a.clientY),l("mousedown",a);var b=hcsdesign.engine3D.keyboardManager.isPressed([17,91,224]);this.dragControl.constrains(b?"y":"xz")},k.prototype.onMouseUp=function(a){l("mouseup",a)},k.prototype.onMouseMove=function(a){l("mousemove",a)},k.prototype.onDragStart=function(a){var b=a.pickedMesh;a.oldPosition=b.position.clone(),a.oldRotation=b.rotation.clone(),l("dragstart",{object:b})},k.prototype.onDragEnd=function(b){var c=b.pickedMesh;l("dragend",{object:c}),a.ephemeralInfos.classList.add("hidden");var d=c.getTopLevelObject(!0);ujs.notify("hcs.request.historyAction",{component:a,object:d,params:{oldPosition:b.oldPosition,newPosition:c.position.clone(),oldRotation:b.oldRotation,newRotation:c.rotation.clone()},action:a.MOVEACTION})},k.prototype.onDragging=function(b){var c=b.pickedMesh;l("dragging",{object:c});var d=c.position,e="<table>";e+="<tr>",e+="<td>x: "+Math.round(d.x)+"</td>",e+="<td>z: "+Math.round(d.z)+"</td>",e+="<td>"+_("elevation:")+Math.round(d.y)+"</td>",e+="</tr>",a.ephemeralInfos.innerHTML=e,a.ephemeralInfos.classList.remove("hidden")},k.prototype.onClick=function(c){if(this.engine3D.mode==this.engine3D.MODE_NORMAL&&(l("click",c),!e)){var d=c.collided;if(d&&d.hit){a.dragControl.setDraggingMode(a.dragControl.GROUPS);var f=hcsdesign.engine3D.keyboardManager.isPressed([17,91,224]),g=d.pickedMesh.getTopLevelObject();if(this.isGroup(g)||this.isSelectableObject(g)){if(f)this.addToGroup(g,this.getSelectedObject()),this.deselectObject(),g=d.pickedMesh.getTopLevelObject();else{var h=d.pickedMesh.getTopLevelObject(!0);(h.parent===this.getSelectedObject()||h===this.getSelectedObject())&&(this.deselectObject(),g=h,a.dragControl.setDraggingMode(a.dragControl.OBJECTS))}this.centerGroup(g),this.selectObject(g),2==c.button&&l("special")}else this.deleteGroup(),this.deselectObject();g!==b&&this.deleteGroup()}}},k.prototype.onDoubleClick=function(a){var b=a.collided?a.collided.pickedMesh.getTopLevelObject(!0):null,c=b?b.animate:null;c&&c(b,a.collided.pickedMesh)},k.prototype.onKeyDown=function(b){var c=hcsdesign.engine3D.keyboardManager.isPressed([17,91,224]);c&&d&&68==b.keyCode&&a.onCloneObject(),46==b.keyCode&&a.getSelectedObject()&&ujs.notify("hcs.request.object.remove",{object:a.getSelectedObject(),structure:a.getSelectedObject().structure})},k.prototype.onRemoveObject=function(b){a.removeObject(b.object||a.getSelectedObject())},k.prototype.onNewPlan=function(){a.deselectObject()},k.prototype.onCreateObject=function(b){var c,d=b.objectStructure.customData.groupId,e=b.object.getFloor();void 0!==d&&null!==d?(c=e.getChildByName("group_"+d),c||(c=a.createGroup(d,e),b.object.structure.isRecentlyAdded&&this.addHistory(c,{floor:e,isGroup:!0},a.ADDACTION)),a.addToGroup(b.object,c,!0),a.setGroupId(b.object,d)):b.object.structure.isRecentlyAdded&&this.addHistory(b.object,{floor:e},a.ADDACTION),b.object.traverse(function(a){a.isVisible&&(a.wasVisible=!0)})},k.prototype.onRefreshObject=function(a){a.object===d&&l("refresh",a)},k.prototype.onDisposeObject=function(a){l("dispose",a.object),a.object===d&&this.deselectObject()},k.prototype.onFloorChanged=function(){a.deselectObject(),a.resetDraggable()},k.prototype.lock=function(b,c){e&&e!==b||(c="undefined"!=typeof c?c:g+f+h+i,c&g&&(this.dragControl.enabled=!1,this.dragControl.reset()),c&f&&(this.camera.enabled=!1),c&i&&(a.camera.cameraTranslationenabled=!1),hcsdesign.keyboardManager&&c&h&&(hcsdesign.keyboardManager.preventDefault=!1),e=b)},k.prototype.unlock=function(b,c){e&&e!==b&&b!==this||(c="undefined"!=typeof c?c:g+f+h+i,c&g&&(this.dragControl.enabled=!0,this.dragControl.reset()),c&f&&(this.camera.enabled=!0),c&i&&(a.camera.cameraTranslationenabled=!0),hcsdesign.keyboardManager&&c&h&&(hcsdesign.keyboardManager.preventDefault=!0),e=null)},k.prototype.disableWidget=function(){l("deselectObject")},k.prototype.enableWidget=function(){d&&l("selectObject",{object:d})},k.prototype.getLocker=function(){return e},k.prototype.isGroup=function(a){return-1!==a.name.indexOf("group_")},k.prototype.isVirtualGroup=function(a){return a&&a.name.indexOf("group_virtual")>=0},k.prototype.isSelectableObject=function(a){return-1!==a.name.indexOf("Object_")},k.prototype.getSelectedObject=function(){return d},k.prototype.selectObject=function(a){d=a,l("selectObject",{object:a})},k.prototype.deselectObject=function(){l("deselectObject"),d=null},k.prototype.moveObject=function(b,c){if(a.isSelectableObject(b)||a.isGroup(b)){b.position.addInPlace(c);var d=b.getFloor();d&&d.markAsDirty(),l("objectMoves",{object:b,delta:c}),ujs.notify("hcs.engine3D.object.translate",{object:b})}},k.prototype.rotateObject=function(b,c){(a.isSelectableObject(b)||a.isGroup(b))&&(b.rotation.addInPlace(c),l("objectRotates",{object:b,delta:c}),ujs.notify("hcs.engine3D.object.rotate",{object:b}))};var m=function(b,c){var d=c.pickedMesh.material.subMaterials?c.pickedMesh.material.subMaterials[c.pickedSubMeshIndex]:c.pickedMesh.material;if(a.isGroup(this))for(var e=this.getChildren(),f=0,g=e.length;g>f;f++)e[f].decorate&&e[f].decorate(b,c);return d};return k.prototype.createGroup=function(b,d){var e;return null!==b&&void 0!==b?(e=new BABYLON.Mesh("group_"+b,hcsdesign.engine3D.scene),a.setGroupId(e,b),c=Math.max(c,b)):e=new BABYLON.Mesh("group_virtual",hcsdesign.engine3D.scene),e.isDecorable=!0,e.decorate=m.bind(e),e.isVisible=!1,e.parent=d,this.addDraggable(e),e},k.prototype.mergeGroup=function(b,c){var d=!!c&&this.isGroup(c),e=!!b&&this.isGroup(b);if(d&&(!e||e&&this.isVirtualGroup(b)))return this.mergeGroup(c,b);var f,g=e?b.getChildren():b?[b]:[],h=d?c.getChildren():c?[c]:[];f=e?b:a.createGroup(null,b.parent),d&&this.deleteGroup(c);for(var i=g.concat(h),j=i.length;j--;)f.getChildByName(i[j].name)||(i[j].changeFrame(i[j].parent),i[j].changeFrame(f),i[j].structure.group=f,this.isVirtualGroup(f)||this.setGroupId(i[j],f.groupId));return f},k.prototype.addToGroup=function(c,d,e){c&&(d=this.mergeGroup(c,d||b),b=this.isVirtualGroup(d)?d:!1,e||this.addHistory(c,{wasAdd:1,object:c,group:d},a.GROUPACTION))},k.prototype.removeFromGroup=function(c,d){var d=d||b;if(d&&c.parent===d){var e=d.parent,f=d.getWorldMatrix().clone(),g=e.getWorldMatrix().clone();g.invert();var h=f.multiply(g);c.parent=e,c.position.copyFrom(BABYLON.Vector3.TransformCoordinates(c.position,h)),c.rotation.addInPlace(d.rotation),c.rotation.subtractInPlace(d.parent.rotation),a.removeGroupId(c),c.changeFrame(d.parent)}},k.prototype.deleteGroup=function(c,d){var c=c||b;if(c){a.removeGroupId(c);var e=c.parent,f=c.getChildren().slice(),g=c.getWorldMatrix().clone(),h=e.getWorldMatrix().clone();h.invert();for(var i=g.multiply(h),j=0,k=f.length;k>j;j++)f[j].parent=e,f[j].position.copyFrom(BABYLON.Vector3.TransformCoordinates(f[j].position,i)),f[j].rotation.addInPlace(c.rotation),f[j].rotation.subtractInPlace(c.parent.rotation);this.removeDraggable(c),c.dispose(),c===b&&(b=null),d&&this.addHistory(c,{component:a,params:{wasAdd:0,object:f,group:c},action:a.GROUPACTION},a.GROUPACTION)}},k.prototype.deleteSelectedGroup=function(){a.deleteGroup(d),a.deselectObject()},k.prototype.centerGroup=function(a){if(a&&this.isGroup(a)){var b=a.getBoundingBox(!0).center.clone();b.y=a.getBoundingBox().minimum.y;var c=a.getChildren(),d=a.getWorldMatrix().clone(),e=a.parent.getWorldMatrix().clone();e.invert();for(var f=d.multiply(e),g=BABYLON.Vector3.TransformNormal(b,f),h=c.length-1;h>=0;h--){var i=c[h];i.position.subtractInPlace(b),i.computeWorldMatrix(!0)}a.position.addInPlace(g),a.computeWorldMatrix(!0),a.getFloor().markAsDirty()}},k.prototype.refreshObject=function(a,b){b=b||{};var c=hcsdesign.getComponentByName("ObjectComponent3D");!b.noHistory&&b.modifiedProperties&&ujs.notify("hcs.request.historyAction",{component:this,object:a,params:b.modifiedProperties||{},action:this.REFRESHACTION}),c.refreshObject(a,b.callback)},k.prototype.setGroupId=function(b,c){if(a.isGroup(b)){b.groupId=c;for(var d=b.getChildren(),e=0,f=d.length;f>e;e++)a.setGroupId(d[e],c)}else a.isSelectableObject(b)&&(b.structure.customData.groupId=c)},k.prototype.removeGroupId=function(b){if(a.isGroup(b))for(var c=b.getChildren(),d=0,e=c.length;e>d;d++)a.removeGroupId(c[d]);else a.isSelectableObject(b)&&(b.structure.customData.groupId=null,b.structure.group=null)},k.prototype.virtualToRealGroup=function(){b&&(b.name="group_"+ ++c,a.setGroupId(b,c),b=null)},k.prototype.onGroup=function(b){b.value?a.virtualToRealGroup(b):a.deleteSelectedGroup()},k.prototype.onCloneGroup=function(b){var d=b.getChildren(),e=hcsdesign.getComponentByName("ObjectComponent3D");a.virtualToRealGroup(),a.deleteGroup(),a.deselectObject();var f=a.createGroup(++c,b.getFloor());f.computeWorldMatrix(!0);var g=b.getBoundingBox(),h=new BABYLON.Vector3(g.maximum.x-g.minimum.x,0,0);h=BABYLON.Vector3.TransformNormal(h,b.getWorldMatrix());for(var i=0,j=d.length;j>i;i++){var k=d[i];if(a.isSelectableObject(k)){var l=k.structure.clone();hcsdesign.getSelectedStructure().insertElement("objects",l);var m=function(b){a.deselectObject(),b.position.addInPlace(h),a.selectObject(b),ujs.notify("hcs.request.saveHistory")};l.customData.groupId=f.groupId,e.buildObject(l,l.programmableInstance,k.getFloor(),m)}}},k.prototype.onCloneObject=function(){var b=hcsdesign.getComponentByName("ObjectComponent3D"),c=d;if(null!=c)if(a.isGroup(c))a.onCloneGroup(c);else if(a.isSelectableObject(c)){var e=c.structure.clone();hcsdesign.getSelectedStructure().insertElement("objects",e);var f=function(b){a.deselectObject(),a.selectObject(b);var c=b.getBoundingBox(),d=new BABYLON.Vector3(c.maximum.x-c.minimum.x,0,0);d=BABYLON.Vector3.TransformNormal(d,b.getWorldMatrix()),b.position.addInPlace(d),ujs.notify("hcs.request.saveHistory"),ujs.notify("hcs.engine3D.object.clone")};b.buildObject(e,e.programmableInstance,c.getFloor(),f)}},k.prototype.removeObject=function(b,c){if(b){this.deselectObject();var d=b.getFloor();if(this.isGroup(b)){var e=b.getChildren();b.isDeleted=!0,this.addHistory(b,{floor:d,isGroup:!0},a.DELETEACTION);for(var f=0,g=e.length;g>f;f++)this.removeObject(e[f],!0)}else d.structure.removeElement("objects",b.structure),c||(this.addHistory(b,{floor:d},a.DELETEACTION),b.structure.isDeleted=!0),b.traverse(function(a){a.isVisible&&(a.wasVisible=!0),a.isVisible=!1})}},k.prototype.onAddToProducts=function(){var b=hcs.Constants.BACK_URL+"ws/add-model";if(d&&d.structure&&a.isSelectableObject(d)){var c=d.structure,e=c.filename||"object";ujs.ajax({method:"POST",url:b,withCredentials:!0,params:"action=add&model=model&is_active=0&name="+e+"&encoded=1&builder_id="+c.builderId+"&params="+JSON.stringify(c.programmableInstance.params)+"&materials="+JSON.stringify(ujs.serializeObject(c.programmableInstance.materials)),success:function(a){Logger.message(a),hcs.UI.MessageBox.show({title:_("Object added"),message:_("Object is now available in the backoffice"),buttonAText:_("Close"),buttonA:!0})}})}else if(d&&a.isGroup(d)){for(var f=d,g={},h={},e="Group",i=0;i<f.getChildren().length;i++){var j=f.getChildren()[i];if(j.structure&&-1!==j.name.indexOf("Object_")){var k=j.position.clone();g[i]={builder_id:j.structure.builderId,type:j.structure.type,filename:j.structure.filename,params:j.structure.programmableInstance.params,rotation:{x:j.rotation.x,y:j.rotation.y,z:j.rotation.z},position:{x:k.x,y:k.y+f.position.y,z:k.z}},h[i]=ujs.serializeObject(j.structure.programmableInstance.materials)}}ujs.ajax({method:"POST",url:b,withCredentials:!0,params:"action=add&model=model&is_active=0&name="+e+"&encoded=1&builder_id=0&params="+JSON.stringify(g)+"&materials="+JSON.stringify(h),success:function(a){Logger.message(a)}})}},k.prototype.update=function(){},k.prototype.addHistory=function(a,b,c){if(this.historycmp)switch(c){case this.MOVEACTION:case this.ROTATEACTION:case this.GROUPACTION:case this.DELETEACTION:case this.ADDACTION:case this.REFRESHACTION:default:"avatar"!==a.id&&this.historycmp.actionDone(a,b,c,this)}},k.prototype.undoMove=function(b,c){a.historyMove(b,c.oldPosition,c.oldRotation)},k.prototype.redoMove=function(b,c){a.historyMove(b,c.newPosition,c.newRotation)},k.prototype.undoRotate=k.prototype.undoMove,k.prototype.redoRotate=k.prototype.redoMove,k.prototype.historyMove=function(a,b,c){a.position.copyFromFloats(b.x,b.y,b.z),a.rotation.copyFromFloats(c.x,c.y,c.z),ujs.notify("hcs.request.saveHistory"),ujs.notify("hcs.engine3D.object.translate",{object:a}),ujs.notify("hcs.engine3D.object.rotate",{object:a})},k.prototype.undoRefresh=function(b,c){a.historyRefresh(b,c,"exValue")},k.prototype.redoRefresh=function(b,c){a.historyRefresh(b,c,"newValue")},k.prototype.historyRefresh=function(a,b,c){var d=hcsdesign.getComponentByName("ObjectComponent3D");for(var e in b)"position"==e?(a.position.copyFrom(b[e][c]),a.structure.position=a.position):ujs.setProperty(a.structure,e,b[e][c]);d.refreshObject(a)},k.prototype.undoGroup=function(b,c){a.historyGroup(b,c)},k.prototype.redoGroup=function(b,c){a.historyGroup(b,c)},k.prototype.historyGroup=function(b,c){c.wasAdd?(a.deselectObject(),2==c.group.getChildren().length?a.deleteGroup(c.group,!0):a.removeFromGroup(c.object,c.group,!0)):a.addToGroup(c.object,c.group,!0)},k.prototype.undoDelete=function(b,c){a.historyDelete(b,c)},k.prototype.redoDelete=function(b,c){a.historyDelete(b,c)},k.prototype.undoAdd=k.prototype.redoDelete,k.prototype.redoAdd=k.prototype.undoDelete,k.prototype.historyDelete=function(a,b){b.isGroup?a.isDeleted=!a.isDeleted:a.structure.isDeleted=!a.structure.isDeleted;var c=b.isGroup?a.isDeleted:a.structure.isDeleted;if(a.traverse(function(a){a.isVisible=!c&&a.wasVisible}),b.isGroup)for(var d=a.getChildren(),e=0;e<d.length;e++)c?b.floor.structure.removeElement("objects",d[e].structure):b.floor.structure.insertElement("objects",d[e].structure);else c?b.floor.structure.removeElement("objects",a.structure):b.floor.structure.insertElement("objects",a.structure)},k.prototype.setupHistory=function(){this.historycmp=this.core.getComponentByName("HistoryComponent"),this.historycmp&&(this.historycmp.registerAction(this.MOVEACTION,this.undoMove,this.redoMove,this),this.historycmp.registerAction(this.ROTATEACTION,this.undoRotate,this.redoRotate,this),this.historycmp.registerAction(this.REFRESHACTION,this.undoRefresh,this.redoRefresh,this),this.historycmp.registerAction(this.GROUPACTION,this.undoGroup,this.redoGroup,this),this.historycmp.registerAction(this.DELETEACTION,this.undoDelete,this.redoDelete,this),this.historycmp.registerAction(this.ADDACTION,this.undoAdd,this.redoAdd,this))},k}(),MobileComponent=function(){function a(){var a=window.innerWidth;640>a?WallComponent2D.WALL_OFFSET=75:a>=640&&800>a?WallComponent2D.WALL_OFFSET=50:a>=800&&1280>a&&(WallComponent2D.WALL_OFFSET=35)}var b=function(a,b){if(BaseComponent2D.call(this,a,"MobileComponent"),this.dirty=!GlobalHelper.isMobileDevice(),this._isMenuVisible=!0,this._menuModified=!1,this._subMenuContainer=document.getElementById("subMenuContainer"),this._toggleIcon=null,this._mainUI=document.getElementById("main-ui"),this._drawableSurfaces=document.getElementsByClassName("drawableSurface"),"boolean"==typeof b&&b===!0&&(this.dirty=!1),!this.dirty){var c=GlobalHelper.getCapabilities();HTMLHelper.addStylesheet("css/mobile.css"),hcsdesign.configuration.loadConfiguration(),hcsdesign.configuration.hasMobileConfig||(c.extensions.elementIndexUint?(hcsdesign.configuration.useMultiTexturing=!0,hcsdesign.configuration.useMultiLights=!0):(hcsdesign.configuration.useMultiTexturing=!1,hcsdesign.configuration.useMultiLights=!1),hcsdesign.configuration.useShadow=!1,hcsdesign.configuration.hasMobileConfig=!0,hcsdesign.configuration.saveConfiguration()),this._toggleMenu=this._toggleMenu.bind(this),this.onCoreInitialized=this.onCoreInitialized.bind(this),this.onContextChanged=this.onContextChanged.bind(this),document.addEventListener("hcs.core.initialized",this.onCoreInitialized,!1),document.addEventListener("hcs.mobile.toggleMenu",this._toggleMenu,!1)}};return b.prototype=Object.create(BaseComponent2D.prototype),b.prototype.initialize=function(){var b=hcsdesign.engine2D.searchComponent("PointComponent2D");b&&(b._SIZE=45);var c=hcsdesign.engine3D.searchComponent("CameraComponent");c&&(GlobalHelper.isAppleDevice()&&(c.camera[0].minZ=250,c.camera[0].maxZ=45e3),window.PointerEvent||(c.camera[0].detachControl(hcsdesign.engine3D.canvas),c.camera[0].attachControlForMobile(hcsdesign.engine3D.canvas))),window.addEventListener("resize",a,!1),a(),this._editionController=document.getElementById("edition-controller")
},b.prototype.onCoreInitialized=function(){document.removeEventListener("hcs.core.initialized",this.onCoreInitialized),GlobalHelper.hasWebGL()&&(hcsdesign.configuration.useMultiLights||(hcsdesign.engine3D.scene.lights[1].dispose(),hcsdesign.engine3D.scene.lights[0].intensity=.8,hcsdesign.engine3D.scene.lights[0].setDirectionToTarget(new BABYLON.Vector3(0,-1,0))),hcsdesign.configuration.useMultiTexturing||(BABYLON.StandardMaterial.reflectionTextureEnabled=!1,BABYLON.StandardMaterial.SpecularTextureEnabled=!1,BABYLON.StandardMaterial.BumpTextureEnabled=!1),hcsdesign.configuration.useShadow||hcsdesign.engine3D.shadowGenerator.dispose(),hcsdesign.engine3D.scene.lights[0].intensity=.45,hcsdesign.engine3D.scene.lights[1].intensity=.05),PerformanceComponent3D.prototype.update=function(){},hcsdesign.engine2D.removeComponentByName("PrintComponent2D"),hcsdesign.engine3D.removeComponentByName("PrintComponent3D"),hcsdesign.engine3D.removeComponentByName("RemoteControlComponent3D"),ujs.notify("hcs.menu.top.sub.replace",{item:{id:"item1",addClass:"hidden"},merge:!0},!0);var a={title:_("Toggle"),icon:"fa fa-chevron-circle-right",action:"hcs.mobile.toggleMenu",id:"toggle-mobile-button",items:[],index:"0"};ujs.notify("hcs.menu.top.sub.add",{item:a,menuPath:"."}),window.innerWidth<800&&(this._toggleMenu(),hcsdesign.engine2D.removeComponentByName("ScreenshotMenuComponent"),hcsdesign.engine2D.removeComponentByName("FullscreenComponent"),hcsdesign.engine3D.removeComponentByName("HistoryEditionComponent"))},b.prototype.addPointerCallback=function(){document.addEventListener("hcs.input.pointerchanged",function(a){hcsdesign.engine3D.onMouseEvent(a,a.inputStatus)},!1)},b.prototype._toggleMenu=function(){this._toggleIcon=document.getElementById("toggle-mobile-button").getElementsByTagName("i")[0],hcsdesign.setMenuWidth(this._isMenuVisible?0:void 0),this._isMenuVisible?(this._mainUI.style.display="none",this._subMenuContainer.style.right="0px",this._toggleIcon.setAttribute("class","fa fa-chevron-circle-left"),this._editionController&&(this._editionController.style.right="40px"),this._drawableSurfaces[0].classList.remove("with-menu"),this._drawableSurfaces[1].classList.remove("with-menu"),hcsdesign.setSize(window.innerWidth,window.innerHeight)):(this._mainUI.style.display="block",this._subMenuContainer.style.right=hcsdesign.getMenuWidth()+"px",this._toggleIcon.setAttribute("class","fa fa-chevron-circle-right"),this._editionController&&(this._editionController.style.right=window.innerWidth-320+"px"),this._drawableSurfaces[0].classList.add("with-menu"),this._drawableSurfaces[1].classList.add("with-menu"),hcsdesign.setSize(window.innerWidth-hcsdesign.getMenuWidth(),window.innerHeight)),this._isMenuVisible=!this._isMenuVisible},b}(),MobileInputComponent=function(){var a=null,b=!1,c=0,d=function(b){BaseComponent2D.call(this,b,"MobileInputComponent"),this._evtBinded=!1,this._bindListeners(),a=this};return d.prototype=Object.create(BaseComponent2D.prototype),d.prototype.destroy=function(){this._unbindListeners()},d.prototype._bindListeners=function(){this._evtBinded||(this._evtBinded=!0,window.addEventListener("touchstart",this._onInputChanged,!1),window.addEventListener("mousemove",this._onInputChanged,!1),window.addEventListener("pointerdown",this._onInputChanged,!1),window.addEventListener("MSPointerDown",this._onInputChanged,!1))},d.prototype._unbindListeners=function(){this._evtBinded&&(this._evtBinded=!1,window.removeEventListener("touchstart",this._onInputChanged),window.removeEventListener("mousemove",this._onInputChanged),window.removeEventListener("pointerdown",this._onInputChanged),window.removeEventListener("MSPointerDown",this._onInputChanged))},d.prototype._onInputChanged=function(d){return"onpointerdown"in window?void(0===c?(c++,b="mousemove"===d.type):a.removeInputSupport("mousemove"===d.type?"touch":"mouse")):void a.removeInputSupport("touchstart"===d.type||"touch"===d.pointerType?"mouse":"touch")},d.prototype.removeInputSupport=function(a){var b=hcsdesign.engine2D._pointerManager,c=hcsdesign.engine3D.pointerManager;if("mouse"===a){b.removeMouseSupport(),c&&c.removeMouseSupport();var d=hcsdesign.engine2D.searchComponent("MobileComponent");d||(console.log("create new"),d=new MobileComponent(hcsdesign,!0),hcsdesign.engine2D.addInstancedComponent(d),d.onCoreInitialized()),d.addPointerCallback(),GlobalHelper.__forceMobileDevice(!0)}else this._unbindListeners(),hcsdesign.engine2D.removeComponent(this,!0)},d}(),PedagoComponent=function(){var a=function(a){BaseComponent2D.call(this,a,"PedagoComponent"),this.pedagoPath="js/Components/PedagoComponent/pedago/pages/"};return a.prototype=Object.create(BaseComponent2D.prototype),a.prototype.checkBrowserCapability=function(){GlobalHelper.hasCanvas2D()||this.redirectToPage("no-webgl");var a=hcsLocalStorage.getItem("hcs.core.force2D");return a?!0:GlobalHelper.hasWebGL()?!0:(this.redirectToPage(GlobalHelper.isAppleDevice()?"ios":"Mac"==BrowserDetect.OS&&"Safari"==BrowserDetect.browser?"safari":GlobalHelper.isAndroidDevice()&&navigator.userAgent.match(/chrome/i)?"no-webgl-chrome-android":GlobalHelper.isMobileDevice()?"mobile":"no-webgl"),!1)},a.prototype.getPageURL=function(a){return[this.pedagoPath,a,".php"].join("")},a.prototype.redirectToPage=function(a){window.location.href=this.getPageURL(a)},a}(),LockComponent=function(){var a="js/Components/LockComponent/Assets/",b=function(a){BaseComponent3D.call(this,a,"LockComponent"),this._editionComponent=null,this._isLocked=!1};return b.prototype=Object.create(BaseComponent3D.prototype),b.prototype.onContextChanged=function(a){"2D"===a?ujs.notify("hcs.menu.top.sub.replace",{item:{id:"lock-icon",addClass:"hidden"},merge:!0},!0):ujs.notify("hcs.menu.top.sub.replace",{item:{id:"lock-icon",addClass:""},merge:!0},!0)},b.prototype.initialize=function(){HTMLHelper.addStylesheet(a+"lockComponent.css",{media:"screen"}),this._editionComponent=hcsdesign.engine3D.searchComponent("EditionComponent3D"),this.toggleLock=this.toggleLock.bind(this);var b={action:"hcs.component.lock",id:"lock-icon",index:1,addClass:"hidden",icon:"fa fa-unlock",title:_("Lock/Unlock")};ujs.notify("hcs.menu.top.sub.add",{item:b,menuPath:"."}),document.addEventListener("hcs.component.lock",this.toggleLock,!1)},b.prototype.destroy=function(){ujs.notify("hcs.menu.top.sub.delete",{id:"lock-icon",menuPath:"."}),document.removeEventListener("hcs.component.lock",this.toggleLock)},b.prototype.toggleLock=function(){this._isLocked=!this._isLocked;var a=document.getElementById("lock-icon"),b=a.children[0].children[0];this._isLocked?(this._editionComponent.dragControl.lock(),b.setAttribute("class","fa fa-lock")):(this._editionComponent.dragControl.unlock(),b.setAttribute("class","fa fa-unlock"))},b}(),EditMeasureComponent=function(){var a=function(a){BaseComponent2D.call(this,a,"EditMeasureComponent")};return a.prototype=new BaseComponent2D,a.prototype.initialize=function(){},a.prototype.startListening=function(){this.onClick=this.onClick.bind(this),this.onDblClick=this.onDblClick.bind(this),this.destroyDialog=this.destroyDialog.bind(this),document.addEventListener("click",this.onClick,!1),document.addEventListener("dblclick",this.onDblClick,!1),document.addEventListener("hcs.contextChanged",this.destroyDialog,!1)},a.prototype.stopListening=function(){document.removeEventListener("click",this.onClick,!1),document.removeEventListener("dblclick",this.onDblClick,!1),this.destroyDialog()},a.prototype.destroyDialog=function(){var a=photonui.getWidget("Dialog_measure");null!=a&&a.destroy()},a.prototype.onClick=function(a){var b=photonui.getWidget("Dialog_measure");null!=b&&(a.pageX<b.position.x||a.pageX>b.position.x+b.offsetWidth||a.pageY<b.position.y||a.pageY>b.position.y+b.offsetHeight)&&b.destroy()},a.prototype.getSideToMove=function(a,b){var c;return c=a<=Math.PI/4&&a>=-Math.PI/4?b?0:1:a>=.75*Math.PI||a<=-3/4*Math.PI?b?1:0:a>Math.PI/4&&a<.75*Math.PI?b?0:1:b?1:0},a.prototype.displacePoint=function(a,b,c,d){var e=this.getSideToMove(c,d),f=a.points,g=f[1].subtract(f[0]),h=this.getSideToMove(Math.atan2(g.y,g.x),d),i=a.parent,j=i.getWallVector();displacevector=0==e?j.normalize().scale(b).negate():j.normalize().scale(b);var k=i.getPoints(e),l=!1;if(-1==i.getPolygon().indexOf(f[h]))for(var m,n=150,o=0;o<i.attachedPoints.length;o++)if(attachedPoint=i.attachedPoints[o],m=f[h].distanceTo(attachedPoint.position),n>m)for(var p=0;p<attachedPoint.parents.length;p++){var q=attachedPoint.parents[p].getPoints(),r=q[(q.indexOf(attachedPoint)+1)%2].position.subtract(attachedPoint.position);BABYLON.Vector2.Dot(a.normal(),r)>0&&(n=m,k=i.attachedPoints[o],l=!0)}if(l)for(var p=0;p<k.parents.length;p++)k.parents[p].translate(displacevector);else{for(var s=!1,p=0;p<k.parents.length;p++)k.parents[p]!=i&&(k.parents[p].translate(displacevector),s=!0);var t=k.wallAttached();s||null==t||(t.translate(displacevector),s=!0),s||k.translate(displacevector)}for(var u=API.getWalls(),p=0;p<u.length;p++)u[p].updateAttachedPoints(API.getCurrentFloor()),u[p].updateOvertures(API.getCurrentFloor()),u[p].needsUpdate=!0;API.e2D.requestStaticDraw()},a.prototype.onDblClick=function(a){var b=API.getComponent("MeasureComponent").getTargeted(API.e2D.getMousePos());if(null!=b){var c=photonui.getWidget("Dialog_measure");if(null!=c){if(a.pageX>=c.position.x||a.pageX<=c.position.x+c.offsetWidth||a.pageY>=c.position.y||a.pageY<=c.position.y+c.offsetHeight)return;c.destroy()}c=new photonui.Window({name:"Dialog_measure",title:_("Settings"),x:a.pageX,y:a.pageY,visible:!0,padding:10});var d=new photonui.GridLayout,e=b.points[b.points.length-1].subtract(b.points[0]).length(),f=new photonui.NumericField({name:"num_length",value:Math.round(e)}),g=new photonui.Label({text:_("Length")+" (cm) :",forInput:f});d.addChild(g,{gridX:0,gridY:0}),d.addChild(f,{gridX:1,gridY:0,gridWidth:2});var h,i,j=b.parent.getWallVector().normalize(),k=Math.atan2(j.y,j.x);k<=Math.PI/4&&k>=-Math.PI/4||k>=.75*Math.PI||k<=-3/4*Math.PI?(h=new photonui.Button({name:"btn-left",text:_("Left")}),i=new photonui.Button({name:"btn-right",text:_("Right")})):(h=new photonui.Button({name:"btn-left",text:_("Top")}),i=new photonui.Button({name:"btn-right",text:_("Bottom")}));var l=new photonui.Label({text:_("Apply to")+" :"});d.addChild(l,{gridX:0,gridY:1}),d.addChild(h,{gridX:1,gridY:1}),d.addChild(i,{gridX:2,gridY:1}),c.child=d,photonui.getWidget("btn-left").registerCallback("clickleft","click",function(){this.displacePoint(b,f.value-e,k,!0),c.destroy()},this),photonui.getWidget("btn-right").registerCallback("clickright","click",function(){this.displacePoint(b,f.value-e,k,!1),c.destroy()},this),photonui.getWidget("num_length").registerCallback("keyup_num","keyup",function(a,d){13==d.keyCode&&(this.displacePoint(b,f.value-e,k,!1),c.destroy())},this),c.registerCallback("close","close-button-clicked",c.destroy,c)}},a}(),HideAvatarComponent=function(){var a=function(a){BaseComponent3D.call(this,a,"HideAvatarComponent")};return a.prototype=new BaseComponent3D,a.prototype.initialize=function(){BaseComponent3D.prototype.initialize.call(this)},a.prototype.startListening=function(){this.onZoom=this.onZoom.bind(this),document.addEventListener("hcs.engine3D.camera.zoom",this.onZoom,!1)},a.prototype.stopListening=function(){document.removeEventListener("hcs.engine3D.camera.zoom",this.onZoom,!1)},a.prototype.onZoom=function(){var a=500,b=API.getComponent("CameraComponent");if(b.cameraActiveId==b.ORBITCAMERA){var c=b.camera[b.cameraActiveId].position,d=API.getComponent("AvatarComponent3D"),e=d.avatar.position;d.setVisibility(c.distanceTo(e)<=a?!1:!0)}},a}(),hcs=window.hcs||{};hcs.LoopTimer=function(){var a=function(){var a=0,b=0;this.start=function(){a=(new Date).getTime()},this.update=function(){var c=(new Date).getTime();b=c-a,a=c},this.getElapsedTime=function(){return a},this.getDeltaTime=function(){return b}};return a}();var socket=io.connect(),hcsdesign=null,hcsLocalStorage={fallback:!0,items:{},setItem:function(a,b){socket.emit("set",{key:a,val:b}),this.items[a]=b},getItem:function(a){return this.items[a]||null},removeItem:function(a){socket.emit("del",{key:a}),delete this.items[a]}};socket.emit("init",{uuid:"bae9e1d5-47ca-4fc2-af27-0e27da13de65"},function(a){function b(a,b){var b=b||1;switch("fr"==a.toLowerCase()&&(j.Constants.LANG="fr"),a.toLowerCase()){case"es":l.setLocale("es_ES",b);break;case"de":l.setLocale("de_DE",b);break;case"fr":l.setLocale("fr_FR",b);break;case"it":l.setLocale("it_IT",b);break;case"pt":l.setLocale("pt_PT",b);break;case"pl":l.setLocale("pl_PL",b);break;case"jp":l.setLocale("jp_JP",b);break;default:l.setLocale("C",b)}}function c(){var a="http://v2.hcsdesign.fr/#b3JpZ2luPWh0dHA6Ly93d3cud2FuYXBsYW4uY29tJmFwaUtleT1jZjk4NjZiNjQwZjZjNmMyNzEyMmM5Y2NjYThkOWRkNyZzYXZlVXJsPWh0dHA6Ly93d3cud2FuYXBsYW4uY29tL2FwaS9wbGFuL3NhdmUvJm5ld1VybD1odHRwOi8vd3d3LndhbmFwbGFuLmNvbS9hcGkvcGxhbi9uZXcvJmF1dG9SZXNpemU9dHJ1ZSZwYXJhbXM9W29iamVjdCBPYmplY3RdJndpZHRoPTEyNzcmaGVpZ2h0PTM4MSZpZD0xJnBhcmFtcz17fQ==",c=hcsLocalStorage.getItem("hcs.core.force2D"),d="",h=a.split("#");h[1]&&(d=i(h[1]));var n=function(a){for(var b={},c=a.split("&"),d=0;d<c.length;d++){var e=c[d].split("=");b[e[0]]=e[1]}return b},o=n(d);if(!GlobalHelper.hasWebGL()&&c&&(o.allow3D=!1),o.apiKey,m=o.lang?o.lang:m,b(m),hcsdesign=new j.Core(k,l,o),hcsdesign.engine2D.addComponent(GridComponent2D),hcsdesign.engine2D.addComponent(PointComponent2D),hcsdesign.engine2D.addComponent(WallComponent2D),hcsdesign.engine2D.addComponent(RoomComponent2D),hcsdesign.engine2D.addComponent(SubSlopeComponent2D),hcsdesign.engine2D.addComponent(SubSlopeOvertureComponent2D),hcsdesign.engine2D.addComponent(OvertureComponent2D),hcsdesign.engine2D.addComponent(MobileComponent),hcsdesign.engine2D.addComponent(MobileInputComponent),hcsdesign.engine2D.addComponent(MeasureComponent),hcsdesign.engine3D.addComponent(CameraComponent),hcsdesign.engine3D.addComponent(GridComponent3D),hcsdesign.engine3D.addComponent(AvatarComponent3D),hcsdesign.engine3D.addComponent(RoomComponent3D),hcsdesign.engine3D.addComponent(OvertureComponent3D),hcsdesign.engine3D.addComponent(SubSlopeComponent3D),hcsdesign.engine3D.addComponent(WallComponent3D),hcsdesign.engine3D.addComponent(StairwayComponent3D),hcsdesign.engine3D.addComponent(HopperComponent3D),hcsdesign.engine3D.addComponent(ObjectComponent3D),hcsdesign.engine3D.addComponent(FloorComponent3D),hcsdesign.engine3D.addComponent(RemoteControlComponent3D),hcsdesign.engine3D.addComponent(TransparencyComponent),g(),f(o),e(o),hcsdesign.setSelectedEngine(hcsdesign.ENGINE_2D),hcsdesign.mode==hcsdesign.MODE_VIEWER){var p=+o.startOn2D?hcsdesign.ENGINE_2D:hcsdesign.ENGINE_3D;hcsdesign.initialize(function(){hcsdesign.engine2D.requestStaticDraw(),hcsdesign.engine2D.update(!0),hcsdesign.setSelectedEngine(p),hcsdesign.hideSplashScreen()})}else hcsdesign.initialize()}function d(a){if(a.mode==hcsdesign.mode||0==a.mode){var b=a.configuration||{};if(1!=a.type)return;var c=hcsdesign["engine"+(a.engine||"2D")];if(!c)return void Logger.message(a.name+" not loaded");var e=window[a.name];if(e){var f=c.addComponent(e);if(f.configuration=b,f&&b["extends"])for(var g=0;g<b["extends"].length;g++){var h=c.searchComponent(b["extends"][g]);h&&h.disable()}}else{var i=a.url||!1;if(i){var j=function(){d(a)};HTMLHelper.addScript(i,void 0,j)}else Logger.message(a.name+" not loaded")}}}function e(a){var b=a.params.env||"";ujs.ajax({method:"get",url:j.Constants.WNP_URL+"/data/api/"+a.apiKey+b+".json",success:function(a){var b=JSON.parse(a);if("ok"==b.status)for(var c=b.components,e=0;e<c.length;e++)d(c[e])}})}function f(a){if(a.components)for(var b=0;b<a.components.length;b++)d(a.components[b])}function g(){hcsdesign.mode==hcsdesign.MODE_EDITOR?(hcsdesign.engine2D.addComponent(MainMenuComponent),hcsdesign.engine2D.addComponent(TopMenuComponent),hcsdesign.engine2D.addComponent(SaveComponent),hcsdesign.engine2D.addComponent(NewComponent),hcsdesign.engine2D.addComponent(OptionsComponent),hcsdesign.engine2D.addComponent(ExitComponent),hcsdesign.engine2D.addComponent(ScreenshotMenuComponent),hcsdesign.engine2D.addComponent(FullscreenComponent),hcsdesign.engine3D.addComponent(HistoryComponent),hcsdesign.engine3D.addComponent(HistoryEditionComponent),hcsdesign.engine2D.addComponent(GeneralOptionComponent2D),hcsdesign.engine2D.addComponent(MagnetismComponent2D),hcsdesign.engine2D.addComponent(PrintComponent2D),hcsdesign.engine2D.addComponent(DebugComponent2D),hcsdesign.engine2D.addComponent(EditMeasureComponent),hcsdesign.engine3D.addComponent(PrintComponent3D),hcsdesign.engine3D.addComponent(EditionComponent3D),hcsdesign.engine3D.addComponent(GroupConfiguratorModComponent3D),hcsdesign.engine3D.addComponent(ConfiguratorModComponent3D),hcsdesign.engine3D.addComponent(GroupConfiguratorPanelComponent3D),hcsdesign.engine3D.addComponent(ConfiguratorPanelComponent3D),hcsdesign.engine3D.addComponent(ConfiguratorInOutAnimationComponent3D),hcsdesign.engine3D.addComponent(ConfiguratorXrayComponent3D),hcsdesign.engine3D.addComponent(MesureDisplayerForDimensionReshaperFactoryComponent3D),hcsdesign.engine3D.addComponent(HandlesDisplayerForDimensionReshaperFactoryComponent3D),hcsdesign.engine3D.addComponent(BoundingLimitDisplayerForDimensionReshaperFactoryComponent3D),hcsdesign.engine3D.addComponent(MasterReshaperComponent3D),hcsdesign.engine3D.addComponent(DimensionReshaperComponent3D),hcsdesign.engine3D.addComponent(MagnetismComponent3D),hcsdesign.engine3D.addComponent(DecorationComponent3D),hcsdesign.engine3D.addComponent(LuxensComponent3D),hcsdesign.engine3D.addComponent(OutsideComponent3D),hcsdesign.engine3D.addComponent(DebugComponent3D),hcsdesign.engine3D.addComponent(LockComponent),hcsdesign.engine3D.addComponent(PerformanceComponent3D),hcsdesign.engine3D.addComponent(HardwareScalingComponent3D),hcsdesign.engine3D.addComponent(HideAvatarComponent)):hcsdesign.mode==hcsdesign.MODE_VIEWER}function h(){requestAnimationFrame(h),hcsdesign.update(),hcsdesign.draw()}hcsLocalStorage.items=a,BABYLON.Engine.ShadersRepository="js/Vendors/Babylon/Shaders/";var i=window.atob||function(a){return a};window.hcs_DEBUG=!1,Logger.setDebugMode(window.hcs_DEBUG);var j=window.hcs||{},k=j.Constants.VERSION;window.hcs_DEBUG&&(k+=Math.round(100*Math.random()));var l=new I18njs("./l10n/"),m=navigator.language||navigator.browserLanguage||"fr_FR",n=hcsLocalStorage.getItem(j.Constants.LC_LANG_KEY);if(null!==n)m=n;else{var o=m.split("-");m=o instanceof Array?o[0]:o}b(m,k);var p=new PedagoComponent;if(p.checkBrowserCapability()){if(!GlobalHelper.isMobileDevice()&&"Windows"==BrowserDetect.OS)var d=setTimeout(function(){clearTimeout(d),hcsdesign.isFullyInitialized||p.redirectToPage("graphics")},15e3);c(),hcsdesign.engine2D.addInstancedComponent(p),h()}});